<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>w4lle&#39;s Notes</title>
  <subtitle>Eeeee... va?</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://w4lle.com/"/>
  <updated>2020-11-17T12:49:33.072Z</updated>
  <id>http://w4lle.com/</id>
  
  <author>
    <name>w4lle</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Flutter UI æ¸²æŸ“æµ…æï¼ˆå››ï¼‰Build</title>
    <link href="http://w4lle.com/2020/11/16/flutter-ui-build/"/>
    <id>http://w4lle.com/2020/11/16/flutter-ui-build/</id>
    <published>2020-11-16T06:30:12.000Z</published>
    <updated>2020-11-17T12:49:33.072Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« çš„ç¬¬å››ç¯‡ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹ Element.rebuild() è¿‡ç¨‹ã€‚</p>
<p>æºç åŸºäº Flutter v1.20.4ã€‚</p>
<a id="more"></a>
<p>åœ¨ <a href="http://w4lle.com/2020/11/11/flutter-ui-vsync/">Flutter UI æ¸²æŸ“æµ…æï¼ˆäºŒï¼‰VSync æ³¨å†Œ</a> è¿™ç¯‡æ–‡ç« ä¸­æåˆ°ï¼ŒC++ Engine æ¥æ”¶åˆ° VSync ä¿¡å·åï¼Œéœ€è¦åšä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>æ‰§è¡Œ Dart Framework <code>dart:ui</code> åŒ…ä¸‹çš„ <code>_beginFrame()</code></li>
<li>æ‰§è¡Œ microtasks ä»»åŠ¡</li>
<li>æ‰§è¡Œ Dart Framework <code>dart:ui</code> åŒ…ä¸‹çš„  <code>_drawFrame()</code></li>
</ul>
<p>ä¸Šä¸€ç¯‡æ–‡ç«  <a href="http://w4lle.com/2020/11/13/flutter-ui-animate/">Flutter UI æ¸²æŸ“æµ…æï¼ˆä¸‰ï¼‰Animation åŸç†</a> ä¸­åˆ†æäº† <code>_beginFrame()</code> çš„è¿‡ç¨‹ã€‚</p>
<p>ç„¶åæ¥ç€å»å¤„ç†åœ¨ <code>Animate</code> è¿‡ç¨‹ä¸­è§¦å‘çš„ <code>microtasks</code> ä»»åŠ¡ï¼Œä¸€èˆ¬ä¸º <code>Ticker</code> æˆ–è€… <code>AnimationController</code> ä¸­  Future çš„å®Œæˆå›è°ƒã€‚</p>
<p>æœ¬ç¯‡æ–‡ç« åˆ†æä¸‹ <code>_drawFrame()</code> çš„å‰åŠéƒ¨åˆ†â€”â€” <code>Element.rebuild()</code> çš„è¿‡ç¨‹ã€‚</p>
<h1 id="1ã€-handleDrawFrame"><a href="#1ã€-handleDrawFrame" class="headerlink" title="1ã€_handleDrawFrame()"></a>1ã€_handleDrawFrame()</h1><p>åŒä¸Šç¯‡æ–‡ç« çš„é€»è¾‘ä¸€æ ·ï¼Œè°ƒç”¨åˆ° Dart Framework çš„<code>SchedulerBinding._handleDrawFrame()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/scheduler/binding.dart</span></div><div class="line">	<span class="keyword">void</span> _handleDrawFrame() &#123;</div><div class="line">    <span class="keyword">if</span> (_ignoreNextEngineDrawFrame) &#123;</div><div class="line">      _ignoreNextEngineDrawFrame = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    handleDrawFrame();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">void</span> handleDrawFrame() &#123;</div><div class="line">    <span class="keyword">assert</span>(_schedulerPhase == SchedulerPhase.midFrameMicrotasks);</div><div class="line">    <span class="comment">//ç»“æŸAnimateè¿‡ç¨‹è®°å½•</span></div><div class="line">    Timeline.finishSync(); <span class="comment">// end the "Animate" phase</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// PERSISTENT FRAME CALLBACKS</span></div><div class="line">      _schedulerPhase = SchedulerPhase.persistentCallbacks;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">final</span> FrameCallback callback <span class="keyword">in</span> _persistentCallbacks)</div><div class="line">        _invokeFrameCallback(callback, _currentFrameTimeStamp);</div><div class="line"></div><div class="line">      <span class="comment">// POST-FRAME CALLBACKS</span></div><div class="line">      _schedulerPhase = SchedulerPhase.postFrameCallbacks;</div><div class="line">      <span class="keyword">final</span> <span class="built_in">List</span>&lt;FrameCallback&gt; localPostFrameCallbacks =</div><div class="line">          <span class="built_in">List</span>&lt;FrameCallback&gt;.from(_postFrameCallbacks);</div><div class="line">      <span class="comment">//æ¸…é™¤åˆ—è¡¨</span></div><div class="line">      _postFrameCallbacks.clear();</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">final</span> FrameCallback callback <span class="keyword">in</span> localPostFrameCallbacks)</div><div class="line">        _invokeFrameCallback(callback, _currentFrameTimeStamp);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">//SchedulerPhaseçŠ¶æ€ç½®ä¸ºidleï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ç»˜åˆ¶è§¦å‘</span></div><div class="line">      _schedulerPhase = SchedulerPhase.idle;</div><div class="line">      <span class="comment">//ç»“æŸFrameè¿‡ç¨‹è®°å½•</span></div><div class="line">      Timeline.finishSync(); <span class="comment">// end the Frame</span></div><div class="line">      _currentFrameTimeStamp = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>éå† <code>_persistentCallbacks</code>ï¼Œç”± <code>WidgetsBinding.addPersistentFrameCallback()</code> æ³¨å†Œï¼Œä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå®ƒæ˜¯ä¸€ä¸ªéœ€è¦æŒä¹…å›è°ƒçš„åˆ—è¡¨ï¼Œæ‰€ä»¥ä¸å¯åˆ é™¤ï¼Œæ¯æ¬¡ç»˜åˆ¶è¿‡ç¨‹éƒ½ä¼šå›è°ƒ</li>
<li>éå†<code>_postFrameCallbacks</code>ï¼Œç”± <code>WidgetsBinding.addPostFrameCallback()</code> æ³¨å†Œï¼Œåªä¼šå›è°ƒä¸€æ¬¡ï¼Œè°ƒç”¨è¿‡åæ¸…é™¤å›è°ƒåˆ—è¡¨ï¼Œä¸€èˆ¬ç”¨äºç›‘å¬ç»˜åˆ¶å®Œæˆåå¤„ç†ä¸€äº›ä»»åŠ¡</li>
</ul>
<p>ä¸‹é¢ä¸»è¦çœ‹ä¸‹<code>_persistentCallbacks</code> çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<h2 id="1-1ã€RendererBinding-drawFrame"><a href="#1-1ã€RendererBinding-drawFrame" class="headerlink" title="1.1ã€RendererBinding.drawFrame()"></a>1.1ã€RendererBinding.drawFrame()</h2><p>åœ¨ <a href="http://w4lle.com/2020/11/11/flutter-ui-vsync/">Flutter UI æ¸²æŸ“æµ…æï¼ˆäºŒï¼‰VSync æ³¨å†Œ</a> è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç®€å•åˆ†æäº† 7 ä¸ª Binding ç±»çš„ä½œç”¨åŠå…¶åˆå§‹åŒ–é¡ºåºã€‚</p>
<p>åœ¨ <code>RendererBinding</code> åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ³¨å†Œäº†<code>_persistentCallbacks</code> å›è°ƒï¼Œå¦‚ä¸‹ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">mixin RendererBinding on BindingBase, ServicesBinding, SchedulerBinding, GestureBinding, SemanticsBinding, HitTestable &#123;</div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> initInstances() &#123;</div><div class="line">    <span class="keyword">super</span>.initInstances();</div><div class="line">    _instance = <span class="keyword">this</span>;</div><div class="line">    <span class="comment">//åˆå§‹åŒ–ç»˜åˆ¶ç®¡çº¿</span></div><div class="line">    _pipelineOwner = PipelineOwner(</div><div class="line">      onNeedVisualUpdate: ensureVisualUpdate,</div><div class="line">      onSemanticsOwnerCreated: _handleSemanticsOwnerCreated,</div><div class="line">      onSemanticsOwnerDisposed: _handleSemanticsOwnerDisposed,</div><div class="line">    );</div><div class="line">    <span class="comment">//æ³¨å†Œwindowå›è°ƒ</span></div><div class="line">    <span class="built_in">window</span></div><div class="line">      ..onMetricsChanged = handleMetricsChanged</div><div class="line">      ..onTextScaleFactorChanged = handleTextScaleFactorChanged</div><div class="line">      ..onPlatformBrightnessChanged = handlePlatformBrightnessChanged</div><div class="line">      ..onSemanticsEnabledChanged = _handleSemanticsEnabledChanged</div><div class="line">      ..onSemanticsAction = _handleSemanticsAction;</div><div class="line">    <span class="comment">//åˆå§‹åŒ–RenderObjectæ ¹èŠ‚ç‚¹RenderView</span></div><div class="line">    initRenderView();</div><div class="line">    _handleSemanticsEnabledChanged();</div><div class="line">    <span class="comment">//è¿™é‡Œæ·»åŠ _persistentCallbackså›è°ƒ</span></div><div class="line">    addPersistentFrameCallback(_handlePersistentFrameCallback);</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">  <span class="comment">//_persistentCallbackså›è°ƒ</span></div><div class="line">  <span class="keyword">void</span> _handlePersistentFrameCallback(<span class="built_in">Duration</span> timeStamp) &#123;</div><div class="line">    <span class="comment">//çœŸæ­£æ‰§è¡Œframeç»˜åˆ¶</span></div><div class="line">    drawFrame();</div><div class="line">    _mouseTracker.schedulePostFrameCheck();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><code>_handlePersistentFrameCallback(Duration timeStamp)</code> æ–¹æ³•æ˜¯ <code>_persistentCallbacks</code> å›è°ƒåˆ—è¡¨çš„ä¸€ä¸ªå­å…ƒç´ ï¼Œå…¶ä¸­å»è°ƒç”¨ <code>drawFrame()</code> æ–¹æ³•ã€‚</p>
<p>ç”±äº <code>WidgetsFlutterBinding</code> çš„æ··å…¥é¡ºåº</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/binding.dart</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WidgetsFlutterBinding</span> <span class="keyword">extends</span> <span class="title">BindingBase</span> <span class="title">with</span> <span class="title">GestureBinding</span>, <span class="title">SchedulerBinding</span>, <span class="title">ServicesBinding</span>, <span class="title">PaintingBinding</span>, <span class="title">SemanticsBinding</span>, <span class="title">RendererBinding</span>, <span class="title">WidgetsBinding</span> </span>&#123;</div><div class="line">  <span class="keyword">static</span> WidgetsBinding ensureInitialized() &#123;</div><div class="line">    <span class="keyword">if</span> (WidgetsBinding.instance == <span class="keyword">null</span>)</div><div class="line">      WidgetsFlutterBinding();</div><div class="line">    <span class="keyword">return</span> WidgetsBinding.instance;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>WidgetsBinding</code> åœ¨ <code>RendererBinding</code> ä¹‹åï¼Œæ‰€ä»¥ä¼šå…ˆæ‰§è¡Œ <code>WidgetsBinding.drawFrame()</code> æ–¹æ³•ã€‚</p>
<h2 id="1-2ã€WidgetsBinding-drawFrame"><a href="#1-2ã€WidgetsBinding-drawFrame" class="headerlink" title="1.2ã€WidgetsBinding.drawFrame()"></a>1.2ã€WidgetsBinding.drawFrame()</h2><p><code>WidgetsBinding.drawFrame()</code> å®ç°: </p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/binding.dart WidgetsBinding</span></div><div class="line">mixin WidgetsBinding on BindingBase, ServicesBinding, SchedulerBinding, GestureBinding, RendererBinding, SemanticsBinding &#123;</div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> initInstances() &#123;</div><div class="line">    <span class="keyword">super</span>.initInstances();</div><div class="line">    _instance = <span class="keyword">this</span>;</div><div class="line">    <span class="comment">//æ„é€ BuildeOwnerï¼Œä¸»è¦è´Ÿè´£Widgetçš„buildè¿‡ç¨‹</span></div><div class="line">    _buildOwner = BuildOwner();</div><div class="line">    buildOwner.onBuildScheduled = _handleBuildScheduled;</div><div class="line">    <span class="comment">//æ³¨å†Œwindowç›¸å…³å›è°ƒ</span></div><div class="line">    <span class="built_in">window</span>.onLocaleChanged = handleLocaleChanged;</div><div class="line">    <span class="built_in">window</span>.onAccessibilityFeaturesChanged = handleAccessibilityFeaturesChanged;</div><div class="line">  	<span class="comment">//å¯¼èˆªchannel  </span></div><div class="line">    SystemChannels.navigation.setMethodCallHandler(_handleNavigationInvocation);</div><div class="line">    FlutterErrorDetails.propertiesTransformers.add(transformDebugCreator);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> drawFrame() &#123;</div><div class="line">		...</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">//renderViewElementæ˜¯æ ¹RenderObject RenderViewå¯¹åº”çš„Element</span></div><div class="line">      <span class="keyword">if</span> (renderViewElement != <span class="keyword">null</span>)</div><div class="line">        buildOwner.buildScope(renderViewElement);</div><div class="line">      <span class="comment">//è°ƒç”¨mixinçš„drawFrameæ–¹æ³•ï¼Œå³RendererBinding.drawFrame()</span></div><div class="line">      <span class="keyword">super</span>.drawFrame();</div><div class="line">      buildOwner.finalizeTree();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>buildOwner.buildScope() è§¦å‘Widget Treeã€Element Treeã€RenderObject Treeä¸‰æ£µæ ‘çš„æ„å»ºæˆ–åˆ·æ–°è¿‡ç¨‹</li>
<li>super.drawFrame() è°ƒç”¨çˆ¶ç±»çš„ drawFrame() æ–¹æ³•ï¼Œç”±äº <code>WidgetsBinding</code> æ··å…¥äº† <code>RendererBinding</code> ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå»è°ƒç”¨ <code>RendererBinding.drawFrame()</code> ï¼Œä¸‹ç¯‡æ–‡ç« ä¼šç»§ç»­åˆ†æ</li>
<li>buildOwner.finalizeTree() å¸è½½æœªæ¿€æ´»çŠ¶æ€çš„ Element èŠ‚ç‚¹ã€‚æœªæ¿€æ´»çŠ¶æ€çš„èŠ‚ç‚¹åœ¨ä¸€ä¸ªç»˜åˆ¶å¸§å‘¨æœŸå†…ï¼Œæ˜¯æœ‰å¯èƒ½è¢«é‡æ–°æ¿€æ´»çš„ï¼Œå¦‚æœæ²¡æœ‰é‡æ–°æ¿€æ´»ï¼Œé‚£ä¹ˆå°±å¸è½½æ‰</li>
</ul>
<h2 id="1-3ã€BuildOwner-buildScope"><a href="#1-3ã€BuildOwner-buildScope" class="headerlink" title="1.3ã€BuildOwner.buildScope()"></a>1.3ã€BuildOwner.buildScope()</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/framework.dart BuildOwner</span></div><div class="line">	<span class="keyword">void</span> buildScope(<span class="built_in">Element</span> context, [ VoidCallback callback ]) &#123;</div><div class="line">    <span class="comment">// è®°å½• Build è¿‡ç¨‹</span></div><div class="line">    Timeline.startSync(<span class="string">'Build'</span>, arguments: timelineArgumentsIndicatingLandmarkEvent);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      _scheduledFlushDirtyElements = <span class="keyword">true</span>;</div><div class="line">      <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">        _dirtyElementsNeedsResorting = <span class="keyword">false</span>;</div><div class="line">        <span class="comment">// æ‰§è¡Œå›è°ƒï¼Œåœ¨Appå¯åŠ¨æ„å»ºä¸‰æ£µæ ‘æ—¶ä¼šç”¨åˆ°</span></div><div class="line">        callback();</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// é‡æ’åºï¼Œé«˜åº¦ä¼˜å…ˆ</span></div><div class="line">      _dirtyElements.sort(<span class="built_in">Element</span>._sort);</div><div class="line">      _dirtyElementsNeedsResorting = <span class="keyword">false</span>;</div><div class="line">      <span class="built_in">int</span> dirtyCount = _dirtyElements.length;</div><div class="line">      <span class="built_in">int</span> index = <span class="number">0</span>;</div><div class="line">      <span class="keyword">while</span> (index &lt; dirtyCount) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// è§¦å‘ Elemeng.rebuild() æ›´æ–°ä¸‰æ£µæ ‘</span></div><div class="line">          _dirtyElements[index].rebuild();</div><div class="line">        &#125;</div><div class="line">        index += <span class="number">1</span>;</div><div class="line">        <span class="comment">// åœ¨ç­‰å¾…VSync ä¿¡å·å›è°ƒè¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½åˆæœ‰æ–°çš„æ ‡è„èŠ‚ç‚¹è¿›æ¥</span></div><div class="line">        <span class="keyword">if</span> (dirtyCount &lt; _dirtyElements.length || _dirtyElementsNeedsResorting) &#123;</div><div class="line">          <span class="comment">// é‡æ’åºï¼Œé«˜åº¦ä¼˜å…ˆ</span></div><div class="line">          _dirtyElements.sort(<span class="built_in">Element</span>._sort);</div><div class="line">          _dirtyElementsNeedsResorting = <span class="keyword">false</span>;</div><div class="line">          dirtyCount = _dirtyElements.length;</div><div class="line">          <span class="keyword">while</span> (index &gt; <span class="number">0</span> &amp;&amp; _dirtyElements[index - <span class="number">1</span>].dirty) &#123;</div><div class="line">            index -= <span class="number">1</span>;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">final</span> <span class="built_in">Element</span> element <span class="keyword">in</span> _dirtyElements) &#123;</div><div class="line">        <span class="comment">// æ¸…é™¤ Element è„æ ‡è®°</span></div><div class="line">        element._inDirtyList = <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// æ¸…ç©ºè„åˆ—è¡¨</span></div><div class="line">      _dirtyElements.clear();</div><div class="line">      _scheduledFlushDirtyElements = <span class="keyword">false</span>;</div><div class="line">      _dirtyElementsNeedsResorting = <span class="keyword">null</span>;</div><div class="line">      <span class="comment">// ç»“æŸ Build è®°å½•è¿‡ç¨‹</span></div><div class="line">      Timeline.finishSync();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ‰§è¡Œå›è°ƒï¼Œåœ¨ App å¯åŠ¨æ—¶<code>WidgetsFlutterBinding.ensureInitialized()
  ..scheduleAttachRootWidget(app)</code> ä¼šç”¨åˆ°ï¼Œç”¨äºæ„å»ºå‡ºä¸‰æ£µæ ‘ï¼Œcallback ä¸º <code>element.mount(null, null);</code></li>
<li><code>_dirtyElements</code> è„åˆ—è¡¨é‡æ’åºï¼Œåœ¨ç­‰å¾… VSync ä¿¡å·å›è°ƒè¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½åˆæœ‰æ–°çš„æ ‡è„èŠ‚ç‚¹è¿›æ¥</li>
<li>è„åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œå³è°ƒç”¨äº† <code>State.setState()</code> çš„èŠ‚ç‚¹ï¼Œè§¦å‘ Element.rebuild() æ›´æ–°ä¸‰æ£µæ ‘ï¼Œè¿™é‡Œçš„é‡ç‚¹ä¹Ÿæ˜¯Element.rebuild()ã€‚</li>
<li>æ¸…é™¤ Element è„æ ‡è®°ï¼Œæ¸…ç©ºè„åˆ—è¡¨</li>
</ul>
<h2 id="1-4ã€Element-rebuild"><a href="#1-4ã€Element-rebuild" class="headerlink" title="1.4ã€Element.rebuild()"></a>1.4ã€Element.rebuild()</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// flutter/lib/src/widgets/framework.dart Elememt  </span></div><div class="line">	<span class="keyword">void</span> rebuild() &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (!_active || !_dirty)</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    performRebuild();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@protected</span></div><div class="line">  <span class="keyword">void</span> performRebuild();</div></pre></td></tr></table></figure>
<p>é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œè°ƒç”¨ <code>performRebuild()</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œå®ç°åœ¨å­ç±»ã€‚</p>
<h1 id="2ã€Widgetã€Element-ä¸-RenderObject"><a href="#2ã€Widgetã€Element-ä¸-RenderObject" class="headerlink" title="2ã€Widgetã€Element ä¸ RenderObject"></a>2ã€Widgetã€Element ä¸ RenderObject</h1><p>åœ¨ç»§ç»­åˆ†æåç»­æµç¨‹ä¹‹å‰ï¼Œå…ˆç®€å•æ¢³ç†ä¸‹ Widgetã€Element ä¸ RenderObject ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠä¸‰æ£µæ ‘ä¸ Layer Tree ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>Flutter å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„å°±æ˜¯ Widget äº†ã€‚</p>
<p>Widget æ˜¯é¢å‘å¼€å‘è€…çš„æ¥å£ï¼Œå®ƒæ˜¯å¯¹UIçš„æè¿°æ€§è¡¨è¾¾ï¼Œå³æ˜¯ç”¨äºæè¿° Element çš„é…ç½®çš„ã€‚</p>
<p>Widget æ˜¯å£°æ˜å¼çš„ UI ç»“æ„ï¼Œå¼€å‘è€…é€šè¿‡ç»„åˆ Widget æ„å»ºå‡ºæƒ³è¦çš„UIæ•ˆæœã€‚</p>
<p>Widget æ˜¯ä¸å¯å˜çš„ï¼ˆimmutableï¼‰ï¼Œè¿™å°±æ„å‘³ç€æ¯æ¬¡åˆ·æ–°ï¼Œéƒ½ä¼šé‡æ–°æ„å»ºå‡ºæ–°çš„Widgetå¯¹è±¡ï¼Œåˆ›å»ºçš„å¼€é”€å¾ˆå°ï¼Œæˆæœ¬è¾ƒä½ã€‚</p>
<p>æˆ‘ä»¬é€šå¸¸å°† Widget ç»„åˆæ„å»ºå‡ºçš„ UI å±‚çº§ç»“æ„ç§°ä¸º Widget Treeï¼Œä½†ç›¸æ¯” Element Treeï¼Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨ Widget              Treeï¼Œç”±äº Widget èŠ‚ç‚¹æŒ‚è½½åœ¨ Element èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠ½è±¡ä¸º Widget Treeã€‚</p>
<p>Widget æä¾› <code>createElement()</code> å’Œ <code>createRenderObject()</code> ï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰ï¼‰ç”¨äºæ„å»º Element å’Œ RenderObjectã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_widgets_categories.png" alt=""></p>
<p>Widget ä¸»è¦æœ‰ä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li>ProxyWidget ä»£ç†ç±»ï¼Œä¸ç›´æ¥å‚ä¸æ„å»ºUIï¼Œå®ƒä»¬å¯ä»¥ä¸ºå…¶ä»– Widget æä¾›ä¸€äº›é™„åŠ ä¿¡æ¯ã€‚ä¾‹å¦‚ <code>InheritedWidget</code> å¯ä»¥åœ¨å…¶å­æ ‘ä¸­ä¼ é€’é™„åŠ ä¿¡æ¯ï¼›<code>ParentDataWidget</code> ç”¨äºæä¾›å…¶å­æ ‘çš„å¸ƒå±€ä¿¡æ¯</li>
<li>ComponentWidget ç»„åˆç±»ï¼Œä¸ç›´æ¥å‚ä¸ç»˜åˆ¶ï¼Œå®ƒä»¬ç”¨æ¥ç»„åˆåŒ…è£…ç”¨æ¥æ„å»ºå¤æ‚çš„UIå¸ƒå±€ã€‚ä¸€èˆ¬éƒ½æ˜¯ <code>StatefullWidget</code> æˆ–è€… <code>StatelessWidget</code> çš„å­ç±»ï¼Œä¾‹å¦‚ <code>RaisedButton</code> ã€<code>Scaffold</code>ã€<code>Text</code>ã€ <code>GestureDetector</code>ã€ <code>Container</code> ç­‰</li>
<li>RenderObjectWidget ç»˜åˆ¶ç±»ï¼Œå¯ä»¥æ„å»ºå‡º RenderObject ç”¨æ¥å¸ƒå±€å’Œç»˜åˆ¶</li>
</ul>
<p>Element æ˜¯å“åº”å¼ç¼–ç¨‹çš„åŸºç¡€ï¼Œé¢‘ç¹çš„åˆ›å»º Element ä¼šå¯¹æ€§èƒ½æœ‰å½±å“ï¼Œæ‰€ä»¥åªæœ‰åœ¨å¿…è¦æ¡ä»¶ä¸‹æ‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Element å¯¹è±¡ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šè¿›è¡Œå¤ç”¨ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªèŒè´£ï¼š</p>
<ul>
<li>æŒæœ‰ Widget å’Œ RenderObject çš„å¼•ç”¨ï¼Œåè°ƒäºŒè€…ä¹‹é—´çš„æ•°æ®ç»‘å®šå…³ç³»</li>
<li>æ ¹æ® Widget çš„å˜åŒ–æ¥åˆ›å»ºæˆ–æ›´æ–° Element Treeï¼ŒåŒ…æ‹¬æŒ‚è½½ã€æ›´æ–°ã€æ›´æ”¹ä½ç½®ã€å¸è½½ç­‰</li>
</ul>
<p>Element å’Œ Widget æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼ŒåŒæ ·ç±»å‹çš„ Widget æ„å»ºå‡ºåŒæ ·ç±»å‹çš„ Elementã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_element_types.png" alt=""></p>
<p>RenderObject ç”¨æ¥å¸ƒå±€å’Œç»˜åˆ¶ï¼Œå¤„ç†è¾“å…¥äº‹ä»¶ç­‰ã€‚</p>
<p>Element å’Œ RenderObject ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œåªæœ‰å¯ä»¥ç»˜åˆ¶çš„èŠ‚ç‚¹æ‰æœ‰ RenderObject å¯¹è±¡ã€‚</p>
<p>Render Tree ç”¨æ¥å¸ƒå±€å’Œç»˜åˆ¶ RenderObject èŠ‚ç‚¹ï¼Œæœ€ç»ˆç”Ÿæˆ Layer Tree æäº¤ç»™ C++ Engineã€‚å®ƒçš„æ ¹èŠ‚ç‚¹æ˜¯ RenderViewã€‚</p>
<p>ä»–ä»¬ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼š</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesinternals_element.png" alt=""></p>
<p>Element æŒæœ‰ Widget å¼•ç”¨å’Œ RenderObject åº”ç”¨ï¼ˆå¯èƒ½æ²¡æœ‰ï¼‰ï¼ŒWidget ç”¨æ¥æ„å»º RenderObject å¯¹è±¡ã€‚</p>
<p>å¯¹äº StatefullElement æ¥è¯´ï¼Œå®ƒè¿˜ä¼šæŒæœ‰ State çš„å¼•ç”¨ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒElement çš„ child æ˜¯ Widget ä¸­ build() æ–¹æ³•æ„å»ºå‡ºæ¥çš„ Widget æ‰€å¯¹åº”çš„ Elementï¼Œä¸‹é¢ä¼šç”¨åˆ°ã€‚</p>
<p>Widgetã€Elementã€RenderObject æ„å»ºå‡ºä¸‰æ£µæ ‘ Widget Treeã€Element Treeã€Render Treeï¼Œå®ƒä»¬å…±åŒç»„æˆäº† Flutter å¯¹äºUIçš„ç»„ç»‡æè¿°ã€‚</p>
<p>å‰ä¸¤æ£µæ ‘å¯ä»¥è®¤ä¸ºæ˜¯é¢å‘å¼€å‘è€…çš„ï¼Œå®ƒä»¬æ„æˆäº†å£°æ˜å¼UIã€å“åº”å¼UIçš„åŸºç¡€ï¼ŒRender Tree ç”¨æ¥çœŸæ­£çš„å¸ƒå±€å’Œç»˜åˆ¶ï¼Œæœ€åç”Ÿæˆ Layer Treeï¼Œå¹¶ä¿å­˜åœ¨ Scene å¯¹è±¡ä¸­ï¼Œæäº¤ç»™ C++ Engine åšå…‰æ …åŒ–åˆæˆã€‚</p>
<p>é‚£ä¹ˆï¼Œå¯ä¸å¯ä»¥ç»•å¼€ Widgetã€Elementã€RenderObject æ¥è¿›è¡Œç»˜åˆ¶ï¼Œå…¶å®æ˜¯å¯ä»¥çš„ï¼Œå®ƒä»¬åªæ˜¯ç”¨æ¥ç»„ç»‡æè¿°ç»˜åˆ¶ä¿¡æ¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿åˆ° Canvas è¿›è¡Œç»˜åˆ¶ï¼Œåªè¦æœ€ç»ˆå¯ä»¥ç”ŸæˆLayer Tree ä¿å­˜åœ¨ Scene ä¸­å°±å¯ä»¥ã€‚</p>
<p>ä¾‹å¦‚ <a href="https://codepen.io/w4lle/pen/ZEOPZEe" target="_blank" rel="external">è¿™ä¸ªä¾‹å­ ğŸŒ°</a> ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥çš„ï¼Œç”šè‡³å¯ä»¥ç»•è¿‡æˆ–è€…èˆå¼ƒ Dart Frameworkï¼Œç›´æ¥å¯¹æ¥ C++ Engineï¼Œä»»ä½•å¯ä»¥ç»„ç»‡æè¿°UIç»˜åˆ¶ç»“æ„çš„ç»„ç»‡å½¢å¼ï¼Œç†è®ºä¸Šéƒ½å¯ä»¥æ¡¥æ¥åˆ° C++ Engineã€‚</p>
<p>ä¾‹å¦‚åŸºäº W3C æ ‡å‡†çš„ CSS + JS/TS ç»„ç»‡çš„UIæè¿°ï¼Œé€šè¿‡ç»‘å®šJSä¸C++ Engineï¼Œå°†ç»˜åˆ¶ä¿¡æ¯å‘é€ç»™ Engineï¼Œç†è®ºä¸Šä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20201117155018.png" alt=""></p>
<h1 id="3ã€Element-performRebuild"><a href="#3ã€Element-performRebuild" class="headerlink" title="3ã€Element.performRebuild()"></a>3ã€Element.performRebuild()</h1><p>ç»§ç»­ä¸Šé¢åˆ†æåˆ° <code>Element.performRebuild()</code>ã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_ondrawframe.gif" alt=""></p>
<p>åˆ† Element ç±»å‹çœ‹ä¸‹å®ç°</p>
<p>ComponentElementï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/framework.dart ComponentElement</span></div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> performRebuild() &#123;</div><div class="line">    Widget built;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      ...</div><div class="line">      built = build();</div><div class="line">      ...</div><div class="line">    &#125; <span class="keyword">catch</span> (e, stack) &#123;</div><div class="line">      _debugDoingBuild = <span class="keyword">false</span>;</div><div class="line">      <span class="comment">// é”™è¯¯æƒ…å†µï¼Œè¿™é‡Œæ˜¯æ„å»ºçº¢å±çš„åœ°æ–¹</span></div><div class="line">      built = ErrorWidget.builder();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">// æ”¹å˜æ ‡å¿—ä½</span></div><div class="line">      _dirty = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      ...</div><div class="line">      _child = updateChild(_child, built, slot);</div><div class="line">    &#125; <span class="keyword">catch</span> (e, stack) &#123;</div><div class="line">      <span class="comment">// é”™è¯¯æƒ…å†µï¼Œè¿™é‡Œä¹Ÿæ˜¯æ„å»ºçº¢å±çš„åœ°æ–¹</span></div><div class="line">      built = ErrorWidget.builder();</div><div class="line">      _child = updateChild(<span class="keyword">null</span>, built, slot);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">// lib/src/widgets/framework.dart StatefullElement</span></div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> performRebuild() &#123;</div><div class="line">    <span class="keyword">if</span> (_didChangeDependencies) &#123;</div><div class="line">      <span class="comment">// ä¾èµ–çš„ç¥–å…ˆèŠ‚ç‚¹å¦‚æœæœ‰å˜åŒ–ï¼Œéœ€è¦è°ƒç”¨</span></div><div class="line">      _state.didChangeDependencies();</div><div class="line">      _didChangeDependencies = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">super</span>.performRebuild();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li><code>build()</code> æ„å»ºå­ Widgetï¼Œæ³¨æ„è¿™é‡Œæ˜¯ <strong>å­Widget</strong></li>
<li><code>_updateChild()</code> åˆ›å»ºæˆ–æ›´æ–°å­Elementï¼Œæ³¨æ„è¿™é‡Œæ˜¯ <strong>å­Element</strong></li>
</ul>
<p>ä¸ºä»€ä¹ˆå¼ºè°ƒå­Widgetå’Œå­Elementï¼Œå› ä¸ºåœ¨è¿™ä¸ªElementå¯¹è±¡ä¸­ï¼Œå®ƒå¯¹åº”çš„ Widget å’Œ Element å°±æ˜¯Elementè‡ªå·±åˆå®ƒæŒæœ‰çš„ Widgetã€‚è¿™é‡Œå¾ˆå®¹æ˜“ææ··ã€‚</p>
<p>RenderObjectElementï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/framework.dart RenderObjectElement</span></div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> performRebuild() &#123;</div><div class="line">    ...</div><div class="line">     </div><div class="line">    widget.updateRenderObject(<span class="keyword">this</span>, renderObject);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">// lib/src/widgets/basic Stack</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stack</span> <span class="keyword">extends</span> <span class="title">MultiChildRenderObjectWidget</span> </span>&#123;</div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> updateRenderObject(BuildContext context, RenderStack renderObject) &#123;</div><div class="line">    <span class="keyword">assert</span>(_debugCheckHasDirectionality(context));</div><div class="line">    renderObject</div><div class="line">      ..alignment = alignment</div><div class="line">      ..textDirection = textDirection ?? Directionality.of(context)</div><div class="line">      ..fit = fit</div><div class="line">      ..clipBehavior = overflow == Overflow.visible ? Clip.none : clipBehavior;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>widget.updateRenderObject()</code> çš„ä½œç”¨æ˜¯æŠŠ Widget ä¸­çš„å±æ€§å€¼ï¼Œç»‘å®šåˆ° RenderObject ä¸­ï¼Œå±æ€§çš„ç±»å‹ä¸€ä¸€å¯¹åº”ã€‚</p>
<h2 id="3-1ã€Element-build"><a href="#3-1ã€Element-build" class="headerlink" title="3.1ã€Element.build()"></a>3.1ã€Element.build()</h2><p><code>build()</code> åœ¨å„ä¸ªç±»å‹çš„ Element çš„å®ç°ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// StatefullElement</span></div><div class="line">	<span class="meta">@override</span></div><div class="line">  Widget build() =&gt; _state.build(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="comment">// StatelessElement</span></div><div class="line">  <span class="meta">@override</span></div><div class="line">  Widget build() =&gt; widget.build(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="comment">// ProxyElement</span></div><div class="line">  <span class="meta">@override</span></div><div class="line">  Widget build() =&gt; widget.child;</div></pre></td></tr></table></figure>
<h2 id="3-2ã€Element-updateChild"><a href="#3-2ã€Element-updateChild" class="headerlink" title="3.2ã€Element.updateChild()"></a>3.2ã€Element.updateChild()</h2><p>è¿™ä¸ªæ–¹æ³•æ˜¯å“åº”å¼UIçš„åŸºç¡€ï¼Œä¹Ÿæ˜¯ Dart Framework çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ï¼Œçœ‹ä¸‹å®ç°ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@protected</span></div><div class="line"><span class="built_in">Element</span> updateChild(<span class="built_in">Element</span> child, Widget newWidget, <span class="keyword">dynamic</span> newSlot) &#123;</div><div class="line">  <span class="keyword">if</span> (newWidget == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">// case 1</span></div><div class="line">    <span class="keyword">if</span> (child != <span class="keyword">null</span>)</div><div class="line">      deactivateChild(child);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">Element</span> newChild;</div><div class="line">  <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">// case 2</span></div><div class="line">    <span class="built_in">bool</span> hasSameSuperclass = <span class="keyword">true</span>;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (hasSameSuperclass &amp;&amp; child.widget == newWidget) &#123;</div><div class="line">      <span class="comment">// case 2.1</span></div><div class="line">      <span class="keyword">if</span> (child.slot != newSlot)</div><div class="line">        updateSlotForChild(child, newSlot);</div><div class="line">      newChild = child;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasSameSuperclass &amp;&amp; Widget.canUpdate(child.widget, newWidget)) &#123;</div><div class="line">      <span class="comment">// case 2.2</span></div><div class="line">      <span class="keyword">if</span> (child.slot != newSlot)</div><div class="line">        updateSlotForChild(child, newSlot);</div><div class="line">      child.update(newWidget);</div><div class="line">      newChild = child;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// case 2.3</span></div><div class="line">      deactivateChild(child);</div><div class="line">      newChild = inflateWidget(newWidget, newSlot);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// case 3</span></div><div class="line">    newChild = inflateWidget(newWidget, newSlot);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> newChild;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè¦å…ˆæ˜ç¡®ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ›´æ–°å­æ ‘çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•° <code>child</code> æ˜¯ <strong>å­Element</strong>ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>newWidget</code>æ˜¯ <strong>å­Widget</strong> ã€‚</p>
<p>åˆ†å‡ ç§æƒ…å†µï¼š</p>
<ul>
<li>case 1ï¼šnewWidget ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯å½“å‰ Element èŠ‚ç‚¹å¯¹åº”çš„ Widget build() è¿”å›äº†ç©ºï¼Œé‚£ä¹ˆæ ‡è®°childä¸ºéæ¿€æ´»çŠ¶æ€(å½“å‰å¸§ç»˜åˆ¶å®Œæˆåä¼šè¢«å¸è½½)ï¼Œç„¶åè¿”å›ç©º</li>
<li>case 2ï¼šå¦‚æœchildä¸ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰æ„å»ºè¿‡ä¸€æ¬¡å­Element<ul>
<li>case 2.1ï¼šå¦‚æœå­Elementå¯¹åº”çš„widget å³ child.widget å’Œæ–°æ„å»ºçš„ newWidget ç›¸ç­‰ï¼Œç›´æ¥æ›´æ–°å­widgetï¼Œå¦‚æœæ’æ§½ä¸åŒï¼Œæ›´æ–°ä¸‹æ’æ§½</li>
<li>case 2.2ï¼šå¦‚æœ <code>Widget.canUpdate(child.widget, newWidget)</code> ï¼Œåˆ¤æ–­æ ‡å‡†æ˜¯ <code>runtimeType</code> å’Œ<code>key</code> éƒ½ç›¸ç­‰ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>update()</code> æ›´æ–° child</li>
<li>case 2.3ï¼šå¦åˆ™childä¸å¯å¤ç”¨ï¼Œæ ‡è®°childä¸ºéæ¿€æ´»çŠ¶æ€(å½“å‰å¸§ç»˜åˆ¶å®Œæˆåä¼šè¢«å¸è½½)ï¼Œç„¶åæ„å»ºå‡ºä¸€ä¸ªæ–°çš„ Element èŠ‚ç‚¹ï¼ŒæŒ‚è½½åˆ°Element Treeä¸Š</li>
</ul>
</li>
<li>case 3ï¼šå¦åˆ™ child ä¸ºç©ºï¼Œä¸å¯å¤ç”¨ï¼Œæ„å»ºå‡ºä¸€ä¸ªæ–°çš„ Element èŠ‚ç‚¹ï¼ŒæŒ‚è½½åˆ°Element Treeä¸Š</li>
</ul>
<p>ä¸‹é¢çœ‹ä¸‹å‡ ä¸ªå…³é”®çš„æ–¹æ³•</p>
<h2 id="3-3ã€Element-update"><a href="#3-3ã€Element-update" class="headerlink" title="3.3ã€Element.update()"></a>3.3ã€Element.update()</h2><p>Element ç±»å®ç°ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/framework.dart Element  </span></div><div class="line">	<span class="meta">@mustCallSuper</span> <span class="comment">// å­ç±»å¤å†™è¯¥æ–¹æ³•å¿…é¡»è°ƒç”¨super</span></div><div class="line">  <span class="keyword">void</span> update(covariant Widget newWidget) &#123;</div><div class="line">    _widget = newWidget;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>ç›´æ¥æ›´æ–° Element å­èŠ‚ç‚¹çš„ <code>_widget</code> å¼•ç”¨ã€‚</p>
<p>å­ç±»å¤å†™è¯¥æ–¹æ³•å¿…é¡»è°ƒç”¨superã€‚</p>
<p>çœ‹ä¸‹å­ç±»çš„å®ç°ã€‚</p>
<h3 id="3-3-1ã€RenderObjectElement-update"><a href="#3-3-1ã€RenderObjectElement-update" class="headerlink" title="3.3.1ã€RenderObjectElement.update()"></a>3.3.1ã€RenderObjectElement.update()</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RenderObjectElement</span> <span class="keyword">extends</span> <span class="title">Element</span> </span>&#123;</div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> update(covariant RenderObjectWidget newWidget) &#123;</div><div class="line">    <span class="keyword">super</span>.update(newWidget);</div><div class="line">    widget.updateRenderObject(<span class="keyword">this</span>, renderObject);</div><div class="line">    _dirty = <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒä¸Šé¢ä¸€æ ·ï¼ŒæŠŠ newWidget ä¸­çš„å±æ€§å€¼ï¼Œç»‘å®šåˆ° RenderObject ä¸­ã€‚</p>
<p><code>SingleChildRenderObjectElement</code>ã€<code>MultiChildRenderObjectElement</code> æ˜¯ <code>RenderObjectElement</code> çš„å­ç±»ï¼Œåˆ†åˆ«çœ‹ä¸‹å®ç°ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleChildRenderObjectElement</span> <span class="keyword">extends</span> <span class="title">RenderObjectElement</span> </span>&#123;</div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> update(SingleChildRenderObjectWidget newWidget) &#123;</div><div class="line">    <span class="keyword">super</span>.update(newWidget);</div><div class="line">    <span class="comment">// æ›´æ–°å­æ ‘</span></div><div class="line">    _child = updateChild(_child, widget.child, <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨superï¼Œå¤ç”¨ RenderObjectElement.update() é€»è¾‘</li>
<li>æ›´æ–°å­æ ‘</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiChildRenderObjectElement</span> <span class="keyword">extends</span> <span class="title">RenderObjectElement</span> </span>&#123;</div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> update(MultiChildRenderObjectWidget newWidget) &#123;</div><div class="line">    <span class="keyword">super</span>.update(newWidget);</div><div class="line">    _children = updateChildren(_children, widget.children, forgottenChildren: _forgottenChildren);</div><div class="line">    _forgottenChildren.clear();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨superï¼Œå¤ç”¨ RenderObjectElement.update() é€»è¾‘</li>
<li>é€šè¿‡å·®åˆ†ç®—æ³•å°†æ–°æ„é€ çš„ widget.children ç»‘å®šåˆ°å·²æœ‰çš„ _children ä¸Šæ¥æ›´æ–°å­æ ‘ï¼ŒupdateChildren() é€»è¾‘è™½ç„¶çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†æ˜¯è¿˜æ¯”è¾ƒå¥½ç†è§£ï¼Œè¿™é‡Œå°±ä¸æ”¾æºç äº†ï¼Œè¯´ä¸‹é€»è¾‘<ul>
<li>é¦–å…ˆä» topIndex åˆ° bottomIndex éå† oldChildElement å’Œ newChildWidgetï¼Œå¦‚æœ<code>Widget.canUpdate(oldChild.widget, newWidget)</code>ï¼Œé‚£ä¹ˆ<code>updateChild()</code>æ›´æ–°å­æ ‘ <code>updateChild()</code>ï¼Œç›´åˆ°åŒ¹é…å¤±è´¥ï¼Œè®°å½• topIndex ç´¯åŠ å€¼</li>
<li>ä» bottomIndex åˆ° topIndex éå†oldChildElement å’Œ newChildWidgetï¼Œç›´åˆ°åŒ¹é…å¤±è´¥ï¼Œè®°å½• bottomIndex ç´¯å‡å€¼ï¼Œè¿™é‡Œä¸æ›´æ–°å­æ ‘</li>
<li>éå†ç¼©å°äº†çš„ oldChildElement åˆ—è¡¨ï¼Œè®°å½• oldChild.widget.key å’Œ oldChild åˆ° mapï¼Œkeyä¸ºç©ºçš„åæ¿€æ´»</li>
<li>éå†ç¼©å°äº†çš„ newChildWidget åˆ—è¡¨ï¼ŒåŒ¹é… map ä¸­çš„keyç±»å‹ï¼Œ<code>updateChild()</code> æ›´æ–°å­æ ‘ï¼ŒæœªåŒ¹é…åˆ°çš„åæ¿€æ´»</li>
<li>æœ€åæ›´æ–°ç¬¬äºŒæ­¥å¾—åˆ°å‰©ä½™çš„éƒ¨åˆ†</li>
</ul>
</li>
</ul>
<h3 id="3-3-2ã€StatefullElement-update"><a href="#3-3-2ã€StatefullElement-update" class="headerlink" title="3.3.2ã€StatefullElement.update()"></a>3.3.2ã€StatefullElement.update()</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@override</span></div><div class="line"><span class="keyword">void</span> update(StatefulWidget newWidget) &#123;</div><div class="line">  <span class="keyword">super</span>.update(newWidget);</div><div class="line">  <span class="keyword">final</span> StatefulWidget oldWidget = _state._widget;</div><div class="line">  <span class="comment">// Notice that we mark ourselves as dirty before calling didUpdateWidget to</span></div><div class="line">  <span class="comment">// let authors call setState from within didUpdateWidget without triggering</span></div><div class="line">  <span class="comment">// asserts.</span></div><div class="line">  _dirty = <span class="keyword">true</span>;</div><div class="line">  _state._widget = widget <span class="keyword">as</span> StatefulWidget;</div><div class="line">  <span class="keyword">final</span> <span class="keyword">dynamic</span> debugCheckForReturnedFuture = _state.didUpdateWidget(oldWidget) <span class="keyword">as</span> <span class="keyword">dynamic</span>;</div><div class="line">  <span class="comment">// æ›´æ–°å­æ ‘</span></div><div class="line">  rebuild();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ super</li>
<li>æ›´æ–° state ä¸­ widget çš„å¼•ç”¨</li>
<li>è°ƒç”¨ _state.didUpdateWidget(oldWidget)</li>
<li>è°ƒç”¨ <code>rebuild()</code> æ›´æ–°å­æ ‘ï¼Œç”±äº <code>rebuild()</code> ä¸€å®šä¼šè§¦å‘ <code>build()</code> æ–¹æ³•è°ƒç”¨ï¼Œæ‰€ä»¥è¿™é‡Œè¿›è¡Œæ ‡è„</li>
</ul>
<p>StatelessElement.update() ç±»ä¼¼ï¼Œä¸å†™å‡ºæ¥äº†ã€‚</p>
<h2 id="3-4ã€Element-inflateWidget"><a href="#3-4ã€Element-inflateWidget" class="headerlink" title="3.4ã€Element.inflateWidget()"></a>3.4ã€Element.inflateWidget()</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@protected</span></div><div class="line"><span class="built_in">Element</span> inflateWidget(Widget newWidget, <span class="keyword">dynamic</span> newSlot) &#123;</div><div class="line">  <span class="keyword">final</span> Key key = newWidget.key;</div><div class="line">  <span class="keyword">if</span> (key <span class="keyword">is</span> GlobalKey) &#123;</div><div class="line">    <span class="comment">// å¦‚æœkeyç±»å‹æ˜¯ GlobalKeyï¼Œä»éæ¿€æ´»çŠ¶æ€çš„åˆ—è¡¨ä¸­å°è¯•åŒ¹é…ç±»å‹ç›¸åŒçš„èŠ‚ç‚¹ï¼ŒæŠ¢æ•‘å¤ç”¨ä¸€ä¸‹</span></div><div class="line">    <span class="keyword">final</span> <span class="built_in">Element</span> newChild = _retakeInactiveElement(key, newWidget);</div><div class="line">    <span class="keyword">if</span> (newChild != <span class="keyword">null</span>) &#123;</div><div class="line">      newChild._activateWithParent(<span class="keyword">this</span>, newSlot);</div><div class="line">      <span class="keyword">final</span> <span class="built_in">Element</span> updatedChild = updateChild(newChild, newWidget, newSlot);</div><div class="line">      <span class="keyword">return</span> updatedChild;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// é€šè¿‡ Widgetï¼Œåˆ›å»ºå¯¹åº”çš„ Element</span></div><div class="line">  <span class="keyword">final</span> <span class="built_in">Element</span> newChild = newWidget.createElement();</div><div class="line"><span class="comment">// æŒ‚è½½åˆ° Element Tree ä¸Š</span></div><div class="line">  newChild.mount(<span class="keyword">this</span>, newSlot);</div><div class="line">  <span class="keyword">return</span> newChild;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœkeyç±»å‹æ˜¯ GlobalKeyï¼Œä»éæ¿€æ´»çŠ¶æ€çš„åˆ—è¡¨ä¸­å°è¯•åŒ¹é…ç±»å‹ç›¸åŒçš„èŠ‚ç‚¹ï¼ŒæŠ¢æ•‘æ€§å¤ç”¨ä¸€ä¸‹</li>
<li>é€šè¿‡ Widgetï¼Œåˆ›å»ºå¯¹åº”çš„ Element</li>
<li>æŒ‚è½½åˆ° Element Tree ä¸Š</li>
</ul>
<h2 id="3-5ã€Element-mount"><a href="#3-5ã€Element-mount" class="headerlink" title="3.5ã€Element.mount()"></a>3.5ã€Element.mount()</h2><p>æŒ‚è½½åˆ°Element Treeä¸Š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@mustCallSuper</span></div><div class="line"><span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="keyword">dynamic</span> newSlot) &#123;</div><div class="line">  <span class="comment">// æ›´æ–°çˆ¶èŠ‚ç‚¹ä¿¡æ¯</span></div><div class="line">  _parent = parent;</div><div class="line">  <span class="comment">// æ›´æ–°æ’æ§½ä¿¡æ¯</span></div><div class="line">  _slot = newSlot;</div><div class="line">  <span class="comment">// æ›´æ–°æ·±åº¦</span></div><div class="line">  _depth = _parent != <span class="keyword">null</span> ? _parent.depth + <span class="number">1</span> : <span class="number">1</span>;</div><div class="line">  <span class="comment">// ä»åˆå§‹åŒ–çŠ¶æ€æ›´æ”¹ä¸ºæ¿€æ´»çŠ¶æ€</span></div><div class="line">  _active = <span class="keyword">true</span>;</div><div class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) </div><div class="line">    <span class="comment">// ç»‘å®š BuildOwner å¯¹è±¡</span></div><div class="line">    _owner = parent.owner;</div><div class="line">  <span class="keyword">final</span> Key key = widget.key;</div><div class="line">  <span class="keyword">if</span> (key <span class="keyword">is</span> GlobalKey) &#123;</div><div class="line">    <span class="comment">// å¦‚æœæ˜¯ GlobalKeyï¼Œæ³¨å†Œåˆ°å…¬å…±mapï¼Œå…¨å±€å¤ç”¨</span></div><div class="line">    key._register(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// ä» parent æ›´æ–° _inheritedWidgetsï¼Œç”¨äºä¼ é€’é™„åŠ ä¿¡æ¯</span></div><div class="line">  _updateInheritance();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ›´æ–°çˆ¶èŠ‚ç‚¹ä¿¡æ¯</li>
<li>æ›´æ–°æ’æ§½ä¿¡æ¯</li>
<li>æ›´æ–°æ·±åº¦</li>
<li>ä»åˆå§‹åŒ–çŠ¶æ€æ›´æ”¹ä¸ºæ¿€æ´»çŠ¶æ€</li>
<li>ç»‘å®š BuildOwner å¯¹è±¡</li>
<li>å¦‚æœæ˜¯ GlobalKeyï¼Œæ³¨å†Œåˆ°å…¬å…±mapï¼Œå…¨å±€å¤ç”¨</li>
<li>ä» parent æ›´æ–° _inheritedWidgetsï¼Œç”¨äºä¼ é€’é™„åŠ ä¿¡æ¯</li>
</ul>
<p>å¦‚æœå­ç±»å¤å†™è¯¥æ–¹æ³•ï¼Œé‚£ä¹ˆå¿…é¡»è¦è°ƒç”¨ superã€‚</p>
<h3 id="3-5-1ã€ComponentElement-mount"><a href="#3-5-1ã€ComponentElement-mount" class="headerlink" title="3.5.1ã€ComponentElement.mount()"></a>3.5.1ã€ComponentElement.mount()</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentElement</span> <span class="keyword">extends</span> <span class="title">Element</span> </span>&#123;  </div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="keyword">dynamic</span> newSlot) &#123;</div><div class="line">    <span class="keyword">super</span>.mount(parent, newSlot);</div><div class="line">    _firstBuild();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">void</span> _firstBuild() &#123;</div><div class="line">    rebuild();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ super() è°ƒç”¨ <code>Element.mount()</code></li>
<li>è°ƒç”¨ _firstBuild() -&gt; rebuild() -&gt; performRebuild() æ„å»º Element å­æ ‘</li>
</ul>
<p>ä¸‹é¢è¿˜æœ‰ SingleChildRenderObjectElement ã€MultiChildRenderObjectElement ç­‰å­ç±»ï¼Œé€»è¾‘è·Ÿ<code>update()</code>å·®ä¸å¤šï¼Œå°±ä¸åˆ—å‡ºæ¥äº†ã€‚</p>
<h3 id="3-5-2ã€RenderObjectElement-mount"><a href="#3-5-2ã€RenderObjectElement-mount" class="headerlink" title="3.5.2ã€RenderObjectElement.mount()"></a>3.5.2ã€RenderObjectElement.mount()</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RenderObjectElement</span> <span class="keyword">extends</span> <span class="title">Element</span> </span>&#123;</div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="keyword">dynamic</span> newSlot) &#123;</div><div class="line">    <span class="keyword">super</span>.mount(parent, newSlot);</div><div class="line">    <span class="comment">// æ„å»º RenderObject</span></div><div class="line">    _renderObject = widget.createRenderObject(<span class="keyword">this</span>);</div><div class="line">		<span class="comment">// å°† RenderObject æŒ‚è½½åˆ° Render Tree ä¸Š</span></div><div class="line">    attachRenderObject(newSlot);</div><div class="line">    _dirty = <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨ super() è°ƒç”¨ <code>Element.mount()</code></li>
<li>æ„å»º RenderObject</li>
<li>å°† RenderObject æŒ‚è½½åˆ° Render Tree ä¸Š</li>
</ul>
<h2 id="3-6ã€RenderObjectElement-attachRenderObject"><a href="#3-6ã€RenderObjectElement-attachRenderObject" class="headerlink" title="3.6ã€RenderObjectElement.attachRenderObject()"></a>3.6ã€RenderObjectElement.attachRenderObject()</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RenderObjectElement</span> <span class="keyword">extends</span> <span class="title">Element</span> </span>&#123;  </div><div class="line">	<span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> attachRenderObject(<span class="keyword">dynamic</span> newSlot) &#123;</div><div class="line">    _slot = newSlot;</div><div class="line">    <span class="comment">// Element Tree å‘ä¸Šéå†ç¥–å…ˆèŠ‚ç‚¹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª RenderObject èŠ‚ç‚¹</span></div><div class="line">    _ancestorRenderObjectElement = _findAncestorRenderObjectElement();</div><div class="line">    <span class="comment">// æ ¹æ®è§„åˆ™æ’å…¥åˆ° Render Tree ä¸­ï¼Œéœ€è¦å­ç±»å®ç°</span></div><div class="line">    _ancestorRenderObjectElement?.insertChildRenderObject(renderObject, newSlot);</div><div class="line">    <span class="comment">// Element Tree å‘ä¸Šéå†ç¥–å…ˆèŠ‚ç‚¹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª ParentDataElement èŠ‚ç‚¹</span></div><div class="line">    <span class="keyword">final</span> ParentDataElement&lt;ParentData&gt; parentDataElement = _findAncestorParentDataElement();</div><div class="line">    <span class="keyword">if</span> (parentDataElement != <span class="keyword">null</span>)</div><div class="line">      _updateParentData(parentDataElement.widget);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">void</span> _updateParentData(ParentDataWidget&lt;ParentData&gt; parentDataWidget) &#123;</div><div class="line">    ...</div><div class="line">    parentDataWidget.applyParentData(renderObject);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Element Tree å‘ä¸Šéå†ç¥–å…ˆèŠ‚ç‚¹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª RenderObject èŠ‚ç‚¹</li>
<li>æ ¹æ®è§„åˆ™æ’å…¥åˆ° Render Tree ä¸­ï¼Œéœ€è¦å­ç±»å®ç°</li>
<li>Element Tree å‘ä¸Šéå†ç¥–å…ˆèŠ‚ç‚¹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª ParentDataElement èŠ‚ç‚¹ï¼ŒParentDataElement èŠ‚ç‚¹ä¸­è®°å½•ç€å¸ƒå±€ä½ç½®ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¿”å›ç©º</li>
<li>æ ¹æ® ParentDataElement æ‰¾åˆ°å¯¹åº”çš„ ParentDataWidgetï¼Œè°ƒç”¨ <code>applyParentData()</code></li>
</ul>
<p>å…¶ä¸­ï¼Œ<code>ParentDataElement</code> æ ¹æ®å‚æ•°ç»‘å®šäº† <code>ParentDataWidget</code> ç±»å‹ï¼Œå¹¶é€šè¿‡æ³›å‹ç»‘å®šäº† ParentData ç±»å‹ã€‚</p>
<h3 id="3-6-1ã€ParentDataWidget-applyParentData"><a href="#3-6-1ã€ParentDataWidget-applyParentData" class="headerlink" title="3.6.1ã€ParentDataWidget.applyParentData()"></a>3.6.1ã€ParentDataWidget.applyParentData()</h3><p>ParentDataWidget æ˜¯ ProxyWidget çš„å­ç±»ï¼Œå®ƒçš„å­ç±»åŒ…æ‹¬ Flexibleã€LayoutIdã€Positionedã€KeepAlive ç­‰Widgetã€‚</p>
<p>ParentDataWidget ä½¿ç”¨æ³›å‹ç»‘å®šäº† ParentData ç±»å‹ã€‚</p>
<p>ä»¥ Flexible ä¸ºä¾‹çœ‹ä¸‹å®ç°ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flexible</span> <span class="keyword">extends</span> <span class="title">ParentDataWidget</span>&lt;<span class="title">FlexParentData</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> applyParentData(RenderObject renderObject) &#123;</div><div class="line">    <span class="keyword">final</span> FlexParentData parentData = renderObject.parentData <span class="keyword">as</span> FlexParentData;</div><div class="line">    <span class="built_in">bool</span> needsLayout = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parentData.flex != flex) &#123;</div><div class="line">      parentData.flex = flex;</div><div class="line">      needsLayout = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parentData.fit != fit) &#123;</div><div class="line">      parentData.fit = fit;</div><div class="line">      needsLayout = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (needsLayout) &#123;</div><div class="line">      <span class="keyword">final</span> AbstractNode targetParent = renderObject.parent;</div><div class="line">      <span class="keyword">if</span> (targetParent <span class="keyword">is</span> RenderObject)</div><div class="line">        targetParent.markNeedsLayout();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ›´æ–°å¸ƒå±€å±æ€§ä¿¡æ¯</li>
<li>RenderObject èŠ‚ç‚¹ Layout æ ‡è„ï¼Œè®°å½•åœ¨ <code>BuildOwner._nodesNeedingLayout</code> åˆ—è¡¨ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥ Layout å¤„ç†</li>
</ul>
<h1 id="4ã€æ€»ç»“"><a href="#4ã€æ€»ç»“" class="headerlink" title="4ã€æ€»ç»“"></a>4ã€æ€»ç»“</h1><p>æœ¬ç¯‡æ–‡ç« ä»‹ç»äº† <code>WidgetsBinding.drawFrame()</code> çš„è¿‡ç¨‹ï¼Œä»¥åŠ Widgetã€Elementã€RenderObject åŠä¸‰æ£µæ ‘çš„å…³ç³»ï¼Œæ¢³ç†äº†<code>build()</code> è¿‡ç¨‹åœ¨ä¸‰æ£µæ ‘ä¹‹é—´çš„æµè½¬å…³ç³»ï¼Œé€šè¿‡ Element Tree å’Œ Widget Tree æ„å»ºäº† Render Treeï¼Œæœ€ç»ˆè§¦å‘ RenderObject.markNeedsLayout()  Layout æ ‡è„æ“ä½œï¼Œè®°å½•åœ¨ <code>BuildOwner._nodesNeedingLayout</code> åˆ—è¡¨ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥ Layout å¤„ç†ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« å°†ç»§ç»­åˆ†æ <code>RendererBinding.drawFrame()</code> ä¸­ Layout è¿‡ç¨‹ã€‚</p>
<p>å‚è€ƒ </p>
<ul>
<li><p><a href="https://www.didierboelens.com/2019/09/flutter-internals/" target="_blank" rel="external">Flutter Internals</a></p>
</li>
<li><p><a href="https://blog.voiddog.org/1599449233776/" target="_blank" rel="external">è°ˆè°ˆ Flutter çš„ build</a></p>
</li>
<li><p><a href="http://zxfcumtcs.github.io/2020/05/17/deepinto-flutter-element/" target="_blank" rel="external">æ·±å…¥æµ…å‡º Flutter Framework ä¹‹ Element</a></p>
</li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2020/11/16/flutter-ui-build/">http://w4lle.com/2020/11/16/flutter-ui-build/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç³»åˆ—æ–‡ç« çš„ç¬¬å››ç¯‡ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹ Element.rebuild() è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;æºç åŸºäº Flutter v1.20.4ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Flutter" scheme="http://w4lle.com/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Flutter UI æ¸²æŸ“æµ…æï¼ˆä¸‰ï¼‰Animation åŸç†</title>
    <link href="http://w4lle.com/2020/11/13/flutter-ui-animate/"/>
    <id>http://w4lle.com/2020/11/13/flutter-ui-animate/</id>
    <published>2020-11-13T10:45:24.000Z</published>
    <updated>2020-11-16T06:48:15.232Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸‰ç¯‡ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹æ”¶åˆ° VSync ä¿¡å·å›è°ƒå Dart Framework è§¦å‘åŠ¨ç”»çš„è¿‡ç¨‹åŠåŠ¨ç”»å®ç°åŸç†ã€‚</p>
<p>åŸºäº Android å¹³å°ï¼ŒFlutter v1.20.4ã€‚</p>
<a id="more"></a>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ€åï¼Œæˆ‘ä»¬æåˆ°åšä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>æ‰§è¡Œ Dart Framework <code>dart:ui</code> åŒ…ä¸‹çš„ <code>_beginFrame()</code></li>
<li>æ‰§è¡Œ microtasks ä»»åŠ¡</li>
<li>æ‰§è¡Œ Dart Framework <code>dart:ui</code> åŒ…ä¸‹çš„  <code>_drawFrame()</code></li>
</ul>
<p><code>dart:ui</code> åŒ…ä¸‹çš„ä¸¤ä¸ªæ–¹æ³•çš„å®ç°åœ¨ hooks.dart</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/ui/hooks.dart</span></div><div class="line"><span class="comment">// æ²¡æœ‰ç›´æ¥å¼•ç”¨ï¼Œæ³¨è§£æ ‡è®°é˜²æ­¢è¢« tree shakingå¹²æ‰</span></div><div class="line"><span class="meta">@pragma</span>(<span class="string">'vm:entry-point'</span>)</div><div class="line"><span class="keyword">void</span> _beginFrame(<span class="built_in">int</span> microseconds) &#123;</div><div class="line">  <span class="comment">// æ‰§è¡Œ window.onBeginFrame</span></div><div class="line">  _invoke1&lt;<span class="built_in">Duration</span>&gt;(<span class="built_in">window</span>.onBeginFrame, <span class="built_in">window</span>._onBeginFrameZone, <span class="built_in">Duration</span>(microseconds: microseconds));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@pragma</span>(<span class="string">'vm:entry-point'</span>)</div><div class="line"><span class="keyword">void</span> _drawFrame() &#123;</div><div class="line">  <span class="comment">// æ‰§è¡Œ window.onDrawFrame</span></div><div class="line">  _invoke(<span class="built_in">window</span>.onDrawFrame, <span class="built_in">window</span>._onDrawFrameZone);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> _invoke(<span class="keyword">void</span> callback()?, Zone zone) &#123;</div><div class="line">	...</div><div class="line">    <span class="comment">// è¿è¡Œ zone æœªå˜ï¼Œç›´æ¥è°ƒç”¨æ–¹æ³•</span></div><div class="line">  <span class="keyword">if</span> (identical(zone, Zone.current)) &#123;</div><div class="line">    callback();</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    zone.runGuarded(callback);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°ï¼Œ<code>SchedulerBinding</code> æ³¨å†Œäº† <code>window.onBeginFrame()</code> å’Œ <code>window.onDrawFrame()</code>ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/scheduler/binding.dart</span></div><div class="line">  <span class="keyword">void</span> ensureFrameCallbacksRegistered() &#123;</div><div class="line">    <span class="comment">// æ³¨å†Œ onBeginFrame ã€onDrawFrame å›è°ƒæ–¹æ³•</span></div><div class="line">    <span class="built_in">window</span>.onBeginFrame ??= _handleBeginFrame;</div><div class="line">    <span class="built_in">window</span>.onDrawFrame ??= _handleDrawFrame;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>æœ¬ç¯‡æ–‡ç« å…ˆåˆ†æ <code>SchedulerBinding._handleBeginFrame()</code>ã€‚</p>
<h2 id="1ã€-handleBeginFrame"><a href="#1ã€-handleBeginFrame" class="headerlink" title="1ã€_handleBeginFrame()"></a>1ã€_handleBeginFrame()</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> _handleBeginFrame(<span class="built_in">Duration</span> rawTimeStamp) &#123;</div><div class="line">  <span class="keyword">if</span> (_warmUpFrame) &#123;</div><div class="line">    <span class="comment">// å¦‚æœæ˜¯å¯åŠ¨é¢„çƒ­å¸§ï¼Œå¿½ç•¥æœ¬æ¬¡è°ƒç”¨</span></div><div class="line">    _ignoreNextEngineDrawFrame = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  handleBeginFrame(rawTimeStamp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯å¯åŠ¨é¢„çƒ­å¸§ï¼Œå¿½ç•¥æœ¬æ¬¡è°ƒç”¨ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> handleBeginFrame(<span class="built_in">Duration</span> rawTimeStamp) &#123;</div><div class="line">  <span class="comment">// å¼€å§‹è®°å½• Frame è¿‡ç¨‹</span></div><div class="line">  Timeline.startSync(<span class="string">'Frame'</span>, arguments: timelineArgumentsIndicatingLandmarkEvent);</div><div class="line">  _firstRawTimeStampInEpoch ??= rawTimeStamp;</div><div class="line">  _currentFrameTimeStamp = _adjustForEpoch(rawTimeStamp ?? _lastRawTimeStamp);</div><div class="line">  <span class="keyword">if</span> (rawTimeStamp != <span class="keyword">null</span>)</div><div class="line">    _lastRawTimeStamp = rawTimeStamp;</div><div class="line"></div><div class="line">  <span class="keyword">assert</span>(() &#123;</div><div class="line">    <span class="comment">// ç»˜åˆ¶æ¬¡æ•° + 1</span></div><div class="line">    _debugFrameNumber += <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (debugPrintBeginFrameBanner || debugPrintEndFrameBanner) &#123;</div><div class="line">      <span class="keyword">final</span> <span class="built_in">StringBuffer</span> frameTimeStampDescription = <span class="built_in">StringBuffer</span>();</div><div class="line">      <span class="keyword">if</span> (rawTimeStamp != <span class="keyword">null</span>) &#123;</div><div class="line">        _debugDescribeTimeStamp(_currentFrameTimeStamp, frameTimeStampDescription);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        frameTimeStampDescription.write(<span class="string">'(warm-up frame)'</span>);</div><div class="line">      &#125;</div><div class="line">      _debugBanner = <span class="string">'â–„â–„â–„â–„â–„â–„â–„â–„ Frame <span class="subst">$&#123;_debugFrameNumber.toString().padRight(<span class="number">7</span>)&#125;</span>   <span class="subst">$&#123;frameTimeStampDescription.toString().padLeft(<span class="number">18</span>)&#125;</span> â–„â–„â–„â–„â–„â–„â–„â–„'</span>;</div><div class="line">      <span class="keyword">if</span> (debugPrintBeginFrameBanner)</div><div class="line">        debugPrint(_debugBanner);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;());</div><div class="line"><span class="comment">//å½“å‰å¤„äº SchedulerPhase.idle çŠ¶æ€</span></div><div class="line">  <span class="keyword">assert</span>(schedulerPhase == SchedulerPhase.idle);</div><div class="line">  <span class="comment">// æ›´æ–°æ ‡å¿—ä½ï¼Œæ¥æ”¶ä¸‹æ¬¡ scheduleFrame è¯·æ±‚</span></div><div class="line">  _hasScheduledFrame = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// TRANSIENT FRAME CALLBACKS</span></div><div class="line">    <span class="comment">// å¼€å§‹è®°å½• Animate è¿‡ç¨‹</span></div><div class="line">    Timeline.startSync(<span class="string">'Animate'</span>, arguments: timelineArgumentsIndicatingLandmarkEvent);</div><div class="line">    _schedulerPhase = SchedulerPhase.transientCallbacks;</div><div class="line">    <span class="comment">// æ‰§è¡Œ transientCallbacks å›è°ƒ</span></div><div class="line">    <span class="keyword">final</span> <span class="built_in">Map</span>&lt;<span class="built_in">int</span>, _FrameCallbackEntry&gt; callbacks = _transientCallbacks;</div><div class="line">    <span class="comment">// æ¸…ç©ºåˆ—è¡¨</span></div><div class="line">    _transientCallbacks = &lt;<span class="built_in">int</span>, _FrameCallbackEntry&gt;&#123;&#125;;</div><div class="line">    callbacks.forEach((<span class="built_in">int</span> id, _FrameCallbackEntry callbackEntry) &#123;</div><div class="line">      <span class="keyword">if</span> (!_removedIds.contains(id))</div><div class="line">        _invokeFrameCallback(callbackEntry.callback, _currentFrameTimeStamp, callbackEntry.debugStack);</div><div class="line">    &#125;);</div><div class="line">    _removedIds.clear();</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="comment">//æ”¹å˜çŠ¶æ€ä¸º SchedulerPhase.midFrameMicrotasks</span></div><div class="line">    _schedulerPhase = SchedulerPhase.midFrameMicrotasks;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>TimeLine å¼€å§‹è®°å½• <code>Frame</code> è¿‡ç¨‹</li>
<li>å¦‚æœ debugPrintBeginFrameBanner || debugPrintEndFrameBanner æ‰“å°ç»˜åˆ¶æ¬¡æ•°åŠæ—¶é—´</li>
<li>æ›´æ–°æ ‡å¿—ä½ _hasScheduledFrame = false ï¼Œæ¥æ”¶ä¸‹æ¬¡ scheduleFrame è¯·æ±‚</li>
<li>å¼€å§‹è®°å½• Animate è¿‡ç¨‹</li>
<li>æ‰§è¡Œ <code>transientCallbacks</code> ç¬æ—¶å¸§å›è°ƒï¼Œå¹¶æ¸…ç©ºå›è°ƒåˆ—è¡¨ï¼Œç”± <code>WidgetsBinding.scheduleFrameCallback()</code> æ³¨å†Œ</li>
<li>æ”¹å˜çŠ¶æ€ä¸º <code>SchedulerPhase.midFrameMicrotasks</code></li>
</ul>
<p>æ‰“å°å¦‚ä¸‹ï¼Œæ‰“å°çš„æ—¶é—´ä¸ºè·ç¦»é¦–å¸§ç»˜åˆ¶çš„æ—¶é—´ï¼Œ<code>warm-up frame</code> ä¸º <code>runApp()</code> å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ<code>RenderView</code> è§¦å‘çš„é¢„çƒ­å¸§ï¼Œé C ++ Engine å›è°ƒ</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">I/flutter (<span class="number">14160</span>): â–„â–„â–„â–„â–„â–„â–„â–„ Frame <span class="number">1</span>            (warm-up frame) â–„â–„â–„â–„â–„â–„â–„â–„</div><div class="line">I/flutter (<span class="number">14160</span>): â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€</div><div class="line">D/PhoneWindow(<span class="number">14160</span>): setNavigationBarColor: ff000000</div><div class="line">I/flutter (<span class="number">14160</span>): â–„â–„â–„â–„â–„â–„â–„â–„ Frame <span class="number">2</span>                        <span class="number">0</span>ms â–„â–„â–„â–„â–„â–„â–„â–„</div><div class="line">I/flutter (<span class="number">14160</span>): â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€</div><div class="line">I/flutter (<span class="number">14160</span>): [verbose]: Add bucket <span class="keyword">in</span> <span class="keyword">set</span> from <span class="number">0</span></div><div class="line">I/flutter (<span class="number">14160</span>): â–„â–„â–„â–„â–„â–„â–„â–„ Frame <span class="number">3</span>                  <span class="number">301.668</span>ms â–„â–„â–„â–„â–„â–„â–„â–„</div><div class="line">I/flutter (<span class="number">14160</span>): â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€</div><div class="line">I/flutter (<span class="number">14160</span>): â–„â–„â–„â–„â–„â–„â–„â–„ Frame <span class="number">4</span>                  <span class="number">402.225</span>ms â–„â–„â–„â–„â–„â–„â–„â–„</div></pre></td></tr></table></figure>
<p><code>beginFrame()</code>ä¸»è¦æ˜¯æ‰§è¡Œ <code>transientCallbacks</code> ç¬æ—¶å¸§å›è°ƒï¼Œæ˜¯ç”± <code>WidgetsBinding.scheduleFrameCallback</code> æ³¨å†Œï¼Œç”¨æ¥å¤„ç†å¸§é—´åŠ¨ç”»è®¡ç®—å’Œæ›´æ–°çš„å·¥ä½œï¼Œå¦‚æœæ²¡æœ‰åŠ¨ç”»ï¼Œåˆ™ <code>transientCallbacks</code> ä¸ºç©ºã€‚</p>
<p>å…ˆçœ‹ä¸‹åŠ¨ç”»æ³¨å†Œç¬æ—¶å¸§å›è°ƒçš„è¿‡ç¨‹ã€‚</p>
<h2 id="2ã€Flutter-Animation-åŠ¨ç”»åŸç†"><a href="#2ã€Flutter-Animation-åŠ¨ç”»åŸç†" class="headerlink" title="2ã€Flutter Animation åŠ¨ç”»åŸç†"></a>2ã€Flutter Animation åŠ¨ç”»åŸç†</h2><h3 id="2-1ã€ä¸»è¦ç±»"><a href="#2-1ã€ä¸»è¦ç±»" class="headerlink" title="2.1ã€ä¸»è¦ç±»"></a>2.1ã€ä¸»è¦ç±»</h3><p>Flutter ä¸­çš„åŠ¨ç”»ä¸»è¦ç±»ç»“æ„å¦‚ä¸‹å›¾</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_animation.png" alt=""></p>
<ul>
<li><code>Animation</code> åŠ¨ç”»å®ç°ç±»ï¼Œé€šè¿‡ <code>Ticker</code> ç¬æ—¶å¸§å›è°ƒæ”¹å˜å½“å‰å€¼ï¼Œæä¾›å€¼å›è°ƒå’ŒçŠ¶æ€å›è°ƒ<ul>
<li>å€¼å›è°ƒ addListener(VoidCallback)</li>
<li>çŠ¶æ€å›è°ƒ addStatusListener(AnimationStatusListener)</li>
</ul>
</li>
<li><code>AnimationController</code> ï¼ŒåŠ¨ç”»æ§åˆ¶å™¨ï¼Œç”¨äºæ§åˆ¶ <code>Animation</code> è¿è¡ŒçŠ¶æ€ï¼Œæ³¨å†Œ <code>Ticker</code> å›è°ƒæ–¹æ³•</li>
<li><code>Ticker</code> ç”¨äºæ³¨å†Œ <code>SchedulerBinding.transientCallbacks</code> å›è°ƒï¼Œæ‰§è¡Œ <code>AnimationController</code> æ³¨å†Œçš„å›è°ƒ</li>
<li><code>TickerProvider</code> &amp; <code>SingleTickerProviderStateMixin</code>ï¼Œæä¾›é»˜è®¤çš„ <code>Ticker</code> å¯¹è±¡</li>
<li><code>AnimateWidget</code> &amp; <code>AnimateState</code> or  <code>AnimateBuilder</code>  åŠ¨ç”» UI å±•ç¤ºï¼Œæ³¨å†Œ <code>Animation</code> å€¼å›è°ƒï¼Œè‡ªåŠ¨è§¦å‘ <code>setState()</code> ï¼Œæ··å…¥<code>SingleTickerProviderStateMixin</code> æä¾›é»˜è®¤çš„ <code>Ticker</code> å¯¹è±¡ï¼Œç”¨äºæ„å»º <code>AnimationController</code> åŠ¨ç”»æ§åˆ¶å™¨</li>
<li><code>Curve</code> åŠ¨ç”»æ›²çº¿å¯ä»¥æ§åˆ¶æ—¶é—´çš„å˜åŒ–æƒ…å†µï¼Œç±»ä¼¼äº Android åŠ¨ç”»çš„æ’å€¼å™¨ï¼Œé»˜è®¤æ˜¯çº¿æ€§æµé€ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼Œæ•ˆæœå‚è€ƒ <a href="https://api.flutter.dev/flutter/animation/Curves-class.html" target="_blank" rel="external">å®˜ç½‘ Curves-class</a><ul>
<li>linear</li>
<li>decelerate</li>
<li>ease</li>
<li>easeIn</li>
<li>easeOut</li>
<li>easeInOut</li>
<li>fastOutSlowIn</li>
<li>bounceIn</li>
<li>bounceOut</li>
<li>bounceInOut</li>
<li>elasticIn</li>
<li>elasticOut</li>
<li>elasticInOut</li>
</ul>
</li>
<li><code>Tween</code> åŠ¨ç”»å–å€¼è®¡ç®—å‡ºå½“å‰æ—¶é—´ <code>t</code> å¯¹åº”çš„æ³›å‹å€¼ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªå­ç±»<ul>
<li>ReverseTween</li>
<li>ColorTween</li>
<li>SizeTween</li>
<li>RectTween</li>
<li>IntTween</li>
<li>StepTween</li>
<li>ConstantTween</li>
</ul>
</li>
<li><code>AnimationStatus</code> åŠ¨ç”»çŠ¶æ€æœºï¼Œå«æœ‰å››ä¸ªçŠ¶æ€<ul>
<li>dismissedï¼šåŠ¨ç”»æš‚æœªå¼€å§‹</li>
<li>forwardï¼šåŠ¨ç”»æ­£å‘è¿è¡Œ</li>
<li>reverseï¼šåŠ¨ç”»åå‘è¿è¡Œ</li>
<li>completeï¼šåŠ¨ç”»å®ŒæˆçŠ¶æ€</li>
</ul>
</li>
<li><code>Simulation</code> ç‰©ç†æ¨¡æ‹Ÿå™¨ï¼Œä½äº<code>physics</code> åŒ…ä¸‹ï¼Œç”¨äºæ¨¡æ‹Ÿç‰©ç†è¿åŠ¨ï¼Œæä¾›ä»¥ä¸‹ä¿¡æ¯<ul>
<li>ä½ç½®ä¿¡æ¯ x</li>
<li>é€Ÿåº¦d(x)</li>
<li>æ˜¯å¦å®Œæˆ isDone </li>
</ul>
</li>
</ul>
<h3 id="2-2ã€å®˜æ–¹ä¾‹å­"><a href="#2-2ã€å®˜æ–¹ä¾‹å­" class="headerlink" title="2.2ã€å®˜æ–¹ä¾‹å­"></a>2.2ã€å®˜æ–¹ä¾‹å­</h3><p>åœ¨ Flutter ä¸­å¯ä»¥ä½¿ç”¨ <code>AnimateWidget</code> or <code>AnimateBuilder</code> æ„å»ºä¸€ä¸ªåŠ¨ç”»ï¼Œå¦‚ä¸‹</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogoApp</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</div><div class="line">  _LogoAppState createState() =&gt; _LogoAppState();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_LogoAppState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">LogoApp</span>&gt; <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</div><div class="line">  Animation&lt;<span class="built_in">double</span>&gt; animation;</div><div class="line">  AnimationController controller;</div><div class="line"></div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> initState() &#123;</div><div class="line">    <span class="keyword">super</span>.initState();</div><div class="line">    controller =</div><div class="line">        AnimationController(duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">2</span>), vsync: <span class="keyword">this</span>);</div><div class="line">    animation = Tween&lt;<span class="built_in">double</span>&gt;(begin: <span class="number">0</span>, end: <span class="number">300</span>).animate(controller);</div><div class="line">    controller.forward();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="meta">@override</span>        </div><div class="line">  Widget build(BuildContext context) =&gt; AnimatedLogo(animation: animation);</div><div class="line"></div><div class="line">  <span class="meta">@override</span>            </div><div class="line">  <span class="keyword">void</span> dispose() &#123;            </div><div class="line">    controller.dispose();            </div><div class="line">    <span class="keyword">super</span>.dispose();            </div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedLogo</span> <span class="keyword">extends</span> <span class="title">AnimatedWidget</span> </span>&#123;</div><div class="line">  AnimatedLogo(&#123;Key key, Animation&lt;<span class="built_in">double</span>&gt; animation&#125;)</div><div class="line">      : <span class="keyword">super</span>(key: key, listenable: animation);</div><div class="line"></div><div class="line">  Widget build(BuildContext context) &#123;</div><div class="line">    <span class="keyword">final</span> animation = listenable <span class="keyword">as</span> Animation&lt;<span class="built_in">double</span>&gt;;</div><div class="line">    <span class="keyword">return</span> Center(</div><div class="line">      child: Container(</div><div class="line">        margin: EdgeInsets.symmetric(vertical: <span class="number">10</span>),</div><div class="line">        height: animation.value,</div><div class="line">        width: animation.value,</div><div class="line">        child: FlutterLogo(),</div><div class="line">      ),</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è·Ÿä¸‹æ„å»ºæµç¨‹ã€‚</p>
<h3 id="2-3ã€AnimationController"><a href="#2-3ã€AnimationController" class="headerlink" title="2.3ã€AnimationController"></a>2.3ã€AnimationController</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">AnimationController(&#123;</div><div class="line">  <span class="built_in">double</span> value,</div><div class="line">  <span class="keyword">this</span>.duration,<span class="comment">// åŠ¨ç”»æ—¶é•¿</span></div><div class="line">  <span class="keyword">this</span>.reverseDuration,</div><div class="line">  <span class="keyword">this</span>.debugLabel,</div><div class="line">  <span class="keyword">this</span>.lowerBound = <span class="number">0.0</span>, <span class="comment">// é»˜è®¤æ˜¯ 0.0 - 1.0</span></div><div class="line">  <span class="keyword">this</span>.upperBound = <span class="number">1.0</span>,</div><div class="line">  <span class="keyword">this</span>.animationBehavior = AnimationBehavior.normal,</div><div class="line">  <span class="comment">// TickerProvider å¯¹è±¡ï¼Œä¸€èˆ¬ä¸ºæ··å…¥äº† SingleTickerProviderStateMixin çš„ State ç±»å¯¹è±¡</span></div><div class="line">  <span class="meta">@required</span> TickerProvider vsync,</div><div class="line">&#125;) : <span class="keyword">assert</span>(lowerBound != <span class="keyword">null</span>),</div><div class="line">     <span class="keyword">assert</span>(upperBound != <span class="keyword">null</span>),</div><div class="line">     <span class="keyword">assert</span>(upperBound &gt;= lowerBound),</div><div class="line">     <span class="keyword">assert</span>(vsync != <span class="keyword">null</span>),</div><div class="line">     _direction = _AnimationDirection.forward &#123;</div><div class="line">  <span class="comment">//æ„å»º Ticker å¯¹è±¡</span></div><div class="line">  _ticker = vsync.createTicker(_tick);</div><div class="line">  <span class="comment">// æ›´æ–°çŠ¶æ€å’ŒåŠ¨ç”»å€¼</span></div><div class="line">  _internalSetValue(value ?? lowerBound);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æä¾›åŠ¨ç”»æ—¶é•¿</li>
<li>æä¾› TickerProvider å¯¹è±¡ï¼Œä¸€èˆ¬ä¸ºæ··å…¥äº† SingleTickerProviderStateMixin çš„ State ç±»å¯¹è±¡</li>
<li>æ„å»º Ticker å¯¹è±¡ï¼Œæ³¨å†Œå›è°ƒæ–¹æ³• <code>_tick()</code></li>
</ul>
<p>å½“è°ƒç”¨ <code>AnimationController.forward()</code> æ–¹å¼</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/animation/animation_controller.dart</span></div><div class="line">	TickerFuture forward(&#123; <span class="built_in">double</span> from &#125;) &#123;</div><div class="line">		...</div><div class="line">    <span class="comment">// æ­£å‘è¿è¡Œ</span></div><div class="line">    _direction = _AnimationDirection.forward;</div><div class="line">    <span class="keyword">if</span> (from != <span class="keyword">null</span>)</div><div class="line">      value = from;</div><div class="line">    <span class="keyword">return</span> _animateToInternal(upperBound);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  TickerFuture _animateToInternal(<span class="built_in">double</span> target, &#123; <span class="built_in">Duration</span> duration, Curve curve = Curves.linear &#125;) &#123; </div><div class="line">    <span class="comment">// é»˜è®¤çº¿æ€§æ›²çº¿</span></div><div class="line">    <span class="built_in">double</span> scale = <span class="number">1.0</span>;</div><div class="line">		...</div><div class="line">    <span class="built_in">Duration</span> simulationDuration = duration;</div><div class="line">    <span class="keyword">if</span> (simulationDuration == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">final</span> <span class="built_in">double</span> range = upperBound - lowerBound;</div><div class="line">      <span class="keyword">final</span> <span class="built_in">double</span> remainingFraction = range.isFinite ? (target - _value).abs() / range : <span class="number">1.0</span>;</div><div class="line">      <span class="keyword">final</span> <span class="built_in">Duration</span> directionDuration =</div><div class="line">        (_direction == _AnimationDirection.reverse &amp;&amp; reverseDuration != <span class="keyword">null</span>)</div><div class="line">        ? reverseDuration</div><div class="line">        : <span class="keyword">this</span>.duration;</div><div class="line">      simulationDuration = directionDuration * remainingFraction;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (target == value) &#123;</div><div class="line">      <span class="comment">// Already at target, don't animate.</span></div><div class="line">      simulationDuration = <span class="built_in">Duration</span>.zero;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// åœæ­¢è€çš„åŠ¨ç”»</span></div><div class="line">    stop();</div><div class="line">    <span class="keyword">if</span> (simulationDuration == <span class="built_in">Duration</span>.zero) &#123;</div><div class="line">      <span class="keyword">if</span> (value != target) &#123;</div><div class="line">        <span class="comment">// æ›´æ–°å€¼ï¼Œé€šçŸ¥å›è°ƒ</span></div><div class="line">        _value = target.clamp(lowerBound, upperBound) <span class="keyword">as</span> <span class="built_in">double</span>;</div><div class="line">        notifyListeners();</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// æ”¹å˜çŠ¶æ€</span></div><div class="line">      _status = (_direction == _AnimationDirection.forward) ?</div><div class="line">        AnimationStatus.completed :</div><div class="line">        AnimationStatus.dismissed;</div><div class="line">      _checkStatusChanged();</div><div class="line">      <span class="keyword">return</span> TickerFuture.complete();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// æ„å»ºä¸€ä¸ª Simulation ç‰©ç†æ¨¡æ‹Ÿå™¨å¯¹è±¡ï¼Œä½¿ç”¨çº¿æ€§æ›²çº¿</span></div><div class="line">    <span class="keyword">return</span> _startSimulation(_InterpolationSimulation(_value, target, simulationDuration, curve, scale));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>æ„å»ºä¸€ä¸ª <code>Simulation</code> ç‰©ç†æ¨¡æ‹Ÿå™¨å¯¹è±¡ï¼Œè¿™é‡Œä½¿ç”¨çº¿æ€§æ¨¡æ‹Ÿï¼Œå†…éƒ¨ä½¿ç”¨çš„æ˜¯ <code>Curves.linear</code> å®ç°ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/animation/animation_controller.dart</span></div><div class="line">	TickerFuture _startSimulation(Simulation simulation) &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// é€šè¿‡æ¨¡æ‹Ÿå™¨è·å–å€¼</span></div><div class="line">    _value = simulation.x(<span class="number">0.0</span>).clamp(lowerBound, upperBound) <span class="keyword">as</span> <span class="built_in">double</span>;</div><div class="line">    <span class="comment">// ticker å¼€å§‹å·¥ä½œ</span></div><div class="line">    <span class="keyword">final</span> TickerFuture result = _ticker.start();</div><div class="line">    <span class="comment">// æ›´æ–°çŠ¶æ€</span></div><div class="line">    _status = (_direction == _AnimationDirection.forward) ?</div><div class="line">      AnimationStatus.forward :</div><div class="line">      AnimationStatus.reverse;</div><div class="line">    _checkStatusChanged();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line">	</div><div class="line">	<span class="comment">// æ£€æŸ¥çŠ¶æ€å˜åŒ–</span></div><div class="line">  <span class="keyword">void</span> _checkStatusChanged() &#123;</div><div class="line">    <span class="keyword">final</span> AnimationStatus newStatus = status;</div><div class="line">    <span class="keyword">if</span> (_lastReportedStatus != newStatus) &#123;</div><div class="line">      _lastReportedStatus = newStatus;</div><div class="line">      notifyStatusListeners(newStatus);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="2-4ã€Ticker"><a href="#2-4ã€Ticker" class="headerlink" title="2.4ã€Ticker"></a>2.4ã€Ticker</h3><p><code>Ticker</code> å¼€å§‹å·¥ä½œ</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/schedule/ticker.dart</span></div><div class="line">	TickerFuture start() &#123;</div><div class="line">    _future = TickerFuture._();</div><div class="line">    <span class="keyword">if</span> (shouldScheduleTick) &#123;</div><div class="line">      <span class="comment">// è§¦å‘ tick äº‹ä»¶</span></div><div class="line">      scheduleTick();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (SchedulerBinding.instance.schedulerPhase.index &gt; SchedulerPhase.idle.index &amp;&amp;</div><div class="line">        SchedulerBinding.instance.schedulerPhase.index &lt; SchedulerPhase.postFrameCallbacks.index)</div><div class="line">      <span class="comment">// SchedulerçŠ¶æ€åœ¨ idle å’Œ postFrameCallbacks ä¹‹é—´ï¼Œå³åœ¨ç»˜åˆ¶çŠ¶æ€ä¸­</span></div><div class="line">      _startTime = SchedulerBinding.instance.currentFrameTimeStamp;</div><div class="line">    <span class="keyword">return</span> _future;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@protected</span></div><div class="line">  <span class="keyword">void</span> scheduleTick(&#123; <span class="built_in">bool</span> rescheduling = <span class="keyword">false</span> &#125;) &#123;</div><div class="line">    <span class="comment">// åŠ å…¥åˆ° _transientCallbacks é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å›è°ƒ _tick æ–¹æ³•</span></div><div class="line">    _animationId = SchedulerBinding.instance.scheduleFrameCallback(_tick, rescheduling: rescheduling);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>åŠ å…¥åˆ° <code>SchedulerBinding._transientCallbacks</code> é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å›è°ƒ <code>_tick</code> æ–¹æ³•</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/scheduler/binding.dart</span></div><div class="line">	<span class="built_in">int</span> scheduleFrameCallback(FrameCallback callback, &#123; <span class="built_in">bool</span> rescheduling = <span class="keyword">false</span> &#125;) &#123;</div><div class="line">    <span class="comment">// è¯·æ±‚ç»˜åˆ¶</span></div><div class="line">    scheduleFrame();</div><div class="line">    _nextFrameCallbackId += <span class="number">1</span>;</div><div class="line">    <span class="comment">// åŠ å…¥ _transientCallbacks é˜Ÿåˆ—</span></div><div class="line">    _transientCallbacks[_nextFrameCallbackId] = _FrameCallbackEntry(callback, rescheduling: rescheduling);</div><div class="line">    <span class="keyword">return</span> _nextFrameCallbackId;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¯·æ±‚ç»˜åˆ¶</li>
<li>åŠ å…¥ _transientCallbacks é˜Ÿåˆ—</li>
</ul>
<p><code>Ticker._tick()</code> æ–¹æ³•</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/schedule/ticker.dart</span></div><div class="line">	<span class="keyword">void</span> _tick(<span class="built_in">Duration</span> timeStamp) &#123;</div><div class="line">    _animationId = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    _startTime ??= timeStamp;</div><div class="line">    <span class="comment">// å›è°ƒ AnimationController æ³¨å†Œçš„å›è°ƒæ–¹æ³•</span></div><div class="line">    _onTick(timeStamp - _startTime);</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (shouldScheduleTick)</div><div class="line">      <span class="comment">// å†æ¬¡æ³¨å†Œ _transientCallbacks å›è°ƒ</span></div><div class="line">      scheduleTick(rescheduling: <span class="keyword">true</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>å›è°ƒ <code>AnimationController</code> æ„å»º <code>Ticker</code> å¯¹è±¡æ—¶æ³¨å†Œçš„å›è°ƒæ–¹æ³• <code>_tick()</code></li>
<li>å†æ¬¡æ³¨å†Œ <code>_transientCallbacks</code> å›è°ƒï¼Œç­‰å¾…è§¦å‘å†æ¬¡æ³¨å†Œâ€¦ ç›´åˆ°åŠ¨ç”»å®Œæˆæˆ–åœæ­¢</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/animation/animation_controller.dart</span></div><div class="line">	<span class="keyword">void</span> _tick(<span class="built_in">Duration</span> elapsed) &#123;</div><div class="line">    _lastElapsedDuration = elapsed;</div><div class="line">    <span class="keyword">final</span> <span class="built_in">double</span> elapsedInSeconds = elapsed.inMicroseconds.toDouble() / <span class="built_in">Duration</span>.microsecondsPerSecond;</div><div class="line">    <span class="comment">// æ›´æ–°åŠ¨ç”»å€¼</span></div><div class="line">    _value = _simulation.x(elapsedInSeconds).clamp(lowerBound, upperBound) <span class="keyword">as</span> <span class="built_in">double</span>;</div><div class="line">    <span class="comment">// æ›´æ–°åŠ¨ç”»çŠ¶æ€</span></div><div class="line">    <span class="keyword">if</span> (_simulation.isDone(elapsedInSeconds)) &#123;</div><div class="line">      _status = (_direction == _AnimationDirection.forward) ?</div><div class="line">        AnimationStatus.completed :</div><div class="line">        AnimationStatus.dismissed;</div><div class="line">      stop(canceled: <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// é€šçŸ¥ç›‘å¬</span></div><div class="line">    notifyListeners();</div><div class="line">    _checkStatusChanged();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="2-5ã€åˆ·æ–°ç•Œé¢"><a href="#2-5ã€åˆ·æ–°ç•Œé¢" class="headerlink" title="2.5ã€åˆ·æ–°ç•Œé¢"></a>2.5ã€åˆ·æ–°ç•Œé¢</h3><p>åœ¨ <code>AnimatedWidget</code> æˆ– <code>AnimatedBuilder</code> å¯¹åº”çš„ State ä¸­ï¼Œä¼šå¯¹ <code>Animation</code> æ³¨å†ŒåŠ¨ç”»ç›‘å¬</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/trasitions.dart</span></div><div class="line">	<span class="keyword">void</span> initState() &#123;</div><div class="line">    <span class="keyword">super</span>.initState();</div><div class="line">    widget.listenable.addListener(_handleChange);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">void</span> _handleChange() &#123;</div><div class="line">    <span class="comment">// element æ ‡è„ï¼Œè§¦å‘ç»˜åˆ¶</span></div><div class="line">    setState(() &#123;</div><div class="line">      <span class="comment">// The listenable's state is our build state, and it changed already.</span></div><div class="line">    &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡ <code>Animation</code> çš„å›è°ƒæ–¹æ³•è§¦å‘ç•Œé¢åˆ·æ–°</li>
<li>Widget é€šè¿‡ <code>Animation</code> å¯¹è±¡è·å–å¯¹åº”çš„å€¼</li>
<li><code>setState()</code> æ ‡è„ elementï¼Œä¸‹ä¸€æ¬¡ VSync ä¿¡å·åˆ°æ¥è§¦å‘ rebuild()</li>
</ul>
<p>è°ƒç”¨è¿‡ç¨‹ï¼š</p>
<p><code>AnimationController.forward()</code> -&gt; <code>Ticker.start()</code> -&gt; <code>Ticker.scheduleTick()</code> -&gt; <code>Ticker._tick()</code> -&gt; <code>AnimationController._tick()</code> -&gt; <code>Widget.build()</code> -&gt; <code>Ticker.scheduleTick()</code> â€¦</p>
<p>ä¸æ–­çš„è§¦å‘åˆ·æ–° -&gt; æ›´æ–°åŠ¨ç”»å€¼ -&gt; element.rebuild() -&gt; è§¦å‘åˆ·æ–°â€¦ ç›´åˆ°åŠ¨ç”»å®Œæˆæˆ–åœæ­¢ã€‚</p>
<h2 id="3ã€æ€»ç»“"><a href="#3ã€æ€»ç»“" class="headerlink" title="3ã€æ€»ç»“"></a>3ã€æ€»ç»“</h2><p>Dart Framework è§¦å‘ Engine æ¸²æŸ“ç®¡çº¿å¼€å§‹ç»˜åˆ¶æµç¨‹ï¼Œå›è°ƒç»™ Dart Frameworkï¼Œé€šè¿‡ <code>SchedulerBinding</code> è°ƒåº¦ UI ç»˜åˆ¶ã€‚</p>
<p>å…¶ä¸­çš„ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯æ›´æ–° <code>_transientCallbacks</code> å›è°ƒï¼Œè¯¥å›è°ƒåœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­è¢«ä½¿ç”¨ã€‚</p>
<p><code>Animation</code> åŠ¨ç”»åœ¨ <code>SchedulerBinding</code>  å’Œ <code>Ticker</code> çš„é©±åŠ¨ä¸‹ï¼Œå¾ªç¯å¾€å¤çš„ä¸åœè¿è½¬ï¼Œç›´åˆ°åŠ¨ç”»å®Œæˆæˆ–è¢«è°ƒç”¨åœæ­¢ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†æ element.rebuild() çš„è¿‡ç¨‹ã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2020/11/13/flutter-ui-animate/">http://w4lle.com/2020/11/13/flutter-ui-animate/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸‰ç¯‡ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹æ”¶åˆ° VSync ä¿¡å·å›è°ƒå Dart Framework è§¦å‘åŠ¨ç”»çš„è¿‡ç¨‹åŠåŠ¨ç”»å®ç°åŸç†ã€‚&lt;/p&gt;
&lt;p&gt;åŸºäº Android å¹³å°ï¼ŒFlutter v1.20.4ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Flutter" scheme="http://w4lle.com/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Flutter UI æ¸²æŸ“æµ…æï¼ˆäºŒï¼‰VSync æ³¨å†Œ</title>
    <link href="http://w4lle.com/2020/11/11/flutter-ui-vsync/"/>
    <id>http://w4lle.com/2020/11/11/flutter-ui-vsync/</id>
    <published>2020-11-11T10:31:21.000Z</published>
    <updated>2020-11-17T06:46:48.454Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Flutter App å¯åŠ¨è¿‡ç¨‹æˆ–è€… State åˆ·æ–°è¿‡ç¨‹ä¸­ï¼Œä¼šè¯·æ±‚æ³¨å†Œ VSync ä¿¡å·ã€‚</p>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹ VSync ä¿¡å·æ³¨å†Œä»¥åŠå›è°ƒè¿‡ç¨‹ã€‚</p>
<p>åŸºäº Android å¹³å°ï¼ŒFlutter v1.20.4ã€‚</p>
<a id="more"></a>
<p>è°ƒç”¨æ—¶åºå›¾</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_vsync.png" alt=""></p>
<h2 id="1ã€Flutter-App-å¯åŠ¨"><a href="#1ã€Flutter-App-å¯åŠ¨" class="headerlink" title="1ã€Flutter App å¯åŠ¨"></a>1ã€Flutter App å¯åŠ¨</h2><p>Flutter App å¯åŠ¨è¿‡ç¨‹ä¸­è°ƒç”¨ <code>runApp()</code>æ–¹æ³•</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/binding.dart</span></div><div class="line"><span class="keyword">void</span> runApp(Widget app) &#123;</div><div class="line">  WidgetsFlutterBinding.ensureInitialized()</div><div class="line">    ..scheduleAttachRootWidget(app)</div><div class="line">    ..scheduleWarmUpFrame();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WidgetsFlutterBinding</span> <span class="keyword">extends</span> <span class="title">BindingBase</span> <span class="title">with</span> <span class="title">GestureBinding</span>, <span class="title">SchedulerBinding</span>, <span class="title">ServicesBinding</span>, <span class="title">PaintingBinding</span>, <span class="title">SemanticsBinding</span>, <span class="title">RendererBinding</span>, <span class="title">WidgetsBinding</span> </span>&#123;</div><div class="line">  <span class="keyword">static</span> WidgetsBinding ensureInitialized() &#123;</div><div class="line">    <span class="keyword">if</span> (WidgetsBinding.instance == <span class="keyword">null</span>)</div><div class="line">      WidgetsFlutterBinding();</div><div class="line">    <span class="keyword">return</span> WidgetsBinding.instance;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>runApp()</code>è¿‡ç¨‹ä¸­åˆå§‹åŒ– <code>WidgetsFlutterBinding</code>ï¼Œå®ƒæ˜¯ Dart Framework å’Œ C++ Engine ä¹‹é—´çš„èƒ¶æ°´å±‚ï¼Œå¹¶ä¸”æ··å…¥äº† 7 ä¸ªBinding ç±»ï¼Œç”¨äºåˆå§‹åŒ– 7 ä¸ª Binding ç±»ã€‚</p>
<p>ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°ï¼Œ<code>Window</code> æ˜¯ <code>dart:ui</code> åŒ…ä¸­æœ€é‡è¦çš„ç±»ï¼Œé€šè¿‡  <code>Window</code>  å»ºç«‹èµ·äº†å»ºç«‹ Dart Framework å’Œ C++ Engine çš„é€šè®¯è¿æ¥ï¼Œ<code>Window</code> åœ¨ Flutter Framework å’Œ C++ Engine ä¸­åˆ†åˆ«å­˜åœ¨ï¼Œå¹¶é€šè¿‡ <code>ffi</code> äº’ç›¸è°ƒç”¨ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</div><div class="line">  <span class="comment">// å½“çª—å£ç»˜åˆ¶åŒºåŸŸå˜åŒ–æ—¶å›è°ƒï¼Œæ¯”å¦‚[devicePixelRatio],</span></div><div class="line">  <span class="comment">/// [physicalSize], [padding], [viewInsets], or [systemGestureInsets]å˜åŒ–</span></div><div class="line">  VoidCallback? <span class="keyword">get</span> onMetricsChanged =&gt; _onMetricsChanged;</div><div class="line">  <span class="comment">// å½“è¯­è¨€ç¯å¢ƒå‘ç”Ÿå˜åŒ–æ—¶å›è°ƒ</span></div><div class="line">  VoidCallback? <span class="keyword">get</span> onLocaleChanged =&gt; _onLocaleChanged;</div><div class="line">  <span class="comment">// å½“ç³»ç»Ÿå­—ä½“ç¼©æ”¾å˜åŒ–æ—¶å›è°ƒ</span></div><div class="line">  VoidCallback <span class="keyword">get</span> onTextScaleFactorChanged =&gt; _onTextScaleFactorChanged;</div><div class="line">  <span class="comment">// ç»˜åˆ¶å‰å›è°ƒï¼Œä¸€èˆ¬åœ¨æ”¶åˆ° VSync ä¿¡å·åå›è°ƒï¼Œæˆ–è€…åœ¨Appå¯åŠ¨é¦–å¸§ä¸»åŠ¨è°ƒç”¨</span></div><div class="line">  FrameCallback <span class="keyword">get</span> onBeginFrame =&gt; _onBeginFrame;</div><div class="line">  <span class="comment">// ç»˜åˆ¶å›è°ƒï¼Œä¸€èˆ¬åœ¨ onBeginFrame å’Œ microtask æ‰§è¡Œå®Œåæ‰§è¡Œï¼Œæˆ–è€…åœ¨Appå¯åŠ¨é¦–å¸§ä¸»åŠ¨è°ƒç”¨</span></div><div class="line">  VoidCallback <span class="keyword">get</span> onDrawFrame =&gt; _onDrawFrame;</div><div class="line">  <span class="comment">// ç»˜åˆ¶æ—¶é—´å›è°ƒï¼Œç”¨äºè®¡ç®—fps</span></div><div class="line">  TimingsCallback? <span class="keyword">get</span> onReportTimings =&gt; _onReportTimings;</div><div class="line">  <span class="comment">// ç‚¹å‡»æˆ–æŒ‡é’ˆäº‹ä»¶å›è°ƒ</span></div><div class="line">  PointerDataPacketCallback <span class="keyword">get</span> onPointerDataPacket =&gt; _onPointerDataPacket;</div><div class="line">  <span class="comment">// è§¦å‘ Engine Pipeline æ¸²æŸ“ç®¡çº¿å·¥ä½œï¼Œæ³¨å†Œ VSync ä¿¡å·å›è°ƒï¼Œå½“ VSync ä¿¡å·åˆ°æ¥æ—¶</span></div><div class="line">  <span class="comment">// onBeginFrameå’ŒonDrawFrame ä¼šè¢«è°ƒç”¨</span></div><div class="line">  <span class="keyword">void</span> scheduleFrame() native <span class="string">'Window_scheduleFrame'</span>;</div><div class="line">  <span class="comment">// è§¦å‘ RasterThread æ‰§è¡Œå…‰æ …åŒ–åˆæˆ</span></div><div class="line">  <span class="keyword">void</span> render(Scene scene) native <span class="string">'Window_render'</span>;</div><div class="line">  <span class="comment">// å‘é€å¹³å°æ¶ˆæ¯</span></div><div class="line">  <span class="keyword">void</span> sendPlatformMessage(<span class="built_in">String</span> name,</div><div class="line">                           ByteData data,</div><div class="line">                           PlatformMessageResponseCallback callback) ;</div><div class="line">  <span class="comment">// å¹³å°é€šé“æ¶ˆæ¯å¤„ç†å›è°ƒ  </span></div><div class="line">  PlatformMessageCallback <span class="keyword">get</span> onPlatformMessage =&gt; _onPlatformMessage;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>Window</code> ä¸­å­˜åœ¨ä¸€äº›å›è°ƒæ–¹æ³•ï¼Œç”± C++ Engine è§¦å‘å›è°ƒæ–¹æ³•ï¼Œè§¦å‘ Flutter Framework æ‰§è¡Œç›¸åº”åŠ¨ä½œã€‚</p>
<p>è¿™äº›å›è°ƒæ–¹æ³•åˆ†æ•£æ³¨å†Œåœ¨ 7 ä¸ª Binding ç±»ä¸­ã€‚</p>
<ul>
<li>SchedulerBindingï¼Œæ¸²æŸ“ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæ³¨å†Œ <code>onBeginFrame</code> ã€ <code>onDrawFrame</code> ã€<code>onReportTimings</code> ç­‰å›è°ƒï¼Œç”¨äºè°ƒåº¦æ¸²æŸ“æµç¨‹ã€è®¡ç®—ç»˜åˆ¶è€—æ—¶</li>
<li>WidgetsBindingï¼Œæ˜¯è§†å›¾å±‚å’Œ Flutter Engine ä¹‹é—´çš„èƒ¶æ°´å±‚ï¼Œç”¨äºç®¡ç†ä¸‰æ£µæ ‘çš„æ„å»ºå’Œæ›´æ–°æ“ä½œï¼›æ³¨å†Œ <code>window.onLocaleChanged</code>ã€<code>onBuildScheduled</code> å›è°ƒï¼›æŒæœ‰ BuilderOwner å¯¹è±¡</li>
<li>RendererBindingï¼Œæ˜¯ç»˜åˆ¶æ ‘ (Render Tree) å’Œ Flutter Engine ä¹‹é—´çš„èƒ¶æ°´å±‚ï¼Œç”¨äºå¸ƒå±€å’Œç»˜åˆ¶ï¼Œæ ¸å¿ƒæ–¹æ³•<code>drawFrame()</code>ï¼›æ³¨å†Œ <code>window.onMetricsChanged</code> ã€<code>window.onTextScaleFactorChanged</code>  ç­‰å›è°ƒï¼›æŒæœ‰ PipelineOwner å¯¹è±¡</li>
<li>PaintingBindingï¼Œç»‘å®šç»˜åˆ¶åº“ï¼Œä¸»è¦ç”¨äºå¤„ç†å›¾ç‰‡ç¼“å­˜</li>
<li>ServicesBindingï¼Œæ³¨å†Œ<code>window.onPlatformMessage</code> å›è°ƒï¼Œ ç”¨äºç»‘å®šå¹³å°æ¶ˆæ¯é€šé“ï¼ˆmessage channelï¼‰ï¼Œå¤„ç†åŸç”Ÿå’Œ Flutter é€šä¿¡</li>
<li>GestureBindingï¼Œæ³¨å†Œ <code>window.onPointerDataPacket</code> å›è°ƒï¼Œç»‘å®šFrameworkæ‰‹åŠ¿å­ç³»ç»Ÿï¼Œæ˜¯Frameworkäº‹ä»¶æ¨¡å‹ä¸åº•å±‚äº‹ä»¶çš„ç»‘å®šå…¥å£</li>
<li>SemanticsBindingï¼Œè¯­ä¹‰åŒ–å±‚ä¸Flutter engineçš„æ¡¥æ¢ï¼Œä¸»è¦æ˜¯è¾…åŠ©åŠŸèƒ½çš„åº•å±‚æ”¯æŒ</li>
</ul>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesinternals_bindings.png" alt=""></p>
<p>é‡ç‚¹å…³æ³¨ <code>SchedulerBinding</code>ã€<code>WidgetsBinding</code>ã€<code>RendererBinding</code> åŠä»–ä»¬æ³¨å†Œçš„å›è°ƒæ–¹æ³•ã€‚</p>
<h2 id="2ã€scheduleFrame"><a href="#2ã€scheduleFrame" class="headerlink" title="2ã€scheduleFrame"></a>2ã€scheduleFrame</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/binding.dart</span></div><div class="line"><span class="keyword">void</span> runApp(Widget app) &#123;</div><div class="line">  WidgetsFlutterBinding.ensureInitialized()</div><div class="line">    ..scheduleAttachRootWidget(app)</div><div class="line">    ..scheduleWarmUpFrame();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>runApp()</code> å¯åŠ¨æ–¹æ³•ä¸­</p>
<ul>
<li><code>scheduleAttachRootWidget(app)</code> é¦–å…ˆæ„å»ºä¸‰æ£µæ ‘ï¼Œå¹¶ä¸”é€šè¿‡ <code>BuildOwner</code> è°ƒç”¨ <code>scheduleFrame()</code> è§¦å‘æ³¨å†Œ VSync ä¿¡å·</li>
<li><code>scheduleWarmUpFrame()</code> å‡†å¤‡ç¬¬ä¸€å¸§çš„ç»˜åˆ¶å·¥ä½œï¼Œè§¦å‘ <code>beginFrame()</code> å’Œ <code>drawFrame()</code> æ‰§è¡Œæ–¹æ³•ï¼Œè¿™æ ·å°±ä¸ç”¨ç­‰å¾… VSync ä¿¡å·å›è°ƒï¼Œå¯ä»¥å°½å¿«çš„ç»˜åˆ¶ç¬¬ä¸€å¸§</li>
</ul>
<p>åŒæ ·çš„ï¼Œåœ¨ <code>State.setState()</code> æ–¹æ³•ä¸­ä¹Ÿä¼šè§¦å‘ <code>ScheduleFrame()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/framework.dart </span></div><div class="line"></div><div class="line"><span class="comment">// State</span></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">State</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span>&gt; <span class="title">with</span> <span class="title">Diagnosticable</span> </span>&#123;</div><div class="line">	<span class="keyword">void</span> setState(VoidCallback fn) &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// è°ƒç”¨callback</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">dynamic</span> result = fn() <span class="keyword">as</span> <span class="keyword">dynamic</span>;</div><div class="line">    ...</div><div class="line">    <span class="comment">// element æ ‡è„</span></div><div class="line">    _element.markNeedsBuild();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Element</span></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Element</span> <span class="keyword">extends</span> <span class="title">DiagnosticableTree</span> <span class="keyword">implements</span> <span class="title">BuildContext</span> </span>&#123;</div><div class="line">  <span class="keyword">void</span> markNeedsBuild() &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// é˜²æ­¢é‡å¤æ ‡è„</span></div><div class="line">    <span class="keyword">if</span> (dirty)</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    _dirty = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">// è§¦å‘ç»˜åˆ¶</span></div><div class="line">    owner.scheduleBuildFor(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// BuildOwner</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuildOwner</span> </span>&#123;</div><div class="line">  <span class="keyword">void</span> scheduleBuildFor(<span class="built_in">Element</span> element) &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (!_scheduledFlushDirtyElements &amp;&amp; onBuildScheduled != <span class="keyword">null</span>) &#123;</div><div class="line">      _scheduledFlushDirtyElements = <span class="keyword">true</span>;</div><div class="line">      <span class="comment">// è°ƒç”¨scheduleFrame</span></div><div class="line">      onBuildScheduled();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// æ·»åŠ åˆ° _dirtyElements è„åˆ—è¡¨</span></div><div class="line">    _dirtyElements.add(element);</div><div class="line">    element._inDirtyList = <span class="keyword">true</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>BuildOwner.onBuildScheduled()</code> ï¼Œè¿™ä¸ªå›è°ƒæ–¹æ³•æ˜¯åœ¨ <code>WidgetsBinding.initInstances()</code> åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¸­æ³¨å†Œçš„ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/widgets/binding.dart WidgetsBinding</span></div><div class="line">mixin WidgetsBinding on BindingBase, ServicesBinding, SchedulerBinding, GestureBinding, RendererBinding, SemanticsBinding &#123;</div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="keyword">void</span> initInstances() &#123;</div><div class="line">    <span class="keyword">super</span>.initInstances();</div><div class="line">    _instance = <span class="keyword">this</span>;</div><div class="line">    <span class="comment">//æ„é€ BuildeOwnerï¼Œä¸»è¦è´Ÿè´£Widgetçš„buildè¿‡ç¨‹</span></div><div class="line">    _buildOwner = BuildOwner();</div><div class="line">    <span class="comment">// æ³¨å†Œ onBuildScheduled å›è°ƒ</span></div><div class="line">    buildOwner.onBuildScheduled = _handleBuildScheduled;</div><div class="line">    <span class="comment">//æ³¨å†Œwindowç›¸å…³å›è°ƒ</span></div><div class="line">    <span class="built_in">window</span>.onLocaleChanged = handleLocaleChanged;</div><div class="line">    <span class="built_in">window</span>.onAccessibilityFeaturesChanged = handleAccessibilityFeaturesChanged;</div><div class="line">  	<span class="comment">//å¯¼èˆªchannel  </span></div><div class="line">    SystemChannels.navigation.setMethodCallHandler(_handleNavigationInvocation);</div><div class="line">    FlutterErrorDetails.propertiesTransformers.add(transformDebugCreator);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">void</span> _handleBuildScheduled() &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// äº¤ç»™ SchedulerBinding è°ƒåº¦å¤„ç†</span></div><div class="line">    ensureVisualUpdate();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>äº¤ç»™ <code>SchedulerBinding</code> è°ƒåº¦å¤„ç†</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/src/scheduler/binding.dart</span></div><div class="line">	<span class="keyword">void</span> ensureVisualUpdate() &#123;</div><div class="line">    <span class="keyword">switch</span> (schedulerPhase) &#123;</div><div class="line">      <span class="keyword">case</span> SchedulerPhase.idle:</div><div class="line">      <span class="keyword">case</span> SchedulerPhase.postFrameCallbacks:</div><div class="line">        <span class="comment">// è°ƒç”¨</span></div><div class="line">        scheduleFrame();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      <span class="keyword">case</span> SchedulerPhase.transientCallbacks:</div><div class="line">      <span class="keyword">case</span> SchedulerPhase.midFrameMicrotasks:</div><div class="line">      <span class="keyword">case</span> SchedulerPhase.persistentCallbacks:</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">void</span> scheduleFrame() &#123;</div><div class="line">    <span class="comment">//é˜²æ­¢é‡å¤æ³¨å†Œ</span></div><div class="line">    <span class="keyword">if</span> (_hasScheduledFrame || !framesEnabled)</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    <span class="comment">// æ³¨å†Œå›è°ƒæ–¹æ³•</span></div><div class="line">    ensureFrameCallbacksRegistered();</div><div class="line">    <span class="comment">// é€šè¿‡windowï¼Œè°ƒç”¨Engine scheduleFrame</span></div><div class="line">    <span class="built_in">window</span>.scheduleFrame();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">void</span> ensureFrameCallbacksRegistered() &#123;</div><div class="line">    <span class="comment">// æ³¨å†Œ onBeginFrame ã€onDrawFrame å›è°ƒæ–¹æ³•</span></div><div class="line">    <span class="built_in">window</span>.onBeginFrame ??= _handleBeginFrame;</div><div class="line">    <span class="built_in">window</span>.onDrawFrame ??= _handleDrawFrame;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ <code>window</code>  è°ƒç”¨Engine <code>Window ::scheduleFrame()</code> Native æ–¹æ³•ï¼Œå¹¶æ³¨å†Œ <code>onBeginFrame</code> ã€<code>onDrawFrame</code>  å›è°ƒæ–¹æ³•ã€‚</p>
<p>çœ‹ä¸‹ <code>SchedulerBinding</code> çš„çŠ¶æ€æœºï¼Œè¿™é‡Œæ˜¯å’Œ C++ Engine ä¸­çš„å›è°ƒè¿‡ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼Œåé¢ä¼šçœ‹åˆ°ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> SchedulerPhase &#123;</div><div class="line">  <span class="comment">//ç©ºé—²çŠ¶æ€</span></div><div class="line">  idle,</div><div class="line"></div><div class="line">  <span class="comment">//è°ƒç”¨ç¬æ—¶å›è°ƒçŠ¶æ€ï¼Œä¸»è¦å¤„ç†åŠ¨ç”»è®¡ç®—æœºæ›´æ–°ç­‰ä»»åŠ¡ï¼Œç”±WidgetsBinding.scheduleFrameCallbackæ³¨å†Œå›è°ƒ</span></div><div class="line">  transientCallbacks,</div><div class="line"></div><div class="line">  <span class="comment">//å¤„ç†transientCallbacksé˜¶æ®µæ³¨å†Œçš„å¾®ä»»åŠ¡microtasks</span></div><div class="line">  midFrameMicrotasks,</div><div class="line"></div><div class="line">  <span class="comment">//build/layout/painté˜¶æ®µï¼ŒåŒæ—¶å¤„ç†WidgetsBinding.addPersistentFrameCallbackæ³¨å†Œçš„persistentCallbacks</span></div><div class="line">  persistentCallbacks,</div><div class="line"></div><div class="line">  <span class="comment">//ç»˜åˆ¶å®Œæˆï¼Œå¤„ç†ä¸€äº›æ¸…ç†å·¥ä½œï¼ŒåŒæ—¶å¤„ç†WidgetsBinding.addPostFrameCallbackæ³¨å†Œçš„postFrameCallbacksï¼ŒAppå±‚å¯ä»¥åœ¨è¿™é‡Œå¤„ç†ä¸€äº›ç»˜åˆ¶å®Œæˆåçš„å·¥ä½œ</span></div><div class="line">  postFrameCallbacks,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3ã€dart-ffi"><a href="#3ã€dart-ffi" class="headerlink" title="3ã€dart:ffi"></a>3ã€dart:ffi</h2><p>åœ¨ Flutter ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>dart:ffi</code> å®ç° Dart æ–¹æ³•å’Œ Native æ–¹æ³•çš„äº’ç›¸è°ƒç”¨ç»‘å®šï¼Œç±»ä¼¼äº Java çš„ <code>JNI</code>ã€‚</p>
<p>åœ¨ Engine <code>Window</code> ç±»ä¸­ï¼Œé€šè¿‡ <code>dart:ffi</code> æ³¨å†Œ <code>Native</code> æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// flutter/lib/ui/window/window.cc</span></div><div class="line"><span class="keyword">void</span> Window::RegisterNatives(tonic::DartLibraryNatives* natives) &#123;</div><div class="line">  natives-&gt;Register(&#123;</div><div class="line">    	<span class="comment">// é»˜è®¤è·¯ç”± '/'</span></div><div class="line">      &#123;<span class="string">"Window_defaultRouteName"</span>, DefaultRouteName, <span class="number">1</span>, <span class="literal">true</span>&#125;,</div><div class="line">    	<span class="comment">// è§¦å‘ç»˜åˆ¶</span></div><div class="line">        &#123;<span class="string">"Window_scheduleFrame"</span>, ScheduleFrame, <span class="number">1</span>, <span class="literal">true</span>&#125;,</div><div class="line">    	<span class="comment">// å‘é€æ¶ˆæ¯å›è°ƒ</span></div><div class="line">      &#123;<span class="string">"Window_sendPlatformMessage"</span>, _SendPlatformMessage, <span class="number">4</span>, <span class="literal">true</span>&#125;,</div><div class="line">    	<span class="comment">// å›è°ƒæ¶ˆæ¯</span></div><div class="line">      &#123;<span class="string">"Window_respondToPlatformMessage"</span>, _RespondToPlatformMessage, <span class="number">3</span>, <span class="literal">true</span>&#125;,</div><div class="line">    	<span class="comment">// å…‰æ …åŒ–åˆæˆ</span></div><div class="line">      &#123;<span class="string">"Window_render"</span>, Render, <span class="number">2</span>, <span class="literal">true</span>&#125;,</div><div class="line">      &#123;<span class="string">"Window_updateSemantics"</span>, UpdateSemantics, <span class="number">2</span>, <span class="literal">true</span>&#125;,</div><div class="line">      &#123;<span class="string">"Window_setIsolateDebugName"</span>, SetIsolateDebugName, <span class="number">2</span>, <span class="literal">true</span>&#125;,</div><div class="line">    	<span class="comment">// ä¸ŠæŠ¥å¼‚å¸¸</span></div><div class="line">      &#123;<span class="string">"Window_reportUnhandledException"</span>, ReportUnhandledException, <span class="number">2</span>, <span class="literal">true</span>&#125;,</div><div class="line">      &#123;<span class="string">"Window_setNeedsReportTimings"</span>, SetNeedsReportTimings, <span class="number">2</span>, <span class="literal">true</span>&#125;,</div><div class="line">      ...</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ—è¡¨ä¸­çš„å‚æ•°ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Dart æ–¹æ³•id</li>
<li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ Engine ä¸­ <code>Native</code> æ–¹æ³•çš„æŒ‡é’ˆï¼Œä¸€èˆ¬ä»¥ <code>_</code> å¼€å¤´çš„æ–¹æ³•æ˜¯ Dart æ³¨å†Œçš„å›è°ƒæ–¹æ³•æˆ–è€…éœ€è¦å›è°ƒçš„æ–¹æ³•</li>
<li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ–¹æ³•å‚æ•°ä¸ªæ•°</li>
<li>ç¬¬å››ä¸ªå‚æ•°ä¸ºæ˜¯å¦è‡ªåŠ¨æ³¨å†Œ</li>
</ul>
<p>åœ¨ <code>DartVM</code> å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå°† Native æ–¹æ³•æ³¨å†Œåˆ° <code>dart:ffi</code>  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// flutter/lib/ui/dart_ui.cc</span></div><div class="line"><span class="keyword">using</span> tonic::ToDart;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> flutter &#123;</div><div class="line"><span class="keyword">namespace</span> &#123;</div><div class="line"></div><div class="line"><span class="comment">// æ³¨å†ŒNativeæ–¹æ³•åˆ—è¡¨</span></div><div class="line"><span class="keyword">static</span> tonic::DartLibraryNatives* g_natives;</div><div class="line"></div><div class="line"><span class="comment">// ç”¨çš„æ—¶å€™æ¥æŸ¥è¡¨</span></div><div class="line"><span class="function">Dart_NativeFunction <span class="title">GetNativeFunction</span><span class="params">(Dart_Handle name,</span></span></div><div class="line">                                      <span class="keyword">int</span> argument_count,</div><div class="line">                                      <span class="keyword">bool</span>* auto_setup_scope) &#123;</div><div class="line">  <span class="keyword">return</span> g_natives-&gt;GetNativeFunction(name, argument_count, auto_setup_scope);</div><div class="line">&#125;</div><div class="line"><span class="comment">//è·å– Dart æ–¹æ³•id</span></div><div class="line"><span class="function"><span class="keyword">const</span> uint8_t* <span class="title">GetSymbol</span><span class="params">(Dart_NativeFunction native_function)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> g_natives-&gt;GetSymbol(native_function);</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;  <span class="comment">// namespace</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> DartUI::InitForGlobal() &#123;</div><div class="line">  <span class="keyword">if</span> (!g_natives) &#123;</div><div class="line">    <span class="comment">// æ„é€ DartLibraryNativesç±»ï¼ŒæŒæœ‰æ–¹æ³•åˆ—è¡¨ï¼Œåˆ†ä¸ºdartæ–¹æ³•idæ˜ å°„è¡¨ï¼Œå’ŒNativeæ–¹æ³•æ˜ å°„è¡¨</span></div><div class="line">    g_natives = <span class="keyword">new</span> tonic::DartLibraryNatives();</div><div class="line">    Canvas::RegisterNatives(g_natives);</div><div class="line">    CanvasGradient::RegisterNatives(g_natives);</div><div class="line">    CanvasImage::RegisterNatives(g_natives);</div><div class="line">    CanvasPath::RegisterNatives(g_natives);</div><div class="line">    CanvasPathMeasure::RegisterNatives(g_natives);</div><div class="line">    Codec::RegisterNatives(g_natives);</div><div class="line">    ColorFilter::RegisterNatives(g_natives);</div><div class="line">    DartRuntimeHooks::RegisterNatives(g_natives);</div><div class="line">    EngineLayer::RegisterNatives(g_natives);</div><div class="line">    FontCollection::RegisterNatives(g_natives);</div><div class="line">    FrameInfo::RegisterNatives(g_natives);</div><div class="line">    ImageFilter::RegisterNatives(g_natives);</div><div class="line">    ImageShader::RegisterNatives(g_natives);</div><div class="line">    IsolateNameServerNatives::RegisterNatives(g_natives);</div><div class="line">    Paragraph::RegisterNatives(g_natives);</div><div class="line">    ParagraphBuilder::RegisterNatives(g_natives);</div><div class="line">    Picture::RegisterNatives(g_natives);</div><div class="line">    PictureRecorder::RegisterNatives(g_natives);</div><div class="line">    Scene::RegisterNatives(g_natives);</div><div class="line">    SceneBuilder::RegisterNatives(g_natives);</div><div class="line">    SemanticsUpdate::RegisterNatives(g_natives);</div><div class="line">    SemanticsUpdateBuilder::RegisterNatives(g_natives);</div><div class="line">    Vertices::RegisterNatives(g_natives);</div><div class="line">    Window::RegisterNatives(g_natives);</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(LEGACY_FUCHSIA_EMBEDDER)</span></div><div class="line">    SceneHost::RegisterNatives(g_natives);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// DartVM åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨</span></div><div class="line"><span class="keyword">void</span> DartUI::InitForIsolate() &#123;</div><div class="line">  FML_DCHECK(g_natives);</div><div class="line">  Dart_Handle result = Dart_SetNativeResolver(</div><div class="line">      Dart_LookupLibrary(ToDart(<span class="string">"dart:ui"</span>)), GetNativeFunction, GetSymbol);</div><div class="line">  <span class="keyword">if</span> (Dart_IsError(result)) &#123;</div><div class="line">    Dart_PropagateError(result);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DartVM åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code>DartUI::InitForIsolate()</code> è¿›è¡Œæ–¹æ³•æ³¨å†Œã€‚</p>
<p>ä¸Šé¢çš„ç±»éƒ½æ˜¯ <code>dart:ui</code> åŒ…ä¸‹çš„ç±»ï¼Œé€šè¿‡ <code>dart:ffi</code> å°† Dart æ–¹æ³•å’Œ Native æ–¹æ³•è¿›è¡Œç»‘å®šã€‚</p>
<p><code>dart:ffi</code> çš„è¯¦ç»†ä»‹ç»è§ <a href="https://flutter.dev/docs/development/platform-integration/c-interop" target="_blank" rel="external">Binding to native code using dart:ffi</a></p>
<h2 id="4ã€æ³¨å†Œ-VSync"><a href="#4ã€æ³¨å†Œ-VSync" class="headerlink" title="4ã€æ³¨å†Œ VSync"></a>4ã€æ³¨å†Œ VSync</h2><p>ç»§ç»­è°ƒç”¨ <code>Window::ScheduleFrame()</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/ui/window.cc</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ScheduleFrame</span><span class="params">(Dart_NativeArguments args)</span> </span>&#123;</div><div class="line">  UIDartState::ThrowIfUIOperationsProhibited();</div><div class="line">  UIDartState::Current()-&gt;window()-&gt;client()-&gt;ScheduleFrame();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// runtime/runtime_controller.cc</span></div><div class="line"><span class="comment">// |WindowClient|</span></div><div class="line"><span class="keyword">void</span> RuntimeController::ScheduleFrame() &#123;</div><div class="line">  client_.ScheduleFrame();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// shell/common/engine.cc</span></div><div class="line"><span class="keyword">void</span> Engine::ScheduleFrame(<span class="keyword">bool</span> regenerate_layer_tree) &#123;</div><div class="line">  animator_-&gt;RequestFrame(regenerate_layer_tree);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// shell/common/animator.cc</span></div><div class="line"><span class="keyword">void</span> Animator::RequestFrame(<span class="keyword">bool</span> regenerate_layer_tree) &#123;</div><div class="line">  <span class="keyword">if</span> (regenerate_layer_tree) &#123;</div><div class="line">    <span class="comment">// é»˜è®¤å€¼ trueï¼Œå†³å®šæ˜¯å¦é‡æ–°ç”Ÿæˆlayer tree</span></div><div class="line">    regenerate_layer_tree_ = <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// å½“è°ƒç”¨ Animator::Stop() åœæ­¢è¯·æ±‚</span></div><div class="line">  <span class="keyword">if</span> (paused_ &amp;&amp; !dimension_change_pending_) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!pending_frame_semaphore_.TryWait()) &#123;</div><div class="line">    <span class="comment">// å¤šæ¬¡è°ƒç”¨ï¼Œåªç”Ÿæ•ˆä¸€æ¬¡</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// åœ¨ UIThread æ‰§è¡Œ VSync æ³¨å†Œå›è°ƒ</span></div><div class="line">  task_runners_.GetUITaskRunner()-&gt;PostTask([self = weak_factory_.GetWeakPtr(),</div><div class="line">                                             frame_number = frame_number_]() &#123;</div><div class="line">    <span class="keyword">if</span> (!self.get()) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    TRACE_EVENT_ASYNC_BEGIN0(<span class="string">"flutter"</span>, <span class="string">"Frame Request Pending"</span>, frame_number);</div><div class="line">    <span class="comment">//æ³¨å†Œ VSync</span></div><div class="line">    self-&gt;AwaitVSync();</div><div class="line">  &#125;);</div><div class="line">  <span class="comment">// æ ‡è®°å·²ç»è¯·æ±‚æ¸²æŸ“</span></div><div class="line">  frame_scheduled_ = <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œæ–¹æ³•çš„å‚æ•° <code>regenerate_layer_tree</code> é»˜è®¤å€¼æ˜¯ trueï¼Œå½“ä¸º false æ—¶ä¸éœ€è¦é‡ç»˜</li>
<li>é€šè¿‡ <code>pending_frame_semaphore_</code> ä¿¡å·é‡æ§åˆ¶ <code>Animator::ScheduleFrame</code> åªéœ€æ³¨å†Œä¸€æ¬¡ VSync ä¿¡å·ï¼Œåˆå§‹å€¼ä¸º1ï¼Œä¸º0 æ—¶ï¼Œè¿™é‡Œ <code>pending_frame_semaphore_</code> -1ï¼Œ<code>Animator::beginFrame()</code> è¢«è°ƒç”¨å <code>pending_frame_semaphore_</code> + 1</li>
<li>åœ¨ UIThread æ‰§è¡Œ VSync æ³¨å†Œå›è°ƒ</li>
</ul>
<h3 id="4-1ã€Animator-AwaitVSync"><a href="#4-1ã€Animator-AwaitVSync" class="headerlink" title="4.1ã€Animator::AwaitVSync()"></a>4.1ã€Animator::AwaitVSync()</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// shell/common/animator.cc</span></div><div class="line"><span class="keyword">void</span> Animator::AwaitVSync() &#123;</div><div class="line">  waiter_-&gt;AsyncWaitForVsync(</div><div class="line">      [self = weak_factory_.GetWeakPtr()](fml::TimePoint frame_start_time,</div><div class="line">                                          fml::TimePoint frame_target_time) &#123;</div><div class="line">        <span class="comment">// VSync ä¿¡å·çš„å›è°ƒæ–¹æ³•</span></div><div class="line">        <span class="comment">// frame_start_time ä¸ºæ¥å—åˆ° VSync ä¿¡å·æ—¶é—´ç‚¹</span></div><div class="line">        <span class="comment">// frame_target_time ä¸ºè¿™ä¸€å¸§æ¸²æŸ“ç›®æ ‡æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å³ä¸ºæ‰å¸§</span></div><div class="line">        <span class="keyword">if</span> (self) &#123;</div><div class="line">          <span class="keyword">if</span> (self-&gt;CanReuseLastLayerTree()) &#123;</div><div class="line">            <span class="comment">// regenerate_layer_tree ä¸ºfalseï¼Œå¤ç”¨ä¸Šä¸€æ¬¡ç”Ÿæˆçš„LayerTreeï¼Œç›´æ¥å…‰æ …åŒ–åˆæˆ</span></div><div class="line">            self-&gt;DrawLastLayerTree();</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// è§¦å‘æ¸²æŸ“ç®¡çº¿å·¥ä½œ</span></div><div class="line">            self-&gt;BeginFrame(frame_start_time, frame_target_time);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">  delegate_.OnAnimatorNotifyIdle(dart_frame_deadline_);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ³¨å†ŒVSync ä¿¡å·çš„å›è°ƒ</li>
<li><code>frame_start_time</code> ä¸ºæ¥å—åˆ° VSync ä¿¡å·æ—¶é—´ç‚¹ï¼Œ <code>frame_target_time</code> ä¸ºè¿™ä¸€å¸§æ¸²æŸ“ç›®æ ‡æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ç‚¹å³ä¸ºæ‰å¸§ï¼Œä¸‹ä¸€å¸§å°±ä¸ä¼šæ³¨å†Œ VSync ä¿¡å·å›è°ƒ</li>
<li>regenerate_layer_tree ä¸ºfalseï¼Œå¤ç”¨ä¸Šä¸€æ¬¡ç”Ÿæˆçš„LayerTreeï¼Œç›´æ¥å…‰æ …åŒ–åˆæˆï¼›ä¸º false ç»§ç»­è§¦å‘æ¸²æŸ“ç®¡çº¿å¯åŠ¨</li>
<li><code>waiter_</code> ä¸º <code>VsyncWaiter</code> å¯¹è±¡ï¼Œåœ¨å¼•æ“å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œåˆå§‹åŒ– <code>Shell</code> æ—¶è¢«åˆ›å»ºï¼Œæ ¹æ®ä¸åŒ Platformï¼Œæ„å»ºå‡ºä¸åŒçš„å¯¹è±¡ï¼Œè¿™é‡Œä»¥ Android ä¸ºä¾‹ï¼Œå®ƒæ˜¯ <code>VsyncWaiterAndroid</code> ç±»çš„å¯¹è±¡</li>
</ul>
<h3 id="4-2ã€VsyncWaiter-AsyncWaitForVsync"><a href="#4-2ã€VsyncWaiter-AsyncWaitForVsync" class="headerlink" title="4.2ã€VsyncWaiter::AsyncWaitForVsync"></a>4.2ã€VsyncWaiter::AsyncWaitForVsync</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// shell/common/async_waiter.cc</span></div><div class="line"><span class="keyword">void</span> VsyncWaiter::AsyncWaitForVsync(<span class="keyword">const</span> Callback&amp; callback) &#123;</div><div class="line">	...</div><div class="line">  TRACE_EVENT0(<span class="string">"flutter"</span>, <span class="string">"AsyncWaitForVsync"</span>);</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="function">scoped_lock <span class="title">lock</span><span class="params">(callback_mutex_)</span></span>;</div><div class="line">    ...</div><div class="line">    callback_ = <span class="built_in">std</span>::move(callback);</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">  AwaitVSync();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// shell/platform/android/vsync_waiter_android.cc</span></div><div class="line"><span class="keyword">void</span> VsyncWaiterAndroid::AwaitVSync() &#123;</div><div class="line">  <span class="keyword">auto</span>* weak_this = <span class="keyword">new</span> <span class="built_in">std</span>::weak_ptr&lt;VsyncWaiter&gt;(shared_from_this());</div><div class="line">  jlong java_baton = <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(weak_this);</div><div class="line"></div><div class="line">  task_runners_.GetPlatformTaskRunner()-&gt;PostTask([java_baton]() &#123;</div><div class="line">    JNIEnv* env = fml::jni::AttachCurrentThread();</div><div class="line">    env-&gt;CallStaticVoidMethod(g_vsync_waiter_class-&gt;obj(),     </div><div class="line">                              g_async_wait_for_vsync_method_,  </div><div class="line">                              java_baton                       </div><div class="line">    );</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// æ³¨å†Œ JNI æ–¹æ³•</span></div><div class="line"><span class="keyword">bool</span> VsyncWaiterAndroid::Register(JNIEnv* env) &#123;</div><div class="line">  <span class="comment">// VSync å›è°ƒï¼ŒJava è°ƒç”¨</span></div><div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod methods[] = &#123;&#123;</div><div class="line">      .name = <span class="string">"nativeOnVsync"</span>,</div><div class="line">      .signature = <span class="string">"(JJJ)V"</span>,</div><div class="line">      .fnPtr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(&amp;OnNativeVsync),</div><div class="line">  &#125;&#125;;</div><div class="line"></div><div class="line">  jclass clazz = env-&gt;FindClass(<span class="string">"io/flutter/embedding/engine/FlutterJNI"</span>);</div><div class="line"></div><div class="line">  g_vsync_waiter_class = <span class="keyword">new</span> fml::jni::ScopedJavaGlobalRef&lt;jclass&gt;(env, clazz);</div><div class="line">  </div><div class="line">  g_async_wait_for_vsync_method_ = env-&gt;GetStaticMethodID(</div><div class="line">      g_vsync_waiter_class-&gt;obj(), <span class="string">"asyncWaitForVsync"</span>, <span class="string">"(J)V"</span>);</div><div class="line">  <span class="keyword">return</span> env-&gt;RegisterNatives(clazz, methods, fml::size(methods)) == <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å¼•æ“å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå·²ç»é€šè¿‡ Java JNI ç»‘å®šäº† C++ å’Œ Java ä»£ç çš„æ˜ å°„ï¼Œè¿™é‡Œé€šè¿‡ JNI è°ƒç”¨ Android Java ä»£ç </p>
<ul>
<li>JNIEnv ä»£è¡¨äº† Java åœ¨æœ¬çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒï¼ˆåœ¨è¿™é‡Œå°±æ˜¯ Android ä¸»çº¿ç¨‹ï¼‰ï¼Œå®ƒçš„ç»“æ„æ˜¯ä¸€ä¸ªå‡½æ•°è¡¨</li>
<li>æ³¨å†Œ VSync ä¿¡å·å›è°ƒ <code>nativeOnVsync</code>  Native æ–¹æ³• <code>OnNativeVsync</code></li>
<li>è¿è¡Œåœ¨ PlatformThreadï¼Œå³ Android ä¸»çº¿ç¨‹</li>
<li><code>g_vsync_waiter_class</code> ä¸ <code>io/flutter/embedding/engine/FlutterJNI</code> Java ç±»ç»‘å®š</li>
<li><code>g_async_wait_for_vsync_method_</code> æ˜¯ <code>io/flutter/embedding/engine/FlutterJNI.asyncWaitForVsync()</code> Java æ–¹æ³•çš„æŒ‡é’ˆ</li>
</ul>
<p>æœ€ç»ˆåœ¨ Android ä¸»çº¿ç¨‹è°ƒç”¨ <code>io/flutter/embedding/engine/FlutterJNI.asyncWaitForVsync()</code> æ–¹æ³•ã€‚</p>
<h3 id="4-3ã€Choreographer"><a href="#4-3ã€Choreographer" class="headerlink" title="4.3ã€Choreographer"></a>4.3ã€Choreographer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// io.flutter.embedding.engine.FlutterJNI</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">asyncWaitForVsync</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> cookie)</span> </span>&#123;</div><div class="line">    asyncWaitForVsyncDelegate.asyncWaitForVsync(cookie);</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">//io.flutter.view.VsyncWaiter</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VsyncWaiter</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> VsyncWaiter instance;</div><div class="line"></div><div class="line">  <span class="meta">@NonNull</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VsyncWaiter <span class="title">getInstance</span><span class="params">(@NonNull WindowManager windowManager)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">      instance = <span class="keyword">new</span> VsyncWaiter(windowManager);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> instance;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@NonNull</span> <span class="keyword">private</span> <span class="keyword">final</span> WindowManager windowManager;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FlutterJNI.AsyncWaitForVsyncDelegate asyncWaitForVsyncDelegate =</div><div class="line">      <span class="keyword">new</span> FlutterJNI.AsyncWaitForVsyncDelegate() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">asyncWaitForVsync</span><span class="params">(<span class="keyword">long</span> cookie)</span> </span>&#123;</div><div class="line">          Choreographer.getInstance()</div><div class="line">            <span class="comment">// æ³¨å†Œ VSync å›è°ƒï¼Œåªä¼šå›è°ƒä¸€æ¬¡</span></div><div class="line">              .postFrameCallback(</div><div class="line">                  <span class="keyword">new</span> Choreographer.FrameCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</div><div class="line">                      <span class="comment">// è·å–å±å¹•åˆ·æ–°é¢‘ç‡ï¼Œä¾‹å¦‚60ã€90ã€120</span></div><div class="line">                      <span class="keyword">float</span> fps = windowManager.getDefaultDisplay().getRefreshRate();</div><div class="line">                      <span class="comment">// æ ¹æ®åˆ·æ–°é¢‘ç‡è®¡ç®—å‡ºæ¯ä¸€å¸§ç»˜åˆ¶æ—¶é—´</span></div><div class="line">                      <span class="keyword">long</span> refreshPeriodNanos = (<span class="keyword">long</span>) (<span class="number">1000000000.0</span> / fps);</div><div class="line">                      <span class="comment">// å›è°ƒ Native æ–¹æ³•ï¼ŒframeTimeNanos å³ä¸º frame_start_time</span></div><div class="line">                      FlutterJNI.nativeOnVsync(</div><div class="line">                          frameTimeNanos, frameTimeNanos + refreshPeriodNanos, cookie);</div><div class="line">                    &#125;</div><div class="line">                  &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">VsyncWaiter</span><span class="params">(@NonNull WindowManager windowManager)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.windowManager = windowManager;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//è®¾ç½® FlutterJNI delegate</span></div><div class="line">    FlutterJNI.setAsyncWaitForVsyncDelegate(asyncWaitForVsyncDelegate);</div><div class="line"></div><div class="line">    <span class="comment">// è·å–å±å¹•åˆ·æ–°é¢‘ç‡ï¼Œä¾‹å¦‚60ã€90ã€120</span></div><div class="line">    <span class="keyword">float</span> fps = windowManager.getDefaultDisplay().getRefreshRate();</div><div class="line">    FlutterJNI.setRefreshRateFPS(fps);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨ App å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ<code>FlutterLoader.startInitialization()</code> æ–¹æ³•ä¸­åˆå§‹åŒ– <code>VsyncWaiter</code> å•ä¾‹ï¼Œè®¾ç½® FlutterJNI delegate</li>
<li>é€šè¿‡ <code>Choreographer..postFrameCallback()</code> æ³¨å†Œ VSync ä¿¡å·å›è°ƒï¼Œåªä¼šå›è°ƒä¸€æ¬¡ï¼Œæ¯ç”¨ä¸€æ¬¡æ³¨å†Œä¸€æ¬¡</li>
<li>æ ¹æ®å±å¹•åˆ·æ–°é¢‘ç‡ï¼Œè®¡ç®— <code>frame_start_time</code> å’Œ <code>frame_target_time</code></li>
<li>æ”¶åˆ° VSync ä¿¡å·å›è°ƒåï¼Œé€šè¿‡ JNI å›è°ƒ Native æ–¹æ³•</li>
</ul>
<p>Choreographer é€šè¿‡ <code>SurfaceFlinger</code> æ³¨å†Œ VSync ä¿¡å·å›è°ƒ <code>FrameDisplayEventReceiver</code>ï¼Œä¸€æ—¦ VSync ä¿¡å·åˆ°æ¥ï¼Œ<code>SurfaceFlinger</code> é€šçŸ¥ FrameDisplayEventReceiver å›è°ƒ <code>doFrame()</code> æ–¹æ³•.</p>
<p>æ³¨æ„åªä¼šå›è°ƒä¸€æ¬¡ï¼Œæ¯ç”¨ä¸€æ¬¡æ³¨å†Œä¸€æ¬¡ã€‚æ‰€ä»¥å½“å±å¹•é™æ­¢æœªåˆ·æ–°æ—¶ï¼ŒFPS ä¼šä¸€ä¸ºæœª 0ã€‚</p>
<h3 id="4-4ã€OnNativeVsync"><a href="#4-4ã€OnNativeVsync" class="headerlink" title="4.4ã€OnNativeVsync"></a>4.4ã€OnNativeVsync</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// shell/platform/android/vsync_waiter_android.cc</span></div><div class="line"><span class="keyword">void</span> VsyncWaiterAndroid::OnNativeVsync(JNIEnv* env,</div><div class="line">                                       jclass jcaller,</div><div class="line">                                       jlong frameTimeNanos,</div><div class="line">                                       jlong frameTargetTimeNanos,</div><div class="line">                                       jlong java_baton) &#123;</div><div class="line">  <span class="keyword">auto</span> frame_time = fml::TimePoint::FromEpochDelta(</div><div class="line">      fml::TimeDelta::FromNanoseconds(frameTimeNanos));</div><div class="line">  <span class="keyword">auto</span> target_time = fml::TimePoint::FromEpochDelta(</div><div class="line">      fml::TimeDelta::FromNanoseconds(frameTargetTimeNanos));</div><div class="line"></div><div class="line">  ConsumePendingCallback(java_baton, frame_time, target_time);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// shell/common/async_waiter.cc</span></div><div class="line"><span class="keyword">void</span> VsyncWaiter::FireCallback(fml::TimePoint frame_start_time,</div><div class="line">                               fml::TimePoint frame_target_time) &#123;</div><div class="line">  Callback callback;</div><div class="line">  fml::closure secondary_callback;</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="function">scoped_lock <span class="title">lock</span><span class="params">(callback_mutex_)</span></span>;</div><div class="line">    callback = <span class="built_in">std</span>::move(callback_);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (callback) &#123;</div><div class="line">    <span class="keyword">auto</span> flow_identifier = fml::tracing::TraceNonce();</div><div class="line">    TRACE_FLOW_BEGIN(<span class="string">"flutter"</span>, kVsyncFlowName, flow_identifier);</div><div class="line">		<span class="comment">// è¿è¡Œåœ¨ UIThread </span></div><div class="line">    task_runners_.GetUITaskRunner()-&gt;PostTaskForTime(</div><div class="line">        [callback, flow_identifier, frame_start_time, frame_target_time]() &#123;</div><div class="line">          <span class="comment">// æ‰§è¡Œå›è°ƒæ–¹æ³•</span></div><div class="line">          callback(frame_start_time, frame_target_time);</div><div class="line">          TRACE_FLOW_END(<span class="string">"flutter"</span>, kVsyncFlowName, flow_identifier);</div><div class="line">        &#125;,</div><div class="line">        frame_start_time);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œæ³¨å†Œçš„å›è°ƒæ–¹æ³•ï¼Œè¿è¡Œåœ¨ UIThreadï¼Œå›åˆ° #4.1</p>
<h2 id="5ã€BeginFrame"><a href="#5ã€BeginFrame" class="headerlink" title="5ã€BeginFrame"></a>5ã€BeginFrame</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Animator::BeginFrame(fml::TimePoint frame_start_time,</div><div class="line">                          fml::TimePoint frame_target_time) &#123;</div><div class="line">  frame_scheduled_ = <span class="literal">false</span>;</div><div class="line">  notify_idle_task_id_++;</div><div class="line">  regenerate_layer_tree_ = <span class="literal">false</span>;</div><div class="line">  <span class="comment">//ä¿¡å·é‡ pending_frame_semaphore_ +1ï¼Œå¯ä»¥ç»§ç»­æ¥æ”¶ RequestFrame è¯·æ±‚</span></div><div class="line">  pending_frame_semaphore_.Signal();</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!producer_continuation_) &#123;</div><div class="line">    <span class="comment">// producer_continuation_ æŒæœ‰ç”Ÿäº§å¯¹è±¡ï¼Œå¹¶é€šè¿‡ä¿¡å·é‡æ§åˆ¶ç®¡çº¿ä»»åŠ¡</span></div><div class="line">    producer_continuation_ = layer_tree_pipeline_-&gt;Produce();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!producer_continuation_) &#123;</div><div class="line">      <span class="comment">// layer_tree_pipeline_ ç®¡çº¿ä»»åŠ¡å·²æ»¡ï¼ˆ2ä¸ªï¼‰ï¼Œå¿½ç•¥æœ¬æ¬¡ç»˜åˆ¶</span></div><div class="line">      RequestFrame();</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  last_frame_begin_time_ = frame_start_time;</div><div class="line">  last_frame_target_time_ = frame_target_time;</div><div class="line">  dart_frame_deadline_ = FxlToDartOrEarlier(frame_target_time);</div><div class="line">  &#123;</div><div class="line">    delegate_.OnAnimatorBeginFrame(frame_target_time);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!frame_scheduled_) &#123;</div><div class="line">    <span class="comment">// Animator::RequestFrame() æ–¹æ³•æœ€åç½®ä¸º trueï¼Œæ ‡è®°å·²ç»è¯·æ±‚æ¸²æŸ“</span></div><div class="line">    task_runners_.GetUITaskRunner()-&gt;PostDelayedTask(</div><div class="line">        [self = weak_factory_.GetWeakPtr(),</div><div class="line">         notify_idle_task_id = notify_idle_task_id_]() &#123;</div><div class="line">          <span class="keyword">if</span> (!self.get()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// 51ms æ—¶é—´ä¹‹å†…æ²¡æœ‰æ–°çš„æäº¤æ–°çš„ä»»åŠ¡ï¼Œé€šçŸ¥Engineç©ºé—²å¯ä»¥è¿›è¡Œ GC</span></div><div class="line">          <span class="keyword">if</span> (notify_idle_task_id == self-&gt;notify_idle_task_id_ &amp;&amp;</div><div class="line">              !self-&gt;frame_scheduled_) &#123;</div><div class="line">            self-&gt;delegate_.OnAnimatorNotifyIdle(Dart_TimelineGetMicros() +</div><div class="line">                                                 <span class="number">100000</span>);</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">      	<span class="comment">// 51msï¼Œé€šçŸ¥ Engine ç©ºé—²</span></div><div class="line">        kNotifyIdleTaskWaitTime);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¿¡å·é‡ pending_frame<em>semaphore</em> +1ï¼Œå¯ä»¥ç»§ç»­æ¥æ”¶ RequestFrame è¯·æ±‚</li>
<li>regenerate_layer<em>tree</em> èµ‹å€¼ falseï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹è°ƒç”¨ RequestFrame å¯ä»¥å¤ç”¨è¿™æ¬¡ç”Ÿæˆçš„ <code>flutter::LayerTree</code></li>
<li><code>producer_continuation_</code> æ˜¯ <code>ProducerContinuation</code> ç±»çš„å¯¹è±¡ï¼ŒæŒæœ‰ç”Ÿäº§å¯¹è±¡ï¼Œå¹¶é€šè¿‡ä¿¡å·é‡æ§åˆ¶ç®¡çº¿ä»»åŠ¡</li>
<li><code>layer_tree_pipeline_</code> æ˜¯ <code>LayerTreePipeline</code> ç±»çš„å¯¹è±¡ï¼Œåœ¨ Animator åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«åˆ›å»ºï¼Œ<code>LayerTreePipeline</code> æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼Œ UIThread è´Ÿè´£ç”Ÿäº§ <code>flutter::LayerTree</code> å’Œ RasterThread è´Ÿè´£æ¶ˆè´¹ <code>flutter::LayerTree</code>ï¼Œ<code>flutter::LayerTree</code> æŒæœ‰ Dart Framework ç”Ÿæˆçš„Layer Treeæ˜ å°„åˆ° Engine çš„ <code>flow::Layer</code> çš„æ ¹èŠ‚ç‚¹</li>
<li>æ‰§è¡Œ <code>delegate_.OnAnimatorBeginFrame(frame_target_time)</code> ï¼Œ delagate_ çš„å®ç°åœ¨ <code>Shell</code> ç±»</li>
</ul>
<h3 id="5-1ã€LayerTreePipeline"><a href="#5-1ã€LayerTreePipeline" class="headerlink" title="5.1ã€LayerTreePipeline"></a>5.1ã€LayerTreePipeline</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">	// shell/common/animator.h</div><div class="line">  using LayerTreePipeline = Pipeline&lt;flutter::LayerTree&gt;;</div><div class="line">...</div><div class="line">// shell/common/animator.cc</div><div class="line">Animator::Animator(Delegate&amp; delegate,</div><div class="line">                   TaskRunners task_runners,</div><div class="line">                   std::unique_ptr&lt;VsyncWaiter&gt; waiter)</div><div class="line">    : delegate_(delegate),</div><div class="line">      task_runners_(std::move(task_runners)),</div><div class="line">      waiter_(std::move(waiter)),</div><div class="line">      last_frame_begin_time_(),</div><div class="line">      last_frame_target_time_(),</div><div class="line">      dart_frame_deadline_(0),</div><div class="line">#if FLUTTER_SHELL_ENABLE_METAL</div><div class="line">			// æ”¯æŒ Metal æ·±åº¦ä¸º2</div><div class="line">      layer_tree_pipeline_(fml::MakeRefCounted&lt;LayerTreePipeline&gt;(2)),</div><div class="line">#else   </div><div class="line">			// è¿™é‡Œåœ¨ä¸€äº›æƒ…å†µä¸‹æœ‰bugï¼Œåç»­ç‰ˆæœ¬ä¼šå†™æ­»æ·±åº¦ä¸º2 </div><div class="line">      layer_tree_pipeline_(fml::MakeRefCounted&lt;LayerTreePipeline&gt;(</div><div class="line">          task_runners.GetPlatformTaskRunner() ==</div><div class="line">                  task_runners.GetRasterTaskRunner()</div><div class="line">              ? 1</div><div class="line">              : 2)),</div><div class="line">#endif  // FLUTTER_SHELL_ENABLE_METAL </div><div class="line">			// pending_frame_semaphore_ åˆå§‹åŒ–ä¸º1ï¼Œå¯ä»¥æ¥å—ä¸€ä¸ª RequestFrame è¯·æ±‚</div><div class="line">      pending_frame_semaphore_(1),</div><div class="line">...</div><div class="line">	// shell/common/pipeline.h</div><div class="line">  explicit Pipeline(uint32_t depth)</div><div class="line">      : depth_(depth), empty_(depth), available_(0), inflight_(0) &#123;&#125;</div><div class="line">  fml::Semaphore empty_; // é»˜è®¤ä¸º2</div><div class="line">  fml::Semaphore available_ // é»˜è®¤ä¸º0</div></pre></td></tr></table></figure>
<p>æ„å»ºæ·±åº¦ä¸º 2 çš„ <code>Pipeline</code> å¯¹è±¡ï¼Œå¯ä»¥æŒæœ‰ <code>flutter::LayerTree</code> å¯¹è±¡ã€‚</p>
<p>Pipeline æŒæœ‰ä¸¤ä¸ªä¿¡å·é‡ <code>empty_</code> å’Œ <code>available_</code>ï¼Œç”¨æ¥æ§åˆ¶ç®¡çº¿ä»»åŠ¡è°ƒåº¦ã€‚</p>
<p>å½“è°ƒç”¨ <code>layer_tree_pipeline_-&gt;Produce()</code> æ–¹æ³•æ—¶</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// shell/common/pipeline.h</span></div><div class="line"><span class="function">ProducerContinuation <span class="title">Produce</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!empty_.TryWait()) &#123;</div><div class="line">     <span class="comment">// ä¿¡å·é‡ empty_ ä¸º0æ—¶ï¼Œè¿”å›ç©º</span></div><div class="line">     <span class="keyword">return</span> &#123;&#125;;</div><div class="line">   &#125;</div><div class="line">   ++inflight_;</div><div class="line">   </div><div class="line">   <span class="keyword">return</span> ProducerContinuation&#123;</div><div class="line">     <span class="comment">// æŒæœ‰ Pipeline::ProducerCommit æ–¹æ³•å¼•ç”¨</span></div><div class="line">       <span class="built_in">std</span>::bind(&amp;Pipeline::ProducerCommit, <span class="keyword">this</span>, <span class="built_in">std</span>::placeholders::_1,</div><div class="line">                 <span class="built_in">std</span>::placeholders::_2),  <span class="comment">// continuation</span></div><div class="line">       GetNextPipelineTraceID()&#125;;         <span class="comment">// trace id</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ç”Ÿæˆä¸€ä¸ª <code>ProducerContinuation</code> ç±»çš„å¯¹è±¡ <code>producer_continuation_</code>ï¼Œ<code>continuation_</code> å¯¹è±¡æŒæœ‰ <code>Pipeline::ProducerCommit()</code> æ–¹æ³•å¼•ç”¨ã€‚</p>
<p>å½“ UIThread åœ¨ Dart Framework ç”Ÿæˆ Layer Treeï¼Œå¹¶é€šè¿‡ <code>SceneBuilder</code> æ„å»ºå‡º <code>Scene</code> å¯¹è±¡ï¼ŒæŒæœ‰ <code>flutter:LayerTree</code>ï¼Œè°ƒç”¨ <code>window.render()</code> æ–¹æ³•å¼€å¯å…‰æ …åŒ–åˆæˆä¹‹å‰ï¼Œä¼šè°ƒç”¨<code>Pipeline::ProducerCommit()</code> æ–¹æ³•ï¼Œå¹¶å°† <code>flutter:LayerTree</code> ç»‘å®šåˆ° <code>producer_continuation_</code>å¯¹è±¡</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// shell/common/pipeline.h</span></div><div class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">ProducerCommit</span><span class="params">(ResourcePtr resource, <span class="keyword">size_t</span> trace_id)</span> </span>&#123;</div><div class="line">    &#123;</div><div class="line">      <span class="built_in">std</span>::<span class="function">scoped_lock <span class="title">lock</span><span class="params">(queue_mutex_)</span></span>;</div><div class="line">      <span class="comment">//resource æ˜¯ flutter:LayerTree å¯¹è±¡ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—</span></div><div class="line">      queue_.emplace_back(<span class="built_in">std</span>::move(resource), trace_id);</div><div class="line">    &#125;</div><div class="line">		<span class="comment">// available_ + 1ï¼Œè§¦å‘ RasterThread å…‰æ …åŒ–</span></div><div class="line">    available_.Signal();</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>æ•´ä¸ª Pipeline ç®¡çº¿çš„æµç¨‹ä¸ºï¼š</p>
<ul>
<li><p><code>Animator::RequestFrame()</code>æ–¹æ³•è§¦å‘ç»˜åˆ¶å¼€å§‹<code>_empty</code> -1ï¼Œå¼€å§‹ç”Ÿæˆ <code>flutter::LayerTree</code>ï¼Œè¿è¡Œåœ¨ UIThread</p>
</li>
<li><p>å½“ UIThread å‡†å¤‡å¥½ Engine <code>flutter::LayerTree</code>ï¼Œ <code>available_</code> +1</p>
</li>
<li><p>å½“ <code>available_</code> &gt; 0 æ—¶ï¼Œè§¦å‘ Raster Thread å·¥ä½œï¼Œæ‹¿åˆ° <code>flutter:LayerTree</code> è¿›è¡Œå…‰æ …åŒ–åˆæˆ</p>
</li>
<li><p>å½“ RasterThread å¤„ç†å®Œæˆï¼Œ <code>_empty</code> + 1ï¼Œä¸‹æ¬¡ <code>Animator::RequestFrame()</code> å¯ä»¥æ­£å¸¸å¼€å§‹å¤„ç†ç”Ÿæˆ <code>flutter::LayerTree</code> å·¥ä½œ</p>
</li>
<li><p>å½“ <code>_empty</code> ä¸º 0 æ—¶ï¼Œç®¡çº¿ä»»åŠ¡å·²æ»¡ï¼Œå¿½ç•¥æœ¬æ¬¡ <code>Animator::RequestFrame()</code> è¯·æ±‚ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡ VSync ä¿¡å·åˆ°æ¥</p>
</li>
</ul>
<p>é€šè¿‡ä¸¤ä¸ªä¿¡å·é‡æ¥ç®¡ç†ç®¡çº¿çš„è°ƒåº¦ï¼Œè¿™ç§è°ƒåº¦æœºåˆ¶å¯ä»¥ç¡®ä¿ RasterThread ä¸è‡³äºè¿‡è½½ï¼ˆ2ä¸ªä»»åŠ¡ï¼‰ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å… UIThread ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ã€‚</p>
<p>æ‰€ä»¥ä¸è®ºåœ¨ UIThread è¿˜æ˜¯åœ¨ RasterThread è€—æ—¶å¤ªä¹…ï¼Œéƒ½å¯èƒ½ä¼šå¯¼è‡´ Flutter åº”ç”¨å¡é¡¿ï¼Œå› ä¸ºä¼šå¯¼è‡´å»¶è¿Ÿæ¥å— VSync ä¿¡å·ï¼Œå¯¼è‡´æ‰å¸§ã€‚</p>
<h3 id="5-2ã€OnAnimatorBeginFrame"><a href="#5-2ã€OnAnimatorBeginFrame" class="headerlink" title="5.2ã€OnAnimatorBeginFrame"></a>5.2ã€OnAnimatorBeginFrame</h3><p>ç»§ç»­è°ƒç”¨ <code>delegate_.OnAnimatorBeginFrame(frame_target_time)</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// shell/common/shell.cc</span></div><div class="line"><span class="comment">// |Animator::Delegate|</span></div><div class="line"><span class="keyword">void</span> Shell::OnAnimatorBeginFrame(fml::TimePoint frame_target_time) &#123;</div><div class="line">  FML_DCHECK(is_setup_);</div><div class="line">  FML_DCHECK(task_runners_.GetUITaskRunner()-&gt;RunsTasksOnCurrentThread());</div><div class="line"></div><div class="line">  <span class="comment">// record the target time for use by rasterizer.</span></div><div class="line">  &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="function">scoped_lock <span class="title">time_recorder_lock</span><span class="params">(time_recorder_mutex_)</span></span>;</div><div class="line">    <span class="comment">// è®°å½•frame_target_time</span></div><div class="line">    latest_frame_target_time_.emplace(frame_target_time);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (engine_) &#123;</div><div class="line">    engine_-&gt;BeginFrame(frame_target_time);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// shell/common/engine.cc</span></div><div class="line"><span class="keyword">void</span> Engine::BeginFrame(fml::TimePoint frame_time) &#123;</div><div class="line">  TRACE_EVENT0(<span class="string">"flutter"</span>, <span class="string">"Engine::BeginFrame"</span>);</div><div class="line">  runtime_controller_-&gt;BeginFrame(frame_time);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// runtime/runtime_controller.cc</span></div><div class="line"><span class="keyword">bool</span> RuntimeController::BeginFrame(fml::TimePoint frame_time) &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span>* window = GetWindowIfAvailable()) &#123;</div><div class="line">    window-&gt;BeginFrame(frame_time);</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// lib/ui/window/window.cc</span></div><div class="line"><span class="keyword">void</span> Window::DidCreateIsolate() &#123;</div><div class="line">  library_.Set(tonic::DartState::Current(),</div><div class="line">               Dart_LookupLibrary(tonic::ToDart(<span class="string">"dart:ui"</span>)));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Window::BeginFrame(fml::TimePoint frameTime) &#123;</div><div class="line">  tonic::DartState::<span class="function">Scope <span class="title">scope</span><span class="params">(dart_state)</span></span>;</div><div class="line"></div><div class="line">  <span class="keyword">int64_t</span> microseconds = (frameTime - fml::TimePoint()).ToMicroseconds();</div><div class="line">	<span class="comment">// é€šè¿‡ fii å›è°ƒ Dart Framework window._beginFrame()</span></div><div class="line">  tonic::LogIfError(tonic::DartInvokeField(library_.value(), <span class="string">"_beginFrame"</span>,</div><div class="line">                                           &#123;</div><div class="line">                                               Dart_NewInteger(microseconds),</div><div class="line">                                           &#125;));</div><div class="line">	<span class="comment">// æ‰§è¡Œ microtasks</span></div><div class="line">  UIDartState::Current()-&gt;FlushMicrotasksNow();</div><div class="line">  <span class="comment">// é€šè¿‡ ffi å›è°ƒ Dart Framework window._drawFrame()</span></div><div class="line">  tonic::LogIfError(tonic::DartInvokeField(library_.value(), <span class="string">"_drawFrame"</span>, &#123;&#125;));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ Shell::OnAnimatorBeginFrame -&gt; Engine::BeginFrame -&gt; RuntimeController::BeginFrame -&gt; Window::BeginFrame å±‚å±‚è°ƒç”¨ï¼Œé€šè¿‡ ffi å›è°ƒ Dart Framework ç»§ç»­ç»˜åˆ¶æµç¨‹ã€‚</p>
<p>åšä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>æ‰§è¡Œ Dart Framework <code>dart:ui</code> åŒ…ä¸‹çš„ <code>_beginFrame()</code></li>
<li>æ‰§è¡Œ microtasks ä»»åŠ¡</li>
<li>æ‰§è¡Œ Dart Framework <code>dart:ui</code> åŒ…ä¸‹çš„  <code>_drawFrame()</code></li>
</ul>
<p>è¿™ä¸ªæµç¨‹å’Œæ–‡ç« å¼€å¤´æåˆ°çš„ <code>SchedulerBinding</code> çš„çŠ¶æ€æœº <code>SchedulerPhase</code> ä¸­å£°æ˜çš„çŠ¶æ€ä¸€ä¸€å¯¹åº”ï¼Œæ¥ä¸‹æ¥å›è°ƒåˆ° Dart Framework åï¼Œç”± <code>SchedulerBinding</code> è¿›è¡Œç»˜åˆ¶è°ƒåº¦ã€‚</p>
<p>åˆ°è¿™é‡Œï¼ŒVSync æ³¨å†Œæµç¨‹ç»“æŸï¼Œæ¥ä¸‹æ¥å›åˆ° Dart Framework ä¸­ç»§ç»­è¿›è¡Œã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://book.flutterchina.club/chapter14/flutter_app_startup.html" target="_blank" rel="external">14.4 Flutterè¿è¡Œæœºåˆ¶-ä»å¯åŠ¨åˆ°æ˜¾ç¤º</a></p>
<p>[Flutteræ¸²æŸ“æœºåˆ¶â€”UIçº¿ç¨‹](</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2020/11/11/flutter-ui-vsync/">http://w4lle.com/2020/11/11/flutter-ui-vsync/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Flutter App å¯åŠ¨è¿‡ç¨‹æˆ–è€… State åˆ·æ–°è¿‡ç¨‹ä¸­ï¼Œä¼šè¯·æ±‚æ³¨å†Œ VSync ä¿¡å·ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹ VSync ä¿¡å·æ³¨å†Œä»¥åŠå›è°ƒè¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;åŸºäº Android å¹³å°ï¼ŒFlutter v1.20.4ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Flutter" scheme="http://w4lle.com/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Flutter UI æ¸²æŸ“æµ…æï¼ˆä¸€ï¼‰æ€»è§ˆ</title>
    <link href="http://w4lle.com/2020/11/09/flutter-ui-overview/"/>
    <id>http://w4lle.com/2020/11/09/flutter-ui-overview/</id>
    <published>2020-11-09T11:43:02.000Z</published>
    <updated>2020-11-11T10:33:21.559Z</updated>
    
    <content type="html"><![CDATA[<p>Flutter UI æ¸²æŸ“ç³»åˆ—æ–‡ç« ï¼ŒåŸºäº Flutter v1.20.4</p>
<a id="more"></a>
<p>æˆ‘ä»¬çŸ¥é“å±å¹•æ˜¾ç¤ºçš„åŸºæœ¬å•ä½æ˜¯åƒç´ ï¼Œæ¯ä¸ªåƒç´ ç‚¹æ˜¾ç¤ºä¸åŒçš„é¢œè‰²å€¼ï¼ŒæŒ‰ä¸€å®šè§„åˆ™æ’åˆ—å°±å½¢æˆäº†å›¾åƒã€‚</p>
<p>æ˜¾ç¤ºå™¨æŒ‰ä¸€å®šé¢‘ç‡ä» GPU è·å–æ•°æ®ï¼Œå°±å¯ä»¥å®Œæˆå›¾åƒçš„æ›´æ–°ã€‚ç°åœ¨æ‰‹æœºå±å¹•ä¸€èˆ¬æœ‰60HZã€90HZã€120HZï¼Œä»¥60HZä¸ºä¾‹ï¼Œå±å¹•æ¯ç§’ä¼šå‘å‡º 60 ä¸ª VSync å‚ç›´åŒæ­¥ä¿¡å·ã€‚</p>
<p>VSync ä¿¡å·ç”¨äºåè°ƒæ˜¾ç¤ºå™¨ã€CPU å’Œ GPU çš„å·¥ä½œã€‚</p>
<p>GPU æ¯ç§’å¯ä»¥ç»˜åˆ¶çš„å¸§æ•°å«åšå¸§é€Ÿç‡ï¼Œå¦‚æœå¸§é€Ÿç‡å¤§äºå±å¹•åˆ·æ–°ç‡ï¼Œå±å¹•ä¸Šæ˜¾ç¤ºçš„å†…å®¹å°±æœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªå›¾åƒçš„ä¸å®Œå…¨å†…å®¹ï¼Œé€ æˆå›¾åƒæ’•è£‚ã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imageswithout_sync.png" alt=""></p>
<p>VSync å‚ç›´ä¿¡å·å¯ä»¥ä¿è¯åˆ·æ–°é¢‘ç‡çš„ç»Ÿä¸€ã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imageswith_sync.png" alt=""></p>
<p>åœ¨ VSync ä¿¡å·çš„è°ƒåº¦ä¸‹ï¼ŒUI ç³»ç»ŸæŠŠé€»è¾‘ä»£ç å˜æˆå›¾åƒæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œä¸€èˆ¬éœ€è¦ç»è¿‡ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>Viewï¼Œæ„å»º View/DOM èŠ‚ç‚¹</li>
<li>Layoutï¼Œè®¡ç®—æ ·å¼(Style)ã€å¸ƒå±€(Layout)</li>
<li>ViewTreeï¼Œå°† View èŠ‚ç‚¹æŒ‰ä¸€å®šè§„åˆ™å½’å±åˆ°ä¸åŒçš„å›¾å±‚ï¼Œæ„å»ºæˆ–æ›´æ–° ViewTree</li>
<li>Paintï¼Œç»˜åˆ¶ï¼Œè¾“å‡ºç»˜åˆ¶æŒ‡ä»¤åˆ° DisplayList</li>
<li>Rasterizationï¼Œå…‰æ …åŒ–ï¼Œæ‰§è¡Œ DisplayList ä¸­çš„ç»˜å›¾æŒ‡ä»¤ï¼Œç”Ÿæˆå›¾å±‚åŒºåŸŸçš„åƒç´ æ•°æ®</li>
<li>Compositeï¼Œåˆæˆï¼ŒæŠŠå„å›¾å±‚å…‰æ …åŒ–åçš„æ•°æ®è¿›è¡Œå åŠ å’Œç‰¹æ€§å¤„ç†ï¼Œè¾“å‡ºåˆ°å±å¹•ä¸Š</li>
</ol>
<p>ç®€å•æ¥è¯´å°±æ˜¯åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>æ„å»º UI æè¿°è§„åˆ™ï¼Œç”¨äºæ„å»ºæˆ–åˆ·æ–°å›¾åƒï¼Œå¹¶æŠŠç»˜åˆ¶æŒ‡ä»¤ä¿å­˜èµ·æ¥ç”¨äºç»˜åˆ¶ï¼Œå³ 1-4</li>
<li>å…‰æ …åŒ–å’Œåˆæˆï¼Œå¯¹ç¡¬ä»¶ç»˜åˆ¶ API åšäº†ç»Ÿä¸€å°è£…ï¼Œå±è”½åº•å±‚ç»˜åˆ¶ç»†èŠ‚ï¼Œå³ 5-6</li>
</ol>
<p>Android å’Œ iOS åŸºæœ¬éƒ½æ˜¯æŒ‰ç…§è¿™ä¸ªæµç¨‹æ¥æ„å»ºUIçš„ã€‚</p>
<p>ä»¥ Android ä¸ºä¾‹ï¼ŒAndroid é€šè¿‡ XML æ¥æè¿° UI ç»“æ„ï¼Œç”¨ DisplayList ä¿å­˜ç»˜åˆ¶æŒ‡ä»¤ä¿¡æ¯ï¼Œé€šè¿‡ Skia å°è£…åº•å±‚ç»†èŠ‚å®ç°å…‰æ …åŒ–åˆæˆã€‚</p>
<p>Flutter ä½œä¸ºä¸€æ¬¾è·¨ç«¯ UI å¼€å‘æ¡†æ¶ï¼Œå®ƒçš„æ¸²æŸ“æµç¨‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p>
<p>è¿™ä¸ªç³»åˆ—çš„æ–‡ç« ä¸»è¦åˆ†æä¸‹ Flutter UI æ¸²æŸ“æµç¨‹ï¼Œæ¶‰åŠåˆ°çš„ä¸­é—´è¿‡ç¨‹ä¼šåˆ†éƒ¨è§£æï¼ŒåŸºäº Flutter v1.20.4 ç‰ˆæœ¬æºç ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>æ€»è§ˆ</li>
<li>VSync æ³¨å†Œ</li>
<li>Animate åŠåŠ¨ç”»å®ç°åŸç†</li>
<li>Build</li>
<li>Layout</li>
<li>Paint &amp; RepaintBoundary</li>
<li>CompositeFrame</li>
<li>RasterThread å…‰æ …åŒ–åŠåˆæˆ</li>
</ol>
<h2 id="1ã€Flutter-æ¶æ„"><a href="#1ã€Flutter-æ¶æ„" class="headerlink" title="1ã€Flutter æ¶æ„"></a>1ã€Flutter æ¶æ„</h2><p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_archdiagram.png" alt=""></p>
<p>Flutter æ¶æ„åˆ†ä¸ºä¸‰å±‚ï¼šDart Frameworkã€C++ Engineã€ Platform Embedderã€‚</p>
<p>Dart Framework æä¾›äº†å“åº”å¼çš„å¼€å‘æ¡†æ¶ï¼Œä½¿ç”¨ Dart å¼€å‘ï¼Œå®ƒå¯¹æ¸²æŸ“é€»è¾‘åšäº†ç»Ÿä¸€å°è£…ï¼Œå±è”½äº†åº•å±‚å®ç°ï¼Œå¯¹åº•å±‚ C++ Engine æä¾›åŒå‘é€šä¿¡èƒ½åŠ›ï¼Œå¼€å‘è€…åªéœ€è¦ç»„åˆ Widgets ç”¨äºæ„å»º App è§†å›¾å³å¯ã€‚</p>
<ul>
<li>æœ€åº•å±‚çš„ Foundation å±‚æä¾›ä¸€äº›æœ€åŸºç¡€çš„æŠ½è±¡ç±»æˆ–å®šä¹‰ï¼ŒåŸºäºæ­¤ï¼Œ Animation åŠ¨ç”»ã€Painting ç»˜åˆ¶ã€Gestures æ‰‹åŠ¿ç­‰æ„å»ºå‡ºé€šç”¨æŠ½è±¡èƒ½åŠ›</li>
<li>Rendering å±‚ï¼Œæ„å»ºå‡ºæ¸²æŸ“æ ‘ Render Treeï¼Œä¹Ÿå³ RenderObject Treeï¼Œç”¨äºå…·ä½“ç»˜åˆ¶ï¼ŒRenderObject ä¼šè‡ªåŠ¨éšç€æ•°æ®æ”¹å˜è€ŒåŠ¨æ€æ”¹å˜</li>
<li>Widgets å±‚ï¼Œæä¾›äº†ä¸€å¥—éå¸¸ä¸°å¯Œçš„ Widget ç»„ä»¶åº“ï¼Œç”¨äºæ„å»º Widgets Tree å’Œ Element Treeï¼Œè¿™æ˜¯å“åº”å¼ç¼–ç¨‹çš„åŸºç¡€å®ç°ï¼Œæ¯ä¸€ä¸ª RenderObject éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ Widget åŠ Element</li>
<li>Materail å±‚å’Œ Cupertino å±‚ä½¿ç”¨ Widgets ç»„ä»¶åº“ï¼Œæ„å»º Android Materail æˆ–è€… iOS Cupertino é£æ ¼çš„åº”ç”¨è§†å›¾ï¼Œå¼€å‘è€…åŸºäºè¿™äº› Widgets å³å¯æ„å»ºå‡ºæ•ˆæœä¸€è‡´çš„è·¨ç«¯åº”ç”¨</li>
</ul>
<p>C++ Engine æ˜¯ Flutter çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†ä½¿ç”¨ C++ å¼€å‘ï¼Œå®ƒçš„ä¸»è¦èŒè´£æ˜¯å…‰æ …åŒ–åˆæˆä¸Šå±ç”¨äºæ˜¾ç¤ºç»˜åˆ¶å†…å®¹ï¼ŒåŒæ—¶å®ƒä¹Ÿæä¾›ä½å±‚æ¬¡çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œæ¯”å¦‚Skiaå›¾å½¢åŒ–ç»˜åˆ¶ï¼ˆgraphicsï¼‰ã€TextLayoutã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œ I/Oã€æ— éšœç¢æ”¯æŒã€æ’ä»¶ä½“ç³»ã€Dartè¿è¡Œæ—¶ï¼ˆDartVMï¼‰å’Œ GCã€ç¼–è¯‘é“¾ã€‚</p>
<p>Engine å±‚å¯¹ App å±‚æš´éœ² <code>dart:ui</code> åŒ…ï¼Œ<code>dart:ui</code> åŒ…æ˜¯ Flutter App çš„æ„å»ºåŸºç¡€ï¼Œå…¶ä¸­çš„ dart ç±»å¯¹ C++ Engine å±‚ä¸­çš„å®ç°ç±»åšäº†åŒ…è£…ï¼Œå®ƒæä¾›äº†åŸºç¡€èƒ½åŠ›ï¼Œè¯¸å¦‚äº¤äº’ç³»ç»Ÿã€å›¾å½¢å›¾åƒå¤„ç†ã€æ¸²æŸ“å­ç³»ç»Ÿç­‰ã€‚</p>
<p>å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç±»æ˜¯åŒ…ä¸‹çš„ <code>Window</code>ï¼Œå®ƒå‘ä¸Šæä¾›äº†æœ€æ ¸å¿ƒçš„ä¸€äº›æœåŠ¡ï¼Œæ¯”å¦‚ä»»åŠ¡Scheduler APIã€ç»˜åˆ¶ APIã€è¾“å…¥äº‹ä»¶å“åº”ç­‰ç­‰ã€‚</p>
<p>Platform Embedder æ˜¯å¹³å°åµŒå…¥å±‚ï¼ŒæŠŠ Flutte ä»£ç æ‰“åŒ…åµŒå…¥åˆ°å…·ä½“çš„å®ç°å¹³å°ï¼Œæä¾›è¿è¡Œå…¥å£ï¼Œå¹¶å¯¹ä¸Šå±‚æä¾›æœ€åŸºç¡€çš„èƒ½åŠ›ï¼Œæ¯”å¦‚æä¾›æ¸²æŸ“ç”»å¸ƒã€æ’ä»¶ç³»ç»Ÿã€æ— éšœç¢ã€äº¤äº’ç®¡ç†ã€æ¶ˆæ¯å¾ªç¯ç®¡ç†ç­‰ã€‚</p>
<p>Flutter åˆ†å±‚æ¶æ„ä½¿å¾—å¹³å°ç›¸å…³æ€§å¤§å¤§é™ä½ã€‚</p>
<p>Dart Framework å¯¹ä¸Šæä¾›ç»Ÿä¸€çš„åŸºäº dart çš„å“åº”å¼ UI æè¿°æ¡†æ¶ã€‚</p>
<p>C++ Engine å‘ä¸‹å¯¹ Skia ç»˜åˆ¶å¼•æ“å¯¹ä¸‹ç»Ÿä¸€å°è£…ï¼Œå±è”½äº†å¹³å°å®ç°ã€‚</p>
<p>ReactNative / Weex ä½œä¸ºè·¨ç«¯æ¡†æ¶ ï¼Œè™½ç„¶èµ°çš„ä¹Ÿæ˜¯æ˜¯åŸç”Ÿæ¸²æŸ“ï¼Œä½†æ˜¯éœ€è¦é€šè¿‡ js æ¥ç»„ç»‡å’Œæè¿° UIï¼Œä¸­é—´éœ€è¦åšä¸€å±‚è½¬æ¢ï¼Œæ‰å¯ä»¥å˜æˆåŸç”Ÿçš„ UI æè¿°ç»“æ„ï¼Œè¿›è€ŒåŸç”Ÿæ¸²æŸ“ã€‚</p>
<p>ä¸­é—´å¤šäº†ä¸€å±‚è½¬æ¢è¿‡ç¨‹ã€‚</p>
<p>è€Œ Flutter è‡ªå»ºæ¸²æŸ“å¼•æ“ï¼Œä¸ä¾èµ–å¹³å°å®ç°ï¼Œå¹¶ä¸” Dart å¯ä»¥ç›´æ¥è¢«ç¼–è¯‘æˆæœºå™¨ç ï¼Œä»æ¶æ„ä¸Šæ¥è¯´ï¼Œæ€§èƒ½ç›¸æ¯” ReactNative / Weex ä¼šæ›´å¥½ã€‚</p>
<h2 id="2ã€Flutter-æ¸²æŸ“ç®¡çº¿"><a href="#2ã€Flutter-æ¸²æŸ“ç®¡çº¿" class="headerlink" title="2ã€Flutter æ¸²æŸ“ç®¡çº¿"></a>2ã€Flutter æ¸²æŸ“ç®¡çº¿</h2><p>Flutter æ¸²æŸ“ç®¡çº¿çš„è®¾è®¡æ˜¯ç±»ä¼¼çš„ï¼Œæµç¨‹å‚è€ƒä¸‹å›¾</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_graphics_pipeline1.png" alt=""></p>
<p>é¦–å…ˆçœ‹ä¸‹ç”¨åˆ°çš„çº¿ç¨‹ï¼š</p>
<p>UIThread æ˜¯ Platform åˆ›å»ºçš„å­çº¿ç¨‹ï¼ŒDartVM Root Isolate æ‰€æœ‰çš„ dart ä»£ç éƒ½è¿è¡Œåœ¨è¯¥çº¿ç¨‹ã€‚</p>
<p>é˜»å¡UIThread ä¼šç›´æ¥å¯¼è‡´ Flutter åº”ç”¨å¡é¡¿æ‰å¸§ã€</p>
<p>RasterThread åŸæœ¬å«åš GPUThreadï¼Œä¹Ÿæ˜¯ Platform åˆ›å»ºçš„å­çº¿ç¨‹ï¼Œç”±äºå¾ˆå¤šäººè¯¯è®¤ä¸ºè¿è¡Œåœ¨ GPU ä¸Šï¼Œä½†å…¶å®å®ƒæ˜¯è¿è¡Œåœ¨ CPU  ç”¨äºå¤„ç†æ•°æ®æäº¤ç»™ GPUï¼Œæ‰€ä»¥ Flutter å›¢é˜Ÿå°†å…¶åå­—æ”¹ä¸º Rasterï¼Œè¡¨æ˜å®ƒçš„ä½œç”¨æ˜¯å…‰æ …åŒ–ã€‚</p>
<p>C++ Engine ä¸­çš„å…‰æ …åŒ–å’Œåˆæˆè¿‡ç¨‹è¿è¡Œåœ¨è¯¥çº¿ç¨‹ã€‚</p>
<p>æ•´ä¸ªæµç¨‹ä¼šç»è¿‡ä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š</p>
<ul>
<li>C++ Engine è§¦å‘ Platform æ³¨å†Œ VSync å‚ç›´ä¿¡å·å›è°ƒï¼Œé€šè¿‡ Platform -&gt; C++ Engine -&gt; Dart Framework è§¦å‘æ•´ä¸ªç»˜åˆ¶æµç¨‹</li>
<li>Dart Framework æ„å»ºå‡ºå››æ£µæ ‘ï¼ŒWidget Treeã€Element Treeã€RenderObject Treeã€Layer Treeï¼Œå¸ƒå±€ã€è®°å½•ç»˜åˆ¶åŒºåŸŸåŠç»˜åˆ¶æŒ‡ä»¤ä¿¡æ¯ç”Ÿæˆ <code>flutter::LayerTree</code>ï¼Œå¹¶ä¿å­˜åœ¨ <code>Scene</code> å¯¹è±¡ç”¨ä»¥å…‰æ …åŒ–ï¼Œè¿™ä¸ªè¿‡ç¨‹è¿è¡Œåœ¨  UIThread</li>
<li>é€šè¿‡ Flutter è‡ªå»ºå¼•æ“ Skia è¿›è¡Œå…‰æ …åŒ–å’Œåˆæˆæ“ä½œï¼Œ å°† <code>flutter::LayerTree</code> è½¬æ¢ä¸º GPU æŒ‡ä»¤ï¼Œå¹¶å‘é€ç»™ GPU å®Œæˆå…‰æ …åŒ–åˆæˆä¸Šå±æ˜¾ç¤ºæ“ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹æ‰§è¡Œåœ¨ RasterThread</li>
</ul>
<p>æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå®ƒçš„å®ç°åœ¨ Engine çš„ <code>LayerTreePipeline</code>ã€‚</p>
<p>UIThread è´Ÿè´£ç”Ÿäº§ <code>flutter::Layer Tree</code>ï¼ŒRasterThread è´Ÿè´£æ¶ˆè´¹ <code>flutter::Layer Tree</code>ã€‚</p>
<p>è¿™ç§è°ƒåº¦æœºåˆ¶å¯ä»¥ç¡®ä¿ RasterThread ä¸è‡³äºè¿‡è½½ï¼ˆ2ä¸ªä»»åŠ¡ï¼‰ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å… UIThread ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ã€‚</p>
<p>æ‰€ä»¥ä¸è®ºåœ¨ UIThread è¿˜æ˜¯åœ¨ RasterThread è€—æ—¶å¤ªä¹…ï¼Œéƒ½å¯èƒ½ä¼šå¯¼è‡´ Flutter åº”ç”¨å¡é¡¿ï¼Œå› ä¸ºä¼šå¯¼è‡´å»¶è¿Ÿæ¥å— VSync ä¿¡å·ï¼Œå¯¼è‡´æ‰å¸§ã€‚</p>
<p>è¿™ä¸ªè°ƒåº¦è¿‡ç¨‹ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¯¦ç»†åˆ†æã€‚</p>
<h2 id="3ã€Flutter-UI-ç»˜åˆ¶ç®¡çº¿"><a href="#3ã€Flutter-UI-ç»˜åˆ¶ç®¡çº¿" class="headerlink" title="3ã€Flutter UI ç»˜åˆ¶ç®¡çº¿"></a>3ã€Flutter UI ç»˜åˆ¶ç®¡çº¿</h2><p>å…¶ä¸­åœ¨ UIThread ç”Ÿæˆ Layer Tree çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸º <code>Rendering Pipeline</code> ç»˜åˆ¶ç®¡çº¿ã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_rendering_pipeline.png" alt=""></p>
<p>ä¸»è¦è¿‡ç¨‹ä¸ºï¼š</p>
<ul>
<li>Animateï¼Œè§¦å‘åŠ¨ç”»æ›´æ–°ä¸‹ä¸€å¸§çš„å€¼</li>
<li>Buildï¼Œè§¦å‘æ„å»ºæˆ–åˆ·æ–° Widget Treeã€Element Treeã€RenderObject Tree</li>
<li>Layoutï¼Œè§¦å‘å¸ƒå±€æ“ä½œï¼Œç¡®å®šå¸ƒå±€å¤§å°å’Œä½ç½®ä¿¡æ¯</li>
<li>CompositeBitsï¼Œæ›´æ–°éœ€è¦åˆæˆçš„ Layer å±‚æ ‡è®°</li>
<li>Paintï¼Œè§¦å‘ RenderObject Tree çš„ç»˜åˆ¶æ“ä½œï¼Œæ„å»º Layer Tree</li>
<li>Compositeï¼Œè§¦å‘ Layer Tree å‘é€åˆ° Engineï¼Œç”Ÿæˆ Engine LayerTree</li>
</ul>
<p>åœ¨ UIThread æ„å»ºå‡ºå››æ£µæ ‘ï¼Œå¹¶åœ¨ Engine ç”Ÿæˆ Sceneï¼Œæœ€åæäº¤ç»™ RasterThreadï¼Œå¯¹ LayerTree åšå…‰æ …åŒ–åˆæˆä¸Šå±ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†æä¸‹ VSync æ³¨å†Œã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://zhuanlan.zhihu.com/p/78758247" target="_blank" rel="external">æ¸²æŸ“æµæ°´çº¿ä¸­çš„å…‰æ …åŒ–ï¼ˆä¸€ï¼‰</a></p>
<p><a href="https://developer.aliyun.com/article/770384" target="_blank" rel="external">ä»æ¶æ„åˆ°æºç ï¼šä¸€æ–‡äº†è§£Flutteræ¸²æŸ“æœºåˆ¶</a></p>
<p><a href="http://gityuan.com/2019/06/15/flutter_ui_draw/" target="_blank" rel="external">Flutteræ¸²æŸ“æœºåˆ¶â€”UIçº¿ç¨‹</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2020/11/09/flutter-ui-overview/">http://w4lle.com/2020/11/09/flutter-ui-overview/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flutter UI æ¸²æŸ“ç³»åˆ—æ–‡ç« ï¼ŒåŸºäº Flutter v1.20.4&lt;/p&gt;
    
    </summary>
    
    
      <category term="Flutter" scheme="http://w4lle.com/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Flutter å·¥ç¨‹æ¶æ„</title>
    <link href="http://w4lle.com/2019/11/23/flutter-project-manage/"/>
    <id>http://w4lle.com/2019/11/23/flutter-project-manage/</id>
    <published>2019-11-23T14:11:04.000Z</published>
    <updated>2019-11-24T03:41:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦ä»‹ç»Androidè§†è§’ä¸‹åœ¨å·²æœ‰ App ä¸­åµŒå…¥ Flutter åº”ç”¨çš„å®è·µï¼ŒiOS çš„æ–¹æ¡ˆæ€è·¯åŸºæœ¬ä¸€è‡´ã€‚</p>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://w4lle.com/2019/11/22/flutter-hybrid-stack/">Flutter æ··åˆæ ˆç®¡ç†</a></li>
<li><a href="http://w4lle.com/2019/11/23/flutter-project-manage/">Flutter å·¥ç¨‹æ¶æ„</a></li>
</ul>
<h1 id="Flutter-å·¥ç¨‹ç±»å‹"><a href="#Flutter-å·¥ç¨‹ç±»å‹" class="headerlink" title="Flutter å·¥ç¨‹ç±»å‹"></a>Flutter å·¥ç¨‹ç±»å‹</h1><p>Flutterå·¥ç¨‹ä¸­ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§å·¥ç¨‹ç±»å‹ï¼Œä¸‹é¢åˆ†åˆ«ç®€å•æ¦‚è¿°ä¸‹ï¼š</p>
<p><strong>1. Flutter Application</strong></p>
<p>â€‹    çº¯å‡€çš„Flutter Appå·¥ç¨‹ï¼ŒåŒ…å«æ ‡å‡†çš„Dartå±‚ä¸Nativeå¹³å°å±‚(android/&amp;ios/)</p>
<p><strong>2. Flutter Module</strong></p>
<p>â€‹    Flutteræ¨¡å—å·¥ç¨‹ï¼Œä»…åŒ…å«Dartå±‚å®ç°ï¼ŒNativeå¹³å°å­å·¥ç¨‹çš„ä½œç”¨æ˜¯æ„å»ºFlutteräº§ç‰©ï¼Œæ˜¯é€šè¿‡Flutterè‡ªåŠ¨ç”Ÿæˆçš„éšè—å·¥ç¨‹ï¼ˆ.android/&amp;.ios/ï¼‰</p>
<p><strong>3. Flutter Plugin</strong></p>
<p>â€‹    Flutterå¹³å°æ’ä»¶å·¥ç¨‹ï¼ŒåŒ…å«Dartå±‚ä¸Nativeå¹³å°å±‚çš„å®ç°(android/&amp;ios/)ï¼Œå¾€å¤–æä¾›APIæ¥å£</p>
<p><strong>4. Flutter Package</strong></p>
<p>â€‹    Flutterçº¯Dartæ’ä»¶å·¥ç¨‹ï¼Œä»…åŒ…å«Dartå±‚çš„å®ç°ï¼Œå¾€å¾€å®šä¹‰ä¸€äº›å…¬å…±Widget</p>
<p>æ¥å…¥Flutterå·¥ç¨‹çš„ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>æºç é›†æˆï¼Œåœ¨åŸç”Ÿé¡¹ç›®ä¸­Flutterä½œä¸ºlibç›´æ¥åµŒå…¥Flutterä»£ç ï¼Œç¼–è¯‘è¿‡ç¨‹éœ€è¦ä¾èµ–Flutterç¯å¢ƒï¼Œæ¯ä¸ªå¼€å‘éƒ½éœ€è¦é…ç½®Flutterå¼€å‘ç¯å¢ƒï¼Œé€‚åˆå…¨æ–°é¡¹ç›®</li>
<li>Flutteré¡¹ç›®ä½œä¸ºå­é¡¹ç›®moduleï¼Œç”Ÿæˆaaråç”±åŸç”ŸAppä¾èµ–ï¼Œå¯¹äºAppæ¥è¯´å±è”½äº†Flutterå¼€å‘ç¯å¢ƒï¼Œåœ¨åŸæœ‰ç¯å¢ƒä¸­å³å¯æ‰“åŒ…ï¼Œå¯¹Appå¼€å‘æ¥è¯´å±è”½äº†Flutterç¯å¢ƒï¼Œé€‚åˆå·²ç»AppåµŒå…¥Flutteråº”ç”¨</li>
</ol>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»ç¬¬äºŒç§æ–¹å¼ï¼Œç”±äºFlutterå®˜æ–¹å¹¶æœªæä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥æ¥å…¥è¿‡ç¨‹ä¸­ä¼šç¢°åˆ°ä¸€äº›é—®é¢˜ï¼Œè¿™é‡Œç»™å‡ºä¸€äº›è§£å†³æ€è·¯ä¾›å‚è€ƒã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªflutter moduleï¼š</p>
<p>flutter create -t module â€“org com.example my_flutter</p>
<p>å·¥ç¨‹ç»“æ„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesD099FCC6-82A2-4170-A8A1-43C90F44CB65.png" alt=""></p>
<h1 id="FlutterModule-æ„å»º-Aar"><a href="#FlutterModule-æ„å»º-Aar" class="headerlink" title="FlutterModule æ„å»º Aar"></a>FlutterModule æ„å»º Aar</h1><p>flutter build aar</p>
<p>ä½†æ˜¯è¿™ä¸ªå‘½ä»¤åœ¨Flutter v1.7.8ç‰ˆæœ¬ä¸­ä¼šæç¤ºæ‰¾ä¸åˆ°è¿™ä¸ªå‘½ä»¤ï¼Œä¼°è®¡æ˜¯devç‰ˆæœ¬æ–°åŠ å…¥çš„ï¼Œè¿˜æ²¡æœ‰stableã€‚</p>
<p>ä¸ä¹…å‰åŠ å…¥çš„ <a href="https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps/_compare/1f606754ee0b18d9970e5fdd7b14d8a6df8d2d72...d648f6b063a0ab7ad4eaf0546e90b1cc75b9d58b" target="_blank" rel="external">https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps/_compare/1f606754ee0b18d9970e5fdd7b14d8a6df8d2d72...d648f6b063a0ab7ad4eaf0546e90b1cc75b9d58b</a></p>
<p>å³ä½¿æ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨./gradlew assembleDebugè¿›è¡Œç¼–è¯‘ï¼Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>å¦‚æœä½¿ç”¨flutter build aarå‘½ä»¤ï¼ŒFlutterå®˜æ–¹ç»™å‡ºçš„ç»“æœæ˜¯ï¼Œæœ¬åœ°ä½œä¸ºlocalmavenï¼Œç”Ÿæˆçš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">build/host/outputs/repo</div><div class="line"></div><div class="line">â””â”€â”€ com</div><div class="line"></div><div class="line">â””â”€â”€ example</div><div class="line"></div><div class="line">â””â”€â”€ my_flutter</div><div class="line"></div><div class="line">â””â”€â”€ flutter_release</div><div class="line"></div><div class="line">â”œâ”€â”€ 1.0</div><div class="line"></div><div class="line">â”‚   â”œâ”€â”€ flutter_release-1.0.aar</div><div class="line"></div><div class="line">â”‚   â”œâ”€â”€ flutter_release-1.0.aar.md5</div><div class="line"></div><div class="line">â”‚   â”œâ”€â”€ flutter_release-1.0.aar.sha1</div><div class="line"></div><div class="line">â”‚   â”œâ”€â”€ flutter_release-1.0.pom</div><div class="line"></div><div class="line">â”‚   â”œâ”€â”€ flutter_release-1.0.pom.md5</div><div class="line"></div><div class="line">â”‚   â””â”€â”€ flutter_release-1.0.pom.sha1</div><div class="line"></div><div class="line">â”œâ”€â”€ maven-metadata.xml</div><div class="line"></div><div class="line">â”œâ”€â”€ maven-metadata.xml.md5</div><div class="line"></div><div class="line">â””â”€â”€ maven-metadata.xml.sha1</div></pre></td></tr></table></figure>
<p>Flutter v1.2ç‰ˆæœ¬ä¹‹åFlutteräº§ç‰©è‡ªåŠ¨ä¼šæ‰“åŒ…åˆ°aarä¸­ï¼Œå…·ä½“è„šæœ¬è§ flutter.gradleï¼Œä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>é€‰æ‹©ç¬¦åˆå¯¹åº”æ¶æ„çš„Flutterå¼•æ“ï¼ˆflutter.soï¼‰</li>
<li>è§£æ .flutter-pluginsæ–‡ä»¶ï¼ŒæŠŠFlutterå¯¹åº”çš„android moduleåŠ¨æ€æ·»åŠ åˆ°Nativeå·¥ç¨‹çš„ä¾èµ–ä¸­ï¼Œå³åŠ¨æ€æ·»åŠ implementationä¾èµ–ï¼Œè¿™å—åé¢ä¼šè¯¦ç»†è®²</li>
<li>Hook mergeAssets/processResources Taskï¼Œé¢„å…ˆæ‰§è¡ŒFlutterTaskï¼Œè°ƒç”¨flutterå‘½ä»¤ç¼–è¯‘Dartå±‚ä»£ç æ„å»ºå‡ºflutter_assetsäº§ç‰©ï¼Œå¹¶æ‹·è´åˆ°assetsç›®å½•ä¸‹</li>
</ol>
<p>åŸºäºFlutter v1.7.8ï¼Œç¼–è¯‘äº§ç‰© Debugç‰ˆæœ¬</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images0517FC2D-73DC-4597-A471-8F87E51420B0.png" alt=""></p>
<p>Releaseç‰ˆæœ¬ </p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesCB70BFBA-A021-4D0C-9614-395D366BF292.png" alt=""></p>
<p>åœ¨Flutter v1.7ä¹‹å‰ï¼ŒReleaseçš„äº§ç‰©å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagese21cd2440bca39a70b30abedaaba4e3be5e090e4.png" alt=""></p>
<p>ä¹Ÿå°±æ˜¯è¯´Flutterçš„ç¼–è¯‘äº§ç‰©ï¼Œ<strong>ä»å››ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å˜æˆäº†ä¸€ä¸ª libapp.so æ–‡ä»¶</strong>ã€‚</p>
<p>è¿™é‡Œä¹Ÿæ¶‰åŠåˆ°soå…¼å®¹armçš„é—®é¢˜ï¼Œä¹‹å‰æŠŠlibflutter.soæ‹·è´åˆ°armç›®å½•ä¸‹å³å¯ï¼Œç°åœ¨ç¼–è¯‘å‡ºçš„libapp.soæ‹·è´è¿‡å»æ˜¯æœ‰é—®é¢˜çš„ï¼Œè§£å†³åŠæ³•å¯ä»¥å‚è€ƒ <a href="https://github.com/lizhangqu/plugin-flutter-armeabi" target="_blank" rel="external">è¿™ä¸ªé¡¹ç›®</a>ã€‚</p>
<p>å¦‚æœåœ¨Flutter module ä¸­ä¾èµ–äº†Flutter Pluginï¼Œé‚£ä¹ˆåœ¨Appä¸­ä¾èµ–Flutter moduleç¼–è¯‘å‡ºçš„aaræ—¶ï¼Œä¼šæŠ¥é”™ï¼Œä¾‹å¦‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ERROR: Unable to resolve dependency <span class="keyword">for</span> <span class="string">':app@debug/compileClasspath'</span>: Could not resolve io.flutter.plugins.sharedpreferences:shared_preferences:<span class="number">1.0</span>-SNAPSHOT. </div><div class="line"></div><div class="line">Show Details</div><div class="line"></div><div class="line">Affected Modules: app</div></pre></td></tr></table></figure>
<p>ä¸‹é¢ä¼šåˆ†æä¸‹ä¸ºä»€ä¹ˆä¼šæŠ¥é”™ã€‚</p>
<h1 id="Flutter-Pluginä¾èµ–åŸç†"><a href="#Flutter-Pluginä¾èµ–åŸç†" class="headerlink" title="Flutter Pluginä¾èµ–åŸç†"></a>Flutter Pluginä¾èµ–åŸç†</h1><p>ä»¥Flutter Moduleä¸ºä¾‹ï¼Œçœ‹ä¸‹Flutter Pluginä¾èµ–çš„åŸç†ã€‚</p>
<h2 id="flutter-package-get"><a href="#flutter-package-get" class="headerlink" title="flutter package get"></a>flutter package get</h2><p>å½“Flutter Moduleåœ¨pubä¸­ä¾èµ–äº†Flutter Pluginï¼Œå¹¶ä¸”åœ¨ flutter package getåï¼Œä¼šä»è¿œç¨‹pubserveræ‹‰å–ä¾èµ–çš„Flutter Pluginï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶è®°å½•ä¾èµ–äº†å“ªäº›Flutter Pluginï¼Œåå­—ä¸ºï¼š <code>.flutter-plugins</code>ï¼Œå†…å®¹ä¸º k-vï¼Œå¦‚ï¼š</p>
<p><code>flutter_webview_plugin=/Users/wanglinglong/Develop/flutter/.pub-cache/hosted/pub.flutter-io.cn/flutter_webview_plugin-0.3.5/</code></p>
<p>è¢«æ‹‰å–åˆ°æœ¬åœ°åçš„Flutter Pluginç›®å½•å¦‚ä¸‹</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesimage2019-8-6%2011-51-21.png" alt=""></p>
<h2 id="åŠ¨æ€ä¾èµ–"><a href="#åŠ¨æ€ä¾èµ–" class="headerlink" title="åŠ¨æ€ä¾èµ–"></a>åŠ¨æ€ä¾èµ–</h2><p>ç„¶ååœ¨.android/app/settings.gradle æ–‡ä»¶ä¸­æ·»åŠ é…ç½®è„šæœ¬ï¼Œä½¿å…¶åœ¨Gradleåˆå§‹åŒ–ä¹‹åæ‰§è¡Œè§£ææ“ä½œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rootProject.name = <span class="string">'android_generated'</span></div><div class="line">setBinding(<span class="keyword">new</span> Binding([gradle: <span class="keyword">this</span>]))</div><div class="line">evaluate(<span class="keyword">new</span> File(settingsDir, <span class="string">'include_flutter.groovy'</span>))</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesimage2019-8-2%2015-19-48.png" alt=""></p>
<p>è¿™ä¸ªè„šæœ¬çš„ä½œç”¨æ˜¯æ§åˆ¶é…ç½®(evaluate)é¡ºåºï¼Œæ“ä½œæ˜¯è§£æ.flutter-pluginsï¼Œå¾—åˆ°å„ä¸ªæ’ä»¶çš„androidå·¥ç¨‹ï¼Œä½¿å…¶åœ¨.android/Flutter é…ç½®å®Œæˆä¹‹åå†è¿›è¡Œé…ç½®è§£æã€‚Gradleé…ç½®é˜¶æ®µçš„ç›®æ ‡æ˜¯è§£ææ¯ä¸ªprojectä¸­çš„build.gradleã€‚</p>
<p>ç„¶ååœ¨.android/Flutter/build.gradleä¸­ä¾èµ– </p>
<p><code>apply from: &quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</code></p>
<p>è¿™ä¸ªæ–‡ä»¶ä¸­åŒæ ·è§£æ.flutter-pluginsæ–‡ä»¶ï¼Œéå†åä¸€ä¸ªä¸€ä¸ª implementation åˆ°./android/Flutter moduleå·¥ç¨‹é‡Œå®Œæˆä¾èµ–ã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesimage2019-8-2%2015-22-42.png" alt=""></p>
<p>æ‰€ä»¥åœ¨Nativeå±‚é¢æ¥çœ‹è¿™ç§ä¾èµ–å…¶å®æ˜¯æœ¬åœ°ä¾èµ–ï¼Œåªä¸è¿‡Flutter Pluginå·¥ç¨‹è·¯å¾„éƒ½åœ¨Flutterçš„ç¯å¢ƒå˜é‡ä¸‹çš„ç¼“å­˜ç›®å½•ä¸­ã€‚ç•™ä¸ªæ€è€ƒé¢˜ï¼Œè¿™é‡Œç”¨ <code>api</code> ä»£æ›¿ <code>implementation</code> è¡Œä¸è¡Œï¼Ÿ</p>
<p>è¿™é‡Œçš„ä¾èµ–åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯åŸç”ŸNativeä¾èµ–ï¼Œä¸€éƒ¨åˆ†æ˜¯Dartä¾èµ–ã€‚</p>
<p>å¯¹äºåŸç”Ÿéƒ¨åˆ†ï¼ŒFlutter Pluginä½œä¸ºlibè¢«Flutter Moduleæœ¬åœ°ä¾èµ–ï¼Œæ ¹æ®Android ç¼–è¯‘å¸¸è¯†ï¼Œåœ¨æ‰“åŒ…Aaråï¼Œè¿™äº›<strong>æœ¬åœ°ä¾èµ–çš„å·¥ç¨‹libä¸èƒ½è¢«ä¸€èµ·æ‰“åˆ°Aarä¸­</strong>ã€‚</p>
<p>æ‰€ä»¥å½“Appä¸­ä¾èµ–Flutter Moduleçš„äº§ç‰©Aaræ—¶ï¼Œä¸èƒ½è·å¾—Flutter Module ä¸­ä¾èµ–çš„Flutter Plugin AndroidåŸç”Ÿä¾èµ–ï¼Œæœ€ç»ˆä¼šæŠ¥é”™ã€‚</p>
<p>å¯¹äºDartéƒ¨åˆ†ï¼Œé€šè¿‡pubè¿›è¡Œç®¡ç†ä¾èµ–ï¼Œç›¸å½“äºæºç ä¾èµ–ï¼Œåœ¨æ‰“åŒ…æ—¶ï¼Œè¿™äº›Pluginçš„Dartæºç éƒ¨åˆ†éƒ½å‚ä¸æ‰“åŒ…ï¼Œæœ€ç»ˆç”ŸæˆFlutterçš„æ„å»ºäº§ç‰©ã€‚</p>
<p>Flutter Moduleæ‰“åŒ…æˆAaråï¼ŒAarä¸­åŒ…å«AndroidåŸç”Ÿéƒ¨åˆ†ç¼–è¯‘äº§ç‰©å’ŒFlutter Dartéƒ¨åˆ†ç¼–è¯‘äº§ç‰©ï¼Œåé¢Appä¾èµ–è¯¥Aaråå°±å¯ä»¥è„±ç¦»Flutterçš„ç¼–è¯‘ç¯å¢ƒï¼Œç›´æ¥è¿›è¡Œapkæ‰“åŒ…äº†ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³AaræŠ¥é”™çš„é—®é¢˜ï¼Ÿ</p>
<h1 id="Flutter-module-ä¾èµ–-Flutter-Plugin"><a href="#Flutter-module-ä¾èµ–-Flutter-Plugin" class="headerlink" title="Flutter module ä¾èµ– Flutter Plugin"></a>Flutter module ä¾èµ– Flutter Plugin</h1><p>å·²æœ‰æ–¹æ¡ˆå¤§è‡´åŸç†éƒ½æ˜¯æ”¶é›†Flutter Plugin çš„Aaræ–‡ä»¶ï¼Œç„¶åè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<p><strong>æ–¹æ¡ˆä¸€ï¼š</strong></p>
<p>ä½¿ç”¨ fat-aarï¼Œå¤§è‡´åŸç†å°±æ˜¯å°†æ‰€æœ‰çš„Flutter Pluginæ‰“åŒ…åˆ°åŒä¸€ä¸ªAarä¸­ï¼Œè¿™ä¸ªæ–¹æ¡ˆæ¯”è¾ƒè‡ƒè‚¿ï¼Œè¿˜å¯èƒ½æ¶‰åŠåˆ°gradleç‰ˆæœ¬é€‚é…ï¼Œè€Œä¸”å¯èƒ½äº§ç”Ÿå¤šæ¬¡ä¾èµ–çš„é—®é¢˜ã€‚ä¸å»ºè®®ä½¿ç”¨ã€‚</p>
<p><strong>æ–¹æ¡ˆäºŒï¼š</strong></p>
<p>éå†æ‰€æœ‰ä¾èµ–çš„Flutter Pluginï¼Œæœé›†Plugin Androidå·¥ç¨‹ä¸‹çš„Aaräº§ç‰©å¹¶copyåˆ°Flutter ModuleæŒ‡å®šç›®å½•ä¸‹ï¼Œç„¶åå†push mavenã€‚</p>
<p><strong>æ–¹æ¡ˆä¸‰ï¼š</strong></p>
<p>éå†æ‰€æœ‰ä¾èµ–çš„Flutter Pluginï¼Œæ ¹æ®Pluginç‰ˆæœ¬ä¿¡æ¯ï¼ŒæŒ¨ä¸ªæ‰“åŒ…æˆä¸Šä¼ åˆ°mavenã€‚</p>
<p>ç”±äºå…¬å¸å†…ä¹‹å‰ç¢°åˆ°åˆ°ç›¸å…³éœ€æ±‚åœºæ™¯ï¼Œå³åŒä¸€å·¥ç¨‹ä¸‹å¤šä¸ªModuleå¦‚ä½•ç»Ÿä¸€ç®¡ç†çš„é—®é¢˜ï¼Œæœ€åè§£å†³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨çš„æ–¹æ¡ˆä¸‰ï¼Œè¿™é‡Œä¾ç„¶é‡‡ç”¨æ–¹æ¡ˆä¸‰ï¼Œç›¸æ¯”å…¶ä»–ä¸¤ç§æ–¹æ¡ˆæ›´ç¨³å®šã€‚</p>
<p>iOS æ€è·¯ç›¸åŒï¼Œæ‰“åŒ…æˆframeworkåä¸Šä¼ åˆ°CDNï¼Œé€šè¿‡Podè¿›è¡Œä¾èµ–ç®¡ç†ã€‚</p>
<p>çœ‹ä¸‹å®ç°ï¼š</p>
<p>é¦–å…ˆåœ¨.andorid/Flutter/build.gradleä¸­ä¾èµ–è„šæœ¬ <code>apply from: &#39;./publish_flutter_plugin.gradle&#39;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">def flutterUpload = gradle.rootProject.project(<span class="string">':flutter'</span>).tasks.getByName(uploadTaskName)</div><div class="line">gradle.rootProject.ext.pluginList.each &#123; name -&gt;</div><div class="line">    project.afterEvaluate &#123;</div><div class="line">        project.apply plugin: <span class="string">'com.u51.publish'</span></div><div class="line">        <span class="comment">// ä¿®æ”¹æ’ä»¶åº“å¯¹æ’ä»¶åº“çš„æœ¬åœ°ä¾èµ–ä¸ºpomä¾</span></div><div class="line">        modifyPom &#123; pom -&gt;</div><div class="line">            pom.dependencies.findAll &#123; dep -&gt;</div><div class="line">                <span class="keyword">if</span> (rootProject.ext.pluginList.contains(dep.artifactId)) &#123;</div><div class="line">                    dep.groupId = rootProject.ext.groupId</div><div class="line">                    dep.version = rootProject.ext.pluginMap[dep.artifactId]</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾å®šæ’ä»¶æœ¬åœ°åº“å‘å¸ƒåæ ‡ç‰ˆæœ¬å·</span></div><div class="line">        project.publish &#123;</div><div class="line">            groupId rootProject.ext.groupId</div><div class="line">            version rootProject.ext.pluginMap[name]</div><div class="line">            artifactId name</div><div class="line">            compileEnvCheck <span class="keyword">false</span></div><div class="line">            sources <span class="keyword">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// flutteråº“ uploadåœ¨æ’ä»¶æœ¬åœ°åº“å‡uploadå®Œæˆå</span></div><div class="line">        <span class="keyword">if</span> (pluginUploadTask != <span class="keyword">null</span>&amp;&amp;node==<span class="keyword">null</span>) &#123;</div><div class="line">            flutterUpload.dependsOn(pluginUploadTask)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦å¤–è¿™ç§æ–¹æ¡ˆå…¼å®¹æŒç»­é›†æˆç¯å¢ƒï¼Œå¯¹äºNativeå±‚é¢æ¥è®²ï¼Œæ— éœ€åšä»»ä½•æ”¹åŠ¨ã€‚</p>
<h1 id="Flutter-Plugin-ä¾èµ–-Flutter-Plugin"><a href="#Flutter-Plugin-ä¾èµ–-Flutter-Plugin" class="headerlink" title="Flutter Plugin ä¾èµ– Flutter Plugin"></a>Flutter Plugin ä¾èµ– Flutter Plugin</h1><p>ä¸Šé¢æåˆ°çš„æ˜¯Flutter moduleä¾èµ–Flutter Pluginçš„æƒ…å†µï¼Œé‚£ä¹ˆå¦‚æœæ˜¯Flutter Pluginå·¥ç¨‹ä¾èµ–Flutter Pluginå·¥ç¨‹æœ‰æ²¡æœ‰é—®é¢˜ï¼Ÿ</p>
<p>å…ˆçœ‹ä¸‹Flutter Pluginçš„é¡¹ç›®ç»“æ„ <code>flutter create --template=plugin -i swift -a kotlin flutter_plugin</code></p>
<p>åœ¨exampleä¸‹è¿è¡Œ flutter runå‘½ä»¤ï¼Œå°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚</p>
<p>çœ‹ä¸‹ç¼–è¯‘äº§ç‰©ï¼Œå…¶ä¸­Aarä¸­åªæœ‰åŸç”Ÿçš„ç¼–è¯‘äº§ç‰©ï¼Œå¹¶æ— Dartç¼–è¯‘äº§ç‰©ã€‚</p>
<p>æ‰€ä»¥Flutter Pluginéœ€è¦è¢«pubä¾èµ–ï¼Œpubå°†å‘å¸ƒåˆ°è¿œç¨‹çš„åº“ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶ååœ¨å·¥ç¨‹ä¸­</p>
<ul>
<li>åŸç”Ÿéƒ¨åˆ†ï¼ŒFlutter Moduleé€šè¿‡ä¸Šè¿°æ–¹æ¡ˆåŠ¨æ€æ·»åŠ maven ä¾èµ–</li>
<li>Dartéƒ¨åˆ†ï¼ŒFlutter Moduleé€šè¿‡pubä¾èµ–æ‰¾åˆ°Dartæºç ï¼Œåœ¨Flutter Moduleä¸­importå¼•å…¥ï¼Œç›¸å½“äºæºç ä¾èµ–ï¼Œå…±åŒå‚ä¸ç¼–è¯‘ï¼Œç”Ÿæˆæœ€ç»ˆçš„ Dartäº§ç‰©</li>
</ul>
<p>ä¸Šé¢çš„åœºæ™¯éƒ½æ˜¯Flutter Module(Flutter Application)ä¾èµ–Flutter Pluginçš„æƒ…å†µï¼Œé‚£ä¹ˆFlutter Pluginèƒ½ä¸èƒ½ä¾èµ–Flutter Pluginï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</p>
<p>é¦–å…ˆDartéƒ¨åˆ†ç”±äºæ˜¯pubä¾èµ–ï¼Œç›¸å½“äºæºç ä¾èµ–ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
<p>åŸç”Ÿéƒ¨åˆ†ï¼Œç”±äºFlutter Pluginåœ¨åŸç”Ÿéƒ¨åˆ†æ²¡æœ‰å¼•å…¥include_flutter.groovy(Android)ï¼Œæ‰€ä»¥å®¿ä¸»Flutter Puginæ— æ³•åŠ¨æ€includeåˆ°å­Flutter Pluginï¼Œæ‰¾ä¸åˆ°ä¾èµ–ã€‚</p>
<p>è§£å†³åŠæ³•å°±æ˜¯å†ç»™å®ƒåŠ ä¸Šï¼Œæ–¹æ³•åŒä¸Šã€‚</p>
<h1 id="å·¥ç¨‹ç»“æ„"><a href="#å·¥ç¨‹ç»“æ„" class="headerlink" title="å·¥ç¨‹ç»“æ„"></a>å·¥ç¨‹ç»“æ„</h1><p>æ€»ç»“æ¥è¯´ï¼Œå¯¹äº Flutter æ¥è®²åªæœ‰ Flutter Module å’Œ Flutter Applicationç¼–è¯‘ä¼šç”ŸæˆDartç¼–è¯‘äº§ç‰©ï¼Œè€ŒFlutter Applicationæˆ‘ä»¬åŸºæœ¬ä¸ç”¨è€ƒè™‘ã€‚</p>
<p>æ‰€ä»¥å¾ˆè‡ªç„¶çš„å¾—å‡ºç»“è®ºï¼Œæˆ‘ä»¬å¯ä»¥æŠŠFlutter Moduleä½œä¸ºéš”ç¦»å±‚ï¼Œä½œä¸ºFlutterå±‚çš„èšåˆç»Ÿä¸€è¾“å‡ºç»™ Appï¼ŒApp å·¥ç¨‹åªéœ€é€šè¿‡ maven or Pod ä¾èµ–Flutter Moduleå³å¯ã€‚</p>
<p>å…¶ä½™çš„Flutterç›¸å…³ä¾èµ–æ“ä½œéƒ½äº¤ç»™Flutter Moduleï¼Œé€šè¿‡Pubè¿›è¡Œç®¡ç†å³å¯ã€‚</p>
<p>è¿™æ ·é€šè¿‡è‹¥å¹²ä¸ªç‹¬ç«‹å·¥ç¨‹ Flutter Moduleã€Appã€Flutter Pluginï¼Œå°±æŠŠæ•´ä¸ªæ„å»ºæµç¨‹å»ºç«‹èµ·æ¥äº†ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥çš„ï¼Œå¦‚æœä¸šåŠ¡éœ€è¦ï¼Œå¯ä»¥åœ¨Flutterå±‚è¿›è¡Œæ›´ç»†åŒ–çš„åˆ’åˆ†ï¼ŒæŠŠNativeç»„ä»¶åŒ–çš„æ€è·¯å¯¹åº”åˆ°Flutterå±‚ã€‚</p>
<p>æ¯ä¸ªFlutter Pluginå¯ä»¥ä½œä¸ºç‹¬ç«‹çš„ä¸šåŠ¡æ¨¡å—æˆ–åŸºç¡€ç»„ä»¶ï¼Œä¸šåŠ¡ç»„ä»¶å‘ä¸‹ä¾èµ–åŸºç¡€ç»„ä»¶ï¼Œåœ¨æ‰“åŒ…æ—¶é€šè¿‡Pubä¼ é€’ä¾èµ–ä¸€èµ·å‚ä¸æ‰“åŒ…ã€‚</p>
<p>æˆ‘ä»¬æœŸæœ›ä¸šåŠ¡ç»„ä»¶ä¹‹é—´ä¸äº’ç›¸ä¾èµ–ï¼Œå°±åƒä¹‹å‰çš„æ–‡ç«  <a href="http://w4lle.com/2018/11/16/51credit-android-architecture/">51ä¿¡ç”¨å¡ Android æ¶æ„æ¼”è¿›å®è·µ</a> ä¸­è®²çš„é‚£æ ·ï¼Œä¸šåŠ¡ç»„ä»¶ä¸äº’ç›¸ä¾èµ–åªæ˜¯çº¦å®šï¼Œä½†ä¸æ˜¯å¼ºåˆ¶çº¦æŸï¼Œæ‰€ä»¥è¦é€šè¿‡ä¸€äº›æ‰‹æ®µè¾¾åˆ°å¼ºåˆ¶çº¦æŸçš„ç›®çš„ï¼Œç”±äºæ¶æ„è¿˜æ²¡æœ‰æ¼”è¿›åˆ°è¿™ä¸€æ­¥ï¼Œæ‰€ä»¥æ²¡è¿˜æ²¡æœ‰è°ƒç ”æ–¹æ¡ˆï¼Œåé¢æœ‰éœ€è¦å†ç ”ç©¶ã€‚</p>
<p>å¦å¤–è¿˜æœ‰æŒç»­é›†æˆ Flutter ç¯å¢ƒæ€ä¹ˆé…ç½®ï¼Ÿ</p>
<p>ä»¥åŠFlutterç‰ˆæœ¬ç®¡ç†çš„é—®é¢˜ï¼ŒFlutterç‰ˆæœ¬å‡çº§APIå¯èƒ½æœ‰å˜åŠ¨ï¼Œæ€ä¹ˆä¿è¯å¼€å‘åŒå­¦ä½¿ç”¨åŒä¸€ç‰ˆæœ¬çš„Flutterï¼Ÿ</p>
<p>å‚è€ƒä¸»æµæ–¹æ¡ˆä½¿ç”¨flutterwè¿›è¡Œç®¡ç†ï¼Œä¸è¯¦ç»†é˜è¿°ã€‚</p>
<p>æ•´ä½“ç»“æ„å€Ÿç”¨ä¸€å¼ å›¾</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_hybrid_arch.jpg" alt=""></p>
<h2 id="Pub-ç§æœ"><a href="#Pub-ç§æœ" class="headerlink" title="Pub ç§æœ"></a>Pub ç§æœ</h2><p>å‚è€ƒ <a href="https://github.com/dart-lang/pub_server" target="_blank" rel="external">pub_server</a> æ­å»ºç§æœã€‚</p>
<h1 id="å·¥ç¨‹æ¨¡æ¿"><a href="#å·¥ç¨‹æ¨¡æ¿" class="headerlink" title="å·¥ç¨‹æ¨¡æ¿"></a>å·¥ç¨‹æ¨¡æ¿</h1><p>å½“ä¾ç…§ä¸Šé¢çš„æ€è·¯æ„‰å¿«çš„å¼€å‘æ—¶ï¼Œä¼šå‘ç°å½“è§¦å‘<code>flutter package get</code> å‘½ä»¤ï¼Œ.android/&amp;.ios/ ç›®å½•å°±éƒ½è¢«è¿˜åŸäº†ï¼Œé‡Œé¢çš„ä¿®æ”¹éƒ½è¢«åˆ é™¤äº†ã€‚</p>
<p>è¿™æ®µæ“ä½œåœ¨ flutter_tools ä¸­è¿›è¡Œï¼Œå®˜æ–¹è¿™ä¹ˆåšçš„ç›®çš„å¯èƒ½æ˜¯ä¸å¸Œæœ›å¼€å‘è€…ç›´æ¥ä¿®æ”¹.android&amp;.ios/ç›®å½•ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªç›®å½•ä»…ä»…æ˜¯å‚ä¸ç¼–è¯‘çš„ä¸­é—´è¿‡æ¸¡ã€‚</p>
<p>è€Œé€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œè¿™ä¸¤ä¸ªç›®å½•æ˜¯ä¸€å®šè¦ä¿®æ”¹çš„ï¼Œä¸ç„¶è·‘ä¸èµ·æ¥ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸Šé¢æåˆ°è¿œç¨‹ä¾èµ–å’Œæœ¬åœ°ä¾èµ–åˆ‡æ¢ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­é€‰æ‹©æœ¬åœ°ä¾èµ–è¿›è¡Œæ‰“åŒ…ï¼Œæ­¤æ—¶Flutteræ˜¯è·‘åœ¨Appä¸­çš„ï¼Œéœ€è¦è°ƒè¯•æ—¶å‘ç°æ²¡æœ‰å…¥å£ã€‚</p>
<p>è¿™é‡Œå¯ä»¥é€šè¿‡åœ¨Flutter Module ä¸­ <code>flutter attach</code>ï¼Œç„¶åé‡å¯Appå°±å¯ä»¥è¿ä¸ŠFlutterçš„è°ƒè¯•æœåŠ¡ï¼Œæ‰å¯ä»¥ä½¿ç”¨hot reloadçš„åŠŸèƒ½ï¼Œä½†æ˜¯æ•´ä¸ªæµç¨‹è¿˜æ˜¯å¾ˆé•¿ï¼Œå¹¶ä¸”hot reloadå¹¶ä¸æ˜¯å…¨èƒ½çš„ï¼Œæœ‰äº›æƒ…å†µä¸‹å¹¶ä¸èƒ½ç”Ÿæ•ˆï¼Œè¿˜æ˜¯è¦è§¦å‘å…¨é‡ç¼–è¯‘ï¼Œæœ‰æ²¡æœ‰åŠæ³•ç¼©çŸ­æ„å»ºè·¯å¾„ï¼Ÿ</p>
<p>ä¸Šé¢çš„ä¸¤ä¸ªé—®é¢˜å…¶å®éƒ½å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å·¥ç¨‹æ¨¡æ¿æ¥è§£å†³ï¼Œé¦–å…ˆæˆ‘ä»¬ä¿®æ”¹flutter_toolsä¸­çš„å…³é”®ä»£ç ï¼Œä½¿å¾—ä¸è¦†ç›–ç›®å½•ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">packages/flutter_tools/lib/src/commands/packages.dart</div><div class="line">  <span class="meta">@override</span></div><div class="line">  Future&lt;FlutterCommandResult&gt; runCommand() <span class="keyword">async</span> &#123;</div><div class="line">    <span class="comment">// await rootProject.ensureReadyForPlatformSpecificTooling(checkProjects: true);</span></div><div class="line">    logger.startProgress(</div><div class="line">      <span class="string">'è¿™æ˜¯ä¿®æ”¹è¿‡çš„ flutter_tools ä¸ä¼šå»ä¿®æ”¹.android å’Œ .ios ç›®å½•ä¸‹çš„ä»£ç '</span>,</div><div class="line">    );</div><div class="line">    refreshPluginsList(rootProject);</div><div class="line">  	...</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬ä¿®æ”¹flutter_tools/templateä¸‹çš„æ¨¡æ¿ä»£ç ï¼Œä½¿å…¶æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚è¿™æ ·æ–°å»ºçš„Flutter Moduleéƒ½æ˜¯é€šè¿‡æ¨¡æ¿å·¥ç¨‹åˆ›å»ºçš„ï¼Œå¼€å‘ç¯å¢ƒä¸€è‡´ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ<strong>å®Œæ•´å¯è¿è¡Œ</strong>çš„Moduleæ¨¡æ¿æ”¾åˆ°ä»“åº“ä¸­ä½¿ç”¨submoduleè¿›è¡Œç®¡ç†ï¼Œè¿™æ ·æ¯æ¬¡æ¨¡æ¿æ›´æ–°åï¼ŒModuleå¯ä»¥å®æ—¶æ›´æ–°ã€‚è¿™éƒ¨åˆ†å¯ä»¥æ”¾åœ¨flutterwä¸­è¿›è¡Œç®¡ç†ã€‚</p>
<p>è¿™é‡Œçš„å®Œæ•´å¯è¿è¡ŒåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ä¿®æ”¹ .android/Flutter/ Moduleï¼Œä½¿å…¶å¯ä»¥æ»¡è¶³ç¼–è¯‘æ„å»ºéœ€è¦</li>
<li>ä¿®æ”¹ .android/appï¼Œä½¿å…¶<strong>æ‹¥æœ‰å’Œå·¥ç¨‹AppåŒæ ·çš„è¿è¡Œæ—¶ç¯å¢ƒ</strong>ï¼ŒåŒ…æ‹¬ç™»é™†æ³¨å†Œç¯å¢ƒã€Hybrid Pluginç¯å¢ƒ(éFlutter Pluginï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºä¸ä¾èµ–Flutterç¯å¢ƒçš„ã€æ›´åŠ é€šç”¨çš„Hybridæ’ä»¶ç³»ç»Ÿ)ã€è°ƒè¯•ç¯å¢ƒã€ç½‘ç»œç¯å¢ƒç­‰ç­‰</li>
</ul>
<p>å½“ç„¶è¿™ä¸ªæ–¹æ¡ˆä¹Ÿå¹¶ä¸å®Œç¾ï¼Œå› ä¸ºæ¶‰åŠåˆ°ä¿®æ”¹flutter_toolsï¼Œè™½ç„¶æ”¹åŠ¨ä¸å¤§ï¼Œä½†æ¯æ¬¡Flutterç‰ˆæœ¬è¿˜æ˜¯è¦åšç‰ˆæœ¬å…¼å®¹ã€‚</p>
<p>æ›´å¥½çš„æ–¹æ¡ˆæ˜¯é‡å†™Dartæ„å»ºæµç¨‹ï¼Œå°†flutter_toolsä¸­çš„æµç¨‹ä¸²èµ·æ¥è€Œä¸æ˜¯ä¿®æ”¹å®ƒä»¬ï¼Œè¿™æ ·å°±ä¸ç”¨åšç‰ˆæœ¬è¿ç§»äº†ã€‚</p>
<p>å¥½åœ¨æœ¬èº«Flutterå¼€å‘ç¯å¢ƒå°±æ˜¯ç”±flutterwåŠ¨æ€é…ç½®çš„ï¼Œæˆ‘ä»¬æŠŠFlutterSDKæ”¾åœ¨å†…éƒ¨ä»“åº“è¿›è¡Œç»´æŠ¤ï¼Œé€šè¿‡ç»Ÿä¸€ç®¡ç†å…¥å£è¿›è¡Œç®¡ç†ï¼Œå¯¹å¼€å‘æ¥è®²é€æ˜ã€æ— æ„ŸçŸ¥ã€‚</p>
<p>å¦å¤–åœ¨Appä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›é…ç½®æ¥åˆ‡æ¢è¿œç¨‹ä¾èµ–å’Œæœ¬åœ°ä¾èµ–ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">gradle.properties</div><div class="line"># flutteræ¨¡å—é¡¹ç›®å¼€å…³</div><div class="line">includeFlutterProject=false</div><div class="line">flutterProjectPath=../U51XiaoLanBenFlutter</div><div class="line"></div><div class="line">setting.gradle</div><div class="line">// flutter lib</div><div class="line">if (includeFlutterProject == 'true') &#123;</div><div class="line">    setBinding(new Binding([gradle: this]))</div><div class="line">    evaluate(new File(</div><div class="line">            settingsDir,</div><div class="line">            "$&#123;flutterProjectPath&#125;/.android/include_flutter.groovy"</div><div class="line">    ))</div><div class="line">&#125;</div><div class="line"></div><div class="line">build.gradle</div><div class="line">if (includeFlutterProject == 'true') &#123;</div><div class="line">	implementation project(':flutter')</div><div class="line">  implementation project(':flutter_shell')</div><div class="line">&#125; else &#123;</div><div class="line">	implementation 'com.u51.android:xiaolanben-flutter:0.0.1-SNAPSHOT'</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å¯ä»¥æ›´æ–¹ä¾¿çš„è¿›è¡Œè°ƒè¯•ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬ç¯‡æ–‡ç« ä»¥Androidä¸ºä¾‹å­ï¼Œä¸»è¦ä»‹ç»äº†åœ¨æ¥å…¥Flutterè¿‡ç¨‹ä¸­ç¢°åˆ°çš„ä¸€äº›é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼Œå®é™…ä¸Šå¯¹äºiOSæ¥è¯´ä¹Ÿæ€è·¯åŸºæœ¬ä¸€è‡´ï¼Œæˆ‘ä»¬çš„iOSæ–¹æ¡ˆä¹Ÿå·²ç»è½åœ°ã€‚</p>
<p>æˆ‘ä»¬ç›®å‰åªåœ¨ä¸€ä¸ªAppä¸­è¿›è¡Œäº†å®è·µï¼Œå®é™…ä¸Šå¯¹äºå¦å¤–çš„ä¸€ä¸ªAppå·¥ç¨‹ï¼Œä¸šåŠ¡ç›¸åŒçš„Flutter Pluginåº”è¯¥åšåˆ°é€šç”¨æ€§ï¼Œåªéœ€è¦æ–°å»ºä¸€ä¸ªFlutter Moduleåšä¸­è½¬å°±å¯ä»¥é›†æˆã€‚</p>
<p>å„ä¸ªAppçš„Flutterè¿è¡Œæ—¶ç¯å¢ƒåº”è¯¥æ˜¯ç»Ÿä¸€çš„ï¼Œç›®å‰æ¥çœ‹ï¼Œè¿™ä¸ªå·¥ç¨‹æ¶æ„å¯ä»¥æ»¡è¶³å¤šä¸šåŠ¡ç»„å¼€å‘å¹¶è¡ŒFlutterçš„æƒ…å†µã€‚</p>
<p><strong>æ³¨ï¼šå¦å¤–è¿™ç¯‡æ–‡ç« æˆæ–‡æ—¶é—´è¾ƒä¹…äº†ï¼Œå¤§æ¦‚å‡ ä¸ªæœˆå‰å†™çš„ï¼Œæ–¹æ¡ˆå¯¹äºç›®å‰çš„Flutter v1.9ç‰ˆæœ¬ä¾ç„¶æ˜¯é€‚ç”¨çš„ã€‚</strong></p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps" target="_blank" rel="external">https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps</a></li>
<li><a href="https://tech.meituan.com/2018/08/09/waimai-flutter-practice.html" target="_blank" rel="external">FlutteråŸç†ä¸å®è·µ</a></li>
<li><a href="http://zhengxiaoyong.com/2018/12/16/Flutter%E6%B7%B7%E5%90%88%E5%BC%80%E5%8F%91%E7%BB%84%E4%BB%B6%E5%8C%96%E4%B8%8E%E5%B7%A5%E7%A8%8B%E5%8C%96%E6%9E%B6%E6%9E%84/" target="_blank" rel="external">Flutteræ··åˆå¼€å‘ç»„ä»¶åŒ–ä¸å·¥ç¨‹åŒ–æ¶æ„</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2019/11/23/flutter-project-manage/">http://w4lle.com/2019/11/23/flutter-project-manage/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡ä¸»è¦ä»‹ç»Androidè§†è§’ä¸‹åœ¨å·²æœ‰ App ä¸­åµŒå…¥ Flutter åº”ç”¨çš„å®è·µï¼ŒiOS çš„æ–¹æ¡ˆæ€è·¯åŸºæœ¬ä¸€è‡´ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Flutter" scheme="http://w4lle.com/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Flutter æ··åˆæ ˆç®¡ç†</title>
    <link href="http://w4lle.com/2019/11/22/flutter-hybrid-stack/"/>
    <id>http://w4lle.com/2019/11/22/flutter-hybrid-stack/</id>
    <published>2019-11-22T10:42:54.000Z</published>
    <updated>2019-11-24T02:58:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Flutter-æ··åˆæ ˆç®¡ç†"><a href="#Flutter-æ··åˆæ ˆç®¡ç†" class="headerlink" title="Flutter æ··åˆæ ˆç®¡ç†"></a>Flutter æ··åˆæ ˆç®¡ç†</h1><p>æœ¬æ–‡ä¸»è¦èŠä¸€ä¸‹ Flutter æ··åˆæ ˆï¼Œç”±äº Flutter ç‰ˆæœ¬è·¨åº¦è¾ƒå¤§ï¼Œæ‰€ä»¥ Flutter API ä¹Ÿæœ‰å¾ˆå¤§å˜åŒ–ï¼Œä¸‹æ–‡ä¸­å‰å‡ ä¸ªæ–¹æ¡ˆçš„å®ç°çœ‹çœ‹å°±å¥½ï¼Œä¸ç”¨æ·±ç©¶ã€‚é‡ç‚¹å…³æ³¨å…¼å®¹ç›®å‰ Flutter ç‰ˆæœ¬(v1.9.1) çš„å®ç°ã€‚æœ¬æ–‡ä»¥ Android å¹³å°ä¸ºä¾‹è¿›è¡Œè®²è§£ã€‚</p>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://w4lle.com/2019/11/22/flutter-hybrid-stack/">Flutter æ··åˆæ ˆç®¡ç†</a></li>
<li><a href="http://w4lle.com/2019/11/23/flutter-project-manage/">Flutter å·¥ç¨‹æ¶æ„</a></li>
</ul>
<h1 id="ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ ˆï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ ˆï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ ˆï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ ˆï¼Ÿ</h1><p>åœ¨è®¨è®º Flutter ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹ Weex åŠ H5 Hybrid å¦‚ä½•å¤„ç†å¤šå®ä¾‹é—®é¢˜çš„ã€‚</p>
<p>å¯¹äºWeexï¼Œå…¶å¼•å…¥äº† JavaScript é€šè¿‡JS Runtime å®ŒæˆåŠ¨æ€è¿ç®—ï¼Œå†æŠŠè¿ç®—ç»“æœå’ŒNativeå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œå®ŒæˆçœŸå®ViewTreeçš„æ„å»ºã€æ¸²æŸ“ç­‰æ“ä½œæŒ‡ä»¤ã€‚</p>
<p>è€Œå½“å®¢æˆ·ç«¯é¢å¯¹å¤šä¸ª Weex é¡µé¢æ—¶ï¼Œä¸ºäº†æ€§èƒ½æ–¹é¢çš„è€ƒè™‘ï¼Œå¹¶æ²¡æœ‰ä¸ºæ¯ä¸ª Weex é¡µé¢æä¾›å„è‡ªç‹¬ç«‹çš„ JS Runtimeï¼Œç›¸ååªæœ‰ä¸€ä¸ª JS Runtimeï¼Œè¿™æ„å‘³ç€æ‰€æœ‰çš„ Weex é¡µé¢å…±äº«åŒä¸€ä»½ JS Runtimeï¼Œå…±ç”¨å…¨å±€ç¯å¢ƒã€å˜é‡ã€å†…å­˜ã€å’Œå¤–ç•Œé€šä¿¡çš„æ¥å£ç­‰ç­‰ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒWeexåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡ JS Framework(weex-jsfm.js)ï¼Œåé¢æ¯æ¬¡æ‰“å¼€æ–°çš„Weexé¡µé¢éƒ½ä¸å¿…é‡æ–°åˆå§‹åŒ–ã€‚</p>
<p>ä¸ºäº†éš”ç¦»Weexç‹¬ç«‹é¡µé¢çš„è¿è¡Œç¯å¢ƒï¼Œåœ¨Nativeå±‚é¢ï¼Œæ¯æ‰“å¼€ä¸€ä¸ªWeexé¡µé¢ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„WXSDKInstanceï¼Œå…¶ä¸­æŒæœ‰å”¯ä¸€InstanceIdï¼Œåœ¨ä¸JSåŒå‘é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œæ¯ç«¯éƒ½è¦æºå¸¦InstanceIdï¼Œä¾‹å¦‚å£°æ˜å‘¨æœŸè°ƒç”¨ï¼š</p>
<ul>
<li><code>createInstance(id, code, ...)</code>ï¼šï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Weex é¡µé¢ï¼Œé€šè¿‡ä¸€æ•´æ®µ Weex JS Bundle çš„ä»£ç ï¼Œåœ¨ JS Runtime å¼€è¾Ÿä¸€å—æ–°çš„ç©ºé—´ç”¨æ¥å­˜å‚¨ã€è®°å½•å’Œè¿ç®—</li>
<li><code>refreshInstance(id, data)</code>ï¼šæ›´æ–°è¿™ä¸ª Weex é¡µé¢çš„â€œé¡¶çº§â€æ ¹ç»„ä»¶çš„æ•°æ®</li>
<li><code>destroyInstance(id)</code>ï¼šé”€æ¯</li>
</ul>
<p>æŒ‡ä»¤è°ƒç”¨ï¼š</p>
<ul>
<li><code>sendTasks(id, tasks)</code>ï¼šå‘é€æŒ‡ä»¤</li>
<li><code>receiveTasks(id, tasks)</code>ï¼šæ¥å—æŒ‡ä»¤</li>
</ul>
<p>è€Œåœ¨ JS Runtimeä¸­ï¼Œæ¯ä¸ªInstanceIdéƒ½æœ‰ä¸€ä»½ç‹¬ç«‹çš„è¿ç®—å’Œæ•°æ®çŠ¶æ€ç­‰ä¸å®¢æˆ·ç«¯ç›¸å¯¹åº”ï¼ŒJSé€šè¿‡é—­åŒ…å°†å…¶éš”ç¦»åœ¨ä¸åŒçš„é—­åŒ…é‡Œï¼Œè¾¾åˆ°éš”ç¦»çš„ç›®çš„ã€‚</p>
<p>å¯¹äºéœ€è¦å…±äº«çš„æ•°æ®ï¼Œåˆ™ä¸ç”¨InstanceIdåšå¯¹åº”ï¼Œå¦‚WeexSDKåˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„å„ç§ registeï¼š</p>
<ul>
<li><code>registerComponents(xxcomponent)</code> ï¼š æ³¨å†Œè§†å›¾ç»„ä»¶</li>
<li><code>registerModules(xxmodule)</code>ï¼šæ³¨å†ŒåŠŸèƒ½æ¨¡å—</li>
</ul>
<p>å¯¹åº”Nativeç«¯ä»£ç  <code>mWXBridge.execJS(&quot;&quot;, null, METHOD_REGISTER_XX, args);</code> ï¼Œç¬¬ä¸€ä¸ªå­—æ®µå³InstanceIdä¸ºç©ºã€‚è¿™æ ·å³å¯åœ¨å…¨å±€èŒƒå›´å†…æŸ¥æ‰¾å¹¶ä½¿ç”¨å·²æµ‹è¯•çš„ç»„ä»¶å’Œæ¨¡å—ï¼Œè€Œä¸éœ€è¦æ¯ä¸ªå®ä¾‹åˆ†åˆ«æ³¨å†Œã€‚</p>
<p>å†çœ‹ä¸‹ H5 Hybrid æ··åˆå¼€å‘ï¼ŒH5çš„å®¹å™¨æ˜¯webviewï¼Œå¯ä»¥åœ¨ä¸€ä¸ªwebviewä¸­ç®¡ç†æ‰€æœ‰H5é¡µé¢ï¼Œæœ‰ç‚¹ç±»ä¼¼ç›®å‰Flutterçš„æ–¹å¼ï¼›æ€§èƒ½æ–¹é¢ï¼ŒAndroidå¹³å°æ¥è®²ï¼Œä» Android 7.0å¼€å§‹ï¼Œwebviewå¯é€‰ä½œä¸ºç‹¬ç«‹è¿›ç¨‹ï¼ŒAndroid8.0å¼€å§‹é»˜è®¤å¼€å¯å¤šè¿›ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥ï¼Œå³ä½¿Appå†…æ‰“å¼€å¤šä¸ªwebviewä¹Ÿä¸ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™çš„å¾ˆå‰å®³ã€‚</p>
<p>è€ŒFlutterä¸€å¼€å§‹çš„è®¾è®¡å°±æ˜¯ä¸ºäº†çº¯å‡€çš„Flutteråº”ç”¨è®¾è®¡çš„ï¼Œçº¯Flutteråº”ç”¨æ•´ä¸ªè¿è¡Œç”Ÿå‘½å‘¨æœŸéƒ½åªæœ‰ä¸€ä¸ªFlutterViewå’ŒRoot Isolateï¼Œä¾é Flutter Frameworkè‡ªèº«Routeæ”¯æŒåœ¨FlutterViewå†…éƒ¨å®Œæˆç•Œé¢è·³è½¬ï¼Œç±»ä¼¼webviewã€‚å€Ÿç”¨ä¸€å¼ å›¾ï¼Œåœ¨æ–°ç‰ˆä¸Šæœ‰äº›å˜åŒ–ï¼Œä½†å¤§ä½“ç›¸é€šã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191123170804.png" alt=""></p>
<p>è€Œ Isolate ä¹‹é—´åœ¨å†…å­˜ä¸Šæ˜¯éš”ç¦»çš„ï¼Œè¿™ä¸ªéš”ç¦»è·Ÿä¸Šé¢è®²çš„Weex Instanceéš”ç¦»æ˜¯ä¸¤å›äº‹æƒ…ã€‚</p>
<p>Weex Instanceéš”ç¦»å¯ä»¥è®¤ä¸ºæ˜¯ä¸¤ä¸ªå†…éƒ¨ç±»ä¹‹é—´çš„éš”ç¦»å…³ç³»ï¼ˆå®é™…æ˜¯é—­åŒ…ï¼‰ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡å…±åŒçš„å¤–éƒ¨ç±»ï¼ˆä¸€ä¸ªæ¯”å–»ï¼‰æ¥è¿›è¡Œé€šä¿¡ï¼Œå¯ä»¥å…±ç”¨åŒä¸€ä»½å…¨å±€å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬ä¹‹é—´æ˜¯å¯ä»¥åšåˆ°å…±ç”¨å†…å­˜è¿›è¡Œé€šä¿¡çš„ã€‚</p>
<p>è€ŒIsolateåˆ™æ˜¯å½»åº•çš„å†…å­˜éš”ç¦»ï¼Œä¸¤ä¸ªIsolateä¹‹é—´ä¸å­˜åœ¨å†…å­˜ä¸Šé€šä¿¡çš„å¯èƒ½æ€§ï¼Œåªèƒ½é€šè¿‡ç¬¬ä¸‰æ–¹ä»‹å…¥æ‰å¯ä»¥é€šä¿¡ã€‚</p>
<p>è¯•æƒ³ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬åœ¨å¤šä¸ªé¡µé¢Widgetä¹‹é—´ä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œå¹¶ä¸”åƒInheritedWidgetä¹Ÿä¸èƒ½åšåˆ°å¤šWidgetæ•°æ®å…±äº«ï¼Œè€Œæˆ‘ä»¬çŸ¥é“Flutterä¸­çš„çŠ¶æ€ç®¡ç†å¾ˆå¤§ä¸€éƒ¨åˆ†æ–¹æ¡ˆéƒ½æ˜¯ä¾èµ–InheritedWidgetæ¥åšæ•°æ®å…±äº«çš„ï¼Œè¿™å°±ç›¸å½“äºç›´æ¥åºŸå¼ƒäº†FlutteråŸç”ŸçŠ¶æ€ç®¡ç†ï¼Œå¾—ä»Nativeç»•é“è¿‡æ¥é€šä¿¡å•¦ï¼Œè¿™å¯¹å¼€å‘æ¥è¯´ä½“éªŒå¤ªç³Ÿç³•ã€‚</p>
<p>æ›´é‡è¦çš„æ˜¯å¯¹èµ„æºçš„å ç”¨ï¼ŒFlutterEngineè¿è¡Œç¯å¢ƒåˆå§‹å°±ä¼šå ç”¨å¾ˆå¤§å†…å­˜ï¼Œé€šä¿¡é€šé“ä¹Ÿä¼šåˆ›å»ºå¤šä¸ªï¼Œç¼“å­˜ç©ºé—´ä¹Ÿä¼šæœ‰å¤šä»½ï¼Œè€Œä¸”æ¯ä¸ªEngineä¼šå­˜åœ¨å››ä¸ªçº¿ç¨‹ï¼ˆå®é™…æ˜¯ä¸‰ä¸ªï¼‰ï¼š</p>
<ul>
<li>Platform Task Runner ç›¸å½“äºä¸»çº¿ç¨‹ï¼Œè·ŸFlutter Engineçš„æ‰€æœ‰äº¤äº’ï¼ˆæ¥å£è°ƒç”¨ï¼‰å¿…é¡»å‘ç”Ÿåœ¨è¿™é‡Œï¼Œæ‰€æœ‰Engineå®ä¾‹å…±äº«åŒä¸€ä¸ªPlatform Runner</li>
<li>UI Task Runner ç”¨äºæ‰§è¡Œ Root Isolateï¼Œå¯¹åˆ›å»ºçš„å¯¹è±¡å’ŒWidgetsè¿›è¡ŒLayoutå¹¶ç”Ÿæˆä¸€ä¸ªLayer Treeï¼Œå¤„ç†æ¥è‡ªNative Pluginsçš„æ¶ˆæ¯å“åº”ï¼ŒTimersï¼ŒMicrotasks</li>
<li>GPU Task Runner è¢«ç”¨äºæ‰§è¡ŒGPUæŒ‡ä»¤è°ƒç”¨</li>
<li>IO Runnerç”¨äº IO è¯»å†™</li>
</ul>
<h1 id="Flutter-æ··åˆæ ˆæ–¹æ¡ˆ"><a href="#Flutter-æ··åˆæ ˆæ–¹æ¡ˆ" class="headerlink" title="Flutter æ··åˆæ ˆæ–¹æ¡ˆ"></a>Flutter æ··åˆæ ˆæ–¹æ¡ˆ</h1><p>æ€»ä½“æ¥è®²æœ‰å‡ ç§ç§æ–¹æ¡ˆï¼š</p>
<ol>
<li>å¤š Activity å¤š FlutterView æ–¹æ¡ˆï¼Œå³å¤šå¼•æ“æ–¹æ¡ˆ</li>
<li>å…±äº« FlutterViewï¼Œä»£è¡¨ä¸ºé—²é±¼ <a href="https://github.com/FlutterRepo/hybrid_stack_manager" target="_blank" rel="external">hybrid_stack_manager</a></li>
<li>å…±äº« FlutterNativieViewï¼Œä»£è¡¨ä¸º <a href="https://juejin.im/post/5c419c07f265da616f703aa1" target="_blank" rel="external">å¾®åº—</a></li>
<li>å…±äº« FlutterViewå‡çº§ç‰ˆï¼Œä»£è¡¨ä¸ºé—²é±¼ <a href="https://github.com/alibaba/flutter_boost" target="_blank" rel="external">Flutter_Boost</a></li>
<li>å…±äº« Isolateï¼Œä»£è¡¨ä¸º <a href="https://www.msup.com.cn/share/details?id=226" target="_blank" rel="external">å¤´æ¡</a></li>
</ol>
<p>å…¶å®æ ¸å¿ƒæ€æƒ³éƒ½æ˜¯å…¬ç”¨åŒä¸€ä¸ª FlutterEngineï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæµªè´¹ï¼Œä¼˜åŒ–æ€§èƒ½åŠé¡µé¢è·³è½¬ä½“éªŒï¼Œå¹¶å®ç°å¤šç«¯é€»è¾‘ç»Ÿä¸€ã€‚</p>
<p>ä¸‹é¢ä¼šæ·±å…¥ç†è§£æ¯ä¸ªæ¡†æ¶çš„å®ç°ç»†èŠ‚ã€‚</p>
<h2 id="å¤šå¼•æ“æ–¹æ¡ˆ"><a href="#å¤šå¼•æ“æ–¹æ¡ˆ" class="headerlink" title="å¤šå¼•æ“æ–¹æ¡ˆ"></a>å¤šå¼•æ“æ–¹æ¡ˆ</h2><p>å¤šå¼•æ“æ–¹æ¡ˆå³ä¸€ç³»åˆ—è¿ç»­Flutteré¡µé¢å¯¹åº”ä¸€ä¸ªActivity(VC)ï¼Œç±»ä¼¼äºwebviewä¸­æ‰“å¼€h5ï¼Œä½†æ˜¯å­˜åœ¨ç€æœ¬è´¨ä¸Šçš„åŒºåˆ«ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿›è¡Œä¸‹é¢ä¸€ç»„å¯¼èˆªæ“ä½œï¼š</p>
<p><code>Flutter Page1 -&gt; Flutter Page2 -&gt; Native Page1 -&gt; Flutter Page3</code></p>
<p>æˆ‘ä»¬åªéœ€è¦åœ¨Flutter Page1å’ŒFlutter Page3åˆ›å»ºä¸åŒçš„Flutterå®ä¾‹å³å¯ã€‚</p>
<p>è¿™ä¸ªæ–¹æ¡ˆçš„å¥½å¤„å°±æ˜¯ç®€å•æ˜“æ‡‚ï¼Œé€»è¾‘æ¸…æ™°ï¼Œä½†æ˜¯è¯¥æ–¹æ¡ˆä¹Ÿå­˜åœ¨æ˜¾è‘—çš„é—®é¢˜ï¼š</p>
<ul>
<li>æ€§èƒ½é—®é¢˜ï¼Œæ¯ä¸ªFlutterViewå¯¹åº”ä¸€ä¸ªFlutterEngineï¼ŒFlutterEngineéšç€FlutterViewçš„å¢å¤šè€Œçº¿æ€§å¢å¤šï¼Œè€ŒFlutterEngineæœ¬èº«æ˜¯ä¸€ä¸ªè¾ƒé‡çš„å¯¹è±¡ã€‚åŒ…æ‹¬çº¿ç¨‹æ•°é‡ã€å›¾ç‰‡ç¼“å­˜ã€å†…å­˜ç¼“å­˜ã€æ¶ˆæ¯é€šé“ç­‰éƒ½æ˜¯å­˜åœ¨å¤šä»½çš„</li>
<li>é€šä¿¡é—®é¢˜ï¼Œæ¯ä¸ªFlutterViewå¯¹åº”çš„Isolateåœ¨å†…å­˜ä¸Šéš”ç¦»ï¼Œä¹Ÿå°±æ˜¯è¯´è·¨FlutterViewçš„Widgeté—´é€šä¿¡éœ€è¦åŸç”Ÿä»‹å…¥æ”¯æŒ</li>
<li>è½¬åœºåŠ¨ç”»é—®é¢˜ï¼ŒNativeä¹‹é—´çš„è·³è½¬åŠ¨ç”»å’ŒFlutter Widgeté—´çš„è·³è½¬åŠ¨ç”»ä¸åŒï¼Œä½¿ç”¨ä½“éªŒä¸å¤ªå¥½</li>
</ul>
<p>æ€»ç»“èµ·æ¥å°±æ˜¯å¤šå¼•æ“æ–¹æ¡ˆä¸é€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>
<h2 id="hybrid-stack-manager"><a href="#hybrid-stack-manager" class="headerlink" title="hybrid_stack_manager"></a>hybrid_stack_manager</h2><p>è¿™ä¸ªæ¡†æ¶å®ç°æ€è·¯å¾ˆç®€å•ï¼Œå³ç”¨XFlutterViewåŒ…è£…FlutterViewï¼Œè¿›è€Œä»£ç† FlutterNativeViewã€‚</p>
<p>å¹¶ä¸”æ›¿é‡å†™äº† FlutterWrapperActivity ç”¨äºæ›¿æ¢äº†FlutterActivityï¼Œé‡Œé¢çš„é€»è¾‘æ˜¯ç›¸ä¼¼çš„ï¼Œåªä¸è¿‡æŠŠå…¶ä¸­çš„FlutterViewå’ŒFlutterActivityDelegateéƒ½æ¢æˆäº†ä»£ç†ç±»ã€‚</p>
<p>å…¶ä¸­çš„FlutterViewæ˜¯å”¯ä¸€çš„ï¼Œå…¨å±€å…±ç”¨ä¸€ä¸ªFlutterViewã€‚</p>
<p>å½“å‘ç”Ÿè·³è½¬æ—¶ï¼Œæœ‰å‡ ç§æƒ…å†µï¼š</p>
<p><strong>å½“åŸç”Ÿè·³è½¬Flutteræ—¶</strong></p>
<ul>
<li>åŸç”Ÿè·³è½¬Flutterå…¶å®æ˜¯è·³è½¬åˆ°FlutterWrapperActivity</li>
<li>åœ¨FlutterWrapperActivity.onCreateæ–¹æ³•ä¸­åŠ¨æ€ç»‘å®šFlutterViewï¼Œå¹¶å°†å‚æ•°é€šè¿‡MethodChannelä¼ é€’ç»™Flutter</li>
<li>Flutteré€šè¿‡Navigatorç®¡ç†é¡µé¢widgetï¼Œå¹¶ä¸”åœ¨Flutterå±‚å”¯ä¸€ç¡®å®šä¸€ä¸ªFlutterWrapperActivity</li>
<li>åœ¨FlutterWrapperActivity.onResumeæ–¹æ³•ä¸­æ›´æ–°curFlutterActivityï¼Œä»£è¡¨å½“å‰çš„FlutterWrapperActivity</li>
</ul>
<p><strong>å½“Flutterè·³è½¬Flutteræ—¶</strong></p>
<ul>
<li>Flutterè·³è½¬Flutteré€šè¿‡MethodChannelä¼ å€¼ç»™åŸç”Ÿï¼Œè°ƒç”¨curFlutterActivity.openUrlæ–¹æ³•</li>
<li>åŸç”Ÿè¿™è¾¹æ¥æ”¶åˆ°å‚æ•°åï¼Œå†å¼€å¯ä¸€ä¸ªFlutterWrapperActivity2</li>
<li>æˆªå±ä¿å­˜bitmapï¼Œç»‘å®šåˆ°å¯¹åº”çš„FlutterWrapperActivity1ï¼Œå¹¶å°†æˆªå›¾æ˜¾ç¤ºå‡ºæ¥</li>
<li>FlutterActivity1.onStopæ–¹æ³•ï¼Œç§»é™¤FlutterView</li>
<li>å…¶ä½™é€»è¾‘åŒä¸Š</li>
</ul>
<p><strong>å½“Flutterè·³è½¬åŸç”Ÿæ—¶</strong></p>
<ul>
<li>Flutterè·³åŸç”Ÿé€šè¿‡MethodChannelä¼ å€¼ç»™åŸç”Ÿï¼Œè°ƒç”¨curFlutterActivity.openUrlæ–¹æ³•</li>
<li>åŸç”Ÿè¿™è¾¹æ¥æ”¶åˆ°å‚æ•°åä¼šè¿”å›ä¸€ä¸ªClassï¼Œé€šè¿‡startActivityå®ç°é¡µé¢è·³è½¬</li>
<li>æˆªå±ä¿å­˜bitmapï¼Œç»‘å®šåˆ°å¯¹åº”FlutterWrapperActivityï¼Œè¿™ç§æƒ…å†µæˆªå±ä¸éœ€è¦æ˜¾ç¤º</li>
</ul>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191122170546.png" alt=""></p>
<p>è¯¥æ–¹æ¡ˆåŸºäºä¸€ä¸ªäº‹å®ï¼š<strong>ä»»ä½•æ—¶å€™æˆ‘ä»¬æœ€å¤šåªèƒ½çœ‹åˆ°ä¸€ä¸ªé¡µé¢ã€‚ï¼ˆç‰¹æ®Šæƒ…å†µä¸åœ¨è€ƒè™‘èŒƒå›´å†…ï¼‰</strong></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“ä»FlutterActivityè·³è½¬åˆ°å¦ä¸€ä¸ªFlutterActivityæ—¶ï¼ŒFlutterViewä»FlutterActivity1ç§»é™¤ï¼Œå¹¶åŠ¨æ€ç»‘å®šåˆ°FlutterActivity2ã€‚</p>
<p>æ­¤æ—¶ï¼Œä¸ºäº†ä¿è¯åˆ‡æ¢åœ¨æ˜¾ç¤ºä¸Šçš„ç»Ÿä¸€ï¼Œé¿å…FlutterViewä»FlutterActivity1ç§»é™¤æ—¶é¡µé¢å‡ºç°ç™½å±çš„æƒ…å†µï¼Œéœ€è¦å¯¹FlutterActivity1è¿›è¡Œæˆªå±æ“ä½œï¼Œå¹¶ä¸”å°†æˆªå±æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<p>ä¸Šé¢åªæè¿°äº†æ‰“å¼€é¡µé¢çš„æƒ…å†µï¼Œå¯¹äºè¿”å›æ“ä½œæ˜¯ä¸€æ ·çš„ï¼Œåœ¨onResumeå’ŒonStopä¸­åˆ†åˆ«åšå¤„ç†ã€‚</p>
<p>è¯¥æ–¹æ¡ˆå¯å–ä¹‹å¤„ï¼š</p>
<ul>
<li>æ¯ä¸€ä¸ªé¡µé¢éƒ½æœ‰ä¸€ä¸ªVC(Activity)ï¼Œä¿è¯æ‰€æœ‰åŸºäºVC(Activity)ç”Ÿå‘½å‘¨æœŸçš„é€»è¾‘(å¦‚åŸ‹ç‚¹ç­‰)ç…§å¸¸å·¥ä½œ</li>
<li>ä¸åŒçš„Flutteré¡µé¢ä¹‹é—´å¯ä»¥æ­£å¸¸é€šä¿¡ï¼Œå…±äº«æ•°æ®</li>
<li>Nativeå¯ä»¥è°ƒèµ·ä»»æ„çš„Flutteré¡µé¢ï¼Œæ— è®ºæ˜¯é¦–æ¬¡æ‰“å¼€è¿˜æ˜¯ä¹‹å</li>
</ul>
<p>è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦åå°„FlutterSDKï¼Œ<strong>ä¾µå…¥æ€§å¼º</strong></li>
<li>å•ä¾‹çš„HybridStackManageræŒæœ‰contextä¸Šä¸‹æ–‡ï¼Œå®¹æ˜“é€ æˆå†…å­˜æ³„éœ²</li>
<li><strong>å¼ºä¾èµ–Flutterç‰ˆæœ¬</strong>ï¼Œå®ç°åŸºäºFlutter v0.x</li>
<li>ä¾èµ–FlutterSDK NavigatorState historyå±æ€§ï¼Œæ–°ç‰ˆè¯¥å±æ€§å·²ç»ç§æœ‰åŒ–ï¼Œæ‰€ä»¥ <a href="https://github.com/FlutterRepo/hybrid_stack_manager/issues/5" target="_blank" rel="external">æ–°ç‰ˆä¸å¯ç”¨</a></li>
<li>åŒçº§çš„Flutteré¡µé¢æ— æ³•å®ç°ï¼Œä¾‹å¦‚tabä¸­çš„åŒçº§Flutteré¡µé¢</li>
<li>æ¯ä¸ªFlutterActivityéƒ½æŒæœ‰ä¸€å¼ æˆªå±çš„bitmapï¼Œå ç”¨å†…å­˜ç©ºé—´</li>
</ul>
<h2 id="å…±äº«FlutterNativeViewæ–¹æ¡ˆ"><a href="#å…±äº«FlutterNativeViewæ–¹æ¡ˆ" class="headerlink" title="å…±äº«FlutterNativeViewæ–¹æ¡ˆ"></a>å…±äº«FlutterNativeViewæ–¹æ¡ˆ</h2><p>è·Ÿæ–¹æ¡ˆ2ç±»ä¼¼ï¼Œåªä¸è¿‡ä»å…¨å±€å…±ç”¨FlutterViewå˜ä¸ºå…¨å±€å…±ç”¨ä¸€ä¸ªFlutterNativeViewï¼Œä¿æŒä¸€ä¸ªFlutteré¡µé¢å¯¹åº”ä¸€ä¸ªåŸç”ŸActivity(VC)ã€‚<a href="https://juejin.im/post/5c419c07f265da616f703aa1" target="_blank" rel="external">åŸç†è§£æ</a>åŠéƒ¨åˆ†<a href="https://github.com/voiddog/hybrid_stack_manager" target="_blank" rel="external">æºç </a></p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesflutter_weidian.jpg" alt=""></p>
<p>åœ¨å®ç°ä¸Šè·Ÿæ–¹æ¡ˆäºŒç±»ä¼¼ï¼Œä½†æ˜¯è¦æ›´ç®€æ´ï¼ŒåºŸå¼ƒäº†FlutterActivityï¼Œé‡å†™äº†FlutterWrapperActivityï¼Œä»ç„¶å¤ç”¨Delegateç”¨äºç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨onCreateæ–¹æ³•ä¸­åˆ¤æ–­FlutterNativeViewæ˜¯å¦å·²ç»attachè¿‡ï¼Œå¦‚æœå·²ç»attachï¼Œé‚£ä¹ˆå°±å…ˆdetachæ“ä½œï¼Œdetachæ“ä½œæ˜¯é‡ç‚¹ã€‚</p>
<p>åŒæ ·çš„ï¼Œåœ¨FlutterWrapperActivityçš„onDestroyæ–¹æ³•ä¸­ï¼Œä¹Ÿéœ€è¦detachæ“ä½œã€‚</p>
<p>FlutterNativeViewçš„å£°æ˜æ˜¯staticï¼Œæ‰€ä»¥æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¯ä»¥ä¸ä»»ä½•FlutterWrapperActivityå¯¹åº”çš„FlutterViewç»‘å®šã€‚</p>
<p>å› ä¸ºåœ¨åˆå§‹åŒ–æ—¶ï¼ŒgetFlutterViewå’ŒgetFlutterNativeViewéƒ½è¢«ViewFactoryçš„å®ç°ç±»FlutterWrapperActivityæ‰€é‡å†™ï¼Œåœ¨æ„é€ FlutterViewæ—¶ï¼Œå°†å”¯ä¸€çš„FlutterNativeViewå½“åšå‚æ•°ï¼Œä¼ è¿›å»å°±å®Œæˆäº†FlutterViewå’ŒFlutterNativeViewçš„ç»‘å®šã€‚</p>
<p>å¹¶ä¸”FlutterNativeViewç»‘å®šçš„contextæ˜¯ApplicationContextï¼Œæ‰€ä»¥ä¸å­˜åœ¨contextå†…å®¹æ³„éœ²çš„é£é™©ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">FlutterWrapperActivity</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> FlutterView <span class="title">createFlutterView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    FlutterNativeView flutterNativeView = createFlutterNativeView();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FlutterView(<span class="keyword">this</span>, <span class="keyword">null</span>, flutterNativeView);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> FlutterNativeView <span class="title">createFlutterNativeView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sFlutterNativeView == <span class="keyword">null</span>) &#123;</div><div class="line">        isCreatePage = <span class="keyword">true</span>;</div><div class="line">        sFlutterNativeView = <span class="keyword">new</span> FlutterNativeView(getApplicationContext());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sFlutterNativeView;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢æåˆ°çš„detachæ–¹æ³•æ˜¯é‡ç‚¹ï¼Œæ˜¯å› ä¸ºè¿™æ˜¯è¯¥æ–¹æ¡ˆå”¯ä¸€hook FlutterSDKçš„åœ°æ–¹ï¼Œå®é™…ä¸Šè¿™é‡Œä¸èƒ½è¯´æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„detachï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ FlutterView.nativeSurfaceDestroyed()ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onSurfaceDestroyed</span><span class="params">(FlutterView flutterView, FlutterNativeView flutterNativeView)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//Flutter è¾ƒæ—§ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬å·²ä¸å…¼å®¹</span></div><div class="line">        Method nativeSurfaceDestroyed = FlutterView.class.getDeclaredMethod(<span class="string">"nativeSurfaceDestroyed"</span>, <span class="keyword">long</span>.class);</div><div class="line">        nativeSurfaceDestroyed.setAccessible(<span class="keyword">true</span>);</div><div class="line">        nativeSurfaceDestroyed.invoke(flutterView, flutterNativeView.get());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"> </div><div class="line"><span class="comment">//å¯¹åº”çš„è€ç‰ˆæœ¬engineä»£ç  FlutterView.java</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</div><div class="line">            assertAttached();</div><div class="line">            nativeSurfaceDestroyed(mNativeView.get());</div><div class="line">        &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSurfaceDestroyed</span><span class="params">(<span class="keyword">long</span> nativePlatformViewAndroid)</span></span>;</div></pre></td></tr></table></figure>
<p>ä¸ºäº†å…¼å®¹æ–°ç‰ˆæœ¬ï¼Œåªéœ€è¦æ›¿æ¢åå°„é‚£é‡Œçš„å®ç°å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Flutter v1.7.8</span></div><div class="line">Field mFlutterJNI = flutterNativeView.getClass().getDeclaredField(<span class="string">"mFlutterJNI"</span>);</div><div class="line">mFlutterJNI.setAccessible(<span class="keyword">true</span>);</div><div class="line">Object o = mFlutterJNI.get(flutterNativeView);</div><div class="line"> </div><div class="line">Method onSurfaceDestroyed = o.getClass().getDeclaredMethod(<span class="string">"onSurfaceDestroyed"</span>);</div><div class="line">onSurfaceDestroyed.invoke(o);</div><div class="line"> </div><div class="line"> </div><div class="line"><span class="comment">//å¯¹åº”çš„ FlutterSDK ä»£ç  FlutterView.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</div><div class="line">    FlutterView.<span class="keyword">this</span>.assertAttached();</div><div class="line">    FlutterView.<span class="keyword">this</span>.mNativeView.getFlutterJNI().onSurfaceDestroyed();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹ååœ¨Flutter v1.7.8ç‰ˆæœ¬ä¸Šå¯ä»¥é¡ºåˆ©è¿è¡Œã€‚</p>
<p>å…¶ä¸­ï¼Œ<a href="https://github.com/flutter/engine" target="_blank" rel="external">Flutter Engineä»£ç åœ°å€</a>ï¼Œå¹³å°ä»£ç ç›®å½•åœ¨ shell/platform/android</p>
<p>è¯¥æ–¹æ¡ˆæœ€å¤§çš„ç‰¹ç‚¹æ˜¯ä¸éœ€è¦æˆªå±ï¼Œæ˜¯å› ä¸ºFlutterViewæ˜¯å’ŒFlutterActivityç»‘å®šçš„ï¼Œå½“åˆ‡æ¢FlutterActivityæ—¶ï¼ŒFlutterNativeView ä» FlutterView1 detachï¼Œæ­¤æ—¶FlutterActivity1ä¸­çš„FlutterView1æ˜¾ç¤ºçš„å†…å®¹ä¸å†æ›´æ–°ï¼Œæ‰€ä»¥æ˜¾ç¤ºå†…å®¹ä¸å˜ï¼Œä¸ç”¨æ‹…å¿ƒç™½å±çš„é—®é¢˜ã€‚</p>
<p>iOS å¦‚æœæ”¯æŒæ»‘åŠ¨è¿”å›çš„è¯å¯èƒ½è¿˜æ˜¯éœ€è¦æˆªå±ï¼Œå› ä¸ºåœ¨ä¾§æ»‘çš„æ—¶å€™ï¼Œé¡µé¢ä¸ä¸€å®šç»“æŸã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œè¯¥æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>hook å°‘ï¼Œä¾µå…¥æ€§è¾ƒå°‘ï¼Œå°±ä¸€å¤„</li>
<li>ä¸éœ€è¦æˆªå±ï¼Œå†…å­˜å ç”¨ä¼šç¨å¾®å¥½ä¸€ç‚¹</li>
<li>å•ä¾‹çš„FlutterNativeViewä¸æŒæœ‰Activityçš„contextï¼Œæ²¡æœ‰å†…å­˜æ³„éœ²çš„é£é™©</li>
<li>æ”¯æŒé¡µé¢é—´æ•°æ®ä¼ é€’ï¼Œåˆ‡æ˜¯await çš„æ–¹å¼ï¼Œéé€šçŸ¥å½¢å¼</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>é¦–æ¬¡è¿›å…¥ç™½å±æ—¶é—´è¾ƒé•¿</li>
<li>ä¸æ”¯æŒå¹³çº§çš„FlutterViewå±•ç¤ºï¼Œæ¯”å¦‚tabä¸­çš„Flutterç•Œé¢</li>
</ul>
<p>æ€»ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜æ˜¯æœ‰å¾ˆå¤§çš„å‚è€ƒä»·å€¼çš„ã€‚</p>
<h2 id="FlutterBoost"><a href="#FlutterBoost" class="headerlink" title="FlutterBoost"></a>FlutterBoost</h2><p><a href="https://github.com/alibaba/flutter_boost" target="_blank" rel="external">é¡¹ç›®åœ°å€</a></p>
<p>è¯¥æ–¹æ¡ˆæ˜¯å¤šNavigatoræ–¹æ¡ˆï¼Œè¦ç ”ç©¶è¿™ä¸ªæ–¹æ¡ˆçš„å®ç°ï¼Œé¦–å…ˆè¦å…ˆè¯»ä¸‹Flutterä¸­è·¯ç”±ç®¡ç†å’ŒWidgetå±‚çº§å…³ç³»çš„ç›¸å…³ä»£ç ï¼Œå¯ä»¥çœ‹<a href="https://juejin.im/post/5c8db8e8f265da2d864b889f" target="_blank" rel="external">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>
<p>å…·ä½“åŸç†å³Flutterå±‚é€šè¿‡å°è£…è¿‡çš„Widgetï¼Œå³ContainerManagerWidgetï¼Œç®¡ç†å¤šä¸ªNavigatorï¼Œæ¯ä¸ªNavigatorå¯¹åº”ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰å…·ä½“çš„ä¸šåŠ¡Widgetï¼Œå¹¶ä¸”æ”¯æŒå½“å‰Navigatorä¸­æ­£å¸¸çš„push Widgetçš„æ“ä½œã€‚</p>
<p>åŸç”Ÿå±‚å’ŒFlutterå±‚çš„å®¹å™¨é€šè¿‡å”¯ä¸€idå¯¹åº”èµ·æ¥ï¼Œå¹¶é€šè¿‡æ¶ˆæ¯é€šé“è¿›è¡Œç”Ÿå‘½å‘¨æœŸåŒæ­¥å’Œæ•°æ®äº¤äº’ã€‚</p>
<p>è¿™é‡ŒåŸç”Ÿå±‚æ˜¯é©±åŠ¨æ–¹ï¼Œæ‰€æœ‰çš„é¡µé¢çº§åˆ«çš„æ“ä½œéƒ½æ˜¯ç»Ÿä¸€å‘é€åˆ°åŸç”Ÿå±‚å¤„ç†ï¼Œç„¶åå†æ¬¡åˆ†å‘åŒæ­¥ç»™Flutterå±‚ä¾æ¬¡å¤„ç†ã€‚</p>
<h3 id="å¤šNavigatorå®ç°"><a href="#å¤šNavigatorå®ç°" class="headerlink" title="å¤šNavigatorå®ç°"></a>å¤šNavigatorå®ç°</h3><p>è¿™ä¸ªæ–¹æ¡ˆçš„ç²¾é«“åœ¨äºï¼Œä»FlutterViewä¸­çš„å•Navigatoræ ˆçº§åˆ«çš„å¯¼èˆªï¼Œè¿›åŒ–åˆ°äº†å¤šNavigatorå¹³çº§å¯¼èˆªï¼Œå³å¯ä»¥éšæ—¶éšåœ°æ‰¾åˆ°ä»»æ„ä¸€ä¸ªFlutteré¡µé¢ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯åŒçº§çš„ã€‚è¿™åœ¨ä¹‹å‰çš„æ–¹æ¡ˆä¸­æ˜¯åšä¸åˆ°çš„ã€‚</p>
<p>ä¸‹é¢ä¸»è¦åˆ†æä¸‹å¤šNavigatorçš„å®ç°ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨Flutterä¸­ï¼Œä¸‡äº‹çš†Widgetã€‚</p>
<p>Navigatorä¹Ÿä¸ä¾‹å¤–ã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191122173237.png" alt=""></p>
<p>å¯¹äºNavigatorçš„é¡µé¢ç®¡ç†ï¼Œæ¯”å¦‚ Navigator.of(context).push(route); é»˜è®¤ä»å½“å‰æ§ä»¶çš„contextä¾æ¬¡å‘ä¸Šå¯»æ‰¾è·ç¦»è‡ªå·±æœ€è¿‘çš„NavigatorStateï¼Œç„¶åè°ƒç”¨å®ƒçš„pushæ–¹æ³•å…¥æ ˆã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> NavigatorState of(</div><div class="line">    BuildContext context, &#123;</div><div class="line">      <span class="built_in">bool</span> rootNavigator = <span class="keyword">false</span>,</div><div class="line">      <span class="built_in">bool</span> nullOk = <span class="keyword">false</span>,</div><div class="line">    &#125;) &#123;</div><div class="line">    <span class="keyword">final</span> NavigatorState navigator = rootNavigator</div><div class="line">        ? context.rootAncestorStateOfType(<span class="keyword">const</span> TypeMatcher&lt;NavigatorState&gt;())</div><div class="line">        : context.ancestorStateOfType(<span class="keyword">const</span> TypeMatcher&lt;NavigatorState&gt;());</div><div class="line">    <span class="keyword">return</span> navigator;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@override</span></div><div class="line">State ancestorStateOfType(TypeMatcher matcher) &#123;</div><div class="line">  <span class="comment">///å‘çˆ¶èŠ‚ç‚¹å¯»æ‰¾ç±»å‹åŒ¹é…çš„å¯¹è±¡</span></div><div class="line">  <span class="keyword">assert</span>(_debugCheckStateIsActiveForAncestorLookup());</div><div class="line">  <span class="built_in">Element</span> ancestor = _parent;</div><div class="line">  <span class="keyword">while</span> (ancestor != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (ancestor <span class="keyword">is</span> StatefulElement &amp;&amp; matcher.check(ancestor.state))</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    ancestor = ancestor._parent;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">final</span> StatefulElement statefulAncestor = ancestor;</div><div class="line">  <span class="keyword">return</span> statefulAncestor?.state;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥åªè¦åœ¨Navigatorä¸­å†æ’å…¥ä¸€ä¸ªContainerManagerWidgetï¼Œè¿›è¡Œæ‹¦æˆªé¡µé¢è·³è½¬çš„æ“ä½œï¼Œç”¨æ¥ç®¡ç†å¤šä¸ªNavigatorï¼Œè¿™æ ·å°±å®ç°äº†Flutteré¡µé¢çš„æ‰å¹³åŒ–æ“ä½œï¼Œè§„é¿æ‰äº†åŸæœ‰Navigatorçš„æ ˆç»“æ„ã€‚</p>
<p>Flutterå±‚çš„æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191122173608.png" alt=""></p>
<p>å…¶ä¸­ï¼ŒContainerManagerè‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªOverlayï¼Œç”¨äºç®¡ç†å¤šNavigatorçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>ç”±äºOverlayStateåœ¨éå†entryè¿‡ç¨‹ä¸­æ˜¯å€’å™çš„ï¼Œæ‰€ä»¥åªè¦ä¿è¯åˆ—è¡¨ç»“æ„çš„ _leastEntries åœ¨æ·»åŠ _ContainerOverlayEntryæ—¶ï¼Œå§‹ç»ˆä¿æŒonstageéœ€è¦å‰å°å±•ç¤ºçš„æœ€åæ·»åŠ å³å¯ã€‚</p>
<p>ä¸Šé¢æåˆ°åŸç”Ÿå±‚å’ŒFlutterå±‚çš„å®¹å™¨é€šè¿‡å”¯ä¸€idå¯¹åº”èµ·æ¥ï¼Œå¹¶é€šè¿‡æ¶ˆæ¯é€šé“è¿›è¡Œç”Ÿå‘½å‘¨æœŸåŒæ­¥å’Œæ•°æ®äº¤äº’ã€‚</p>
<p>è€Œåœ¨Flutterå±‚ï¼Œæ¯ä¸ªWidgetä¹‹é—´æ˜¯å…±äº«å†…å­˜çš„ï¼Œå®ƒä»¬ä¹‹é—´å¯ä»¥å…±ç”¨åŒä¸€å¥—è¿è¡Œç¯å¢ƒã€å…¨å±€å˜é‡ã€å†…å­˜ã€é€šä¿¡æ¥å£ç­‰ã€‚æ‰€ä»¥ä»–ä»¬ä¹‹é—´å¯ä»¥æ­£å¸¸é€šä¿¡ï¼Œ</p>
<p>è¿™æ ·çœ‹æ˜¯ä¸æ˜¯å’ŒWeex JS å±‚æœ‰ç‚¹åƒäº†ã€‚</p>
<p>å®é™…ä¸Šå½“æ·±å…¥äº†è§£åï¼Œä¼šå‘ç°åœ¨DOMå¤„ç†ã€Viewçš„æ˜ å°„å…³ç³»ä¸ŠFlutterå’ŒWeexæœ‰å¾ˆå¤šç›¸ä¼¼æ”¯æŒã€‚</p>
<p>æ¯”å¦‚Flutterä¸­çš„ä¸‰æ£µæ ‘ â€”â€” Widgetã€Elementã€RenderObject å’Œ Weex Native ä¸­çš„ä¸‰æ£µæ ‘â€”â€” WxDomObjectã€WXComponentã€NativeView ä¹‹é—´çš„ç›¸ä¼¼æ€§ç­‰ç­‰ã€‚</p>
<h3 id="åŸç”Ÿå±‚å®ç°"><a href="#åŸç”Ÿå±‚å®ç°" class="headerlink" title="åŸç”Ÿå±‚å®ç°"></a>åŸç”Ÿå±‚å®ç°</h3><p>å¯¹äºåŸç”Ÿå±‚æœ‰ä¸¤ç§å®ç°ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ï¼š</p>
<ol>
<li>å…±äº«FlutterView</li>
<li>å…±äº«FlutterEngine</li>
</ol>
<p><strong>å…±äº« FlutterView ï¼š</strong></p>
<p>åˆ†æçš„ä»£ç åŸºäºmasteråˆ†æ”¯ï¼Œå½“å‰ç‰ˆæœ¬0.420ï¼Œé€‚ç”¨äº<strong>Flutter v1.5</strong>ä¹‹å‰çš„ç‰ˆæœ¬ã€‚</p>
<p>æ•´ä½“ä¸Šæ¥è¯´ï¼Œè¯¥æ–¹æ¡ˆä½¿ç”¨äº†è¾ƒä¸ºå¤æ‚çš„FlutterViewå…±äº«ç®¡ç†æ–¹æ¡ˆï¼ŒFlutterViewä»ç„¶æ˜¯å•ä¾‹çš„ï¼Œä½†æ˜¯ç›¸å¯¹äºæ–¹æ¡ˆäºŒhybrid_stack_manageræœ‰äº†é•¿è¶³çš„è¿›æ­¥ï¼Œé€»è¾‘å¤æ‚åº¦ä¹Ÿæé«˜äº†ä¸å°‘ã€‚</p>
<p>ä¸‹å›¾æ˜¯å®˜æ–¹æä¾›çš„åŸç†å›¾</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191122173908.png" alt=""></p>
<p>å¯¹äºåŸç”Ÿå±‚å’ŒFlutterå±‚æ¥è¯´ï¼Œåˆ†åˆ«æœ‰ä¸€ä¸ªContainerManagerç”¨äºç®¡ç†è°ƒåº¦Flutterå®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨çš„æ¦‚å¿µï¼Œåœ¨åŸç”Ÿå±‚å°±æ˜¯åŒ…è£…è¿‡çš„FlutterActivityï¼Œåœ¨Flutterå±‚æ˜¯Navigatorã€‚</p>
<p>ç®€å•æ¥è¯´ï¼ŒåŸç”Ÿå±‚é€šè¿‡ContainerManagerç®¡ç†åŒ…è£…è¿‡çš„FlutterActivityï¼Œä»è€Œå…±äº«å•ä¾‹çš„FlutterViewã€‚</p>
<p>è¿™é‡Œä¸ºäº†é¿å…åˆ‡æ¢è¿‡ç¨‹ä¸­å‡ºç°ç™½å±çš„é—®é¢˜ï¼Œä¾ç„¶éœ€è¦æˆªå±ã€‚</p>
<p>ç”±äºæˆªå±ï¼Œè¿™é‡Œå¯èƒ½ä¾ç„¶ä¼šå‡ºç°é—ªåŠ¨ã€é»‘å±çš„å‡ºç°ï¼Œè§ <a href="https://github.com/alibaba/flutter_boost/issues/221" target="_blank" rel="external">issue</a></p>
<p><strong>å…±äº« FlutterEngineï¼š</strong></p>
<p>åˆ†æ”¯ï¼šflutter_1.5_upgrade_opt é€‚é…äº†<strong>Flutter v1.5</strong>ç‰ˆæœ¬ã€‚</p>
<p>è¯¥æ–¹æ¡ˆæ˜¯å¤šFlutterViewï¼Œå•FlutterEngineçš„æ–¹æ¡ˆï¼Œæœ‰ç‚¹ç±»ä¼¼äºå…±äº«FlutterNativeViewæ–¹æ¡ˆã€‚</p>
<p>å®é™…ä¸Šè¿™é‡Œçš„<strong>FlutterEngineå°±æ˜¯Flutter v1.5ç‰ˆæœ¬ä¹‹åç”¨äºæ›¿ä»£FlutterNativeViewçš„ã€‚</strong></p>
<p><strong>é«˜ç‰ˆæœ¬çš„FlutterSDKï¼Œæä¾›äº†embeddingåŒ…ï¼Œè¯¥åŒ…ä¸‹æä¾›äº†æ–°çš„å®¹å™¨å®ç°åŠTextureViewçš„æ”¯æŒã€‚</strong></p>
<p>è¯¥æ–¹æ¡ˆä»ç„¶æ˜¯åºŸå¼ƒäº†FlutterActivityï¼Œè€Œè‡ªå·±ç»„è£…äº†ä¸€ä¸ªBoostFlutterActivityï¼Œå¹¶ä¸”åºŸå¼ƒäº†delegateç›¸å…³å£°æ˜å‘¨æœŸç®¡ç†ï¼Œæ‰€æœ‰çš„å£°æ˜å‘¨æœŸç®¡ç†éƒ½æ˜¯è‡ªå·±æ¥ç®¡ç†ã€‚</p>
<p>ä¸åŒç‚¹åœ¨äºå…±äº«FlutterNativeViewæ–¹æ¡ˆ detachè¿‡ç¨‹ä¸­éœ€è¦åå°„æ‹¿åˆ°FlutterJNIï¼Œè¿›è€Œè°ƒç”¨onSurfaceDestroyedæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ¡ˆä¸éœ€è¦ï¼Œæœ€ç»ˆåœ¨FlutterViewçš„detachè¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨è·¯å¾„ FlutterView.detach()-&gt;FlutterRender.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">detachFromRenderSurface()-&gt;</div><div class="line">FlutterRender.surfaceDestroyed()-&gt;</div><div class="line">flutterJNI.onSurfaceDestroyed()-&gt;</div><div class="line">FlutterJNI.nativeSurfaceDestroyed()</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆéœ€è¦è°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œéƒ½éœ€è¦è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">flutterJNI.nativeSurfaceDestroyed().</div></pre></td></tr></table></figure>
<p>ä»¥Flutter v1.5ä¸ºç•Œé™ç®€å•å¯¹æ¯”å¦‚ä¸‹ï¼š</p>
<p><strong>Flutter v1.5 ä¹‹å‰çš„ Android SDKï¼š</strong></p>
<p>io.flutter.view.FlutterView: ä¸FlutterNativeViewå…³è”ï¼ŒFlutterNativeViewé€šè¿‡DartExecutorå¯¹FlutterJNIä¸‹jniæ–¹æ³•è¿›è¡Œæ¶ˆæ¯é€šé“ä¼ é€’ï¼›</p>
<p>è§†å›¾æ¸²æŸ“å®é™…å®ç°ä¸ºSurfaceViewï¼›</p>
<p>è§†å›¾é”€æ¯ä¸åˆ›å»ºé€šè¿‡embeddingåŒ…ä¸‹çš„FlutterJNIé€šçŸ¥native</p>
<p>æ ¸å¿ƒæˆå‘˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">private final DartExecutor dartExecutor;</div><div class="line">private final FlutterRenderer flutterRenderer;</div><div class="line">private final NavigationChannel navigationChannel;</div><div class="line">private final KeyEventChannel keyEventChannel;</div><div class="line">private final LifecycleChannel lifecycleChannel;</div><div class="line">private final LocalizationChannel localizationChannel;</div><div class="line">private final PlatformChannel platformChannel;</div><div class="line">private final SettingsChannel settingsChannel;</div><div class="line">private final SystemChannel systemChannel;</div><div class="line">private final InputMethodManager mImm;</div><div class="line">private final TextInputPlugin mTextInputPlugin;</div><div class="line">private final AndroidKeyProcessor androidKeyProcessor;</div><div class="line">private final AndroidTouchProcessor androidTouchProcessor;</div></pre></td></tr></table></figure>
<p><strong>Flutter 1.5ä¹‹åçš„ Android SDKæä¾›äº†embeddingåŒ…ï¼ŒåºŸå¼ƒäº†ioåŒ…ï¼š</strong></p>
<p>io.flutter.embedding.android.FlutterView ä¸FlutterEngineå…³è”ï¼ŒåºŸå¼ƒäº†FlutterNativeViewï¼›</p>
<p>è§†å›¾æ¸²æŸ“å®é™…ä¸ºFlutterSurefaceViewæˆ–FlutterTextureViewï¼›</p>
<p>è§†å›¾é”€æ¯ä¸åˆ›å»ºé€šè¿‡embeddingåŒ…ä¸‹çš„FlutterJNIé€šçŸ¥nativeï¼›</p>
<p>æ ¸å¿ƒæˆå‘˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private FlutterView.RenderMode renderMode;</div><div class="line">private FlutterView.TransparencyMode transparencyMode;</div><div class="line">private RenderSurface renderSurface;</div><div class="line">private FlutterEngine flutterEngine;</div><div class="line">private TextInputPlugin textInputPlugin;</div><div class="line">private AndroidKeyProcessor androidKeyProcessor;</div><div class="line">private AndroidTouchProcessor androidTouchProcessor;</div><div class="line">private AccessibilityBridge accessibilityBridge;</div></pre></td></tr></table></figure>
<p>Flutter Engineæ ¸å¿ƒæˆå‘˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private final AccessibilityChannel accessibilityChannel;</div><div class="line">private final KeyEventChannel keyEventChannel;</div><div class="line">private final LifecycleChannel lifecycleChannel;</div><div class="line">private final LocalizationChannel localizationChannel;</div><div class="line">private final NavigationChannel navigationChannel;</div><div class="line">private final PlatformChannel platformChannel;</div><div class="line">private final SettingsChannel settingsChannel;</div><div class="line">private final SystemChannel systemChannel;</div><div class="line">private final TextInputChannel textInputChannel;</div></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œåœ¨æœ€æ–°ç‰ˆæœ¬ Flutter v1.9.1 å·²ç»æä¾›äº†FlutterEngineProviderç›¸å…³æ¥å£ï¼Œå³å®˜æ–¹æœ‰æ„æä¾›æ··åˆæ ˆçš„ç®¡ç†æ–¹æ¡ˆï¼Œä½†ç°åœ¨åªæ˜¯ä¸ªåŠæˆå“ï¼Œå¦‚æœç›´æ¥ç”¨çš„è¯ï¼Œä¼šå‘ç°è¿”å›é”®ç‚¹ä¸åŠ¨ï¼Œè·Ÿäº†ä¸‹å‘ç°æ˜¯æŠŠPlatformChannelçš„Handlerç»™ç½®ç©ºäº†ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é—®é¢˜ã€‚</p>
<p>å…·ä½“å®ç°å‚è§æœ€æ–°ç‰ˆçš„Flutter_Boostï¼Œå·²ç»åšå¥½äº†Flutter v1.9.1çš„é€‚é…ï¼Œæ€»ä½“ä¸Šå®ç°å·²ç»è·Ÿembeddingå·®åˆ«ä¸å¤§ï¼Œæœ‰å·®åˆ«çš„ç‚¹åœ¨äºFlutterEngineçš„attachå’Œdetachçš„æ—¶æœºä¸åŒã€FlutterPluginçš„ç”Ÿå‘½å‘¨æœŸåšäº†ä¸‹åŒæ­¥ï¼Œæ„Ÿå…´è¶£çš„è‡ªå·±å»é˜…è¯»ï¼Œè¿™é‡Œä¸è¯¦ç»†è¯´äº†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>Flutterå±‚å¤šNavigatoræ–¹æ¡ˆï¼Œæ”¯æŒåŒçº§Flutter Widgetéšæ„åˆ‡æ¢</li>
<li>æä¾›äº†ä¸€ç§æ–°çš„æ€è·¯ï¼Œç†è®ºä¸ŠFlutterè·³è½¬å¯ä»¥ä»ç„¶ä½¿ç”¨å®˜æ–¹apiï¼Œå¯ä»¥åœ¨ä¸­é—´æ‹¦æˆª</li>
<li>å¤šFlutterViewï¼Œä¸éœ€è¦æˆªå±</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ç•¥æœ‰ä¾µå…¥æ€§ï¼Œå„ä¸ªFlutterç‰ˆæœ¬éœ€è¦é€‚é…</li>
</ul>
<h2 id="å…±äº«Isolate"><a href="#å…±äº«Isolate" class="headerlink" title="å…±äº«Isolate"></a>å…±äº«Isolate</h2><p>å¤´æ¡çš„æ–¹æ¡ˆï¼Œå¤šFlutterViewï¼Œå¤šFlutterEngineï¼Œå•Isolateæ–¹æ¡ˆ</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191122175942.png" alt=""></p>
<p>è¯¥æ–¹æ¡ˆéœ€è¦ä¿®æ”¹Flutter engineæºç ï¼Œæš‚ä¸è€ƒè™‘ã€‚</p>
<p>å¤šFlutterEngineåœ¨åŒä¸€è¿è¡Œç¯å¢ƒä¸‹å¯ä»¥åšåˆ°å†…å­˜å…±äº«ï¼Œä½†åŒæ—¶ä¹Ÿéœ€è¦æ³¨æ„å†…å­˜åŒæ­¥çš„é—®é¢˜ï¼Œæ¯•ç«Ÿæ¯ä¸ªFlutterEngineéƒ½å„è‡ªæŒæœ‰UITaskRunnerï¼Œå¯ä»¥åŒæ—¶æ“ä½œåŒä¸€ä»½å†…å­˜çš„ï¼Œå¤´æ¡çš„è§£å†³æ–¹æ¡ˆæ˜¯æŠŠè¿™äº›çº¿ç¨‹å…¨éƒ¨åšæˆå…±äº«çš„äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åˆ†æäº†ä¸Šé¢å‡ ç§æ··åˆæ ˆç®¡ç†æ–¹æ¡ˆï¼Œæ•´ä½“ä¸Šæ¥è¯´é—²é±¼çš„å…±äº«FlutterEngineæ–¹æ¡ˆæ¯”è¾ƒä¸»æµï¼Œå…¶ä¸­çš„å¤šNavigatoræœ‰å¾ˆå¤§çš„å‚è€ƒä»·å€¼ã€‚</p>
<p>å¯¹äº51ä¿¡ç”¨å¡æ¥è¯´ï¼Œå¯ä»¥ä»¥æ­¤ä¸ºåŸºç¡€ï¼Œå»ºè®¾ç¬¦åˆå…¬å¸å†…éƒ¨ä½¿ç”¨çš„æ··åˆæ ˆç®¡ç†æ–¹æ¡ˆã€‚ä¸»è¦æœ‰å‡ ä¸ªäº‹æƒ…ï¼š</p>
<ul>
<li>Plugin ç®¡ç†é—®é¢˜ï¼ŒPlugin æ˜¯æŒ‡æ¯æ¡æŒ‡ä»¤å¯¹åº”åœ¨Nativeï¼ˆAndroidã€iOSï¼‰ä¸Šçš„å®ç°ï¼Œå¾—ç›ŠäºHybridçš„åŸºç¡€è®¾æ–½å»ºè®¾ï¼Œå…¬å¸å†…éƒ¨ç›®å‰æœ‰200+ Pluginå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å¤§éƒ¨åˆ†éœ€è¦Nativeå‚ä¸çš„åŠŸèƒ½ï¼Œéƒ½å·²ç»å®ç°å¥½äº†ï¼ŒFlutter ç«¯ç›´æ¥è°ƒç”¨å³å¯ï¼Œè¿™å—å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç«  <a href="http://w4lle.com/2018/11/16/51credit-android-architecture/">51ä¿¡ç”¨å¡ Android æ¶æ„æ¼”è¿›å®è·µ</a> </li>
<li>è·¯ç”±ç®¡ç†ï¼Œæ¥å…¥å·²æœ‰è·¯ç”±æ¡†æ¶</li>
<li>Flutter v1.9.1å…¼å®¹</li>
</ul>
<p>ç»è¿‡å‡ ä¸ªç‰ˆæœ¬çš„è¿­ä»£ï¼Œç›®å‰å·²ç»å®Œæˆäº†ä¸Šé¢çš„å‡ ä»¶äº‹æƒ…ï¼Œå¹¶åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨ã€‚</p>
<p><strong>æ³¨ï¼šæ­¤ç¯‡æ–‡ç« æˆæ–‡æ—¶é—´è¾ƒä¹…ï¼Œè¿‘æœŸåšäº†ä¸€äº›ä¿®æ”¹ï¼Œä¸»è¦å¢åŠ äº†Flutter v1.9.1 åŠç›¸å…³çš„å†…å®¹ã€‚</strong></p>
<p>å‚è€ƒ</p>
<ul>
<li><p><a href="https://jiongks.name/blog/weex-multi-instance-runtime/" target="_blank" rel="external">Weex åœ¨ JS Runtime å†…çš„å¤šå®ä¾‹ç®¡ç†</a></p>
</li>
<li><p><a href="https://www.jiqizhixin.com/articles/2019-03-07-15" target="_blank" rel="external">Flutteræ··åˆå¼€å‘â€”â€”FlutterBoost</a></p>
</li>
<li><p><a href="https://juejin.im/post/5b764acb51882532dc1812b1" target="_blank" rel="external">Flutteræ–°é”ä¸“å®¶ä¹‹è·¯ï¼šæ··åˆå¼€å‘ç¯‡</a></p>
</li>
<li><p><a href="https://juejin.im/post/5c419c07f265da616f703aa1" target="_blank" rel="external">å¾®åº—çš„Flutteræ··åˆæ ˆç®¡ç†æŠ€æœ¯å®è·µ</a></p>
</li>
<li><p><a href="https://www.msup.com.cn/share/details?id=226" target="_blank" rel="external">è®©FlutterçœŸæ­£æ”¯æŒViewçº§åˆ«çš„æ··åˆå¼€å‘</a></p>
</li>
<li><a href="https://zhuanlan.zhihu.com/p/38026271" target="_blank" rel="external">ä¸ºè¿½æ±‚é«˜æ€§èƒ½ï¼Œæˆ‘å¿…é¡»å‘Šè¯‰ä½ Flutterå¼•æ“çº¿ç¨‹çš„äº‹å®</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2019/11/22/flutter-hybrid-stack/">http://w4lle.com/2019/11/22/flutter-hybrid-stack/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Flutter-æ··åˆæ ˆç®¡ç†&quot;&gt;&lt;a href=&quot;#Flutter-æ··åˆæ ˆç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;Flutter æ··åˆæ ˆç®¡ç†&quot;&gt;&lt;/a&gt;Flutter æ··åˆæ ˆç®¡ç†&lt;/h1&gt;&lt;p&gt;æœ¬æ–‡ä¸»è¦èŠä¸€ä¸‹ Flutter æ··åˆæ ˆï¼Œç”±äº Flutter ç‰ˆæœ¬è·¨åº¦è¾ƒå¤§ï¼Œæ‰€ä»¥ Flutter API ä¹Ÿæœ‰å¾ˆå¤§å˜åŒ–ï¼Œä¸‹æ–‡ä¸­å‰å‡ ä¸ªæ–¹æ¡ˆçš„å®ç°çœ‹çœ‹å°±å¥½ï¼Œä¸ç”¨æ·±ç©¶ã€‚é‡ç‚¹å…³æ³¨å…¼å®¹ç›®å‰ Flutter ç‰ˆæœ¬(v1.9.1) çš„å®ç°ã€‚æœ¬æ–‡ä»¥ Android å¹³å°ä¸ºä¾‹è¿›è¡Œè®²è§£ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Flutter" scheme="http://w4lle.com/tags/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>UI2Codeï¼ˆä¸‰ï¼‰imgcook</title>
    <link href="http://w4lle.com/2019/04/08/UI2Code-2/"/>
    <id>http://w4lle.com/2019/04/08/UI2Code-2/</id>
    <published>2019-04-08T11:30:15.000Z</published>
    <updated>2019-11-24T02:58:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>imgcookæ˜¯é˜¿é‡Œå®ç°çš„åŸºäºsketchæˆ–Psè®¾è®¡ç¨¿ï¼Œè‡ªåŠ¨ç”Ÿæˆå¸ƒå±€ä»£ç çš„å·¥å…·ï¼Œæ”¯æŒç”Ÿæˆæ”¯æŒflexboxå¸ƒå±€çš„ä»£ç ï¼ŒåŒ…æ‹¬JARVISã€Vueã€å¾®ä¿¡å°ç¨‹åºã€Reactã€H5ã€Raxç­‰ç­‰ã€‚ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯sketch(Ps)æ’ä»¶ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯<a href="https://imgcook.taobao.org/" target="_blank" rel="external">imgcookå¹³å°</a>ã€‚</p>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://w4lle.com/2019/03/13/UI2Code-0/">UI2Codeï¼ˆä¸€ï¼‰pix2code</a></li>
<li><a href="http://w4lle.com/2019/03/22/UI2Code-1/">UI2Codeï¼ˆäºŒï¼‰pixeltoapp</a></li>
<li><a href="http://w4lle.com/2019/04/08/UI2Code-2/">UI2Codeï¼ˆä¸‰ï¼‰imgcook</a></li>
</ul>
<p>ç»è¿‡å‰é¢çš„ç ”ç©¶ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒUI2Codeä½œä¸ºå¯ä»¥ä»UIæˆªå›¾ç”Ÿæˆå¸ƒå±€ä»£ç çš„å·¥ä½œï¼Œå…¶æ„å»ºæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç‰ˆé¢åˆ†æï¼ŒåŒ…å«èƒŒæ™¯åˆ†æå’Œå‰æ™¯åˆ†æ</li>
<li>æå–GUIå…ƒç´ </li>
<li>ç»„ä»¶è¯†åˆ«</li>
<li>å±æ€§æå–</li>
<li>å¸ƒå±€æ¨å¯¼</li>
<li>DSL æ¨å¯¼</li>
<li>ç¼–è¯‘ï¼Œå¾—åˆ°ç›®æ ‡å¹³å°ä»£ç </li>
</ol>
<p>å…¶ä¸­éš¾ç‚¹æ˜¯ç‰ˆé¢åˆ†æå’Œå¸ƒå±€æ¨å¯¼ã€‚</p>
<p>ç‰ˆé¢åˆ†æï¼Œç›®çš„æ˜¯å¾—åˆ°ç›¸å¯¹å‡†ç¡®çš„èƒŒæ™¯å’Œå‰æ™¯ï¼Œé€šè¿‡ä¼ ç»Ÿçš„è®¡ç®—æœºå›¾åƒè®¡ç®—å’Œæœºå™¨å­¦ä¹ ï¼Œå°†UIå›¾ç‰‡æ‹†åˆ†å¹¶åˆ†å±‚ï¼Œå¾—åˆ°ç›¸å¯¹ç‹¬ç«‹çš„æ§ä»¶ï¼Œä¸ºä¸‹ä¸€æ­¥æ§ä»¶è¯†åˆ«å’Œå±æ€§æå–åšå‡†å¤‡ã€‚å¯ä»¥è¯´ï¼Œè¿™éƒ¨åˆ†åšçš„å¥½åç›´æ¥å½±å“åˆ°åé¢æ‰€æœ‰çš„æµç¨‹ã€‚</p>
<p>è€Œå¯¹äºçº¿ä¸Šä¸šåŠ¡é€»è¾‘æ¥è¯´ï¼ŒUIå›¾åƒå˜ä¸‡åŒ–ï¼ŒèƒŒæ™¯å’Œå‰æ™¯å¯èƒ½å­˜åœ¨å¾ˆå¤æ‚çš„è€¦åˆå…³ç³»ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„è§„åˆ™çº¦æŸï¼Œè¿™å°±å¯¼è‡´ç‰ˆé¢åˆ†æçš„éš¾åº¦è¾ƒå¤§ã€‚</p>
<ol>
<li>é€šè¿‡çº¯å›¾åƒè®¡ç®—ï¼Œç‰ˆé¢åˆ†æä¸å‡†ç¡®ï¼Œç»„ä»¶é—´çš„æå–ä¸å¤Ÿç‹¬ç«‹æˆ–è¢«éš”æ–­ï¼Œæ³›åŒ–èƒ½åŠ›ä¸å¤Ÿ</li>
<li>é€šè¿‡æœºå™¨å­¦ä¹ è¯†åˆ«ï¼Œæ§ä»¶å±æ€§ä¿¡æ¯ä¸å…¨ï¼Œæ²¡æœ‰åæ ‡ã€å®½åº¦ç­‰ä¿¡æ¯ï¼Œä¸”å‡†ç¡®åº¦ä¸å¤Ÿ</li>
</ol>
<p>æ‰€ä»¥å°†å›¾åƒè®¡ç®—ä¸æœºå™¨å­¦ä¹ ç›¸ç»“åˆï¼Œé€šè¿‡ä¸Šè¿°1ã€2ã€3ã€4æ­¥éª¤å¾—åˆ°ä¸€å®šæ³›åŒ–èƒ½åŠ›ä¸”ç›¸å¯¹å‡†ç¡®çš„ç‰ˆé¢ç»“æ„å’Œæ§ä»¶ä¿¡æ¯ã€‚</p>
<p>è€Œå¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œ1ã€2ã€3ã€4æ­¥æƒ³è¦å¾—åˆ°çš„å†…å®¹ï¼Œåœ¨Sketchè®¾è®¡ç¨¿é‡Œé¢éƒ½æ˜¯æœ‰æä¾›çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•å°†å…¶æå–å¤„ç†å°±å¯ä»¥ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</p>
<p>æ‰€ä»¥ç»è¿‡ä¼˜åŒ–åï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æå– Sketch è®¾è®¡ç¨¿ä¿¡æ¯</li>
<li>å¸ƒå±€æ¨å¯¼</li>
<li>DSL æ¨å¯¼</li>
<li>ç¼–è¯‘</li>
</ol>
<p>imgcook åšçš„å°±æ˜¯è¿™æ ·çš„äº‹æƒ…ã€‚</p>
<h1 id="å®é™…æ•ˆæœ"><a href="#å®é™…æ•ˆæœ" class="headerlink" title="å®é™…æ•ˆæœ"></a>å®é™…æ•ˆæœ</h1><p>é¡µé¢çº§åˆ« ï¼š</p>
<p>è®¾è®¡ç¨¿ </p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1bpzqptv3j30k2120wh6.jpg" alt=""> </p>
<p>è¿è¡Œæ•ˆæœ </p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1gfnovz73j30u01rcmys.jpg" alt=""> </p>
<p>å¡ç‰‡çº§åˆ« ï¼š</p>
<p>è®¾è®¡ç¨¿ </p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1g1gfb9ubk6j30ku098my0.jpg" alt=""> </p>
<p>è¿è¡Œæ•ˆæœ </p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1gfe6muckj30tu0glmz3.jpg" alt=""></p>
<h1 id="å®ç°æ‹†è§£"><a href="#å®ç°æ‹†è§£" class="headerlink" title="å®ç°æ‹†è§£"></a>å®ç°æ‹†è§£</h1><p>ä¸»è¦åˆ†ä¸ºå‡ ä¸ªå¤§çš„è¿‡ç¨‹ï¼š</p>
<ol>
<li>Sketch -&gt; Json</li>
<li>Json -&gt; DSL</li>
<li>DSL -&gt; Code</li>
</ol>
<p>åˆ†åˆ«æ¥çœ‹ä¸‹ã€‚</p>
<h2 id="sketchToJson"><a href="#sketchToJson" class="headerlink" title="sketchToJson"></a>sketchToJson</h2><p>åœ¨sketchä¸­é€‰ä¸­å›¾å±‚ï¼Œæˆ–è€…symbolï¼Œé€‰ä¸­imgcookæ’ä»¶å¯¼å‡ºï¼Œå½“ä»sketchå¯¼å‡ºæ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªjsonæ–‡ä»¶ï¼Œä»¥ä¸Šé¢ç¬¬äºŒä¸ªå¡ç‰‡ä¸ºä¾‹ï¼Œä¿¡æ¯å¦‚ä¸‹ </p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1g1gg7w0xdqj31440u0wk9.jpg" alt=""> </p>
<p>å…¶ä¸­åŒ…å«çš„ä¿¡æ¯åŒ…æ‹¬ï¼š </p>
<ul>
<li><p>artboardImgï¼Œé€‰ä¸­symbolçš„æ¸²æŸ“å›¾ï¼Œå¦‚<a href="https://ai-sample.oss-cn-hangzhou.aliyuncs.com/test/b4dd75404f6e11e9b26815c07ac4b122.png" target="_blank" rel="external">https://ai-sample.oss-cn-hangzhou.aliyuncs.com/test/b4dd75404f6e11e9b26815c07ac4b122.png</a> </p>
</li>
<li><p>æ§ä»¶å”¯ä¸€id </p>
</li>
<li><p>æ§ä»¶ç±»å‹ï¼Œæ¯”å¦‚Textã€Imageã€Shapeã€Repeat </p>
</li>
<li><p>æ§ä»¶å±æ€§propsï¼ŒåŒ…æ‹¬xyåæ ‡ã€å®½é«˜ã€èƒŒæ™¯è‰²ã€èƒŒæ™¯åœ†è§’ã€æº¢å‡ºå¤„ç†(overflow)ã€å›¾ç‰‡å†…å®¹ã€æ–‡å­—å†…å®¹ã€å­—ä½“å’Œå¤§å°ã€å­—ä½“é¢œè‰²ã€è¡Œé«˜ã€è¡Œæ•°ç­‰ç­‰ </p>
</li>
<li><p>childrenå±æ€§ï¼Œè¿™ä¸ªä¸€èˆ¬éƒ½æ˜¯é“ºå¹³çš„ï¼Œå½“æ—¶Typeæ˜¯Repeatæ—¶ä¼šæœ‰è¯¥å€¼ </p>
</li>
</ul>
<p>è€Œåœ¨æ’ä»¶å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä»¥ä¸‹è¿‡ç¨‹ï¼š</p>
<ul>
<li><p>æ²¡æœ‰å›¾å±‚ä¿¡æ¯ï¼Œå›¾å±‚ä¿¡æ¯éƒ½è¢«è¿‡æ»¤æ‰ </p>
</li>
<li><p>å¹³é“ºçš„æ•°ç»„ï¼Œæ²¡æœ‰å±‚çº§å…³ç³»å’Œå…„å¼Ÿå…³ç³» </p>
</li>
<li><p>RepeatåŒ…å«å¤šä¸ªchildrenï¼Œå†…å®¹æ˜¯Text </p>
</li>
<li><p>å®Œå…¨è¢«é®æŒ¡æˆ–è€…ä¸å¯è§çš„æ§ä»¶è¢«è¿‡æ»¤ </p>
</li>
<li><p>å¤æ‚çš„maskè®¡ç®—ï¼Œå¯¹äºé®ç½©çš„å¤„ç† </p>
</li>
<li><p>æ§ä»¶ç±»å‹å’Œå±æ€§éƒ½æ˜¯ä¾æ¬¡è§£æ </p>
</li>
</ul>
<p>ç›¸å½“äºæŠŠsketchæ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¿¡æ¯éƒ½å¤„ç†è¿‡åï¼Œå¾—åˆ°ä¸€ä»½æœŸæœ›çš„jsonæ–‡ä»¶ï¼Œå…¶ä¸­åŸºæœ¬æ²¡æœ‰å¸ƒå±€å±‚æ¬¡å±æ€§ï¼Œä»…æœ‰æ§ä»¶å±æ€§ï¼ŒåŒ…æ‹¬å¤§å°ã€ä½ç½®ã€æ§ä»¶ç‰¹æœ‰å±æ€§ç­‰ã€‚</p>
<p>å¸ƒå±€å±‚æ¬¡å…³ç³»åŠä½ç½®å…³ç³»ç”±ä¸‹ä¸€æ­¥æ¥å…·ä½“ç¡®å®šã€‚</p>
<h2 id="JsonToDSL"><a href="#JsonToDSL" class="headerlink" title="JsonToDSL"></a>JsonToDSL</h2><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1ghk5j5h0j31iw0u0aim.jpg" alt=""> </p>
<p>æŠŠä¸Šé¢çš„jsonå¤åˆ¶åˆ°imgcookå¹³å°ï¼Œä¼šå‘èµ·gen-layout-processè¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¼šæŠŠjsonæ–‡ä»¶å½“åšè¯·æ±‚å‚æ•°ä¸Šä¼ ï¼Œå¹¶è¿”å›ä¸€ä¸ªdslçš„Responseï¼Œè¯·æ±‚æŠ“åŒ…æ–‡ä»¶ç»“æœç»è¿‡ç¼©å‡åå¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"type"</span>: <span class="string">"Block"</span>,</div><div class="line">  <span class="attr">"id"</span>: <span class="string">"Block-661077"</span>,</div><div class="line">  <span class="attr">"__VERSION__"</span>: <span class="string">"2.0"</span>,</div><div class="line">  <span class="attr">"mask"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">"props"</span>: &#123;</div><div class="line">    <span class="attr">"style"</span>: &#123;</div><div class="line">      <span class="attr">"display"</span>: <span class="string">"flex"</span>,</div><div class="line">      <span class="attr">"alignItems"</span>: <span class="string">"flex-start"</span>,</div><div class="line">      <span class="attr">"flexDirection"</span>: <span class="string">"column"</span>,</div><div class="line">      <span class="attr">"width"</span>: <span class="number">375</span>,</div><div class="line">      <span class="attr">"height"</span>: <span class="number">164</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"attrs"</span>: &#123;</div><div class="line">      <span class="attr">"x"</span>: <span class="number">0</span>,</div><div class="line">      <span class="attr">"y"</span>: <span class="number">0</span>,</div><div class="line">      <span class="attr">"className"</span>: <span class="string">"block-661077"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"children"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"__VERSION__"</span>: <span class="string">"2.0"</span>,</div><div class="line">      <span class="attr">"props"</span>: &#123;</div><div class="line">        <span class="attr">"style"</span>: &#123;</div><div class="line">          <span class="attr">"display"</span>: <span class="string">"flex"</span>,</div><div class="line">          <span class="attr">"alignItems"</span>: <span class="string">"flex-start"</span>,</div><div class="line">          <span class="attr">"flexDirection"</span>: <span class="string">"row"</span>,</div><div class="line">          <span class="attr">"backgroundColor"</span>: <span class="string">"#ffffff"</span>,</div><div class="line">          <span class="attr">"width"</span>: <span class="number">375</span>,</div><div class="line">          <span class="attr">"height"</span>: <span class="number">68</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"attrs"</span>: &#123;</div><div class="line">          <span class="attr">"x"</span>: <span class="number">0</span>,</div><div class="line">          <span class="attr">"y"</span>: <span class="number">0</span>,</div><div class="line">          <span class="attr">"className"</span>: <span class="string">"shape-0"</span></div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"children"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"__VERSION__"</span>: <span class="string">"2.0"</span>,</div><div class="line">          <span class="attr">"props"</span>: &#123;</div><div class="line">            <span class="attr">"style"</span>: &#123;</div><div class="line">              <span class="attr">"marginTop"</span>: <span class="number">6</span>,</div><div class="line">              <span class="attr">"marginLeft"</span>: <span class="number">6</span>,</div><div class="line">              <span class="attr">"width"</span>: <span class="number">23</span>,</div><div class="line">              <span class="attr">"height"</span>: <span class="number">23</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"attrs"</span>: &#123;</div><div class="line">              <span class="attr">"x"</span>: <span class="number">22</span>,</div><div class="line">              <span class="attr">"y"</span>: <span class="number">22</span>,</div><div class="line">              <span class="attr">"source"</span>: <span class="string">"https://ai-sample.oss-cn-hangzhou.aliyuncs.com/test/b46d27404f6e11e98785ebe830f6201d.png"</span>,</div><div class="line">              <span class="attr">"src"</span>: <span class="string">"https://ai-sample.oss-cn-hangzhou.aliyuncs.com/test/b46d27404f6e11e98785ebe830f6201d.png"</span>,</div><div class="line">              <span class="attr">"className"</span>: <span class="string">"image-7"</span></div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          <span class="attr">"children"</span>: [],</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"Image"</span>,</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"Image-7"</span>,</div><div class="line">          <span class="attr">"componentType"</span>: <span class="string">"picture"</span>,</div><div class="line">          <span class="attr">"_jsonId"</span>: <span class="string">"Image-7"</span>,</div><div class="line">          <span class="attr">"_jsonElementId"</span>: <span class="string">"Image-7"</span>,</div><div class="line">          <span class="attr">"title"</span>: <span class="string">"Image"</span>,</div><div class="line">          <span class="attr">"semantic"</span>: &#123;</div><div class="line">            <span class="attr">"dvc_default"</span>: [</div><div class="line">              &#123;</div><div class="line">                <span class="attr">"name"</span>: <span class="string">"dvc_default"</span>,</div><div class="line">                <span class="attr">"level"</span>: <span class="number">100</span>,</div><div class="line">                <span class="attr">"result"</span>: <span class="string">"img"</span>,</div><div class="line">                <span class="attr">"prefix"</span>: <span class="string">""</span>,</div><div class="line">                <span class="attr">"id"</span>: <span class="number">262862</span></div><div class="line">              &#125;</div><div class="line">            ],</div><div class="line">            <span class="attr">"dvc_picture"</span>: [</div><div class="line">              &#123;</div><div class="line">                <span class="attr">"name"</span>: <span class="string">"dvc_picture"</span>,</div><div class="line">                <span class="attr">"level"</span>: <span class="number">88</span>,</div><div class="line">                <span class="attr">"result"</span>: <span class="string">"zhaoshangbank"</span>,</div><div class="line">                <span class="attr">"prefix"</span>: <span class="string">""</span>,</div><div class="line">                <span class="attr">"id"</span>: <span class="number">953603</span>,</div><div class="line">                <span class="attr">"choose"</span>: <span class="literal">true</span></div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Shape"</span>,</div><div class="line">      <span class="attr">"id"</span>: <span class="string">"Shape-0"</span>,</div><div class="line">      <span class="attr">"__ADAPT__"</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">"componentType"</span>: <span class="string">"view"</span>,</div><div class="line">      <span class="attr">"_jsonId"</span>: <span class="string">"Shape-0"</span>,</div><div class="line">      <span class="attr">"_jsonElementId"</span>: <span class="string">"Shape-0"</span>,</div><div class="line">      <span class="attr">"title"</span>: <span class="string">"Shape"</span>,</div><div class="line">      <span class="attr">"semantic"</span>: &#123;</div><div class="line">        <span class="attr">"dvc_layout"</span>: []</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"artboardImg"</span>: <span class="string">"https://ai-sample.oss-cn-hangzhou.aliyuncs.com/test/b4dd75404f6e11e9b26815c07ac4b122.png"</span>,</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"å¯æ1 copy"</span>,</div><div class="line">  <span class="attr">"componentType"</span>: <span class="string">"view"</span>,</div><div class="line">  <span class="attr">"_jsonId"</span>: <span class="string">"Block-661077"</span>,</div><div class="line">  <span class="attr">"_jsonElementId"</span>: <span class="string">"Block-661077"</span>,</div><div class="line">  <span class="attr">"title"</span>: <span class="string">"Block"</span>,</div><div class="line">  <span class="attr">"semantic"</span>: &#123;</div><div class="line">    <span class="attr">"dvc_default"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">"name"</span>: <span class="string">"dvc_default"</span>,</div><div class="line">        <span class="attr">"level"</span>: <span class="number">100</span>,</div><div class="line">        <span class="attr">"result"</span>: <span class="string">"block"</span>,</div><div class="line">        <span class="attr">"prefix"</span>: <span class="string">""</span>,</div><div class="line">        <span class="attr">"id"</span>: <span class="number">613351</span></div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">"dvc_layout"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">"name"</span>: <span class="string">"dvc_layout"</span>,</div><div class="line">        <span class="attr">"level"</span>: <span class="number">100</span>,</div><div class="line">        <span class="attr">"result"</span>: <span class="string">"box"</span>,</div><div class="line">        <span class="attr">"prefix"</span>: <span class="string">""</span>,</div><div class="line">        <span class="attr">"id"</span>: <span class="number">803050</span>,</div><div class="line">        <span class="attr">"choose"</span>: <span class="literal">true</span></div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»”ç»†è§‚å¯Ÿè¯¥jsonæ–‡ä»¶ï¼Œå¾—å‡ºä¿¡æ¯ï¼š </p>
<ul>
<li><p>å®Œæ•´çš„DomTreeï¼ŒåµŒå¥—å…³ç³»æ˜ç¡® </p>
</li>
<li><p>æ§ä»¶å±æ€§propsä¸­å¤šäº†ä¸€äº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¸ƒå±€æ–¹å¼(â€œdisplayâ€: â€œflexâ€)ã€flexå¸ƒå±€æ–¹å‘(flexDirection)ã€ä¸»è½´å¯¹é½æ–¹å¼(justifyContent)ã€å‰¯è½´å¯¹é½æ–¹å¼(alignItems)ã€æ–‡æœ¬è¿‡é•¿å¤„ç†(text-overflow)ã€classNameã€marginå®šä½ä¿¡æ¯(marginTopã€marginLeft) </p>
</li>
<li><p>è¯­ä¹‰semanticï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæœ€ç»ˆäº§ç”Ÿä¸€ä¸ªclassName </p>
</li>
<li><p>ç»„ä»¶ç±»å‹componentTypeï¼ŒåŒ…æ‹¬viewã€textã€picture </p>
</li>
</ul>
<p>è¿™ä¸€æ­¥å®Œæˆåï¼ŒåŸºæœ¬å°±å¾—åˆ°äº†å®Œæ•´å¯ç”¨çš„å¸ƒå±€DSLã€‚</p>
<p>ä¸‹ä¸€æ­¥å°±æ˜¯compileçš„è¿‡ç¨‹ã€‚</p>
<h2 id="DSL2Code"><a href="#DSL2Code" class="headerlink" title="DSL2Code"></a>DSL2Code</h2><p>DSL compileç›®æ ‡ä»£ç çš„è¿‡ç¨‹ï¼Œimgcookæ”¯æŒæ¯”è¾ƒå¤šçš„ä»£ç æ¨¡æ¿ï¼ŒJARVISã€Vueã€å¾®ä¿¡å°ç¨‹åºã€Reactã€H5ã€Raxã€‚ </p>
<p>ä»¥Vueä¸ºä¾‹ï¼Œå‘èµ·è¯·æ±‚ï¼ŒResponse ç»“æœè¿™é‡Œä¸å†åˆ—å‡ºï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<p>å…¶ä¸­renderCodeåŒ…å«3éƒ¨åˆ†å†…å®¹ï¼š </p>
<ul>
<li><p>templateï¼ŒDOMTreeï¼Œå®Œæ•´çš„å¸ƒå±€ä¿¡æ¯ï¼Œæ”¯æŒåŠ¨æ€æ•°æ®ç»‘å®š </p>
</li>
<li><p>scriptï¼Œéœ€è¦ç»‘å®šçš„æ–¹æ³•é€»è¾‘</p>
</li>
<li><p>styleï¼Œéœ€è¦ç»‘å®šçš„cssæ ·å¼</p>
</li>
</ul>
<p>åˆ†åˆ«å¯¹åº”vueä¸­çš„ä»£ç å— </p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1g1ghaq0z2wj315e068401.jpg" alt=""> </p>
<p>å®é™…çš„vueä»£ç ï¼š </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">&lt;template&gt;</div><div class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"bd"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"zhaoshangbank-wrap"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">img</span></span></div><div class="line">          <span class="attr">class</span>=<span class="string">"zhaoshangbank"</span></div><div class="line">          <span class="attr">src</span>=<span class="string">"https://ai-sample.oss-cn-hangzhou.aliyuncs.com/test/b46d27404f6e11e98785ebe830f6201d.png"</span></div><div class="line">          @<span class="attr">click</span>=<span class="string">"onClick_2"</span></div><div class="line">        /&gt;</div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"block"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"organization"</span>&gt;</span>æ‹›å•†é“¶è¡Œ 6889 <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrap"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span>å½“å‰é¢åº¦ <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"text"</span>&gt;</span>110,000<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      ...</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  <span class="attr">name</span>: <span class="string">"DvcComponent"</span>,</div><div class="line">  <span class="attr">methods</span>: &#123;</div><div class="line">    onClick_2()&#123;</div><div class="line">    	<span class="built_in">console</span>.log(<span class="string">"test"</span>)</div><div class="line">    &#125;,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="undefined"></span></div><div class="line">.box &#123;</div><div class="line">  display: flex;</div><div class="line">  align-items: flex-start;</div><div class="line">  flex-direction: column;</div><div class="line">  width: 375px;</div><div class="line">  height: 164px;</div><div class="line">...</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ä»ç”Ÿæˆçš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œdivä¸€èˆ¬ä½¿ç”¨flexå¸ƒå±€ã€‚ è¿™é‡Œçš„å›¾ç‰‡ä¹Ÿå·²ç»è¢«ä¸Šä¼ çš„å›¾åºŠï¼Œè™½ç„¶ä¸å¯çº¿ä¸Šä½¿ç”¨ï¼Œä½†æ˜¯å¯ä»¥å³æ—¶çš„é¢„è§ˆã€‚åé¢å¯ä»¥é€šè¿‡æ’ä»¶å¯¼å‡ºåˆ°æœ¬åœ°ã€‚</p>
<p>åˆ°è¿™é‡Œç”Ÿæˆçš„ä»£ç åŸºæœ¬æ˜¯å¯ç”¨çš„ï¼Œå¹¶ä¸”åœ¨imgcookå¹³å°ä¸Šå¯ä»¥è°ƒæ•´æ ·å¼ï¼Œç»‘å®šæ–¹æ³•ç­‰æ“ä½œã€‚</p>
<p>è¿™é‡Œçš„åˆ†ææ˜¯å¾ˆæ—©ä»¥å‰è¿›è¡Œçš„ï¼Œæ•°æ®ç»“æ„å¯èƒ½å·²ç»å˜æ›´ï¼Œä½†å¤§ä½“ä¸Šåº”è¯¥æ˜¯ç›¸åŒçš„ã€‚</p>
<h1 id="å®ç°éš¾ç‚¹"><a href="#å®ç°éš¾ç‚¹" class="headerlink" title="å®ç°éš¾ç‚¹"></a>å®ç°éš¾ç‚¹</h1><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼ŒåŸºæœ¬çŸ¥é“äº†imgcookçš„å¤§è‡´æµç¨‹ï¼Œä¸ªäººå…¶ä¸­çš„éš¾ç‚¹åœ¨å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<p>ä¸€æ˜¯å¸ƒå±€æ¨å¯¼çš„è¿‡ç¨‹ï¼Œè¿™å—ä¹Ÿæ˜¯æ•´ä¸ªUI2Codeçš„æ ¸å¿ƒå†…å®¹ã€‚</p>
<p>ä»å‡†ç¡®æ€§å’Œè¿˜åŸè¿‡ç¨‹ä¸­çš„å¯é€‰é¡¹æ¥çœ‹ï¼Œåº”è¯¥æ˜¯é€šè¿‡è®¡ç®—å¾—åˆ°çš„ï¼Œå…¶ä¸­çš„å¸ƒå±€ç»†èŠ‚è¾ƒå¤šï¼Œè¿™å—ä¹Ÿæ˜¯æœ€é‡è¦çš„ç‚¹ï¼Œå…¶ç»“æœç›´æ¥å¯¼è‡´é¡µé¢å¸ƒå±€çš„å¥½åã€‚</p>
<p>imgcookå¹³å°å¯¹äºè¿™å—çš„å®ç°çŒœæµ‹æ˜¯åŸºäºåˆ‡å‰²è§„åˆ™åŠ ç®—æ³•æ¥å®ç°flexå¸ƒå±€çš„ï¼Œæ•´ä½“ä¸Šæ¥è¯´åŸºæœ¬èƒ½å¤Ÿå®ç°è®¾è®¡ç¨¿ä¸Šæ‰€ä½“ç°çš„å¸ƒå±€å˜åŒ–ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿä¼šæ˜¾å¾—ä¸å¤Ÿçµæ´»ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´åˆ°ã€‚</p>
<p>å…·ä½“å¦‚ä½•å®ç°å¸ƒå±€æ¨å¯¼ï¼Œå¯ä»¥æœŸå¾…imgcookå®˜æ–¹åç»­æœ‰æ²¡æœ‰è¯´æ˜ã€‚</p>
<p>è¿™é‡Œåªæ˜¯å¼•ç”¨ä¸€ä¸‹é—²é±¼ä¹‹å‰å…³äºåˆ‡å‰²æ–¹é¢çš„è®ºè¿°ï¼ŒåŸºæœ¬å°±æ˜¯å…ˆæ¨ªåˆ‡å†ç«–åˆ‡ï¼Œé€’å½’è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨åˆ‡å‰²ä¹‹å‰å¯ä»¥å¤„ç†åæ ‡åµŒå¥—ï¼Œå¾—åˆ°çˆ¶å­ä¿¡æ¯ï¼Œç„¶ååœ¨çˆ¶å¸ƒå±€ä¸­é€’å½’åˆ‡å‰²è¿‡ç¨‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">åˆ‡å‰²æ–¹æ³•</div><div class="line">---------------------------|</div><div class="line">|                          | </div><div class="line">|    --------- 30          | </div><div class="line">|    |        |            | </div><div class="line">|    --------- 60          | </div><div class="line">|                          | </div><div class="line">|    â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 120        | </div><div class="line">|    |         |           | </div><div class="line">|    ---------- 130        | </div><div class="line">|                          | </div><div class="line">|__________________________|</div><div class="line"></div><div class="line">å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¬¬ä¸€ä¸ªåˆ‡çº¿æ˜¯60ï¼Œç¬¬äºŒä¸ªåˆ‡çº¿æ˜¯130</div><div class="line">'''</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">cut_by_col</span><span class="params">(cut_num, _im_mask)</span>:</span></div><div class="line">    zero_start = <span class="keyword">None</span></div><div class="line">    zero_end = <span class="keyword">None</span></div><div class="line">    end_range = len(_im_mask)</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, end_range):</div><div class="line">        im = _im_mask[x]</div><div class="line">        <span class="keyword">if</span> len(np.where(im == <span class="number">255</span>)[<span class="number">0</span>]) == len(im):</div><div class="line">            <span class="comment"># åˆ¤æ–­æ˜¯å¦è´¯ç©¿æ•´ä¸ªåŒºåŸŸ</span></div><div class="line">            <span class="keyword">if</span> zero_start == <span class="keyword">None</span>:</div><div class="line">                zero_start = x</div><div class="line">        <span class="keyword">elif</span> zero_start != <span class="keyword">None</span> <span class="keyword">and</span> zero_end == <span class="keyword">None</span>:</div><div class="line">            zero_end = x</div><div class="line">        <span class="keyword">if</span> zero_start != <span class="keyword">None</span> <span class="keyword">and</span> zero_end != <span class="keyword">None</span>:</div><div class="line">            start = zero_start</div><div class="line">            <span class="keyword">if</span> start &gt; <span class="number">0</span>:</div><div class="line">                <span class="comment"># é¦–æ¬¡éè”é€šåŒºåŸŸè¿‡æ»¤æ‰</span></div><div class="line">                cut_num.append(start)</div><div class="line">            zero_start = <span class="keyword">None</span></div><div class="line">            zero_end = <span class="keyword">None</span></div><div class="line">        <span class="keyword">if</span> x == end_range - <span class="number">1</span> <span class="keyword">and</span> zero_start != <span class="keyword">None</span> <span class="keyword">and</span> zero_end == <span class="keyword">None</span> <span class="keyword">and</span> zero_start &gt; <span class="number">0</span>:</div><div class="line">            zero_end = x</div><div class="line">            start = zero_start</div><div class="line">            <span class="keyword">if</span> start &gt; <span class="number">0</span>:</div><div class="line">                cut_num.append(start)</div><div class="line">            zero_start = <span class="keyword">None</span></div><div class="line">            zero_end = <span class="keyword">None</span></div></pre></td></tr></table></figure>
<p>åˆ‡å‰²è¿‡åï¼Œæ ¹æ®å„ç§ä¼˜åŒ–ç®—æ³•å¾—åˆ°å®é™…çš„å¸ƒå±€ä¿¡æ¯ã€‚</p>
<p>å½“ç„¶ï¼Œå®é™…ç”Ÿäº§è¿‡ç¨‹è‚¯å®šè¦æ¯”æˆ‘çŒœæµ‹çš„è¦å¤æ‚çš„å¤šå¾—å¤šã€‚æ¯”å¦‚ä»€ä¹ˆæ—¶å€™é€‚åˆflexå¸ƒå±€ï¼Œä»€ä¹ˆæ—¶å€™é€‚åˆç›¸å¯¹å¸ƒå±€ï¼Œä»¥åŠè°æ˜¯ä¼˜å…ˆçº§æ›´é«˜çš„ï¼Œè¿˜æœ‰æ˜¯å¦å¯ä»¥é˜ˆå€¼æ§åˆ¶æ¥ä½¿ç›¸å¯¹å¸ƒå±€å˜æˆflexå¸ƒå±€ç­‰ç­‰ã€‚</p>
<p>ç¬¬äºŒä¸ªéš¾ç‚¹æ˜¯ClassNameçš„è¯­ä¹‰åˆ†æã€‚</p>
<p>çŒœæµ‹æ˜¯é€šè¿‡æœºå™¨å­¦ä¹ è¿›è¡ŒOCRå›¾ç‰‡è¯†åˆ«å’ŒNLPè‡ªç„¶è¯­è¨€å¤„ç†ç¿»è¯‘ï¼Œè¿™å—å±äºæ˜“ç”¨æ€§æ–¹é¢çš„ä¼˜åŒ–ã€‚</p>
<p>ç¬¬ä¸‰ä¸ªéš¾ç‚¹æ˜¯é…å¥—è®¾æ–½ï¼Œä¸Šé¢åˆ†æçš„éƒ½æ˜¯å¦‚ä½•å¾—åˆ°ä¸€ä¸ªç›¸å¯¹å‡†ç¡®çš„å¸ƒå±€DSLï¼Œimgcookå¹³å°é™¤äº†è¿™ä¸ªæ ¸å¿ƒä¹‹å¤–ï¼Œå¹³å°ç»™å¼€å‘è€…æä¾›äº†æ›´å¥½çš„æ‹“å±•ï¼Œæ ¹æ®å¾—åˆ°çš„DSLä¿¡æ¯ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½ç¼–è¯‘æˆå„ç§å¹³å°ã€å„ç§è¯­è¨€ã€‚å¦å¤–è¿˜æœ‰å·¥ç¨‹åŒ–é…å¥—çš„å·¥å…·ï¼Œæ¯”å¦‚å¯¼å‡ºæ’ä»¶ï¼Œå¯ä»¥æŠŠç”Ÿæˆçš„æ–‡ä»¶å…¨éƒ¨å¯¼å‡ºåˆ°æœ¬åœ°ï¼Œä¸ä¾èµ–çº¿ä¸Šå›¾åºŠæœåŠ¡ç­‰ç­‰ã€‚</p>
<h1 id="å­˜åœ¨çš„é—®é¢˜"><a href="#å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜"></a>å­˜åœ¨çš„é—®é¢˜</h1><ul>
<li><p>æ•°æ®ç»‘å®šï¼Œéœ€è¦æ‰‹åŠ¨ç»‘å®šæ•°æ®ï¼Œå¹¶ä¸”dataåå­—è¦å…ˆæƒ³å¥½ </p>
</li>
<li><p>å›¾åºŠé—®é¢˜ï¼Œé»˜è®¤æ˜¯ä¸Šä¼ è‡³é˜¿é‡Œçš„å›¾åºŠï¼Œä¸å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨å¯¼å‡ºçš„zipåŒ…ä¸­åŒ…å«æ‰€æœ‰çš„icon </p>
</li>
<li><p>ç•Œé¢å¸ƒå±€ï¼Œç®€ç‰ˆ flexï¼ŒåŸºæœ¬åªæœ‰æ–¹å‘ï¼Œé»˜è®¤marginå®šä½ </p>
</li>
<li><p>flex çš„å¯¹é½æ–¹å¼ï¼Œæ¯”å¦‚justify-content: space-betweenå±æ€§é˜ˆå€¼è¾ƒä½ï¼Œå¤§æ¦‚2ä¸ªåƒç´ ï¼Œä¸å®¹æ˜“è¢«è§¦å‘ </p>
</li>
</ul>
<p>ä¸è¿‡imgcookå›¢é˜Ÿä¸€ç›´åœ¨åšä¼˜åŒ–å·¥ä½œï¼Œç›¸ä¿¡å¯ä»¥åšçš„è¶Šæ¥è¶Šå¥½ç”¨ï¼Œé€ ç¦å¼€å‘è€…ã€‚</p>
<h1 id="u51-weex"><a href="#u51-weex" class="headerlink" title="u51-weex"></a>u51-weex</h1><p>åŸºäºä»¥ä¸Šçš„åˆ†æï¼Œå’Œimgcookå¹³å°çš„å¼€æ”¾èƒ½åŠ›ï¼Œæˆ‘è¿™è¾¹ç¬¬ä¸€æ—¶é—´ä½“éªŒäº†è‡ªå®šä¹‰DSLçš„åŠŸèƒ½ï¼Œç”±äºæˆ‘ä»¬å›¢é˜Ÿå†…ä½¿ç”¨weexè¾ƒå¤šï¼Œæ‰€ä»¥åšäº†ä¸€ä¸ªè‡ªå®šä¹‰weex DSLçš„åŠŸèƒ½ï¼Œåœ°å€åœ¨ï¼š<a href="https://github.com/imgcook-dsl/u51-weex" target="_blank" rel="external">https://github.com/imgcook-dsl/u51-weex</a></p>
<p>å…·ä½“çš„ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://imgcook.taobao.org/docs?slug=dsl-dev" target="_blank" rel="external">https://imgcook.taobao.org/docs?slug=dsl-dev</a></p>
<p>ç†è®ºä¸Šæ¥è¯´å¯ä»¥å¯¹ä»»æ„å¹³å°çš„å¸ƒå±€è¿›è¡Œæ‹“å±•ã€‚</p>
<p>è¿™å—ä¹Ÿåœ¨å›¢é˜Ÿå†…éƒ¨åšäº†ä¸€äº›æ¨å¹¿ï¼Œæ•´ä½“ä¸Šæ¥è¯´å¯ä»¥æé«˜UIæ–¹é¢çš„å¼€å‘æ•ˆç‡ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨ç€ä¸€äº›é—®é¢˜ï¼Œè¿™é‡Œå°±ä¸å…·ä½“å±•å¼€äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ•´ä½“æ¥è®²imgcookæ˜¯ä¸€ä¸ªåŸºæœ¬å¯ç”¨çš„å¸ƒå±€ä»£ç ç”Ÿæˆå¹³å°ï¼Œå¯¹äºæå‡å·¥ä½œæ•ˆç‡æ–¹é¢æœ‰ä¸€äº›å¸®åŠ©ã€‚</p>
<p>åŒæ—¶ï¼Œå¯¹äºæ‹“å±•å¹³å°æ”¯æŒçš„å…¼å®¹æ€§ä¹Ÿæ¯”è¾ƒä¸é”™ã€‚</p>
<p>è™½ç„¶å¯¹äºé¡µé¢çº§åˆ«ä¹Ÿå¯ä»¥ç”Ÿæˆï¼Œä½†æ˜¯å¯¹äºä»£ç å±‚çº§å…³ç³»ã€åæœŸä»£ç ç»´æŠ¤ä¸Šéƒ½ä¸å¤ªå»ºè®®ç›´æ¥ä¸Šé¡µé¢çº§åˆ«ï¼›æ¯”è¾ƒå»ºè®®çš„æ–¹å¼æ˜¯ç”Ÿæˆå¡ç‰‡itemçš„å¸ƒå±€ï¼Œå¯¼å‡ºä½œä¸ºä¸€ä¸ªcomponentä½¿ç”¨ã€‚ </p>
<p>æœ€åå¸Œæœ›æ›´å¤šå¼€å‘è€…å¯ä»¥ä½¿ç”¨imgcookï¼Œæå‡ºä¸€äº›å»ºè®®ï¼Œä½¿å¾—ä»–ä»¬å›¢é˜Ÿå¯ä»¥è¿›è¡Œæ›´å¤šçš„ä¼˜åŒ–ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« å†™çš„æ—¶é—´æ¯”è¾ƒä¹…ï¼Œå½“æ–‡ç« å‘å¸ƒçš„æ—¶å€™å‘ç°imgcookå¹³å°åˆæ–°æ·»åŠ äº†<a href="https://imgcook.taobao.org/labs" target="_blank" rel="external">Lab</a>ï¼ŒæœŸå¾…æ›´å¤šæœ‰æ„æ€çš„äº§å“ã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2019/04/08/UI2Code-2/">http://w4lle.com/2019/04/08/UI2Code-2/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;imgcookæ˜¯é˜¿é‡Œå®ç°çš„åŸºäºsketchæˆ–Psè®¾è®¡ç¨¿ï¼Œè‡ªåŠ¨ç”Ÿæˆå¸ƒå±€ä»£ç çš„å·¥å…·ï¼Œæ”¯æŒç”Ÿæˆæ”¯æŒflexboxå¸ƒå±€çš„ä»£ç ï¼ŒåŒ…æ‹¬JARVISã€Vueã€å¾®ä¿¡å°ç¨‹åºã€Reactã€H5ã€Raxç­‰ç­‰ã€‚ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯sketch(Ps)æ’ä»¶ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯&lt;a href=&quot;https://imgcook.taobao.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;imgcookå¹³å°&lt;/a&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æœºå™¨å­¦ä¹ " scheme="http://w4lle.com/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>UI2Codeï¼ˆäºŒï¼‰pixeltoapp</title>
    <link href="http://w4lle.com/2019/03/22/UI2Code-1/"/>
    <id>http://w4lle.com/2019/03/22/UI2Code-1/</id>
    <published>2019-03-22T09:36:57.000Z</published>
    <updated>2019-11-24T02:58:32.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://pixeltoapp.com/" target="_blank" rel="external">pixeltoapp</a> æ˜¯ä¸€ä¸ªé€šè¿‡ä¼ ç»Ÿå›¾åƒå¤„ç†æŠŠå±å¹•æˆªå›¾è½¬æ¢ä¸º Android ä»£ç çš„é¡¹ç›®ï¼Œä½¿ç”¨pythonå®ç°ï¼Œæä¾›åœ¨çº¿æœåŠ¡ï¼Œå…·ä½“å®ç°åœ¨<a href="https://github.com/soumikmohianuta/pixtoapp" target="_blank" rel="external">é¡¹ç›®æºç åœ°å€</a></p>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://w4lle.com/2019/03/13/UI2Code-0/">UI2Codeï¼ˆä¸€ï¼‰pix2code</a></li>
<li><a href="http://w4lle.com/2019/03/22/UI2Code-1/">UI2Codeï¼ˆäºŒï¼‰pixeltoapp</a></li>
<li><a href="http://w4lle.com/2019/04/08/UI2Code-2/">UI2Codeï¼ˆä¸‰ï¼‰imgcook</a></li>
</ul>
<h1 id="å®ç°æ•ˆæœ"><a href="#å®ç°æ•ˆæœ" class="headerlink" title="å®ç°æ•ˆæœ"></a>å®ç°æ•ˆæœ</h1><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1bjfidsnoj30ku1940wr.jpg" alt="åŸå›¾"> </p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1g1bjglum9yj30ly118wgz.jpg" alt="ä»£ç æ¸²æŸ“å›¾"> </p>
<p>ç”Ÿæˆçš„å¸ƒå±€ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div></pre></td><td class="code"><pre><div class="line">&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">             android:layout_width=&quot;250.0dip&quot;</div><div class="line">             android:layout_height=&quot;541.3333333333334dip&quot;</div><div class="line">             android:layout_gravity=&quot;center_vertical|center_horizontal&quot;</div><div class="line">             android:background=&quot;@color/color_0&quot;&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_0&quot;</div><div class="line">        android:layout_width=&quot;10.333333333333334dip&quot;</div><div class="line">        android:layout_height=&quot;10.333333333333334dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;74.33333333333333dip&quot;</div><div class="line">        android:layout_marginTop=&quot;499.3333333333333dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_0&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_1&quot;</div><div class="line">        android:layout_width=&quot;10.333333333333334dip&quot;</div><div class="line">        android:layout_height=&quot;10.0dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;41.333333333333336dip&quot;</div><div class="line">        android:layout_marginTop=&quot;499.3333333333333dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_2&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_2&quot;</div><div class="line">        android:layout_width=&quot;31.666666666666668dip&quot;</div><div class="line">        android:layout_height=&quot;18.0dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;198.0dip&quot;</div><div class="line">        android:layout_marginTop=&quot;491.3333333333333dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_5&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_3&quot;</div><div class="line">        android:layout_width=&quot;10.333333333333334dip&quot;</div><div class="line">        android:layout_height=&quot;10.333333333333334dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;52.666666666666664dip&quot;</div><div class="line">        android:layout_marginTop=&quot;499.0dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_6&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_4&quot;</div><div class="line">        android:layout_width=&quot;9.333333333333334dip&quot;</div><div class="line">        android:layout_height=&quot;11.0dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;188.0dip&quot;</div><div class="line">        android:layout_marginTop=&quot;498.6666666666667dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_7&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_5&quot;</div><div class="line">        android:layout_width=&quot;10.666666666666666dip&quot;</div><div class="line">        android:layout_height=&quot;11.0dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;176.33333333333334dip&quot;</div><div class="line">        android:layout_marginTop=&quot;498.6666666666667dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_8&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_6&quot;</div><div class="line">        android:layout_width=&quot;10.666666666666666dip&quot;</div><div class="line">        android:layout_height=&quot;10.666666666666666dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;165.33333333333334dip&quot;</div><div class="line">        android:layout_marginTop=&quot;498.6666666666667dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_9&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_7&quot;</div><div class="line">        android:layout_width=&quot;1.6666666666666667dip&quot;</div><div class="line">        android:layout_height=&quot;14.666666666666666dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;124.33333333333333dip&quot;</div><div class="line">        android:layout_marginTop=&quot;496.6666666666667dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_10&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/ImageView_8&quot;</div><div class="line">        android:layout_width=&quot;250.0dip&quot;</div><div class="line">        android:layout_height=&quot;1.6666666666666667dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;0.0dip&quot;</div><div class="line">        android:layout_marginTop=&quot;489.0dip&quot;</div><div class="line">        android:scaleType=&quot;fitXY&quot;</div><div class="line">        android:src=&quot;@drawable/img_11&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;FrameLayout</div><div class="line">        android:id=&quot;@+id/FrameLayout_9&quot;</div><div class="line">        android:layout_width=&quot;229.66666666666666dip&quot;</div><div class="line">        android:layout_height=&quot;101.0dip&quot;</div><div class="line">        android:layout_marginLeft=&quot;10.0dip&quot;</div><div class="line">        android:layout_marginTop=&quot;383.3333333333333dip&quot;</div><div class="line">        android:background=&quot;@color/color_0&quot;&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_9&quot;</div><div class="line">            android:layout_width=&quot;22.0dip&quot;</div><div class="line">            android:layout_height=&quot;7.666666666666667dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;70.0dip&quot;</div><div class="line">            android:layout_marginTop=&quot;78.33333333333333dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_12&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_10&quot;</div><div class="line">            android:layout_width=&quot;22.0dip&quot;</div><div class="line">            android:layout_height=&quot;7.666666666666667dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;48.0dip&quot;</div><div class="line">            android:layout_marginTop=&quot;78.33333333333333dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_13&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_11&quot;</div><div class="line">            android:layout_width=&quot;7.0dip&quot;</div><div class="line">            android:layout_height=&quot;7.333333333333333dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;40.666666666666664dip&quot;</div><div class="line">            android:layout_marginTop=&quot;78.33333333333333dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_14&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_12&quot;</div><div class="line">            android:layout_width=&quot;14.666666666666666dip&quot;</div><div class="line">            android:layout_height=&quot;7.333333333333333dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;26.0dip&quot;</div><div class="line">            android:layout_marginTop=&quot;78.33333333333333dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_15&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_13&quot;</div><div class="line">            android:layout_width=&quot;14.666666666666666dip&quot;</div><div class="line">            android:layout_height=&quot;7.666666666666667dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;11.333333333333334dip&quot;</div><div class="line">            android:layout_marginTop=&quot;78.33333333333333dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_16&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_14&quot;</div><div class="line">            android:layout_width=&quot;44.666666666666664dip&quot;</div><div class="line">            android:layout_height=&quot;20.0dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;174.33333333333334dip&quot;</div><div class="line">            android:layout_marginTop=&quot;72.0dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_18&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_15&quot;</div><div class="line">            android:layout_width=&quot;49.0dip&quot;</div><div class="line">            android:layout_height=&quot;8.333333333333334dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;24.333333333333332dip&quot;</div><div class="line">            android:layout_marginTop=&quot;40.333333333333336dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_21&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_16&quot;</div><div class="line">            android:layout_width=&quot;12.333333333333334dip&quot;</div><div class="line">            android:layout_height=&quot;7.0dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;11.666666666666666dip&quot;</div><div class="line">            android:layout_marginTop=&quot;41.0dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_22&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_17&quot;</div><div class="line">            android:layout_width=&quot;8.666666666666666dip&quot;</div><div class="line">            android:layout_height=&quot;8.0dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;210.33333333333334dip&quot;</div><div class="line">            android:layout_marginTop=&quot;40.666666666666664dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_23&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_18&quot;</div><div class="line">            android:layout_width=&quot;24.0dip&quot;</div><div class="line">            android:layout_height=&quot;8.333333333333334dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;184.0dip&quot;</div><div class="line">            android:layout_marginTop=&quot;40.333333333333336dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_24&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_19&quot;</div><div class="line">            android:layout_width=&quot;8.0dip&quot;</div><div class="line">            android:layout_height=&quot;5.666666666666667dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;210.66666666666666dip&quot;</div><div class="line">            android:layout_marginTop=&quot;29.0dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_25&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_20&quot;</div><div class="line">            android:layout_width=&quot;37.333333333333336dip&quot;</div><div class="line">            android:layout_height=&quot;9.333333333333334dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;49.0dip&quot;</div><div class="line">            android:layout_marginTop=&quot;25.333333333333332dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_26&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_21&quot;</div><div class="line">            android:layout_width=&quot;37.333333333333336dip&quot;</div><div class="line">            android:layout_height=&quot;9.333333333333334dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;11.333333333333334dip&quot;</div><div class="line">            android:layout_marginTop=&quot;25.333333333333332dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_27&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_22&quot;</div><div class="line">            android:layout_width=&quot;7.666666666666667dip&quot;</div><div class="line">            android:layout_height=&quot;12.666666666666666dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;200.0dip&quot;</div><div class="line">            android:layout_marginTop=&quot;22.0dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_28&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/ImageView_23&quot;</div><div class="line">            android:layout_width=&quot;4.333333333333333dip&quot;</div><div class="line">            android:layout_height=&quot;12.333333333333334dip&quot;</div><div class="line">            android:layout_marginLeft=&quot;193.33333333333334dip&quot;</div><div class="line">            android:layout_marginTop=&quot;22.0dip&quot;</div><div class="line">            android:scaleType=&quot;fitXY&quot;</div><div class="line">            android:src=&quot;@drawable/img_29&quot;/&gt;</div><div class="line">    &lt;/FrameLayout&gt;</div><div class="line">    ...</div></pre></td></tr></table></figure>
<h1 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h1><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1bmgzbb4rj31o90u00z4.jpg" alt=""> </p>
<p>æ•´ä½“å¤„ç†è¿‡ç¨‹ï¼š </p>
<p>åŸå›¾ -&gt; ç°åº¦å¤„ç† - é™å™ª - è¾¹ç¼˜æ¢æµ‹ï¼Œæå–è¾¹ç¼˜è½®å»“ - è†¨èƒ€å¤„ç† - æ¡†é€‰è¾¹ç¼˜è½®å»“ - éå†è½®å»“æ„å»ºViewTree - åˆ é™¤é‡å¤å…ƒç´ ï¼Œåˆå¹¶Layoutå¸ƒå±€ï¼Œæ¢³ç†ViewTree - åˆ¤æ–­æ§ä»¶ç±»å‹ï¼Œç›®å‰æ”¯æŒTextå’ŒImage - åˆ‡å‰²å›¾åƒã€æ–‡æœ¬è¯†åˆ«ï¼Œç»‘å®šæ§ä»¶å±æ€§ - æ„å»ºXMLå¸ƒå±€ </p>
<p>æ•´ä½“åˆ†ä¸ºä¸‰ä¸ªå¤§çš„è¿‡ç¨‹ï¼šèƒŒæ™¯åˆ†æã€å‰æ™¯åˆ†æå’Œå¸ƒå±€æ„å»º </p>
<p>- èƒŒæ™¯åˆ†æï¼šé€šè¿‡æœºå™¨è§†è§‰ç®—æ³•ï¼Œå¾—åˆ°å›¾åƒè½®å»“ </p>
<p>- å‰æ™¯åˆ†æï¼šå¯¹è½®å»“ç¢ç‰‡è¿›è¡Œæ•´ç†ï¼Œåˆå¹¶ï¼Œè¯†åˆ« </p>
<p>- å¸ƒå±€æ„å»ºï¼šåŸºäºä»¥ä¸Šä¿¡æ¯æ„å»ºå¸ƒå±€ </p>
<p>ä¸‹é¢ä¾æ¬¡çœ‹ä¸‹ </p>
<h2 id="èƒŒæ™¯åˆ†æ"><a href="#èƒŒæ™¯åˆ†æ" class="headerlink" title="èƒŒæ™¯åˆ†æ"></a>èƒŒæ™¯åˆ†æ</h2><p>åŒ…å« ç°åº¦å¤„ç†ã€é™å™ªã€è¾¹ç¼˜æ¢æµ‹ã€è†¨èƒ€å¤„ç†ã€æ¡†é€‰è¾¹ç¼˜è½®å»“ç­‰å‡ ä¸ªæ­¥éª¤ </p>
<h3 id="ç°åº¦å¤„ç†"><a href="#ç°åº¦å¤„ç†" class="headerlink" title="ç°åº¦å¤„ç†"></a>ç°åº¦å¤„ç†</h3><p>äºŒå€¼åŒ–å¤„ç†ï¼Œä½œç”¨æ˜¯å¾—åˆ°ç›¸å¯¹å¹²å‡€çš„èƒŒæ™¯åº•è‰² </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)</div></pre></td></tr></table></figure>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1bkowh846j30ku194q53.jpg" alt=""> </p>
<h3 id="é™å™ª"><a href="#é™å™ª" class="headerlink" title="é™å™ª"></a>é™å™ª</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cv2.fastNlMeansDenoising(img_gray)</div></pre></td></tr></table></figure>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1bkraa5qfj30ku194jtm.jpg" alt=""> </p>
<h3 id="è¾¹ç¼˜æ¢æµ‹"><a href="#è¾¹ç¼˜æ¢æµ‹" class="headerlink" title="è¾¹ç¼˜æ¢æµ‹"></a>è¾¹ç¼˜æ¢æµ‹</h3><p>ä½¿ç”¨Cannyè¿›è¡Œè¾¹ç¼˜æ¢æµ‹ï¼ŒCannyç®—å­æ˜¯ä¸€ç§ç»å…¸çš„è¾¹ç¼˜æ£€æµ‹ç®—å­ï¼Œå®ƒèƒ½å¾—åˆ°ç²¾ç¡®çš„è¾¹ç¼˜ä½ç½®ã€‚</p>
<p>Cannyæ£€æµ‹çš„ä¸€èˆ¬æ­¥éª¤ä¸ºï¼š</p>
<ol>
<li>ç”¨é«˜æ–¯æ»¤æ³¢è¿›è¡Œé™å™ª</li>
<li>ç”¨ä¸€é˜¶åå¯¼çš„æœ‰é™å·®åˆ†è®¡ç®—æ¢¯åº¦çš„å¹…å€¼å’Œæ–¹å‘ </li>
<li>å¯¹æ¢¯åº¦å¹…å€¼è¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶</li>
<li>ç”¨åŒé˜ˆå€¼æ£€æµ‹å’Œè¿æ¥è¾¹ç¼˜ã€‚å®éªŒè¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¤šæ¬¡å°è¯•é€‰æ‹©è¾ƒå¥½çš„åŒé˜ˆå€¼å‚æ•°ã€‚ </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cv2.Canny(imgData,self.lowThreshold,self.highThreshold)</div></pre></td></tr></table></figure>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1g1bksbdqhgj30ku194dgj.jpg" alt=""> #20-40 </p>
<h3 id="å½¢æ€å­¦è†¨èƒ€"><a href="#å½¢æ€å­¦è†¨èƒ€" class="headerlink" title="å½¢æ€å­¦è†¨èƒ€"></a>å½¢æ€å­¦è†¨èƒ€</h3><p>æ£€æµ‹å‡ºæ¥çš„è¾¹ç¼˜åœ¨æŸäº›å±€éƒ¨åœ°æ–¹ä¼šæ–­å¼€ï¼Œå¯ä»¥é‡‡ç”¨ç‰¹å®šå½¢çŠ¶å’Œå°ºå¯¸çš„ç»“æ„å…ƒç´ å¯¹äºŒå€¼åŒ–å›¾åƒè¿›è¡Œå½¢æ€å­¦è†¨èƒ€å¤„ç†æ¥è¿æ¥æ–­å¼€çš„è¾¹ç¼˜ã€‚ </p>
<p>ä½¿ç”¨å¤§å°ä¸º(3ï¼Œ3)çš„åå­—çº¿è¿›è¡Œè†¨èƒ€å¤„ç† </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ratio =<span class="number">2</span>; </div><div class="line"></div><div class="line">kernel = np.ones((<span class="number">2</span> * dilationSize + <span class="number">1</span>, <span class="number">2</span> * dilationSize + <span class="number">1</span>), np.uint8) </div><div class="line"></div><div class="line">img_dilation = cv2.dilate(imgData, kernel, iterations=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1g1bkvi7ng4j30ku194t9b.jpg" alt=""> </p>
<h3 id="æ¡†é€‰è½®å»“"><a href="#æ¡†é€‰è½®å»“" class="headerlink" title="æ¡†é€‰è½®å»“"></a>æ¡†é€‰è½®å»“</h3><p>ä¸ºäº†ç›´è§‚çš„çœ‹åˆ°è½®å»“å½¢çŠ¶ï¼Œæˆ‘ä»¬ç”¨çº¢è‰²æŠŠè½®å»“æ¡†èµ·æ¥ï¼Œå…¶ä¸­å¯ä»¥çœ‹åˆ°å¾ˆå¤šç›¸åŒæ§ä»¶å†…çš„æ–‡å­—å¹¶æ²¡æœ‰è”é€šï¼Œæ‰€ä»¥ä¸Šä¸€æ­¥çš„è†¨èƒ€å¤„ç†çš„å‚æ•°ä»ç„¶æœ‰è°ƒæ•´ç©ºé—´ </p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1g1bkz5o1mbj30ku194jyb.jpg" alt=""> </p>
<p>èƒŒæ™¯åˆ†æåŸºæœ¬å°±è¿™äº›ï¼Œä¸‹é¢çœ‹å‰æ™¯åˆ†æã€‚</p>
<h2 id="å‰æ™¯åˆ†æ"><a href="#å‰æ™¯åˆ†æ" class="headerlink" title="å‰æ™¯åˆ†æ"></a>å‰æ™¯åˆ†æ</h2><p>å‰æ™¯åˆ†æåŒ…æ‹¬å¯¹è½®å»“ç¢ç‰‡è¿›è¡Œæ•´ç†å¹¶æ„å»ºViewTreeã€ViewTreeä¼˜åŒ–åˆå¹¶ã€æ§ä»¶è¯†åˆ«ã€‚</p>
<h3 id="æ„å»ºViewTree"><a href="#æ„å»ºViewTree" class="headerlink" title="æ„å»ºViewTree"></a>æ„å»ºViewTree</h3><p>å¾—åˆ°è½®å»“å‚æ•°åéå†æ“ä½œï¼Œcontoursè‡ªå¸¦å±‚çº§å…³ç³»ï¼ŒæŒ‰ç…§è¯¥å±‚çº§å…³ç³»ä¾æ¬¡é€’å½’éå†ï¼Œå¾—åˆ°ç²—ç³™çš„ViewTree </p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1g1bl2vf5naj31lm0u0gv0.jpg" alt=""> </p>
<h3 id="ViewTreeä¼˜åŒ–"><a href="#ViewTreeä¼˜åŒ–" class="headerlink" title="ViewTreeä¼˜åŒ–"></a>ViewTreeä¼˜åŒ–</h3><p>åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>åˆ é™¤é‡å åŒºåŸŸview </li>
<li>åˆç†åˆ’åˆ†çˆ¶å­å…³ç³» </li>
<li>åˆå¹¶æ— æ„ä¹‰çš„Layoutæ§ä»¶ </li>
</ul>
<h3 id="æ§ä»¶è¯†åˆ«"><a href="#æ§ä»¶è¯†åˆ«" class="headerlink" title="æ§ä»¶è¯†åˆ«"></a>æ§ä»¶è¯†åˆ«</h3><p>åˆ°è¿™ä¸€æ­¥å°±å¾—åˆ°äº†æ¯ä¸€ä¸ªViewçš„åæ ‡å±æ€§åŠè½®å»“å±æ€§äº†ï¼Œæ ¹æ®è¿™äº›æ•°æ®è¿›è¡ŒæŠ å›¾å¹¶è¯†åˆ«æ§ä»¶ç±»å‹ï¼Œ<strong>è¿™é‡Œåªæ”¯æŒä¸¤ç§æ§ä»¶</strong>ï¼šTextView å’Œ ImageViewï¼Œä½†æ˜¯ç”Ÿæˆçš„ä»£ç åªåŒ…å«ImageViewï¼ŒçŒœæµ‹æ˜¯å› ä¸ºOCRè¯†åˆ«ä¸­æ–‡æœ‰é—®é¢˜ï¼Œæ‰€ä»¥æ§ä»¶ç±»å‹è¯†åˆ«é”™è¯¯å¯¼è‡´ã€‚ </p>
<ul>
<li><p>æ§ä»¶è¯†åˆ« </p>
</li>
<li><p>å±æ€§æå–ï¼Œå›¾åƒã€æ–‡å­—ã€é¢œè‰² </p>
</li>
</ul>
<p>è¿™é‡Œä½œè€…è¿˜æä¾›äº†ListViewçš„å®ç°ï¼Œä½†æ˜¯åº”è¯¥ä¸æ˜¯å®Œæ•´çš„ï¼Œæ‰€ä»¥è¢«æ³¨é‡Šæ‰äº†ã€‚</p>
<p>åˆ°è¿™ä¸€æ­¥ï¼Œæ ¹æ®ä¸Šé¢çš„å·¥ä½œï¼Œå°±å¯ä»¥å¾—åˆ°æ•´ä¸ªViewTreeçš„æè¿°ä¿¡æ¯äº†ï¼Œç›¸å½“äºå¾—åˆ°äº†å¸ƒå±€çš„DSLï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰è¾“å‡ºDSLï¼Œä»…ä»…æ˜¯åœ¨å†…å­˜ä¸­æ•°æ®ç»“æ„çš„è¡¨ç°ã€‚</p>
<h1 id="å¸ƒå±€æ„å»º"><a href="#å¸ƒå±€æ„å»º" class="headerlink" title="å¸ƒå±€æ„å»º"></a>å¸ƒå±€æ„å»º</h1><p>èƒŒæ™¯åˆ†æå’Œå‰æ™¯åˆ†æéƒ½åšå®Œä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®ä»¥ä¸Šä¿¡æ¯è¿›è¡Œå¸ƒå±€ç”Ÿæˆå·¥ä½œ ï¼š</p>
<ul>
<li><p>æ ¹å¸ƒå±€æ˜¯FrameLayout </p>
</li>
<li><p>å­å¸ƒå±€æœ‰ä¸¤ç§FrameLayoutå’ŒRelativeLayout </p>
</li>
<li><p>æ§ä»¶éƒ½æ˜¯ç›¸å¯¹çˆ¶å¸ƒå±€çš„ç»å¯¹å¸ƒå±€ï¼Œlayout_marginLeftï¼Œlayout_marginTop </p>
</li>
<li><p>ä»£ç ä¸­çœ‹ RelativeLayout ä¸­æœ‰ç›¸å¯¹å¸ƒå±€ï¼Œä¸è¿‡çœ‹ç”Ÿæˆçš„ä»£ç æ²¡æœ‰çœ‹åˆ° </p>
</li>
</ul>
<p>è¿™ä¸€æ­¥å¤„ç†ä¹‹åå°±å¯ä»¥å¾—åˆ°å¸ƒå±€ä»£ç äº†ï¼Œç”Ÿæˆå¸ƒå±€ä»£ç åï¼Œè¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªcompileçš„è¿‡ç¨‹ï¼Œæ ¹æ®æä¾›çš„templateå·¥ç¨‹ï¼Œå°†å¸ƒå±€ä»£ç å¸¦å…¥ï¼Œå°±å¯ä»¥å¾—åˆ°å¯ä»¥è¿è¡Œçš„Androidå·¥ç¨‹äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç”±äºè®¾è®¡ç¨¿æ˜¯iOSï¼Œå®½åº¦750pxçš„è®¾è®¡ç¨¿ï¼Œæ‰€ä»¥å‡ºæ¥çš„å¸ƒå±€ä»£ç åœ¨Androidä¸Šæ˜¯æ²¡æœ‰é€‚é…çš„ï¼Œä¸è¿‡è¿™ä¸ªå…³ç³»éƒ½ä¸å¤§ã€‚ </p>
<p>è¿™ä¸ªé¡¹ç›®æä¾›äº†é€šè¿‡ä¼ ç»Ÿçš„æœºå™¨è§†è§‰å›¾åƒç®—æ³•ç”Ÿæˆå¸ƒå±€çš„æ€è·¯ã€‚ä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š </p>
<ul>
<li>å¯¹äºå¤æ‚ç•Œé¢å¤„ç†èƒ½åŠ›æœ‰é™</li>
<li>ä¼ ç»Ÿå›¾åƒå¤„ç†çš„æ–¹å¼ï¼Œå¯¹äºä¸åŒåœºæ™¯é˜ˆå€¼å¯èƒ½éœ€è¦é¢‘ç¹çš„è°ƒæ•´ï¼Œå…¸å‹çš„å¦‚è†¨èƒ€å‚æ•°</li>
<li>æ³›åŒ–èƒ½åŠ›è¾ƒå¼±ï¼Œæ”¯æŒæ§ä»¶ç±»å‹å¤ªå°‘ï¼Œå¹¶ä¸”è¯†åˆ«å‡†ç¡®ç‡ç¡®å®ä¸è¡Œ</li>
<li>å¸ƒå±€èƒ½åŠ›æœ‰é™ï¼ŒåŸºæœ¬éƒ½æ˜¯ç»å¯¹åæ ‡ï¼Œå¸ƒå±€æ¯”è¾ƒæ­»æ¿ </li>
</ul>
<p>ç°åœ¨å›è¿‡å¤´æ¥ç¿»çœ‹é—²é±¼å…³äº<a href="https://www.jiqizhixin.com/articles/2019-02-27-14" target="_blank" rel="external">ç‰ˆé¢åˆ†æçš„æ–‡ç« </a>ï¼Œå…¶ä¸­çš„ä¸»è¦æµç¨‹è·ŸpixtoappåŸºæœ¬ä¸€è‡´ï¼Œå¹¶ä¸”ä¸€äº›å‚æ•°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚è†¨èƒ€å‚æ•°ï¼ŒçŒœæµ‹é—²é±¼å›¢é˜Ÿåº”è¯¥ä¹Ÿæ˜¯å‚è€ƒè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œå¹¶åœ¨è¿™åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ã€‚ </p>
<p>ç»“åˆpix2codeé¡¹ç›®ï¼Œpixtoappè¿›è¡Œç‰ˆé¢åˆ†æï¼Œåˆ‡å‰²æ§ä»¶ã€å¾—åˆ°å¸ƒå±€ï¼Œpix2codeä½¿ç”¨MLè¿›è¡Œæ§ä»¶è¯†åˆ«ï¼Œæœ€åè¿›è¡Œç»„è£…ï¼Œå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„å¸ƒå±€ï¼Œè¿™ç§æ€è·¯æ˜¯å¯è¡Œçš„ï¼ŒçŒœæµ‹é—²é±¼ä¹Ÿæ˜¯åŸºäºè¿™æ ·çš„æ€è·¯æ¥åšçš„ã€‚ </p>
<p>è¿™ç§æ–¹æ¡ˆå…¶ä¸­çš„ä¸€ä¸ªæœ€é‡è¦çš„ç‚¹ï¼Œä¹Ÿæ˜¯æœ€éš¾çš„ç‚¹ï¼Œå°±æ˜¯å¸ƒå±€èƒ½åŠ›å¤ªå¼±ï¼Œé—²é±¼æ–‡ä¸­æåˆ°çš„å¸ƒå±€æ–¹å¼ä¹Ÿæ˜¯è§„åˆ™å®ç°ï¼Œé‚£ä¹ˆå°±æ˜¯ç±»ä¼¼pixtoappä¸­çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œåˆ‡å‰²æ–¹å¼ä¸åŒï¼Œæ‰€ä»¥é—²é±¼æœ‰rowå’Œcolï¼Œè€Œpixtoappæ²¡æœ‰ï¼ŒRNNå‰ç½®åé¦ˆè¿™ä¸ªè¿˜æ²¡æœ‰äº†è§£åˆ°ï¼Œåé¢å†çœ‹ä¸‹ã€‚ </p>
<blockquote>
<p>å‰æœŸæˆ‘ä»¬é‡‡ç”¨4å±‚LSTMç½‘ç»œè¿›è¡Œè®­ç»ƒå­¦ä¹ ï¼Œç”±äºæ ·æœ¬é‡æ¯”è¾ƒå°ï¼Œæˆ‘ä»¬æ”¹ä¸ºè§„åˆ™å®ç°ã€‚è§„åˆ™å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥åˆ‡å›¾æ—¶5åˆ€åˆ‡å‰²çš„é¡ºåºå°±æ˜¯rowå’Œcolã€‚ç¼ºç‚¹æ˜¯å¸ƒå±€æ¯”è¾ƒæ­»æ¿ï¼Œéœ€è¦ç»“åˆRNNè¿›è¡Œå‰ç½®åé¦ˆã€‚ </p>
</blockquote>
<p>é€šè¿‡ä¸¤ç¯‡æ–‡ç« çš„åˆ†æï¼ŒUI2Codeçš„å¤§ä½“æ€è·¯æ˜¯é€šäº†çš„ï¼Œä½†æ˜¯æ ¸å¿ƒç‚¹æ„å»ºå¸ƒå±€è¿˜æ²¡æœ‰å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œè¿˜éœ€è¦å†è¯¦ç»†æ€è€ƒä¸‹å®ç°æ–¹æ¡ˆã€‚ </p>
<p>å‚è€ƒ ï¼š</p>
<p><a href="https://www.jiqizhixin.com/articles/2018-12-29-5" target="_blank" rel="external">åŸºäºAIçš„ç§»åŠ¨ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶çš„è®¾è®¡</a> </p>
<p><a href="https://www.jiqizhixin.com/articles/2019-02-27-14" target="_blank" rel="external">UI2Codeæ™ºèƒ½ç”ŸæˆFlutterä»£ç â€”â€”ç‰ˆé¢åˆ†æç¯‡</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2019/03/22/UI2Code-1/">http://w4lle.com/2019/03/22/UI2Code-1/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://pixeltoapp.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;pixeltoapp&lt;/a&gt; æ˜¯ä¸€ä¸ªé€šè¿‡ä¼ ç»Ÿå›¾åƒå¤„ç†æŠŠå±å¹•æˆªå›¾è½¬æ¢ä¸º Android ä»£ç çš„é¡¹ç›®ï¼Œä½¿ç”¨pythonå®ç°ï¼Œæä¾›åœ¨çº¿æœåŠ¡ï¼Œå…·ä½“å®ç°åœ¨&lt;a href=&quot;https://github.com/soumikmohianuta/pixtoapp&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;é¡¹ç›®æºç åœ°å€&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æœºå™¨å­¦ä¹ " scheme="http://w4lle.com/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>UI2Codeï¼ˆä¸€ï¼‰pix2code</title>
    <link href="http://w4lle.com/2019/03/13/UI2Code-0/"/>
    <id>http://w4lle.com/2019/03/13/UI2Code-0/</id>
    <published>2019-03-13T08:27:22.000Z</published>
    <updated>2019-11-24T02:57:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>pix2code é¡¹ç›®é€šè¿‡æœºå™¨å­¦ä¹ ï¼Œæ”¯æŒè¾“å…¥ä¸€å¼ å›¾ç‰‡è¾“å‡ºå®é™…çš„å¸ƒå±€ä»£ç ï¼ŒåŒæ—¶æ”¯æŒç”Ÿæˆä¸‰ç«¯(Androidã€iOSã€web)å¸ƒå±€ä»£ç ã€‚</p>
<p>pix2codeä½œä¸ºUI2Codeçš„å…ˆé©±é¡¹ç›®ï¼Œåç»­çš„ç›¸å…³é¡¹ç›®æˆ–å¤šæˆ–å°‘çš„éƒ½æœ‰å‚è€ƒè¯¥é¡¹ç›®çš„å®ç°ã€‚</p>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://w4lle.com/2019/03/13/UI2Code-0/">UI2Codeï¼ˆä¸€ï¼‰pix2code</a></li>
<li><a href="http://w4lle.com/2019/03/22/UI2Code-1/">UI2Codeï¼ˆäºŒï¼‰pixeltoapp</a></li>
<li><a href="http://w4lle.com/2019/04/08/UI2Code-2/">UI2Codeï¼ˆä¸‰ï¼‰imgcook</a></li>
</ul>
<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p><a href="https://github.com/tonybeltramelli/pix2code" target="_blank" rel="external">é¡¹ç›®åœ°å€</a><br><a href="https://arxiv.org/abs/1705.07962" target="_blank" rel="external">è®ºæ–‡åœ°å€</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650728064&amp;idx=1&amp;sn=adb744e599299916faa23545c2ab436e&amp;chksm=871b22feb06cabe83ba0e3268a7a8c0c486cf6f42427ab41814e69242f919b25bc7de06ea258&amp;scene=21#wechat_redirect" target="_blank" rel="external">è®ºæ–‡ç¿»è¯‘</a></p>
<p>ä½¿ç”¨åŒæ˜¾å¡æœåŠ¡å™¨è·‘å‡ºæ¨¡å‹ï¼Œè€—æ—¶å¤§æ¦‚1.5å°æ—¶ï¼Œæ¨¡å‹æ•°é‡1500å¼ å›¾ç‰‡ï¼Œ1500ä¸ªå¯¹åº”DSLï¼Œæ¨¡å‹å¤§å°450Må·¦å³</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191115164209.png" alt=""></p>
<p>ç„¶åä½¿ç”¨éªŒè¯é›†ç”ŸæˆDSLï¼Œæ¯”å¯¹åŸå§‹DSL</p>
<p>å¯¹æ¯”1ï¼š</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images03BC80FA-5959-4432-9622-19958492D0E7.png" alt=""></p>
<p>å¯¹æ¯”2ï¼š</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images61B2D439-EC8E-4574-8BB9-D7D427B1BDF0.png" alt=""></p>
<p>å¯¹æ¯”3ï¼š</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images77658E09-48B9-489D-B69A-69C6DB57AD75.png" alt=""></p>
<p>éªŒè¯é›†å…±ç”Ÿæˆäº†250å¼ å›¾ç‰‡å¯¹åº”çš„DSLï¼Œæ€»ä½“æ¥çœ‹ä¸èƒ½åšåˆ°100%è¿˜åŸDSLï¼Œä½œè€…ç§°å¯ä»¥åšåˆ°77%å·¦å³çš„å‡†ç¡®ç‡ã€‚</p>
<p>ä»¥å…¶ä¸­ä¸€ä¸ªå›¾ç‰‡ä¸ºä¾‹</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/imagesCD7F3D19-3D1B-4070-833C-54AE57B6AC9E.png" alt=""></p>
<p>ç”Ÿæˆçš„DSL </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">stack&#123; </div><div class="line"></div><div class="line">  row&#123; </div><div class="line"></div><div class="line">    label,slider,label </div><div class="line"></div><div class="line">  &#125; </div><div class="line">&#125; </div><div class="line"></div><div class="line">footer&#123; </div><div class="line"></div><div class="line">	btn-search,btn-search,btn-search,btn-search </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼–è¯‘compileåç”Ÿæˆçš„Android xml å¸ƒå±€æ–‡ä»¶</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images7B1049AC-A185-4F64-945D-32CDB2EF7C57.png" alt=""></p>
<p>ç»“æœæ˜¯æœ‰10ä¸ªæ§ä»¶ï¼Œå…¶ä¸­çš„8ä¸ªæ˜¯æ­£ç¡®çš„ï¼Œ2ä¸ªæ˜¯è¯†åˆ«é”™è¯¯çš„ã€‚</p>
<h1 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h1><p>åŸºäºå›¾åƒæ ‡è®°ï¼ˆimage captionï¼‰æ„å»ºä¸€ç§æŠŠå›¾åƒå’Œæ–‡æœ¬è¿æ¥åœ¨ä¸€èµ·çš„æ¨¡å‹ï¼Œç”¨äºç”Ÿæˆæºå›¾åƒå†…å®¹çš„æè¿°ã€‚ </p>
<p>pix2codeæ˜¯ä¸€ä¸ªåŸºäºå·åŠç¥ç»ç½‘ç»œ(CNN)å’Œå¾ªç¯ç¥ç»ç½‘ç»œ(LSTMï¼Œé•¿çŸ­æ—¶ç¥ç»å•å…ƒ)èƒ½å¤Ÿç”±å•ä¸ªGUIå±å¹•æˆªå›¾ç”Ÿæˆæºä»£ç çš„é¡¹ç›®ã€‚ </p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images20191115163604.png" alt=""></p>
<p>æ¨¡å‹é‡‡ç”¨ç›‘ç£å­¦ä¹ ï¼Œæœ‰è¿ä¸ªè¾“å…¥ï¼Œä¸€ä¸ªæ•°GUIæˆªå›¾ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯å¯¹åº”çš„å¸ƒå±€DSLã€‚è¿™äº›å¸ƒå±€æ–‡ä»¶éƒ½è¶³å¤Ÿç®€å•ï¼ŒDSLä¹Ÿä»…ä»…å¯¹æ§ä»¶è¿›è¡Œäº†æè¿°ï¼Œä¸æ¶‰åŠä½ç½®ä¿¡æ¯å’Œæ§ä»¶å±æ€§ã€‚<br>é¦–å…ˆå°†GUIå›¾åƒ I é€šè¿‡CNNç½‘ç»œç”Ÿæˆç‰¹å¾å‘é‡Pï¼Œç„¶åDSL ç¬¦å·T æè¿°åˆ‡å‰²æˆä¸€ä¸ªåºåˆ— Xï¼ˆxt, t âˆˆ {0 . . . T âˆ’ 1}ï¼‰é€šè¿‡ç¬¬ä¸€ä¸ªè¯­è¨€æ¨¡å‹å¾—åˆ°ç‰¹å¾å‘é‡qtï¼ˆè¯¥è¯­è¨€æ¨¡å‹ç”±ä¸¤ä¸ª LSTM å±‚ã€æ¯å±‚å¸¦æœ‰128ä¸ªç¥ç»å•å…ƒæ¥å®ç°ï¼‰ï¼Œè§†è§‰ç¼–ç å‘é‡ p å’Œè¯­è¨€ç¼–ç å‘é‡ qt å¯ä»¥çº§è”ä¸ºå•ä¸€å‘é‡ rtï¼Œè¯¥çº§è”å‘é‡ rt éšåå¯ä»¥æŠ•é€åˆ°åŸºäº LSTM çš„æ¨¡å‹æ¥è§£ç ã€‚å› æ­¤è§£ç å™¨å°±å­¦åˆ°äº†è¾“å…¥ GUI å›¾åƒä¸­çš„å¯¹è±¡å’Œ DSL ä»£ç ä¸­çš„ç¬¦å·é—´çš„å…³ç³»ï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥å¯¹è¿™ä¸€å…³ç³»è¿›è¡Œå»ºæ¨¡ã€‚æˆ‘ä»¬çš„è§£ç å™¨ç”±ä¸¤ä¸ª LSTM å±‚ã€æ¯å±‚å¸¦æœ‰ 512 ä¸ªå•å…ƒçš„å †æ ˆè€Œå®ç°ã€‚æœ€åé€šè¿‡ä¸€ä¸ªsoftmaxè¿›è¡Œä¸€ä¸ªåˆ†ç±»å¯¹å½“å‰é¡¹è¿›è¡Œé¢„æµ‹ï¼Œå¹¶æŠŠç»“æœä½œä¸ºä¸‹ä¸€é¡¹çš„è¾“å…¥ã€‚</p>
<p>æ ¸å¿ƒä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">image_model = Sequential()</div><div class="line">image_model.add(Conv2D(32, (3, 3), padding=&apos;valid&apos;, activation=&apos;relu&apos;, input_shape=input_shape))</div><div class="line">image_model.add(Conv2D(32, (3, 3), padding=&apos;valid&apos;, activation=&apos;relu&apos;))</div><div class="line">image_model.add(MaxPooling2D(pool_size=(2, 2)))</div><div class="line">image_model.add(Dropout(0.25))</div><div class="line"></div><div class="line">image_model.add(Conv2D(64, (3, 3), padding=&apos;valid&apos;, activation=&apos;relu&apos;))</div><div class="line">image_model.add(Conv2D(64, (3, 3), padding=&apos;valid&apos;, activation=&apos;relu&apos;))</div><div class="line">image_model.add(MaxPooling2D(pool_size=(2, 2)))</div><div class="line">image_model.add(Dropout(0.25))</div><div class="line"></div><div class="line">image_model.add(Conv2D(128, (3, 3), padding=&apos;valid&apos;, activation=&apos;relu&apos;))</div><div class="line">image_model.add(Conv2D(128, (3, 3), padding=&apos;valid&apos;, activation=&apos;relu&apos;))</div><div class="line">image_model.add(MaxPooling2D(pool_size=(2, 2)))</div><div class="line">image_model.add(Dropout(0.25))</div><div class="line"></div><div class="line">image_model.add(Flatten())</div><div class="line">image_model.add(Dense(1024, activation=&apos;relu&apos;))</div><div class="line">image_model.add(Dropout(0.3))</div><div class="line">image_model.add(Dense(1024, activation=&apos;relu&apos;))</div><div class="line">image_model.add(Dropout(0.3))</div><div class="line"></div><div class="line">image_model.add(RepeatVector(CONTEXT_LENGTH))</div><div class="line"></div><div class="line">visual_input = Input(shape=input_shape)</div><div class="line">encoded_image = image_model(visual_input)</div><div class="line"></div><div class="line">language_model = Sequential()</div><div class="line">language_model.add(LSTM(128, return_sequences=True, input_shape=(CONTEXT_LENGTH, output_size)))</div><div class="line">language_model.add(LSTM(128, return_sequences=True))</div><div class="line"></div><div class="line">textual_input = Input(shape=(CONTEXT_LENGTH, output_size))</div><div class="line">encoded_text = language_model(textual_input)</div><div class="line"></div><div class="line">decoder = concatenate([encoded_image, encoded_text])</div><div class="line"></div><div class="line">decoder = LSTM(512, return_sequences=True)(decoder)</div><div class="line">decoder = LSTM(512, return_sequences=False)(decoder)</div><div class="line">decoder = Dense(output_size, activation=&apos;softmax&apos;)(decoder)</div><div class="line"></div><div class="line">self.model = Model(inputs=[visual_input, textual_input], outputs=decoder)</div><div class="line"></div><div class="line">optimizer = RMSprop(lr=0.0001, clipvalue=1.0)</div><div class="line">self.model.compile(loss=&apos;categorical_crossentropy&apos;, optimizer=optimizer)</div></pre></td></tr></table></figure>
<p>å…·ä½“åŸç†å‚è€ƒ<a href="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650728064&amp;idx=1&amp;sn=adb744e599299916faa23545c2ab436e&amp;chksm=871b22feb06cabe83ba0e3268a7a8c0c486cf6f42427ab41814e69242f919b25bc7de06ea258&amp;scene=21#wechat_redirect" target="_blank" rel="external">è®ºæ–‡ç¿»è¯‘</a>ã€‚</p>
<p>ç”Ÿæˆ DSL åï¼Œé€šè¿‡compilerç¼–è¯‘æˆä¸‰ç«¯ä»£ç  UI -&gt; DSL -&gt; Codeã€‚</p>
<p>å…¶ä¸­compileè¿‡ç¨‹ï¼Œå°±æ˜¯æ›¿æ¢DSLæè¿°åˆ°å®é™…æ§ä»¶çš„è¿‡ç¨‹ï¼Œè¿™äº›å®é™…æ§ä»¶çš„å±æ€§å’Œå¸ƒå±€ä½ç½®ä¿¡æ¯å…¨æ˜¯å†™æ­»çš„ï¼Œå­˜åœ¨æ”¾dsl-mappingæ–‡ä»¶ä¸­ï¼Œä»¥å…¶ä¸­ä¸€ä¸ªæ§ä»¶ä¸ºä¾‹ï¼Œå¯¹ç…§å…³ç³»å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;check&quot;: </div><div class="line">&quot;&lt;CheckBox android:id=\&quot;@+id/[ID]\&quot; </div><div class="line">	android:layout_width=\&quot;wrap_content\&quot; </div><div class="line">	android:layout_height=\&quot;wrap_content\&quot; </div><div class="line">	android:paddingRight=\&quot;10dp\&quot; </div><div class="line">	android:text=\&quot;[TEXT]\&quot;/&gt;&quot;,</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥pix2codeçš„æ ¸å¿ƒæ˜¯é€šè¿‡æœºå™¨å­¦ä¹ å¾—åˆ°å¯¹åº”å¸ƒå±€çš„DSLï¼Œcompiler æ˜¯è§„åˆ™æ›¿æ¢çš„è¿‡ç¨‹ã€‚</p>
<h1 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h1><p>pix2codeå…·æœ‰70%å·¦å³çš„å‡†ç¡®ç‡ï¼Œ åŸºäºè¯¥é¡¹ç›®ï¼Œè¥¿å®‰äº¤å¤§é€šè¿‡ä¸€äº›ä¼˜åŒ–ä½¿å‡†ç¡®ç‡è¿›ä¸€æ­¥æé«˜ã€‚</p>
<p><img src="https://raw.githubusercontent.com/w4lle/developnote/images/images4E51A20B-550F-4016-94FF-9C718DDA2B2F.png" alt=""></p>
<p>å‚è€ƒæ–‡ç«  <a href="https://www.jiqizhixin.com/articles/2018-11-05-12?from=synced&amp;keyword=pix2Code" target="_blank" rel="external">https://www.jiqizhixin.com/articles/2018-11-05-12?from=synced&amp;keyword=pix2Code</a></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>pix2codeé¡¹ç›®æœ¬èº«ä½œä¸ºä¸€ä¸ªå®éªŒæ€§è´¨çš„é¡¹ç›®ï¼Œè®ºè¯äº†GUIæˆªå›¾é€šè¿‡AIæ‰‹æ®µè‡ªåŠ¨ç”Ÿæˆå¸ƒå±€ä»£ç çš„å¯è¡Œæ€§ã€‚ </p>
<p>ä½†æ˜¯ç”±äºå…¶ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š </p>
<ul>
<li>æ¨¡å‹å‡†ç¡®ç‡ä¸é«˜ï¼Œä¿®æ”¹æ¨¡å‹æˆ–è€…é‡æ–°æ„å»ºæ¨¡å‹æˆæœ¬é«˜ </li>
<li>ä¸­é—´è¿‡ç¨‹ä¸å…è®¸äººå·¥å¹²é¢„ï¼Œå…¶ç»“æœå°±æ˜¯å®Œæ•´çš„DSLï¼Œäººå·¥å¹²é¢„æ˜¯åœ¨DSLç”Ÿæˆå </li>
<li>è®­ç»ƒç´ ææ ‡å‡†æˆæœ¬é«˜ï¼Œè¿™ä¹Ÿæ˜¯æ·±åº¦å­¦ä¹ éƒ½ä¼šç¢°åˆ°çš„ä¸€ä¸ªå®é™…é—®é¢˜ </li>
<li>åˆ‡å‰²ç²¾å‡†åº¦ä¸å¤Ÿï¼Œå®é™…ä¸Šå®ƒæ˜¯ä»¥CNNç½‘ç»œæå–å›¾ç‰‡ç‰¹å¾ï¼Œç²¾å‡†åº¦ä¸å¤§è¾¾åˆ°åƒç´ çº§åˆ«çš„è¦æ±‚ </li>
<li>æ§ä»¶ä½ç½®å’Œå±æ€§ä¿¡æ¯ç¼ºå¤±ï¼Œä¸èƒ½å‡†ç¡®è¿˜åŸå¸ƒå±€ </li>
</ul>
<p>åŸºäºä»¥ä¸Šè°ƒç ”åˆ†æï¼Œpix2codeé¡¹ç›®ä»…ä»…ä½œä¸ºä¸€ä¸ªç ”ç©¶æ€§é¡¹ç›®è¿›è¡Œå¼€æºï¼Œå¹¶ä¸èƒ½å®é™…ä½¿ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½œè€…æ˜ç¡®è¡¨è¿°è¯¥é¡¹ç›®å’Œè®ºæ–‡ä»…ä»…ä½œä¸ºå®éªŒï¼Œå¹¶ä¸”ä¸ä¼šå†è¿›è¡Œè¿›ä¸€æ­¥çš„å¹³å°æ‹“å±•ã€‚ </p>
<p>æˆ‘ä»¬å¯ä»¥æ¢ç´¢åœ¨pix2codeåŸºç¡€ä¸Šï¼Œé€šè¿‡å›¾åƒåˆ†æ+pix2codeæ§ä»¶è¯†åˆ« æ¥è¿›è¡ŒUI2Codeçš„å·¥ä½œã€‚ </p>
<p>åé¢ä¼šå»è°ƒç ”ä¸‹pixelToAppè¿™ä¸ªé¡¹ç›®ï¼Œå…¶åŸºäºä¼ ç»Ÿçš„è®¡ç®—æœºè§†è§‰è¯†åˆ«æŠ€æœ¯è¿›è¡Œä»£ç ç”Ÿæˆã€‚ </p>
<p>è®ºæ–‡ï¼š</p>
<p><a href="https://cs.anu.edu.au/courses/CSPROJECTS/18S2/initialTalks/u6013787.pdf" target="_blank" rel="external">UI Design to Code Skeleton</a></p>
<p>å‚è€ƒæ–‡ç« ï¼š</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650728064&amp;idx=1&amp;sn=adb744e599299916faa23545c2ab436e&amp;chksm=871b22feb06cabe83ba0e3268a7a8c0c486cf6f42427ab41814e69242f919b25bc7de06ea258&amp;scene=21#wechat_redirect" target="_blank" rel="external">æ·±åº¦å­¦ä¹ åŠ©åŠ›å‰ç«¯å¼€å‘ï¼šè‡ªåŠ¨ç”ŸæˆGUIå›¾ä»£ç </a></li>
<li><a href="https://www.jiqizhixin.com/articles/2018-12-29-5" target="_blank" rel="external">åŸºäºAIçš„ç§»åŠ¨ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶çš„è®¾è®¡</a> </li>
<li><a href="https://www.jiqizhixin.com/articles/2018-11-05-12?from=synced&amp;keyword=pix2Code" target="_blank" rel="external">å‰ç«¯è®¾è®¡å›¾è½¬ä»£ç ï¼Œè¥¿å®‰äº¤å¤§è¡¨ç¤ºå¤æ‚ç•Œé¢ä¹Ÿèƒ½ä¸€æ­¥æ­¥æå®š</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzIzNjc1NzUzMw==&amp;mid=2247496681&amp;idx=3&amp;sn=885b227400bdc8c81d74feffcb1b6c5c&amp;scene=0#wechat_redirect" target="_blank" rel="external">å‰ç«¯åˆ©å™¨ï¼è®©AIæ ¹æ®æ‰‹ç»˜åŸå‹ç”ŸæˆHTML | æ•™ç¨‹+ä»£ç </a></li>
<li><a href="https://medium.freecodecamp.org/how-you-can-train-an-ai-to-convert-your-design-mockups-into-html-and-css-cc7afd82fed4" target="_blank" rel="external">How you can train an AI to convert your design mockups into HTML and CSS</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2019/03/13/UI2Code-0/">http://w4lle.com/2019/03/13/UI2Code-0/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;pix2code é¡¹ç›®é€šè¿‡æœºå™¨å­¦ä¹ ï¼Œæ”¯æŒè¾“å…¥ä¸€å¼ å›¾ç‰‡è¾“å‡ºå®é™…çš„å¸ƒå±€ä»£ç ï¼ŒåŒæ—¶æ”¯æŒç”Ÿæˆä¸‰ç«¯(Androidã€iOSã€web)å¸ƒå±€ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;pix2codeä½œä¸ºUI2Codeçš„å…ˆé©±é¡¹ç›®ï¼Œåç»­çš„ç›¸å…³é¡¹ç›®æˆ–å¤šæˆ–å°‘çš„éƒ½æœ‰å‚è€ƒè¯¥é¡¹ç›®çš„å®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æœºå™¨å­¦ä¹ " scheme="http://w4lle.com/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>51ä¿¡ç”¨å¡ Android æ¶æ„æ¼”è¿›å®è·µ</title>
    <link href="http://w4lle.com/2018/11/16/51credit-android-architecture/"/>
    <id>http://w4lle.com/2018/11/16/51credit-android-architecture/</id>
    <published>2018-11-16T03:24:10.000Z</published>
    <updated>2019-11-15T07:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>éšç€ä¸šåŠ¡çš„å¿«é€Ÿæ‰©å¼ ï¼ŒåŸæœ¬å°ä½œåŠå¼çš„å•ä¸ªå·¥ç¨‹çš„å¼€å‘æ¨¡å¼è¶Šæ¥ä¸ä¸èƒ½æ»¡è¶³å®é™…éœ€æ±‚ã€‚æ—©åœ¨ä¸¤å¹´å¤šä»¥å‰ï¼Œ51ä¿¡ç”¨å¡ç®¡å®¶å°±å‘ä¸‹æ²‰æ·€å‡ºäº†å•ç‹¬çš„å…¬ç”¨åŸºç¡€åº“ï¼Œä¸€äº›é€šç”¨çš„åŠŸèƒ½ç»„ä»¶å’Œä¸ªåˆ«ç‹¬ç«‹çš„ä¸šåŠ¡è¢«æ‹†åˆ†æˆ SDKï¼Œå½¢æˆäº†ä¸€å¥—ä¸­å‹é¡¹ç›®ã€å¤šäººå¹¶è¡Œçš„å¼€å‘æ¨¡å¼ï¼Œä¹Ÿä¸ºæœªæ¥ç»„ä»¶åŒ–æ‹†åˆ†åšå‡†å¤‡ã€‚</p>
<a id="more"></a>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwi9479hnhj31g00uk49x.jpg" alt="image-20181023162224348"></p>
<p>è¿™å¥—æ¡†æ¶è¿è¡Œäº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¼´éšç€å•åº”ç”¨å†…ä¸šåŠ¡éœ€æ±‚çš„å¢åŠ ã€å¼€å‘äººå‘˜æ•°é‡çš„å¢å¤šã€åŸºç¡€åº“æ•°é‡çš„è†¨èƒ€ï¼Œå¯¼è‡´äº†ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>ä¸»å·¥ç¨‹ä»£ç è€¦åˆä¸¥é‡ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«</li>
<li>éœ€æ±‚æµ‹è¯•å½±å“é¢å¤§ï¼Œä¸èƒ½èšç„¦å•ä¸€ä¸šåŠ¡æ¨¡å—</li>
<li>ä¸»å·¥ç¨‹ä»£ç è¶Šæ¥è¶Šå¤šï¼Œç¼–è¯‘è€—æ—¶</li>
<li>ä¾èµ–å€’ç½®ï¼Œä¸šåŠ¡ä»£ç ä¾èµ–Appå·¥ç¨‹</li>
<li>SDK ç•Œé™æ¨¡ç³Šï¼ŒåŸºç¡€åº“å’Œä¸šåŠ¡åº“ç•Œé™ä¸æ˜ç¡®</li>
<li>ä¸šåŠ¡æ¨¡å—é—´å¯ä»¥ä»»æ„ä¾èµ–è°ƒç”¨ï¼Œä¾èµ–è§„åˆ™ä¸æ˜ç¡®</li>
<li>ç±»åº“è¶Šæ¥è¶Šå¤šï¼Œä¸å¥½ç®¡ç†</li>
</ul>
<p>é™¤äº†ä»¥ä¸Šé—®é¢˜ï¼ŒåŠ¨æ€åŒ–éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šå¼ºçƒˆï¼Œä¾èµ– Hybrid + H5 æ‰“å¼€é¡µé¢æ…¢çš„é—®é¢˜ä¹Ÿå‡¸æ˜¾å‡ºæ¥ã€‚</p>
<p>è¿™äº›é—®é¢˜æ¨åŠ¨æˆ‘ä»¬æ›´è¿›ä¸€æ­¥çš„å‡çº§å¼€å‘æ„æ¶ã€‚</p>
<h1 id="ç»„ä»¶åŒ–-or-æ’ä»¶åŒ–"><a href="#ç»„ä»¶åŒ–-or-æ’ä»¶åŒ–" class="headerlink" title="ç»„ä»¶åŒ– or æ’ä»¶åŒ–"></a>ç»„ä»¶åŒ– or æ’ä»¶åŒ–</h1><h2 id="åŠ¨æ€åŒ–"><a href="#åŠ¨æ€åŒ–" class="headerlink" title="åŠ¨æ€åŒ–"></a>åŠ¨æ€åŒ–</h2><p>æœ€è¿‘ä¸¤å¹´ï¼Œæ’ä»¶åŒ–æ¡†æ¶å±‚å‡ºä¸ç©·ï¼Œå„å¤§å‚éƒ½æ”¾å‡ºäº†è‡ªå®¶å¼€æºçš„æ’ä»¶åŒ–æ¡†æ¶ã€‚ä½œä¸º Native åŠ¨æ€åŒ–ä¸æ€§èƒ½å…¼é¡¾çš„æ’ä»¶åŒ–æ–¹æ¡ˆï¼Œå¾ˆå¤šå…¬å¸é€‰æ‹©æ’ä»¶åŒ–ä½œä¸ºåŠ¨æ€åŒ–æŠ€æœ¯æ–¹æ¡ˆã€‚åŠ¨æ€æ€§é€šå¸¸æœ‰ä¸¤éƒ¨åˆ†çš„ä½œç”¨ï¼šä¸€æ˜¯åŠ¨æ€çƒ­ä¿®å¤ï¼›äºŒæ˜¯åŠ¨æ€ä¸‹å‘ä¸šåŠ¡æ’ä»¶ã€‚å¯¹äºç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬æœ‰çƒ­ä¿®å¤æ¡†æ¶å¯ä»¥å®Œæˆè¿™éƒ¨åˆ†å·¥ä½œï¼›å¯¹äºç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Hybrid åŠ è½½H5çš„æ–¹å¼å®ç°ï¼Œè™½ç„¶æ€§èƒ½ä¸Šæœ‰æ‰€æ¬ ç¼ºï¼Œä½†å®Œå…¨åˆ‡åˆ° Native æ¥åšæœ‰ç‚¹æ¨å€’é‡æ¥çš„æ„æ€ï¼Œå¹¶ä¸”è·Ÿä¸šç•ŒåŒå­¦äº¤æµåï¼Œå¯¹äºåŠ¨æ€ä¸‹å‘ä¸šåŠ¡æ’ä»¶ç”¨åˆ°çš„æƒ…å†µä¹Ÿä¸å¤šï¼Œä¸šåŠ¡æ›´æ–°ä¸»è¦è¿˜æ˜¯ä¾é  App å‡çº§æ¥å®ç°ã€‚æŠ€æœ¯æ–¹æ¡ˆæ²¡æœ‰æœ€ä¼˜è§£ï¼Œé€‰æ‹©é€‚åˆè‡ªå·±çš„æ‰æ˜¯æœ€å¥½çš„ã€‚</p>
<p>ç”±äºæ’ä»¶åŒ–ä¹Ÿå­˜åœ¨ä¸€äº›å¼Šç«¯ï¼Œæ¯”å¦‚ä¸å¯é¿å…çš„ hook frameworkã€ä¿®æ”¹ aaptã€åŒ…è£… Gradle Pluginã€ä»£ç†ç»„ä»¶ç­‰ç­‰éå¸¸è§„æ“ä½œï¼Œæ—¥å¸¸ç»´æŠ¤ä¹Ÿæ˜¯ä¸€ç¬”ä¸å°çš„å¼€é”€ï¼Œç¨³å®šæ€§ã€å…¼å®¹æ€§ã€æ–°ç‰ˆæœ¬é€‚é…ç­‰ç­‰é—®é¢˜éƒ½éœ€è¦è€ƒè™‘è¿›å»ã€‚å¯¹äº Android ç«¯æ˜¯å¦ä½¿ç”¨æ’ä»¶åŒ–ï¼Œå…¬å¸å†…éƒ¨åšè¿‡ä¸€äº›è®¨è®ºï¼Œç»“è®ºæ˜¯ä¸æ€¥ç€ä¸Šï¼Œè¾¹èµ°è¾¹çœ‹ï¼Œå…ˆæŠŠä¸šåŠ¡ç»„ä»¶æ‹†åˆ†å‡ºæ¥å†è¯´ã€‚</p>
<p>å¦‚ä»Šå›è¿‡å¤´çœ‹ï¼Œè‡ªä» Android På‘å¸ƒä»¥æ¥ï¼Œé™åˆ¶ hook framework åï¼Œæ’ä»¶åŒ–é€æ¸å¼€å§‹å¼å¾®ï¼Œåé¢èµ°å‘å¤§æ¦‚ç‡æ˜¯ç»´æŠ¤æˆæœ¬è¶Šæ¥è¶Šé«˜ï¼Œæˆæœ¬æ”¶ç›Šæ¯”é€æ¸é™ä½ï¼Œæœ€ç»ˆå¼ƒå‘ä¸ç”¨ã€‚</p>
<p>é™¤äº†æ’ä»¶åŒ–å¤–ï¼ŒåŠ¨æ€åŒ–æ–¹æ¡ˆè¿‘ä¸¤å¹´æ¯”è¾ƒç«çš„å°±æ˜¯ä»¥ ReactNativeã€Weex ä¸ºä»£è¡¨çš„å¤§å‰ç«¯æ–¹å‘ï¼Œç»“åˆ51ä¿¡ç”¨å¡çš„å®é™…æƒ…å†µï¼Œæœ€ç»ˆé€‰æ‹©æ‹¥æŠ±å¤§å‰ç«¯ï¼Œ Weex ä½œä¸ºåŠ¨æ€åŒ–æ–¹æ¡ˆï¼Œä»¥ Native ä¸ºä¸»ï¼Œ Hybrid ç¦»çº¿åŒ–æ–¹æ¡ˆä¸ºè¾…ï¼ŒWeex é€æ­¥è¿­ä»£çš„æ¶æ„å¼€å‘æ¨¡å¼ã€‚</p>
<p>Weex çš„åŸºç¡€å»ºè®¾å’Œå‰ç«¯åŒå­¦åˆä½œï¼Œå†ç»å¤§åŠå¹´æ—¶é—´ï¼Œç›®å‰å·²ç»ç¨³å®šåº”ç”¨åœ¨51ä¿¡ç”¨å¡å„ä¸ª App ä¸Šï¼ŒWeex ä½œä¸ºåŠ¨æ€åŒ–é¡µé¢çš„é¦–é€‰æ–¹æ¡ˆï¼Œå·²ç»å®Œæˆäº†çº¿ä¸Šæ•°ç™¾ä¸ªé¡µé¢çš„å¼€å‘éœ€æ±‚ã€‚é…åˆç¦»çº¿åŒ–æ–¹æ¡ˆï¼Œå„é¡¹æ€§èƒ½æŒ‡æ ‡ä¹Ÿéƒ½è¾¾åˆ°è¦æ±‚ã€‚</p>
<h2 id="ç»„ä»¶åˆ†ç¦»"><a href="#ç»„ä»¶åˆ†ç¦»" class="headerlink" title="ç»„ä»¶åˆ†ç¦»"></a>ç»„ä»¶åˆ†ç¦»</h2><p>ä»£ç è§£è€¦ä¸ä»£ç éš”ç¦»ï¼Œæœ€æœ‰æ•ˆçš„æ–¹æ¡ˆæ˜¯å·¥ç¨‹éš”ç¦»ã€‚å®¡è§†æˆ‘ä»¬æœ€åˆçš„æ–¹æ¡ˆï¼Œæ¯ä¸ª SDK å¯¹åº”å•ç‹¬çš„ä»“åº“ï¼Œé€šè¿‡ maven ä¾èµ–ï¼Œé€šè¿‡å·¥ç¨‹åˆ†ç¦»éš”ç¦»ä»£ç ï¼Œè¿™ç§æ–¹æ¡ˆæ²¡æœ‰é—®é¢˜ï¼Œåªä¸è¿‡éœ€è¦å¾€å‰æ›´è¿‘ä¸€æ­¥ï¼Œå„ä¸ªä¸šåŠ¡æ¨¡å—ä¹Ÿéœ€è¦ç‹¬ç«‹ä¸»å·¥ç¨‹ï¼Œæ‹†åˆ†æˆç‹¬ç«‹çš„ä¸šåŠ¡ç»„ä»¶ã€‚</p>
<p>åŒæ—¶ï¼Œåˆ’åˆ†æ¸…æ¥šä»£ç è¾¹ç•Œï¼Œæ§åˆ¶ä¾èµ–å…³ç³»ï¼Œæ¢³ç†æ¸…æ¥šå±‚æ¬¡ç»“æ„ï¼Œæœ€ç»ˆå½¢æˆå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ¶æ„ã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwrpnjc8xdj31hc0u0gt5.jpg" alt="ç»„ä»¶åŒ–å±‚æ¬¡.001"></p>
<p>æ•´ä½“æ¶æ„ä¸Šæä¾›ä¸‰ç§å®¹å™¨ï¼š</p>
<ul>
<li>Native å®¹å™¨ï¼Œé‡‡ç”¨ç»„ä»¶åŒ–æ¶æ„ï¼Œç”¨äºåŸç”Ÿä¸šåŠ¡å¼€å‘</li>
<li>Hybrid å®¹å™¨ï¼Œwebview åŠ è½½ H5ï¼Œé…åˆç¦»çº¿åŒ–æ–¹æ¡ˆ</li>
<li>Weex å®¹å™¨ï¼Œç”¨äºç¼–å†™å¸¸è§„çš„é¡µé¢ï¼Œjs åŠ¨æ€è½¬åŒ–æˆ Native æ§ä»¶ï¼Œå¤©ç„¶å…·æœ‰åŠ¨æ€åŒ–ç‰¹æ€§ï¼Œé…åˆç¦»çº¿åŒ–æ–¹æ¡ˆï¼Œè¾¾åˆ°é¡µé¢ç§’å¼€çš„æ•ˆæœï¼ŒåŒæ—¶å…±ç”¨ Hybrid æ²‰æ·€å‡ºçš„æ¯”è¾ƒå®Œå–„çš„ PG æ–¹æ³•</li>
</ul>
<p>åŒæ—¶ï¼ŒHybrid å’Œ Weex ä¾èµ–äºåŸç”Ÿæä¾›çš„æ–¹æ³•ï¼Œé€šè¿‡ JsBridge è¿›è¡Œé€šä¿¡ï¼Œç›®å‰å…±æœ‰ 200 å¤šä¸ª PG æ–¹æ³•ä¾› js è°ƒç”¨ã€‚é•¿è¿œæ¥çœ‹ï¼Œè¿™ä¸‰ç§å®¹å™¨å¹¶ä¸ä¼šäº’ç›¸å–ä»£ï¼Œç›¸ååœ°ï¼Œå®ƒä»¬åº”è¯¥æ˜¯ç›¸äº’ä¾å­˜ã€å–é•¿è¡¥çŸ­ã€é•¿æœŸå…±å­˜çš„çŠ¶æ€ã€‚</p>
<h1 id="ç»„ä»¶åŒ–å®è·µ"><a href="#ç»„ä»¶åŒ–å®è·µ" class="headerlink" title="ç»„ä»¶åŒ–å®è·µ"></a>ç»„ä»¶åŒ–å®è·µ</h1><p>Native å®¹å™¨å¯¹åº”ä¸Šå›¾ä¸­å„ä¸ªå±‚çº§çš„å®šä¹‰ï¼š</p>
<ul>
<li>å·¥ç¨‹ Appï¼Œå„ä¸ªåº”ç”¨å·¥ç¨‹ï¼Œç›®å‰å·²æœ‰åå¤šä¸ªåº”ç”¨å¹¶è¡Œå¼€å‘ï¼Œ51ä¿¡ç”¨å¡ç®¡å®¶ä½œä¸ºå¹³å°åº”ç”¨ï¼Œå…¶ä½™åº”ç”¨ä¸ºç‹¬ç«‹çš„ä¸šåŠ¡å·¥ç¨‹åº”ç”¨</li>
<li>ä¸šåŠ¡ç»„ä»¶ï¼Œç‹¬ç«‹çš„ä¸šåŠ¡ç»„ä»¶ï¼Œä¸€èˆ¬ä¸ºå¤åˆä¸šåŠ¡ç»„ä»¶ï¼Œapi ä¸å®ç°åˆ†ç¦»ï¼Œç›¸äº’ä¹‹é—´ä¾èµ–éš”ç¦»</li>
<li>åŸºç¡€ä¸šåŠ¡ SDKï¼Œç‹¬ç«‹çš„å°çš„å•åŠŸèƒ½æ¨¡å—ï¼Œæä¾›åŸºç¡€åŠŸèƒ½ï¼Œç›®å‰è¿™ä¸€å±‚çº§ä¸­è¿˜åŒ…å«é—ç•™æœªæ”¹é€ çš„éƒ¨åˆ†ä¸šåŠ¡ç»„ä»¶</li>
<li>åŸºç¡€ Libï¼Œä¸šåŠ¡æ— å…³çš„åŸºç¡€ç»„ä»¶</li>
</ul>
<p>ç»„ä»¶åŒ–æ‹†åˆ†çš„æ ¸å¿ƒè¯‰æ±‚æ˜¯è§£è€¦åˆï¼Œæé«˜ç»„ä»¶å†…èšï¼Œæ‰€ä»¥åº”è¯¥ä»è¯‰æ±‚å‡ºå‘ï¼Œåœ¨æ²¿ç”¨å½“ä¸‹å¼€å‘æ¨¡å¼ï¼Œå¹¶ä¸”ä¸å¼ºä¾èµ–ç»„ä»¶åŒ–æ¡†æ¶çš„æƒ…å†µä¸‹ï¼Œé€æ¸çš„è¿›è¡Œç»„ä»¶åŒ–æ‹†åˆ†ã€‚</p>
<p>é€šè¿‡å·¥ç¨‹éš”ç¦»è¿›è€Œè¿›è¡Œç»„ä»¶åŒ–æ‹†åˆ†åï¼ŒåŸºæœ¬å¯ä»¥è§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ï¼š</p>
<ul>
<li>é«˜å†…èšï¼Œä½è€¦åˆï¼Œä»£ç è¾¹ç•Œæ¸…æ™°ï¼Œä»£ç å˜åŠ¨å½±å“é¢å¯ä»¥å‡†ç¡®è¯„ä¼°</li>
<li>æé«˜å¼€å‘æ•ˆç‡ï¼Œæ¯ä¸ªç»„ä»¶å¯ä»¥ç‹¬ç«‹æ‰“åŒ…ï¼Œå•ç‹¬è°ƒè¯•ï¼Œæœ€å¤šå‡ åç§’å°±å¯ä»¥å®Œæˆæ‰“åŒ…è¿‡ç¨‹</li>
<li>æ¯ä¸ªç»„ä»¶è´Ÿè´£ç»„ä»¶å†…çš„äº‹æƒ…ï¼Œç†è®ºä¸Šåªè¦ä¿è¯ç»„ä»¶å†…éƒ¨ç¨³å®šï¼Œæ¥å…¥å·¥ç¨‹ App åä¹Ÿä¸ä¼šäº§ç”Ÿæ–°çš„é—®é¢˜</li>
<li>é™ä½ App å·¥ç¨‹ç¼–è¯‘æ—¶é—´ï¼Œæœ€ç†æƒ³çš„æƒ…å†µæ˜¯ï¼ŒApp å·¥ç¨‹ä»…ä»…æ˜¯ä¸€ä¸ªç©ºå£³ï¼Œç”¨äºåŠ è½½å„ä¸ªç»„ä»¶</li>
</ul>
<p>è§£è€¦ï¼Œä¸€èˆ¬éœ€è¦é¿å…ç›´æ¥ä¾èµ–ï¼Œè½¬ä¸ºé—´æ¥ä¾èµ–ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¾èµ–éš”ç¦»ã€‚å¯¹äºç»„ä»¶åŒ–è€Œè¨€ï¼Œæ¯ä¸ªç»„ä»¶éƒ½æ˜¯å•ç‹¬çš„å®ç°ï¼Œå•ä¸ªç»„ä»¶å¯¹å¤–æä¾›çš„æœåŠ¡å°½å¯èƒ½å•ä¸€ï¼Œä¾èµ–å°½å¯èƒ½å°‘ï¼›åŒæ—¶ï¼Œä¾èµ–å…¶å®ƒç»„ä»¶åŠŸèƒ½æˆ–é¡µé¢çš„æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½é¿å…ç›´æ¥ä¾èµ–ï¼Œæœ€å¥½ä¾èµ–ä¸­é—´å±‚è¿›è¡Œé›†ä¸­å¼ç®¡ç†ï¼Œç„¶åå†è¿›è¡Œé€»è¾‘åˆ†å‘ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨åˆ†æ€»åˆ†çš„ç»“æ„ï¼šç»„ä»¶å†…éƒ¨åˆ†åˆ«æ³¨å†Œï¼Œç¼–è¯‘æ—¶ç”Ÿæˆæ±‡æ€»ä»£ç ã€è¿è¡Œæ—¶é›†ä¸­å¼ç®¡ç†ï¼Œè°ƒç”¨æ—¶å¤„ç†é€»è¾‘åˆ†å‘ã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwrpngbj7qj30yy0i4di0.jpg" alt="image-20181026181156315"></p>
<p>ç»„ä»¶åŒ–éœ€è¦è§£è€¦å¤„ç†çš„å‡ ä¸ªåŸºç¡€æ¨¡å—ï¼š</p>
<ul>
<li>é¡µé¢è·¯ç”±</li>
<li>æ¨¡å—é—´è°ƒç”¨</li>
<li>æ¶ˆæ¯æ€»çº¿</li>
<li>æ•°æ®æ€»çº¿</li>
</ul>
<p>ä¸‹é¢ä¾æ¬¡ä»‹ç»ã€‚</p>
<h2 id="é¡µé¢è·¯ç”±"><a href="#é¡µé¢è·¯ç”±" class="headerlink" title="é¡µé¢è·¯ç”±"></a>é¡µé¢è·¯ç”±</h2><p>è·¯ç”±åˆ†å‘æœ¬è´¨ä¸Šæ˜¯æŠŠç›´æ¥ä¾èµ–å¼•ç”¨è½¬åŒ–ä¸ºä¸­å¿ƒåŒ–ç®¡ç†åˆ†å‘çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œç”±äºç»„ä»¶åŒ–æ‹†åˆ†åï¼Œå„ä¸ªä¸šåŠ¡ç»„ä»¶é—´ä¸å­˜åœ¨ç›´æ¥çš„ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥å¿…ç„¶è¦æœ‰ä¸€ä¸ªç»Ÿä¸€æ”¶é›†é¡µé¢è·³è½¬è§„åˆ™è¿›è€Œå†åˆ†å‘çš„è¿‡ç¨‹ã€‚</p>
<p>51ä¿¡ç”¨å¡åœ¨ 2017 å¹´å°±åœ¨è¿›è¡Œè·¯ç”±åŒ–å®è·µï¼Œä»¥åº”å¯¹åé¢è¿›è¡Œçš„ç»„ä»¶åŒ–æ‹†åˆ†éœ€æ±‚ï¼Œå¹¶æ²‰æ·€å‡ºä¸€å¥—è‡ªç ”çš„è·¯ç”±æ¡†æ¶ U51OkDeepLinkï¼Œå®ƒä¹Ÿé‡‡ç”¨åˆ†æ€»åˆ†ç»“æ„ï¼Œä¸»è¦åŸç†æ˜¯ç»„ä»¶å†…æ³¨å†Œè·¯ç”±ï¼Œç¼–è¯‘æ—¶åœ¨ç»„ä»¶å†…ç”Ÿæˆç‹¬ç«‹çš„è·¯ç”±è¡¨ï¼Œå¹¶ç”¨ AOP åœ¨ç¼–è¯‘æ—¶åšå¥½æ‰€æœ‰ç»„ä»¶å†…è·¯ç”±è¡¨æ±‡æ€»çš„å·¥ä½œï¼Œè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•æ—¶è¿›è¡Œè·¯ç”±è¡¨æ±‡æ€»ï¼Œé¡µé¢è·³è½¬æ—¶å†è¿›è¡Œç®¡ç†åˆ†å‘ï¼Œå…¶ç”¨æ³•å¾ˆç®€å•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ç»„ä»¶å†…æ³¨å†Œè·¯ç”±</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SampleService</span> </span>&#123;</div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/main"</span>)</div><div class="line">    <span class="meta">@Activity</span>(MainActivity.class)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startMainActivity</span><span class="params">(@Query(<span class="string">"key"</span>)</span> String key)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å…¶ä½™ç»„ä»¶å”¤èµ·é¡µé¢</span></div><div class="line"><span class="keyword">new</span> DeepLinkClient(context).buildRequest(<span class="string">"old://app/main?key=value"</span>).addQuery(<span class="string">"key2"</span>, <span class="string">"2"</span>).start();</div></pre></td></tr></table></figure>
<p>å¹¶ä¸”æ”¯æŒå¼ºå¤§çš„å¼‚æ­¥ç‰¹æ€§ï¼Œæ”¯æŒè·³è½¬è¿‡ç¨‹ä¸­çš„ä¸­é—´é€»è¾‘å¤„ç†ã€‚</p>
<p>å…¶åŸç†å›¾å¦‚ä¸‹</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwrpnhjehsj31ju0uewka.jpg" alt="router"></p>
<p>æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯» <a href="https://www.jianshu.com/p/8a3eeeaf01e8" target="_blank" rel="external">Android ç»„ä»¶åŒ– â€”â€” è·¯ç”±è®¾è®¡æœ€ä½³å®è·µ</a> è·å–æ›´å¤šæŠ€æœ¯ç»†èŠ‚ã€‚</p>
<h2 id="æ¨¡å—é—´è°ƒç”¨"><a href="#æ¨¡å—é—´è°ƒç”¨" class="headerlink" title="æ¨¡å—é—´è°ƒç”¨"></a>æ¨¡å—é—´è°ƒç”¨</h2><p>ç»„ä»¶é—´å±‚æ¬¡å’Œè¾¹ç•Œæ¨¡ç³Šé—®é¢˜çš„äº§ç”Ÿï¼Œæ ¹æœ¬åŸå› æ˜¯å„ä¸ªä¸šåŠ¡ç»„ä»¶é—´çš„ç›¸äº’ä¾èµ–å…³ç³»æ··ä¹±ï¼Œä¸ºäº†è¿›è¡Œä¸šåŠ¡ç»„ä»¶é—´çš„éš”ç¦»ï¼Œé¦–å…ˆè¦åšå¥½ç»„ä»¶ä¹‹é—´çš„æœåŠ¡è°ƒç”¨è§£è€¦ã€‚</p>
<p>è¿™é‡Œé‡‡ç”¨çš„æ˜¯ ServiceLoader çš„æ¨¡å¼ï¼Œç»„ä»¶å·¥ç¨‹ç›®å½•ä¸€èˆ¬å¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwrpnfmr75j30bs052glm.jpg" alt="image-20181024204942179"></p>
<p>æ¯ä¸ªç»„ä»¶å†…ä¸€èˆ¬å£°æ˜ä¸‰ä¸ª moduleï¼š</p>
<ul>
<li>api moduleï¼Œå£°æ˜å¯¹å¤–æš´éœ²çš„æœåŠ¡æ¥å£å’Œå¯¹å¤–æš´éœ²çš„å®ä½“ç±»åŠ Event äº‹ä»¶</li>
<li>imp moduleï¼Œä¾èµ– api moduleï¼Œæ˜¯ api module çš„å…·ä½“å®ç°ï¼Œä¸å¯¹å¤–æš´éœ²ç»†èŠ‚ï¼Œä¸å…è®¸å…¶ä»–ç»„ä»¶å¯¹ imp module è¿›è¡Œç›´æ¥ä¾èµ–</li>
<li>app moduleï¼Œæ˜¯å·¥ç¨‹çš„å£³ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•ï¼Œé€šè¿‡ SDKTemplate åˆ›å»ºç”Ÿæˆï¼ŒåŒ…å«å„ç§è¿è¡Œæ—¶æ‰€éœ€ç¯å¢ƒ</li>
</ul>
<p>ä¸šåŠ¡ç»„ä»¶ä¹‹é—´ä¾èµ– api åº“çš„æœåŠ¡æ¥å£ï¼Œimp åº“ä½œä¸ºå®ç°åŠ¨æ€æŸ¥æ‰¾ã€‚ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼ŒåŒæ—¶å‘å¸ƒ api å’Œ imp ä¸¤ä¸ªåº“ï¼Œå¹¶ä¸”ä¿è¯ api å’Œ imp å…·æœ‰ç›¸åŒç‰ˆæœ¬å·ï¼Œè¿™ä¸ªåœ¨ç»„ä»¶å‘ç‰ˆæ—¶ç»Ÿä¸€ç®¡ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">//ç»„ä»¶å†… api module æ¥å£å£°æ˜</span></div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç»„ä»¶å†… imp module æ¥å£å®ç°</span></div><div class="line"><span class="meta">@ServiceImpl</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServiceImpl</span> <span class="keyword">implements</span> <span class="title">TestService</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è·¨ç»„ä»¶è°ƒç”¨</span></div><div class="line">compile <span class="string">'com.u51.android:test-lib-api:$version'</span></div><div class="line"></div><div class="line">CommentService service = ServicesLoader.getInstance().getService(TestService.class);</div><div class="line">service.sayHello();</div></pre></td></tr></table></figure>
<p>å®ƒçš„å®ç°åŸç†ä¸è·¯ç”±ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é‡‡ç”¨åˆ†æ€»åˆ†ç»“æ„ï¼Œåœ¨ç¼–è¯‘æ—¶é€šè¿‡ APT ç”Ÿæˆæ±‡æ€»ä»£ç ï¼Œè°ƒç”¨æ—¶åŠ¨æ€æŸ¥æ‰¾æ³¨å…¥ Service åŠå…¶å®ç°ç±»çš„ç»‘å®šå…³ç³»ã€‚</p>
<p>ä¸è·¯ç”±åˆå§‹åŒ–æ±‡æ€»è·¯ç”±è¡¨ä¸åŒçš„æ˜¯ï¼ŒServiceLoader åœ¨è°ƒç”¨æ—¶æŸ¥æ‰¾ï¼Œçœå»äº†åˆå§‹åŒ–çš„é€»è¾‘ï¼ŒService ä¸ä¼šåƒè·¯ç”±è¿™ä¹ˆå¤šï¼ŒæŸ¥æ‰¾èµ·æ¥ä¸ä¼šå­˜åœ¨éå†å¤ªæ…¢çš„é—®é¢˜ã€‚</p>
<h2 id="æ¶ˆæ¯æ€»çº¿"><a href="#æ¶ˆæ¯æ€»çº¿" class="headerlink" title="æ¶ˆæ¯æ€»çº¿"></a>æ¶ˆæ¯æ€»çº¿</h2><p>æ¶ˆæ¯æ€»çº¿æ˜¯åŸºäº <a href="https://github.com/greenrobot/EventBus" target="_blank" rel="external">EventBus</a> å®ç°çš„è·¨ä¸‰ç«¯ï¼ˆNativeã€Hybridã€Weexï¼‰äº‹ä»¶ç®¡ç†åˆ†å‘ç»„ä»¶ U51EventBusã€‚è·¨ä¸‰ç«¯æ˜¯æŒ‡åœ¨ä»»æ„ä¸€ç«¯æ³¨å†Œç›‘å¬åï¼Œåœ¨äº‹ä»¶è§¦å‘æ—¶éƒ½å¯ä»¥å¾—åˆ°å“åº”ã€‚</p>
<p>å¯¹äºåŸç”Ÿå¼€å‘æ¥è¯´ï¼ŒEventBus æœ¬èº«å¯ä»¥æ»¡è¶³éœ€æ±‚ï¼Œè™½ç„¶æœ‰ç‚¹äº‹ä»¶æ»¡å¤©é£çš„ç¼ºç‚¹ï¼Œä½†æ˜¯è¿˜åœ¨å¯æ¥å—èŒƒå›´ä¹‹å†…ã€‚å¯¹äºä¸šåŠ¡ç»„ä»¶æ¥è¯´ï¼Œå…¶ Event ç±»éœ€è¦æ”¾åœ¨ api module ä¸­è¿›è¡Œæš´éœ²ã€‚</p>
<p>å¯¹äº Hybrid å’Œ Weex æ¥è¯´ï¼Œä¸€èˆ¬çš„ bridge éƒ½æ˜¯ callback å½¢å¼å¾—åˆ°å¼‚æ­¥å“åº”ï¼Œå¯¹äºå…¨å±€äº‹ä»¶é€šçŸ¥æ”¯æŒä¸å¤ªå‹å¥½ã€‚é€šè¿‡ bridge é€šé“è¿æ¥ U51EventBus æ¶ˆæ¯æ€»çº¿ï¼Œæ‰“é€šè·¨ä¸‰ç«¯å…¨å±€çš„äº‹ä»¶ç›‘å¬åŠåˆ†å‘ï¼Œå¾—ä»¥å®ç°ä»»æ„äº‹ä»¶å¯ä»¥åœ¨ Nativeã€H5ã€Weex ä¹‹é—´ç›¸äº’å‘é€å’Œç›‘å¬ã€‚æ¯”å¦‚ï¼Œç±»ä¼¼ç™»é™†ã€ç™»å‡ºæ“ä½œåœ¨ Native å‘å‡ºåï¼Œå…¨å±€å·²æ‰“å¼€çš„ H5 æˆ– Weex é¡µé¢å¯ä»¥ç«‹å³å¾—åˆ°æ„ŸçŸ¥ã€‚</p>
<p>å…¶å®ç°åŸç†ä¹Ÿæ˜¯é‡‡ç”¨åˆ†æ€»åˆ†ç»“æ„ï¼Œåœ¨ç¼–è¯‘æ—¶å¯¹ EventBus è¿›è¡Œäº†å®šåˆ¶å°è£…ï¼Œäº‹ä»¶åˆ†å‘è¿˜æ˜¯ä½¿ç”¨çš„åŸæœ‰çš„ EventBus åˆ†å‘é€»è¾‘ã€‚</p>
<h2 id="æ•°æ®æ€»çº¿"><a href="#æ•°æ®æ€»çº¿" class="headerlink" title="æ•°æ®æ€»çº¿"></a>æ•°æ®æ€»çº¿</h2><p>æ•°æ®å­˜å‚¨é‡‡ç”¨åŸºäº <a href="https://developer.android.com/topic/libraries/architecture/room" target="_blank" rel="external">Room</a> å®ç°çš„ç»Ÿä¸€ KV å­˜å‚¨æ¡†æ¶ï¼Œåº•å±‚æ•°æ®åº“ä¾ç„¶æ˜¯ sqliteï¼Œæ€§èƒ½è¿™å—æ²¡æœ‰åšç‰¹åˆ«å¼ºè°ƒï¼Œå¼ºåˆ¶å…¶åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œæ“ä½œï¼Œç”¨äºæ”¯æŒæ—¥å¸¸å¼€å‘ä¸­é…ç½®å’Œä¸šåŠ¡æ•°æ®çš„å­˜å–æ“ä½œã€‚</p>
<p>å¦å¤–ï¼Œæ•°æ®æ€»çº¿æ”¯æŒæŒ‰æ¨¡å—è¿›è¡Œå­˜å–ï¼Œæ¯ä¸ªä¸šåŠ¡ç»„ä»¶éƒ½å¯ä»¥å®šä¹‰è‡ªæœ‰ tagï¼Œé¿å…å­—æ®µå†²çªé—®é¢˜ã€‚</p>
<h1 id="è·¨å¹³å°æ··åˆå¼€å‘å®è·µ"><a href="#è·¨å¹³å°æ··åˆå¼€å‘å®è·µ" class="headerlink" title="è·¨å¹³å°æ··åˆå¼€å‘å®è·µ"></a>è·¨å¹³å°æ··åˆå¼€å‘å®è·µ</h1><p>æ— è®ºä»æ—©æœŸçš„ PhoneGapã€Cordovaï¼Œè¿˜æ˜¯è¿‘å¹´æ¥æ¯”è¾ƒç«çš„ ReactNativeã€Weexï¼Œåˆ°æœ€è¿‘ä¸¤å¹´å´›èµ·çš„ Flutterï¼Œè·¨å¹³å°æ··åˆå¼€å‘ä¸€ç›´æ·±å—ä¼—å¤šå¼€å‘é’çã€‚ç©¶å…¶åŸå› ï¼Œè¿˜æ˜¯å…¶è·¨å¹³å°å’ŒåŠ¨æ€åŒ–æ˜¯åŸç”Ÿå¼€å‘æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§ã€‚</p>
<h2 id="Hybrid-å®¹å™¨å®è·µ"><a href="#Hybrid-å®¹å™¨å®è·µ" class="headerlink" title="Hybrid å®¹å™¨å®è·µ"></a>Hybrid å®¹å™¨å®è·µ</h2><p>Native å’Œ H5 æ··åˆå¼€å‘ä¸€èˆ¬æ˜¯æ¯”è¾ƒå¸¸è§çš„æ··åˆå¼€å‘æ¨¡å¼ï¼ŒH5 å¼€å‘æ•ˆç‡é«˜ã€è¿­ä»£å¿«é€Ÿã€ä¸ä¾èµ– App å‘ç‰ˆï¼Œ51ä¿¡ç”¨å¡ä¼—å¤š App äº§å“ä¸­ï¼Œæœ‰å¾ˆå¤šé¡µé¢éƒ½æ˜¯ç”¨ H5 æ¥å¼€å‘ï¼ŒåµŒå…¥åŸç”Ÿ App ä¸­ä½¿ç”¨ webview è¿›è¡ŒåŠ è½½æ˜¾ç¤ºã€‚</p>
<p>æ—©æœŸ H5 å®¹å™¨åœ¨å„ä¸ª App ä¸­åˆ†åˆ«ç‹¬ç«‹å®ç°ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„æ¶æ„å’Œè§„èŒƒï¼Œå¯¼è‡´å¯¹ H5 çš„æ”¯æŒæ•ˆç‡è¾ƒä½ï¼ŒPG æ–¹æ³•ï¼ˆæ¥æºäº PhoneGapï¼‰çš„å¼€å‘ã€æµ‹è¯•å’Œç»´æŠ¤éƒ½ç›¸å½“çš„æ··ä¹±ï¼Œé‡å¤æ€§å·¥ä½œå¤ªå¤šã€‚</p>
<p>Native å±‚æä¾›ä¸€å¥—é€šç”¨æ€§å¼ºã€åŠŸèƒ½ä¸°å¯Œã€ç¨³å®šæ€§é«˜çš„ H5 å®¹å™¨å¯¹ä¸šåŠ¡çš„é«˜é€Ÿå‘å±•è‡³å…³é‡è¦ã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwxgmjrohtj31kw0zkwth.jpg" alt="image-20181105173903973"></p>
<h3 id="æ’ä»¶ç®¡ç†"><a href="#æ’ä»¶ç®¡ç†" class="headerlink" title="æ’ä»¶ç®¡ç†"></a>æ’ä»¶ç®¡ç†</h3><p>ç”±äº H5 ä¸å…·å¤‡ç›´æ¥è°ƒç”¨åŸç”Ÿæ–¹æ³•ï¼Œæ‰€ä»¥åŸç”Ÿå£³è¦æä¾›ä¸€å¥—é€šç”¨çš„é€šä¿¡æ–¹å¼ï¼Œä¸€èˆ¬ä¸º JsBridgeï¼Œåœ¨ Android ç«¯ï¼Œå®ç° JsBridge é€šä¿¡çš„é€šé“ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>shouldOverrideUrlLoading</li>
<li>addJavascriptInterface</li>
<li>onJsPrompt/onJsAlert</li>
</ul>
<p>è€Œé€šé“ä¸æ˜¯å…³é”®ï¼Œæ€æ ·ç®¡ç†å’Œç»´æŠ¤ PG æ–¹æ³•è°ƒç”¨æ‰æ˜¯æ ¸å¿ƒã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æŠŠæ¯ä¸ªæ–¹æ³•å®šä¹‰ä¸ºä¸€ä¸ª Pluginï¼Œç”¨æ’ä»¶çš„å½¢å¼ç®¡ç† PG æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥åšåˆ°æ¯ä¸ªæ’ä»¶ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚æ’ä»¶ç®¡ç†ä¹Ÿæ˜¯é‡‡ç”¨åˆ†æ€»åˆ†ç»“æ„ï¼Œåœ¨å„ä¸ªä¸šåŠ¡ç»„ä»¶ä¸­åˆ†åˆ«æ³¨å†Œï¼Œç¼–è¯‘æ˜¯é€šè¿‡ APT ç”Ÿæˆæ±‡æ€»ä»£ç ï¼Œè¿è¡Œæ—¶è¿›è¡Œæ’ä»¶æ±‡æ€»ï¼Œæœ€åè°ƒç”¨é€šè¿‡ PluginManager æŸ¥æ‰¾åˆ†å‘é€»è¾‘ã€‚</p>
<p>æ’ä»¶æ³¨å†Œä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ <code>onExecute()</code> æ–¹æ³•åœ¨ js è°ƒç”¨è¯¥æ–¹æ³•æ—¶è§¦å‘ï¼Œæ‰§è¡Œç»“æœé€šè¿‡ <code>evaluateJavaScript()</code> æ–¹æ³•å¼‚æ­¥è¿”å›ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@JsPlugin</span>(name = TestPlugin.PLUGIN_NAME, loadOnInit = <span class="keyword">false</span>, version = <span class="number">1</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPlugin</span> <span class="keyword">extends</span> <span class="title">EnNiuJsPlugin</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PLUGIN_NAME = <span class="string">"TestPlugin"</span>;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPluginName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PLUGIN_NAME;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onExecute</span><span class="params">(String args)</span> </span>&#123;</div><div class="line">        doSomething();                    </div><div class="line">        callbackContext.callback(...);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼ŒH5 å®¹å™¨å’Œæ’ä»¶éƒ½å…·æœ‰ Activity ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥èƒ½åŠ›ï¼Œæ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwxgmhf6r9j31kw16eas1.jpg" alt="image-20181105191433330"></p>
<h3 id="é…å¥—è®¾æ–½"><a href="#é…å¥—è®¾æ–½" class="headerlink" title="é…å¥—è®¾æ–½"></a>é…å¥—è®¾æ–½</h3><p>æ’ä»¶ç»Ÿä¸€é€šè¿‡æ’ä»¶ç®¡ç†å¹³å°è¿›è¡Œç»´æŠ¤ç®¡ç†ï¼Œç›®å‰å·²æœ‰200+æ’ä»¶ã€‚PG æ’ä»¶ä½œä¸ºåŸºç¡€é€šç”¨åŠŸèƒ½ï¼Œé‡‡å–é›†ä¸­å¼ç®¡ç†æœºåˆ¶ï¼Œä»»ä½•äººåœ¨æ–°å¢ã€ä¿®æ”¹æ’ä»¶éƒ½éœ€è¦è¿›è¡Œç›¸å…³è´Ÿè´£äººå®¡æ ¸ï¼Œä»¥é¿å…å‡ºç° Androidã€iOS ä¸¤ç«¯å®ç°ä¸ç»Ÿä¸€ï¼Œç‰ˆæœ¬é—´å®ç°ä¸ç»Ÿä¸€ç­‰é—®é¢˜ã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwxgmi1nm7j31kw0ebdl6.jpg" alt="image-20181105191949792"></p>
<p>æ’ä»¶è°ƒè¯•é€šè¿‡è°ƒè¯•å¹³å°è¿›è¡Œæ“ä½œï¼Œæµè§ˆå™¨ä¸­æ‰“å¼€è°ƒè¯•åœ°å€ï¼ŒApp ç«¯é€šè¿‡è°ƒè¯•å·¥å…·æ‰«ç å»ºç«‹è¿æ¥ï¼Œå³å¯è¿›è¡Œæ’ä»¶è°ƒè¯•ã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwxgmiq9l1j31kw110thw.jpg" alt="image-20181105192429943"></p>
<h3 id="ç¦»çº¿åŠ è½½"><a href="#ç¦»çº¿åŠ è½½" class="headerlink" title="ç¦»çº¿åŠ è½½"></a>ç¦»çº¿åŠ è½½</h3><p>Hybrid æ··åˆå¼€å‘çš„ä¸€å¤§åŠ£åŠ¿å°±æ˜¯æ€§èƒ½æ¯”è¾ƒå·®ï¼Œæ‰“å¼€é¡µé¢è¾ƒæ…¢ï¼Œç‰¹åˆ«æ˜¯åœ¨å¼±ç½‘æƒ…å†µä¸‹ã€‚ç”±äº51ä¿¡ç”¨å¡ä¸šåŠ¡å¤§éƒ¨åˆ†éƒ½æ˜¯é™æ€èµ„æºè¯·æ±‚ï¼Œå‚è€ƒä¸šç•Œåšæ³•ï¼Œæˆ‘ä»¬å®ç°äº†åŠ¨æ€ä¸‹å‘ç¦»çº¿åŒ…çš„æ–¹å¼æ¥æå‡H5é¡µé¢æ‰“å¼€é€Ÿåº¦ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwxgmkmdnlj31ca12wn45.jpg" alt="lixianbao"></p>
<p>è¿™é‡Œç»†èŠ‚é—®é¢˜ä¸å…·ä½“å±•å¼€ã€‚</p>
<p>é™¤äº†ä»¥ä¸Šæåˆ°çš„å®è·µå¤–ï¼Œæˆ‘ä»¬è¿˜åšäº†å¾ˆå¤šå·¥ä½œï¼Œæ¯”å¦‚ UI ç»Ÿä¸€ã€Back é”®æ‹¦æˆªã€å…¬å…±å‚æ•°å¤„ç†ã€PG ç™½åå•æœºåˆ¶ã€H5ç›‘æ§ã€PG æ–¹æ³•ç›‘æ§ç­‰ç­‰ï¼Œé™äºæ–‡ç« ç¯‡å¹…ï¼Œè¿™é‡Œä¸å†ä¸€ä¸€åˆ—å‡ºï¼Œæ•¬è¯·å…³æ³¨åç»­ç›¸å…³æ–‡ç« ã€‚</p>
<h2 id="Weex-å®¹å™¨å®è·µ"><a href="#Weex-å®¹å™¨å®è·µ" class="headerlink" title="Weex å®¹å™¨å®è·µ"></a>Weex å®¹å™¨å®è·µ</h2><p>åœ¨ Hybrid å·²æœ‰é…å¥—åŸºç¡€ä¸Šï¼Œ51ä¿¡ç”¨å¡é€‰æ‹©äº† Weex ä½œä¸ºè·¨å¹³å°æ–¹æ¡ˆï¼Œç»è¿‡ä¸€å¹´çš„è¸©å‘å¡«å‘è¿‡ç¨‹ï¼Œç›®å‰å·²ç»æœ‰ 20+ ä¸ªé¡¹ç›®ã€æ•°ç™¾ä¸ª Weex é¡µé¢åœ¨çº¿ä¸Šç¨³å®šè¿è¡Œï¼Œå¹¶ä¸”ï¼Œç›®å‰ Weex æ–¹æ¡ˆè¶‹äºæˆç†Ÿï¼Œå·²ç»ä½œä¸º51ä¿¡ç”¨å¡ç«¯å†…é¦–é€‰ä¸šåŠ¡æ–¹æ¡ˆã€‚</p>
<h3 id="å…±äº«æ’ä»¶"><a href="#å…±äº«æ’ä»¶" class="headerlink" title="å…±äº«æ’ä»¶"></a>å…±äº«æ’ä»¶</h3><p>ç”±äº Hybrid è‰¯å¥½çš„é¢å‘æ¥å£ç¼–ç¨‹ç‰¹æ€§ï¼Œåœ¨è¿›è¡Œ Weex åŸºç¡€å»ºè®¾è¿‡ç¨‹ä¸­ï¼Œå¾ˆæ–¹ä¾¿çš„å°±æŠŠå·²æœ‰çš„æ’ä»¶é›†æˆè¿›æ¥ï¼Œå¹¶ä¸”å…±äº«å·²æ²‰æ·€çš„é…å¥—è®¾æ–½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ENBridgeModule</span> <span class="keyword">extends</span> <span class="title">WXModule</span> </span>&#123;</div><div class="line">    <span class="meta">@JSMethod</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String method, String args, JSCallback jsCallback)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        weexWebView = weexEngine.getWeexVirtualWebView();</div><div class="line">        EnNiuJsBridge enNiuJsBridge = weexWebView.getEnNiuJsBridge();</div><div class="line">        enNiuJsBridge.notify(pg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨å†Œ Weex çš„ Moduleï¼Œå¹¶ä¸”æ¯ä¸ª Weex Engine ä¸­ä¼šæ–°å»ºå‡ºä¸€ä¸ªè™šæ‹Ÿ webviewï¼Œç”¨äºæ¡¥æ¥ JsBridge è¿›è€Œè°ƒç”¨ PluginManager è¿›è¡Œæ’ä»¶é€»è¾‘åˆ†å‘ã€‚</p>
<p>Weex å®¹å™¨å®è·µåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å·²ç»æåˆ°è¿‡ä¸€éƒ¨åˆ†ï¼Œå…·ä½“è¯·çœ‹ <a href="https://mp.weixin.qq.com/s/PSquf5ILDykC9jYFu911qg" target="_blank" rel="external">Weexé¿å‘æŒ‡å—-ç†è®ºç¯‡ </a>ï¼Œåç»­è¿˜å°†æœ‰ Weex å®è·µç›¸å…³çš„æ–‡ç« æ”¾å‡ºï¼Œè¿™é‡Œä¸åšè¿‡å¤šç¯‡å¹…çš„ä»‹ç»ï¼Œæ•¬è¯·å…³æ³¨åç»­ç›¸å…³æ–‡ç« ã€‚</p>
<h1 id="å·¥ç¨‹åŒ–å®è·µ"><a href="#å·¥ç¨‹åŒ–å®è·µ" class="headerlink" title="å·¥ç¨‹åŒ–å®è·µ"></a>å·¥ç¨‹åŒ–å®è·µ</h1><p>å·¥ç¨‹åŒ–æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†æé«˜ç ”å‘æ•ˆç‡ã€‚51ä¿¡ç”¨å¡å®¢æˆ·ç«¯å›¢é˜Ÿè‡ªç ”çš„å¤§é£è½¦ç®¡ç†å¹³å°ï¼Œç”¨äº App ç®¡ç†ã€æŒç»­é›†æˆã€ç±»åº“ç®¡ç†ã€å‘ç‰ˆç®¡ç†ç­‰ï¼Œå›´ç»•å®¢æˆ·ç«¯ç ”å‘ä¸Šä¸‹æ¸¸æµç¨‹ï¼Œå»ºç«‹ç»Ÿä¸€çš„ç®¡ç†å…¥å£ã€‚</p>
<p>ç›®å‰ï¼Œ51ä¿¡ç”¨å¡ iOS å’Œ Android å…± 30 å¤šä¸ªåº”ç”¨ Appã€ 200 å¤šä¸ªç±»åº“ä¾æ‰˜å¤§é£è½¦å¹³å°è¿›è¡Œç®¡ç†ã€‚ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹ç±»åº“ç®¡ç†ç›¸å…³å†…å®¹ã€‚</p>
<h2 id="ç±»åº“ç®¡ç†"><a href="#ç±»åº“ç®¡ç†" class="headerlink" title="ç±»åº“ç®¡ç†"></a>ç±»åº“ç®¡ç†</h2><p>51ä¿¡ç”¨å¡ç›®å‰æœ‰ 100 å¤šä¸ª Android ç±»åº“ï¼Œæ¯ä¸ªç±»åº“å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ Gitlab ä»“åº“ã€‚è¿‡å¤šçš„ç‹¬ç«‹ç»„ä»¶åŠç‹¬ç«‹ä»“åº“ï¼Œç®¡ç†èµ·æ¥æœ‰äº›éº»çƒ¦ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwrpnk3uc9j31kw0scaj6.jpg" alt="image-20181030193630574"></p>
<p>ä¾æ‰˜äºå¤§é£è½¦å¹³å°ï¼Œæ‰€æœ‰ç±»åº“çš„åç§°ã€æœ€æ–°ç‰ˆæœ¬åŠæ ‡ç­¾ç±»å‹éƒ½ä¼šå±•ç¤ºåœ¨åˆ—è¡¨é¡µï¼Œæ ‡ç­¾ç±»å‹å¯¹åº”ç»„ä»¶åŒ–æ¶æ„çš„å±‚æ¬¡ç»“æ„ï¼ŒåŒ…æ‹¬ï¼šåŸºç¡€ç»„ä»¶ã€å•ä¸šåŠ¡åŠŸèƒ½ç»„ä»¶ã€å¤šä¸šåŠ¡åŠŸèƒ½ç»„ä»¶ã€‚</p>
<p>åœ¨ç±»åº“è¯¦æƒ…é¡µï¼Œä¼šæœ‰åº“çš„åŠŸèƒ½æè¿°ã€groupId:artifactId ä¾èµ–ä¿¡æ¯ã€ç‰ˆæœ¬å†å²è®°å½•ã€åˆ†æ”¯ä¿¡æ¯ã€READMEã€CHANGELOGã€è´Ÿè´£äººç­‰è¯¦æƒ…ä¿¡æ¯ã€‚</p>
<p>æ‰€æœ‰çš„ç±»åº“ç®¡ç†å·¥ä½œéƒ½å¯ä»¥åœ¨å¤§é£è½¦å®Œæˆï¼ŒåŒ…æ‹¬æ–°å»ºç±»åº“ã€ç±»åº“å‘ç‰ˆã€æŸ¥é˜…ç›¸å…³ä¿¡æ¯ç­‰ç­‰ï¼Œè¿™å¤§å¤§æé«˜äº†åŸºç¡€ç»„çš„ç ”å‘æ•ˆç‡ï¼Œé™ä½äº†å›¢é˜Ÿé—´çš„æ²Ÿé€šæˆæœ¬ã€‚</p>
<p>å¹¶ä¸” App å·¥ç¨‹ä¸­ï¼Œè¯¥ App æ‰€ä¾èµ–çš„æ‰€æœ‰ç±»åº“ä¿¡æ¯ä¸€ç›®äº†ç„¶ï¼Œåœ¨å¤šäººç»´æŠ¤ã€å¤šç±»åº“å¹¶è¡Œå¼€å‘ã€ç±»åº“é¢‘ç¹å‘ç‰ˆçš„æƒ…å†µä¸‹ï¼Œä¾èµ–ç±»åº“ä¿¡æ¯ check æ›´åŠ ä¾¿æ·ã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwrpng2bwcj31kw1540z0.jpg" alt="image-20181031160854953"></p>
<h2 id="ç‰ˆæœ¬ç®¡ç†"><a href="#ç‰ˆæœ¬ç®¡ç†" class="headerlink" title="ç‰ˆæœ¬ç®¡ç†"></a>ç‰ˆæœ¬ç®¡ç†</h2><p>ç”±äºç±»åº“ä¹‹é—´æ˜¯ä»“åº“éš”ç¦»ï¼Œæ‰€ä»¥å®ƒä»¬çš„ä¾èµ–å…³ç³»æ˜¯ maven ä¾èµ–ï¼Œæ‰€æœ‰ç±»åº“çš„ aar åŒ…éƒ½éœ€è¦å‘å¸ƒåˆ°å†…éƒ¨ maven æœåŠ¡å™¨ä¸Šï¼Œä¸Šä¼ å·¥ä½œç”± PublishMavenPlugin å®Œæˆã€‚</p>
<h3 id="SNAPSHOT-é¢„è§ˆç‰ˆ"><a href="#SNAPSHOT-é¢„è§ˆç‰ˆ" class="headerlink" title="SNAPSHOT é¢„è§ˆç‰ˆ"></a>SNAPSHOT é¢„è§ˆç‰ˆ</h3><p>å¯¹äºå¼€å‘è°ƒè¯•é˜¶æ®µï¼Œæ¯ä¸ªç±»åº“è‡ªå¸¦ DemoApp å·¥ç¨‹ï¼Œæ‰€ä»¥é‡‡ç”¨æºç ä¾èµ–ï¼›å¼€å‘å®Œæˆåï¼Œç±»åº“ä½¿ç”¨<code>SNAPSHOT</code>ç‰ˆæœ¬ï¼ˆæ¯”å¦‚ 1.0.0-SNAPSHOTï¼‰å‘å¸ƒåˆ° maven æœåŠ¡å™¨ï¼Œæ¥å…¥ App å·¥ç¨‹å push ä»£ç è§¦å‘å¤§é£è½¦æ‰“åŒ…ï¼Œè¿›è¡Œé›†æˆæµ‹è¯•ã€‚éœ€è¦ä¿®æ”¹ç±»åº“æ—¶ï¼Œå¯ä»¥å†é‡å¤å‘å¸ƒç›¸åŒç‰ˆæœ¬çš„<code>SNAPSHOT</code>ç‰ˆæœ¬ã€‚</p>
<p><code>SNAPSHOT</code>ç‰ˆæœ¬å¯ä»¥åœ¨å¼€å‘åŒå­¦è‡ªå·±çš„æœºå™¨ä¸Šè¿›è¡Œæ‰“åŒ…å‘å¸ƒã€‚</p>
<h3 id="æ­£å¼ç‰ˆ"><a href="#æ­£å¼ç‰ˆ" class="headerlink" title="æ­£å¼ç‰ˆ"></a>æ­£å¼ç‰ˆ</h3><p>å¯¹äºå‘å¸ƒé˜¶æ®µï¼Œç±»åº“å¿…é¡»ä½¿ç”¨æ­£å¼ç‰ˆæœ¬å‘å¸ƒï¼Œç”±äºæ­£å¼ç‰ˆæœ¬ä¸å¯é‡å¤å‘å¸ƒï¼Œè¿™ä¹Ÿå°±è¦æ±‚å¼€å‘åŒå­¦ä¿è¯æ¯ä¸ªæ­£å¼ç‰ˆæœ¬çš„ç‰ˆæœ¬è´¨é‡ï¼Œåœ¨æ­£å¼å‘å¸ƒå‰éƒ½åº”è¾¾åˆ°å‘å¸ƒæ ‡å‡†ã€‚</p>
<p>ç”±äºç±»åº“å†…éƒ¨ä¹Ÿå­˜åœ¨ç›¸äº’ä¾èµ–çš„æƒ…å†µï¼Œæ‰€ä»¥åœ¨ç±»åº“æ­£å¼å‘å¸ƒæ—¶ï¼Œä¸å…è®¸ä¾èµ–åŒ…å«<code>SNAPSHOT</code>ç‰ˆæœ¬çš„ç±»åº“ï¼Œ<code>DependencyCheck</code>å·¥ä½œä¹Ÿä¼šåœ¨  PublishMavenPlugin å®Œæˆã€‚</p>
<p>åŒæ—¶ï¼Œæ­£å¼ç‰ˆæœ¬ä¸å…è®¸å¼€å‘åŒå­¦åœ¨æœ¬æœºæ‰“åŒ…å‘å¸ƒï¼ŒPublishMavenPlugin ä¼šæ£€æµ‹æ˜¯å¦åœ¨äº‘ç«¯æ‰“åŒ…ç¯å¢ƒã€‚åŠŸèƒ½åˆ†æ”¯ç» CodeReview ååˆå¹¶ master åˆ†æ”¯ï¼Œç„¶ååˆ›å»ºå¯¹åº”ç‰ˆæœ¬çš„ tagï¼Œè§¦å‘å¤§é£è½¦è¿›è¡Œæ‰“åŒ…å‘å¸ƒå·¥ä½œï¼Œå‘å¸ƒæˆåŠŸåï¼Œä¼šé‚®ä»¶é€šçŸ¥ Android ç»„åŒå­¦ï¼Œå¹¶é™„å¸¦ CHANGELOGã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwxgz042voj312q0qa44m.jpg" alt="image-20181105204154472"></p>
<h2 id="ä¾èµ–ç®¡ç†"><a href="#ä¾èµ–ç®¡ç†" class="headerlink" title="ä¾èµ–ç®¡ç†"></a>ä¾èµ–ç®¡ç†</h2><h3 id="ä¾èµ–ä¼ é€’"><a href="#ä¾èµ–ä¼ é€’" class="headerlink" title="ä¾èµ–ä¼ é€’"></a>ä¾èµ–ä¼ é€’</h3><p>App å·¥ç¨‹ä¸‹é‡‡ç”¨ compile ä¾èµ–ï¼Œcompile ä¼šè§£æç±»åº“ maven åŒ…ä¸­çš„ pom æ–‡ä»¶ï¼Œè¿›è€Œé—´æ¥ä¾èµ– pom æ–‡ä»¶ä¸­å£°æ˜çš„å…¶ä»–ç±»åº“ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–ä¼ é€’ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¾èµ–ä¼ é€’ä¼šå‡å°‘ä¸å¿…è¦çš„ç±»åº“å£°æ˜ï¼Œå½“å‡ºç°ç‰ˆæœ¬å†²çªæ—¶ä¼šè‡ªåŠ¨å¤„ç† merge æ“ä½œã€‚</p>
<p>ä½†æ˜¯ï¼Œåœ¨å¤šäººååŒå·¥ä½œã€å¤šç±»åº“å¹¶è¡Œå¼€å‘æƒ…å†µä¸‹ï¼Œäº‹æƒ…å˜å¾—æœ‰äº›å¤æ‚ã€‚è€ƒè™‘ä¸€ç§æƒ…å†µï¼Œåº”ç”¨ A ä¾èµ–ç±»åº“ Bï¼Œç±»åº“ B ä¾èµ–ç±»åº“ Cï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼ŒA ä¸­åªéœ€è¦å£°æ˜ä¾èµ– B å³å¯ï¼ŒC ä¼šè¢«ä¾èµ–ä¼ é€’è¿‡å»ã€‚å¦‚æœ C ä¸­æ”¹å˜äº†æ–¹æ³•ç­¾åï¼Œå¹¶ä¸”åœ¨åº”ç”¨ A ä¸­æ˜¾ç¤ºå£°æ˜ä¾èµ– Cï¼Œç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶ä¼šåˆ†åˆ«å‡ºç°ä»€ä¹ˆæƒ…å†µï¼Ÿåœ¨ç¼–è¯‘æ—¶æ²¡æœ‰é—®é¢˜ï¼Œæ­£å¸¸ç¼–è¯‘é€šè¿‡ï¼›åœ¨è¿è¡Œæ—¶ï¼Œå½“è¿è¡Œåˆ°ç±»åº“ B ä¸­ä½¿ç”¨çš„ç±»åº“ C ä¸­è¢«æ”¹å˜ç­¾åçš„æ–¹æ³•æ—¶ï¼ŒApp crashã€‚è¿™æ˜¯å› ä¸ºï¼Œmaven åœ¨å¤„ç†ç±»åº“ç‰ˆæœ¬ merge æ—¶ï¼Œä¼šå°† C å‡çº§åˆ°æœ€é«˜ç‰ˆæœ¬ï¼Œè€Œæ­¤æ—¶ B ä¸­å·²ç»ç¼–è¯‘å¥½çš„ class ä¸­ä½¿ç”¨çš„è¿˜æ˜¯è€ç‰ˆæœ¬ C ä¸­çš„æ–¹æ³•ã€‚</p>
<p>ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨ APICheckGradlePlugin åœ¨ç¼–è¯‘æ—¶è¿›è¡Œ check æ“ä½œï¼Œå½“å‘ç°è¢«è°ƒç”¨çš„æ–¹æ³•æ‰¾ä¸åˆ°æ—¶ï¼Œä¸»åŠ¨æŠ¥é”™ï¼Œå°†é”™è¯¯æå‰æš´éœ²åœ¨ç¼–è¯‘æœŸï¼Œè€Œéåœ¨è¿è¡Œæ—¶ã€‚åŒæ—¶å†…éƒ¨å¼ºè°ƒ API æ¥å£çš„å‘ä¸‹å…¼å®¹æ€§ï¼Œä¸ç”¨çš„æ–¹æ³•æ ‡è®°ä¸ºåºŸå¼ƒï¼Œè€Œéç›´æ¥ä¿®æ”¹å…¶æ–¹æ³•ç­¾åæˆ–åˆ é™¤æ–¹æ³•ã€‚</p>
<p>APICheckGradlePlugin æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    c.getClassPool().get(callClassName)</div><div class="line">    isClassNotFound = <span class="keyword">false</span></div><div class="line">    m.getMethod()</div><div class="line">&#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</div><div class="line">    <span class="keyword">if</span> (isClassNotFound) &#123;</div><div class="line">        dealException(String.format(<span class="string">"åœ¨%sç±»ä¸­çš„ç¬¬%dè¡Œæ˜¯ç”¨åˆ°çš„%sç±»ä¸å­˜åœ¨"</span>, className, line, callClassName))</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        dealException(String.format(<span class="string">"åœ¨%sç±»ä¸­çš„ç¬¬%dè¡Œæ˜¯ç”¨åˆ°çš„%sç±»çš„%sæ–¹æ³•ä¸å­˜åœ¨"</span>, className, line, callClassName, methodName))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å¤šmoduleå‘å¸ƒ"><a href="#å¤šmoduleå‘å¸ƒ" class="headerlink" title="å¤šmoduleå‘å¸ƒ"></a>å¤šmoduleå‘å¸ƒ</h3><p>ä¸Šæ–‡ä¸­æåˆ°ï¼Œåœ¨å¤šä¸šåŠ¡ç»„ä»¶åº“å·¥ç¨‹ä¸­ä¼šæœ‰å¤šä¸ª moduleï¼Œä¸€ä¸ª api moduleï¼Œä¸€ä¸ª imp moduleï¼Œåœ¨ä½¿ç”¨ DemoApp ç¼–è¯‘è°ƒè¯•æ—¶é‡‡ç”¨æºç ä¾èµ–ï¼Œ imp module ä¾èµ– api moduleï¼ŒApp ä¾èµ– imp moduleï¼Œè¿™æ ·åœ¨æ‰“åŒ…ä¸Šä¼  maven æ—¶ï¼Œä¼šå‡ºç°æ— æ³•ä¸€èµ·ä¸Šä¼ çš„é—®é¢˜ï¼›å¹¶ä¸”æˆ‘ä»¬ä¹Ÿè¦ç¡®ä¿ api å’Œ imp çš„ç‰ˆæœ¬å·ä¸€è‡´ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦åœ¨ä¸Šä¼ æ—¶åŠ¨æ€ä¿®æ”¹ä»–ä»¬çš„ pom æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">modifyPom &#123; pom -&gt;</div><div class="line">    pom.dependencies.findAll &#123; dep -&gt; dep.groupId == rootProject.name &#125;.collect &#123; dep -&gt;</div><div class="line">        dep.groupId = pom.groupId = rootProject.groupId</div><div class="line">        dep.version = pom.version = rootProject.sdkVersion</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ä¸€é”®åˆ›å»ºé¡¹ç›®"><a href="#ä¸€é”®åˆ›å»ºé¡¹ç›®" class="headerlink" title="ä¸€é”®åˆ›å»ºé¡¹ç›®"></a>ä¸€é”®åˆ›å»ºé¡¹ç›®</h2><h3 id="æ¨¡æ¿å·¥ç¨‹"><a href="#æ¨¡æ¿å·¥ç¨‹" class="headerlink" title="æ¨¡æ¿å·¥ç¨‹"></a>æ¨¡æ¿å·¥ç¨‹</h3><p>ç”±äºæ¯ä¸ªæ–°å»ºç»„ä»¶ç±»åº“çš„ App å·¥ç¨‹éœ€è¦è¿è¡Œæ—¶ç¯å¢ƒåŸºæœ¬ç›¸åŒï¼ŒåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€è°ƒè¯•ç¯å¢ƒã€gradle é…ç½®ã€é€šç”¨ä¾èµ–é…ç½®ç­‰ç­‰ï¼Œè¿™äº›é‡å¤æ€§çš„å·¥ä½œæœ€å¥½æ”¾åœ¨ä¸€èµ·ç»Ÿä¸€å¤„ç†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ç»„ä»¶åº“çš„æ¨¡æ¿å·¥ç¨‹ï¼Œåªéœ€è¦ clone ä¸‹æ¥æ¨¡æ¿ä»“åº“ï¼Œç„¶åä¿®æ”¹ä¸€äº›ä»£ç å³å¯å¼€å‘éœ€æ±‚ä»£ç ã€‚</p>
<h3 id="ä¸€é”®åˆ›å»ºç±»åº“"><a href="#ä¸€é”®åˆ›å»ºç±»åº“" class="headerlink" title="ä¸€é”®åˆ›å»ºç±»åº“"></a>ä¸€é”®åˆ›å»ºç±»åº“</h3><p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼ä¾ç„¶æœ‰å¾ˆå¤šå…±æ€§çš„å·¥ä½œï¼Œæ¯”å¦‚ clone ä»£ç ã€ä¿®æ”¹ç±»åº“åã€ä¿®æ”¹ groupId:artifactIdã€åˆ›å»ºæ–°çš„ç±»åº“ä»“åº“ã€push ä»£ç ã€åœ¨å¤§é£è½¦ä¸­æ–°å»ºç±»åº“å…³è”ä»“åº“åœ°å€ç­‰ç­‰æ“ä½œã€‚è¿™äº›å…±æ€§æ“ä½œä»ç„¶å¯ä»¥ç”¨æœºå™¨æ¥æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¤§é£è½¦æ–°å»ºç±»åº“è¿™ä¸€æ­¥ä¸­ï¼ŒæŠŠå‰é¢æ‰€æœ‰è¦åšçš„äº‹æƒ…å…¨éƒ¨åšå®Œï¼Œåªéœ€è¦åœ¨æ–°å»ºç±»åº“æ—¶å¡«å…¥å¿…è¦çš„å‚æ•°ï¼Œä¸€é”®å°±å¯ä»¥åˆ›å»ºå‡ºå¯ç”¨çš„ç±»åº“é¡¹ç›®ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwrpngxyd4j31g40mqdht.jpg" alt="image-20181031201425732"></p>
<h3 id="ä¸€é”®åˆ›å»ºåº”ç”¨"><a href="#ä¸€é”®åˆ›å»ºåº”ç”¨" class="headerlink" title="ä¸€é”®åˆ›å»ºåº”ç”¨"></a>ä¸€é”®åˆ›å»ºåº”ç”¨</h3><p>éšç€æˆ‘å¸ App è¶Šæ¥è¶Šå¤šï¼Œæ–°å»º App çš„é…ç½®åŒæ ·é¢ä¸´ç±»åº“åˆšå¼€å§‹æ—¶çš„å›°æ‰°ï¼Œæ–°å»º App ä¸æ–°å»ºç±»åº“æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ‰€éœ€å‚æ•°æ›´å¤šä¸€äº›ï¼Œå¹¶ä¸”è¿™äº›å‚æ•°å¯èƒ½ä¸å›ºå®šï¼Œæœ‰äº› App éœ€è¦æœ‰äº› App ä¸éœ€è¦ã€‚å‚è€ƒç±»åº“ï¼Œæˆ‘ä»¬æå–å…±æ€§æ“ä½œï¼Œåˆ›å»ºäº† App çš„æ¨¡æ¿å·¥ç¨‹ï¼Œå¹¶ä¸”å¯¹æ¥å¤§é£è½¦ï¼Œä¸€é”®å³å¯åˆ›å»ºå‡º App å·¥ç¨‹ï¼Œé‚£äº›å¯å˜çš„å‚æ•°ç•™åœ¨æ¨¡æ¿å·¥ç¨‹ä¸­æŒ‰éœ€æ‰‹åŠ¨é…ç½®ã€‚</p>
<h2 id="æ¨¡å—è´Ÿè´£äºº"><a href="#æ¨¡å—è´Ÿè´£äºº" class="headerlink" title="æ¨¡å—è´Ÿè´£äºº"></a>æ¨¡å—è´Ÿè´£äºº</h2><p>åœ¨ç»„ä»¶åŒ–åˆæ­¥å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬çš„æ¯ä¸ªæ¨¡å—éƒ½æœ‰å›ºå®šçš„è´Ÿè´£äººï¼Œæ¯ä¸ªäººæ‰‹ä¸Šéƒ½æœ‰å›ºå®šçš„è‹¥å¹²ä¸ªæ¨¡å—ï¼Œè´£ä»»äººå¯¹è‡ªå·±è´Ÿè´£çš„æ¨¡å—è´Ÿè´£ã€‚</p>
<p>ä½†æ˜¯éšç€ç»„å†…çš„äººå‘˜å˜åŠ¨å’Œä¸šåŠ¡å˜åŠ¨ï¼Œå¯¼è‡´ä¸€äº›æ¨¡å—é¢‘ç¹æ˜“ä¸»ï¼Œä¸€äº›æ¨¡å—çš„æ–‡æ¡£é•¿æœŸå¤„äºä¸è¢«ç»´æŠ¤çŠ¶æ€ï¼ŒREADME å’Œ CHANGELOG å¸¸å¹´å¤±ä¿®ã€‚</p>
<p>ä¾èµ–å¤§é£è½¦çš„ç±»åº“ç®¡ç†ï¼Œé‡æ–°ä¸ºæ¯ä¸ªæ¨¡å—æŒ‡å®šè´Ÿè´£äººï¼Œå¹¶ä¸”æ¢³ç†ç°å­˜ç±»åº“å“ªäº›ç¼ºå¤±æ–‡æ¡£ï¼Œè¿›è¡Œè¡¥å…¨ã€‚è‡ªä»å¤§é£è½¦è‡ªåŠ¨æŠ„é€ç±»åº“å‘ç‰ˆ CHANGELOG åï¼ŒCHANGELOG ä¸å…¨çš„æƒ…å†µä¹Ÿå¤§å¹…æ”¹å–„ï¼ŒåŸºæœ¬æ¯ä¸ªæ–°çš„ç‰ˆæœ¬éƒ½ä¼šé™„ä¸Šè¯¥ç‰ˆæœ¬æ‰€åšä¿®æ”¹ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¼ºè°ƒ CodeReview æœºåˆ¶ï¼Œæ¯ä¸ªæ¨¡å—åœ¨ææµ‹å‰è¿›è¡Œ CodeReviewï¼Œå¼ºåˆ¶merge request å¿…é¡»æœ‰äººç‚¹èµåæ‰èƒ½åˆå¹¶ master åˆ†æ”¯ç­‰ç­‰ä»£ç å®¡æŸ¥æœºåˆ¶ã€‚æœªæ¥ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¿›ä¸€æ­¥å®è·µè´Ÿè´£äºº backup æ–¹æ¡ˆï¼Œä¸»å‰¯è´Ÿè´£äººç›¸äº’ reviewï¼Œæ‰©å¤§å¤§å®¶æŠ€æœ¯è§†é‡çš„åŒæ—¶ï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜å¤§å®¶çš„ä¸»äººç¿æ„è¯†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¥½çš„æ¶æ„ä¸æ˜¯è®¾è®¡å‡ºæ¥çš„ï¼Œè€Œæ˜¯æ¼”è¿›å‡ºæ¥çš„ã€‚æœ¬æ–‡ç®€å•é˜è¿°äº†51ä¿¡ç”¨å¡ Android æ¶æ„æ¼”è¿›çš„ä¸€äº›å®è·µç»éªŒï¼ŒåŒæ—¶æˆ‘ä»¬åšä¿¡æŠ€æœ¯æ–¹æ¡ˆæ²¡æœ‰æœ€ä¼˜è§£ï¼Œé‡è¦çš„æ˜¯è¦é€‰æ‹©é€‰æ‹©é€‚åˆè‡ªå·±çš„ã€‚è„±ç¦»æ‰€å¤„ç¯å¢ƒå’Œé—®é¢˜æœ¬èº«è°ˆæŠ€æœ¯æ–¹æ¡ˆï¼Œéƒ½å°†ä¸èƒ½å¾—åˆ°é€‚åˆè‡ªèº«çš„å¼€å‘æ¶æ„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿåº”å½“å¸å–å’Œå€Ÿé‰´ä¸šç•Œä¼˜ç§€çš„æ¶æ„å’Œè®¾è®¡ç†å¿µï¼Œå¹¶å°†å…¶æ ¹æ®è‡ªèº«é€‚ç”¨åœºæ™¯åŠ ä»¥æ”¹é€ ï¼Œåœ¨ç†è®ºå’Œå®è·µä¸­é€æ¸äº¤æ›¿æ¢ç´¢æ¼”è¿›ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ç›®å‰æ‰€ä½¿ç”¨çš„æ¶æ„ä¾ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ç»„ä»¶æ‹†åˆ†ä¸å®Œå…¨ã€ä¸»å·¥ç¨‹ä¸šåŠ¡ä»ç„¶å¾ˆå¤šã€CodeReview æœºåˆ¶ä¸å¥å…¨ã€ä»£ç æ‰«æä¸å¤Ÿä¸¥æ ¼ã€ä¸€äº›ç»„ä»¶åº“æ²¡æœ‰ä¸¥æ ¼æŒ‰ç…§ api å·¥ç¨‹æ¥æ”¹é€ ã€ä¸€äº›è€çš„ç»„ä»¶ä¾ç„¶æ²¡æœ‰ api moduleç­‰ç­‰é—®é¢˜ã€‚æˆ‘ä»¬ä¹Ÿåº”è¯¥çœ‹åˆ°ï¼Œæ­£æ˜¯å› ä¸ºè¿™äº›å®é™…çš„é—®é¢˜åœ¨æ¨åŠ¨æˆ‘ä»¬è¿›è¡ŒæŠ€æœ¯æ”¹é€ ï¼Œæ¶æ„å‡çº§ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦å®¡è§†è¡Œä¸šå†…å¤§çš„æ–¹å‘ï¼Œç´§è·ŸæŠ€æœ¯è¶‹åŠ¿ï¼Œä¸»åŠ¨æ‹¥æŠ±å˜åŒ–ï¼Œæ¯•ç«ŸæŠ€æœ¯ä¸–ç•Œå”¯ä¸€ä¸å˜çš„ï¼Œä¾¿æ˜¯å˜åŒ–ã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2018/11/16/51credit-android-architecture/">http://w4lle.com/2018/11/16/51credit-android-architecture/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;éšç€ä¸šåŠ¡çš„å¿«é€Ÿæ‰©å¼ ï¼ŒåŸæœ¬å°ä½œåŠå¼çš„å•ä¸ªå·¥ç¨‹çš„å¼€å‘æ¨¡å¼è¶Šæ¥ä¸ä¸èƒ½æ»¡è¶³å®é™…éœ€æ±‚ã€‚æ—©åœ¨ä¸¤å¹´å¤šä»¥å‰ï¼Œ51ä¿¡ç”¨å¡ç®¡å®¶å°±å‘ä¸‹æ²‰æ·€å‡ºäº†å•ç‹¬çš„å…¬ç”¨åŸºç¡€åº“ï¼Œä¸€äº›é€šç”¨çš„åŠŸèƒ½ç»„ä»¶å’Œä¸ªåˆ«ç‹¬ç«‹çš„ä¸šåŠ¡è¢«æ‹†åˆ†æˆ SDKï¼Œå½¢æˆäº†ä¸€å¥—ä¸­å‹é¡¹ç›®ã€å¤šäººå¹¶è¡Œçš„å¼€å‘æ¨¡å¼ï¼Œä¹Ÿä¸ºæœªæ¥ç»„ä»¶åŒ–æ‹†åˆ†åšå‡†å¤‡ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</title>
    <link href="http://w4lle.com/2018/06/20/robust-2/"/>
    <id>http://w4lle.com/2018/06/20/robust-2/</id>
    <published>2018-06-20T08:18:16.000Z</published>
    <updated>2018-06-20T13:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œåˆ†æäº† Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>è¡¥ä¸åŠ è½½è¿‡ç¨‹</li>
<li>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹</li>
<li>è¡¥ä¸åŒ…è‡ªåŠ¨åŒ–ç”Ÿæˆè¿‡ç¨‹</li>
</ul>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°çš„å‘ä»¥åŠåˆ†æé—®é¢˜çš„æ€è·¯å’Œæœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆã€‚åŒ…å«ï¼š</p>
<ul>
<li>æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ</li>
<li>Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ</li>
<li>æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ</li>
<li>ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ</li>
<li>static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ</li>
</ul>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« :</p>
<ul>
<li><a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
<li><a href="http://w4lle.com/2018/05/28/robust-1/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</a></li>
<li><a href="http://w4lle.com/2018/05/29/robust-2/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</a></li>
</ul>
<h1 id="æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ"><a href="#æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ" class="headerlink" title="æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ"></a>æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ</h1><p>åœ¨æ‰“è¡¥ä¸åŒ…è¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°äº†ä¸€ä¸ªé”™è¯¯ <code>execute command java -jar /Users/wanglinglong/Develop/u51/Credit51/CreditCardManager/robust/dx.jar --dex --output=classes.dex  meituan.jar error</code>ï¼Œæ‰¾äº†ä¸€å¤§åœˆæœ€åå‘ç°æ˜¯jdkè€ç‰ˆæœ¬åœ¨Macä¸Šçš„ä¸€ä¸ªbugï¼Œå‡çº§jdkå°±å¥½äº†ï¼Œå‚è€ƒ <a href="https://stackoverflow.com/questions/43003012/class-javalaunchhelper-is-implemented-in-two-places?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa" target="_blank" rel="external">Class JavaLaunchHelper is implemented in two places</a></p>
<h1 id="Robust-å®šä¹‰çš„-API-ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ"><a href="#Robust-å®šä¹‰çš„-API-ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ"></a>Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ</h1><p>Robust æä¾›äº†ä¸€äº› API å¯ä¾›å¼€å‘è€…æ‰©å±•ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š<br>æ·»åŠ ç±»åº“ä¾èµ– <code>compile &#39;com.meituan.robust:robust:0.4.82&#39;</code>ï¼Œå…¶ä¸­ <code>PatchManipulateImp</code> ç±»çš„ä¸€äº›å¯æ‰©å±•æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Patch&gt; <span class="title">fetchPatchList</span><span class="params">(Context context)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">verifyPatch</span><span class="params">(Context context, Patch patch)</span></span>;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">ensurePatchExist</span><span class="params">(Patch patch)</span></span>;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œè¿™äº›å¯æ‰©å±•æ–¹æ³•å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>ä¸ºäº†æ»¡è¶³å®šåˆ¶åŒ–éœ€æ±‚ï¼Œå¯ä»¥å¼ƒç”¨ <code>com.meituan.robust:robust</code>ï¼Œè‡ªå·±å®ç°ä¸€å¥—è¡¥ä¸åŠ è½½é€»è¾‘ï¼Œè¿™ä¸ªå®ç°èµ·æ¥éš¾åº¦å¹¶ä¸å¤ªå¤§ï¼Œä¸»è¦è¡¥ä¸åŠ è½½æµç¨‹éƒ½å¯ä»¥å‚è€ƒ Robust å®˜æ–¹å®ç°ï¼Œå…·ä½“åŠ è½½é€»è¾‘å¯å‚è€ƒæœ¬ç³»åˆ—ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œè¿™é‡Œä¸å†æ·±å…¥ã€‚</p>
<h1 id="æ’ä»¶-Plugin-Transform-çš„é¡ºåºé—®é¢˜ï¼Ÿ"><a href="#æ’ä»¶-Plugin-Transform-çš„é¡ºåºé—®é¢˜ï¼Ÿ" class="headerlink" title="æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ"></a>æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ</h1><p>é¦–å…ˆï¼Œè¦æ‰¾åˆ° Gradle Plugin ç¼–è¯‘è¿‡ç¨‹ä¸­å¯¹äºè‡ªå®šä¹‰ Transform çš„å¤„ç†ï¼Œå…·ä½“æµç¨‹è¯»è€…å¯ä»¥è‡ªè¡Œæœç´¢æŸ¥çœ‹ï¼Œè¿™é‡Œåªç»™å‡ºå…³é”®ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">TaskManager.java</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Creates the post-compilation tasks for the given Variant.</div><div class="line"> *</div><div class="line"> * These tasks create the dex file from the .class files, plus optional intermediary steps like</div><div class="line"> * proguard and jacoco</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createPostCompilationTasks</span><span class="params">(</span></span></div><div class="line">        @NonNull <span class="keyword">final</span> VariantScope variantScope) &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// ---- Code Coverage first -----</span></div><div class="line">    ...</div><div class="line">    <span class="comment">// Merge Java Resources.</span></div><div class="line">    createMergeJavaResTransform(variantScope);</div><div class="line">    <span class="comment">// ----- External Transforms -----</span></div><div class="line">    <span class="comment">// apply all the external transforms.</span></div><div class="line">    List&lt;Transform&gt; customTransforms = extension.getTransforms();</div><div class="line">    List&lt;List&lt;Object&gt;&gt; customTransformsDependencies = extension.getTransformsDependencies();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = customTransforms.size(); i &lt; count; i++) &#123;</div><div class="line">        Transform transform = customTransforms.get(i);</div><div class="line">        List&lt;Object&gt; deps = customTransformsDependencies.get(i);</div><div class="line">        transformManager</div><div class="line">                .addTransform(taskFactory, variantScope, transform)</div><div class="line">                .ifPresent(</div><div class="line">                        t -&gt; &#123;</div><div class="line">                            <span class="keyword">if</span> (!deps.isEmpty()) &#123;</div><div class="line">                                t.dependsOn(deps);</div><div class="line">                            &#125;</div><div class="line">                            <span class="comment">// if the task is a no-op then we make assemble task depend on it.</span></div><div class="line">                            <span class="keyword">if</span> (transform.getScopes().isEmpty()) &#123;</div><div class="line">                                variantScope.getAssembleTask().dependsOn(t);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ç”Ÿæˆ Dex ä»»åŠ¡ä¹‹å‰ï¼Œä¼šå¤„ç†æ‰€æœ‰çš„è‡ªå®šä¹‰ Transform ä»»åŠ¡ï¼Œé€»è¾‘æ˜¯æŒ‰ç…§é¡ºåºéå†ç„¶åå¤„ç†ä»»åŠ¡ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆä»dzheâ€™lè¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒTransform çš„æ‰§è¡Œé¡ºåºæ˜¯æŒ‰ç…§æ’ä»¶çš„å£°æ˜é¡ºåºæ¥æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå“ªä¸ª plugin çš„å£°æ˜åœ¨å‰ï¼Œå…¶å¯¹åº”çš„ Transform å°±åœ¨å‰æ‰§è¡Œï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'pluginA'</span></div><div class="line">apply plugin: <span class="string">'pluginB'</span></div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¯¹åº”çš„ TransformA ä»»åŠ¡å°±ä¼šå…ˆäº TransfromB ä»»åŠ¡æ‰§è¡Œã€‚</p>
<p>å¥½äº†ï¼ŒçŸ¥é“äº† Transform çš„æ‰§è¡Œé¡ºåºé—®é¢˜ï¼Œå†æ¥çœ‹ä¸‹ Robust æ’ä»¶çš„é¡ºåºé—®é¢˜ã€‚é¦–å…ˆæ¥çœ‹ä¸‹åŸºçº¿åŒ…çš„å¤„ç†æ’ä»¶ <code>apply plugin: &#39;robust&#39;</code>ï¼Œå…¶é€»è¾‘æ˜¯åœ¨æ¯ä¸ªæ–¹æ³•ä¸­å‰ç½®æ’å…¥è¡¥ä¸åŠ è½½é€»è¾‘ä»£ç ï¼Œç”¨äºæ‹¦æˆªåŸºçº¿åŒ…ä¸­çš„åŸæœ‰é€»è¾‘ï¼Œè¾¾åˆ°ä¿®å¤æ–¹æ³•çš„ç›®çš„ã€‚<br>å¦‚æœ robust Plugin æ˜¯å…ˆäºå…¶ä»–æ’ä»¶æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆä¼šå‡ºç° Robust æ’å…¥ä»£ç åï¼Œå†æ‰§è¡Œå…¶ä»–æ’ä»¶çš„ä»£ç é€»è¾‘ï¼Œè¿™æ ·ä¼šæœ‰é—®é¢˜å—ï¼Ÿå…¶å®è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰é—®é¢˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº†å¬äº‘ï¼Œè€Œä¸”æ˜¯è¾ƒè€çš„ç‰ˆæœ¬(2.5.9)ï¼Œå…¶æ’ä»¶å†…éƒ¨æ’å…¥ä»£ç æ²¡æœ‰ç”¨åˆ° Transformï¼Œè€Œæ˜¯ç”¨äº†å¦å¤–ä¸€ç§æŠ€æœ¯ï¼Œå…¶ä¼šå¯¼è‡´ä¸ç®¡åœ¨å“ªé‡Œå£°æ˜æ’ä»¶ï¼Œå…¶å¤„ç†é¡ºåºéƒ½æ˜¯æœ€åæ‰§è¡Œï¼Œé‚£ä¹ˆå¯¹äº Robust åŸºçº¿åŒ…æ’ä»¶æ¥è¯´ï¼Œå½“åŸºçº¿åŒ…æ’ä»¶æ’å…¥å®Œä»£ç åï¼Œåˆä¼šå»æ‰§è¡Œå¬äº‘æ’ä»¶çš„æ’å…¥ä»£ç é€»è¾‘ï¼Œæ‰€ä»¥å¯èƒ½ä¼šçœ‹åˆ°ä»¥ä¸‹è¿™ç§ä»£ç ï¼š</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/robust_tingyun.png" alt=""></p>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/robust_tingyun_right.png" alt=""></p>
<p>ç„¶è€Œï¼Œå¦‚æœä»”ç»†è§‚å¯Ÿè¿™ç§é”™è¯¯çš„ä»£ç æ’å…¥é€»è¾‘ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰å¯¹æœ€ç»ˆçš„çƒ­ä¿®å¤é€»è¾‘äº§ç”Ÿå½±å“ã€‚æ˜¯å› ä¸ºåœ¨ç”Ÿæˆè¡¥ä¸åŒ…è¿‡ç¨‹ä¸­ï¼Œä»–ä»¬çš„æ‰§è¡Œé¡ºåºä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œå³å¬äº‘æ’ä»¶æœ€åæ‰§è¡Œï¼Œè¿™æ ·çš„ç»“æœå°±æ˜¯Robust è‡ªåŠ¨åŒ–è¡¥ä¸æ’ä»¶åœ¨ç”Ÿæˆæ’ä»¶åå°±å¼ºåˆ¶åœæ­¢äº†æ•´ä¸ªç¼–è¯‘æµç¨‹ï¼Œå¬äº‘æ’ä»¶æ ¹æœ¬å°±æ²¡æœ‰æœºä¼šæ‰§è¡Œã€‚æ‰€ä»¥æœ€åè¡¥ä¸åŒ…ä¸­ä»…ä»…ä¼šåŒ…å«å‰”é™¤äº†Robust åŸºçº¿åŒ…æ’ä»¶æ’å…¥çš„ä»£ç ä»¥åŠå¬äº‘æ’ä»¶æ’å…¥çš„ä»£ç ã€‚å¯ä»¥ç†è§£ä¸ºç¬¬ä¸€å¼ å›¾ä¸­æŠŠçº¢æ¡†ä¸‹é¢çš„ä»£ç é€šè¿‡çƒ­ä¿®å¤çš„æ–¹å¼ç§»å…¥äº†çº¢æ¡†é‡Œé¢ï¼Œç„¶åreturnã€‚</p>
<p>å¯¹äºå¬äº‘æ¥è¯´ï¼Œ2.8.xç‰ˆæœ¬ä¹‹åï¼Œæ’å…¥ä»£ç çš„é€»è¾‘ä¹Ÿç”± Tranform æ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå¬äº‘æ¥è¯´ï¼Œä¸ç®¡æ˜¯æ€ä¹ˆæ ·çš„æ‰§è¡Œé¡ºåºï¼Œéƒ½ä¸ä¼šä¸ Robust å‘ç”Ÿå…¼å®¹æ€§é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥è¿˜æ˜¯è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œè¿™é‡Œä»…ä»…æä¾›ä¸€äº›æ’æŸ¥é—®é¢˜çš„æ€è·¯ã€‚</p>
<h1 id="ä¸-Aspectj-å†²çªæ€ä¹ˆåŠï¼Ÿ"><a href="#ä¸-Aspectj-å†²çªæ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ"></a>ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ</h1><p>æˆ‘ä»¬é¡¹ç›®ä¸­å¤§é‡ä½¿ç”¨äº† AOP æŠ€æœ¯ï¼Œæ¶‰åŠåˆ°çš„æ¡†æ¶æœ‰ Aspectjã€javassistã€ASMã€‚å…¶ä¸­ç”±äº  javassist å’Œ ASM å®Œå…¨æ˜¯æœ‰è‡ªå·±æ§åˆ¶çš„ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜ï¼Œè€Œå¯¹äº Aspectj æ¥è¯´å°±æ²¡è¿™ä¹ˆç®€å•äº†ã€‚</p>
<p>åˆšå¼€å§‹ä»‹å…¥å°±ç¢°åˆ°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ <code>Caused by: java.lang.ClassCastException: com.meituan.robust.patch.MainFragmentActivityPatch cannot be cast to com.zhangdan.app.activities.MainFragmentActivity</code>ï¼Œæ˜¯ä¸€ä¸ªç±»å‹å¼ºè½¬é”™è¯¯ã€‚</p>
<p>é—®é¢˜åˆ†æï¼Œç”±äº Aspectj æ¡†æ¶ä¸ºå¼€å‘è€…çœç•¥äº†å¾ˆå¤šé€»è¾‘ï¼Œå¼€å‘è€…åªéœ€è¦ç¼–å†™åˆ‡é¢ç›¸å…³ä»£ç å³å¯ï¼Œæ‰€ä»¥éœ€è¦æ¢³ç†æ¸…æ¥š Aspectj çš„åŸç†ï¼š</p>
<p>é¦–å…ˆè´´ä¸‹æœªæ··æ·†çš„ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity.class</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody2</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">        onCreate_aroundBody1$advice(mainFragmentActivity, bundle, joinPoint, MainFragmentActivity$$Injector.aspectOf(), (ProceedingJoinPoint) joinPoint);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> onCreate_aroundBody1$advice(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint, MainFragmentActivity$$Injector mainFragmentActivity$$Injector, ProceedingJoinPoint proceedingJoinPoint) &#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint, mainFragmentActivity$$Injector, proceedingJoinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11888</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class, MainFragmentActivity$$Injector.class, ProceedingJoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            MainFragmentActivity mainFragmentActivity2 = (MainFragmentActivity) proceedingJoinPoint.getTarget();</div><div class="line">            onCreate_aroundBody0(mainFragmentActivity, bundle, proceedingJoinPoint);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;bundle&#125;, <span class="keyword">this</span>, changeQuickRedirect, <span class="keyword">false</span>, <span class="number">11849</span>, <span class="keyword">new</span> Class[]&#123;Bundle.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            JoinPoint makeJP = Factory.makeJP(ajc$tjp_0, <span class="keyword">this</span>, <span class="keyword">this</span>, bundle);</div><div class="line">            MainFragmentActivity$$Injector.aspectOf().onCreate(<span class="keyword">new</span> AjcClosure3(<span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, bundle, makeJP&#125;).linkClosureAndJoinPoint(<span class="number">69648</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11887</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">            JudgeEmulatorUtil.uploadEmulatorInfoIfNeed(mainFragmentActivity);</div><div class="line">            instance = mainFragmentActivity;</div><div class="line">            mainFragmentActivity.setContentView(R.layout.main_activity);</div><div class="line">            ButterKnife.bind((Activity) mainFragmentActivity);</div><div class="line">            mainFragmentActivity.initUserCenterManager();</div><div class="line">            mainFragmentActivity.mainPagerAdapter = <span class="keyword">new</span> MainPagerAdapter(mainFragmentActivity, mainFragmentActivity.getSupportFragmentManager());</div><div class="line">            mainFragmentActivity.userInfoPresenter = <span class="keyword">new</span> UserInfoPresenter();</div><div class="line">            mainFragmentActivity.refreshOldDataPresenter = <span class="keyword">new</span> RefreshOldDataPresenter();</div><div class="line">            mainFragmentActivity.tabRedPointPresenter = <span class="keyword">new</span> TabRedPointPresenter(mainFragmentActivity);</div><div class="line">            mainFragmentActivity.getMsgCenterRedPresenter = <span class="keyword">new</span> GetMsgCenterRedPresenter(mainFragmentActivity);</div><div class="line">            mainFragmentActivity.userInfoPresenter.setUserInfoView(mainFragmentActivity);</div><div class="line">            mainFragmentActivity.userInfoPresenter.startGetCurUserInfoDBUseCase();</div><div class="line">            INSTANCE_FLAG = <span class="number">1</span>;</div><div class="line">            BaiduLocation.getInstance(ZhangdanApplication.getInstance()).start();</div><div class="line">            mainFragmentActivity.initToolBar();</div><div class="line">            mainFragmentActivity.showImportBillDialog();</div><div class="line">            mainFragmentActivity.onLoginCreate(bundle);</div><div class="line">            mainFragmentActivity.getLoggerABConfig();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å¯¹åº”çš„patch æ–‡ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivityPatch</span> </span>&#123;</div><div class="line">    MainFragmentActivity originClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainFragmentActivityPatch</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.originClass = (MainFragmentActivity) obj;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        StaticPart staticPart = (StaticPart) EnhancedRobustUtils.getStaticFieldValue(<span class="string">"ajc$tjp_0"</span>, MainFragmentActivity.class);</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"get static  value is ajc$tjp_0     No:  1"</span>);</div><div class="line">        JoinPoint joinPoint = (JoinPoint) EnhancedRobustUtils.invokeReflectStaticMethod(<span class="string">"makeJP"</span>, Factory.class, getRealParameter(<span class="keyword">new</span> Object[]&#123;staticPart, <span class="keyword">this</span>, <span class="keyword">this</span>, savedInstanceState&#125;), <span class="keyword">new</span> Class[]&#123;StaticPart.class, Object.class, Object.class, Object.class&#125;);</div><div class="line">        Object obj = (Injector) EnhancedRobustUtils.invokeReflectStaticMethod(<span class="string">"aspectOf"</span>, Injector.class, getRealParameter(<span class="keyword">new</span> Object[<span class="number">0</span>]), <span class="keyword">null</span>);</div><div class="line">        Object[] objArr = <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, savedInstanceState, joinPoint&#125;;</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"  inner Class new      No:  2"</span>);</div><div class="line">        Object obj2 = (AjcClosure3) EnhancedRobustUtils.invokeReflectConstruct(<span class="string">"com.zhangdan.app.activities.MainFragmentActivity$AjcClosure3"</span>, getRealParameter(<span class="keyword">new</span> Object[]&#123;objArr&#125;), <span class="keyword">new</span> Class[]&#123;Object[].class&#125;);</div><div class="line">        <span class="keyword">if</span> (obj2 == <span class="keyword">this</span>) &#123;</div><div class="line">            obj2 = ((MainFragmentActivityPatch) obj2).originClass;</div><div class="line">        &#125;</div><div class="line">        ProceedingJoinPoint proceedingJoinPoint = (ProceedingJoinPoint) EnhancedRobustUtils.invokeReflectMethod(<span class="string">"linkClosureAndJoinPoint"</span>, obj2, getRealParameter(<span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> Integer(<span class="number">69648</span>)&#125;), <span class="keyword">new</span> Class[]&#123;Integer.TYPE&#125;, AroundClosure.class);</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"invoke  method is       No:  3 linkClosureAndJoinPoint"</span>);</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</div><div class="line">            obj = ((MainFragmentActivityPatch) obj).originClass;</div><div class="line">        &#125;</div><div class="line">        EnhancedRobustUtils.invokeReflectMethod(<span class="string">"onCreate"</span>, obj, getRealParameter(<span class="keyword">new</span> Object[]&#123;proceedingJoinPoint&#125;), <span class="keyword">new</span> Class[]&#123;ProceedingJoinPoint.class&#125;, Injector.class);</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"invoke  method is       No:  4 onCreate"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¾€ä¸‹è·Ÿä¸‹ Aspectj çš„è°ƒç”¨æµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">AjcClosure ç±»</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AroundClosure</span> </span>&#123;</div><div class="line">   ...</div><div class="line">    <span class="keyword">protected</span> Object[] state;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AroundClosure</span><span class="params">(Object[] state)</span> </span>&#123;</div><div class="line">    	<span class="keyword">this</span>.state = state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Object[] getState() &#123;</div><div class="line">      <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * This takes in the same arguments as are passed to the proceed</div><div class="line">	 * call in the around advice (with primitives coerced to Object types)</div><div class="line">	 */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">run</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> ProceedingJoinPoint <span class="title">linkClosureAndJoinPoint</span><span class="params">(<span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        <span class="comment">//TODO is this cast safe ?</span></div><div class="line">        ProceedingJoinPoint jp = (ProceedingJoinPoint)state[state.length-<span class="number">1</span>];</div><div class="line">        jp.set$AroundClosure(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">this</span>.bitflags = flags;</div><div class="line">        <span class="keyword">return</span> jp;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AjcClosure æ¥æ”¶ä¸€ä¸ª Object çš„å¯¹è±¡æ•°ç»„ï¼Œåœ¨åŸºç¡€åŒ…ä¸­ï¼Œå®ƒçš„å®ç°æ˜¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, bundle, makeJP&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™ä¸ª <code>this</code>ï¼Œä»£è¡¨çš„æ˜¯MainFragmentActivity å¯¹è±¡ã€‚<br>ç›¸å¯¹åº”çš„çœ‹ä¸‹patchåŒ…ä¸­çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Object[] objArr = <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, savedInstanceState, joinPoint&#125;;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè°ƒç”¨äº†ä¸‹ <code>getRealParameter(new Object[]{objArr})</code> è¿›è¡Œäº† this è½¬æ¢ï¼Œæ‰€ä»¥è¿™é‡Œçš„this ä¹Ÿæ˜¯MainFragmentActivityå¯¹è±¡ï¼Œè¿™é‡Œæ˜¯æ²¡é—®é¢˜çš„ã€‚<br>ç„¶åè°ƒç”¨ <code>linkClosureAndJoinPoint</code> æ–¹æ³•å¾—åˆ° ProceedingJoinPoint å¯¹è±¡ï¼Œå½“åšå‚æ•°ä¼ é€’ç»™ MainFragmentActivity$$Injector.onCreate(ProceedingJoinPoint joinPoint)  æ–¹æ³•ï¼Œçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity$$Injector.class</div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivity</span>$$<span class="title">Injector</span> </span>&#123;</div><div class="line">  <span class="meta">@Around</span>(<span class="string">"execution(* com.zhangdan.app.activities.MainFragmentActivity.onCreate(..))"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    MainFragmentActivity target = (MainFragmentActivity)joinPoint.getTarget();</div><div class="line">    ...</div><div class="line">    joinPoint.proceed();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨äº† ProceedingJoinPoint.proceed æŠ½è±¡æ–¹æ³•ï¼Œå®ç°åœ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">   JoinPointImpl.<span class="function">java</span></div><div class="line"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</div><div class="line">	<span class="comment">// when called from a before advice, but be a no-op</span></div><div class="line">		<span class="keyword">return</span> arc.run(arc.getState());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>arc</code> æ˜¯ AroundClosureï¼Œ<code>arc.getState()</code> è¿”å›çš„æ˜¯æ„é€  AroundClosure æ—¶ä¼ é€’è¿‡æ¥çš„å¯¹è±¡æ•°ç»„ã€‚<br>æœ€åè°ƒç”¨äº†æŠ½è±¡æ–¹æ³• <code>run(Object[] args)</code>ï¼Œå®ç°åœ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivity</span>$<span class="title">AjcClosure3</span> <span class="keyword">extends</span> <span class="title">AroundClosure</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ChangeQuickRedirect changeQuickRedirect;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> MainFragmentActivity$AjcClosure3(Object[] objArr) &#123;</div><div class="line">        <span class="keyword">super</span>(objArr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">(Object[] objArr)</span> </span>&#123;</div><div class="line">        PatchProxyResult proxy = PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;objArr&#125;, <span class="keyword">this</span>, changeQuickRedirect, <span class="keyword">false</span>, <span class="number">11911</span>, <span class="keyword">new</span> Class[]&#123;Object[].class&#125;, Object.class);</div><div class="line">        <span class="keyword">if</span> (proxy.isSupported) &#123;</div><div class="line">            <span class="keyword">return</span> proxy.result;</div><div class="line">        &#125;</div><div class="line">        Object[] objArr2 = <span class="keyword">this</span>.state;</div><div class="line">        MainFragmentActivity.onCreate_aroundBody2((MainFragmentActivity) objArr2[<span class="number">0</span>], (Bundle) objArr2[<span class="number">1</span>], (JoinPoint) objArr2[<span class="number">2</span>]);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åè°ƒç”¨ <code>MainFragmentActivity.onCreate_aroundBody2((MainFragmentActivity) objArr2[0], (Bundle) objArr2[1], (JoinPoint) objArr2[2]);</code>ï¼Œæ•´ä¸ª AOP çš„æµç¨‹å°±èµ°é€šäº†ã€‚</p>
<p>æœ€åæ€»ç»“ä¸‹ Aspectj çš„è°ƒç”¨æµç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity.onCreate -&gt; </div><div class="line">MainFragmentActivity$$Injector.onCreate(ProceedingJoinPoint joinPoint) -&gt; </div><div class="line">ProceedingJoinPoint.proceed() -&gt; </div><div class="line">AroundClosure.run(Object[] args) -&gt;  </div><div class="line">MainFragmentActivity$AjcClosure3.run(Object[] objArr) -&gt; </div><div class="line">MainFragmentActivity.onCreate_aroundBody2((MainFragmentActivity) objArr2[<span class="number">0</span>], (Bundle) objArr2[<span class="number">1</span>], (JoinPoint) objArr2[<span class="number">2</span>]); -&gt; </div><div class="line">MainFragmentActivity.onCreate_aroundBody1$advice -&gt; </div><div class="line">MainFragmentActivity.onCreate_aroundBody0();</div></pre></td></tr></table></figure>
<p>æœ€åçš„ <code>MainFragmentActivity.onCreate_aroundBody0();</code>æ–¹æ³•å®é™…ä¸Šå°±æ˜¯onCreate()çš„åŸå§‹æ–¹æ³•é€»è¾‘ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äºä¿®æ”¹åçš„ä»£ç ï¼Œæ²¡æœ‰è¢«æ‰“å…¥è¡¥ä¸ï¼Œä¹Ÿæ˜¯å¯ä»¥è§£é‡Šçš„ã€‚<br>å¯¹äº auto-path-pluginï¼ŒTransform çš„é¡ºåºæ˜¯ Aspectj -&gt; auto-patch.<br>é‚£ä¹ˆï¼Œå¯¹äºæ ‡è®°ä¿®æ”¹çš„ onCreate æ–¹æ³•æ¥è¯´ï¼ŒAspectj å¤„ç†å®Œåï¼ŒonCreate æ–¹æ³•è¢«æ›¿æ¢æˆäº†ä»£ç†ï¼ŒçœŸæ­£çš„æ–¹æ³•å®ç°è¢«æ–°ç”Ÿæˆçš„æ–¹æ³•éšè—èµ·æ¥äº†ã€‚<br>è€Œæˆ‘ä»¬ä»…ä»…æ ‡è®°äº†æ—§çš„ onCreate æ–¹æ³•ï¼Œå…¶ç»“æœå°±æ˜¯ï¼ŒAspectj çš„ä»£ç† onCreate æ–¹æ³•è¢« patch äº†ï¼Œè€Œå®é™…çš„æ–¹æ³•è™½ç„¶æ–¹æ³•ä½“å†…æœ‰æˆ‘ä»¬çš„ä¿®å¤ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰æ ‡è®° <code>@modify</code> è€Œè¢«å¿½ç•¥ã€‚</p>
<p>å› ä¸ºæ˜¯å¼ºè½¬ crashï¼Œæ‰€ä»¥åœ¨ $$Injector ä»£ç ä¸­æ’å…¥ä¸€äº› Log</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity$$Injector.class</div><div class="line">    <span class="meta">@Around</span>(<span class="string">"execution(* com.zhangdan.app.activities.MainFragmentActivity.onCreate(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;proceedingJoinPoint&#125;, <span class="keyword">this</span>, changeQuickRedirect, <span class="keyword">false</span>, <span class="number">11892</span>, <span class="keyword">new</span> Class[]&#123;ProceedingJoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            MainFragmentActivity target = (MainFragmentActivity) proceedingJoinPoint.getTarget();</div><div class="line">            ...</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"test for aspectj start "</span>);</div><div class="line">            ...</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"getTarget : "</span> + proceedingJoinPoint.getTarget().getClass().getSimpleName());</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"getThis : "</span> + proceedingJoinPoint.getThis().getClass().getSimpleName());</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"getArgs[0] : "</span> + (proceedingJoinPoint.getArgs()[<span class="number">0</span>] != <span class="keyword">null</span> ? proceedingJoinPoint.getArgs()[<span class="number">0</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">            Field arcField = proceedingJoinPoint.getClass().getDeclaredField(<span class="string">"arc"</span>);</div><div class="line">            arcField.setAccessible(<span class="keyword">true</span>);</div><div class="line">            AroundClosure arc = (AroundClosure) arcField.get(proceedingJoinPoint);</div><div class="line">            <span class="keyword">if</span> (!(arc == <span class="keyword">null</span> || arc.getState() == <span class="keyword">null</span> || arc.getState().length &lt; <span class="number">3</span>)) &#123;</div><div class="line">                Object[] states = arc.getState();</div><div class="line">                Log.d(<span class="string">"robust-wll"</span>, <span class="string">"states[0] : "</span> + (states[<span class="number">0</span>] != <span class="keyword">null</span> ? states[<span class="number">0</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">                Log.d(<span class="string">"robust-wll"</span>, <span class="string">"states[1] : "</span> + (states[<span class="number">1</span>] != <span class="keyword">null</span> ? states[<span class="number">1</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">                Log.d(<span class="string">"robust-wll"</span>, <span class="string">"states[2] : "</span> + (states[<span class="number">2</span>] != <span class="keyword">null</span> ? states[<span class="number">2</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">            &#125;</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"test for aspectj end "</span>);</div><div class="line">            proceedingJoinPoint.proceed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä¸åŠ è½½è¡¥ä¸æƒ…å†µä¸‹çš„ log å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.184</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: test <span class="keyword">for</span> aspectj start </div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.184</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: getTarget : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: getThis : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: getArgs[<span class="number">0</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: states[<span class="number">0</span>] : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: states[<span class="number">1</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.186</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: states[<span class="number">2</span>] : JoinPointImpl</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.186</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: test <span class="keyword">for</span> aspectj end</div></pre></td></tr></table></figure>
<p>åŠ è½½è¡¥ä¸åï¼Œlog å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.885</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: test <span class="keyword">for</span> aspectj start </div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.885</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: getTarget : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: getThis : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: getArgs[<span class="number">0</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: states[<span class="number">0</span>] : MainFragmentActivityPatch</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: states[<span class="number">1</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: states[<span class="number">2</span>] : JoinPointImpl</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: test <span class="keyword">for</span> aspectj end</div></pre></td></tr></table></figure>
<p><strong>states[0] : MainFragmentActivityPatch</strong> è¿™ä¸ªæ˜æ˜¾æ˜¯ä¸å¯¹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº†åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨æ„é€  <code>AroundClosure</code> æ—¶å€™ä¼ è¿›æ¥çš„å‚æ•°ä¸å¯¹ã€‚<br>æŠ¥é”™åœ°æ–¹å¯¹åº”äºä¸Šé¢çš„åˆ†æï¼Œä¹Ÿå°±æ˜¯<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Object[] objArr = <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, savedInstanceState, joinPoint&#125;;</div><div class="line">Object obj2 = (AjcClosure3) EnhancedRobustUtils.invokeReflectConstruct(<span class="string">"com.zhangdan.app.activities.MainFragmentActivity$AjcClosure3"</span>, getRealParameter(<span class="keyword">new</span> Object[]&#123;objArr&#125;), <span class="keyword">new</span> Class[]&#123;Object[].class&#125;);</div></pre></td></tr></table></figure></p>
<p>ç»“æœå°±æ˜¯ï¼ŒæŠŠä¸€ä¸ªå«æœ‰3ä¸ªå¯¹è±¡çš„ä¸€ç»´æ•°æ®ï¼Œç¼–ç¨‹äº†å«æœ‰ä¸€ä¸ªå¯¹è±¡çš„äºŒç»´æ•°ç»„ï¼Œç„¶åå» getRealParameterã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Object[] getRealParameter(Object[] objArr) &#123;</div><div class="line">    <span class="keyword">if</span> (objArr == <span class="keyword">null</span> || objArr.length &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> objArr;</div><div class="line">    &#125;</div><div class="line">    Object[] objArr2 = <span class="keyword">new</span> Object[objArr.length];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objArr.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (objArr[i] == <span class="keyword">this</span>) &#123;</div><div class="line">            objArr2[i] = <span class="keyword">this</span>.originClass;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            objArr2[i] = objArr[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> objArr2;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è€Œè¿™ä¸ªæ–¹æ³•åªåˆ¤æ–­äº†ä¸€ç»´æ•°ç»„çš„æƒ…å†µï¼Œæ²¡æœ‰åˆ¤æ–­äºŒç»´æˆ–å¤šç»´æ•°ç»„çš„æƒ…å†µã€‚ç»ˆäºæ‰¾åˆ°åŸå› äº† ğŸ˜ƒ<br>å¯¹åº”çš„ä¿®æ”¹æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Object[] getRealParameter(Object[] objArr) &#123;</div><div class="line">    <span class="keyword">if</span> (objArr == <span class="keyword">null</span> || objArr.length &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> objArr;</div><div class="line">    &#125;</div><div class="line">    Object[] objArr2 = <span class="keyword">new</span> Object[objArr.length];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objArr.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (objArr[i] <span class="keyword">instanceof</span> Object[]) &#123;</div><div class="line">            objArr2[i] = getRealParameter(((Object[]) objArr[i]));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (objArr[i] == <span class="keyword">this</span>) &#123;</div><div class="line">                objArr2[i] = <span class="keyword">this</span>.originClass;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                objArr2[i] = objArr[i];</div><div class="line">            &#125;</div><div class="line">        &#125; </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> objArr2;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>castException ç»ˆäºæ˜¯æå®šäº†ã€‚å…·ä½“è§£å†³æ–¹æ³•è§ <a href="https://github.com/Meituan-Dianping/Robust/pull/259" target="_blank" rel="external">merge request #259</a>ã€‚</p>
<h1 id="static-æ–¹æ³•ä¸­åŒ…å«-super-æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ"><a href="#static-æ–¹æ³•ä¸­åŒ…å«-super-æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ"></a>static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ</h1><p>çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜å¯èƒ½ä¼šä¸€è„¸æ‡µé€¼ï¼Œstatic æ–¹æ³•ä¸­æ€ä¹ˆå¯èƒ½åŒ…å« super è°ƒç”¨ï¼Ÿåˆ«æ€¥æ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p>
<p>ä¹¦æ¥ä¸ŠèŠ‚ï¼Œè‡³äºè¢« Aspectj  å¤„ç†è¿‡çš„æ–¹æ³•æ— æ³•è¢«æ‰“å…¥ patch çš„é—®é¢˜ï¼Œç†è®ºä¸Šæ¥è¯´è·Ÿæ³›å‹çš„æ¡¥æ–¹æ³•æ˜¯ç±»ä¼¼çš„ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯ <code>@Modify -&gt; RobustModify.modify();</code>ï¼Œä¿®æ”¹åç»éªŒè¯ï¼Œä¼šæŠ¥é”™ã€‚logå¦‚ä¸‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">Caused by: javassist.CannotCompileException: [source error] not-available: <span class="keyword">this</span></div><div class="line">        at javassist.expr.MethodCall.replace(MethodCall.java:<span class="number">241</span>)</div><div class="line">        at javassist.expr.MethodCall$replace$<span class="number">2</span>.call(Unknown Source)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory$<span class="number">1</span>.edit(PatchesFactory.groovy:<span class="number">144</span>)</div><div class="line">        at javassist.expr.ExprEditor.loopBody(ExprEditor.java:<span class="number">224</span>)</div><div class="line">        at javassist.expr.ExprEditor.doit(ExprEditor.java:<span class="number">91</span>)</div><div class="line">        at javassist.CtBehavior.instrument(CtBehavior.java:<span class="number">712</span>)</div><div class="line">        at javassist.CtBehavior$instrument$<span class="number">1</span>.call(Unknown Source)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory.createPatchClass(PatchesFactory.groovy:<span class="number">76</span>)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory.createPatch(PatchesFactory.groovy:<span class="number">310</span>)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory$createPatch.call(Unknown Source)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform.generatPatch(AutoPatchTransform.groovy:<span class="number">190</span>)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform$generatPatch$<span class="number">0</span>.callCurrent(Unknown Source)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform.autoPatch(AutoPatchTransform.groovy:<span class="number">138</span>)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform$autoPatch.callCurrent(Unknown Source)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform.transform(AutoPatchTransform.groovy:<span class="number">97</span>)</div><div class="line">        at com.android.build.api.transform.Transform.transform(Transform.java:<span class="number">290</span>)</div><div class="line">        at com.android.build.gradle.internal.pipeline.TransformTask$<span class="number">2</span>.call(TransformTask.java:<span class="number">185</span>)</div><div class="line">        at com.android.build.gradle.internal.pipeline.TransformTask$<span class="number">2</span>.call(TransformTask.java:<span class="number">181</span>)</div><div class="line">        at com.android.builder.profile.ThreadRecorder.record(ThreadRecorder.java:<span class="number">102</span>)</div><div class="line">        ... <span class="number">27</span> more</div><div class="line">Caused by: compile error: not-available: <span class="keyword">this</span></div><div class="line">        at javassist.compiler.CodeGen.atKeyword(CodeGen.java:<span class="number">1908</span>)</div><div class="line">        at javassist.compiler.ast.Keyword.accept(Keyword.java:<span class="number">35</span>)</div><div class="line">        at javassist.compiler.JvstCodeGen.atMethodArgs(JvstCodeGen.java:<span class="number">358</span>)</div><div class="line">        at javassist.compiler.MemberCodeGen.atMethodCallCore(MemberCodeGen.java:<span class="number">569</span>)</div><div class="line">        at javassist.compiler.MemberCodeGen.atCallExpr(MemberCodeGen.java:<span class="number">537</span>)</div><div class="line">        at javassist.compiler.JvstCodeGen.atCallExpr(JvstCodeGen.java:<span class="number">244</span>)</div><div class="line">        at javassist.compiler.ast.CallExpr.accept(CallExpr.java:<span class="number">46</span>)</div><div class="line">        at javassist.compiler.CodeGen.atStmnt(CodeGen.java:<span class="number">338</span>)</div><div class="line">        at javassist.compiler.ast.Stmnt.accept(Stmnt.java:<span class="number">50</span>)</div><div class="line">        at javassist.compiler.CodeGen.atStmnt(CodeGen.java:<span class="number">351</span>)</div><div class="line">        at javassist.compiler.ast.Stmnt.accept(Stmnt.java:<span class="number">50</span>)</div><div class="line">        at javassist.compiler.Javac.compileStmnt(Javac.java:<span class="number">569</span>)</div><div class="line">        at javassist.expr.MethodCall.replace(MethodCall.java:<span class="number">235</span>)</div><div class="line">        ... <span class="number">45</span> more</div></pre></td></tr></table></figure></p>
<p>é—®é¢˜åˆ†æï¼Œæ ¹æ®å †æ ˆæ˜¾ç¤ºï¼Œè¿™é‡Œæ˜¯åœ¨åšæ›¿æ¢ super æ–¹æ³•çš„é€»è¾‘ï¼Œè·Ÿäº†ä¸‹ plugin çš„ debugï¼Œç”Ÿæˆéœ€è¦ replace çš„ javassist ä»£ç ä¸º <code>{staticRobustonCreate(this,originClass,$$);}</code>ï¼Œç„¶ååœ¨ replace åï¼Œjavac ç¼–è¯‘è¿™æ¡è¯­å¥çš„æ—¶å€™è·ªäº†ã€‚<br>åˆ†æä¸‹éœ€è¦æ›¿æ¢çš„ super çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ Aspectj å¤„ç†åçš„æ–¹æ³•ï¼Œæ ¹æ®ä¸Šé¢åˆ†æçš„ Aspectj çš„è°ƒç”¨æµç¨‹å¾—çŸ¥ï¼Œè¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯ onCreate æ–¹æ³•åŸå§‹çš„é€»è¾‘ï¼Œåç¼–è¯‘å‡ºæ¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11887</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);<span class="comment">//è¿™é‡Œæ˜¯éœ€è¦æ›¿æ¢çš„åœ°æ–¹</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œ auto-patch åšçš„å·¥ä½œæ˜¯å°†<code>super.onCreate</code>æ–¹æ³•åŒ…è£…æˆ static æ–¹æ³•ï¼Œæ­£å¸¸ç”Ÿæˆçš„patchä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivityPatch</span> </span>&#123;</div><div class="line">    SecondActivity originClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondActivityPatch</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.originClass = (SecondActivity) obj;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        staticRobustonCreate(<span class="keyword">this</span>,originClass,bundle);</div><div class="line">       ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(SecondActivityPatch secondActivityPatch, SecondActivity secondActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        SecondActivityPatchRobustAssist.staticRobustonCreate(secondActivityPatch, secondActivity, bundle);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivityPatchRobustAssist</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(SecondActivityPatch secondActivityPatch, SecondActivity secondActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œå¯¹äºå·²ç»è¢« Aspectj å¤„ç†è¿‡çš„æ–¹æ³•ï¼Œæ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11887</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">        <span class="comment">//super.onCreate(bundle);//è¿™é‡Œæ˜¯éœ€è¦æ›¿æ¢çš„åœ°æ–¹</span></div><div class="line">        staticRobustonCreate(<span class="keyword">this</span>,originClass,bundle);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨static æ–¹æ³•ä¸­ä½¿ç”¨äº† <code>this</code>å…³é”®å­—ï¼Œå½“ç„¶ç¼–è¯‘å‡ºé”™å•¦ã€‚åŒç†è¿™ä¸ª <code>originClass</code> ä¹Ÿä¸å¯ä»¥å‡ºç°ï¼Œå› ä¸ºå®ƒæ˜¯é static å˜é‡ã€‚<br>ç”±äº xxPatchRobustAssist.staticRobustonCreate() æ–¹æ³•å¹¶æ²¡æœ‰ç”¨åˆ°å‰ä¸¤ä¸ªå˜é‡(patch, activity)ï¼Œç›´æ¥ä¼  null è¡Œä¸è¡Œå‘¢ï¼Ÿç»éªŒè¯æ˜¯ä¸è¡Œçš„ï¼ŒåŸå› å¦‚ä¸‹ã€‚<br>çœ‹äº†ä¸‹ç”ŸæˆxxxPatchRobustAssistç±»çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PatchesAssistFactory</span> </span>&#123;</div><div class="line">    <span class="function">def</span></div><div class="line">    <span class="keyword">static</span> <span class="title">createAssistClass</span><span class="params">(CtClass modifiedClass, String patchClassName, CtMethod removeMethod)</span> &#123;</div><div class="line">       ....</div><div class="line">        StringBuilder staticMethodBuidler = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">if</span> (removeMethod.parameterTypes.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            staticMethodBuidler.append(<span class="string">"public static  "</span> + removeMethod.returnType.name + <span class="string">"   "</span> + ReflectUtils.getStaticSuperMethodName(removeMethod.getName())</div><div class="line">                    + <span class="string">"("</span> + patchClassName + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance,"</span> + JavaUtils.getParameterSignure(removeMethod) + <span class="string">")&#123;"</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            staticMethodBuidler.append(<span class="string">"public static  "</span> + removeMethod.returnType.name + <span class="string">"   "</span> + ReflectUtils.getStaticSuperMethodName(removeMethod.getName())</div><div class="line">                    + <span class="string">"("</span> + patchClassName + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance)&#123;"</span>);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        staticMethodBuidler.append(<span class="string">" return patchInstance."</span> + removeMethod.getName() + <span class="string">"("</span> + JavaUtils.getParameterValue(removeMethod.getParameterTypes().length) + <span class="string">");"</span>);</div><div class="line">        staticMethodBuidler.append(<span class="string">"&#125;"</span>);</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> assistClass;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®é™…ä¸Šï¼Œæœ€ç»ˆç”Ÿæˆçš„è°ƒç”¨æ˜¯ <code>xxPatch.superMethod($$);</code> ï¼Œ$$ä»£è¡¨å…¨éƒ¨å‚æ•°ã€‚å¯¹äºä¸ä¸Šé¢çš„ onCreate æ–¹æ³•å°±æ˜¯ <code>xxPatch.onCreate(bundle);</code>ã€‚<br>æ‰€ä»¥ï¼Œpatch åº”è¯¥ä¸èƒ½ä¼  null äº†ï¼Œå¦åˆ™è¿è¡Œæ—¶ä¼šæŠ¥ç©ºæŒ‡é’ˆï¼Œé‚£ç¬¬äºŒä¸ªå‚æ•° activity  èƒ½ä¸èƒ½ä¼  null å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹ã€‚<br>é¦–å…ˆï¼Œæ ¹æ®å¸¸è¯†ï¼Œstatic æ–¹æ³•ä¸­è‚¯å®šæ˜¯ä¸èƒ½è°ƒç”¨ superæ–¹æ³•çš„ã€‚ä»æœ€ç»ˆç”Ÿæˆçš„ä»£ç ä¹Ÿèƒ½çœ‹å‡ºï¼Œè¿™å¹¶ä¸æ˜¯æœ€ç»ˆåç¼–è¯‘å‡ºçš„çš„ <code>super.onCreate(bundle)</code>æ–¹æ³•è°ƒç”¨ã€‚æ‰€ä»¥å¤„ç†çš„åœ°æ–¹è‚¯å®šåœ¨javassistä¿®æ”¹ç¼–è¯‘ä¹‹åï¼Œå¯¹åº”å¤„ç†çš„åœ°æ–¹åœ¨smali å±‚ï¼Œä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">SmaliTool.<span class="function">java</span></div><div class="line">    <span class="keyword">private</span> String <span class="title">invokeSuperMethodInSmali</span><span class="params">(<span class="keyword">final</span> String line, String fullClassName)</span> &#123;</div><div class="line">                    ...</div><div class="line">                    result = line.replace(Constants.SMALI_INVOKE_VIRTUAL_COMMAND, Constants.SMALI_INVOKE_SUPER_COMMAND);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (!ctMethod.getReturnType().isPrimitive()) &#123;</div><div class="line">                            returnType = <span class="string">"L"</span> + ctMethod.getReturnType().getName().replaceAll(<span class="string">"\\."</span>, <span class="string">"/"</span>);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            returnType = String.valueOf(((CtPrimitiveType) ctMethod.getReturnType()).getDescriptor());</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (NameManger.getInstance().getPatchNameMap().get(fullClassName).equals(fullClassName)) &#123;</div><div class="line">                            result = result.replace(<span class="string">"p0"</span>, <span class="string">"p1"</span>);</div><div class="line">                        &#125;</div><div class="line">                       ...</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">                    &#125;</div><div class="line">                ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå°±æ˜¯æŠŠæ–¹æ³•è°ƒç”¨ä» <code>invoke-invoke-virtual {p0, p2}, Lcom/meituan/robust/patch/SecondActivityPatch;-&gt;onCreate(Landroid/os/Bundle;)</code>V è½¬æ¢æˆ <code>invoke-super {p1, p2}, Landroid/support/v7/app/AppCompatActivity;-&gt;onCreate(Landroid/os/Bundle;)V</code>ï¼Œè¿™æ­¥å¤„ç†å®Œæ‰ä¼šçœŸæ­£çš„è°ƒç”¨çˆ¶ç±»çš„superæ–¹æ³•ã€‚<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ smali å¤„ç†å®Œåï¼Œå‚æ•°ä» p0 -&gt; p1ï¼Œä¹Ÿå°±æ˜¯å‚æ•°ä» xxpatch æ¢æˆäº† Activityï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼šåœ¨è¿è¡Œæ—¶ç”¨åˆ°ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½ä¼ nullã€‚<br>åˆ†æå®Œäº†æ€»ç»“ä¸‹ï¼Œç¬¬äºŒä¸ªå‚æ•° originClass è‚¯å®šä¸èƒ½ä¼  nullï¼Œå¦åˆ™ä¼šç©ºæŒ‡é’ˆï¼›ç¬¬ä¸€ä¸ªå‚æ•°  xxPatchï¼Œç”±äºåœ¨ smali è¢«æ›¿æ¢æˆäº†ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ‰€ä»¥æœ‰å¯èƒ½æ˜¯å¯ä»¥ä¼  null çš„ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>ä¿®æ”¹ originClass ä¸ºstaticï¼Œå¹¶æ–°å¢ä¸€ä¸ª static patch å˜é‡</li>
<li>ç”±äºç›®å‰å·²ç»æ˜¯åœ¨ static æ–¹æ³•ä¸­å­˜åœ¨ super æ–¹æ³•ï¼Œå¯¹åº”çš„ smali ä»£ç ï¼š</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.<span class="function">method <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="title">onCreate_aroundBody0</span><span class="params">(Lcom/zhangdan/app/activities/MainFragmentActivity;Landroid/os/Bundle;Lorg/aspectj/lang/JoinPoint;)</span>V</span></div><div class="line"> ...</div><div class="line">invoke-<span class="keyword">super</span> &#123;p0, p1&#125;, Lcom/zhangdan/app/activities/WrapperAppCompatFragmentActivity;-&gt;onCreate(Landroid/os/Bundle;)V</div></pre></td></tr></table></figure>
</li>
</ol>
<p>æ‰€ä»¥åªè¦ä¸å¤„ç†å°±å¥½äº†ï¼Œéœ€è¦åšçš„å°±æ˜¯åœ¨ auto-plugin ä¸­å¢åŠ æ¡ä»¶åˆ¤æ–­ï¼Œç¬¦åˆ static æ–¹æ³•ä¸­å¸¦æœ‰ super çš„ä¸å¤„ç†ï¼Œä¸€å…±æœ‰ä¸‰å¤„ï¼Œä¸€å¤„æ˜¯ç”Ÿæˆ xxPatchRobustAssist è¾…åŠ©ç±»ï¼Œç¬¬äºŒå¤„åœ¨ javassit æ›¿æ¢ super æ–¹æ³•ï¼Œç¬¬ä¸‰å¤„åœ¨ smali å¤„ç†è¡¥ä¸ä¸­çš„ super æ–¹æ³•ã€‚</p>
<p>å¯¹äºæ–¹æ¡ˆ1ï¼Œé—®é¢˜ï¼š<br>å¦‚æœ patch å’Œ originClass éƒ½æ˜¯ staticï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å†…å­˜æ³„éœ²çš„é£é™©ã€‚<br>å¹¶ä¸”å¦‚æœè¢« patch æ–¹æ³•æ˜¯ static æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨åˆå§‹åŒ– patch æ—¶ï¼ŒoriginClass ä¼šä¼  nullã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">accessDispatch</span><span class="params">(String methodName, Object[] paramArrayOfObject)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="keyword">new</span> StringBuffer().append(<span class="string">"arrivied in AccessDispatch "</span>).append(methodName).append(<span class="string">" paramArrayOfObject  "</span>).append(paramArrayOfObject).toString());</div><div class="line">        MainFragmentActivityPatch mainFragmentActivityPatch;</div><div class="line">        <span class="keyword">if</span> (!methodName.split(<span class="string">":"</span>)[<span class="number">2</span>].equals(<span class="string">"false"</span>)) &#123;</div><div class="line">            Log.d(<span class="string">"robust"</span>, <span class="string">"static method forward "</span>);</div><div class="line">            mainFragmentActivityPatch = <span class="keyword">new</span> MainFragmentActivityPatch(<span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<p>åŒæ ·åº”è¯¥ä¹Ÿæ˜¯ä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œæ¯ä¿®å¤ä¸€ä¸ªæ–¹æ³•å°±ä¼šç”Ÿæˆä¸€ä¸ª patch å¯¹è±¡å¹¶æŒæœ‰ static çš„ originClass å¼•ç”¨ã€‚<br>å¯¹äºæ–¹æ¡ˆ2 ï¼Œé—®é¢˜ï¼š<br>é¦–å…ˆï¼ŒAspectj åœ¨ static æ–¹æ³•ä¸­æ’äº†ä¸ª super æ–¹æ³•ï¼ˆçŒœæµ‹ä¹Ÿæ˜¯åœ¨ smali å±‚åšçš„ä¿®æ”¹ï¼‰ï¼Œç›´æ¥å†™çš„è¯ javac ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ï¼Œsmali å¤„ç†å§è¿˜æ²¡åˆ°è¿™ä¸€æ­¥ã€‚æ‰€ä»¥è¢«ä¿®å¤åï¼Œè¿™ä¸ª static æ–¹æ³•æ˜¯åœ¨ xxPatch ç±»ä¸­çš„ï¼Œauto-patch å³ä½¿ä¸å¤„ç†ï¼Œè¿è¡Œæ—¶ä¹Ÿä¸èƒ½æ­£å¸¸è¿è¡Œï¼Œå› ä¸º xxPatch ä¸æ˜¯ originClass çˆ¶ç±»çš„å­ç±»ï¼Œä¸èƒ½ç›´æ¥å…¶è°ƒç”¨ super æ–¹æ³•ã€‚</p>
<p>è§‚å¯Ÿ Aspectj ç”Ÿæˆçš„æ–¹æ³•ï¼Œæ‰€æœ‰ çš„static æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯å½“å‰ç±»çš„å¼•ç”¨ï¼Œæ¯”å¦‚ <code>private static final void onCreate_aroundBody0(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint) {</code>ã€‚<br>æ‰€ä»¥æ¯”å¦‚æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œå¾—å‡ºä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">def <span class="keyword">static</span> String <span class="title">invokeSuperString</span><span class="params">(MethodCall m, String originClass)</span> </span>&#123;</div><div class="line">       ...</div><div class="line">       stringBuilder.append(getStaticSuperMethodName(m.methodName) + <span class="string">"("</span> + <span class="keyword">null</span> + <span class="string">","</span> + originClass + <span class="string">",\$\$);"</span>);</div><div class="line">       ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯ static æ–¹æ³•ä¸­å«æœ‰ super æ–¹æ³•ï¼Œå°±å¦‚ä¸‹å¤„ç†ã€‚<br>ç¬¬ä¸€ä¸ª xxPatch å¯¹è±¡ä¼ ç©ºï¼Œæœ€ååœ¨ smali å¤„ç†çš„æ—¶å€™ä¼šè¢«æ›¿æ¢æ‰ã€‚<br>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä»ç±»ä¼¼<code>onCreate_aroundBody0()</code>ä¸­ä¼ è¿‡æ¥çš„ï¼Œåé¢çš„æ˜¯å…¶ä»–å‚æ•°ã€‚<br>æœ€ç»ˆç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">    MainFragmentActivityPatchRobustAssist.staticRobustonCreate(mainFragmentActivityPatch, mainFragmentActivity, bundle);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity ajc$<span class="keyword">this</span>, Bundle savedInstanceState, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    staticRobustonCreate(<span class="keyword">null</span>, ajc$<span class="keyword">this</span>, savedInstanceState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œè¿™ä¸ªé—®é¢˜å°±åˆ†æå®Œäº†ï¼Œè¯¦ç»†è§£å†³æ–¹å‘è§ <a href="https://github.com/Meituan-Dianping/Robust/pull/265" target="_blank" rel="external">merge request #265</a></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸ªç³»åˆ—åˆ°è¿™é‡ŒåŸºæœ¬å°±ç»“æŸäº†ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†åœ¨æ¥å…¥ Robust è¿‡ç¨‹ä¸­ç¢°åˆ°çš„ä¸€äº›å‘ä»¥åŠè§£å†³æ€è·¯ï¼Œå…¶å®æ ¹æœ¬è¿˜æ˜¯ç†Ÿè¯»æºç ï¼Œç¢°åˆ°é—®é¢˜å­¦ä¹ ä»æºç ä¸­æ‰¾ç­”æ¡ˆã€‚è¦åšä¿¡ï¼Œå‘è¸©çš„å¤šäº†ï¼Œä¹Ÿå°±ä¸æ€•å‘äº†ã€‚æœ€åç¦åˆ©ä¸€å¼ ã€‚</p>
<p><img src="http://wx3.sinaimg.cn/large/0078WU5Lgy1fsgrhhx37tj30o31040zf.jpg" alt=""></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2018/06/20/robust-2/">http://w4lle.com/2018/06/20/robust-2/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œåˆ†æäº† Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¡¥ä¸åŠ è½½è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;è¡¥ä¸åŒ…è‡ªåŠ¨åŒ–ç”Ÿæˆè¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°çš„å‘ä»¥åŠåˆ†æé—®é¢˜çš„æ€è·¯å’Œæœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆã€‚åŒ…å«ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ&lt;/li&gt;
&lt;li&gt;Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;li&gt;æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;li&gt;static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</title>
    <link href="http://w4lle.com/2018/05/28/robust-1/"/>
    <id>http://w4lle.com/2018/05/28/robust-1/</id>
    <published>2018-05-28T11:47:06.000Z</published>
    <updated>2018-05-29T08:40:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>è¡¥ä¸åŠ è½½è¿‡ç¨‹</li>
<li>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹</li>
<li>è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹</li>
</ul>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a>ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†å‰ä¸¤ä¸ªï¼Œè¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º <code>0.3.2</code>ã€‚<br>è¯¥ç¯‡æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œä¸»è¦åˆ†æè¡¥ä¸è‡ªåŠ¨åŒ–ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º<code>0.4.82</code>ã€‚<br><a id="more"></a><br>æ—¶é—´è·¨åº¦æœ‰ç‚¹å¤§â€¦</p>
<p>ç³»åˆ—æ–‡ç« :</p>
<ul>
<li><a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
<li><a href="http://w4lle.com/2018/05/28/robust-1/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</a></li>
<li><a href="http://w4lle.com/2018/05/29/robust-2/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</a></li>
</ul>
<h1 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h1><p>é¦–å…ˆåœ¨ Gradle æ’ä»¶ä¸­æ³¨å†Œäº†ä¸€ä¸ªåä¸º AutoPatchTranform çš„ Tranform </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoPatchTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; </span>&#123;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project target)</span> </span>&#123;</div><div class="line">    initConfig();</div><div class="line">    project.android.registerTransform(<span class="keyword">this</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">def <span class="title">initConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">    NameManger.init();</div><div class="line">    InlineClassFactory.init();</div><div class="line">    ReadMapping.init();</div><div class="line">    Config.init();</div><div class="line">    ...</div><div class="line">    ReadXML.readXMl(project.projectDir.path);</div><div class="line">    Config.methodMap = JavaUtils.getMapFromZippedFile(project.projectDir.path + Constants.METHOD_MAP_PATH)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥ç±»ä¸ºæ’ä»¶çš„å…¥å£ï¼Œå®ç°äº† GradlePlugin å¹¶ç»§æ‰¿è‡ª Transformï¼Œåœ¨å…¥å£å¤„åˆå§‹åŒ–é…ç½®å¹¶æ³¨å†Œ Transformã€‚é…ç½®ä¸»è¦æ˜¯è¯»å– Robust xml é…ç½®ã€æ··æ·†ä¼˜åŒ–åçš„ mapping æ–‡ä»¶ã€æ’åº„è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ methodsMap.robust æ–‡ä»¶ã€åˆå§‹åŒ–å†…è”å·¥å‚ç±»ç­‰ç­‰ã€‚<br>ç„¶åæœ€ä¸»è¦çš„æ˜¯<code>transform</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">transform</span><span class="params">(Context context, Collection&lt;TransformInput&gt; inputs, Collection&lt;TransformInput&gt; referencedInputs, TransformOutputProvider outputProvider, <span class="keyword">boolean</span> isIncremental)</span> <span class="keyword">throws</span> IOException, TransformException, InterruptedException </span>&#123;</div><div class="line">    project.android.bootClasspath.each &#123;</div><div class="line">        Config.classPool.appendClassPath((String) it.absolutePath)</div><div class="line">    &#125;</div><div class="line">    def box = ReflectUtils.toCtClasses(inputs, Config.classPool)</div><div class="line">    ...</div><div class="line">    autoPatch(box)</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">def <span class="title">autoPatch</span><span class="params">(List&lt;CtClass&gt; box)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    ReadAnnotation.readAnnotation(box, logger);</div><div class="line">    <span class="keyword">if</span>(Config.supportProGuard) &#123;</div><div class="line">        ReadMapping.getInstance().initMappingInfo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    generatPatch(box,patchPath);</div><div class="line"></div><div class="line">    zipPatchClassesFile()</div><div class="line">    executeCommand(jar2DexCommand)</div><div class="line">    executeCommand(dex2SmaliCommand)</div><div class="line">    SmaliTool.getInstance().dealObscureInSmali();</div><div class="line">    executeCommand(smali2DexCommand)</div><div class="line">    <span class="comment">//package patch.dex to patch.jar</span></div><div class="line">    packagePatchDex2Jar()</div><div class="line">    deleteTmpFiles()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>transform</code> æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ javassist API æŠŠæ‰€æœ‰éœ€è¦å¤„ç†çš„ç±»åŠ è½½åˆ°å¾…æ‰«æé˜Ÿåˆ—ä¸­ï¼Œç„¶åè°ƒç”¨<code>autoPatch</code>æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆè¡¥ä¸ã€‚<br>åœ¨ <code>autoPatch</code>æ–¹æ³•ä¸­ï¼Œä¸»è¦åšäº†è¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>è¯»å–è¢« @Addã€@Modifyã€RobustModify.modify() æ ‡æ³¨çš„æ–¹æ³•æˆ–ç±»å¹¶è®°å½•</li>
<li>è§£æ mapping æ–‡ä»¶å¹¶è®°å½•æ¯ä¸ªç±»å’Œç±»ä¸­æ–¹æ³•æ··æ·†å‰åå¯¹åº”çš„ä¿¡æ¯ï¼Œå…¶ä¸­æ–¹æ³•å­˜å‚¨çš„ä¿¡æ¯æœ‰ï¼šè¿”å›å€¼ï¼Œæ–¹æ³•åï¼Œå‚æ•°åˆ—è¡¨ï¼Œæ··æ·†åçš„åå­—ï¼›å­—æ®µå­˜å‚¨çš„ä¿¡æ¯æœ‰ï¼šå­—æ®µåï¼Œæ··æ·†åçš„åå­—</li>
<li>æ ¹æ®å¾—åˆ°çš„ä¿¡æ¯ï¼Œ<code>generatPatch</code> æ–¹æ³•å®é™…ç”Ÿæˆè¡¥ä¸</li>
<li>å°†ç”Ÿæˆçš„è¡¥ä¸classæ‰“åŒ…æˆjaråŒ…</li>
<li>jar -&gt; dex</li>
<li>dex -&gt; smali</li>
<li>å¤„ç† smaliï¼Œä¸»è¦æ˜¯å¤„ç† super æ–¹æ³•å’Œå¤„ç†æ··æ·†å…³ç³»</li>
<li>smali -&gt; dex</li>
<li>dex -&gt; jar</li>
</ol>
<p>1ã€2 æ¯”è¾ƒå¥½æ‡‚å°±ä¸é€æ­¥åˆ†æäº†ï¼Œä¸»è¦çœ‹3ï¼›åé¢çš„5ã€6ã€7ã€8ã€9 éƒ½æ˜¯ä¸ºäº† 7 ä¸­å¤„ç† smaliï¼Œæ‰€ä»¥åªè¦ææ‡‚smaliå¤„ç†å°±å¥½äº†ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†æ­¥æ¥çœ‹ã€‚</p>
<h1 id="ç”Ÿæˆè¡¥ä¸"><a href="#ç”Ÿæˆè¡¥ä¸" class="headerlink" title="ç”Ÿæˆè¡¥ä¸"></a>ç”Ÿæˆè¡¥ä¸</h1><p>ä¸»è¦é€»è¾‘åœ¨ <code>generatPatch</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function">def  <span class="title">generatPatch</span><span class="params">(List&lt;CtClass&gt; box,String patchPath)</span></span>&#123;</div><div class="line">...</div><div class="line">    InlineClassFactory.dealInLineClass(patchPath, Config.newlyAddedClassNameList)</div><div class="line">    initSuperMethodInClass(Config.modifiedClassNameList);</div><div class="line">    <span class="comment">//auto generate all class</span></div><div class="line">    <span class="keyword">for</span> (String fullClassName : Config.modifiedClassNameList) &#123;</div><div class="line">        CtClass ctClass = Config.classPool.get(fullClassName)</div><div class="line">        CtClass patchClass = PatchesFactory.createPatch(patchPath, ctClass, <span class="keyword">false</span>, NameManger.getInstance().getPatchName(ctClass.name), Config.patchMethodSignatureSet)</div><div class="line">        patchClass.writeFile(patchPath)</div><div class="line">        patchClass.defrost();</div><div class="line">        createControlClass(patchPath, ctClass)</div><div class="line">    &#125;</div><div class="line">    createPatchesInfoClass(patchPath);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<h2 id="é€æ­¥ç¿»è¯‘"><a href="#é€æ­¥ç¿»è¯‘" class="headerlink" title="é€æ­¥ç¿»è¯‘"></a>é€æ­¥ç¿»è¯‘</h2><p>é¦–å…ˆè°ƒç”¨<code>InlineClassFactory.dealInLineClass(patchPath, Config.newlyAddedClassNameList)</code>è¯†åˆ«è¢«ä¼˜åŒ–è¿‡çš„æ–¹æ³•ï¼Œè¿™é‡Œçš„ä¼˜åŒ–æ˜¯æ³›æŒ‡ï¼ŒåŒ…æ‹¬è¢«ä¼˜åŒ–ã€å†…è”ã€æ–°å¢è¿‡çš„ç±»å’Œæ–¹æ³•ï¼Œå…·ä½“çš„é€»è¾‘ä¸ºæ‰«æä¿®æ”¹åçš„æ‰€æœ‰ç±»å’Œç±»ä¸­çš„æ–¹æ³•ï¼Œå¦‚æœè¿™äº›ç±»å’Œæ–¹æ³•ä¸åœ¨ mapping æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå¯ä»¥å®šä¹‰ä¸ºè¢«ä¼˜åŒ–è¿‡ï¼Œå…¶ä¸­åŒ…æ‹¬<code>@Add</code>æ–°å¢çš„ç±»æˆ–æ–¹æ³•ã€‚<br>ç„¶åè°ƒç”¨<code>initSuperMethodInClass</code>æ–¹æ³•è¯†åˆ«ä¿®æ”¹åçš„æ‰€æœ‰ç±»å’Œç±»ä¸­çš„æ–¹æ³•ä¸­ï¼Œåˆ†ææ˜¯å¦å¦‚åŒ…å« <code>super</code> æ–¹æ³•ï¼Œå¦‚æœæœ‰é‚£ä¹ˆç¼“å­˜ä¸‹æ¥ã€‚<br>ç„¶åè°ƒç”¨ <code>PatchesFactory.createPatch</code> åå°„ç¿»è¯‘ä¿®æ”¹çš„ç±»å’Œæ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> CtClass <span class="title">createPatchClass</span><span class="params">(CtClass modifiedClass, <span class="keyword">boolean</span> isInline, String patchName, Set patchMethodSignureSet, String patchPath)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException </span>&#123;</div><div class="line">    <span class="comment">//æ¸…æ´—éœ€è¦å¤„ç†çš„æ–¹æ³•ï¼Œç•¥..</span></div><div class="line"></div><div class="line">    CtClass temPatchClass = cloneClass(modifiedClass, patchName, methodNoNeedPatchList);</div><div class="line">    </div><div class="line">    JavaUtils.addPatchConstruct(temPatchClass, modifiedClass);</div><div class="line">    CtMethod reaLParameterMethod = CtMethod.make(JavaUtils.getRealParamtersBody(), temPatchClass);</div><div class="line">    temPatchClass.addMethod(reaLParameterMethod);</div><div class="line"></div><div class="line">    dealWithSuperMethod(temPatchClass, modifiedClass, patchPath);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (CtMethod method : temPatchClass.getDeclaredMethods()) &#123;</div><div class="line">        <span class="comment">//  shit !!too many situations need take into  consideration</span></div><div class="line">        <span class="comment">//   methods has methodid   and in  patchMethodSignatureSet</span></div><div class="line">        <span class="keyword">if</span> (!Config.addedSuperMethodList.contains(method) &amp;&amp; reaLParameterMethod != method &amp;&amp; !method.getName().startsWith(Constants.ROBUST_PUBLIC_SUFFIX)) &#123;</div><div class="line">            method.instrument(</div><div class="line">                    <span class="keyword">new</span> ExprEditor() &#123;</div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">edit</span><span class="params">(FieldAccess f)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            ...</div><div class="line">                                <span class="keyword">if</span> (f.isReader()) &#123; f.replace(ReflectUtils.getFieldString(f.getField(), memberMappingInfo, temPatchClass.getName(), modifiedClass.getName()));</div><div class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.isWriter()) &#123;</div><div class="line">                                    f.replace(ReflectUtils.setFieldString(f.getField(), memberMappingInfo, temPatchClass.getName(), modifiedClass.getName()));</div><div class="line">                                &#125;</div><div class="line">                            ...</div><div class="line">                        &#125;</div><div class="line"></div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(NewExpr e)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            <span class="comment">//inner class in the patched class ,not all inner class</span></div><div class="line">                            ...</div><div class="line">                                <span class="keyword">if</span> (!ReflectUtils.isStatic(Config.classPool.get(e.getClassName()).getModifiers()) &amp;&amp; JavaUtils.isInnerClassInModifiedClass(e.getClassName(), modifiedClass)) &#123;</div><div class="line">                                    e.replace(ReflectUtils.getNewInnerClassString(e.getSignature(), temPatchClass.getName(), ReflectUtils.isStatic(Config.classPool.get(e.getClassName()).getModifiers()), getClassValue(e.getClassName())));</div><div class="line">                                    <span class="keyword">return</span>;</div><div class="line">                                &#125;</div><div class="line">                            ...</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(Cast c)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            MethodInfo thisMethod = ReflectUtils.readField(c, <span class="string">"thisMethod"</span>);</div><div class="line">                            CtClass thisClass = ReflectUtils.readField(c, <span class="string">"thisClass"</span>);</div><div class="line"></div><div class="line">                            def isStatic = ReflectUtils.isStatic(thisMethod.getAccessFlags());</div><div class="line">                            <span class="keyword">if</span> (!isStatic) &#123;</div><div class="line">                                <span class="comment">//inner class in the patched class ,not all inner class</span></div><div class="line">                                <span class="keyword">if</span> (Config.newlyAddedClassNameList.contains(thisClass.getName()) || Config.noNeedReflectClassSet.contains(thisClass.getName())) &#123;</div><div class="line">                                    <span class="keyword">return</span>;</div><div class="line">                                &#125;</div><div class="line">                                <span class="comment">// staticå‡½æ•°æ˜¯æ²¡æœ‰thisæŒ‡ä»¤çš„ï¼Œç›´æ¥ä¼šæŠ¥é”™ã€‚</span></div><div class="line">                                c.replace(ReflectUtils.getCastString(c, temPatchClass))</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(MethodCall m)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            ...</div><div class="line">                                <span class="keyword">if</span> (!repalceInlineMethod(m, method, <span class="keyword">false</span>)) &#123;</div><div class="line">                                    Map memberMappingInfo = getClassMappingInfo(m.getMethod().getDeclaringClass().getName());</div><div class="line">                                    <span class="keyword">if</span> (invokeSuperMethodList.contains(m.getMethod())) &#123;</div><div class="line">                                        <span class="keyword">int</span> index = invokeSuperMethodList.indexOf(m.getMethod());</div><div class="line">                                        CtMethod superMethod = invokeSuperMethodList.get(index);</div><div class="line">                                        <span class="keyword">if</span> (superMethod.getLongName() != <span class="keyword">null</span> &amp;&amp; superMethod.getLongName() == m.getMethod().getLongName()) &#123;</div><div class="line">                                            String firstVariable = <span class="string">""</span>;</div><div class="line">                                            <span class="keyword">if</span> (ReflectUtils.isStatic(method.getModifiers())) &#123;</div><div class="line">                                                <span class="comment">//ä¿®å¤static æ–¹æ³•ä¸­å«æœ‰superçš„é—®é¢˜ï¼Œæ¯”å¦‚Aspectjå¤„ç†åçš„æ–¹æ³•</span></div><div class="line">                                                MethodInfo methodInfo = method.getMethodInfo();</div><div class="line">                                                LocalVariableAttribute table = methodInfo.getCodeAttribute().getAttribute(LocalVariableAttribute.tag);</div><div class="line">                                                <span class="keyword">int</span> numberOfLocalVariables = table.tableLength();</div><div class="line">                                                <span class="keyword">if</span> (numberOfLocalVariables &gt; <span class="number">0</span>) &#123;</div><div class="line">                                                    <span class="keyword">int</span> frameWithNameAtConstantPool = table.nameIndex(<span class="number">0</span>);</div><div class="line">                                                    firstVariable = methodInfo.getConstPool().getUtf8Info(frameWithNameAtConstantPool)</div><div class="line">                                                &#125;</div><div class="line">                                            &#125;</div><div class="line">                                            m.replace(ReflectUtils.invokeSuperString(m, firstVariable));</div><div class="line">                                            <span class="keyword">return</span>;</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;</div><div class="line">                                    m.replace(ReflectUtils.getMethodCallString(m, memberMappingInfo, temPatchClass, ReflectUtils.isStatic(method.getModifiers()), isInline));</div><div class="line">                                &#125;</div><div class="line">                            ...</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//remove static code block,pay attention to the  class created by cloneClassWithoutFields which construct's</span></div><div class="line">    CtClass patchClass = cloneClassWithoutFields(temPatchClass, patchName, <span class="keyword">null</span>);</div><div class="line">    patchClass = JavaUtils.addPatchConstruct(patchClass, modifiedClass);</div><div class="line">    <span class="keyword">return</span> patchClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å…¶å®æ˜¯è¿™ä¸ªæ’ä»¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œæ€»ä½“æ¥è¯´å°±æ˜¯å°†ä¿®æ”¹åçš„ä»£ç å…¨éƒ¨ç¿»è¯‘æˆåå°„è°ƒç”¨ç”Ÿæˆ xxxPatch ç±»ã€‚<br>æˆ‘ä»¬å…ˆåªå…³æ³¨<code>method.instrument()</code>è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªJavassistçš„APIï¼Œä½œç”¨æ˜¯éå†æ–¹æ³•ä¸­çš„ä»£ç é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>FieldAccessï¼Œå­—æ®µè®¿é—®æ“ä½œã€‚åˆ†ä¸ºå­—æ®µè¯»å’Œå†™ä¸¤ç§ï¼Œåˆ†åˆ«è°ƒç”¨<code>ReflectUtils.getFieldString</code>æ–¹æ³•ï¼Œå°†ä»£ç é€»è¾‘ä½¿ç”¨Javassistç¿»è¯‘æˆåå°„è°ƒç”¨ï¼Œç„¶åæ›¿æ¢ã€‚</li>
<li>NewExprï¼Œnew å¯¹è±¡æ“ä½œã€‚ä¹Ÿåˆ†ä¸ºä¸¤ç§<ul>
<li>éé™æ€å†…éƒ¨ç±»ï¼Œè°ƒç”¨<code>ReflectUtils.getNewInnerClassString</code>ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
<li>å¤–éƒ¨ç±»ï¼Œè°ƒç”¨<code>ReflectUtils.getCreateClassString</code>ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
</ul>
</li>
<li>Castï¼Œå¼ºè½¬æ“ä½œã€‚è°ƒç”¨<code>ReflectUtils.getCastString</code>ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
<li>MethodCallï¼Œæ–¹æ³•è°ƒç”¨æ“ä½œã€‚æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œä»¥ä¸‹å‡ ç§æƒ…å½¢<ul>
<li>lamdaè¡¨è¾¾å¼ï¼Œè°ƒç”¨<code>ReflectUtils.getNewInnerClassString</code>ç”Ÿæˆå†…éƒ¨ç±»çš„æ–¹æ³•å¹¶ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
<li>ä¿®æ”¹çš„æ–¹æ³•æ˜¯å†…è”æ–¹æ³•ï¼Œè°ƒç”¨<code>ReflectUtils.getInLineMemberString</code>æ–¹æ³•ç”Ÿæˆå ä½å†…è”ç±»<code>xxInLinePatch</code>ï¼Œå¹¶åœ¨æ”¹ç±»ä¸­æŠŠä¿®æ”¹çš„æ–¹æ³•ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢è°ƒç”¨ï¼Œè¿™æ–¹æ³•ä¸­åˆæœ‰ä¸€äº›å…¶ä»–æƒ…å†µåˆ¤æ–­ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»</li>
<li>å¦‚æœæ˜¯superæ–¹æ³•ï¼Œè¿™ä¸ªæƒ…å†µåé¢å•ç‹¬æ‹å‡ºæ¥è¯´</li>
<li>æ­£å¸¸æ–¹æ³•ï¼Œè°ƒç”¨<code>ReflectUtils.getMethodCallString</code>æ–¹æ³•ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
</ul>
</li>
<li>ç”Ÿæˆè¡¥ä¸ç±»å¹¶å¢åŠ æ„é€ æ–¹æ³•</li>
</ul>
<p>è¯·æ³¨æ„ï¼Œä»¥ä¸Šæ‰€æœ‰æ–¹æ³•å’Œéœ€è¦å¤„ç†çš„æ–¹æ³•éƒ½éœ€è¦ç‰¹åˆ«æ³¨æ„æ–¹æ³•ç­¾åï¼</p>
<h2 id="æ§åˆ¶è¡¥ä¸è¡Œä¸º"><a href="#æ§åˆ¶è¡¥ä¸è¡Œä¸º" class="headerlink" title="æ§åˆ¶è¡¥ä¸è¡Œä¸º"></a>æ§åˆ¶è¡¥ä¸è¡Œä¸º</h2><p>æœ€åè°ƒç”¨ <code>createControlClass(patchPath, ctClass)</code>ã€<code>createPatchesInfoClass(patchPath);</code>ç”Ÿæˆ PatchesInfoImplã€xxxPatchControl å†™å…¥è¡¥ä¸ä¿¡æ¯å’Œæ§åˆ¶è¡¥ä¸è¡Œä¸ºã€‚</p>
<p>å…¶ä¸­ï¼Œ<code>PatchesInfoImpl</code>ä¸­åŒ…å«æ‰€æœ‰è¡¥ä¸ç±»çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œæ¯”å¦‚ <code>MainActivity -&gt; MainActivityPatch</code>ï¼Œä¸æ¸…æ¥šçš„å¯ä»¥å‚è€ƒè¯¥ç³»åˆ—çš„ä¸Šä¸€ç¯‡æ–‡ç« ã€‚ç”Ÿæˆçš„<code>xxxPatchControl</code>ç±»ç”¨äºç”Ÿæˆ<code>xxPatch</code>ç±»ï¼Œå¹¶åˆ¤æ–­è¡¥ä¸ä¸­çš„æ–¹æ³•æ˜¯å¦å’Œmethods.robustä¸­çš„æ–¹æ³•idåŒ¹é…ï¼Œå¦‚æœåŒ¹é…æ‰ä¼šå»è°ƒç”¨è¡¥ä¸ä¸­æ–¹æ³•ã€‚</p>
<p>è‡³æ­¤æ•´ä½“æµç¨‹åŸºæœ¬æ¢³ç†å®Œæˆã€‚åé¢ä¼šé’ˆå¯¹å…·ä½“çš„å¤æ‚æƒ…å†µåŠ ä»¥è§£æã€‚</p>
<h1 id="this-å¦‚ä½•å¤„ç†"><a href="#this-å¦‚ä½•å¤„ç†" class="headerlink" title="this å¦‚ä½•å¤„ç†"></a>this å¦‚ä½•å¤„ç†</h1><p>é¦–å…ˆï¼Œåœ¨è¡¥ä¸ç±»ä¸­ xxPatch ä¸­ï¼Œ<code>this</code>æŒ‡ä»£çš„æ˜¯xxPatchç±»çš„å¯¹è±¡ï¼Œè€Œæˆ‘ä»¬æ˜¯æƒ³è¦çš„å¯¹è±¡æ˜¯è¢«è¡¥ä¸çš„ç±»çš„å¯¹è±¡ã€‚</p>
<p>åœ¨<code>PatchesFactory.createPatchClass()</code>æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">CtMethod reaLParameterMethod = CtMethod.make(JavaUtils.getRealParamtersBody(), temPatchClass);</div><div class="line">temPatchClass.addMethod(reaLParameterMethod);</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRealParamtersBody</span><span class="params">()</span> </span>&#123;</div><div class="line">    StringBuilder realParameterBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">    realParameterBuilder.append(<span class="string">"public  Object[] "</span> + Constants.GET_REAL_PARAMETER + <span class="string">" (Object[] args)&#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"if (args == null || args.length &lt; 1) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" return args;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"&#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" Object[] realParameter = new Object[args.length];"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"for (int i = 0; i &lt; args.length; i++) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"if (args[i] instanceof Object[]) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"realParameter[i] ="</span> + Constants.GET_REAL_PARAMETER + <span class="string">"((Object[]) args[i]);"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"&#125; else &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"if (args[i] ==this) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" realParameter[i] =this."</span> + ORIGINCLASS + <span class="string">";"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"&#125; else &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" realParameter[i] = args[i];"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"  return realParameter;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    <span class="keyword">return</span> realParameterBuilder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µçš„ä½œç”¨æ˜¯ï¼Œåœ¨æ¯ä¸ªxxPatchè¡¥ä¸ç±»ä¸­éƒ½æ’å…¥ä¸€ä¸ª<code>getRealParameter()</code>æ–¹æ³•ï¼Œåç¼–è¯‘å‡ºæ¥æœ€ç»ˆçš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Object[] getRealParameter(Object[] objArr) &#123;</div><div class="line">    <span class="keyword">if</span> (objArr == <span class="keyword">null</span> || objArr.length &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> objArr;</div><div class="line">    &#125;</div><div class="line">    Object[] objArr2 = <span class="keyword">new</span> Object[objArr.length];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objArr.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (objArr[i] <span class="keyword">instanceof</span> Object[]) &#123;</div><div class="line">            objArr2[i] = getRealParameter((Object[]) objArr[i]);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objArr[i] == <span class="keyword">this</span>) &#123;</div><div class="line">            objArr2[i] = <span class="keyword">this</span>.originClass;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            objArr2[i] = objArr[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> objArr2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ƒçš„ä½œç”¨æ˜¯ï¼Œåœ¨æ¯ä¸ªxxPatchä¸­ä½¿ç”¨çš„<code>this</code>ï¼Œéƒ½è½¬æ¢æˆxxè¢«è¡¥ä¸ç±»çš„å¯¹è±¡ã€‚å…¶ä¸­çš„<code>originClass</code>å°±æ˜¯è¡¥ä¸ç±»çš„å¯¹è±¡ã€‚</p>
<h1 id="super-å¦‚ä½•å¤„ç†"><a href="#super-å¦‚ä½•å¤„ç†" class="headerlink" title="super å¦‚ä½•å¤„ç†"></a>super å¦‚ä½•å¤„ç†</h1><p>åŒ<code>this</code>ç±»ä¼¼ï¼ŒxxPatchä¸­è°ƒç”¨ <code>super</code> æ–¹æ³•åŒæ ·éœ€è¦è½¬ä¸ºè°ƒç”¨è¢«è¡¥ä¸ç±»ä¸­ç›¸å…³æ–¹æ³•çš„<code>super</code>è°ƒç”¨ã€‚</p>
<p>è¿˜æ˜¯åœ¨<code>PatchesFactory.createPatchClass()</code>æ–¹æ³•ä¸­æœ‰<code>dealWithSuperMethod(temPatchClass, modifiedClass, patchPath);</code>è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dealWithSuperMethod</span><span class="params">(CtClass patchClass, CtClass modifiedClass, String patchPath)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException </span>&#123;</div><div class="line">    ...</div><div class="line">    methodBuilder.append(<span class="string">"public  static "</span> + invokeSuperMethodList.get(index).getReturnType().getName() + <span class="string">"  "</span> + ReflectUtils.getStaticSuperMethodName(invokeSuperMethodList.get(index).getName()) + <span class="string">"("</span> + patchClass.getName() + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance,"</span> + JavaUtils.getParameterSignure(invokeSuperMethodList.get(index)) + <span class="string">")&#123;"</span>);</div><div class="line">    ...</div><div class="line">    CtClass assistClass = PatchesAssistFactory.createAssistClass(modifiedClass, patchClass.getName(), invokeSuperMethodList.get(index));</div><div class="line">    ...</div><div class="line">    methodBuilder.append(NameManger.getInstance().getAssistClassName(patchClass.getName()) + <span class="string">"."</span> + ReflectUtils.getStaticSuperMethodName(invokeSuperMethodList.get(index).getName())  + <span class="string">"(patchInstance,modifiedInstance"</span>);</div><div class="line">    ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¿ç•™ä¸»è¦ä»£ç ï¼Œæ ¹æ®æ–¹æ³•ç­¾åç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œä»¥<code>staticRobust+methodName</code>å‘½åï¼Œæ–¹æ³•ä¸­è°ƒç”¨ä»¥<code>RobustAssist</code>ç»“å°¾çš„ç±»ä¸­çš„åŒåæ–¹æ³•ï¼Œå¹¶è°ƒç”¨ <code>PatchesAssistFactory.createAssistClass</code> æ–¹æ³•ç”Ÿæˆè¯¥ç±»ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯è¢«è¡¥ä¸ç±»çš„çˆ¶ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">PatchesAssistFactory.createAssistClass:</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">createAssistClass</span><span class="params">(CtClass modifiedClass, String patchClassName, CtMethod removeMethod)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    staticMethodBuidler.append(<span class="string">"public static  "</span> + removeMethod.returnType.name + <span class="string">"   "</span> + ReflectUtils.getStaticSuperMethodName(removeMethod.getName())</div><div class="line">            + <span class="string">"("</span> + patchClassName + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance)&#123;"</span>);</div><div class="line">                </div><div class="line">    staticMethodBuidler.append(<span class="string">" return patchInstance."</span> + removeMethod.getName() + <span class="string">"("</span> + JavaUtils.getParameterValue(removeMethod.getParameterTypes().length) + <span class="string">");"</span>);</div><div class="line">    staticMethodBuidler.append(<span class="string">"&#125;"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨éå†<code>MethodCall</code>è¿‡ç¨‹ä¸­ï¼Œå¤„ç†æ–¹æ³•è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">m.replace(ReflectUtils.invokeSuperString(m, firstVariable));</div><div class="line">...</div><div class="line"><span class="function">def <span class="keyword">static</span> String <span class="title">invokeSuperString</span><span class="params">(MethodCall m, String originClass)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    stringBuilder.append(getStaticSuperMethodName(m.methodName) + <span class="string">"(this,"</span> + Constants.ORIGINCLASS + <span class="string">",\$\$);"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¼ é€’çš„å‚æ•°ï¼Œpatchã€originClassï¼ˆè¢«è¡¥ä¸ç±»å¯¹è±¡ï¼‰ã€æ–¹æ³•å®é™…å‚æ•°åˆ—è¡¨ã€‚</p>
<p>åç¼–è¯‘å‡ºçš„ç»“æœå®é™…æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity:</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">MainFragmentActivityPatch:</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">    MainFragmentActivityPatchRobustAssist.staticRobustonCreate(mainFragmentActivityPatch, mainFragmentActivity, bundle);</div><div class="line">&#125;</div><div class="line"></div><div class="line">MainFragmentActivityPatchRobustAssist:</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivityPatchRobustAssist</span> <span class="keyword">extends</span> <span class="title">WrapperAppCompatFragmentActivity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        mainFragmentActivityPatch.onCreate(bundler);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‚æ•°æ˜¯æŒ‰ç…§å®é™…çš„æ–¹æ³•å‚æ•°ä¼ è¿›å»çš„ï¼Œæœ€åè°ƒç”¨äº†xxPatch.superMethodæ–¹æ³•ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿå¹¶æ²¡æœ‰å®ç°<code>super</code>æ–¹æ³•çš„è½¬ä¹‰å•Šï¼Œå†å¾€ä¸‹çœ‹ã€‚</p>
<p>åœ¨å¤„ç†smaliè¿‡ç¨‹ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">invokeSuperMethodInSmali</span><span class="params">(<span class="keyword">final</span> String line, String fullClassName)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    result = line.replace(Constants.SMALI_INVOKE_VIRTUAL_COMMAND, Constants.SMALI_INVOKE_SUPER_COMMAND);</div><div class="line">    ...</div><div class="line">    result = result.replace(<span class="string">"p0"</span>, <span class="string">"p1"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å¤„ç†ä¹‹å‰ï¼Œsmaliæ˜¯é•¿è¿™æ ·çš„ï¼š<code>invoke-invoke-virtual {p0, p2}, Lcom/meituan/robust/patch/SecondActivityPatch;-&gt;onCreate(Landroid/os/Bundle;)V</code>,<br>å¤„ç†ä¹‹åæ˜¯è¿™æ ·çš„ï¼š<code>invoke-super {p1, p2}, Landroid/support/v7/app/AppCompatActivity;-&gt;onCreate(Landroid/os/Bundle;)V</code>ï¼Œæ„æ€å°±æ˜¯æœ¬æ¥æ˜¯è°ƒç”¨æ­£å¸¸æ–¹æ³•ï¼Œç°åœ¨è½¬ä¸ºè°ƒç”¨superæ–¹æ³•ï¼Œå¹¶ä¸”æŠŠå‚æ•°æ¢äº†ä¸€ä¸‹ï¼ŒæŠŠp0(è¡¥ä¸ç±»å¯¹è±¡)æ¢æˆäº†p1ï¼ˆè¢«è¡¥ä¸ç±»å¯¹è±¡ï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†<code>super</code>çš„å¤„ç†ã€‚åç¼–è¯‘åæœ€ç»ˆç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivityPatchRobustAssist</span> <span class="keyword">extends</span> <span class="title">WrapperAppCompatFragmentActivity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="å†…è”æ€ä¹ˆå¤„ç†"><a href="#å†…è”æ€ä¹ˆå¤„ç†" class="headerlink" title="å†…è”æ€ä¹ˆå¤„ç†"></a>å†…è”æ€ä¹ˆå¤„ç†</h1><p>å†…è”æ˜¯ä¸ªå¹¿ä¹‰çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬äº†æ··æ·†è¿‡ç¨‹ä¸­çš„ä¼˜åŒ–(ä¿®æ”¹æ–¹æ³•ç­¾åã€åˆ é™¤æ–¹æ³•ç­‰)ã€å†…è”ã€‚åœ¨ä¸Šé¢çš„åˆ†æä¸­å¤„ç†ziæ–¹æ³•åŸºæœ¬ä¹Ÿæåˆ°äº†ï¼Œç¼ºå•¥è¡¥å•¥ï¼šå°±æ˜¯æŠŠå†…è”æ‰çš„æ–¹æ³•å†è¡¥å›æ¥ã€‚<br>å¯¹äºå†…è”çš„æ–¹æ³•ï¼Œä¸èƒ½ç”¨<code>@Modify</code>æ³¨è§£æ ‡æ³¨ï¼Œåªèƒ½ä½¿ç”¨<code>RobustModify.modify()</code>æ ‡æ³¨ï¼Œå› ä¸ºåœ¨åŸºç¡€åŒ…ä¸­æ–¹æ³•éƒ½æ²¡äº†ï¼Œæ‰“äº†lè¡¥ä¸æ–¹æ³•ä¹Ÿæ²¡ç”¨ã€‚</p>
<p>ä¸»è¦é€»è¾‘åœ¨éå†<code>MethodCall</code> -&gt; <code>repalceInlineMethod()</code> -&gt; <code>ReflectUtils.getInLineMemberString()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">stringBuilder.append(<span class="string">" instance=new "</span> + NameManger.getInstance().getInlinePatchName(method.declaringClass.name) + <span class="string">"(\$0);"</span>)</div><div class="line">stringBuilder.append(<span class="string">"\$_=(\$r)instance."</span> + getInLineMethodName(method) + <span class="string">"("</span> + parameterBuilder.toString() + <span class="string">");"</span>)</div><div class="line">...</div></pre></td></tr></table></figure>
<p>ä½œç”¨å°±æ˜¯æŠŠå†…è”æ‰çš„æ–¹æ³•è°ƒç”¨æ›¿æ¢ä¸ºInLineç±»ä¸­çš„æ–°å¢æ–¹æ³•ã€‚</p>
<p>ç»“æœå°±æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String first=<span class="keyword">null</span>;</div><div class="line">    <span class="comment">//privateMethodè¢«å†…è”äº†</span></div><div class="line">    <span class="comment">// private void privateMethod(String fir)&#123;</span></div><div class="line">    <span class="comment">//    System.out.println(fir);</span></div><div class="line">    <span class="comment">//&#125;</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(String fir)</span></span>&#123;</div><div class="line">        first=fir;</div><div class="line">        Parent children=<span class="keyword">new</span> Children();</div><div class="line">        <span class="comment">//children.privateMethod("Robust");</span></div><div class="line">        <span class="comment">//å†…è”æ›¿æ¢çš„é€»è¾‘</span></div><div class="line">        ParentInline inline= <span class="keyword">new</span> ParentInline(children);</div><div class="line">        inline.privateMethod(<span class="string">"Robust"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParentInline</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Parent children ;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParentInline</span><span class="params">(Parent p)</span></span>&#123;</div><div class="line">       children=p;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ··æ·†ä¸ºc</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">privateMethod</span><span class="params">(String fir)</span></span>&#123;</div><div class="line">        System.out.println(fir);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Robust çš„æ ¸å¿ƒå…¶å®å°±æ˜¯è‡ªåŠ¨åŒ–ç”Ÿæˆè¡¥ä¸è¿™å—ï¼Œè‡³äºæ’åº„ã€è¡¥ä¸åŠ è½½è¿™äº›éƒ½æ˜¯å¾ˆå¥½å®ç°çš„ï¼Œå› ä¸ºæ²¡æœ‰å¾ˆå¤šçš„ç‰¹æ®Šæƒ…å†µéœ€è¦å¤„ç†ã€‚<br>è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æäº†è‡ªåŠ¨åŒ–è¡¥ä¸æ’ä»¶çš„ä¸»è¦å·¥ä½œæµç¨‹ï¼Œå’Œä¸€äº›ç‰¹æ®Šæƒ…å†µçš„å¤„ç†ï¼Œæ–‡ç« æœ‰é™ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šç‰¹æ®Šæƒ…å†µæ²¡æœ‰åˆ†æï¼Œè¿™é‡Œåªæ˜¯æä¾›ä¸€äº›åˆ†ææºç çš„æ€è·¯ï¼Œç¢°åˆ°ç‰¹æ®Šæƒ…å†µå¯ä»¥æŒ‰ç…§è¿™ä¸ªæ€è·¯æ’æŸ¥è§£å†³é—®é¢˜ã€‚</p>
<p>å°±åƒä»£ç ä¸­æœ‰ä¸€è¡Œæ³¨é‡Šï¼Œæˆ‘è§‰å¾—ç‰¹åˆ«èƒ½æ¦‚æ‹¬è‡ªåŠ¨åŒ–ç”Ÿæˆè¡¥ä¸çš„å›¢é˜Ÿçš„å¿ƒé‡Œè·¯ç¨‹ï¼Œåœ¨æ­¤ä¹Ÿå†æ¬¡æ„Ÿè°¢ç¾å›¢å›¢é˜Ÿå¯¹å¼€æºåšå‡ºçš„è´¡çŒ®ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  shit !!too many situations need take into  consideration</span></div></pre></td></tr></table></figure></p>
<p>æ€»ä½“æ¥è¯´ï¼ŒRobust å‘æ˜¯æœ‰çš„ï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯é«˜å¯ç”¨æ€§ã€é«˜å…¼å®¹æ€§çš„çƒ­ä¿®å¤æ¡†æ¶ï¼Œå°¤å…¶æ˜¯åœ¨Android ç³»ç»Ÿå¼€æ”¾æ€§è¶Šæ¥è¶Šæ”¶ç´§çš„è¶‹åŠ¿ä¸‹ï¼ŒRobust  ä½œä¸ºä¸ hook ç³»ç»Ÿ API çš„çƒ­ä¿®å¤æ¡†æ¶ä¼˜åŠ¿æ›´åŠ çªå‡ºã€‚è™½ç„¶å…¶ä¸­å¯èƒ½æœ‰ä¸€äº›å‘ï¼Œåªè¦æˆ‘ä»¬å¯¹åŸç†ç†Ÿæ‚‰æŒæ¡ï¼Œæ‰æœ‰ä¿¡å¿ƒèƒ½æå®šè¿™äº›é—®é¢˜ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œä¸»è¦å°±è®²ä¸‹Robustä¸å…¶ä»–æ¡†æ¶æ­é…ä½¿ç”¨å‡ºç°çš„ä¸€äº›å‘ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://tech.meituan.com/android_autopatch.html" target="_blank" rel="external">Androidçƒ­æ›´æ–°æ–¹æ¡ˆRobustå¼€æºï¼Œæ–°å¢è‡ªåŠ¨åŒ–è¡¥ä¸å·¥å…·</a></li>
<li><a href="https://www.jianshu.com/p/b9b3ff0e1bf8" target="_blank" rel="external">Javassist ä½¿ç”¨æŒ‡å—ï¼ˆäºŒï¼‰</a></li>
<li><a href="https://juejin.im/entry/579ef6e37db2a2005a6350d8" target="_blank" rel="external">[è½¬] æ·±å…¥ç†è§£ Dalvik å­—èŠ‚ç æŒ‡ä»¤åŠ Smali æ–‡ä»¶</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2018/05/28/robust-1/">http://w4lle.com/2018/05/28/robust-1/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¡¥ä¸åŠ è½½è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« &lt;a href=&quot;http://w4lle.com/2017/03/31/robust-0/&quot;&gt;Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)&lt;/a&gt;ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†å‰ä¸¤ä¸ªï¼Œè¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º &lt;code&gt;0.3.2&lt;/code&gt;ã€‚&lt;br&gt;è¯¥ç¯‡æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œä¸»è¦åˆ†æè¡¥ä¸è‡ªåŠ¨åŒ–ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º&lt;code&gt;0.4.82&lt;/code&gt;ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Python å¤„ç† pdf</title>
    <link href="http://w4lle.com/2018/02/02/python-pdf/"/>
    <id>http://w4lle.com/2018/02/02/python-pdf/</id>
    <published>2018-02-02T01:34:45.000Z</published>
    <updated>2018-02-05T01:33:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘è€å©†å·¥ä½œä¸­ç¢°åˆ°ä¸€äº›å›°éš¾ï¼Œæ€»æ˜¯è·Ÿæˆ‘æŠ±æ€¨å·¥ä½œå¥½çƒ¦ï¼Œä¸å¼€å¿ƒã€‚<br>ä¸»è¦æ˜¯æ˜¯å› ä¸ºè¦å¤„ç†ä¸€äº›æŠ¥å‘Šï¼Œè¿™äº› pdf æ ¼å¼çš„æ ·æœ¬æŠ¥å‘Šæ¯”è¾ƒå¤šï¼ŒåŸºæœ¬éƒ½æ˜¯äººå·¥æ“ä½œæ¯”è¾ƒå®¹æ˜“å‡ºé”™ï¼Œä¹Ÿæ¯”è¾ƒçç¢ï¼Œå¥½å¿ƒæƒ…éƒ½è¢«ç£¨æ²¡äº†ã€‚</p>
<p>ç„¶åæˆ‘è¯´è¦ä¹ˆå†™ä¸ªå°ç¨‹åºå§ï¼Œå¸®ä½ å¤„ç†è¿™äº›çç¢çš„å·¥ä½œï¼Œç„¶åå°±å¤§æ¦‚æ¢³ç†äº†ä¸€ä¸‹ä¸»è¦éœ€æ±‚ï¼š</p>
<a id="more"></a>
<p>å†…éƒ¨æŠ¥å‘Šï¼š</p>
<ol>
<li>é¦–å…ˆéœ€è¦ä»ç³»ç»Ÿå‡ºå¯¼å‡ºä¸€ä¸ªå¤§çš„ pdfï¼ŒåŒ…å«å¾ˆå¤šå°çš„ pdf</li>
<li>æ¯ä¸ªå°çš„ pdf æŠ¥å‘Šä¸­åŒ…å«ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ æŠ¥å‘Šæ ‡é¢˜ã€å§“åã€ç¼–å·ã€åŒ»é™¢ã€æ€»é¡µæ•°</li>
<li>æ‹¿åˆ°è¿™äº›ä¿¡æ¯ä¹‹åï¼Œåˆ†å‰²å¤§çš„ pdfï¼Œå°†å°çš„ pdf æŠ¥å‘Šå‰¥ç¦»å¤„ç†</li>
<li>ç„¶åé‡å‘½åè¿™äº›æŠ¥å‘Šï¼Œæ ¼å¼ä¸º <code>å§“å-ç¼–å·.pdf</code></li>
<li>å°†è¿™äº›æŠ¥å‘Šç§»åŠ¨åˆ°å¯¹åº”åŒ»é™¢çš„ç›®å½•ä¸‹ï¼Œç„¶åå°†è¿™äº›åŒ»é™¢ç›®å½•å‹ç¼©</li>
</ol>
<p>å¤–éƒ¨æŠ¥å‘Šï¼š</p>
<ol>
<li>å¤–éƒ¨ä¼šå‘è¿‡æ¥å‹ç¼©åŒ…ï¼Œå…¶ä¸­åŒ…å«å•ä¸ªçš„ pdf æŠ¥å‘Š</li>
<li>è§£å‹ç¼©åå°†æŠ¥å‘Šæ‹¿å‡ºæ¥ï¼Œæå–å…¶ä¸­çš„ä¿¡æ¯ï¼Œä¿¡æ¯åŸºæœ¬åŒå†…éƒ¨æŠ¥å‘Š</li>
<li>é‡å‘½å</li>
<li>ç§»åŠ¨åˆ°å¯¹åº”çš„åŒ»é™¢ç›®å½•ä¸‹ï¼Œå¹¶å‹ç¼©</li>
</ol>
<h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><p>äººç”Ÿè‹¦çŸ­ï¼Œæˆ‘ç”¨pythonã€‚<br>å—¯ï¼Œpythonå¤§æ³•å¥½ï¼Œå¤„ç†è¿™äº›çç¢çš„äº‹æƒ…å†™ä¸ª python è„šæœ¬è·‘ä¸€ä¸‹ä¸å°±å¥½äº†å—ã€‚<br>python ç‰ˆæœ¬ä½¿ç”¨çš„python 3.xã€‚</p>
<p>æ¢³ç†äº†ä¸‹è¾“çƒï¼Œé¦–å…ˆéœ€è¦è§£æå¤§ pdf ä¸­çš„ä¸€äº›å…³é”®ä¿¡æ¯ï¼Œè½¬åŒ–ä¸ºæˆ‘ä»¬éœ€è¦çš„æŠ¥å‘Šä¿¡æ¯ï¼Œé¦–å…ˆå†™ä¸ªModelå«åš <code>Sample</code>ï¼ŒåŒ…å« titleã€numberã€nameã€total_pageã€hospital ç­‰ç­‰ï¼Œç„¶åä¾æ¬¡è§£æ pdf ç”Ÿæˆç»„æˆ samples åˆ—è¡¨ï¼Œæœ€åæ ¹æ®æŠ¥å‘Šåˆ—è¡¨åˆ†å‰²å¤„ç†pdf å°±å¥½äº†ã€‚</p>
<h2 id="è§£æ-pdf"><a href="#è§£æ-pdf" class="headerlink" title="è§£æ pdf"></a>è§£æ pdf</h2><p>æœ‰ä¸ª python åº“å«åš <a href="https://github.com/euske/pdfminer" target="_blank" rel="external">pdfminer</a>ï¼Œè¿™ä¸ªåº“å·²ç»ä¸æ”¯æŒpython 3.x ç‰ˆæœ¬äº†ï¼Œè¯¥é¡¹ç›®æ³¨æ˜äº†å¯ä»¥ä½¿ç”¨ <a href="https://github.com/pdfminer/pdfminer.six" target="_blank" rel="external">pdfminer.six</a>æ¥æ”¯æŒ3.xçš„ç‰ˆæœ¬ã€‚</p>
<p>åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_samples</span><span class="params">()</span>:</span></div><div class="line">    fp = open(get_origin_report_path(), <span class="string">'rb'</span>)  <span class="comment"># ä»¥äºŒè¿›åˆ¶è¯»æ¨¡å¼æ‰“å¼€</span></div><div class="line">    <span class="comment"># ç”¨æ–‡ä»¶å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªpdfæ–‡æ¡£åˆ†æå™¨</span></div><div class="line">    praser = PDFParser(fp)</div><div class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªPDFæ–‡æ¡£</span></div><div class="line">    doc = PDFDocument()</div><div class="line">    <span class="comment"># è¿æ¥åˆ†æå™¨ ä¸æ–‡æ¡£å¯¹è±¡</span></div><div class="line">    praser.set_document(doc)</div><div class="line">    doc.set_parser(praser)</div><div class="line"></div><div class="line">    <span class="comment"># æä¾›åˆå§‹åŒ–å¯†ç </span></div><div class="line">    <span class="comment"># å¦‚æœæ²¡æœ‰å¯†ç  å°±åˆ›å»ºä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²</span></div><div class="line">    doc.initialize()</div><div class="line"></div><div class="line">    <span class="comment"># æ£€æµ‹æ–‡æ¡£æ˜¯å¦æä¾›txtè½¬æ¢ï¼Œä¸æä¾›å°±å¿½ç•¥</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> doc.is_extractable:</div><div class="line">        <span class="keyword">raise</span> PDFTextExtractionNotAllowed</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="comment"># åˆ›å»ºPDf èµ„æºç®¡ç†å™¨ æ¥ç®¡ç†å…±äº«èµ„æº</span></div><div class="line">        rsrcmgr = PDFResourceManager()</div><div class="line">        <span class="comment"># åˆ›å»ºä¸€ä¸ªPDFè®¾å¤‡å¯¹è±¡</span></div><div class="line">        laparams = LAParams()</div><div class="line">        device = PDFPageAggregator(rsrcmgr, laparams=laparams)</div><div class="line">        <span class="comment"># åˆ›å»ºä¸€ä¸ªPDFè§£é‡Šå™¨å¯¹è±¡</span></div><div class="line">        interpreter = PDFPageInterpreter(rsrcmgr, device)</div><div class="line"></div><div class="line">        <span class="comment"># å¾ªç¯éå†åˆ—è¡¨ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ªpageçš„å†…å®¹</span></div><div class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> doc.get_pages():  <span class="comment"># doc.get_pages() è·å–pageåˆ—è¡¨</span></div><div class="line">            number_index = <span class="number">0</span></div><div class="line">            name_index = <span class="number">0</span></div><div class="line">            sample = Sample()</div><div class="line">            interpreter.process_page(page)</div><div class="line">            <span class="comment"># æ¥å—è¯¥é¡µé¢çš„LTPageå¯¹è±¡</span></div><div class="line">            layout = device.get_result()</div><div class="line">            <span class="comment"># è¿™é‡Œlayoutæ˜¯ä¸€ä¸ªLTPageå¯¹è±¡ é‡Œé¢å­˜æ”¾ç€ è¿™ä¸ªpageè§£æå‡ºçš„å„ç§å¯¹è±¡ ä¸€èˆ¬åŒ…æ‹¬LTTextBox, LTFigure, LTImage, LTTextBoxHorizontal ç­‰ç­‰ æƒ³è¦è·å–æ–‡æœ¬å°±è·å¾—å¯¹è±¡çš„textå±æ€§ï¼Œ</span></div><div class="line">            <span class="keyword">for</span> index, out <span class="keyword">in</span> enumerate(layout):</div><div class="line">                <span class="comment"># if hasattr(out, "get_text"):</span></div><div class="line">                <span class="comment"># if (isinstance(out, LTTextBoxHorizontal)):</span></div><div class="line">                <span class="keyword">if</span> (isinstance(out, LTTextBox)):</div><div class="line">                    <span class="keyword">with</span> open(get_log_path(), <span class="string">'a'</span>) <span class="keyword">as</span> outfile:</div><div class="line">                        results = out.get_text().replace(<span class="string">u'\xa0'</span>, <span class="string">u' '</span>)</div><div class="line">                        parse()</div><div class="line">                        ...</div><div class="line">                        ....</div></pre></td></tr></table></figure>
<p>å®˜ç½‘ç»™å‡ºçš„ layout å¸ƒå±€</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/pdfminer_layout.png" alt="layout"></p>
<p>æˆ‘ä»¬ä¸»è¦æ‹¿å…¶ä¸­çš„æ–‡æœ¬ä¿¡æ¯ï¼Œæ‰€ä»¥æ‹¿åˆ°æ¯ä¸€é¡µ pdf çš„LTPageåï¼Œéå†å…¶ä¸­çš„åŒ…å« text å±æ€§çš„æ§ä»¶å°±å¥½äº†ï¼Œæ‹¿åˆ°æ–‡æœ¬ä¿¡æ¯ï¼Œæ ¹æ®æ­£åˆ™åŒ¹é…åˆ°å…³å¿ƒçš„æ–‡æœ¬ä¿¡æ¯ï¼Œèµ‹å€¼ç»™æ–°å»ºçš„<code>sample</code>ï¼Œä¾æ¬¡å¾ªç¯ï¼Œæœ€åç»„æˆ <code>samples</code> æŠ¥å‘Šåˆ—è¡¨ç»™åé¢ä½¿ç”¨ã€‚<br>è§£æå®Œäº†åå°±éœ€è¦å¤„ç† pdf äº†ã€‚</p>
<h3 id="åˆ†å‰²-pdf"><a href="#åˆ†å‰²-pdf" class="headerlink" title="åˆ†å‰² pdf"></a>åˆ†å‰² pdf</h3><p>é¦–å…ˆè¦åšçš„æ˜¯å°†å¤§çš„ pdf åˆ†å‰²æˆå°çš„ pdfï¼Œæœäº†ä¸‹åˆ†å‰² pdf æœ‰ä¸ªpython åº“å«åš <a href="https://pythonhosted.org/PyPDF2/" target="_blank" rel="external">PyPDF2</a>ï¼Œå‚è€ƒAPI å†™äº†ä¸€ä¸ªå·¥å…·æ–¹æ³•ç”¨æ¥åˆ†å‰² pdfã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_pdf</span><span class="params">(infn, outfn, start_page, end_page)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    åˆ†å‰²pdfæ–‡æ¡£ï¼Œå¦‚æœéœ€è¦çš„è¯</div><div class="line"></div><div class="line">    :param infn: æºæŠ¥å‘Šç›®å½•</div><div class="line">    :param outfn: åˆ†å‰²åè¾“å‡ºæ–‡æ¡£ç›®å½•</div><div class="line">    :param start_page:</div><div class="line">    :param end_page:</div><div class="line">    :return:</div><div class="line">    """</div><div class="line">    pdf_output = PdfFileWriter()</div><div class="line">    pdf_input = PdfFileReader(open(infn, <span class="string">'rb'</span>))</div><div class="line">    <span class="comment"># è·å– pdf å…±ç”¨å¤šå°‘é¡µ</span></div><div class="line">    page_count = pdf_input.getNumPages()</div><div class="line">    <span class="comment"># å°† pdf çš„åˆ†å‰²é¡µé¢ï¼Œè¾“å‡ºåˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(start_page, end_page):</div><div class="line">        pdf_output.addPage(pdf_input.getPage(i))</div><div class="line">    pdf_output.write(open(outfn, <span class="string">'wb'</span>))</div><div class="line">    print(<span class="string">'---åˆ†å‰²pdfå®Œæ¯•--'</span>)</div></pre></td></tr></table></figure>
<p>æ ¹æ®ç¬¬ä¸€æ­¥å¾—å‡ºçš„ samplesï¼Œå¾ªç¯ä¸€ä¸‹æ‹¿å‡ºå…¶ä¸­çš„total_pageï¼Œä¾æ¬¡åˆ†å‰²å°±å¥½äº†ã€‚</p>
<p>æœ€åå°±æ˜¯é‡å‘½åã€ç§»åŠ¨ã€å‹ç¼©ï¼Œä¸å†™äº†ã€‚</p>
<h1 id="æ‰“åŒ…æˆ-exe-å¯æ‰§è¡Œæ–‡ä»¶"><a href="#æ‰“åŒ…æˆ-exe-å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="æ‰“åŒ…æˆ exe å¯æ‰§è¡Œæ–‡ä»¶"></a>æ‰“åŒ…æˆ exe å¯æ‰§è¡Œæ–‡ä»¶</h1><p>è€å©†ä½¿ç”¨çš„æ˜¯ Windownsï¼Œæ‰€ä»¥æœ€åè¦æ‰“åŒ…æˆ <code>.exe</code> å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœäº†ä¸‹ pyinstaller å¯ä»¥è§£å†³ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦åœ¨å¯¹åº”çš„å¹³å°æ‰èƒ½æ‰“å‡ºå¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯å°±æ˜¯è¯´æƒ³è¦æ‰“å‡º <code>.exe</code> å¿…é¡»åœ¨ Windows ä¸‹æ‰“åŒ…ï¼Œè¿™å°±æœ‰ç‚¹è›‹ç–¼äº†ã€‚ç„¶åå¼„äº†ä¸€ä¸‹ï¼Œå‘ç° Windows ç”¨æ¥åšå¼€å‘çœŸçš„æ˜¯éš¾ç”¨æ— æ¯”ã€‚<br>æœ€åä¹Ÿæ²¡æ‰“ <code>.exe</code>ï¼Œç›´æ¥åœ¨ Windows ä¸‹è£…äº†pythonï¼ŒåŒå‡» <code>.py</code> æ–‡ä»¶å¥½äº†ï¼Œæœ‰bugçš„è¯æ›¿æ¢ä¸€ä¸‹æ–‡ä»¶å¥½äº†ï¼Œä¸ç”¨é‡æ–°æ‰“åŒ…ã€‚</p>
<h1 id="ç¢°åˆ°çš„é—®é¢˜"><a href="#ç¢°åˆ°çš„é—®é¢˜" class="headerlink" title="ç¢°åˆ°çš„é—®é¢˜"></a>ç¢°åˆ°çš„é—®é¢˜</h1><p>é¡¹ç›®äº¤ä»˜è€å©†ä½¿ç”¨åï¼Œæå…¶çš„å¥½ç”¨ï¼Œå¤§å¹…æå‡äº†å·¥ä½œæ•ˆç‡ï¼Œå‡å°‘å‡ºé”™æ¦‚ç‡ï¼Œè€å©†ç”šè‡³å‘äº†ä¸ªæœ‹å‹åœˆå¤¸å¥–äº†ä¸€ç•ªï¼Œæ„Ÿè§‰ç¾æ»‹æ»‹ã€‚</p>
<p>ç¾äº†ä¸åˆ°ä¸¤å¤©å°±å‡º bug äº†ã€‚</p>
<p>bugæ˜¯è¿™æ ·çš„ï¼Œæ¯”å¦‚æœ‰ä¸ªç¼–å·<code>ç¼–å·ï¼šG201802020108</code> æ­£å¸¸è§£æå‡ºæ¥ <code>sample.number = G201802020108</code> æ‰å¯¹ï¼Œä½†æ˜¯ç»“æœå¯èƒ½æ˜¯è¿™æ ·çš„<code>G20180202</code>ï¼Œåé¢å°‘äº†å‡ ä½ã€‚æ‹¿åˆ°åŸå§‹çš„å¤§ pdf è·‘äº†ä¸€éå‘ç°ç¡®å®æ˜¯è¿™æ ·ï¼Œæ¯ä¸ª pdf åœ¨è§£ææ—¶æˆ‘éƒ½æŠŠæ–‡æœ¬ä¿¡æ¯å­˜äº†ä¸‹æ¥ä»¥ä¾¿æŸ¥é—®é¢˜ç”¨ï¼Œè¿™æ—¶æ´¾ä¸Šäº†ç”¨åœºï¼Œæ‰“å¼€çœ‹äº†ä¸‹æ–‡æœ¬ä¿¡æ¯è¢«è¿™æ ·å¤„ç†äº†ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ç¼–å·ï¼šG20180202</div><div class="line"><span class="number">0108</span></div></pre></td></tr></table></figure>
<p>æœ¬æ¥åœ¨ä¸€è¡Œæˆ–è€…è¯´åœ¨ä¸€ä¸ª <code>LTTextBox</code> ä¸­çš„å†…å®¹è¢«åˆ†å‰²æˆäº†ä¸¤ä¸ªï¼Œæ‰€ä»¥å‡ºç°äº†å†…å®¹å°‘çš„é—®é¢˜ã€‚</p>
<p>æ‰¾åˆ°äº†é—®é¢˜åŸå› å°±å¥½å¤„ç†äº†ã€‚<br>é¦–å…ˆæƒ³åˆ°äº†ä¸€ä¸ªæ–¹æ¡ˆï¼Œæ¯ä¸ª <code>LTxx</code> æ§ä»¶åœ¨å½“é¡µ pdf ä¸­çš„ä½ç½®ç”±åæ ‡è¡¨ç¤ºï¼Œå·¦ä¸Šè§’åæ ‡æ˜¯ <code>{x0:0,y0:0, x1:0,y1:0}</code>ï¼Œåªè¦æ¡†ä½äº†ç¼–å·ä¿¡æ¯æ‰€åœ¨çš„åæ ‡èŒƒå›´ï¼Œåªè¦åœ¨è¯¥èŒƒå›´å†…çš„ï¼Œæ‰€æœ‰æ–‡æœ¬ä¿¡æ¯ append ä¸€ä¸‹ç„¶åå†æ­£åˆ™åŒ¹é…å°±å¥½äº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">in_number_area</span><span class="params">(text_box)</span>:</span></div><div class="line">    <span class="comment"># x0,y0,x1,y1</span></div><div class="line">    scope = (<span class="number">370</span>, <span class="number">700</span>, <span class="number">560</span>, <span class="number">740</span>)</div><div class="line">    <span class="keyword">if</span> in_area(text_box.bbox, scope):</div><div class="line">        print(<span class="string">'æ ·æœ¬ç¼–å·åŒ¹é…ï¼åæ ‡ç‚¹ï¼š'</span>, text_box.bbox)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    </div><div class="line"></div><div class="line"><span class="comment"># åˆ¤æ–­TextBoxåæ ‡èŒƒå›´æ˜¯å¦åœ¨è§„å®šèŒƒå›´å†…</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">in_area</span><span class="params">(bbox, scope)</span>:</span></div><div class="line">    <span class="keyword">if</span> bbox[<span class="number">0</span>] &gt; scope[<span class="number">0</span>] <span class="keyword">and</span> bbox[<span class="number">1</span>] &gt; scope[<span class="number">1</span>] <span class="keyword">and</span> bbox[<span class="number">2</span>] &lt; scope[<span class="number">2</span>] <span class="keyword">and</span> bbox[<span class="number">3</span>] &lt; scope[<span class="number">3</span>]:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>ç»™å®šå›ºå®šåæ ‡èŒƒå›´ï¼Œæ‰¾åˆ°åœ¨è¯¥åæ ‡èŒƒå›´å†…çš„æ§ä»¶ï¼Œç„¶åå†å»åŒ¹é…ã€‚</p>
<p>è·‘äº†ä¸€ä¸‹ç¡®å®ç”Ÿæ•ˆäº†ï¼Œä½†æ˜¯é—®é¢˜ä¾ç„¶æ²¡æœ‰è§£å†³ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæŠ¥å‘Šç§ç±»ä¸ä¸€ï¼Œå¯¼è‡´æ ¼å¼å°±ä¸ä¸€æ ·ï¼Œåæ ‡èŒƒå›´ä¹Ÿä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åŠ¨æ€çš„æ‰¾åˆ°åæ ‡èŒƒå›´ã€‚è¯¥æ–¹æ¡ˆå¤±è´¥ã€‚</p>
<p>äºæ˜¯åˆæƒ³åˆ°äº†ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œç›´æ¥çœ‹ä»£ç å§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># è§£æç¼–å·</span></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> utils.number_legal_for_internal(sample.number):</div><div class="line">    num = utils.parse_sample_num(results)</div><div class="line">    <span class="keyword">if</span> num:</div><div class="line">        number_index = index</div><div class="line">        sample.number = num</div><div class="line">        <span class="keyword">continue</span></div><div class="line">    <span class="comment"># è§£å†³ç¼–å·è¢«åˆ†æˆä¸¤æ®µçš„é—®é¢˜</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> utils.number_legal_for_internal(sample.number) <span class="keyword">and</span> number_index <span class="keyword">and</span> (</div><div class="line">            index == number_index + <span class="number">1</span> <span class="keyword">or</span> index == number_index + <span class="number">2</span>):</div><div class="line">        print(<span class="string">'ä¿®æ­£åçš„ç¼–å·ï¼š'</span>)</div><div class="line">        num = utils.parse_sample_num(<span class="string">'æ ·æœ¬ç¼–å·ï¼š'</span> + sample.number + results)</div><div class="line">        sample.number = num</div><div class="line">        <span class="keyword">if</span> utils.number_legal_for_internal(num):</div><div class="line">            number_index = <span class="number">0</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>åŸºæœ¬è§£å†³ã€‚</p>
<p>å…¶å®ç¬¬äºŒä¸ªæ–¹æ¡ˆä¹Ÿä¸å¤ªå®Œç¾ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿç¼–å·è¿˜å¥½è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯å­—æ¯åŠ æ•°å­—ï¼Œå¦‚æœå‡ºç°è¿™ä¸ªbugä¸€èˆ¬éƒ½èƒ½æ¯”è¾ƒå¥½åˆ¤æ–­æ˜¯å¦åˆæ³•ï¼Œæ¯”å¦‚ç¼–å·é•¿åº¦ &gt;=11ï¼Œä½†æ˜¯ï¼Œå¦‚æœæ˜¯åå­—å‘¢ï¼Œå°±æ²¡æœ‰å¾ˆå¥½çš„åˆæ³•è§„åˆ™æ¥åˆ¤æ–­ï¼Œæ¯”å¦‚<code>åå­—ï¼šå¼ ä¸‰ä¸°</code>ï¼Œ<code>ä¸°</code>å­—è¢«åˆ†å‰²äº†ï¼Œè€Œåˆæ³•åˆ¤æ–­æ˜¯åå­—é•¿åº¦ &gt;=2ï¼Œé‚£æœ€åç»“æœå°±æ˜¯<code>å¼ ä¸‰</code>è€Œä¸æ˜¯<code>å¼ ä¸‰ä¸°</code>ã€‚</p>
<p>æ‰€ä»¥ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªä¼˜åŒ–æ–¹æ¡ˆï¼Œåœ¨æ–¹æ¡ˆä¸€å’Œæ–¹æ¡ˆäºŒçš„åŸºç¡€ä¸Šï¼Œç¬¬ä¸€æ­¥å…ˆåŒ¹é…å…³é”®å­—ï¼Œæ¯”å¦‚<code>å§“åï¼š</code>ï¼ŒåŒ¹é…åˆ°äº†ä»¥åå†æ¡†å®šåæ ‡èŒƒå›´ï¼Œä¸€èˆ¬åå­—éƒ½æ˜¯6å­—ä»¥å†…ï¼Œç¼–å·æ˜¯20ä½ä»¥å†…ï¼Œåˆ’å®šåæ ‡èŒƒå›´åå°†èŒƒå›´å†…çš„åŒ¹é…æ§ä»¶æ–‡æœ¬ä¿¡æ¯éƒ½æ‹¿å‡ºæ¥å†ä¸€èµ·è§£æã€‚åŸºæœ¬åšåˆ°äº†åŠ¨æ€åˆ¤æ–­åæ ‡èŒƒå›´ã€‚</p>
<p>å¤–éƒ¨æŠ¥å‘Šè·Ÿå†…éƒ¨æŠ¥å‘ŠåŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«æ˜¯é¦–å…ˆéœ€è¦è§£å‹ä¸€ä¸‹ï¼Œç„¶åè§£æã€å¤„ç†ï¼Œä¸å†™äº†ã€‚</p>
<h1 id="è¿˜æœ‰å“ªäº›å¯ä»¥åš"><a href="#è¿˜æœ‰å“ªäº›å¯ä»¥åš" class="headerlink" title="è¿˜æœ‰å“ªäº›å¯ä»¥åš"></a>è¿˜æœ‰å“ªäº›å¯ä»¥åš</h1><p>å‰é¢å†™äº†æ€ä¹ˆè§£æå¤„ç†pdfï¼Œå…¶å®è¿˜æœ‰ä¸€éƒ¨åˆ†å·¥ä½œä¹Ÿå¯ä»¥ç”¨è„šæœ¬æ¥å¤„ç†ï¼Œæ¯”å¦‚ï¼Œå¤§çš„pdf ä¸‹è½½å¯ä»¥é€šè¿‡è„šæœ¬å¤„ç†ï¼›å¤„ç†å¥½çš„ pdf æŠ¥å‘Šè¦é€šè¿‡é‚®ä»¶æ³•å‘é€ç»™å®¢æˆ·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬å¤„ç†ï¼›æœ‰æ—¶è¿˜éœ€è¦æŠŠè§£æå‡ºçš„ä¿¡æ¯å¡«åˆ°è¡¨æ ¼ä¸­ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨è„šæœ¬å¤„ç†çš„ã€‚</p>
<p>æ€»ç»“ä¸‹æ¥ä¸€å…±æœ‰è¿™å‡ ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>çˆ¬è™«ï¼Œä»ç³»ç»Ÿä¸­å¯¼å‡ºå¤§çš„ pdf æŠ¥å‘Š</li>
<li>pdf è§£æå’Œåˆ†å‰²</li>
<li>å½’ç±»ï¼Œå‹ç¼©</li>
<li>ç”Ÿæˆè¡¨æ ¼</li>
<li>å‘é€é‚®ä»¶</li>
</ul>
<p>ç›®å‰åªåšäº†2 å’Œ3 ï¼Œå…¶ä½™çš„æœ‰æ—¶é—´æ…¢æ…¢å†™ã€‚</p>
<h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« å‘¢ï¼Ÿ<br>å…¶å®ç”¨åˆ°çš„ä¸œè¥¿å¾ˆç®€å•ï¼Œçœ‹å‡ åˆ†é’Ÿ python å…¥é—¨ç„¶åå†æ‰¾ä¸¤ä¸ªå¼€æºåº“å°±æå®šäº†ï¼Œä¹Ÿæ²¡å¿…è¦è®°å½•ä»€ä¹ˆæŠ€æœ¯çŸ¥è¯†ç‚¹ã€‚<br>æˆ‘çœŸæ­£æƒ³è¯´çš„æ˜¯ä¸€äº›æ„Ÿæ‚Ÿï¼Œç¨‹åºå‘˜ç¢°åˆ°è¿™ç§é—®é¢˜ä¸€èˆ¬éƒ½ä¼šæƒ³åŠæ³•å†™ä¸€äº›è„šæœ¬å¤„ç†ï¼Œæ²¡ä»€ä¹ˆç¨€å¥‡çš„ã€‚ä½†æ˜¯å¯¹äºä¸ä¼šå†™ç¨‹åºçš„äººæ¥è¯´ï¼Œæœ‰è¿™ä¸ªç¨‹åºå’Œæ²¡æœ‰è¿™ä¸ªç¨‹åºç®€ç›´å°±æ˜¯ä¸ä¸€æ ·çš„å·¥ä½œï¼Œå°±æ‹¿è¿™ä»¶äº‹æ¥è¯´ï¼Œç”¨äº†è¿™ä¸ªç¨‹åºä¹‹åï¼Œæˆ‘è€å©†çš„å·¥ä½œæ•ˆç‡æ˜æ˜¾æå‡ï¼Œæ¯å¤©èƒ½èŠ‚çœå‡º1-2å°æ—¶æ—¶é—´åšåˆ«çš„äº‹æƒ…ï¼Œä»äº¤ä»˜é‚£å¤©èµ·ï¼ŒåŸºæœ¬æ²¡å¬è¿‡è€å©†å†æŠ±æ€¨å·¥ä½œäº†ã€‚ç®€ç›´å¼€å¿ƒã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯ä»¥å‰æ€»æ„Ÿè§‰ç¨‹åºå‘˜è¿™ä¸ªå·¥ä½œå¯¹ç”Ÿæ´»çš„å¸®åŠ©ç®€ç›´å°±æ˜¯æ²¡å•¥ç”¨ï¼Œæ¯”å¦‚ï¼Œä½ çœ‹è°è°ç°åœ¨æ˜¯åŒ»ç”Ÿï¼Œå»åŒ»é™¢éƒ½ä¸ç”¨æŒ‚å·ï¼Œç›´æ¥å°±èƒ½çœ‹ç—…ï¼›è°è°æ˜¯è€å¸ˆï¼Œå­©å­ä¸Šå­¦çš„äº‹æƒ…æ ¹æœ¬ä¸ç”¨æ„ç­‰ç­‰è¯¸å¦‚æ­¤ç±»ï¼ŒèŒä¸šé™¤äº†èƒ½å…»æ´»è‡ªå·±ä¹‹å¤–èƒ½å¤Ÿåå“ºç”Ÿæ´»ï¼Œåœ¨ç”Ÿæ´»ä¸­æä¾›ä¸€äº›ä»·å€¼ã€‚åè§‚ç¨‹åºå‘˜å¯¹ç”Ÿæ´»ä¸Šçš„å¸®åŠ©ç®€ç›´å°±æ˜¯0ï¼Œç”šè‡³å¯ä»¥è¯´æ˜¯è´Ÿæ•°ã€‚</p>
<p>ç°åœ¨æ˜¯é«˜é€Ÿå‘å±•çš„ä¿¡æ¯æ—¶ä»£ï¼Œå¹²ä»€ä¹ˆå·¥ä½œéƒ½ç¦»ä¸å¼€æ‰‹æœºã€ç”µè„‘ï¼Œç”šè‡³äººå·¥æ™ºèƒ½åœ¨æŸäº›æ–¹é¢éƒ½å¼€å§‹å–ä»£äººåŠ›å»åšä¸€äº›å·¥ä½œï¼Œæ‰€ä»¥æˆ‘è§‰å¾—è¶Šæ¥è¶Šèƒ½ä½“ç°å‡ºç¨‹åºå‘˜çš„ä»·å€¼ï¼Œå¯ä»¥æ§åˆ¶æœºå™¨å–ä»£äººå·¥å»åšä¸€äº›é‡å¤æ€§çš„ã€æœºæ¢°æ€§çš„å·¥ä½œï¼Œæ‰€ä»¥åœ¨æœ‰èƒ½åŠ›çš„å‰æä¸‹å­¦ä¹ ä¸€äº›å¼€å‘çŸ¥è¯†ä¼šå¤§æœ‰è£¨ç›Šã€‚å°±åƒæ¯ä¸ªäººéƒ½å­¦è‹±è¯­ä¸€æ ·ï¼Œåœ¨æœªæ¥ï¼Œç¼–ç¨‹ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€é—¨åŸºç¡€å­¦ç§‘ï¼Œæ¯ä¸ªäººéƒ½åº”è¯¥æŒæ¡ã€‚</p>
<p>å›åˆ°ç°åœ¨ï¼Œç®€å•çš„ç”¨ä¸€äº›ç®€å•çš„è„šæœ¬æå‡ç”Ÿæ´»å¹¸ç¦æ„Ÿï¼ŒæŠŠè¿™äº›çƒ¦äººçš„å·¥ä½œäº¤ç»™æœºå™¨å»åšï¼Œäººç±»æœ€æ“…é•¿çš„æ˜¯æµªè´¹æ—¶é—´ï¼Œæ©ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/machine_time1.jpg" alt=""></p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/machine_time2.jpg" alt=""></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2018/02/02/python-pdf/">http://w4lle.com/2018/02/02/python-pdf/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æœ€è¿‘è€å©†å·¥ä½œä¸­ç¢°åˆ°ä¸€äº›å›°éš¾ï¼Œæ€»æ˜¯è·Ÿæˆ‘æŠ±æ€¨å·¥ä½œå¥½çƒ¦ï¼Œä¸å¼€å¿ƒã€‚&lt;br&gt;ä¸»è¦æ˜¯æ˜¯å› ä¸ºè¦å¤„ç†ä¸€äº›æŠ¥å‘Šï¼Œè¿™äº› pdf æ ¼å¼çš„æ ·æœ¬æŠ¥å‘Šæ¯”è¾ƒå¤šï¼ŒåŸºæœ¬éƒ½æ˜¯äººå·¥æ“ä½œæ¯”è¾ƒå®¹æ˜“å‡ºé”™ï¼Œä¹Ÿæ¯”è¾ƒçç¢ï¼Œå¥½å¿ƒæƒ…éƒ½è¢«ç£¨æ²¡äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åæˆ‘è¯´è¦ä¹ˆå†™ä¸ªå°ç¨‹åºå§ï¼Œå¸®ä½ å¤„ç†è¿™äº›çç¢çš„å·¥ä½œï¼Œç„¶åå°±å¤§æ¦‚æ¢³ç†äº†ä¸€ä¸‹ä¸»è¦éœ€æ±‚ï¼š&lt;/p&gt;
    
    </summary>
    
    
      <category term="å·¥å…·" scheme="http://w4lle.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="å…¶ä»–" scheme="http://w4lle.com/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>åŒºå—é“¾ï¼ˆä¸€ï¼‰åŒºå—é“¾å’Œä»¥å¤ªåŠ</title>
    <link href="http://w4lle.com/2017/10/27/ethereum-0/"/>
    <id>http://w4lle.com/2017/10/27/ethereum-0/</id>
    <published>2017-10-27T11:37:06.000Z</published>
    <updated>2017-10-27T13:59:25.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŒºå—é“¾æ˜¯ä»€ä¹ˆ"><a href="#åŒºå—é“¾æ˜¯ä»€ä¹ˆ" class="headerlink" title="åŒºå—é“¾æ˜¯ä»€ä¹ˆ"></a>åŒºå—é“¾æ˜¯ä»€ä¹ˆ</h1><blockquote>
<p>åŒºå—é“¾ï¼ˆè‹±è¯­ï¼šblockchain æˆ– block chainï¼‰æ˜¯ç”¨åˆ†å¸ƒå¼æ•°æ®åº“è¯†åˆ«ã€ä¼ æ’­å’Œè®°è½½ä¿¡æ¯çš„æ™ºèƒ½åŒ–å¯¹ç­‰ç½‘ç»œ, ä¹Ÿç§°ä¸ºä»·å€¼äº’è”ç½‘ã€‚ä¸­æœ¬èªåœ¨2008å¹´ï¼Œäºã€Šæ¯”ç‰¹å¸ç™½çš®ä¹¦ã€‹ä¸­æå‡ºâ€œåŒºå—é“¾â€æ¦‚å¿µï¼Œå¹¶åœ¨2009å¹´åˆ›ç«‹äº†æ¯”ç‰¹å¸ç¤¾ä¼šç½‘ç»œï¼Œå¼€å‘å‡ºç¬¬ä¸€ä¸ªåŒºå—ï¼Œå³â€œåˆ›ä¸–åŒºå—â€ã€‚</p>
</blockquote>
<a id="more"></a>
<p>åŒºå—é“¾ï¼Œç®€å•çš„è®²å°±æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨çš„ä¸€ä¸ªå¤§è´¦æœ¬ï¼Œç”±ä¸€æ¡æ¡çš„äº¤æ˜“è®°å½•ï¼ˆblockï¼‰ç»„æˆï¼Œå¹¶ä¸”ä»»ä½•äººéƒ½å¯ä»¥æ‹¥æœ‰è¿™ä¸ªè´¦æœ¬å¹¶ä¸”å¯ä»¥å­˜å‚¨äº¤æ˜“è®°å½•ï¼Œå‡ ä¹åœ¨åŒä¸€æ—¶é—´è¿™æ¡è®°å½•å°±ä¼šè¢«åŒæ­¥åˆ°å…¨ä¸–ç•Œçš„å‰¯æœ¬ä¸Šï¼Œè¿™å°±ä½¿å¾—æ²¡æœ‰äººèƒ½å¤Ÿä¿®æ”¹æœ¬åœ°è´¦æœ¬ä¸­çš„è®°å½•ï¼Œä½¿å…¶æ‹¥æœ‰äº†å»ä¸­å¿ƒåŒ–çš„èƒ½åŠ›ã€‚å¯ä»¥ç†è§£ä¸ºè¿™å°±æ˜¯åŒºå—é“¾æŠ€æœ¯çš„åŸºæœ¬å†…å®¹ï¼Œæ¯”ç‰¹å¸å’Œä»¥å¤ªåŠå’Œå…¶ä»–ä»£å¸éƒ½æ˜¯ä»¥æ­¤ä¸ºåŸºç¡€ã€‚æœ€æœ‰åæ°”çš„å°±å±æ¯”ç‰¹å¸äº†ã€‚</p>
<p>è€ƒè™‘ç°å®ç”Ÿæ´»ï¼Œæ¯”å¦‚æƒ³å»æ‰¾ä¸€ä¸ªé™Œç”Ÿäººå€Ÿé’±ï¼Œé‚£ä¹ˆå°±å¿…é¡»æœ‰ä¸€ä¸ªåŒæ–¹éƒ½è®¤å¯çš„ç¬¬ä¸‰æ–¹å­˜åœ¨ï¼Œæ¯”å¦‚é“¶è¡Œã€‚ç”±äºåŒºå—é“¾çš„å­˜åœ¨ï¼Œè¿™ä¸ªç¬¬ä¸‰æ–¹å°±å¯ä»¥ä¸éœ€è¦äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘è¦å€Ÿç»™ A ä¸€å—é’±ï¼Œæˆ‘è¦åœ¨è´¦æœ¬ä¸Šå†™ä¸€æ¡ï¼Œæˆ‘è¦å€Ÿç»™ A ä¸€å—é’±ï¼Œé¦–å…ˆä¼šå»æ£€æŸ¥ä½ æœ‰æ²¡æœ‰ä¸€å—é’±ï¼Œå¦‚æœæœ‰çš„è¯å°±ä¼šè®°å½•ä¸‹æ¥ï¼Œå¹¶ä¸”åŒæ—¶åœ¨ä½ çš„è´¦æˆ·ä¸­æ‰£æ‰ä¸€å—é’±åŒæ—¶åœ¨ A çš„è´¦æˆ·ä¸­å¢åŠ ä¸€å—é’±ï¼ŒåŒæ—¶åŒæ­¥åˆ°æ‰€æœ‰æŒæœ‰è¯¥è´¦æœ¬çš„è´¦æˆ·ä¸Šã€‚</p>
<p>å› æ­¤ï¼ŒåŒºå—é“¾å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å»ä¸­å¿ƒåŒ–</li>
<li>åˆ†å¸ƒå¼</li>
<li>å¯†ç æ€§å®‰å…¨</li>
</ul>
<h1 id="ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ"><a href="#ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ"></a>ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ</h1><blockquote>
<p>ä»¥å¤ªåŠæ˜¯ä¸€ä¸ªå…¨æ–°å¼€æ”¾çš„åŒºå—é“¾å¹³å°ï¼Œå®ƒå…è®¸ä»»ä½•äººåœ¨å¹³å°ä¸­å»ºç«‹å’Œä½¿ç”¨é€šè¿‡åŒºå—é“¾æŠ€æœ¯è¿è¡Œçš„å»ä¸­å¿ƒåŒ–åº”ç”¨ã€‚</p>
</blockquote>
<p>ä»¥å¤ªåŠç›¸æ¯”äºåŒºå—é“¾æœ‰äº†æ›´è¿›ä¸€æ­¥çš„å‘å±•ï¼Œå®ƒå¯ä»¥åœ¨é“¾ä¸Šåˆ›å»ºä¸€äº›è‡ªåŠ¨è¿è¡Œçš„ç¨‹åºç§°ä¹‹ä¸ºæ™ºèƒ½åˆçº¦ï¼Œåªè¦è¿™ä¸ªæ™ºèƒ½åˆçº¦å‘å¸ƒåˆ°äº†é“¾ä¸Šï¼Œä»»ä½•äººéƒ½æ— æ³•ä¿®æ”¹å®ƒï¼Œå¹¶ä¸”å®ƒæ˜¯å¯¹ä»»ä½•äººé€æ˜çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥çœ‹åˆ°å…¶ä»£ç ã€‚ä»»ä½•äººéƒ½å¯ä»¥å‘å¸ƒæ™ºèƒ½åˆçº¦ï¼Œç¼–å†™æ™ºèƒ½åˆçº¦æ‰€ä½¿ç”¨çš„é«˜çº§è¯­è¨€ä¹Ÿæ˜¯å›¾çµå®Œå¤‡çš„ï¼ˆæ„å‘³ç€è¯­è¨€å¯ä»¥ä½¿ç”¨è®¡å›¾çµæœºå®Œæˆä»»ä½•å›¾çµæœºå¯ä»¥å®Œæˆçš„ä»»åŠ¡ï¼‰ï¼Œè¿™å°±ä½¿å¾—è¿™æ˜¯å¯ç¼–ç¨‹çš„ï¼Œä»»ä½•äººæ”¯ä»˜ä¸€ç¬”è´¹ç”¨ (Gas) éƒ½å¯ä»¥éƒ¨ç½²ç¼–å†™çš„æ™ºèƒ½åˆçº¦ä¾›å…¶ä»–äººä½¿ç”¨ã€‚</p>
<p>è€ƒè™‘ç°å®ç”Ÿæ´»ï¼Œæ¯”å¦‚è¯´ä½¿ç”¨åŸºäºä»¥å¤ªåŠçš„æ™ºèƒ½åˆçº¦å­˜é’±ï¼Œè¯¥åˆçº¦çº¦å®šæœˆåˆ©ç‡1%ï¼Œé‚£ä¹ˆå‡å¦‚æˆ‘å­˜äº†100å—é’±è¿›å»ï¼Œä¸€ä¸ªæœˆåæ¥å–ï¼Œé‚£ä¹ˆæˆ‘èƒ½å–åˆ°çš„é‡‘é¢å¿…ç„¶æ˜¯ 100 + 100 * 0.01ã€‚</p>
<p>æ‰€ä»¥ç›¸å¯¹äºåŒºå—é“¾ï¼Œä»¥å¤ªåŠå¤šäº†ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ™ºèƒ½åˆçº¦</li>
<li>å›¾çµå®Œå¤‡</li>
</ul>
<h1 id="æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ"><a href="#æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ" class="headerlink" title="æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ"></a>æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</h1><p>ä»¥å¤ªåŠçš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªåŸºäºäº¤æ˜“çš„çŠ¶æ€æœº(transaction-based state machine)ã€‚ä»¥å¤ªåŠçš„çŠ¶æ€åŒ…å«å¾ˆå¤šäº¤æ˜“ï¼Œè¿™äº›äº¤æ˜“è¢«æ‰“åŒ…åˆ°åŒºå—ä¸­ï¼ˆblockï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª block åŒ…å«äº†ä¸€ç³»åˆ—çš„äº¤æ˜“ï¼Œæ¯ä¸ªåŒºå—ä¸å®ƒçš„å‰ä¸€ä¸ªåŒºå—é“¾æ¥èµ·æ¥ç»„æˆåŒºå—é“¾ã€‚<br><img src="http://7xs23g.com1.z0.glb.clouddn.com/blockchain.png" alt="blockchain"><br>ä¸ºäº†è®©äº¤æ˜“è¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„ï¼Œéƒ½å¿…é¡»è¦ç»å†ä¸€ä¸ªéªŒè¯çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯æŒ–çŸ¿ã€‚æŒ–çŸ¿å®é™…ä¸Šå°±æ˜¯çŸ¿å·¥ç”¨ä»–ä»¬çš„è®¡ç®—èµ„æºæ¥åˆ›å»ºä¸€ä¸ªåŒ…å«æœ‰æ•ˆäº¤æ˜“çš„åŒºå—å‡ºæ¥ã€‚ç„¶è€Œå½“ä½ åœ¨è®¡ç®—åŒºå—çš„æ—¶å€™åˆ«çš„çŸ¿å·¥åŒæ ·ä¹Ÿåœ¨è®¡ç®—ï¼Œå¦‚æœå¤§å®¶åŒæ—¶æäº¤çš„è¯ï¼Œæ€ä¹ˆè¯æ˜è°çš„åŒºå—æ˜¯æœ‰æ•ˆçš„ï¼Ÿæ‰€ä»¥åœ¨æäº¤åŒºå—åˆ°åŒºå—é“¾ä¸Šæ—¶ï¼Œéƒ½éœ€è¦æä¾›ä¸€ä¸ªæ•°å­¦æœºåˆ¶çš„è¯æ˜ï¼Œç§°ä¹‹ä¸ºå·¥ä½œé‡è¯æ˜ï¼ˆproof of workï¼‰ï¼Œæ‰€ä»¥ä¸€ä¸ªçŸ¿å·¥å¿…é¡»è¦æ¯”å…¶ä»–çŸ¿å·¥æ›´å¿«çš„æä¾›å‡ºè¿™ä¸ªè¯æ˜æ¥æŠ¢å åŒºå—çš„æœ‰æ•ˆæ€§å°†ä¹‹åˆå¹¶åˆ°åŒºå—ä¸¤ä¸Šï¼Œä¸æ­¤åŒæ—¶ï¼Œåˆ«çš„çŸ¿å·¥ä¼šåŠæ—¶çš„å°†åŒºå—é“¾çš„çŠ¶æ€æ›´æ–°è‡³æœ€æ–°ã€‚è¯å®äº†ä¸€ä¸ªæ–°åŒºå—çš„çŸ¿å·¥éƒ½ä¼šè¢«å¥–åŠ±ä¸€å®šä»·å€¼çš„å¥–èµã€‚å¥–èµå°±æ˜¯ä»¥å¤ªåŠä½¿çš„ç”¨ä¸€ç§å†…åœ¨æ•°å­—ä»£å¸â€”ä»¥å¤ªå¸(Ether)ã€‚</p>
<p>å¦å¤–ï¼Œä»¥å¤ªåŠå’ŒåŒºå—é“¾çš„æ¶æ„ä¸åŒåœ¨äºï¼Œä»¥å¤ªåŠåŒºå—ä¸ä»…åŒ…å«äº¤æ˜“è®°å½•å’Œæœ€è¿‘çš„çŠ¶æ€ï¼Œè¿˜åŒ…å«åŒºå—åºå·å’Œéš¾åº¦å€¼ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/ethereum-blockchain.png" alt=""></p>
<h1 id="æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›"><a href="#æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›" class="headerlink" title="æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›"></a>æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›</h1><p>æˆ‘ä»¬å…¬å¸ 1024 ç¨‹åºå‘˜èŠ‚å½“å¤©æäº†ä¸ª HackathonDay æ´»åŠ¨ï¼Œæˆ‘ä»¬æŠ¥åå‚åŠ äº†ä¸‹ï¼Œå¹¶ä¸”é€‰é¢˜å°±æ˜¯åŸºäºåŒºå—é“¾çš„å®é™…åº”ç”¨ï¼Œè™½ç„¶åŸºæœ¬åªæœ‰ä¸€å¤©çš„æ—¶é—´æ¥å­¦ä¹ åŒºå—é“¾çš„ç›¸å…³çŸ¥è¯†ï¼Œæˆ‘ä»¬è¿˜æ˜¯åšå‡ºäº†ä¸€äº› Demoï¼ŒåŸºæœ¬ç®—æ˜¯å…¥é—¨ã€‚<br>æ‰€ä»¥æ¥ä¸‹æ¥çš„æ–‡ç« ä¼šå†™åˆ°åŸºäºä»¥å¤ªåŠæ­å»ºä¸€ä¸ªç§æœ‰é“¾ã€åˆ›å»ºè´¦æˆ·ã€è¿›è¡ŒæŒ–çŸ¿ã€è¿›è¡Œè½¬è´¦äº¤æ˜“ã€åŸºäº Solidity è¯­è¨€ç¼–å†™æ™ºèƒ½åˆçº¦ã€éƒ¨ç½²åˆ°åŒºå—é“¾ä¸Šã€ç¼–å†™ DApp æ¥ä½¿ç”¨æ™ºèƒ½åˆçº¦ç­‰ç­‰ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://github.com/ethereum/wiki/wiki/%5B%E4%B8%AD%E6%96%87%5D-%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%99%BD%E7%9A%AE%E4%B9%A6" target="_blank" rel="external">ä»¥å¤ªåŠç™½çš®ä¹¦</a></li>
<li><a href="http://ethfans.org/posts/how-does-ethereum-work-anyway" target="_blank" rel="external">ä»¥å¤ªåŠçš„å·¥ä½œåŸç†</a></li>
<li><a href="http://wangxiaoming.com/blog/2016/05/05/blockchain-tech-what-is-blockchain/" target="_blank" rel="external">åŒºå—é“¾æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/10/27/ethereum-0/">http://w4lle.com/2017/10/27/ethereum-0/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;åŒºå—é“¾æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#åŒºå—é“¾æ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;åŒºå—é“¾æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;/a&gt;åŒºå—é“¾æ˜¯ä»€ä¹ˆ&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;åŒºå—é“¾ï¼ˆè‹±è¯­ï¼šblockchain æˆ– block chainï¼‰æ˜¯ç”¨åˆ†å¸ƒå¼æ•°æ®åº“è¯†åˆ«ã€ä¼ æ’­å’Œè®°è½½ä¿¡æ¯çš„æ™ºèƒ½åŒ–å¯¹ç­‰ç½‘ç»œ, ä¹Ÿç§°ä¸ºä»·å€¼äº’è”ç½‘ã€‚ä¸­æœ¬èªåœ¨2008å¹´ï¼Œäºã€Šæ¯”ç‰¹å¸ç™½çš®ä¹¦ã€‹ä¸­æå‡ºâ€œåŒºå—é“¾â€æ¦‚å¿µï¼Œå¹¶åœ¨2009å¹´åˆ›ç«‹äº†æ¯”ç‰¹å¸ç¤¾ä¼šç½‘ç»œï¼Œå¼€å‘å‡ºç¬¬ä¸€ä¸ªåŒºå—ï¼Œå³â€œåˆ›ä¸–åŒºå—â€ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="åŒºå—é“¾" scheme="http://w4lle.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>çƒ­ä¿®å¤æ€»ç»“</title>
    <link href="http://w4lle.com/2017/05/04/hotpatch-summary/"/>
    <id>http://w4lle.com/2017/05/04/hotpatch-summary/</id>
    <published>2017-05-04T10:45:31.000Z</published>
    <updated>2017-05-15T02:51:33.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="çƒ­ä¿®å¤æ€»ç»“"><a href="#çƒ­ä¿®å¤æ€»ç»“" class="headerlink" title="çƒ­ä¿®å¤æ€»ç»“"></a>çƒ­ä¿®å¤æ€»ç»“</h1><table>
<thead>
<tr>
<th style="text-align:center">å¹³å°</th>
<th style="text-align:center">é˜¿é‡Œ AndFix</th>
<th style="text-align:center">é˜¿é‡Œ HotFix1.x</th>
<th style="text-align:center">Nuwa</th>
<th style="text-align:center">å¾®ä¿¡Tinker</th>
<th style="text-align:center">ç¾å›¢Robust</th>
<th style="text-align:center">é˜¿é‡Œ HotFix2.x</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å³æ—¶ç”Ÿæ•ˆ</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">çœ‹æƒ…å†µ</td>
</tr>
<tr>
<td style="text-align:center">æ€§èƒ½æŸè€—</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå¤§</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
</tr>
<tr>
<td style="text-align:center">è¡¥ä¸åŒ…å¤§å°</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">è¾ƒå¤§</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
</tr>
<tr>
<td style="text-align:center">å Romä½“ç§¯</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">è¾ƒå¤§</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">çœ‹æƒ…å†µ</td>
</tr>
<tr>
<td style="text-align:center">æ¥å…¥å¤æ‚åº¦</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">å¤æ‚</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">ç®€å•</td>
</tr>
<tr>
<td style="text-align:center">å®‰å…¨æ ¡éªŒ</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">ç±»æ›¿æ¢</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">èµ„æºæ›¿æ¢</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">å³å°†æ”¯æŒ</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">soæ›¿æ¢</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">å³å°†æ”¯æŒ</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">å…¨å¹³å°æ”¯æŒ</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">å¼€å‘é€æ˜</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">gradleæ”¯æŒ</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">æ¥å£æ–‡æ¡£</td>
<td style="text-align:center">è¾ƒå°‘</td>
<td style="text-align:center">ä¸°å¯Œ</td>
<td style="text-align:center">è¾ƒå°‘</td>
<td style="text-align:center">ä¸°å¯Œ</td>
<td style="text-align:center">ä¸°å¯Œ</td>
<td style="text-align:center">ä¸°å¯Œ</td>
</tr>
<tr>
<td style="text-align:center">æˆåŠŸç‡</td>
<td style="text-align:center">è¾ƒä½</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">è¾ƒé«˜</td>
<td style="text-align:center">æœ€é«˜</td>
<td style="text-align:center">è¾ƒé«˜</td>
</tr>
<tr>
<td style="text-align:center">åå°ç®¡ç†</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">åŠ å›ºå…¼å®¹</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">éƒ¨åˆ†å…¼å®¹</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">ä¸ç¡®å®š</td>
</tr>
</tbody>
</table>
<p>ä¸Šè¡¨åŸºæœ¬æ¶µç›–äº†å…·æœ‰ä»£è¡¨æ€§çš„å„ç§çƒ­ä¿®å¤æ–¹æ¡ˆï¼Œæ¶‰åŠåˆ°çš„å„ç§å…³é”®æŒ‡æ ‡çš„æ¨ªå‘å¯¹æ¯”ã€‚</p>
<p>Slider ä¸­å¤§æ¦‚æ€»ç»“äº†å„ç§æ–¹æ¡ˆçš„å®ç°æ–¹å¼ï¼Œä»¥åŠå¸¸è§çš„é—®é¢˜ã€‚</p>
<p>Slider åœ°å€ï¼š <a href="http://w4lle.github.io/sliders/hot-fix/index.html" target="_blank" rel="external">http://w4lle.github.io/sliders/hot-fix/index.html</a></p>
<p>è¯¦ç»†çš„å„ç§æ–¹æ¡ˆåˆ†æï¼š</p>
<ul>
<li><a href="http://w4lle.github.io/2016/03/03/Android%E7%83%AD%E8%A1%A5%E4%B8%81%E4%B9%8BAndFix%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹AndFixåŸç†è§£æ</a></li>
<li><a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a></li>
<li><a href="http://w4lle.github.io/2016/12/16/tinker/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æ</a></li>
<li><a href="http://w4lle.github.io/2017/03/31/robust-0/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
</ul>
<p>æ°´å¹³æœ‰é™ï¼Œéš¾å…æœ‰å†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿äº¤æµã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/05/04/hotpatch-summary/">http://w4lle.com/2017/05/04/hotpatch-summary/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;çƒ­ä¿®å¤æ€»ç»“&quot;&gt;&lt;a href=&quot;#çƒ­ä¿®å¤æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;çƒ­ä¿®å¤æ€»ç»“&quot;&gt;&lt;/a&gt;çƒ­ä¿®å¤æ€»ç»“&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;å¹³å°&lt;/th&gt;
&lt;t
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</title>
    <link href="http://w4lle.com/2017/03/31/robust-0/"/>
    <id>http://w4lle.com/2017/03/31/robust-0/</id>
    <published>2017-03-31T07:58:12.000Z</published>
    <updated>2018-05-29T08:40:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ—©åœ¨16å¹´9æœˆä»½ï¼Œç¾å›¢æŠ€æœ¯å›¢é˜Ÿå°±å†™è¿‡ä¸€ç¯‡æ–‡ç« æè¿° Android çƒ­è¡¥ä¸æ¡†æ¶Robustçš„ç®€å•å®ç°åŸç†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¼€æºï¼›ç„¶ååœ¨17å¹´3æœˆä»½ï¼Œç¾å›¢å›¢é˜Ÿå®£å¸ƒæ­£å¼å¼€æº Robustå¹¶ä¸”é…å¥—äº†è‡ªåŠ¨æ‰“è¡¥ä¸åŒ…å·¥å…·ã€‚æœ¬ç³»åˆ—æ–‡ç« ä¸»è¦è§£æRobustå®ç°åŸç†ï¼Œåˆ†ä¸ºå‡ ä¸ªæ–¹é¢</p>
<ul>
<li>è¡¥ä¸åŠ è½½è¿‡ç¨‹</li>
<li>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹</li>
<li>è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹</li>
</ul>
<p>æœ¬æ–‡ä¸ºç¬¬ä¸€ç¯‡ï¼Œä¸»è¦è®²è§£è¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æç‰ˆæœ¬ <code>0.3.2</code>ã€‚</p>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« :</p>
<ul>
<li><a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
<li><a href="http://w4lle.com/2018/05/28/robust-1/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</a></li>
<li><a href="http://w4lle.com/2018/05/29/robust-2/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</a></li>
</ul>
<h1 id="ä»-InstantRun-è¯´èµ·"><a href="#ä»-InstantRun-è¯´èµ·" class="headerlink" title="ä» InstantRun è¯´èµ·"></a>ä» InstantRun è¯´èµ·</h1><p>ä¸å¾—ä¸è¯´ InstantRun çœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚ç›®å‰ä¸»æµçš„çƒ­ä¿®å¤æ¡†æ¶éƒ½æœ‰æˆ–å¤šæˆ–å°‘çš„å‚è€ƒ InstantRun çš„æŸäº›æŠ€æœ¯ç‚¹ï¼Œæ¯”å¦‚ <a href="https://github.com/Tencent/tinker" target="_blank" rel="external">Tinker</a> çš„å®˜æ–¹æ–‡ç« ä¸­æ˜ç¡®è€ƒè™‘è¿‡ InstantRun ä¸­çš„ Application æ›¿æ¢ï¼Œè™½ç„¶æœ€åæ²¡æœ‰é‡‡ç”¨ï¼Œä½†æ˜¯èº«ä¸ºå…¶å…„å¼Ÿåº“çš„ <a href="http://tinkerpatch.com/Docs/intro" target="_blank" rel="external">TinkerPatch</a> ä¸­ä¸€é”®æ¥å…¥æ–¹æ¡ˆå°±é‡‡ç”¨çš„è¯¥æŠ€æœ¯ç‚¹ã€‚å…³äºè¯¥æŠ€æœ¯ç‚¹ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç«  <a href="http://w4lle.github.io/2017/01/05/one-key-for-tinker/" target="_blank" rel="external">ä¸€é”®æ¥å…¥Tinker</a> ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒInstantRun å¯¹åº”ä¸‰ç§æ›´æ–°æœºåˆ¶ï¼š</p>
<ul>
<li>å†·æ’æ‹”ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé‡å¯æ›´æ–°æœºåˆ¶</li>
<li>æ¸©æ’æ‹”ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé‡å¯Activityæ›´æ–°æœºåˆ¶</li>
<li>çƒ­æ’æ‹”ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºçƒ­æ›´æ–°æœºåˆ¶</li>
</ul>
<p>å¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰ InstantRunï¼Œè¯·å‚è€ƒæˆ‘çš„è¿™ç¯‡æ–‡ç« <a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a></p>
<p>è€Œè¿™ç¯‡æ–‡ç« çš„ä¸»è§’ Robust ï¼Œå…¶çƒ­ä¿®å¤çš„å…³é”®æŠ€æœ¯ç‚¹å°±æ˜¯é‡‡ç”¨äº† InstantRun ä¸­çš„çƒ­æ›´æ–°æœºåˆ¶ï¼Œå¯¹åº”äºå¤š ClassLoader çš„åŠ¨æ€åŠ è½½æ–¹æ¡ˆï¼Œå³ä¸€ä¸ª dex æ–‡ä»¶å¯¹åº”ä¸€ä¸ªæ–°å»º ClassLoader ã€‚</p>
<h1 id="Robust-åŸç†è§£æ"><a href="#Robust-åŸç†è§£æ" class="headerlink" title="Robust åŸç†è§£æ"></a>Robust åŸç†è§£æ</h1><p>Robust çš„åŸç†å¯ä»¥ç®€å•æè¿°ä¸ºï¼š</p>
<ol>
<li>æ‰“åŸºç¡€åŒ…æ—¶æ’æ¡©ï¼Œåœ¨æ¯ä¸ªæ–¹æ³•å‰æ’å…¥ä¸€æ®µç±»å‹ä¸º <code>ChangeQuickRedirect</code> é™æ€å˜é‡çš„é€»è¾‘</li>
<li>åŠ è½½è¡¥ä¸æ—¶ï¼Œä»è¡¥ä¸åŒ…ä¸­è¯»å–è¦æ›¿æ¢çš„ç±»åŠå…·ä½“æ›¿æ¢çš„æ–¹æ³•å®ç°ï¼Œæ–°å»º ClassLoader åŠ è½½è¡¥ä¸dexã€‚</li>
</ol>
<p>æˆ‘ä»¬æ¥åˆ†åˆ«åˆ†æã€‚</p>
<h2 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h2><p>æ‰“åŸºç¡€åŒ…æ—¶ï¼ŒRobust ä¸ºæ¯ä¸ªç±»æ–°å¢äº†ä¸€ä¸ªç±»å‹ä¸º <code>ChangeQuickRedirect</code> çš„é™æ€å˜é‡ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæ–¹æ³•å‰ï¼Œå¢åŠ åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦ä¸ºç©ºçš„é€»è¾‘ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œèµ°æ‰“åŸºç¡€åŒ…æ—¶æ’æ¡©çš„é€»è¾‘ï¼Œå¦åˆ™èµ°æ­£å¸¸é€»è¾‘ã€‚æˆ‘ä»¬åç¼–è¯‘å‡ºåŸºç¡€åŒ…ä¸­çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//SecondActivity</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ChangeQuickRedirect u;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (PatchProxy.isSupport(<span class="keyword">new</span> Object[]&#123;bundle&#125;, <span class="keyword">this</span>, u, <span class="keyword">false</span>, <span class="number">78</span>)) &#123;</div><div class="line">                PatchProxy.accessDispatchVoid(<span class="keyword">new</span> Object[]&#123;bundle&#125;, <span class="keyword">this</span>, u, <span class="keyword">false</span>, <span class="number">78</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯¹åº”äºè¡¥ä¸æ–‡ä»¶ï¼Œéœ€è¦æœ‰ä¸‰ä¸ªæ–‡ä»¶</p>
<ul>
<li><code>PatchesInfoImpl</code> ç”¨äºè®°å½•ä¿®æ”¹çš„ç±»ï¼ŒåŠå…¶å¯¹åº”çš„ <code>ChangeQuickRedirect</code> æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬åç¼–è¯‘è¡¥ä¸åŒ…å¾—å‡ºä»¥ä¸‹ç»“æœï¼Œå…¶ä¸­çš„ç±»åæ˜¯æ··æ·†åçš„ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchesInfoImpl</span> <span class="keyword">implements</span> <span class="title">PatchesInfo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">getPatchedClassesInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        List arrayList = <span class="keyword">new</span> ArrayList();</div><div class="line">        arrayList.add(<span class="keyword">new</span> PatchedClassInfo(<span class="string">"com.meituan.sample.robusttest.l"</span>, <span class="string">"com.meituan.robust.patch.SampleClassPatchControl"</span>));</div><div class="line">        arrayList.add(<span class="keyword">new</span> PatchedClassInfo(<span class="string">"com.meituan.sample.robusttest.p"</span>, <span class="string">"com.meituan.robust.patch.SuperPatchControl"</span>));</div><div class="line">        arrayList.add(<span class="keyword">new</span> PatchedClassInfo(<span class="string">"com.meituan.sample.SecondActivity"</span>, <span class="string">"com.meituan.robust.patch.SecondActivityPatchControl"</span>));</div><div class="line">        EnhancedRobustUtils.isThrowable = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> arrayList;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>xxxPatchControl</code> æ˜¯ <code>ChangeQuickRedirect</code> æ¥å£çš„å…·ä½“å®ç°ï¼Œæ˜¯ä¸€ä¸ªä»£ç†ï¼Œå…·ä½“çš„æ›¿æ¢æ–¹æ³•æ˜¯åœ¨ <code>xxxPatch</code> ç±»ä¸­</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivityPatchControl</span> <span class="keyword">implements</span> <span class="title">ChangeQuickRedirect</span> </span>&#123;</div><div class="line">...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSupport</span><span class="params">(String methodName, Object[] paramArrayOfObject)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"78:79:90:"</span>.contains(methodName.split(<span class="string">":"</span>)[<span class="number">3</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">accessDispatch</span><span class="params">(String methodName, Object[] paramArrayOfObject)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            SecondActivityPatch secondActivityPatch;</div><div class="line">            ...</div><div class="line">            Object obj = methodName.split(<span class="string">":"</span>)[<span class="number">3</span>];</div><div class="line">            <span class="keyword">if</span> (<span class="string">"78"</span>.equals(obj)) &#123;</div><div class="line">                secondActivityPatch.onCreate((Bundle) paramArrayOfObject[<span class="number">0</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"79"</span>.equals(obj)) &#123;</div><div class="line">                <span class="keyword">return</span> secondActivityPatch.getTextInfo((String) paramArrayOfObject[<span class="number">0</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"90"</span>.equals(obj)) &#123;</div><div class="line">                secondActivityPatch.RobustPubliclambda$onCreate$<span class="number">0</span>((View) paramArrayOfObject[<span class="number">0</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">            th.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆè°ƒç”¨ <code>accessDispatch</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®ä¼ é€’è¿‡æ¥çš„æ–¹æ³•ç­¾åï¼Œè°ƒç”¨<code>xxxPatch</code>çš„ä¿®æ”¹è¿‡çš„æ–¹æ³•ã€‚</p>
<ul>
<li><code>xxxPatch</code> å…·ä½“çš„æ›¿æ¢å®ç°ç±»ï¼Œä»£ç å°±ä¸è´´äº†ã€‚</li>
</ul>
<p>å…¶è¿‡ç¨‹å¯ä»¥ç®€å•æè¿°ä¸ºï¼Œä¸‹å‘è¡¥ä¸åŒ…åï¼Œæ–°å»º DexClassLoader åŠ è½½è¡¥ä¸ dex æ–‡ä»¶ï¼Œåå°„å¾—åˆ° <code>PatchesInfoImpl</code> classï¼Œå¹¶åˆ›å»ºå…¶å¯¹è±¡ï¼Œè°ƒç”¨ <code>getPatchedClassesInfo()</code> æ–¹æ³•å¾—åˆ°å“ªäº›ä¿®æ”¹çš„ç±»ï¼ˆæ¯”å¦‚ SecondActivityï¼‰ï¼Œç„¶åå†é€šè¿‡åå°„å¾ªç¯æ‹¿åˆ°æ¯ä¸ªä¿®æ”¹ç±»åœ¨å½“å‰ç¯å¢ƒä¸­çš„çš„classï¼Œå°†å…¶ä¸­ç±»å‹ä¸º <code>ChangeQuickRedirect</code> çš„é™æ€å˜é‡åå°„ä¿®æ”¹ä¸º <code>xxxPatchControl.java</code> è¿™ä¸ªclass new å‡ºæ¥çš„å¯¹è±¡ã€‚</p>
<p>ç”¨å®˜æ–¹çš„ä¸€ç§å›¾å¾ˆå¥½çš„è¡¨è¾¾äº†æ›¿æ¢åŸç†ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/patching.png" alt="Robust"></p>
<h2 id="è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ"><a href="#è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ" class="headerlink" title="è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ"></a>è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ</h2><p>demoä¸­çš„è¡¥ä¸åŠ è½½å°±ä¸€å¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> PatchExecutor(getApplicationContext(), <span class="keyword">new</span> PatchManipulateImp(),  <span class="keyword">new</span> Callback()).start();</div></pre></td></tr></table></figure>
<p><code>PatchExecutor</code> æ˜¯ä¸ª Thread</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">public class PatchExecutor extends Thread &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        ...</div><div class="line">        applyPatchList(patches);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * åº”ç”¨è¡¥ä¸åˆ—è¡¨</div><div class="line">     */</div><div class="line">    protected void applyPatchList(List&lt;Patch&gt; patches) &#123;</div><div class="line">        ...</div><div class="line">        for (Patch p : patches) &#123;</div><div class="line">            ...</div><div class="line">            currentPatchResult = patch(context, p);</div><div class="line">            ...</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    protected boolean patch(Context context, Patch patch) &#123;</div><div class="line">        ...</div><div class="line">        DexClassLoader classLoader = new DexClassLoader(patch.getTempPath(), context.getCacheDir().getAbsolutePath(),</div><div class="line">                null, PatchExecutor.class.getClassLoader());</div><div class="line">        patch.delete(patch.getTempPath());</div><div class="line">        ...</div><div class="line">        try &#123;</div><div class="line">            patchsInfoClass = classLoader.loadClass(patch.getPatchesInfoImplClassFullName());</div><div class="line">            patchesInfo = (PatchesInfo) patchsInfoClass.newInstance();</div><div class="line">            &#125; catch (Throwable t) &#123;</div><div class="line">             ...</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        for (PatchedClassInfo patchedClassInfo : patchedClasses) &#123;</div><div class="line">            ...</div><div class="line">            try &#123;</div><div class="line">                oldClass = classLoader.loadClass(patchedClassName.trim());</div><div class="line">                Field[] fields = oldClass.getDeclaredFields();</div><div class="line">                for (Field field : fields) &#123;</div><div class="line">                    if (TextUtils.equals(field.getType().getCanonicalName(), ChangeQuickRedirect.class.getCanonicalName()) &amp;&amp; TextUtils.equals(field.getDeclaringClass().getCanonicalName(), oldClass.getCanonicalName())) &#123;</div><div class="line">                        changeQuickRedirectField = field;</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                ...</div><div class="line">                try &#123;</div><div class="line">                    patchClass = classLoader.loadClass(patchClassName);</div><div class="line">                    Object patchObject = patchClass.newInstance();</div><div class="line">                    changeQuickRedirectField.setAccessible(true);</div><div class="line">                    changeQuickRedirectField.set(null, patchObject);</div><div class="line">                    &#125; catch (Throwable t) &#123;</div><div class="line">                    ...</div><div class="line">                &#125;</div><div class="line">            &#125; catch (Throwable t) &#123;</div><div class="line">                 ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œé€šè¿‡æŒ‡å®šçš„è·¯å¾„å»è¯»patchæ–‡ä»¶çš„jaråŒ…ï¼Œpatchæ–‡ä»¶å¯ä»¥ä¸ºå¤šä¸ªï¼Œæ¯ä¸ªpatchæ–‡ä»¶å¯¹åº”ä¸€ä¸ª DexClassLoader å»åŠ è½½ï¼Œæ¯ä¸ªpatchæ–‡ä»¶ä¸­å­˜åœ¨PatchInfoImpï¼Œé€šè¿‡éå†å…¶ä¸­çš„ç±»ä¿¡æ¯è¿›è€Œåå°„ä¿®æ”¹å…¶ä¸­ <code>ChangeQuickRedirect</code> å¯¹è±¡çš„å€¼ã€‚</p>
<h2 id="åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ"><a href="#åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ" class="headerlink" title="åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ"></a>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ</h2><p>ç±»ä¼¼ InstantRun ï¼Œ Robust ä¹Ÿæ˜¯ä½¿ç”¨ Transform API ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶ï¼Œè¯¥ API å…è®¸ç¬¬ä¸‰æ–¹æ’ä»¶åœ¨  .class æ–‡ä»¶æ‰“åŒ…ä¸º dex æ–‡ä»¶ä¹‹å‰æ“ä½œç¼–è¯‘å¥½çš„ .class å­—èŠ‚ç æ–‡ä»¶ã€‚</p>
<p>Robust ä¸­çš„ <code>Gradle-Plugin</code> å°±æ˜¯æ“ä½œå­—èŠ‚ç çš„åä¸º <code>robust</code> çš„ gradle æ’ä»¶é¡¹ç›®ã€‚æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸‹å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RobustTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project target)</span> </span>&#123;</div><div class="line">            <span class="comment">//è§£æé¡¹ç›®ä¸‹robust.xmlé…ç½®æ–‡ä»¶</span></div><div class="line">            robust = <span class="keyword">new</span> XmlSlurper().parse(<span class="keyword">new</span> File(<span class="string">"$&#123;project.projectDir&#125;/$&#123;Constants.ROBUST_XML&#125;"</span>))</div><div class="line">            ...</div><div class="line">            project.android.registerTransform(<span class="keyword">this</span>)</div><div class="line">            project.afterEvaluate(<span class="keyword">new</span> RobustApkHashAction())</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transform</span><span class="params">(Context context, Collection&lt;TransformInput&gt; inputs, Collection&lt;TransformInput&gt; referencedInputs, TransformOutputProvider outputProvider, <span class="keyword">boolean</span> isIncremental)</span> <span class="keyword">throws</span> IOException, TransformException, InterruptedException </span>&#123;</div><div class="line">    ...</div><div class="line">    ClassPool classPool = <span class="keyword">new</span> ClassPool()</div><div class="line">    project.android.bootClasspath.each &#123;</div><div class="line">        logger.debug <span class="string">"android.bootClasspath   "</span> + (String) it.absolutePath</div><div class="line">        classPool.appendClassPath((String) it.absolutePath)</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    def box = ConvertUtils.toCtClasses(inputs, classPool)</div><div class="line">    insertRobustCode(box, jarFile)</div><div class="line">    writeMap2File(methodMap, Constants.METHOD_MAP_OUT_PATH)</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè¯»å– robust.xml é…ç½®æ–‡ä»¶å¹¶åˆå§‹åŒ–ï¼Œå¯é…ç½®é€‰é¡¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä¸€äº›å¼€å…³é€‰é¡¹</li>
<li>éœ€è¦çƒ­è¡¥ä¸çš„åŒ…åæˆ–è€…ç±»åï¼Œè¿™äº›åŒ…åä¸‹çš„æ‰€æœ‰ç±»éƒ½è¢«ä¼šæ’å…¥ä»£ç </li>
<li>ä¸éœ€è¦çƒ­è¡¥çš„åŒ…åæˆ–è€…ç±»åï¼Œå¯ä»¥åœ¨éœ€è¦çƒ­è¡¥çš„åŒ…ä¸­å‰”é™¤æŒ‡å®šçš„ç±»æˆ–è€…åŒ…</li>
</ul>
<p>ç„¶åé€šè¿‡ <code>Transform</code> API è°ƒç”¨ <code>transform()</code> æ–¹æ³•ï¼Œæ‰«ææ‰€æœ‰ç±»åŠ å…¥åˆ° <code>classPool</code> ä¸­ï¼Œè°ƒç”¨ <code>insertRobustCode()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="function">def <span class="title">insertRobustCode</span><span class="params">(List&lt;CtClass&gt; box, File jarFile)</span> </span>&#123;</div><div class="line">    ZipOutputStream outStream=<span class="keyword">new</span> JarOutputStream(<span class="keyword">new</span> FileOutputStream(jarFile));</div><div class="line">    <span class="keyword">new</span> ForkJoinPool().submit &#123;</div><div class="line">        box.each &#123; ctClass -&gt;</div><div class="line">            <span class="keyword">if</span> (isNeedInsertClass(ctClass.getName())) &#123;</div><div class="line">               <span class="comment">//å°†classè®¾ç½®ä¸ºpublic ctClass.setModifiers(AccessFlag.setPublic(ctClass.getModifiers()))</span></div><div class="line">                <span class="keyword">boolean</span> addIncrementalChange = <span class="keyword">false</span>;</div><div class="line">                ctClass.declaredBehaviors.findAll &#123;</div><div class="line">                <span class="comment">//è§„é¿æ¥å£å’Œæ— æ–¹æ³•ç±»</span></div><div class="line">                    <span class="keyword">if</span> (ctClass.isInterface() || ctClass.declaredMethods.length &lt; <span class="number">1</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (!addIncrementalChange) &#123;</div><div class="line">                    <span class="comment">//æ’å…¥ public static ChangeQuickRedirect changeQuickRedirect;</span></div><div class="line">                        addIncrementalChange = <span class="keyword">true</span>;</div><div class="line">                        ClassPool classPool = it.declaringClass.classPool</div><div class="line">                        CtClass type = classPool.getOrNull(Constants.INTERFACE_NAME);</div><div class="line">                        CtField ctField = <span class="keyword">new</span> CtField(type, Constants.INSERT_FIELD_NAME, ctClass);</div><div class="line">                        ctField.setModifiers(AccessFlag.PUBLIC | AccessFlag.STATIC)</div><div class="line">                        ctClass.addField(ctField)</div><div class="line">                        logger.debug <span class="string">"ctClass: "</span> + ctClass.getName();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (it.getMethodInfo().isStaticInitializer()) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// synthetic æ–¹æ³•æš‚æ—¶ä¸aop æ¯”å¦‚AsyncTask ä¼šç”Ÿæˆä¸€äº›åŒå syntheticæ–¹æ³•,å¯¹synthetic ä»¥åŠprivateçš„æ–¹æ³•ä¹Ÿæ’å…¥çš„ä»£ç ï¼Œä¸»è¦æ˜¯é’ˆå¯¹lambdaè¡¨è¾¾å¼</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.SYNTHETIC) != <span class="number">0</span> &amp;&amp; !AccessFlag.isPrivate(it.getModifiers())) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//ä¸æ”¯æŒæ„é€ æ–¹æ³•</span></div><div class="line">                    <span class="keyword">if</span> (it.getMethodInfo().isConstructor()) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//è§„é¿æŠ½è±¡æ–¹æ³•</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.ABSTRACT) != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//è§„é¿NATIVEæ–¹æ³•</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.NATIVE) != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//è§„é¿æ¥å£</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.INTERFACE) != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (it.getMethodInfo().isMethod()) &#123;</div><div class="line">                        <span class="keyword">if</span> (AccessFlag.isPackage(it.modifiers)) &#123;</div><div class="line">                            it.setModifiers(AccessFlag.setPublic(it.modifiers))</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰æ–¹æ³•è°ƒç”¨ï¼Œè¿”å›æ˜¯å¦æ’åº„</span></div><div class="line">                        <span class="keyword">boolean</span> flag = modifyMethodCodeFilter(it)</div><div class="line">                        <span class="keyword">if</span> (!flag) &#123;</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//æ–¹æ³•è¿‡æ»¤</span></div><div class="line">                    <span class="keyword">if</span> (isExceptMethodLevel &amp;&amp; exceptMethodList != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">for</span> (String exceptMethod : exceptMethodList) &#123;</div><div class="line">                            <span class="keyword">if</span> (it.name.matches(exceptMethod)) &#123;</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (isHotfixMethodLevel &amp;&amp; hotfixMethodList != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">for</span> (String name : hotfixMethodList) &#123;</div><div class="line">                            <span class="keyword">if</span> (it.name.matches(name)) &#123;</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">true</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> !isHotfixMethodLevel</div><div class="line">                &#125;.each &#123; ctBehavior -&gt;</div><div class="line">                    <span class="comment">// methodMap must be put here</span></div><div class="line">                    methodMap.put(ctBehavior.longName, insertMethodCount.incrementAndGet());</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (ctBehavior.getMethodInfo().isMethod()) &#123;</div><div class="line">                            <span class="keyword">boolean</span> isStatic = ctBehavior.getModifiers() &amp; AccessFlag.STATIC;</div><div class="line">                            CtClass returnType = ctBehavior.getReturnType0();</div><div class="line">                            String returnTypeString = returnType.getName();</div><div class="line">                            def body = <span class="string">"if ($&#123;Constants.INSERT_FIELD_NAME&#125; != null) &#123;"</span></div><div class="line">                            body += <span class="string">"Object argThis = null;"</span></div><div class="line">                            <span class="keyword">if</span> (!isStatic) &#123;</div><div class="line">                                body += <span class="string">"argThis = \$0;"</span></div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            body += <span class="string">"   if (com.meituan.robust.PatchProxy.isSupport(\$args, argThis, $&#123;Constants.INSERT_FIELD_NAME&#125;, $isStatic, "</span> + methodMap.get(ctBehavior.longName) + <span class="string">")) &#123;"</span></div><div class="line">                            body += getReturnStatement(returnTypeString, isStatic, methodMap.get(ctBehavior.longName));</div><div class="line">                            body += <span class="string">"   &#125;"</span></div><div class="line">                            body += <span class="string">"&#125;"</span></div><div class="line">                            ctBehavior.insertBefore(body);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t ) &#123;</div><div class="line">                        logger.error <span class="string">"ctClass: "</span> + ctClass.getName() + <span class="string">" error: "</span> + t.toString();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                &#125;</div><div class="line">            zipFile(ctClass.toBytecode(),outStream,ctClass.name.replaceAll(<span class="string">"\\."</span>,<span class="string">"/"</span>)+<span class="string">".class"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;.get()</div><div class="line">    outStream.close();</div><div class="line">    logger.debug <span class="string">"robust insertMethodCount: "</span> + insertMethodCount.get()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>å°†classè®¾ç½®ä¸ºpublic</li>
<li>è§„é¿ æ¥å£</li>
<li>è§„é¿ æ— æ–¹æ³•ç±»</li>
<li>è§„é¿ æ„é€ æ–¹æ³•</li>
<li>è§„é¿ æŠ½è±¡æ–¹æ³•</li>
<li>è§„é¿ nativeæ–¹æ³•</li>
<li>è§„é¿ syntheticæ–¹æ³•</li>
<li>è¿‡æ»¤é…ç½®æ–‡ä»¶ä¸­ä¸éœ€è¦ä¿®å¤çš„ç±»</li>
<li>é€šè¿‡ javassist åœ¨ç±»ä¸­æ’å…¥ <code>public static ChangeQuickRedirect changeQuickRedirect;</code></li>
<li>é€šè¿‡ javassist åœ¨æ–¹æ³•ä¸­æ’å…¥é€»è¾‘ä»£ç æ®µ</li>
<li>é€šè¿‡ zipFile() æ–¹æ³•å†™å›classæ–‡ä»¶</li>
</ul>
<p>æœ€åè°ƒç”¨ <code>writeMap2File()</code> å°†æ’æ¡©çš„æ–¹æ³•ä¿¡æ¯å†™å…¥ robust/methodsMap.robust æ–‡ä»¶ä¸­ï¼Œæ­¤æ–‡ä»¶å’Œæ··æ·†çš„mappingæ–‡ä»¶éœ€è¦å¤‡ä»½ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åˆ°è¿™é‡Œæœ¬ç¯‡æ–‡ç« ç»“æŸï¼Œä¸»è¦è®²äº†ä¸‹åŸºç¡€åŸç†ã€è¡¥ä¸åŠ è½½æµç¨‹å’Œæ’æ¡©è¿‡ç¨‹ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•çš„å¯¹ Robust åšä¸‹æ€»ç»“ã€‚</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç”±äºä½¿ç”¨å¤šClassLoaderæ–¹æ¡ˆï¼ˆè¡¥ä¸ä¸­æ— æ–°å¢Activityï¼Œæ‰€ä»¥ä¸ç®—æ¿€è¿›ç±»å‹çš„åŠ¨æ€åŠ è½½ï¼Œæ— éœ€hook systemï¼‰ï¼Œå…¼å®¹æ€§å’Œç¨³å®šæ€§æ›´å¥½ï¼Œä¸å­˜åœ¨preverifyçš„é—®é¢˜</li>
<li>ç”±äºé‡‡ç”¨ InstantRun çš„çƒ­æ›´æ–°æœºåˆ¶ï¼Œæ‰€ä»¥å¯ä»¥å³æ—¶ç”Ÿæ•ˆï¼Œä¸éœ€è¦é‡å¯</li>
<li>æ”¯æŒAndroid2.3-7.Xç‰ˆæœ¬</li>
<li>å¯¹æ€§èƒ½å½±å“è¾ƒå°ï¼Œä¸éœ€è¦åˆæˆpatch</li>
<li>æ”¯æŒæ–¹æ³•çº§åˆ«çš„ä¿®å¤ï¼Œæ”¯æŒé™æ€æ–¹æ³•</li>
<li>æ”¯æŒæ–°å¢æ–¹æ³•å’Œç±»</li>
<li>æ”¯æŒProGuardçš„æ··æ·†ã€å†…è”ã€ç¼–è¯‘å™¨ä¼˜åŒ–åå¼•èµ·çš„é—®é¢˜(æ¡¥æ–¹æ³•ã€lambdaã€å†…éƒ¨ç±»ç­‰)ç­‰æ“ä½œ</li>
</ul>
<p>å½“ç„¶ï¼Œæœ‰ä¼˜ç‚¹å°±ä¼šæœ‰ç¼ºç‚¹ï¼š</p>
<ul>
<li>æš‚æ—¶ä¸æ”¯æŒæ–°å¢å­—æ®µï¼Œä½†å¯ä»¥é€šè¿‡æ–°å¢ç±»è§£å†³</li>
<li>æš‚æ—¶ä¸æ”¯æŒä¿®å¤æ„é€ æ–¹æ³•ï¼Œå·²ç»åœ¨å†…æµ‹</li>
<li>æš‚æ—¶ä¸æ”¯æŒèµ„æºå’Œ so ä¿®å¤ï¼Œä¸è¿‡è¿™ä¸ªé—®é¢˜ä¸å¤§ï¼Œå› ä¸ºç‹¬ç«‹äº dex è¡¥ä¸ï¼Œå·²ç»æœ‰å¾ˆæˆç†Ÿçš„æ–¹æ¡ˆäº†ï¼Œå°±çœ‹æ€ä¹ˆæ‰“åˆ°è¡¥ä¸åŒ…ä¸­ä»¥åŠ diff æ–¹æ¡ˆã€‚</li>
<li>å¯¹äºè¿”å›å€¼æ˜¯ this çš„æ–¹æ³•æ”¯æŒä¸å¤ªå¥½</li>
<li><strong>æ²¡æœ‰å®‰å…¨æ ¡éªŒï¼Œéœ€è¦å¼€å‘è€…åœ¨åŠ è½½è¡¥ä¸ä¹‹å‰è‡ªå·±åšéªŒè¯</strong></li>
<li>å¯èƒ½ä¼šå‡ºç°æ·±åº¦æ–¹æ³•å†…è”å¯¼è‡´çš„ä¸å¯é¢„çŸ¥çš„é”™è¯¯(å‡ ç‡å¾ˆå°å¯ä»¥å¿½ç•¥)</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼ŒRobustæ˜¯å¯ç”¨çš„ã€é«˜ç¨³å®šæ€§çš„ã€æˆåŠŸç‡å¾ˆé«˜ï¼ˆå®˜æ–¹è¯´99.9%ï¼‰çš„ã€æ— ä¾µå…¥çš„ä¸€æ¬¾ä¼˜ç§€çš„çƒ­ä¿®å¤æ¡†æ¶ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="http://tech.meituan.com/android_robust.html" target="_blank" rel="external">Androidçƒ­æ›´æ–°æ–¹æ¡ˆRobust</a></li>
<li><a href="http://tech.meituan.com/android_autopatch.html" target="_blank" rel="external">Androidçƒ­æ›´æ–°æ–¹æ¡ˆRobustå¼€æºï¼Œæ–°å¢è‡ªåŠ¨åŒ–è¡¥ä¸å·¥å…·
</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/26036302" target="_blank" rel="external">çƒ­ä¿®å¤æ¡†æ¶ç ”ç©¶ä¹‹RobuståŸç†</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/03/31/robust-0/">http://w4lle.com/2017/03/31/robust-0/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ—©åœ¨16å¹´9æœˆä»½ï¼Œç¾å›¢æŠ€æœ¯å›¢é˜Ÿå°±å†™è¿‡ä¸€ç¯‡æ–‡ç« æè¿° Android çƒ­è¡¥ä¸æ¡†æ¶Robustçš„ç®€å•å®ç°åŸç†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¼€æºï¼›ç„¶ååœ¨17å¹´3æœˆä»½ï¼Œç¾å›¢å›¢é˜Ÿå®£å¸ƒæ­£å¼å¼€æº Robustå¹¶ä¸”é…å¥—äº†è‡ªåŠ¨æ‰“è¡¥ä¸åŒ…å·¥å…·ã€‚æœ¬ç³»åˆ—æ–‡ç« ä¸»è¦è§£æRobustå®ç°åŸç†ï¼Œåˆ†ä¸ºå‡ ä¸ªæ–¹é¢&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¡¥ä¸åŠ è½½è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ¬æ–‡ä¸ºç¬¬ä¸€ç¯‡ï¼Œä¸»è¦è®²è§£è¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æç‰ˆæœ¬ &lt;code&gt;0.3.2&lt;/code&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>å†è§ï¼Œè–„è·ï¼</title>
    <link href="http://w4lle.com/2017/03/08/goodbye-boohee/"/>
    <id>http://w4lle.com/2017/03/08/goodbye-boohee/</id>
    <published>2017-03-07T16:00:00.000Z</published>
    <updated>2017-03-08T12:56:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>2015.3.23 - 2017.3.8 </p>
<p>ä¸¤å¹´æ—¶å…‰ï¼ŒåŒ†åŒ†è€Œé€ã€‚</p>
<p>æ¥åˆ°è–„è·å·²ç»ä¸¤å¹´æ—¶é—´ï¼Œè¯´é•¿ä¸é•¿ï¼Œè¯´çŸ­ä¸çŸ­ã€‚</p>
<a id="more"></a>
<p>ä¸¤å¹´æ¥åœ¨å…¬å¸ä¹Ÿæˆé•¿äº†å¾ˆå¤šï¼ŒåŒ…æ‹¬æŠ€æœ¯å’ŒæŠ€æœ¯ä»¥å¤–çš„å…¶ä»–ä¸œè¥¿ã€‚</p>
<p>è–„è·æ˜¯å¾ˆæ³¨é‡æŠ€æœ¯æ°›å›´çš„å…¬å¸ï¼Œæˆ‘ä»¬çš„æŠ€æœ¯å›¢é˜Ÿæ˜¯æˆ‘å·¥ä½œä»¥æ¥æŠ€æœ¯æ°›å›´æœ€ä¸ºæµ“åšçš„å›¢é˜Ÿï¼Œå…·ä½“ä½“ç°åœ¨æ¯å‘¨ä¸‰æ™šçš„æŠ€æœ¯åˆ†äº«å’Œæ¯å‘¨æœ«æ¯äººä¸€ç¯‡çš„æŠ€æœ¯åšå®¢ã€‚åšæŒå†™ä½œæ˜¯è–„è·é•¿ä¹…ä»¥æ¥çš„ä¼˜ç§€ä¼ ç»Ÿï¼Œæˆ‘ä¹‹å‰ä¸€ç›´åœ¨CSDNå†™åšå®¢ï¼Œéš”ä¸‰å·®äº”å†™ä¸€ç¯‡æœ‰æ—¶å€™ä¸å¤Ÿç§¯æï¼Œä½†æ˜¯ä»åŠ å…¥è–„è·åå†™ä½œçš„ç§¯ææ€§ä¹Ÿæœ‰äº†æé«˜ï¼Œä¸ªäººåšå®¢ä»2016å¹´æ­å»ºè‡³ä»Šä¹ŸæŒç»­å†™äº†ä¸€äº›æ–‡ç« ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€äº›è´¨é‡è¿˜ä¸é”™çš„æ–‡ç« è¢«å¹¿æ³›é˜…è¯»ï¼Œä¸€å¹´çš„æ—¶é—´åšå®¢ä¹Ÿæœ‰äº†6wçš„è®¿é—®é‡ï¼Œè™½ç„¶ä¸å¤šï¼Œå¯¹æˆ‘æ¥è¯´ä¹Ÿæ˜¯ä¸€ç§æ¿€åŠ±ï¼Œè¯´æ˜åˆ†äº«çš„ä¸œè¥¿ä¹Ÿä¼šå¯¹åˆ«äººæœ‰ç”¨ã€‚</p>
<p>è‡³äºAndroidç»„ï¼Œæˆ‘ä»¬æœ‰å……åˆ†è‡ªç”±çš„æŠ€æœ¯æ ˆé€‰æ‹©ï¼Œåœ¨å¯ç”¨æ€§å’Œç¨³å®šæ€§çš„å‰æä¸‹ï¼Œéƒ½å¯ä»¥å¼•å…¥é¡¹ç›®ä¸­ä½¿ç”¨ã€‚åœ¨è¿™ä¸¤å¹´æ—¶é—´é‡Œï¼Œæˆ‘ä¹Ÿä¸»åŠ¨æ‰¿æ‹…äº†ä¸€äº›åŸºç¡€å·¥ä½œï¼Œæ…¢æ…¢ä¹Ÿæˆé•¿ä¸ºAndroidç»„çš„è´Ÿè´£äººï¼Œæœ‰ä»˜å‡ºå°±ä¼šæœ‰å›æŠ¥ï¼Œä¸ç”¨ç€æ€¥ï¼Œæƒ³è¦çš„ï¼Œæ—¶å…‰éƒ½ä¼šç»™ä½ ã€‚ä¸¤å¹´æ—¶é—´æ›´æ–°äº†å¤šå°‘ç‰ˆæœ¬å·²ç»è®°ä¸å¾—ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªç‰ˆæœ¬æ›´æ–°éƒ½æœ‰æˆ‘çš„ä»˜å‡ºã€‚æœ‰è¿‡å¼€å¿ƒï¼Œæœ‰è¿‡å¤±è½ï¼Œä¸ç®¡æ€æ ·ï¼Œè¿™æ®µå·¥ä½œå·²ç»è¿‡å»ï¼Œä»˜å‡ºçš„æ±—æ°´ç»ˆç©¶æ²¡æœ‰ç™½è´¹ã€‚</p>
<p>è¦æ„Ÿè°¢stormzhangå¯¹æˆ‘å·¥ä½œçš„ä¿¡ä»»å’Œå¸®åŠ©ï¼Œä¹Ÿè¦è°¢è°¢skykaiã€loodyã€ttdevsè¿™äº›å°ä¼™ä¼´ä»¬ï¼Œæ˜¯å¤§å®¶çš„å·¥ä½œæ€åº¦è®©æˆ‘ä»¬è¿™ä¸ªå›¢é˜Ÿè¿™ä¹ˆæœ‰å‡èšåŠ›ã€‚æ¯å½“åˆ«äººé—®èµ·ä½ å¿ƒä¸­çš„ç†æƒ³å›¢é˜Ÿæ˜¯ä»€ä¹ˆæ ·å­ï¼Œæˆ‘éƒ½ä¼šæ¯«ä¸çŠ¹è±«çš„å›ç­”ï¼Œæˆ‘ç°åœ¨æ‰€åœ¨çš„å›¢é˜Ÿå°±æ˜¯æˆ‘å‘å¾€çš„å›¢é˜Ÿã€‚å¤§å®¶å¯¹æŠ€æœ¯çš„çƒ­æƒ…ï¼Œå·¥ä½œçš„ç§¯ææ€åº¦ï¼Œå›¢é˜Ÿè¶³å¤Ÿopençš„æ°›å›´ï¼Œé‡åˆ°é—®é¢˜æ°¸ä¸æœè¾“çš„ç²¾ç¥ï¼Œç”Ÿæ´»ä¸­çš„äº’ç›¸å¸®åŠ©ï¼Œç¢°å·§ä¹Ÿæœ‰å…±åŒçš„çˆ±å¥½ï¼Œæˆ‘è¯´è¿™å°±æ˜¯æˆ‘ç†æƒ³çš„å›¢é˜Ÿã€‚</p>
<p>åœ¨è–„è·çš„è¿™ä¸¤å¹´ï¼Œä¹Ÿå®Œæˆäº†äººç”Ÿä¸­çš„ä¸¤ä»¶å¤§äº‹ã€‚ç»“å©šã€ç”Ÿå­ã€‚æˆ‘å¾ˆæ„Ÿæ©ã€‚æ„Ÿæ©æœ‰ä¸ªè´¤æƒ çš„åª³å¦‡å„¿ï¼Œæ„Ÿæ©æˆ‘ä»¬æœ‰å¥åº·æ¼‚äº®çš„å°jojoï¼Œè‡ªä»æœ‰äº†jojoæˆ‘ä»¬å®¶æ¬¢ç¬‘å°±æ²¡æ–­è¿‡ï¼Œæ¯å¤©å“ˆå“ˆå“ˆã€‚ç”·äººä¸å°±æ˜¯è¿™æ ·ï¼Œå¦»å„¿è€å°ä¸€äººæ‰›ï¼Œå®¶åº­å¹¸ç¦æ¯”å•¥éƒ½å¼ºã€‚å¸Œæœ›æ—¶é—´å¯ä»¥æ…¢ç‚¹èµ°ï¼Œæˆ‘ä»¬çš„å°jojoæ…¢æ…¢å¥åº·é•¿å¤§ï¼Œè®©æˆ‘ä»¬å¤šäº«å—å°jojoæˆé•¿å¸¦ç»™æˆ‘ä»¬çš„å¿«ä¹ã€‚</p>
<p>ç”±äºä¸ªäººåŸå› ç¦»å¼€å…¬å¸ï¼Œä»Šå¤©ä¸‹åˆåŠçš„ç¦»èŒæ‰‹ç»­ï¼Œä¸´èµ°ä¹‹å‰ï¼Œæäº¤äº†æœ€åä¸€è¡Œä»£ç ï¼Œcommit messageæ˜¯â€œGoodbyeâ€ã€‚å›¢é˜Ÿå°ä¼™ä¼´ä»¬ä¸€ç›´æŠŠæˆ‘é€åˆ°åœ°é“ç«™æ‰ç¦»å»ï¼Œæˆ‘çš„å¿ƒé‡Œä¹Ÿæ˜¯å¾ˆå¤šä¸èˆï¼Œä½†æ˜¯äººç”Ÿä¸å°±æ˜¯è¿™æ ·ä¹ˆï¼Œå¤©ä¸‹æ²¡æœ‰ä¸æ•£çš„ç­µå¸­ï¼Œåªèƒ½å¿ƒä¸­é»˜å¿µç¥å¤§å®¶éƒ½å¥½ï¼</p>
<p>è™½ç„¶æœ‰äº›ä¸èˆï¼Œä½†æˆ‘å¿ƒé‡Œæ›´å¤šçš„æ˜¯å¯¹æ–°ç”Ÿæ´»çš„æœŸå¾…ï¼ŒæœŸå¾…ç¾å¥½çš„æ˜å¤©ï¼ŒæœŸå¾…ç»™å®¶äººä¸€ä¸ªç¨³å®šçš„å®¶ï¼ŒæœŸå¾…ç®€å•çš„ç¨³ç¨³çš„å¹¸ç¦ã€‚æœŸå¾…çˆ¶æ¯èº«ä½“å¥åº·ï¼ŒæœŸå¾…è€å©†è´¤æƒ æ¼‚äº®ï¼ŒæœŸå¾…jojoå¥åº·æˆé•¿ã€‚æœŸå¾…æ°¸è¿œå¹´è½»ï¼Œæ°¸è¿œçƒ­æ³ªç›ˆçœ¶ï¼Œæ°¸è¿œç›¸ä¿¡æ¢¦æƒ³ã€‚</p>
<p>å·²ç»è¿œå»çš„ï¼Œå¸¦ç€ç¾å¥½è®°å¿†æŒ¥æŒ¥æ‰‹è¯´å£°æ‹œæ‹œã€‚</p>
<p>å°†è¦åˆ°æ¥çš„ï¼Œæ€€ç€æœŸå¾…å¼ å¼€åŒæ‰‹è¿æ¥æœªæ¥ã€‚</p>
<p>å†è§ï¼Œè–„è·ã€‚</p>
<p>ä½ å¥½ï¼Œæ˜å¤©ã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/03/08/goodbye-boohee/">http://w4lle.com/2017/03/08/goodbye-boohee/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2015.3.23 - 2017.3.8 &lt;/p&gt;
&lt;p&gt;ä¸¤å¹´æ—¶å…‰ï¼ŒåŒ†åŒ†è€Œé€ã€‚&lt;/p&gt;
&lt;p&gt;æ¥åˆ°è–„è·å·²ç»ä¸¤å¹´æ—¶é—´ï¼Œè¯´é•¿ä¸é•¿ï¼Œè¯´çŸ­ä¸çŸ­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å…¶ä»–" scheme="http://w4lle.com/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>Gradleæ¨¡å—åŒ–é…ç½®</title>
    <link href="http://w4lle.com/2017/01/22/gradle-modules/"/>
    <id>http://w4lle.com/2017/01/22/gradle-modules/</id>
    <published>2017-01-22T01:53:37.000Z</published>
    <updated>2017-01-23T00:56:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä»¥<a href="https://github.com/shwenzhang/AndResGuard" target="_blank" rel="external">AndResGuard</a>å’Œ<a href="https://github.com/Tencent/tinker" target="_blank" rel="external">Tinker</a>ä¸ºä¾‹è®²è§£ä¸‹å¦‚ä½•æ¨¡å—åŒ–é…ç½®Gradleï¼Œä»¥åŠä¸€é”®æ‰“Tinkerè¡¥ä¸åŒ…çš„å®ç°æ–¹æ³•ã€‚<br><a id="more"></a></p>
<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>éšç€é¡¹ç›®è¶Šæ¥è¶Šå¤§ï¼Œå¼•ç”¨ç¬¬ä¸‰æ–¹åº“çš„gradleæ„ˆæ¥æ„ˆå¤šï¼Œappçš„build.gradleæ–‡ä»¶ä¹Ÿè¶Šæ¥è¶Šé•¿ï¼Œæ‹¿è–„è·Appä¸ºä¾‹å·²ç»è¾¾åˆ°äº†1000è¡Œå·¦å³ï¼Œä¸€å¤§å¨ä»£ç èµ›åœ¨ä¸€èµ·çœ‹èµ·æ¥å¾ˆä¸çˆ½ã€‚å¹¶ä¸”å°†ç¬¬ä¸‰æ–¹åº“çš„é…ç½®ç§»æ¤åˆ°æ–°é¡¹ç›®ä¹Ÿå¾ˆå›°éš¾ï¼Œç¨å¾®ä¸æ³¨æ„å°±ä¼šå‡ºé”™ã€‚</p>
<h1 id="AndResGuardé…ç½®"><a href="#AndResGuardé…ç½®" class="headerlink" title="AndResGuardé…ç½®"></a>AndResGuardé…ç½®</h1><p>é¦–å…ˆæ–°å»ºresguard.gradleæ–‡ä»¶ï¼Œé…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'AndResGuard'</span></div><div class="line">andResGuard &#123;</div><div class="line">    use7zip = <span class="keyword">true</span></div><div class="line">    useSign = <span class="keyword">true</span></div><div class="line">    keepRoot = <span class="keyword">false</span></div><div class="line">    whiteList&#123;...&#125;</div><div class="line">    compressFilePattern&#123;...&#125;</div><div class="line">    sevenzip&#123;...&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ä¸»é¡¹ç›®çš„build.gradleä¸­åŠ å…¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">apply from: <span class="string">'../resguard.gradle'</span></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath (<span class="string">'com.tencent.mm:AndResGuard-gradle-plugin:1.1.16'</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±é…ç½®å¥½äº†ï¼Œå­Projectä¾èµ–resguardè„šæœ¬ï¼Œsyncä¸‹å°±èƒ½çœ‹åˆ°resguard Taskäº†ã€‚é‚£ä¹ˆç§»æ¤åˆ°æ–°é¡¹ç›®åªéœ€è¦æŠŠresguard.gradleæ‹·è´è¿‡å»å°±okäº†ã€‚</p>
<h1 id="Tinkeré…ç½®"><a href="#Tinkeré…ç½®" class="headerlink" title="Tinkeré…ç½®"></a>Tinkeré…ç½®</h1><p>ç”±äºè¦é…åˆAndResGuardä½¿ç”¨ï¼ŒTinkerçš„gradleé…ç½®ç›¸å¯¹æ¥è¯´å¤æ‚äº›ï¼Œç„¶åæˆ‘åˆåœ¨ä¸­é—´æ’å…¥äº†è‡ªåŠ¨å¤‡ä»½å’Œå¤šæ¸ é“æ‰“åŒ…çš„taskï¼Œç„¶åå°±å¯ä»¥ä¸€é”®æ‰“ReleaseåŒ…å’Œè¡¥ä¸åŒ…ã€‚</p>
<p>é¦–å…ˆæ–°å»ºtinker.graldeæ–‡ä»¶ï¼Œé¦–å…ˆæŠŠTinkerçš„å®˜æ–¹åŸºæœ¬é…ç½®copyè¿›æ¥æ­¤å¤„ä»£ç ç•¥ã€‚å…ˆçœ‹ä¸‹Projectçš„build.gradleæ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">apply from: <span class="string">'../tinker.gradle'</span></div><div class="line">apply from: <span class="string">'../utils.gradle'</span></div><div class="line">dependencies &#123;</div><div class="line">    classpath (<span class="string">"com.tencent.tinker:tinker-patch-gradle-plugin:$&#123;TINKER_VERSION&#125;"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Projectåªéœ€è¦é…ç½®è¿™ä¸¤è¡Œä»£ç å°±å¯ä»¥äº†ã€‚å…¶ä¸­çš„utils.gradleæ˜¯ä¸€ä¸ªå·¥å…·è„šæœ¬æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€äº›å¸¸ç”¨çš„å·¥å…·æ–¹æ³•ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//utils.gradle</span></div><div class="line">ext &#123;</div><div class="line">    releaseTime = <span class="keyword">this</span>.&amp;releaseTime</div><div class="line">    packageChannel = <span class="keyword">this</span>.&amp;packageChannel</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">def <span class="title">releaseTime</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date().format(<span class="string">"yyyy-MM-dd"</span>, TimeZone.getTimeZone(<span class="string">"UTC"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å¤šæ¸ é“æ‰“åŒ…ï¼Œä½¿ç”¨çš„ç¾å›¢æ–¹æ¡ˆ</span></div><div class="line"><span class="function">def <span class="title">packageChannel</span><span class="params">(String releaseApk)</span> </span>&#123;</div><div class="line">    print <span class="string">"begin package Channel! \n "</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        def stdout = <span class="keyword">new</span> ByteArrayOutputStream()</div><div class="line">        exec &#123;</div><div class="line">            commandLine <span class="string">'python'</span>, rootProject.getRootDir().getAbsolutePath() + <span class="string">"/app/multi_build.py"</span>, releaseApk</div><div class="line">            standardOutput = stdout</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> stdout.toString().trim()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (ignored) &#123;</div><div class="line">        print <span class="string">"package Channel Error! \n "</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"UnKnown"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„å¤šæ¸ é“æ‰“åŒ…æ–¹æ¡ˆä»ç„¶ä½¿ç”¨çš„ç¾å›¢ä¹‹å‰çš„å¾€META-INFæ’å…¥ç©ºæ–‡ä»¶çš„åšæ³•ï¼Œæ˜¯å› ä¸ºAndResGuardèµä¸æ”¯æŒv2ç­¾åï¼Œæš‚æ—¶æ— æ³•ä½¿ç”¨æ–°ä¸€ä»£çš„v2ç­¾åå¤šæ¸ é“æ‰“åŒ…æ–¹æ¡ˆ<a href="https://github.com/Meituan-Dianping/walle" target="_blank" rel="external">walle</a>ã€‚</p>
<p>ç»§ç»­çœ‹tinker.gradleï¼Œé¦–å…ˆéœ€è¦é…ç½®ä¾èµ–åº“å’Œæ‰“åŒ…æ—¶çš„æ’å…¥ä»£ç æ¯”å¦‚ç‰ˆæœ¬å·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    defaultConfig &#123;</div><div class="line">        <span class="comment">//æ¯æ¬¡å‘è¡¥ä¸éœ€è¦æ›´æ”¹æ­¤å¤„ å¢åŠ patchç‰ˆæœ¬å·ã€‚å‡çº§app ç‰ˆæœ¬è¦è¿˜åŸ0.0</span></div><div class="line">        buildConfigField <span class="string">"String"</span>, <span class="string">"PATCH_VERSION"</span>, <span class="string">"\"0.0\""</span></div><div class="line">        buildConfigField <span class="string">"String"</span>, <span class="string">"PLATFORM"</span>, <span class="string">"\"all\""</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    provided(<span class="string">"com.tencent.tinker:tinker-android-anno:$&#123;cfg.TINKER_VERSION&#125;"</span>)</div><div class="line">    compile(<span class="string">"com.tencent.tinker:tinker-android-lib:$&#123;cfg.TINKER_VERSION&#125;"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·é…ç½®å®ŒTinkerå°±å¯ä»¥å¯ç”¨äº†ï¼Œç„¶åæˆ‘ä»¬è¦å¤„ç†å’ŒAndResGuardé…ç½®ä½¿ç”¨ä»¥åŠè‡ªåŠ¨å¤‡ä»½è‡ªåŠ¨æ‰“æ¸ é“åŒ…ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä½¿ç”¨resguardæ‰“æ­£å¼åŒ…åéœ€è¦å¤‡ä»½apkã€Rã€mappingã€Resource mappingï¼›å¹¶ä¸”æ‰“æ¸ é“åŒ…</li>
<li>æ‰“è¡¥ä¸åŒ…éœ€è¦è‡ªåŠ¨å¡«å…¥resguardæ–°æ‰“å‡ºåŒ…çš„è·¯å¾„buildApkPathï¼Œapkã€Rã€mappingã€Resource mappingæ–‡ä»¶çš„å¯¹åº”è·¯å¾„ã€‚</li>
<li>æ‰“è¡¥ä¸åŒ…æ—¶resguardæ–°æ‰“å‡ºçš„åŒ…ä¸éœ€è¦å¤‡ä»½</li>
<li>éœ€è¦åŒºåˆ†debugå’Œreleaseåˆ‡æ¢å¤‡ä»½è·¯å¾„</li>
</ol>
<p>å¯¹åº”ä»¥ä¸Šå‡ ç‚¹ï¼Œç»™å‡ºå…³é”®ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">def cfg = rootProject.ext</div><div class="line">def bakPath = file(<span class="string">"$&#123;buildDir.parent&#125;/tinkerBackup/"</span>)</div><div class="line">def bakResguard = file(<span class="string">"$&#123;bakPath&#125;"</span>)</div><div class="line">def debugBakPath = file(<span class="string">"$&#123;buildDir.absolutePath&#125;/tinkerBackup"</span>)</div><div class="line">ext &#123;</div><div class="line">    appName = <span class="string">"nicepro"</span></div><div class="line">    ...</div><div class="line">    çœç•¥tinkeré…ç½®</div><div class="line">&#125;</div><div class="line">    def isNeedBackup = <span class="keyword">true</span></div><div class="line">    task AtinkerPatchPrepare &lt;&lt; &#123;</div><div class="line">        isNeedBackup = <span class="keyword">false</span></div><div class="line">        def backUpVersion = <span class="string">""</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).exists()) &#123;</div><div class="line">            backUpVersion = <span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).getText()</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!backUpVersion.isEmpty()) &#123;</div><div class="line">            print <span class="string">"app version : + $&#123;backUpVersion&#125; \n"</span></div><div class="line">            project.tinkerPatch.oldApk = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;.apk"</span></div><div class="line">            project.tinkerPatch.buildConfig.applyResourceMapping = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;_R.txt"</span></div><div class="line">            project.andResGuard.mappingFile = file(<span class="string">"$&#123;bakResguard&#125;/resource_mapping_$&#123;backUpVersion&#125;.txt"</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * bak apk and mapping</div><div class="line">     */</div><div class="line">    android.applicationVariants.all &#123; variant -&gt;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * task type, you want to bak</div><div class="line">         */</div><div class="line">        def taskName = <span class="string">'release'</span></div><div class="line"><span class="comment">//        def taskName = 'debug'</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (taskName.equals(<span class="string">"debug"</span>)) &#123;</div><div class="line">            bakResguard = file(<span class="string">"$&#123;buildDir.absolutePath&#125;/tinkerBackup"</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tasks.all &#123;</div><div class="line">            <span class="keyword">if</span> (variant.buildType.name == taskName) &#123;</div><div class="line"></div><div class="line">                def backUpVersion = <span class="string">""</span></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).exists()) &#123;</div><div class="line">                    backUpVersion = <span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).getText()</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (<span class="string">"tinkerPatch$&#123;taskName.capitalize()&#125;"</span>.equalsIgnoreCase(it.name)) &#123;</div><div class="line">                    def resguardTask</div><div class="line">                    tasks.all &#123;</div><div class="line">                        <span class="keyword">if</span> (it.name.equalsIgnoreCase(<span class="string">"resguard$&#123;taskName.capitalize()&#125;"</span>)) &#123;</div><div class="line">                            resguardTask = it</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    it.doFirst(&#123;</div><div class="line">                        <span class="comment">// change build apk path</span></div><div class="line">                        it.buildApkPath = <span class="string">"$&#123;buildDir&#125;/outputs/apk/AndResGuard_$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;/$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;_signed_7zip_aligned.apk"</span></div><div class="line">                        project.android.ext.tinkerOldApkPath = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;.apk"</span></div><div class="line">                        project.android.ext.tinkerApplyResourcePath = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;_R.txt"</span></div><div class="line">                    &#125;)</div><div class="line">                    it.dependsOn AtinkerPatchPrepare</div><div class="line">                    it.dependsOn resguardTask</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (<span class="string">"resguard$&#123;taskName.capitalize()&#125;"</span>.equalsIgnoreCase(it.name)) &#123;</div><div class="line">                    <span class="keyword">if</span> (!backUpVersion.isEmpty() &amp;&amp; <span class="keyword">new</span> File(<span class="string">"$&#123;backUpVersion&#125;_mapping.txt"</span>).exists()) &#123;</div><div class="line">                        ext.andResMappingFile = <span class="keyword">new</span> File(<span class="string">"$&#123;backUpVersion&#125;_mapping.txt"</span>)</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        ext.andResMappingFile = <span class="keyword">null</span></div><div class="line">                    &#125;</div><div class="line">                    it.doLast &#123;</div><div class="line">                        <span class="keyword">if</span> (!isNeedBackup) &#123;</div><div class="line">                            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">                        &#125;</div><div class="line">                        def date = <span class="keyword">new</span> Date().format(<span class="string">"MMdd-HH-mm-ss"</span>)</div><div class="line">                        def orgAndresPrefix = <span class="string">"AndResGuard_$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;"</span></div><div class="line">                        def orgApkPrefix = <span class="string">"$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;"</span></div><div class="line">                        def targetApkPrefix = <span class="string">"$&#123;appName&#125;_$&#123;taskName.capitalize()&#125;_$&#123;cfg.versionName&#125;_$&#123;date&#125;"</span></div><div class="line"></div><div class="line">                        <span class="comment">//backUpVersion</span></div><div class="line">                        File version = <span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>)</div><div class="line">                        <span class="keyword">if</span> (!version.parentFile.exists()) &#123;</div><div class="line">                            version.parentFile.mkdir()</div><div class="line">                        &#125;</div><div class="line">                        version.write(<span class="string">"$&#123;targetApkPrefix&#125;"</span>)</div><div class="line"></div><div class="line">                        copy &#123;</div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/outputs/apk/$&#123;orgAndresPrefix&#125;/$&#123;orgApkPrefix&#125;_signed_7zip_aligned.apk"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    fileName.replace(<span class="string">"$&#123;orgApkPrefix&#125;_signed_7zip_aligned.apk"</span>, <span class="string">"$&#123;targetApkPrefix&#125;.apk"</span>)</div><div class="line">                                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                    print <span class="string">"rename apk mapping error"</span></div><div class="line">                                    e.printStackTrace()</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/outputs/mapping/$&#123;taskName&#125;/mapping.txt"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                fileName.replace(<span class="string">"mapping.txt"</span>, <span class="string">"$&#123;targetApkPrefix&#125;_mapping.txt"</span>)</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/intermediates/symbols/$&#123;taskName&#125;/R.txt"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                fileName.replace(<span class="string">"R.txt"</span>, <span class="string">"$&#123;targetApkPrefix&#125;_R.txt"</span>)</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/outputs/apk/$&#123;orgAndresPrefix&#125;/resource_mapping_$&#123;orgApkPrefix&#125;.txt"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    fileName.replace(<span class="string">"resource_mapping_$&#123;orgApkPrefix&#125;.txt"</span>, <span class="string">"resource_mapping_$&#123;targetApkPrefix&#125;.txt"</span>)</div><div class="line">                                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                    print <span class="string">"rename resource mapping error"</span></div><div class="line">                                    e.printStackTrace()</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                            print <span class="string">"one resguard backup tinker base apk ok! \n"</span></div><div class="line">                        &#125;</div><div class="line">                        packageChannel(<span class="string">"$&#123;buildDir&#125;/outputs/apk/$&#123;orgAndresPrefix&#125;/$&#123;orgApkPrefix&#125;_signed_7zip_aligned.apk"</span>)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>é…ç½®å®Œæˆã€‚å‘è¡¥ä¸åŒ…åªéœ€æ‰§è¡Œ<code>./gradlew resguardRelease</code>ä¾¿ä¼šæ‰“å‡ºå¤šæ¸ é“åŒ…ä»¥åŠå¤‡ä»½tinkeréœ€è¦çš„æ–‡ä»¶ã€‚</p>
<p>æ‰“tinkerè¡¥ä¸ä¸éœ€è¦æ‰‹åŠ¨å¡«ä¾èµ–æ–‡ä»¶ï¼ŒåŒ…åªéœ€æ‰§è¡Œ<code>./gradlew tinkerProcessRelease</code>ã€‚</p>
<p>æ­£å¥½ç°åœ¨å¹¶è¡Œä¸‰ä¸ªé¡¹ç›®ï¼Œç§»æ¤è¿‡ç¨‹å¾ˆå¿«ï¼Œcopyä¸¤ä¸ªgradleé…ç½®æ–‡ä»¶å°±æå®šäº†ã€‚appçš„build.gradleä»£ç ä¹Ÿåªæœ‰ä¸åˆ°200è¡Œã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p> <a href="http://blog.csdn.net/innost/article/details/48228651" target="_blank" rel="external">æ·±å…¥ç†è§£Androidä¹‹Gradle</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/01/22/gradle-modules/">http://w4lle.com/2017/01/22/gradle-modules/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡ä»¥&lt;a href=&quot;https://github.com/shwenzhang/AndResGuard&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AndResGuard&lt;/a&gt;å’Œ&lt;a href=&quot;https://github.com/Tencent/tinker&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Tinker&lt;/a&gt;ä¸ºä¾‹è®²è§£ä¸‹å¦‚ä½•æ¨¡å—åŒ–é…ç½®Gradleï¼Œä»¥åŠä¸€é”®æ‰“Tinkerè¡¥ä¸åŒ…çš„å®ç°æ–¹æ³•ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Thingsåˆæ¢</title>
    <link href="http://w4lle.com/2017/01/06/AndroidThings-0/"/>
    <id>http://w4lle.com/2017/01/06/AndroidThings-0/</id>
    <published>2017-01-06T09:26:47.000Z</published>
    <updated>2017-01-08T08:57:51.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Android Thingsæ˜¯Googleæ¨å‡ºçš„å…¨æ–°ç‰©è”ç½‘æ“ä½œç³»ç»Ÿ<br><a id="more"></a><br>å‰èº«æ˜¯å»å¹´å‘å¸ƒçš„ç‰©è”ç½‘å¹³å° Brilloã€‚Brillo ä½¿ç”¨ C/C++ åŸºäº NDK è¿›è¡Œå¼€å‘ï¼Œè€ŒAndroid Thingsä½¿ç”¨JAVAã€Android Studioã€Android SDKã€NDKç­‰è¿›è¡Œå¼€å‘ï¼Œå¦å¤–è¿˜æ–°å¢äº†åä¸º<code>Things Support Library</code>çš„åº“è¿™ä¸ªåº“æœ‰ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼šé€šè¿‡å¤šç§åè®®å’Œæ¥å£ï¼ˆGPIOã€PWMã€I2Cã€SPIã€UARTç­‰ï¼‰è®¿é—®ä¼ æ„Ÿå™¨å’Œæ‰§è¡Œå™¨çš„å¤–å›´I/O APIï¼›ä»¥åŠä¸€ä¸ªç”¨æˆ·é©±åŠ¨APIï¼ˆUser Driver APIï¼‰ï¼Œå¯ä»¥ç»™åº”ç”¨ç¨‹åºæ·»åŠ æ–°çš„è®¾å¤‡é©±åŠ¨ï¼Œç”¨äºå°†ç¡¬ä»¶äº‹ä»¶æ³¨å…¥ç³»ç»Ÿï¼Œä½¿å®ƒä»¬å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºæ‰€ç”¨ã€‚è¿˜æœ‰ï¼ŒAndroid Things å¤©ç”Ÿæ”¯æŒç‰©è”ç½‘é€šè®¯åè®® Weaveï¼Œå¯è®©æ‰€æœ‰ç±»å‹çš„è®¾å¤‡èƒ½å¤Ÿè¿ä¸Šäº‘ç«¯å¹¶ä¸å…¶ä»–æœåŠ¡å¦‚ Google Assistant äº¤äº’ã€‚Android Thingsç›®å‰æ”¯æŒä¸‰ç§ç¡¬ä»¶å¹³å°ï¼šIntel Edisonã€NXP Picoã€Raspberry Pi 3ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/things0.png" alt=""></p>
<p>ç®€å•æ¥è¯´ï¼Œé€šè¿‡Android Thingsï¼Œå¼€å‘è€…å¯ä»¥åƒå¼€å‘Androidåº”ç”¨ä¸€æ ·ç®€å•åœ°æ§åˆ¶ç¡¬ä»¶è®¾å¤‡ã€‚</p>
<h1 id="æ­å»ºå¼€å‘ç¯å¢ƒ"><a href="#æ­å»ºå¼€å‘ç¯å¢ƒ" class="headerlink" title="æ­å»ºå¼€å‘ç¯å¢ƒ"></a>æ­å»ºå¼€å‘ç¯å¢ƒ</h1><p>ç¡¬ä»¶å¹³å°é€‰æ‹©äº†æ ‘è“æ´¾3ï¼Œéœ€è¦å‡†å¤‡çš„ç¡¬ä»¶è®¾å¤‡ï¼š</p>
<ul>
<li>æ ‘è“æ´¾3å¼€å‘æ¿ä¸€ä¸ª</li>
<li>SDå¡ä¸€å¼ ï¼Œæˆ‘ä¹°çš„32G</li>
<li>USBæ’å£çº¿ä¸€æ¡</li>
<li>HDMIè§†é¢‘è¾“å‡ºçº¿ä¸€æ¡</li>
<li>æ˜¾ç¤ºå™¨ä¸€å°</li>
<li>æœ‰çº¿é¼ æ ‡ä¸€ä¸ª</li>
<li>LEDç¯2ä¸ª</li>
<li>æœé‚¦çº¿è‹¥å¹²æ¡</li>
<li>ç½‘çº¿ä¸€æ¡</li>
</ul>
<p>ç„¶åå‡†å¤‡æŠŠä»å®˜ç½‘ä¸‹è½½è§£å‹å¥½çš„imgæ–‡ä»¶çƒ§å…¥SDå¡ï¼Œæ­¥éª¤å‚è€ƒ<a href="https://developer.android.com/things/hardware/developer-kits.html" target="_blank" rel="external">å®˜ç½‘</a>å’Œ<a href="https://www.raspberrypi.org/documentation/installation/installing-images/mac.md" target="_blank" rel="external">æ ‘è“æ´¾å®˜ç½‘</a>ï¼Œæˆ‘æŒ‰ç…§å®˜ç½‘æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo dd bs=1m if=iot_rpi3.img of=/dev/disk2</div></pre></td></tr></table></figure>
<p>æç¤º<code>Resource busy</code>ï¼Œ<a href="http://raspberrypi.stackexchange.com/questions/9217/resource-busy-error-when-using-dd-to-copy-disk-img-to-sd-card" target="_blank" rel="external">è§£å†³æ–¹æ¡ˆ</a>å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">df -h</div><div class="line">sudo diskutil unmount /dev/disk2s1</div><div class="line">sudo dd bs=<span class="number">1</span>m <span class="keyword">if</span>=iot_rpi3.img of=/dev/rdisk2</div></pre></td></tr></table></figure>
<p>çƒ§å¥½åæŠŠSDå¡æ’å…¥å¼€å‘æ¿çš„å¡æ§½é‡Œï¼ŒUSBçº¿è¿ç”µè„‘ï¼ŒHDMIè¿æ˜¾ç¤ºå™¨ã€‚ç„¶åé€šç”µå¼€æœºã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/things1.jpg" alt=""><br><img src="http://7xs23g.com1.z0.glb.clouddn.com/things2.jpg" alt=""></p>
<p>çœ‹åˆ°è¿™ä¸ªç•Œé¢å°±å¯åŠ¨å¥½äº†ï¼Œå®é™…ä¸Šè¿™ä¸ªç•Œé¢å°±æ˜¯Androidåº”ç”¨Launcherçš„ä¸€ä¸ªActivity IoTLauncherã€‚IoT(Internet of Things)ç‰©è”ç½‘çš„ç®€ç§°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">âœ code &gt;adb shell dumpsys activity | grep <span class="string">"mFocusedActivity"</span></div><div class="line">  mFocusedActivity: ActivityRecord&#123;a7148f7 u0 com.android.iotlauncher/.IoTLauncher t1&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæ’ç½‘çº¿ï¼Œå†…ç½‘IPä¼šæ˜¾ç¤ºåœ¨Launcherç•Œé¢ï¼Œç„¶åç”¨adbè¿æ¥å¼€å‘æ¿ï¼Œè¿wifi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">adb connect 192.168.1.143</div><div class="line">adb shell am startservice \\n    </div><div class="line">-n com.google.wifisetup/.WifiSetupService \\n    </div><div class="line">-a WifiSetupService.Connect \\n</div><div class="line">-e ssid ssid \\n</div><div class="line">-e passphrase ***</div><div class="line">adb shell ping 8.8.8.8</div></pre></td></tr></table></figure>
<h1 id="è¿æ¥ledç¯"><a href="#è¿æ¥ledç¯" class="headerlink" title="è¿æ¥ledç¯"></a>è¿æ¥ledç¯</h1><p>æ ¹æ®demoç»™çš„å›¾è¿æ¥ledç¯</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/rpi3_schematics.png" alt=""></p>
<p>è¿™å¼ å›¾ç»™å‡ºäº†ä¸¤æ ¹çº¿ä¸€ä¸ªæ’åœ°çº¿ï¼Œä¸€ä¸ªæ’ç»¿è‰²çš„GPIOã€‚<br>è¿™é‡Œæ”¾ä¸Šä¸€å¼ å›¾å±•ç¤ºäº†æ ‘è“æ´¾ä¸Šå¯¹åº”çš„é’ˆè„šç±»å‹å’Œnameï¼Œæ¥ä¸‹æ¥çš„æ“ä½œledéœ€è¦nameæ‰èƒ½æ§åˆ¶ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/gpio.png" alt=""></p>
<h1 id="è¿è¡Œç¨‹åº"><a href="#è¿è¡Œç¨‹åº" class="headerlink" title="è¿è¡Œç¨‹åº"></a>è¿è¡Œç¨‹åº</h1><p>å®˜ç½‘æä¾›äº†å‡ ä¸ªSampleï¼Œæˆ‘ä»¬ä¸‹è½½ä¸‹æ¥ç„¶åè¿è¡Œç¬¬ä¸€ä¸ªSample-Blinkã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PeripheralManagerService service = <span class="keyword">new</span> PeripheralManagerService();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    mLedGpio = service.openGpio(<span class="string">"BCM5"</span>);</div><div class="line">    mLedGpio.setDirection(Gpio.DIRECTION_OUT_INITIALLY_LOW);</div><div class="line">&#125; <span class="keyword">catch</span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>openGpioæ–¹æ³•ä¸­çš„å‚æ•°å°±æ˜¯ä¸Šé¢æåˆ°çš„é’ˆè„šå¯¹åº”çš„nameã€‚ç¨‹åºè·‘èµ·æ¥ä¹‹åå°±å¯ä»¥çœ‹åˆ°æ¯éš”ä¸€ç§’ledé—ªä¸€ä¸‹ï¼ŒæŒºæœ‰æ„æ€ã€‚</p>
<p>æˆ‘ä»¬ç¨å¾®æ”¹é€ ä¸‹ï¼Œå†™ä¸€ä¸ªxmlæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªbuttonï¼Œæ¯æ¬¡ç‚¹å‡»buttonæ§åˆ¶ledç¯çš„çŠ¶æ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">findViewById(R.id.btn_blink).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mLedGpio.setValue(!mLedGpio.getValue());</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>å¤–æ¥é¼ æ ‡ï¼Œæ¯ç‚¹ä¸€ä¸‹buttonæ”¹å˜ä¸€ä¸‹ledçš„äº®ç­ã€‚<br>ç„¶åå†æ”¹ä¸‹ï¼Œæ’ä¸¤ä¸ªledç¯ï¼Œç¬¬äºŒä¸ªåœ¨BCM21 <code>mLedGpio2 = service.openGpio(&quot;BCM21&quot;);</code><br>ç„¶åæ¯éš”1sæ§åˆ¶ä¸¤ä¸ªç¯çš„çŠ¶æ€å–åã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mLedGpio2.setValue(mLedGpio.getValue());</div><div class="line">mLedGpio.setValue(!mLedGpio.getValue());</div></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚å›¾ï¼Œgifå‹ç¼©å¤ªä¸¥é‡ï¼Œå‡‘åˆçœ‹å§ã€‚<br><img src="http://7xs23g.com1.z0.glb.clouddn.com/things3.gif" alt=""></p>
<p>å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œé€šè¿‡Android Thingsæ§åˆ¶ç¡¬ä»¶çœŸçš„æ„Ÿè§‰è·Ÿå¼€å‘ä¸€æ¬¾Android Appæ²¡æœ‰å¤ªå¤§ä»€ä¹ˆåŒºåˆ«ï¼ŒåŒæ ·çš„å¼€å‘å·¥å…·ï¼ŒåŒæ ·çš„å¼€å‘ç¯å¢ƒï¼Œç”šè‡³SDKå¤§äº24çš„Andriod AppåŒæ ·å¯ä»¥å®‰è£…è¿è¡Œåœ¨Android Thingsç³»ç»Ÿä¸Šï¼›è€Œå¯¹äºNDKå¼€å‘ï¼Œè·ŸAndroidä¸Šä¹Ÿæ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚</p>
<h1 id="Android-Everywhere"><a href="#Android-Everywhere" class="headerlink" title="Android Everywhere"></a>Android Everywhere</h1><p>è¿˜è®°å¾—RoyLiåœ¨åšçš„åä¸ºRuffçš„ç‰©è”ç½‘å¹³å°ï¼ŒRoyLiæ˜¯è¿™æ ·ä»‹ç»å®ƒçš„</p>
<blockquote>
<p> Ruff è®©ä¸ä¼šåšç¡¬ä»¶çš„è½¯ä»¶å·¥ç¨‹å¸ˆæ ¹æ®äº§å“ç»ç†çš„åˆ›æ„ç¼–å†™åº”ç”¨ï¼Œ(è½¯ä»¶å·¥ç¨‹å¸ˆ)ä¸ç”¨å…³å¿ƒåº•å±‚å®ç°å’Œé©±åŠ¨ç§»æ¤é—®é¢˜ï¼Œé€šè¿‡å¼€å‘è€…å»ºç«‹çš„åº”ç”¨ç”Ÿæ€æœ€ç»ˆè§£å†³ç‰©è”ç½‘è½¯ä»¶è½åçš„é—®é¢˜ã€‚<br>Ruffçš„ç›®çš„å°±æ˜¯è¦åšç‰©è”ç½‘é¢†åŸŸçš„Androidå¹³å°ï¼Œé‡‡ç”¨æ¯”è¾ƒæµè¡Œçš„JavaScriptä½œä¸ºç¼–ç¨‹è¯­è¨€ç›´æ¥æ“ä½œç¡¬ä»¶ã€‚</p>
</blockquote>
<p>è€Œç°åœ¨Android Thingså·²ç»ç§»æ¤åˆ°äº†ç‰©è”ç½‘é¢†åŸŸï¼ŒGoogleçš„é‡å¿ƒä¹Ÿå¯è§ä¸€æ–‘ï¼Œå…¶å¯¹äºåƒRuffè¿™æ ·çš„åˆ›ä¸šé¡¹ç›®çš„å†²å‡»ä¹Ÿå¯æƒ³è€ŒçŸ¥ã€‚æ”¾ä¸€å¼ 2015å¹´Google I/Oå¤§ä¼šä¸Šçš„æ—§å›¾</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/google_to.png" alt=""></p>
<p>Androidæœ‰åºå¤§çš„å¼€å‘è€…æ”¯æŒï¼Œå®Œå–„çš„å¼€å‘å·¥å…·é…å¥—ï¼Œä¹Ÿè®¸AndroidçœŸçš„å¯ä»¥åšåˆ°è¿æ¥ä¸‡ç‰©çš„å¯èƒ½ï¼ŒAndroidåœ¨ä¸è¿œçš„æœªæ¥çœŸçš„å¯èƒ½æ— å¤„ä¸åœ¨ï¼Œä¹˜æ­¤ä¸œé£ï¼ŒAndroidå¼€å‘è€…ä¹Ÿå¯å¤§æœ‰å¯ä¸ºã€‚</p>
<h1 id="å®‰å…¨"><a href="#å®‰å…¨" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h1><p>è¯´åˆ°ç‰©è”ç½‘å°±ä¸å¾—ä¸è¯´å®‰å…¨ï¼Œåœ¨è½¯ä»¶å±‚é¢ç›—ä¸ªå·ï¼Œä¸ªäººä¿¡æ¯è¢«çªƒå–å¯èƒ½æ„Ÿè§‰é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯å¯¹äºè”ç½‘çš„ç¡¬ä»¶æ¥è¯´å°±å¾ˆå¯æ€•äº†ï¼Œæ¯”å¦‚è¯´é—¨é”è¢«ç ´è§£ï¼Œä½ å®¶çš„ç…¤æ°”è¢«è¿œç¨‹æ§åˆ¶ï¼ŒåŠå¤œä½ å®¶ç”µè§†çªç„¶å“äº†ï¼Œå°±é—®ä½ æ€•ä¸æ€•ã€‚</p>
<p>Googleæ—¢ç„¶æƒ³ç»Ÿä¸€IoTæ ‡å‡†ï¼Œé‚£ä¹ˆIoTçš„å®‰å…¨æ€§å¿…é¡»é‡è§†ï¼Œå› ä¸ºåœ¨æ ‡å‡†æœªç»Ÿä¸€ä¹‹å‰ç ´è§£æŸä¸€æ¬¾ç¡¬ä»¶è®¾å¤‡æ€§æ„ä¹‰ä¸å¤§ï¼Œè€Œæ ‡å‡†ç»Ÿä¸€ä¹‹åï¼Œåªè¦ç ´è§£è¿™ä¸ªå¹³å°å°±æå®šäº†ä¸€åˆ‡ã€‚çœŸå¿ƒå¸Œæœ›Googleå¯ä»¥åšåˆ°è®©äººæ»¡æ„çš„å®‰å…¨æ€§ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://developer.android.com/things/hardware/index.html" target="_blank" rel="external">Android Things</a><br><a href="https://github.com/androidthings" target="_blank" rel="external">Android Things Sample</a><br><a href="http://www.jianshu.com/nb/3704305" target="_blank" rel="external">ttdevsçš„æ ‘è“æ´¾ä¸“é¢˜</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/01/06/AndroidThings-0/">http://w4lle.com/2017/01/06/AndroidThings-0/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;Android Thingsæ˜¯Googleæ¨å‡ºçš„å…¨æ–°ç‰©è”ç½‘æ“ä½œç³»ç»Ÿ&lt;br&gt;
    
    </summary>
    
    
      <category term="Android Things" scheme="http://w4lle.com/tags/Android-Things/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€é”®æ¥å…¥Tinker</title>
    <link href="http://w4lle.com/2017/01/05/one-key-for-tinker/"/>
    <id>http://w4lle.com/2017/01/05/one-key-for-tinker/</id>
    <published>2017-01-05T06:15:49.000Z</published>
    <updated>2018-02-05T01:32:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Tinkerå¼€æºæŒºé•¿æ—¶é—´äº†ï¼Œä½¿ç”¨çš„å¼€å‘è€…ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå¯¹äºä¸€äº›å°ç™½å¼€å‘è€…æ¥è¯´å¯¹æ¥Tinkerçš„æˆæœ¬è¿˜æ˜¯æŒºé«˜çš„ï¼Œå…¶ä¸­ä¸»è¦å› ç´ è¿˜æ˜¯ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆApplicationè¦ä¿®æ”¹æˆApplicationLikeï¼Œä»¥åŠæ”¹é€ åå¯¹é¡¹ç›®ä¸­ä½¿ç”¨Applicationçš„åœ°æ–¹ä¹Ÿè¦åŒæ­¥ä¿®æ”¹ã€‚</p>
<p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="http://w4lle.github.io/2016/12/16/tinker/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æ</a>ä¸­æˆ‘ä»¬å·²ç»è®²è§£äº†è¿™æ ·åšçš„ç›®çš„ä»¥åŠTinkerçš„åŠ è½½è¡¥ä¸çš„æµç¨‹ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦è®²ä¸€ä¸‹ä¸€é”®æ¥å…¥Tinkerçš„å®ç°æ€è·¯ã€‚</p>
<h1 id="InstantRun"><a href="#InstantRun" class="headerlink" title="InstantRun"></a>InstantRun</h1><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯è¦å®ç°ä¸ä¿®æ”¹Applicationè¾¾åˆ°æ›¿æ¢Applicationçš„æ•ˆæœï¼Œåœ¨è¿™ç¯‡æ–‡ç« <a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a>ä¸­ï¼Œè¯¦ç»†è®²è¿°äº†å¦‚ä½•åŠ¨æ€æ›¿æ¢Applicationï¼Œæ€»ç»“èµ·æ¥å°±ä¸¤æ­¥ï¼š</p>
<ol>
<li>æ‰“åŒ…æ—¶æ›¿æ¢Applicationæ ‡ç­¾ï¼Œæ’å…¥BootstrapApplication</li>
<li>è¿è¡Œæ—¶hookç³»ç»Ÿapiï¼Œå°†BootstrapApplicationæ¢å›MyApplication</li>
</ol>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ç”¨è¿™å¥—æ–¹æ¡ˆæ¥å®ç°Tinkerçš„ä¸€é”®æ¥å…¥ï¼ŒåŠ¨æ€æ›¿æ¢Applicationã€‚</p>
<h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><p>æœ‰äº†æ€è·¯æˆ‘ä»¬å°±å¯ä»¥æ•²ä»£ç äº†ã€‚</p>
<h2 id="æ‰“åŒ…"><a href="#æ‰“åŒ…" class="headerlink" title="æ‰“åŒ…"></a>æ‰“åŒ…</h2><p>æ‰“åŒ…æ—¶æˆ‘ä»¬è¦æ”¹å˜Manifestä¸­Applicationçš„æ ‡ç­¾å€¼ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰Gradleæ’ä»¶æ¥å®ç°ï¼Œå…³é”®ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@TaskAction</span></div><div class="line">    <span class="function">def <span class="title">updateManifest</span><span class="params">()</span> </span>&#123;</div><div class="line">        def ns = <span class="keyword">new</span> Namespace(<span class="string">"http://schemas.android.com/apk/res/android"</span>, <span class="string">"android"</span>)</div><div class="line">        def xml = <span class="keyword">new</span> XmlParser().parse(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(manifestPath), <span class="string">"utf-8"</span>))</div><div class="line"></div><div class="line">        def application = xml.application[<span class="number">0</span>]</div><div class="line">        <span class="keyword">if</span> (application) &#123;</div><div class="line">            def metaDataTags = application[<span class="string">'meta-data'</span>]</div><div class="line"></div><div class="line">            String rawApplicationName = application.attributes()[ns.name]</div><div class="line">            metaDataTags.findAll &#123;</div><div class="line">                it.attributes()[ns.name].equals(TINKER_APPLICATION)</div><div class="line">            &#125;.each &#123;</div><div class="line">                it.parent().remove(it)</div><div class="line">            &#125;</div><div class="line">            application.appendNode(<span class="string">'meta-data'</span>, [(ns.name): TINKER_APPLICATION, (ns.value): rawApplicationName])</div><div class="line">            application.attributes()[ns.name] = TINKER_APPLICATION_VALUE</div><div class="line"></div><div class="line">            def printer = <span class="keyword">new</span> XmlNodePrinter(<span class="keyword">new</span> PrintWriter(manifestPath, <span class="string">"utf-8"</span>))</div><div class="line">            printer.preserveWhitespace = <span class="keyword">true</span></div><div class="line">            printer.print(xml)</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ‰“åŒ…å‡ºçš„apkä¸­çš„AndroidManifest.xmlæ–‡ä»¶åŸºæœ¬æ˜¯è¿™æ ·çš„</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;application android:name="com.w4lle.onekeytinker.BootstrapApplication"&gt;</div><div class="line">    ...</div><div class="line">    &lt;meta-data android:name="ONEKEY_TINKER_APPLICATION" android:value="com.w4lle.onekeytinker.App"/&gt;</div><div class="line">  &lt;/application&gt;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„Appæ˜¯é¡¹ç›®ä¸­åŸæœ‰çš„Applicationï¼ŒBootstrapApplicationæ˜¯åæœŸæˆ‘ä»¬æ’å…¥çš„Applicationã€‚è‡ªå®šä¹‰Gradleæ’ä»¶æ—¶å¯ä»¥å°è£…ä¸€ä¸ªExtensioné…ç½®å‚æ•°ï¼ŒæŠŠTinkerçš„ç›¸å…³é…ç½®å°è£…èµ·æ¥ï¼Œä¸€äº›ä¸å˜çš„é»˜è®¤é…ç½®é¡¹éƒ½å¯ä»¥å†™åˆ°é‡Œé¢ï¼Œè¿™æ ·é¡¹ç›®çš„gradleé…ç½®å¯ä»¥æ›´ç®€æ´ã€‚å¦å¤–è¯´ä¸€å¥ï¼Œè¿™ä¸ªGradleæ’ä»¶çš„é¡ºåºåº”è¯¥æ˜¯æ‰“åŒ…å·¥å…·ç”ŸæˆManifestä¹‹åï¼ŒTinkerç›¸å…³Taskä¹‹å‰ã€‚</p>
<h2 id="è¿è¡Œæ—¶æ›¿æ¢Application"><a href="#è¿è¡Œæ—¶æ›¿æ¢Application" class="headerlink" title="è¿è¡Œæ—¶æ›¿æ¢Application"></a>è¿è¡Œæ—¶æ›¿æ¢Application</h2><p>è¿™ä¸€æ­¥çš„ä¸»è¦å·¥ä½œä¹Ÿæ˜¯åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€å°±æ˜¯è§£æManifestæ–‡ä»¶ï¼Œæ‹¿åˆ°realApplication(App)å’ŒBootstrapApplicationï¼›ç„¶åhook ç³»ç»Ÿå®Œæˆæ›¿æ¢ã€‚</p>
<p>InstantRunä¸­çš„æ›¿æ¢å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">monkeyPatchApplication</span><span class="params">(@Nullable Context context,</span></span></div><div class="line">                                              @Nullable Application bootstrap,</div><div class="line">                                              @Nullable Application realApplication) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Find the ActivityThread instance for the current thread</span></div><div class="line">            Class&lt;?&gt; activityThread = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line">            Object currentActivityThread = getActivityThread(context, activityThread);</div><div class="line"></div><div class="line">            <span class="comment">// Find the mInitialApplication field of the ActivityThread to the real application</span></div><div class="line">            Field mInitialApplication = activityThread.getDeclaredField(<span class="string">"mInitialApplication"</span>);</div><div class="line">            mInitialApplication.setAccessible(<span class="keyword">true</span>);</div><div class="line">            Application initialApplication = (Application) mInitialApplication.get(currentActivityThread);</div><div class="line">            <span class="keyword">if</span> (realApplication != <span class="keyword">null</span> &amp;&amp; initialApplication == bootstrap) &#123;</div><div class="line">            <span class="comment">//**2.æ›¿æ¢æ‰ActivityThread.mInitialApplication**</span></div><div class="line">                mInitialApplication.set(currentActivityThread, realApplication);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Replace all instance of the stub application in ActivityThread#mAllApplications with the</span></div><div class="line">            <span class="comment">// real one</span></div><div class="line">            <span class="keyword">if</span> (realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">                Field mAllApplications = activityThread.getDeclaredField(<span class="string">"mAllApplications"</span>);</div><div class="line">                mAllApplications.setAccessible(<span class="keyword">true</span>);</div><div class="line">                List&lt;Application&gt; allApplications = (List&lt;Application&gt;) mAllApplications</div><div class="line">                        .get(currentActivityThread);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; allApplications.size(); i++) &#123;</div><div class="line">                    <span class="keyword">if</span> (allApplications.get(i) == bootstrap) &#123;</div><div class="line">                    <span class="comment">//**1.æ›¿æ¢æ‰ActivityThread.mAllApplications**</span></div><div class="line">                        allApplications.set(i, realApplication);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Figure out how loaded APKs are stored.</span></div><div class="line"></div><div class="line">            <span class="comment">// API version 8 has PackageInfo, 10 has LoadedApk. 9, I don't know.</span></div><div class="line">            Class&lt;?&gt; loadedApkClass;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                loadedApkClass = Class.forName(<span class="string">"android.app.LoadedApk"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                loadedApkClass = Class.forName(<span class="string">"android.app.ActivityThread$PackageInfo"</span>);</div><div class="line">            &#125;</div><div class="line">            Field mApplication = loadedApkClass.getDeclaredField(<span class="string">"mApplication"</span>);</div><div class="line">            mApplication.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">            <span class="comment">// 10 doesn't have this field, 14 does. Fortunately, there are not many Honeycomb devices</span></div><div class="line">            <span class="comment">// floating around.</span></div><div class="line">            Field mLoadedApk = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mLoadedApk = Application.class.getDeclaredField(<span class="string">"mLoadedApk"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</div><div class="line">                <span class="comment">// According to testing, it's okay to ignore this.</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Enumerate all LoadedApk (or PackageInfo) fields in ActivityThread#mPackages and</span></div><div class="line">            <span class="comment">// ActivityThread#mResourcePackages and do two things:</span></div><div class="line">            <span class="comment">//   - Replace the Application instance in its mApplication field with the real one</span></div><div class="line">            <span class="comment">//   - Set Application#mLoadedApk to the found LoadedApk instance</span></div><div class="line">            <span class="keyword">for</span> (String fieldName : <span class="keyword">new</span> String[]&#123;<span class="string">"mPackages"</span>, <span class="string">"mResourcePackages"</span>&#125;) &#123;</div><div class="line">                Field field = activityThread.getDeclaredField(fieldName);</div><div class="line">                field.setAccessible(<span class="keyword">true</span>);</div><div class="line">                Object value = field.get(currentActivityThread);</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, WeakReference&lt;?&gt;&gt; entry :</div><div class="line">                        ((Map&lt;String, WeakReference&lt;?&gt;&gt;) value).entrySet()) &#123;</div><div class="line">                    Object loadedApk = entry.getValue().get();</div><div class="line">                    <span class="keyword">if</span> (loadedApk == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (mApplication.get(loadedApk) == bootstrap) &#123;</div><div class="line">                        <span class="keyword">if</span> (realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">//**3.æ›¿æ¢æ‰mApplication**</span></div><div class="line">                            mApplication.set(loadedApk, realApplication);</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (realApplication != <span class="keyword">null</span> &amp;&amp; mLoadedApk != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">//**4.æ›¿æ¢æ‰mLoadedApk**</span></div><div class="line">                            mLoadedApk.set(realApplication, loadedApk);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>æ›¿æ¢Application<ul>
<li>baseContext.mPackageInfo.mApplication ä»£ç 3å¤„</li>
<li>baseContext.mPackageInfo.mActivityThread.mInitialApplication ä»£ç 2å¤„</li>
<li>baseContext.mPackageInfo.mActivityThread.mAllApplications ä»£ç 1å¤„</li>
</ul>
</li>
<li>æ›¿æ¢mLoadedApkå¯¹è±¡ï¼Œä»£ç 4å¤„</li>
</ol>
<p>è¯¦ç»†è¯·æŸ¥çœ‹<a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a></p>
<p>åšå®Œä¸Šé¢è¿™ä¸¤æ­¥è¿™æ ·å°±å¯ä»¥å®ç°ä¸€é”®æ¥å…¥äº†ã€‚</p>
<h1 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h1><p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°ï¼Œç”±äºè¯¥æ–¹æ¡ˆå¤§é‡hookç³»ç»Ÿapiï¼Œåœ¨å›½å†…Androidç¢ç‰‡åŒ–å¦‚æ­¤ä¸¥é‡çš„å¸‚åœºç¯å¢ƒä¸‹ï¼Œè¯¥æ–¹æ¡ˆå…¼å®¹æ€§æœ‰ä¸€äº›é—®é¢˜ï¼Œå¤§æ¦‚æœ‰ 1/1wçš„æ¦‚ç‡ä¼šå‡ºç°æ›¿æ¢å¤±è´¥çš„é—®é¢˜ï¼Œå¦‚æœæ›¿æ¢å¤±è´¥ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿä¸­è¿è¡Œçš„Applicationè¿˜æ˜¯BootstrapApplicationï¼Œè€Œæˆ‘ä»¬Appä¸­çš„Applicationå·²ç»æ²¡æœ‰äº†Applicationçš„ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦åœ¨å¤±è´¥catchä¸­è°ƒç”¨ä¸‹Applicationçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥ä¿è¯ç¨‹åºèƒ½å¤Ÿæ­£å¸¸åˆå§‹åŒ–å¯åŠ¨èµ·æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  ...</div><div class="line">&#125; <span class="keyword">catch</span> &#123;</div><div class="line">  e = <span class="keyword">true</span>;</div><div class="line">  realApplication.onCreate();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration paramConfiguration)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onConfigurationChanged(paramConfiguration);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onConfigurationChanged(paramConfiguration);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onLowMemory();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onLowMemory();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@TargetApi</span>(<span class="number">14</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> paramInt)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onTrimMemory(paramInt);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onTrimMemory(paramInt);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTerminate</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onTerminate();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onTerminate();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¹ˆåšè™½ç„¶èƒ½ä¿è¯Appèƒ½å¯åŠ¨ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜ä¼šæœ‰éšæ€§é—®é¢˜å­˜åœ¨ã€‚æ¯”å¦‚Appä¸­æœ‰å¦‚ä¸‹ä»£ç <code>((App) getApplication()).xxx();</code>ï¼Œé‚£ä¹ˆåœ¨æ›¿æ¢å¤±è´¥çš„æƒ…å†µä¸‹å¯èƒ½å°±ä¼šå´©äº†ï¼Œ å› ä¸º<code>getApplication()</code>å¾—åˆ°çš„æ˜¯BootstrapApplicationï¼Œå¼ºè½¬ä¸º<code>App</code>ç±»å‹è‚¯å®šå°±æŒ‚äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ•´ä½“æ€è·¯å¤§æ¦‚è®²æ¸…æ¥šäº†ï¼Œè™½ç„¶è¿™ç§æ–¹æ¡ˆæ¥å…¥æˆæœ¬ä½ï¼Œä½†æ˜¯å…¼å®¹æ€§é—®é¢˜æ˜¯ä¸ªå¾ˆéº»çƒ¦çš„äº‹æƒ…ï¼Œè¯´ä¸å®šå•¥æ—¶å€™å°±å´©äº†ã€‚æ¨èå¤§å®¶è¿˜æ˜¯ä½¿ç”¨Tinkerè‡ªæœ‰çš„æ¥å…¥æ–¹æ¡ˆã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a><br><a href="http://www.tinkerpatch.com/" target="_blank" rel="external">TinkerPatch</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/01/05/one-key-for-tinker/">http://w4lle.com/2017/01/05/one-key-for-tinker/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;Tinkerå¼€æºæŒºé•¿æ—¶é—´äº†ï¼Œä½¿ç”¨çš„å¼€å‘è€…ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå¯¹äºä¸€äº›å°ç™½å¼€å‘è€…æ¥è¯´å¯¹æ¥Tinkerçš„æˆæœ¬è¿˜æ˜¯æŒºé«˜çš„ï¼Œå…¶ä¸­ä¸»è¦å› ç´ è¿˜æ˜¯ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆA
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
</feed>
