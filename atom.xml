<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>w4lle&#39;s Notes</title>
  <subtitle>Eeeee... va?</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://w4lle.com/"/>
  <updated>2018-06-20T13:12:53.000Z</updated>
  <id>http://w4lle.com/</id>
  
  <author>
    <name>w4lle</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</title>
    <link href="http://w4lle.com/2018/06/20/robust-2/"/>
    <id>http://w4lle.com/2018/06/20/robust-2/</id>
    <published>2018-06-20T08:18:16.000Z</published>
    <updated>2018-06-20T13:12:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œåˆ†æäº† Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>è¡¥ä¸åŠ è½½è¿‡ç¨‹</li>
<li>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹</li>
<li>è¡¥ä¸åŒ…è‡ªåŠ¨åŒ–ç”Ÿæˆè¿‡ç¨‹</li>
</ul>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°çš„å‘ä»¥åŠåˆ†æé—®é¢˜çš„æ€è·¯å’Œæœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆã€‚åŒ…å«ï¼š</p>
<ul>
<li>æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ</li>
<li>Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ</li>
<li>æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ</li>
<li>ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ</li>
<li>static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ</li>
</ul>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« :</p>
<ul>
<li><a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
<li><a href="http://w4lle.com/2018/05/28/robust-1/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</a></li>
<li><a href="http://w4lle.com/2018/05/29/robust-2/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</a></li>
</ul>
<h1 id="æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ"><a href="#æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ" class="headerlink" title="æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ"></a>æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ</h1><p>åœ¨æ‰“è¡¥ä¸åŒ…è¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°äº†ä¸€ä¸ªé”™è¯¯ <code>execute command java -jar /Users/wanglinglong/Develop/u51/Credit51/CreditCardManager/robust/dx.jar --dex --output=classes.dex  meituan.jar error</code>ï¼Œæ‰¾äº†ä¸€å¤§åœˆæœ€åå‘ç°æ˜¯jdkè€ç‰ˆæœ¬åœ¨Macä¸Šçš„ä¸€ä¸ªbugï¼Œå‡çº§jdkå°±å¥½äº†ï¼Œå‚è€ƒ <a href="https://stackoverflow.com/questions/43003012/class-javalaunchhelper-is-implemented-in-two-places?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa" target="_blank" rel="external">Class JavaLaunchHelper is implemented in two places</a></p>
<h1 id="Robust-å®šä¹‰çš„-API-ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ"><a href="#Robust-å®šä¹‰çš„-API-ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ"></a>Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ</h1><p>Robust æä¾›äº†ä¸€äº› API å¯ä¾›å¼€å‘è€…æ‰©å±•ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š<br>æ·»åŠ ç±»åº“ä¾èµ– <code>compile &#39;com.meituan.robust:robust:0.4.82&#39;</code>ï¼Œå…¶ä¸­ <code>PatchManipulateImp</code> ç±»çš„ä¸€äº›å¯æ‰©å±•æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Patch&gt; <span class="title">fetchPatchList</span><span class="params">(Context context)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">verifyPatch</span><span class="params">(Context context, Patch patch)</span></span>;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">ensurePatchExist</span><span class="params">(Patch patch)</span></span>;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œè¿™äº›å¯æ‰©å±•æ–¹æ³•å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>ä¸ºäº†æ»¡è¶³å®šåˆ¶åŒ–éœ€æ±‚ï¼Œå¯ä»¥å¼ƒç”¨ <code>com.meituan.robust:robust</code>ï¼Œè‡ªå·±å®ç°ä¸€å¥—è¡¥ä¸åŠ è½½é€»è¾‘ï¼Œè¿™ä¸ªå®ç°èµ·æ¥éš¾åº¦å¹¶ä¸å¤ªå¤§ï¼Œä¸»è¦è¡¥ä¸åŠ è½½æµç¨‹éƒ½å¯ä»¥å‚è€ƒ Robust å®˜æ–¹å®ç°ï¼Œå…·ä½“åŠ è½½é€»è¾‘å¯å‚è€ƒæœ¬ç³»åˆ—ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œè¿™é‡Œä¸å†æ·±å…¥ã€‚</p>
<h1 id="æ’ä»¶-Plugin-Transform-çš„é¡ºåºé—®é¢˜ï¼Ÿ"><a href="#æ’ä»¶-Plugin-Transform-çš„é¡ºåºé—®é¢˜ï¼Ÿ" class="headerlink" title="æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ"></a>æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ</h1><p>é¦–å…ˆï¼Œè¦æ‰¾åˆ° Gradle Plugin ç¼–è¯‘è¿‡ç¨‹ä¸­å¯¹äºè‡ªå®šä¹‰ Transform çš„å¤„ç†ï¼Œå…·ä½“æµç¨‹è¯»è€…å¯ä»¥è‡ªè¡Œæœç´¢æŸ¥çœ‹ï¼Œè¿™é‡Œåªç»™å‡ºå…³é”®ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">TaskManager.java</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Creates the post-compilation tasks for the given Variant.</div><div class="line"> *</div><div class="line"> * These tasks create the dex file from the .class files, plus optional intermediary steps like</div><div class="line"> * proguard and jacoco</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createPostCompilationTasks</span><span class="params">(</span></span></div><div class="line">        @NonNull <span class="keyword">final</span> VariantScope variantScope) &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// ---- Code Coverage first -----</span></div><div class="line">    ...</div><div class="line">    <span class="comment">// Merge Java Resources.</span></div><div class="line">    createMergeJavaResTransform(variantScope);</div><div class="line">    <span class="comment">// ----- External Transforms -----</span></div><div class="line">    <span class="comment">// apply all the external transforms.</span></div><div class="line">    List&lt;Transform&gt; customTransforms = extension.getTransforms();</div><div class="line">    List&lt;List&lt;Object&gt;&gt; customTransformsDependencies = extension.getTransformsDependencies();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = customTransforms.size(); i &lt; count; i++) &#123;</div><div class="line">        Transform transform = customTransforms.get(i);</div><div class="line">        List&lt;Object&gt; deps = customTransformsDependencies.get(i);</div><div class="line">        transformManager</div><div class="line">                .addTransform(taskFactory, variantScope, transform)</div><div class="line">                .ifPresent(</div><div class="line">                        t -&gt; &#123;</div><div class="line">                            <span class="keyword">if</span> (!deps.isEmpty()) &#123;</div><div class="line">                                t.dependsOn(deps);</div><div class="line">                            &#125;</div><div class="line">                            <span class="comment">// if the task is a no-op then we make assemble task depend on it.</span></div><div class="line">                            <span class="keyword">if</span> (transform.getScopes().isEmpty()) &#123;</div><div class="line">                                variantScope.getAssembleTask().dependsOn(t);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ç”Ÿæˆ Dex ä»»åŠ¡ä¹‹å‰ï¼Œä¼šå¤„ç†æ‰€æœ‰çš„è‡ªå®šä¹‰ Transform ä»»åŠ¡ï¼Œé€»è¾‘æ˜¯æŒ‰ç…§é¡ºåºéå†ç„¶åå¤„ç†ä»»åŠ¡ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆä»dzheâ€™lè¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒTransform çš„æ‰§è¡Œé¡ºåºæ˜¯æŒ‰ç…§æ’ä»¶çš„å£°æ˜é¡ºåºæ¥æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå“ªä¸ª plugin çš„å£°æ˜åœ¨å‰ï¼Œå…¶å¯¹åº”çš„ Transform å°±åœ¨å‰æ‰§è¡Œï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'pluginA'</span></div><div class="line">apply plugin: <span class="string">'pluginB'</span></div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¯¹åº”çš„ TransformA ä»»åŠ¡å°±ä¼šå…ˆäº TransfromB ä»»åŠ¡æ‰§è¡Œã€‚</p>
<p>å¥½äº†ï¼ŒçŸ¥é“äº† Transform çš„æ‰§è¡Œé¡ºåºé—®é¢˜ï¼Œå†æ¥çœ‹ä¸‹ Robust æ’ä»¶çš„é¡ºåºé—®é¢˜ã€‚é¦–å…ˆæ¥çœ‹ä¸‹åŸºçº¿åŒ…çš„å¤„ç†æ’ä»¶ <code>apply plugin: &#39;robust&#39;</code>ï¼Œå…¶é€»è¾‘æ˜¯åœ¨æ¯ä¸ªæ–¹æ³•ä¸­å‰ç½®æ’å…¥è¡¥ä¸åŠ è½½é€»è¾‘ä»£ç ï¼Œç”¨äºæ‹¦æˆªåŸºçº¿åŒ…ä¸­çš„åŸæœ‰é€»è¾‘ï¼Œè¾¾åˆ°ä¿®å¤æ–¹æ³•çš„ç›®çš„ã€‚<br>å¦‚æœ robust Plugin æ˜¯å…ˆäºå…¶ä»–æ’ä»¶æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆä¼šå‡ºç° Robust æ’å…¥ä»£ç åï¼Œå†æ‰§è¡Œå…¶ä»–æ’ä»¶çš„ä»£ç é€»è¾‘ï¼Œè¿™æ ·ä¼šæœ‰é—®é¢˜å—ï¼Ÿå…¶å®è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰é—®é¢˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº†å¬äº‘ï¼Œè€Œä¸”æ˜¯è¾ƒè€çš„ç‰ˆæœ¬(2.5.9)ï¼Œå…¶æ’ä»¶å†…éƒ¨æ’å…¥ä»£ç æ²¡æœ‰ç”¨åˆ° Transformï¼Œè€Œæ˜¯ç”¨äº†å¦å¤–ä¸€ç§æŠ€æœ¯ï¼Œå…¶ä¼šå¯¼è‡´ä¸ç®¡åœ¨å“ªé‡Œå£°æ˜æ’ä»¶ï¼Œå…¶å¤„ç†é¡ºåºéƒ½æ˜¯æœ€åæ‰§è¡Œï¼Œé‚£ä¹ˆå¯¹äº Robust åŸºçº¿åŒ…æ’ä»¶æ¥è¯´ï¼Œå½“åŸºçº¿åŒ…æ’ä»¶æ’å…¥å®Œä»£ç åï¼Œåˆä¼šå»æ‰§è¡Œå¬äº‘æ’ä»¶çš„æ’å…¥ä»£ç é€»è¾‘ï¼Œæ‰€ä»¥å¯èƒ½ä¼šçœ‹åˆ°ä»¥ä¸‹è¿™ç§ä»£ç ï¼š</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/robust_tingyun.png" alt=""></p>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/robust_tingyun_right.png" alt=""></p>
<p>ç„¶è€Œï¼Œå¦‚æœä»”ç»†è§‚å¯Ÿè¿™ç§é”™è¯¯çš„ä»£ç æ’å…¥é€»è¾‘ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰å¯¹æœ€ç»ˆçš„çƒ­ä¿®å¤é€»è¾‘äº§ç”Ÿå½±å“ã€‚æ˜¯å› ä¸ºåœ¨ç”Ÿæˆè¡¥ä¸åŒ…è¿‡ç¨‹ä¸­ï¼Œä»–ä»¬çš„æ‰§è¡Œé¡ºåºä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œå³å¬äº‘æ’ä»¶æœ€åæ‰§è¡Œï¼Œè¿™æ ·çš„ç»“æœå°±æ˜¯Robust è‡ªåŠ¨åŒ–è¡¥ä¸æ’ä»¶åœ¨ç”Ÿæˆæ’ä»¶åå°±å¼ºåˆ¶åœæ­¢äº†æ•´ä¸ªç¼–è¯‘æµç¨‹ï¼Œå¬äº‘æ’ä»¶æ ¹æœ¬å°±æ²¡æœ‰æœºä¼šæ‰§è¡Œã€‚æ‰€ä»¥æœ€åè¡¥ä¸åŒ…ä¸­ä»…ä»…ä¼šåŒ…å«å‰”é™¤äº†Robust åŸºçº¿åŒ…æ’ä»¶æ’å…¥çš„ä»£ç ä»¥åŠå¬äº‘æ’ä»¶æ’å…¥çš„ä»£ç ã€‚å¯ä»¥ç†è§£ä¸ºç¬¬ä¸€å¼ å›¾ä¸­æŠŠçº¢æ¡†ä¸‹é¢çš„ä»£ç é€šè¿‡çƒ­ä¿®å¤çš„æ–¹å¼ç§»å…¥äº†çº¢æ¡†é‡Œé¢ï¼Œç„¶åreturnã€‚</p>
<p>å¯¹äºå¬äº‘æ¥è¯´ï¼Œ2.8.xç‰ˆæœ¬ä¹‹åï¼Œæ’å…¥ä»£ç çš„é€»è¾‘ä¹Ÿç”± Tranform æ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå¬äº‘æ¥è¯´ï¼Œä¸ç®¡æ˜¯æ€ä¹ˆæ ·çš„æ‰§è¡Œé¡ºåºï¼Œéƒ½ä¸ä¼šä¸ Robust å‘ç”Ÿå…¼å®¹æ€§é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥è¿˜æ˜¯è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œè¿™é‡Œä»…ä»…æä¾›ä¸€äº›æ’æŸ¥é—®é¢˜çš„æ€è·¯ã€‚</p>
<h1 id="ä¸-Aspectj-å†²çªæ€ä¹ˆåŠï¼Ÿ"><a href="#ä¸-Aspectj-å†²çªæ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ"></a>ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ</h1><p>æˆ‘ä»¬é¡¹ç›®ä¸­å¤§é‡ä½¿ç”¨äº† AOP æŠ€æœ¯ï¼Œæ¶‰åŠåˆ°çš„æ¡†æ¶æœ‰ Aspectjã€javassistã€ASMã€‚å…¶ä¸­ç”±äº  javassist å’Œ ASM å®Œå…¨æ˜¯æœ‰è‡ªå·±æ§åˆ¶çš„ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜ï¼Œè€Œå¯¹äº Aspectj æ¥è¯´å°±æ²¡è¿™ä¹ˆç®€å•äº†ã€‚</p>
<p>åˆšå¼€å§‹ä»‹å…¥å°±ç¢°åˆ°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ <code>Caused by: java.lang.ClassCastException: com.meituan.robust.patch.MainFragmentActivityPatch cannot be cast to com.zhangdan.app.activities.MainFragmentActivity</code>ï¼Œæ˜¯ä¸€ä¸ªç±»å‹å¼ºè½¬é”™è¯¯ã€‚</p>
<p>é—®é¢˜åˆ†æï¼Œç”±äº Aspectj æ¡†æ¶ä¸ºå¼€å‘è€…çœç•¥äº†å¾ˆå¤šé€»è¾‘ï¼Œå¼€å‘è€…åªéœ€è¦ç¼–å†™åˆ‡é¢ç›¸å…³ä»£ç å³å¯ï¼Œæ‰€ä»¥éœ€è¦æ¢³ç†æ¸…æ¥š Aspectj çš„åŸç†ï¼š</p>
<p>é¦–å…ˆè´´ä¸‹æœªæ··æ·†çš„ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity.class</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody2</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">        onCreate_aroundBody1$advice(mainFragmentActivity, bundle, joinPoint, MainFragmentActivity$$Injector.aspectOf(), (ProceedingJoinPoint) joinPoint);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> onCreate_aroundBody1$advice(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint, MainFragmentActivity$$Injector mainFragmentActivity$$Injector, ProceedingJoinPoint proceedingJoinPoint) &#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint, mainFragmentActivity$$Injector, proceedingJoinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11888</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class, MainFragmentActivity$$Injector.class, ProceedingJoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            MainFragmentActivity mainFragmentActivity2 = (MainFragmentActivity) proceedingJoinPoint.getTarget();</div><div class="line">            onCreate_aroundBody0(mainFragmentActivity, bundle, proceedingJoinPoint);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;bundle&#125;, <span class="keyword">this</span>, changeQuickRedirect, <span class="keyword">false</span>, <span class="number">11849</span>, <span class="keyword">new</span> Class[]&#123;Bundle.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            JoinPoint makeJP = Factory.makeJP(ajc$tjp_0, <span class="keyword">this</span>, <span class="keyword">this</span>, bundle);</div><div class="line">            MainFragmentActivity$$Injector.aspectOf().onCreate(<span class="keyword">new</span> AjcClosure3(<span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, bundle, makeJP&#125;).linkClosureAndJoinPoint(<span class="number">69648</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11887</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">            JudgeEmulatorUtil.uploadEmulatorInfoIfNeed(mainFragmentActivity);</div><div class="line">            instance = mainFragmentActivity;</div><div class="line">            mainFragmentActivity.setContentView(R.layout.main_activity);</div><div class="line">            ButterKnife.bind((Activity) mainFragmentActivity);</div><div class="line">            mainFragmentActivity.initUserCenterManager();</div><div class="line">            mainFragmentActivity.mainPagerAdapter = <span class="keyword">new</span> MainPagerAdapter(mainFragmentActivity, mainFragmentActivity.getSupportFragmentManager());</div><div class="line">            mainFragmentActivity.userInfoPresenter = <span class="keyword">new</span> UserInfoPresenter();</div><div class="line">            mainFragmentActivity.refreshOldDataPresenter = <span class="keyword">new</span> RefreshOldDataPresenter();</div><div class="line">            mainFragmentActivity.tabRedPointPresenter = <span class="keyword">new</span> TabRedPointPresenter(mainFragmentActivity);</div><div class="line">            mainFragmentActivity.getMsgCenterRedPresenter = <span class="keyword">new</span> GetMsgCenterRedPresenter(mainFragmentActivity);</div><div class="line">            mainFragmentActivity.userInfoPresenter.setUserInfoView(mainFragmentActivity);</div><div class="line">            mainFragmentActivity.userInfoPresenter.startGetCurUserInfoDBUseCase();</div><div class="line">            INSTANCE_FLAG = <span class="number">1</span>;</div><div class="line">            BaiduLocation.getInstance(ZhangdanApplication.getInstance()).start();</div><div class="line">            mainFragmentActivity.initToolBar();</div><div class="line">            mainFragmentActivity.showImportBillDialog();</div><div class="line">            mainFragmentActivity.onLoginCreate(bundle);</div><div class="line">            mainFragmentActivity.getLoggerABConfig();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å¯¹åº”çš„patch æ–‡ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivityPatch</span> </span>&#123;</div><div class="line">    MainFragmentActivity originClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainFragmentActivityPatch</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.originClass = (MainFragmentActivity) obj;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        StaticPart staticPart = (StaticPart) EnhancedRobustUtils.getStaticFieldValue(<span class="string">"ajc$tjp_0"</span>, MainFragmentActivity.class);</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"get static  value is ajc$tjp_0     No:  1"</span>);</div><div class="line">        JoinPoint joinPoint = (JoinPoint) EnhancedRobustUtils.invokeReflectStaticMethod(<span class="string">"makeJP"</span>, Factory.class, getRealParameter(<span class="keyword">new</span> Object[]&#123;staticPart, <span class="keyword">this</span>, <span class="keyword">this</span>, savedInstanceState&#125;), <span class="keyword">new</span> Class[]&#123;StaticPart.class, Object.class, Object.class, Object.class&#125;);</div><div class="line">        Object obj = (Injector) EnhancedRobustUtils.invokeReflectStaticMethod(<span class="string">"aspectOf"</span>, Injector.class, getRealParameter(<span class="keyword">new</span> Object[<span class="number">0</span>]), <span class="keyword">null</span>);</div><div class="line">        Object[] objArr = <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, savedInstanceState, joinPoint&#125;;</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"  inner Class new      No:  2"</span>);</div><div class="line">        Object obj2 = (AjcClosure3) EnhancedRobustUtils.invokeReflectConstruct(<span class="string">"com.zhangdan.app.activities.MainFragmentActivity$AjcClosure3"</span>, getRealParameter(<span class="keyword">new</span> Object[]&#123;objArr&#125;), <span class="keyword">new</span> Class[]&#123;Object[].class&#125;);</div><div class="line">        <span class="keyword">if</span> (obj2 == <span class="keyword">this</span>) &#123;</div><div class="line">            obj2 = ((MainFragmentActivityPatch) obj2).originClass;</div><div class="line">        &#125;</div><div class="line">        ProceedingJoinPoint proceedingJoinPoint = (ProceedingJoinPoint) EnhancedRobustUtils.invokeReflectMethod(<span class="string">"linkClosureAndJoinPoint"</span>, obj2, getRealParameter(<span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> Integer(<span class="number">69648</span>)&#125;), <span class="keyword">new</span> Class[]&#123;Integer.TYPE&#125;, AroundClosure.class);</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"invoke  method is       No:  3 linkClosureAndJoinPoint"</span>);</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</div><div class="line">            obj = ((MainFragmentActivityPatch) obj).originClass;</div><div class="line">        &#125;</div><div class="line">        EnhancedRobustUtils.invokeReflectMethod(<span class="string">"onCreate"</span>, obj, getRealParameter(<span class="keyword">new</span> Object[]&#123;proceedingJoinPoint&#125;), <span class="keyword">new</span> Class[]&#123;ProceedingJoinPoint.class&#125;, Injector.class);</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="string">"invoke  method is       No:  4 onCreate"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¾€ä¸‹è·Ÿä¸‹ Aspectj çš„è°ƒç”¨æµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">AjcClosure ç±»</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AroundClosure</span> </span>&#123;</div><div class="line">   ...</div><div class="line">    <span class="keyword">protected</span> Object[] state;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AroundClosure</span><span class="params">(Object[] state)</span> </span>&#123;</div><div class="line">    	<span class="keyword">this</span>.state = state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Object[] getState() &#123;</div><div class="line">      <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * This takes in the same arguments as are passed to the proceed</div><div class="line">	 * call in the around advice (with primitives coerced to Object types)</div><div class="line">	 */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">run</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> ProceedingJoinPoint <span class="title">linkClosureAndJoinPoint</span><span class="params">(<span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        <span class="comment">//TODO is this cast safe ?</span></div><div class="line">        ProceedingJoinPoint jp = (ProceedingJoinPoint)state[state.length-<span class="number">1</span>];</div><div class="line">        jp.set$AroundClosure(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">this</span>.bitflags = flags;</div><div class="line">        <span class="keyword">return</span> jp;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AjcClosure æ¥æ”¶ä¸€ä¸ª Object çš„å¯¹è±¡æ•°ç»„ï¼Œåœ¨åŸºç¡€åŒ…ä¸­ï¼Œå®ƒçš„å®ç°æ˜¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, bundle, makeJP&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™ä¸ª <code>this</code>ï¼Œä»£è¡¨çš„æ˜¯MainFragmentActivity å¯¹è±¡ã€‚<br>ç›¸å¯¹åº”çš„çœ‹ä¸‹patchåŒ…ä¸­çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Object[] objArr = <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, savedInstanceState, joinPoint&#125;;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè°ƒç”¨äº†ä¸‹ <code>getRealParameter(new Object[]{objArr})</code> è¿›è¡Œäº† this è½¬æ¢ï¼Œæ‰€ä»¥è¿™é‡Œçš„this ä¹Ÿæ˜¯MainFragmentActivityå¯¹è±¡ï¼Œè¿™é‡Œæ˜¯æ²¡é—®é¢˜çš„ã€‚<br>ç„¶åè°ƒç”¨ <code>linkClosureAndJoinPoint</code> æ–¹æ³•å¾—åˆ° ProceedingJoinPoint å¯¹è±¡ï¼Œå½“åšå‚æ•°ä¼ é€’ç»™ MainFragmentActivity$$Injector.onCreate(ProceedingJoinPoint joinPoint)  æ–¹æ³•ï¼Œçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity$$Injector.class</div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivity</span>$$<span class="title">Injector</span> </span>&#123;</div><div class="line">  <span class="meta">@Around</span>(<span class="string">"execution(* com.zhangdan.app.activities.MainFragmentActivity.onCreate(..))"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    MainFragmentActivity target = (MainFragmentActivity)joinPoint.getTarget();</div><div class="line">    ...</div><div class="line">    joinPoint.proceed();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨äº† ProceedingJoinPoint.proceed æŠ½è±¡æ–¹æ³•ï¼Œå®ç°åœ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">   JoinPointImpl.<span class="function">java</span></div><div class="line"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</div><div class="line">	<span class="comment">// when called from a before advice, but be a no-op</span></div><div class="line">		<span class="keyword">return</span> arc.run(arc.getState());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>arc</code> æ˜¯ AroundClosureï¼Œ<code>arc.getState()</code> è¿”å›çš„æ˜¯æ„é€  AroundClosure æ—¶ä¼ é€’è¿‡æ¥çš„å¯¹è±¡æ•°ç»„ã€‚<br>æœ€åè°ƒç”¨äº†æŠ½è±¡æ–¹æ³• <code>run(Object[] args)</code>ï¼Œå®ç°åœ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivity</span>$<span class="title">AjcClosure3</span> <span class="keyword">extends</span> <span class="title">AroundClosure</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ChangeQuickRedirect changeQuickRedirect;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> MainFragmentActivity$AjcClosure3(Object[] objArr) &#123;</div><div class="line">        <span class="keyword">super</span>(objArr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">(Object[] objArr)</span> </span>&#123;</div><div class="line">        PatchProxyResult proxy = PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;objArr&#125;, <span class="keyword">this</span>, changeQuickRedirect, <span class="keyword">false</span>, <span class="number">11911</span>, <span class="keyword">new</span> Class[]&#123;Object[].class&#125;, Object.class);</div><div class="line">        <span class="keyword">if</span> (proxy.isSupported) &#123;</div><div class="line">            <span class="keyword">return</span> proxy.result;</div><div class="line">        &#125;</div><div class="line">        Object[] objArr2 = <span class="keyword">this</span>.state;</div><div class="line">        MainFragmentActivity.onCreate_aroundBody2((MainFragmentActivity) objArr2[<span class="number">0</span>], (Bundle) objArr2[<span class="number">1</span>], (JoinPoint) objArr2[<span class="number">2</span>]);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åè°ƒç”¨ <code>MainFragmentActivity.onCreate_aroundBody2((MainFragmentActivity) objArr2[0], (Bundle) objArr2[1], (JoinPoint) objArr2[2]);</code>ï¼Œæ•´ä¸ª AOP çš„æµç¨‹å°±èµ°é€šäº†ã€‚</p>
<p>æœ€åæ€»ç»“ä¸‹ Aspectj çš„è°ƒç”¨æµç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity.onCreate -&gt; </div><div class="line">MainFragmentActivity$$Injector.onCreate(ProceedingJoinPoint joinPoint) -&gt; </div><div class="line">ProceedingJoinPoint.proceed() -&gt; </div><div class="line">AroundClosure.run(Object[] args) -&gt;  </div><div class="line">MainFragmentActivity$AjcClosure3.run(Object[] objArr) -&gt; </div><div class="line">MainFragmentActivity.onCreate_aroundBody2((MainFragmentActivity) objArr2[<span class="number">0</span>], (Bundle) objArr2[<span class="number">1</span>], (JoinPoint) objArr2[<span class="number">2</span>]); -&gt; </div><div class="line">MainFragmentActivity.onCreate_aroundBody1$advice -&gt; </div><div class="line">MainFragmentActivity.onCreate_aroundBody0();</div></pre></td></tr></table></figure>
<p>æœ€åçš„ <code>MainFragmentActivity.onCreate_aroundBody0();</code>æ–¹æ³•å®é™…ä¸Šå°±æ˜¯onCreate()çš„åŸå§‹æ–¹æ³•é€»è¾‘ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äºä¿®æ”¹åçš„ä»£ç ï¼Œæ²¡æœ‰è¢«æ‰“å…¥è¡¥ä¸ï¼Œä¹Ÿæ˜¯å¯ä»¥è§£é‡Šçš„ã€‚<br>å¯¹äº auto-path-pluginï¼ŒTransform çš„é¡ºåºæ˜¯ Aspectj -&gt; auto-patch.<br>é‚£ä¹ˆï¼Œå¯¹äºæ ‡è®°ä¿®æ”¹çš„ onCreate æ–¹æ³•æ¥è¯´ï¼ŒAspectj å¤„ç†å®Œåï¼ŒonCreate æ–¹æ³•è¢«æ›¿æ¢æˆäº†ä»£ç†ï¼ŒçœŸæ­£çš„æ–¹æ³•å®ç°è¢«æ–°ç”Ÿæˆçš„æ–¹æ³•éšè—èµ·æ¥äº†ã€‚<br>è€Œæˆ‘ä»¬ä»…ä»…æ ‡è®°äº†æ—§çš„ onCreate æ–¹æ³•ï¼Œå…¶ç»“æœå°±æ˜¯ï¼ŒAspectj çš„ä»£ç† onCreate æ–¹æ³•è¢« patch äº†ï¼Œè€Œå®é™…çš„æ–¹æ³•è™½ç„¶æ–¹æ³•ä½“å†…æœ‰æˆ‘ä»¬çš„ä¿®å¤ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰æ ‡è®° <code>@modify</code> è€Œè¢«å¿½ç•¥ã€‚</p>
<p>å› ä¸ºæ˜¯å¼ºè½¬ crashï¼Œæ‰€ä»¥åœ¨ $$Injector ä»£ç ä¸­æ’å…¥ä¸€äº› Log</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity$$Injector.class</div><div class="line">    <span class="meta">@Around</span>(<span class="string">"execution(* com.zhangdan.app.activities.MainFragmentActivity.onCreate(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;proceedingJoinPoint&#125;, <span class="keyword">this</span>, changeQuickRedirect, <span class="keyword">false</span>, <span class="number">11892</span>, <span class="keyword">new</span> Class[]&#123;ProceedingJoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">            MainFragmentActivity target = (MainFragmentActivity) proceedingJoinPoint.getTarget();</div><div class="line">            ...</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"test for aspectj start "</span>);</div><div class="line">            ...</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"getTarget : "</span> + proceedingJoinPoint.getTarget().getClass().getSimpleName());</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"getThis : "</span> + proceedingJoinPoint.getThis().getClass().getSimpleName());</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"getArgs[0] : "</span> + (proceedingJoinPoint.getArgs()[<span class="number">0</span>] != <span class="keyword">null</span> ? proceedingJoinPoint.getArgs()[<span class="number">0</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">            Field arcField = proceedingJoinPoint.getClass().getDeclaredField(<span class="string">"arc"</span>);</div><div class="line">            arcField.setAccessible(<span class="keyword">true</span>);</div><div class="line">            AroundClosure arc = (AroundClosure) arcField.get(proceedingJoinPoint);</div><div class="line">            <span class="keyword">if</span> (!(arc == <span class="keyword">null</span> || arc.getState() == <span class="keyword">null</span> || arc.getState().length &lt; <span class="number">3</span>)) &#123;</div><div class="line">                Object[] states = arc.getState();</div><div class="line">                Log.d(<span class="string">"robust-wll"</span>, <span class="string">"states[0] : "</span> + (states[<span class="number">0</span>] != <span class="keyword">null</span> ? states[<span class="number">0</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">                Log.d(<span class="string">"robust-wll"</span>, <span class="string">"states[1] : "</span> + (states[<span class="number">1</span>] != <span class="keyword">null</span> ? states[<span class="number">1</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">                Log.d(<span class="string">"robust-wll"</span>, <span class="string">"states[2] : "</span> + (states[<span class="number">2</span>] != <span class="keyword">null</span> ? states[<span class="number">2</span>].getClass().getSimpleName() : <span class="keyword">null</span>));</div><div class="line">            &#125;</div><div class="line">            Log.d(<span class="string">"robust-wll"</span>, <span class="string">"test for aspectj end "</span>);</div><div class="line">            proceedingJoinPoint.proceed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä¸åŠ è½½è¡¥ä¸æƒ…å†µä¸‹çš„ log å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.184</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: test <span class="keyword">for</span> aspectj start </div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.184</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: getTarget : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: getThis : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: getArgs[<span class="number">0</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: states[<span class="number">0</span>] : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.185</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: states[<span class="number">1</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.186</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: states[<span class="number">2</span>] : JoinPointImpl</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">41.186</span> <span class="number">15469</span> <span class="number">15469</span> D robust-wll: test <span class="keyword">for</span> aspectj end</div></pre></td></tr></table></figure>
<p>åŠ è½½è¡¥ä¸åï¼Œlog å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.885</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: test <span class="keyword">for</span> aspectj start </div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.885</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: getTarget : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: getThis : MainFragmentActivity</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: getArgs[<span class="number">0</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: states[<span class="number">0</span>] : MainFragmentActivityPatch</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: states[<span class="number">1</span>] : <span class="keyword">null</span></div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: states[<span class="number">2</span>] : JoinPointImpl</div><div class="line"><span class="number">04</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">27</span>:<span class="number">41.886</span> <span class="number">18490</span> <span class="number">18490</span> D robust-wll: test <span class="keyword">for</span> aspectj end</div></pre></td></tr></table></figure>
<p><strong>states[0] : MainFragmentActivityPatch</strong> è¿™ä¸ªæ˜æ˜¾æ˜¯ä¸å¯¹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº†åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨æ„é€  <code>AroundClosure</code> æ—¶å€™ä¼ è¿›æ¥çš„å‚æ•°ä¸å¯¹ã€‚<br>æŠ¥é”™åœ°æ–¹å¯¹åº”äºä¸Šé¢çš„åˆ†æï¼Œä¹Ÿå°±æ˜¯<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Object[] objArr = <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, savedInstanceState, joinPoint&#125;;</div><div class="line">Object obj2 = (AjcClosure3) EnhancedRobustUtils.invokeReflectConstruct(<span class="string">"com.zhangdan.app.activities.MainFragmentActivity$AjcClosure3"</span>, getRealParameter(<span class="keyword">new</span> Object[]&#123;objArr&#125;), <span class="keyword">new</span> Class[]&#123;Object[].class&#125;);</div></pre></td></tr></table></figure></p>
<p>ç»“æœå°±æ˜¯ï¼ŒæŠŠä¸€ä¸ªå«æœ‰3ä¸ªå¯¹è±¡çš„ä¸€ç»´æ•°æ®ï¼Œç¼–ç¨‹äº†å«æœ‰ä¸€ä¸ªå¯¹è±¡çš„äºŒç»´æ•°ç»„ï¼Œç„¶åå» getRealParameterã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Object[] getRealParameter(Object[] objArr) &#123;</div><div class="line">    <span class="keyword">if</span> (objArr == <span class="keyword">null</span> || objArr.length &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> objArr;</div><div class="line">    &#125;</div><div class="line">    Object[] objArr2 = <span class="keyword">new</span> Object[objArr.length];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objArr.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (objArr[i] == <span class="keyword">this</span>) &#123;</div><div class="line">            objArr2[i] = <span class="keyword">this</span>.originClass;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            objArr2[i] = objArr[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> objArr2;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è€Œè¿™ä¸ªæ–¹æ³•åªåˆ¤æ–­äº†ä¸€ç»´æ•°ç»„çš„æƒ…å†µï¼Œæ²¡æœ‰åˆ¤æ–­äºŒç»´æˆ–å¤šç»´æ•°ç»„çš„æƒ…å†µã€‚ç»ˆäºæ‰¾åˆ°åŸå› äº† ğŸ˜ƒ<br>å¯¹åº”çš„ä¿®æ”¹æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Object[] getRealParameter(Object[] objArr) &#123;</div><div class="line">    <span class="keyword">if</span> (objArr == <span class="keyword">null</span> || objArr.length &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> objArr;</div><div class="line">    &#125;</div><div class="line">    Object[] objArr2 = <span class="keyword">new</span> Object[objArr.length];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objArr.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (objArr[i] <span class="keyword">instanceof</span> Object[]) &#123;</div><div class="line">            objArr2[i] = getRealParameter(((Object[]) objArr[i]));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (objArr[i] == <span class="keyword">this</span>) &#123;</div><div class="line">                objArr2[i] = <span class="keyword">this</span>.originClass;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                objArr2[i] = objArr[i];</div><div class="line">            &#125;</div><div class="line">        &#125; </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> objArr2;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>castException ç»ˆäºæ˜¯æå®šäº†ã€‚å…·ä½“è§£å†³æ–¹æ³•è§ <a href="https://github.com/Meituan-Dianping/Robust/pull/259" target="_blank" rel="external">merge request #259</a>ã€‚</p>
<h1 id="static-æ–¹æ³•ä¸­åŒ…å«-super-æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ"><a href="#static-æ–¹æ³•ä¸­åŒ…å«-super-æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ"></a>static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ</h1><p>çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜å¯èƒ½ä¼šä¸€è„¸æ‡µé€¼ï¼Œstatic æ–¹æ³•ä¸­æ€ä¹ˆå¯èƒ½åŒ…å« super è°ƒç”¨ï¼Ÿåˆ«æ€¥æ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p>
<p>ä¹¦æ¥ä¸ŠèŠ‚ï¼Œè‡³äºè¢« Aspectj  å¤„ç†è¿‡çš„æ–¹æ³•æ— æ³•è¢«æ‰“å…¥ patch çš„é—®é¢˜ï¼Œç†è®ºä¸Šæ¥è¯´è·Ÿæ³›å‹çš„æ¡¥æ–¹æ³•æ˜¯ç±»ä¼¼çš„ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯ <code>@Modify -&gt; RobustModify.modify();</code>ï¼Œä¿®æ”¹åç»éªŒè¯ï¼Œä¼šæŠ¥é”™ã€‚logå¦‚ä¸‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">Caused by: javassist.CannotCompileException: [source error] not-available: <span class="keyword">this</span></div><div class="line">        at javassist.expr.MethodCall.replace(MethodCall.java:<span class="number">241</span>)</div><div class="line">        at javassist.expr.MethodCall$replace$<span class="number">2</span>.call(Unknown Source)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory$<span class="number">1</span>.edit(PatchesFactory.groovy:<span class="number">144</span>)</div><div class="line">        at javassist.expr.ExprEditor.loopBody(ExprEditor.java:<span class="number">224</span>)</div><div class="line">        at javassist.expr.ExprEditor.doit(ExprEditor.java:<span class="number">91</span>)</div><div class="line">        at javassist.CtBehavior.instrument(CtBehavior.java:<span class="number">712</span>)</div><div class="line">        at javassist.CtBehavior$instrument$<span class="number">1</span>.call(Unknown Source)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory.createPatchClass(PatchesFactory.groovy:<span class="number">76</span>)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory.createPatch(PatchesFactory.groovy:<span class="number">310</span>)</div><div class="line">        at com.meituan.robust.autopatch.PatchesFactory$createPatch.call(Unknown Source)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform.generatPatch(AutoPatchTransform.groovy:<span class="number">190</span>)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform$generatPatch$<span class="number">0</span>.callCurrent(Unknown Source)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform.autoPatch(AutoPatchTransform.groovy:<span class="number">138</span>)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform$autoPatch.callCurrent(Unknown Source)</div><div class="line">        at robust.gradle.plugin.AutoPatchTransform.transform(AutoPatchTransform.groovy:<span class="number">97</span>)</div><div class="line">        at com.android.build.api.transform.Transform.transform(Transform.java:<span class="number">290</span>)</div><div class="line">        at com.android.build.gradle.internal.pipeline.TransformTask$<span class="number">2</span>.call(TransformTask.java:<span class="number">185</span>)</div><div class="line">        at com.android.build.gradle.internal.pipeline.TransformTask$<span class="number">2</span>.call(TransformTask.java:<span class="number">181</span>)</div><div class="line">        at com.android.builder.profile.ThreadRecorder.record(ThreadRecorder.java:<span class="number">102</span>)</div><div class="line">        ... <span class="number">27</span> more</div><div class="line">Caused by: compile error: not-available: <span class="keyword">this</span></div><div class="line">        at javassist.compiler.CodeGen.atKeyword(CodeGen.java:<span class="number">1908</span>)</div><div class="line">        at javassist.compiler.ast.Keyword.accept(Keyword.java:<span class="number">35</span>)</div><div class="line">        at javassist.compiler.JvstCodeGen.atMethodArgs(JvstCodeGen.java:<span class="number">358</span>)</div><div class="line">        at javassist.compiler.MemberCodeGen.atMethodCallCore(MemberCodeGen.java:<span class="number">569</span>)</div><div class="line">        at javassist.compiler.MemberCodeGen.atCallExpr(MemberCodeGen.java:<span class="number">537</span>)</div><div class="line">        at javassist.compiler.JvstCodeGen.atCallExpr(JvstCodeGen.java:<span class="number">244</span>)</div><div class="line">        at javassist.compiler.ast.CallExpr.accept(CallExpr.java:<span class="number">46</span>)</div><div class="line">        at javassist.compiler.CodeGen.atStmnt(CodeGen.java:<span class="number">338</span>)</div><div class="line">        at javassist.compiler.ast.Stmnt.accept(Stmnt.java:<span class="number">50</span>)</div><div class="line">        at javassist.compiler.CodeGen.atStmnt(CodeGen.java:<span class="number">351</span>)</div><div class="line">        at javassist.compiler.ast.Stmnt.accept(Stmnt.java:<span class="number">50</span>)</div><div class="line">        at javassist.compiler.Javac.compileStmnt(Javac.java:<span class="number">569</span>)</div><div class="line">        at javassist.expr.MethodCall.replace(MethodCall.java:<span class="number">235</span>)</div><div class="line">        ... <span class="number">45</span> more</div></pre></td></tr></table></figure></p>
<p>é—®é¢˜åˆ†æï¼Œæ ¹æ®å †æ ˆæ˜¾ç¤ºï¼Œè¿™é‡Œæ˜¯åœ¨åšæ›¿æ¢ super æ–¹æ³•çš„é€»è¾‘ï¼Œè·Ÿäº†ä¸‹ plugin çš„ debugï¼Œç”Ÿæˆéœ€è¦ replace çš„ javassist ä»£ç ä¸º <code>{staticRobustonCreate(this,originClass,$$);}</code>ï¼Œç„¶ååœ¨ replace åï¼Œjavac ç¼–è¯‘è¿™æ¡è¯­å¥çš„æ—¶å€™è·ªäº†ã€‚<br>åˆ†æä¸‹éœ€è¦æ›¿æ¢çš„ super çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ Aspectj å¤„ç†åçš„æ–¹æ³•ï¼Œæ ¹æ®ä¸Šé¢åˆ†æçš„ Aspectj çš„è°ƒç”¨æµç¨‹å¾—çŸ¥ï¼Œè¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯ onCreate æ–¹æ³•åŸå§‹çš„é€»è¾‘ï¼Œåç¼–è¯‘å‡ºæ¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11887</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);<span class="comment">//è¿™é‡Œæ˜¯éœ€è¦æ›¿æ¢çš„åœ°æ–¹</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œ auto-patch åšçš„å·¥ä½œæ˜¯å°†<code>super.onCreate</code>æ–¹æ³•åŒ…è£…æˆ static æ–¹æ³•ï¼Œæ­£å¸¸ç”Ÿæˆçš„patchä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivityPatch</span> </span>&#123;</div><div class="line">    SecondActivity originClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondActivityPatch</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.originClass = (SecondActivity) obj;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        staticRobustonCreate(<span class="keyword">this</span>,originClass,bundle);</div><div class="line">       ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(SecondActivityPatch secondActivityPatch, SecondActivity secondActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        SecondActivityPatchRobustAssist.staticRobustonCreate(secondActivityPatch, secondActivity, bundle);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivityPatchRobustAssist</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(SecondActivityPatch secondActivityPatch, SecondActivity secondActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œå¯¹äºå·²ç»è¢« Aspectj å¤„ç†è¿‡çš„æ–¹æ³•ï¼Œæ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!PatchProxy.proxy(<span class="keyword">new</span> Object[]&#123;mainFragmentActivity, bundle, joinPoint&#125;, <span class="keyword">null</span>, changeQuickRedirect, <span class="keyword">true</span>, <span class="number">11887</span>, <span class="keyword">new</span> Class[]&#123;MainFragmentActivity.class, Bundle.class, JoinPoint.class&#125;, Void.TYPE).isSupported) &#123;</div><div class="line">        <span class="comment">//super.onCreate(bundle);//è¿™é‡Œæ˜¯éœ€è¦æ›¿æ¢çš„åœ°æ–¹</span></div><div class="line">        staticRobustonCreate(<span class="keyword">this</span>,originClass,bundle);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨static æ–¹æ³•ä¸­ä½¿ç”¨äº† <code>this</code>å…³é”®å­—ï¼Œå½“ç„¶ç¼–è¯‘å‡ºé”™å•¦ã€‚åŒç†è¿™ä¸ª <code>originClass</code> ä¹Ÿä¸å¯ä»¥å‡ºç°ï¼Œå› ä¸ºå®ƒæ˜¯é static å˜é‡ã€‚<br>ç”±äº xxPatchRobustAssist.staticRobustonCreate() æ–¹æ³•å¹¶æ²¡æœ‰ç”¨åˆ°å‰ä¸¤ä¸ªå˜é‡(patch, activity)ï¼Œç›´æ¥ä¼  null è¡Œä¸è¡Œå‘¢ï¼Ÿç»éªŒè¯æ˜¯ä¸è¡Œçš„ï¼ŒåŸå› å¦‚ä¸‹ã€‚<br>çœ‹äº†ä¸‹ç”ŸæˆxxxPatchRobustAssistç±»çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PatchesAssistFactory</span> </span>&#123;</div><div class="line">    <span class="function">def</span></div><div class="line">    <span class="keyword">static</span> <span class="title">createAssistClass</span><span class="params">(CtClass modifiedClass, String patchClassName, CtMethod removeMethod)</span> &#123;</div><div class="line">       ....</div><div class="line">        StringBuilder staticMethodBuidler = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">if</span> (removeMethod.parameterTypes.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            staticMethodBuidler.append(<span class="string">"public static  "</span> + removeMethod.returnType.name + <span class="string">"   "</span> + ReflectUtils.getStaticSuperMethodName(removeMethod.getName())</div><div class="line">                    + <span class="string">"("</span> + patchClassName + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance,"</span> + JavaUtils.getParameterSignure(removeMethod) + <span class="string">")&#123;"</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            staticMethodBuidler.append(<span class="string">"public static  "</span> + removeMethod.returnType.name + <span class="string">"   "</span> + ReflectUtils.getStaticSuperMethodName(removeMethod.getName())</div><div class="line">                    + <span class="string">"("</span> + patchClassName + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance)&#123;"</span>);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        staticMethodBuidler.append(<span class="string">" return patchInstance."</span> + removeMethod.getName() + <span class="string">"("</span> + JavaUtils.getParameterValue(removeMethod.getParameterTypes().length) + <span class="string">");"</span>);</div><div class="line">        staticMethodBuidler.append(<span class="string">"&#125;"</span>);</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> assistClass;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®é™…ä¸Šï¼Œæœ€ç»ˆç”Ÿæˆçš„è°ƒç”¨æ˜¯ <code>xxPatch.superMethod($$);</code> ï¼Œ$$ä»£è¡¨å…¨éƒ¨å‚æ•°ã€‚å¯¹äºä¸ä¸Šé¢çš„ onCreate æ–¹æ³•å°±æ˜¯ <code>xxPatch.onCreate(bundle);</code>ã€‚<br>æ‰€ä»¥ï¼Œpatch åº”è¯¥ä¸èƒ½ä¼  null äº†ï¼Œå¦åˆ™è¿è¡Œæ—¶ä¼šæŠ¥ç©ºæŒ‡é’ˆï¼Œé‚£ç¬¬äºŒä¸ªå‚æ•° activity  èƒ½ä¸èƒ½ä¼  null å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹ã€‚<br>é¦–å…ˆï¼Œæ ¹æ®å¸¸è¯†ï¼Œstatic æ–¹æ³•ä¸­è‚¯å®šæ˜¯ä¸èƒ½è°ƒç”¨ superæ–¹æ³•çš„ã€‚ä»æœ€ç»ˆç”Ÿæˆçš„ä»£ç ä¹Ÿèƒ½çœ‹å‡ºï¼Œè¿™å¹¶ä¸æ˜¯æœ€ç»ˆåç¼–è¯‘å‡ºçš„çš„ <code>super.onCreate(bundle)</code>æ–¹æ³•è°ƒç”¨ã€‚æ‰€ä»¥å¤„ç†çš„åœ°æ–¹è‚¯å®šåœ¨javassistä¿®æ”¹ç¼–è¯‘ä¹‹åï¼Œå¯¹åº”å¤„ç†çš„åœ°æ–¹åœ¨smali å±‚ï¼Œä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">SmaliTool.<span class="function">java</span></div><div class="line">    <span class="keyword">private</span> String <span class="title">invokeSuperMethodInSmali</span><span class="params">(<span class="keyword">final</span> String line, String fullClassName)</span> &#123;</div><div class="line">                    ...</div><div class="line">                    result = line.replace(Constants.SMALI_INVOKE_VIRTUAL_COMMAND, Constants.SMALI_INVOKE_SUPER_COMMAND);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (!ctMethod.getReturnType().isPrimitive()) &#123;</div><div class="line">                            returnType = <span class="string">"L"</span> + ctMethod.getReturnType().getName().replaceAll(<span class="string">"\\."</span>, <span class="string">"/"</span>);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            returnType = String.valueOf(((CtPrimitiveType) ctMethod.getReturnType()).getDescriptor());</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (NameManger.getInstance().getPatchNameMap().get(fullClassName).equals(fullClassName)) &#123;</div><div class="line">                            result = result.replace(<span class="string">"p0"</span>, <span class="string">"p1"</span>);</div><div class="line">                        &#125;</div><div class="line">                       ...</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">                    &#125;</div><div class="line">                ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå°±æ˜¯æŠŠæ–¹æ³•è°ƒç”¨ä» <code>invoke-invoke-virtual {p0, p2}, Lcom/meituan/robust/patch/SecondActivityPatch;-&gt;onCreate(Landroid/os/Bundle;)</code>V è½¬æ¢æˆ <code>invoke-super {p1, p2}, Landroid/support/v7/app/AppCompatActivity;-&gt;onCreate(Landroid/os/Bundle;)V</code>ï¼Œè¿™æ­¥å¤„ç†å®Œæ‰ä¼šçœŸæ­£çš„è°ƒç”¨çˆ¶ç±»çš„superæ–¹æ³•ã€‚<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ smali å¤„ç†å®Œåï¼Œå‚æ•°ä» p0 -&gt; p1ï¼Œä¹Ÿå°±æ˜¯å‚æ•°ä» xxpatch æ¢æˆäº† Activityï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼šåœ¨è¿è¡Œæ—¶ç”¨åˆ°ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½ä¼ nullã€‚<br>åˆ†æå®Œäº†æ€»ç»“ä¸‹ï¼Œç¬¬äºŒä¸ªå‚æ•° originClass è‚¯å®šä¸èƒ½ä¼  nullï¼Œå¦åˆ™ä¼šç©ºæŒ‡é’ˆï¼›ç¬¬ä¸€ä¸ªå‚æ•°  xxPatchï¼Œç”±äºåœ¨ smali è¢«æ›¿æ¢æˆäº†ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ‰€ä»¥æœ‰å¯èƒ½æ˜¯å¯ä»¥ä¼  null çš„ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>ä¿®æ”¹ originClass ä¸ºstaticï¼Œå¹¶æ–°å¢ä¸€ä¸ª static patch å˜é‡</li>
<li>ç”±äºç›®å‰å·²ç»æ˜¯åœ¨ static æ–¹æ³•ä¸­å­˜åœ¨ super æ–¹æ³•ï¼Œå¯¹åº”çš„ smali ä»£ç ï¼š</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.<span class="function">method <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="title">onCreate_aroundBody0</span><span class="params">(Lcom/zhangdan/app/activities/MainFragmentActivity;Landroid/os/Bundle;Lorg/aspectj/lang/JoinPoint;)</span>V</span></div><div class="line"> ...</div><div class="line">invoke-<span class="keyword">super</span> &#123;p0, p1&#125;, Lcom/zhangdan/app/activities/WrapperAppCompatFragmentActivity;-&gt;onCreate(Landroid/os/Bundle;)V</div></pre></td></tr></table></figure>
</li>
</ol>
<p>æ‰€ä»¥åªè¦ä¸å¤„ç†å°±å¥½äº†ï¼Œéœ€è¦åšçš„å°±æ˜¯åœ¨ auto-plugin ä¸­å¢åŠ æ¡ä»¶åˆ¤æ–­ï¼Œç¬¦åˆ static æ–¹æ³•ä¸­å¸¦æœ‰ super çš„ä¸å¤„ç†ï¼Œä¸€å…±æœ‰ä¸‰å¤„ï¼Œä¸€å¤„æ˜¯ç”Ÿæˆ xxPatchRobustAssist è¾…åŠ©ç±»ï¼Œç¬¬äºŒå¤„åœ¨ javassit æ›¿æ¢ super æ–¹æ³•ï¼Œç¬¬ä¸‰å¤„åœ¨ smali å¤„ç†è¡¥ä¸ä¸­çš„ super æ–¹æ³•ã€‚</p>
<p>å¯¹äºæ–¹æ¡ˆ1ï¼Œé—®é¢˜ï¼š<br>å¦‚æœ patch å’Œ originClass éƒ½æ˜¯ staticï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å†…å­˜æ³„éœ²çš„é£é™©ã€‚<br>å¹¶ä¸”å¦‚æœè¢« patch æ–¹æ³•æ˜¯ static æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨åˆå§‹åŒ– patch æ—¶ï¼ŒoriginClass ä¼šä¼  nullã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">accessDispatch</span><span class="params">(String methodName, Object[] paramArrayOfObject)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Log.d(<span class="string">"robust"</span>, <span class="keyword">new</span> StringBuffer().append(<span class="string">"arrivied in AccessDispatch "</span>).append(methodName).append(<span class="string">" paramArrayOfObject  "</span>).append(paramArrayOfObject).toString());</div><div class="line">        MainFragmentActivityPatch mainFragmentActivityPatch;</div><div class="line">        <span class="keyword">if</span> (!methodName.split(<span class="string">":"</span>)[<span class="number">2</span>].equals(<span class="string">"false"</span>)) &#123;</div><div class="line">            Log.d(<span class="string">"robust"</span>, <span class="string">"static method forward "</span>);</div><div class="line">            mainFragmentActivityPatch = <span class="keyword">new</span> MainFragmentActivityPatch(<span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<p>åŒæ ·åº”è¯¥ä¹Ÿæ˜¯ä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œæ¯ä¿®å¤ä¸€ä¸ªæ–¹æ³•å°±ä¼šç”Ÿæˆä¸€ä¸ª patch å¯¹è±¡å¹¶æŒæœ‰ static çš„ originClass å¼•ç”¨ã€‚<br>å¯¹äºæ–¹æ¡ˆ2 ï¼Œé—®é¢˜ï¼š<br>é¦–å…ˆï¼ŒAspectj åœ¨ static æ–¹æ³•ä¸­æ’äº†ä¸ª super æ–¹æ³•ï¼ˆçŒœæµ‹ä¹Ÿæ˜¯åœ¨ smali å±‚åšçš„ä¿®æ”¹ï¼‰ï¼Œç›´æ¥å†™çš„è¯ javac ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ï¼Œsmali å¤„ç†å§è¿˜æ²¡åˆ°è¿™ä¸€æ­¥ã€‚æ‰€ä»¥è¢«ä¿®å¤åï¼Œè¿™ä¸ª static æ–¹æ³•æ˜¯åœ¨ xxPatch ç±»ä¸­çš„ï¼Œauto-patch å³ä½¿ä¸å¤„ç†ï¼Œè¿è¡Œæ—¶ä¹Ÿä¸èƒ½æ­£å¸¸è¿è¡Œï¼Œå› ä¸º xxPatch ä¸æ˜¯ originClass çˆ¶ç±»çš„å­ç±»ï¼Œä¸èƒ½ç›´æ¥å…¶è°ƒç”¨ super æ–¹æ³•ã€‚</p>
<p>è§‚å¯Ÿ Aspectj ç”Ÿæˆçš„æ–¹æ³•ï¼Œæ‰€æœ‰ çš„static æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯å½“å‰ç±»çš„å¼•ç”¨ï¼Œæ¯”å¦‚ <code>private static final void onCreate_aroundBody0(MainFragmentActivity mainFragmentActivity, Bundle bundle, JoinPoint joinPoint) {</code>ã€‚<br>æ‰€ä»¥æ¯”å¦‚æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œå¾—å‡ºä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">def <span class="keyword">static</span> String <span class="title">invokeSuperString</span><span class="params">(MethodCall m, String originClass)</span> </span>&#123;</div><div class="line">       ...</div><div class="line">       stringBuilder.append(getStaticSuperMethodName(m.methodName) + <span class="string">"("</span> + <span class="keyword">null</span> + <span class="string">","</span> + originClass + <span class="string">",\$\$);"</span>);</div><div class="line">       ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯ static æ–¹æ³•ä¸­å«æœ‰ super æ–¹æ³•ï¼Œå°±å¦‚ä¸‹å¤„ç†ã€‚<br>ç¬¬ä¸€ä¸ª xxPatch å¯¹è±¡ä¼ ç©ºï¼Œæœ€ååœ¨ smali å¤„ç†çš„æ—¶å€™ä¼šè¢«æ›¿æ¢æ‰ã€‚<br>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä»ç±»ä¼¼<code>onCreate_aroundBody0()</code>ä¸­ä¼ è¿‡æ¥çš„ï¼Œåé¢çš„æ˜¯å…¶ä»–å‚æ•°ã€‚<br>æœ€ç»ˆç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">    MainFragmentActivityPatchRobustAssist.staticRobustonCreate(mainFragmentActivityPatch, mainFragmentActivity, bundle);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate_aroundBody0</span><span class="params">(MainFragmentActivity ajc$<span class="keyword">this</span>, Bundle savedInstanceState, JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    staticRobustonCreate(<span class="keyword">null</span>, ajc$<span class="keyword">this</span>, savedInstanceState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œè¿™ä¸ªé—®é¢˜å°±åˆ†æå®Œäº†ï¼Œè¯¦ç»†è§£å†³æ–¹å‘è§ <a href="https://github.com/Meituan-Dianping/Robust/pull/265" target="_blank" rel="external">merge request #265</a></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸ªç³»åˆ—åˆ°è¿™é‡ŒåŸºæœ¬å°±ç»“æŸäº†ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†åœ¨æ¥å…¥ Robust è¿‡ç¨‹ä¸­ç¢°åˆ°çš„ä¸€äº›å‘ä»¥åŠè§£å†³æ€è·¯ï¼Œå…¶å®æ ¹æœ¬è¿˜æ˜¯ç†Ÿè¯»æºç ï¼Œç¢°åˆ°é—®é¢˜å­¦ä¹ ä»æºç ä¸­æ‰¾ç­”æ¡ˆã€‚è¦åšä¿¡ï¼Œå‘è¸©çš„å¤šäº†ï¼Œä¹Ÿå°±ä¸æ€•å‘äº†ã€‚æœ€åç¦åˆ©ä¸€å¼ ã€‚</p>
<p><img src="http://wx3.sinaimg.cn/large/0078WU5Lgy1fsgrhhx37tj30o31040zf.jpg" alt=""></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2018/06/20/robust-2/">http://w4lle.com/2018/06/20/robust-2/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œåˆ†æäº† Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¡¥ä¸åŠ è½½è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;è¡¥ä¸åŒ…è‡ªåŠ¨åŒ–ç”Ÿæˆè¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸‹é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°çš„å‘ä»¥åŠåˆ†æé—®é¢˜çš„æ€è·¯å’Œæœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆã€‚åŒ…å«ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ‰“è¡¥ä¸åŒ…å‡ºé”™ï¼Ÿ&lt;/li&gt;
&lt;li&gt;Robust å®šä¹‰çš„ API ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;li&gt;æ’ä»¶ Plugin Transform çš„é¡ºåºé—®é¢˜ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ä¸ Aspectj å†²çªæ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;li&gt;static æ–¹æ³•ä¸­åŒ…å« super æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</title>
    <link href="http://w4lle.com/2018/05/28/robust-1/"/>
    <id>http://w4lle.com/2018/05/28/robust-1/</id>
    <published>2018-05-28T11:47:06.000Z</published>
    <updated>2018-05-29T08:40:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>è¡¥ä¸åŠ è½½è¿‡ç¨‹</li>
<li>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹</li>
<li>è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹</li>
</ul>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« <a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a>ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†å‰ä¸¤ä¸ªï¼Œè¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º <code>0.3.2</code>ã€‚<br>è¯¥ç¯‡æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œä¸»è¦åˆ†æè¡¥ä¸è‡ªåŠ¨åŒ–ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º<code>0.4.82</code>ã€‚<br><a id="more"></a><br>æ—¶é—´è·¨åº¦æœ‰ç‚¹å¤§â€¦</p>
<p>ç³»åˆ—æ–‡ç« :</p>
<ul>
<li><a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
<li><a href="http://w4lle.com/2018/05/28/robust-1/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</a></li>
<li><a href="http://w4lle.com/2018/05/29/robust-2/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</a></li>
</ul>
<h1 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h1><p>é¦–å…ˆåœ¨ Gradle æ’ä»¶ä¸­æ³¨å†Œäº†ä¸€ä¸ªåä¸º AutoPatchTranform çš„ Tranform </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoPatchTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; </span>&#123;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project target)</span> </span>&#123;</div><div class="line">    initConfig();</div><div class="line">    project.android.registerTransform(<span class="keyword">this</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">def <span class="title">initConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">    NameManger.init();</div><div class="line">    InlineClassFactory.init();</div><div class="line">    ReadMapping.init();</div><div class="line">    Config.init();</div><div class="line">    ...</div><div class="line">    ReadXML.readXMl(project.projectDir.path);</div><div class="line">    Config.methodMap = JavaUtils.getMapFromZippedFile(project.projectDir.path + Constants.METHOD_MAP_PATH)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥ç±»ä¸ºæ’ä»¶çš„å…¥å£ï¼Œå®ç°äº† GradlePlugin å¹¶ç»§æ‰¿è‡ª Transformï¼Œåœ¨å…¥å£å¤„åˆå§‹åŒ–é…ç½®å¹¶æ³¨å†Œ Transformã€‚é…ç½®ä¸»è¦æ˜¯è¯»å– Robust xml é…ç½®ã€æ··æ·†ä¼˜åŒ–åçš„ mapping æ–‡ä»¶ã€æ’åº„è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ methodsMap.robust æ–‡ä»¶ã€åˆå§‹åŒ–å†…è”å·¥å‚ç±»ç­‰ç­‰ã€‚<br>ç„¶åæœ€ä¸»è¦çš„æ˜¯<code>transform</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">transform</span><span class="params">(Context context, Collection&lt;TransformInput&gt; inputs, Collection&lt;TransformInput&gt; referencedInputs, TransformOutputProvider outputProvider, <span class="keyword">boolean</span> isIncremental)</span> <span class="keyword">throws</span> IOException, TransformException, InterruptedException </span>&#123;</div><div class="line">    project.android.bootClasspath.each &#123;</div><div class="line">        Config.classPool.appendClassPath((String) it.absolutePath)</div><div class="line">    &#125;</div><div class="line">    def box = ReflectUtils.toCtClasses(inputs, Config.classPool)</div><div class="line">    ...</div><div class="line">    autoPatch(box)</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">def <span class="title">autoPatch</span><span class="params">(List&lt;CtClass&gt; box)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    ReadAnnotation.readAnnotation(box, logger);</div><div class="line">    <span class="keyword">if</span>(Config.supportProGuard) &#123;</div><div class="line">        ReadMapping.getInstance().initMappingInfo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    generatPatch(box,patchPath);</div><div class="line"></div><div class="line">    zipPatchClassesFile()</div><div class="line">    executeCommand(jar2DexCommand)</div><div class="line">    executeCommand(dex2SmaliCommand)</div><div class="line">    SmaliTool.getInstance().dealObscureInSmali();</div><div class="line">    executeCommand(smali2DexCommand)</div><div class="line">    <span class="comment">//package patch.dex to patch.jar</span></div><div class="line">    packagePatchDex2Jar()</div><div class="line">    deleteTmpFiles()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>transform</code> æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ javassist API æŠŠæ‰€æœ‰éœ€è¦å¤„ç†çš„ç±»åŠ è½½åˆ°å¾…æ‰«æé˜Ÿåˆ—ä¸­ï¼Œç„¶åè°ƒç”¨<code>autoPatch</code>æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆè¡¥ä¸ã€‚<br>åœ¨ <code>autoPatch</code>æ–¹æ³•ä¸­ï¼Œä¸»è¦åšäº†è¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>è¯»å–è¢« @Addã€@Modifyã€RobustModify.modify() æ ‡æ³¨çš„æ–¹æ³•æˆ–ç±»å¹¶è®°å½•</li>
<li>è§£æ mapping æ–‡ä»¶å¹¶è®°å½•æ¯ä¸ªç±»å’Œç±»ä¸­æ–¹æ³•æ··æ·†å‰åå¯¹åº”çš„ä¿¡æ¯ï¼Œå…¶ä¸­æ–¹æ³•å­˜å‚¨çš„ä¿¡æ¯æœ‰ï¼šè¿”å›å€¼ï¼Œæ–¹æ³•åï¼Œå‚æ•°åˆ—è¡¨ï¼Œæ··æ·†åçš„åå­—ï¼›å­—æ®µå­˜å‚¨çš„ä¿¡æ¯æœ‰ï¼šå­—æ®µåï¼Œæ··æ·†åçš„åå­—</li>
<li>æ ¹æ®å¾—åˆ°çš„ä¿¡æ¯ï¼Œ<code>generatPatch</code> æ–¹æ³•å®é™…ç”Ÿæˆè¡¥ä¸</li>
<li>å°†ç”Ÿæˆçš„è¡¥ä¸classæ‰“åŒ…æˆjaråŒ…</li>
<li>jar -&gt; dex</li>
<li>dex -&gt; smali</li>
<li>å¤„ç† smaliï¼Œä¸»è¦æ˜¯å¤„ç† super æ–¹æ³•å’Œå¤„ç†æ··æ·†å…³ç³»</li>
<li>smali -&gt; dex</li>
<li>dex -&gt; jar</li>
</ol>
<p>1ã€2 æ¯”è¾ƒå¥½æ‡‚å°±ä¸é€æ­¥åˆ†æäº†ï¼Œä¸»è¦çœ‹3ï¼›åé¢çš„5ã€6ã€7ã€8ã€9 éƒ½æ˜¯ä¸ºäº† 7 ä¸­å¤„ç† smaliï¼Œæ‰€ä»¥åªè¦ææ‡‚smaliå¤„ç†å°±å¥½äº†ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†æ­¥æ¥çœ‹ã€‚</p>
<h1 id="ç”Ÿæˆè¡¥ä¸"><a href="#ç”Ÿæˆè¡¥ä¸" class="headerlink" title="ç”Ÿæˆè¡¥ä¸"></a>ç”Ÿæˆè¡¥ä¸</h1><p>ä¸»è¦é€»è¾‘åœ¨ <code>generatPatch</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function">def  <span class="title">generatPatch</span><span class="params">(List&lt;CtClass&gt; box,String patchPath)</span></span>&#123;</div><div class="line">...</div><div class="line">    InlineClassFactory.dealInLineClass(patchPath, Config.newlyAddedClassNameList)</div><div class="line">    initSuperMethodInClass(Config.modifiedClassNameList);</div><div class="line">    <span class="comment">//auto generate all class</span></div><div class="line">    <span class="keyword">for</span> (String fullClassName : Config.modifiedClassNameList) &#123;</div><div class="line">        CtClass ctClass = Config.classPool.get(fullClassName)</div><div class="line">        CtClass patchClass = PatchesFactory.createPatch(patchPath, ctClass, <span class="keyword">false</span>, NameManger.getInstance().getPatchName(ctClass.name), Config.patchMethodSignatureSet)</div><div class="line">        patchClass.writeFile(patchPath)</div><div class="line">        patchClass.defrost();</div><div class="line">        createControlClass(patchPath, ctClass)</div><div class="line">    &#125;</div><div class="line">    createPatchesInfoClass(patchPath);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<h2 id="é€æ­¥ç¿»è¯‘"><a href="#é€æ­¥ç¿»è¯‘" class="headerlink" title="é€æ­¥ç¿»è¯‘"></a>é€æ­¥ç¿»è¯‘</h2><p>é¦–å…ˆè°ƒç”¨<code>InlineClassFactory.dealInLineClass(patchPath, Config.newlyAddedClassNameList)</code>è¯†åˆ«è¢«ä¼˜åŒ–è¿‡çš„æ–¹æ³•ï¼Œè¿™é‡Œçš„ä¼˜åŒ–æ˜¯æ³›æŒ‡ï¼ŒåŒ…æ‹¬è¢«ä¼˜åŒ–ã€å†…è”ã€æ–°å¢è¿‡çš„ç±»å’Œæ–¹æ³•ï¼Œå…·ä½“çš„é€»è¾‘ä¸ºæ‰«æä¿®æ”¹åçš„æ‰€æœ‰ç±»å’Œç±»ä¸­çš„æ–¹æ³•ï¼Œå¦‚æœè¿™äº›ç±»å’Œæ–¹æ³•ä¸åœ¨ mapping æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå¯ä»¥å®šä¹‰ä¸ºè¢«ä¼˜åŒ–è¿‡ï¼Œå…¶ä¸­åŒ…æ‹¬<code>@Add</code>æ–°å¢çš„ç±»æˆ–æ–¹æ³•ã€‚<br>ç„¶åè°ƒç”¨<code>initSuperMethodInClass</code>æ–¹æ³•è¯†åˆ«ä¿®æ”¹åçš„æ‰€æœ‰ç±»å’Œç±»ä¸­çš„æ–¹æ³•ä¸­ï¼Œåˆ†ææ˜¯å¦å¦‚åŒ…å« <code>super</code> æ–¹æ³•ï¼Œå¦‚æœæœ‰é‚£ä¹ˆç¼“å­˜ä¸‹æ¥ã€‚<br>ç„¶åè°ƒç”¨ <code>PatchesFactory.createPatch</code> åå°„ç¿»è¯‘ä¿®æ”¹çš„ç±»å’Œæ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> CtClass <span class="title">createPatchClass</span><span class="params">(CtClass modifiedClass, <span class="keyword">boolean</span> isInline, String patchName, Set patchMethodSignureSet, String patchPath)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException </span>&#123;</div><div class="line">    <span class="comment">//æ¸…æ´—éœ€è¦å¤„ç†çš„æ–¹æ³•ï¼Œç•¥..</span></div><div class="line"></div><div class="line">    CtClass temPatchClass = cloneClass(modifiedClass, patchName, methodNoNeedPatchList);</div><div class="line">    </div><div class="line">    JavaUtils.addPatchConstruct(temPatchClass, modifiedClass);</div><div class="line">    CtMethod reaLParameterMethod = CtMethod.make(JavaUtils.getRealParamtersBody(), temPatchClass);</div><div class="line">    temPatchClass.addMethod(reaLParameterMethod);</div><div class="line"></div><div class="line">    dealWithSuperMethod(temPatchClass, modifiedClass, patchPath);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (CtMethod method : temPatchClass.getDeclaredMethods()) &#123;</div><div class="line">        <span class="comment">//  shit !!too many situations need take into  consideration</span></div><div class="line">        <span class="comment">//   methods has methodid   and in  patchMethodSignatureSet</span></div><div class="line">        <span class="keyword">if</span> (!Config.addedSuperMethodList.contains(method) &amp;&amp; reaLParameterMethod != method &amp;&amp; !method.getName().startsWith(Constants.ROBUST_PUBLIC_SUFFIX)) &#123;</div><div class="line">            method.instrument(</div><div class="line">                    <span class="keyword">new</span> ExprEditor() &#123;</div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">edit</span><span class="params">(FieldAccess f)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            ...</div><div class="line">                                <span class="keyword">if</span> (f.isReader()) &#123; f.replace(ReflectUtils.getFieldString(f.getField(), memberMappingInfo, temPatchClass.getName(), modifiedClass.getName()));</div><div class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.isWriter()) &#123;</div><div class="line">                                    f.replace(ReflectUtils.setFieldString(f.getField(), memberMappingInfo, temPatchClass.getName(), modifiedClass.getName()));</div><div class="line">                                &#125;</div><div class="line">                            ...</div><div class="line">                        &#125;</div><div class="line"></div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(NewExpr e)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            <span class="comment">//inner class in the patched class ,not all inner class</span></div><div class="line">                            ...</div><div class="line">                                <span class="keyword">if</span> (!ReflectUtils.isStatic(Config.classPool.get(e.getClassName()).getModifiers()) &amp;&amp; JavaUtils.isInnerClassInModifiedClass(e.getClassName(), modifiedClass)) &#123;</div><div class="line">                                    e.replace(ReflectUtils.getNewInnerClassString(e.getSignature(), temPatchClass.getName(), ReflectUtils.isStatic(Config.classPool.get(e.getClassName()).getModifiers()), getClassValue(e.getClassName())));</div><div class="line">                                    <span class="keyword">return</span>;</div><div class="line">                                &#125;</div><div class="line">                            ...</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(Cast c)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            MethodInfo thisMethod = ReflectUtils.readField(c, <span class="string">"thisMethod"</span>);</div><div class="line">                            CtClass thisClass = ReflectUtils.readField(c, <span class="string">"thisClass"</span>);</div><div class="line"></div><div class="line">                            def isStatic = ReflectUtils.isStatic(thisMethod.getAccessFlags());</div><div class="line">                            <span class="keyword">if</span> (!isStatic) &#123;</div><div class="line">                                <span class="comment">//inner class in the patched class ,not all inner class</span></div><div class="line">                                <span class="keyword">if</span> (Config.newlyAddedClassNameList.contains(thisClass.getName()) || Config.noNeedReflectClassSet.contains(thisClass.getName())) &#123;</div><div class="line">                                    <span class="keyword">return</span>;</div><div class="line">                                &#125;</div><div class="line">                                <span class="comment">// staticå‡½æ•°æ˜¯æ²¡æœ‰thisæŒ‡ä»¤çš„ï¼Œç›´æ¥ä¼šæŠ¥é”™ã€‚</span></div><div class="line">                                c.replace(ReflectUtils.getCastString(c, temPatchClass))</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(MethodCall m)</span> <span class="keyword">throws</span> CannotCompileException </span>&#123;</div><div class="line">                            ...</div><div class="line">                                <span class="keyword">if</span> (!repalceInlineMethod(m, method, <span class="keyword">false</span>)) &#123;</div><div class="line">                                    Map memberMappingInfo = getClassMappingInfo(m.getMethod().getDeclaringClass().getName());</div><div class="line">                                    <span class="keyword">if</span> (invokeSuperMethodList.contains(m.getMethod())) &#123;</div><div class="line">                                        <span class="keyword">int</span> index = invokeSuperMethodList.indexOf(m.getMethod());</div><div class="line">                                        CtMethod superMethod = invokeSuperMethodList.get(index);</div><div class="line">                                        <span class="keyword">if</span> (superMethod.getLongName() != <span class="keyword">null</span> &amp;&amp; superMethod.getLongName() == m.getMethod().getLongName()) &#123;</div><div class="line">                                            String firstVariable = <span class="string">""</span>;</div><div class="line">                                            <span class="keyword">if</span> (ReflectUtils.isStatic(method.getModifiers())) &#123;</div><div class="line">                                                <span class="comment">//ä¿®å¤static æ–¹æ³•ä¸­å«æœ‰superçš„é—®é¢˜ï¼Œæ¯”å¦‚Aspectjå¤„ç†åçš„æ–¹æ³•</span></div><div class="line">                                                MethodInfo methodInfo = method.getMethodInfo();</div><div class="line">                                                LocalVariableAttribute table = methodInfo.getCodeAttribute().getAttribute(LocalVariableAttribute.tag);</div><div class="line">                                                <span class="keyword">int</span> numberOfLocalVariables = table.tableLength();</div><div class="line">                                                <span class="keyword">if</span> (numberOfLocalVariables &gt; <span class="number">0</span>) &#123;</div><div class="line">                                                    <span class="keyword">int</span> frameWithNameAtConstantPool = table.nameIndex(<span class="number">0</span>);</div><div class="line">                                                    firstVariable = methodInfo.getConstPool().getUtf8Info(frameWithNameAtConstantPool)</div><div class="line">                                                &#125;</div><div class="line">                                            &#125;</div><div class="line">                                            m.replace(ReflectUtils.invokeSuperString(m, firstVariable));</div><div class="line">                                            <span class="keyword">return</span>;</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;</div><div class="line">                                    m.replace(ReflectUtils.getMethodCallString(m, memberMappingInfo, temPatchClass, ReflectUtils.isStatic(method.getModifiers()), isInline));</div><div class="line">                                &#125;</div><div class="line">                            ...</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//remove static code block,pay attention to the  class created by cloneClassWithoutFields which construct's</span></div><div class="line">    CtClass patchClass = cloneClassWithoutFields(temPatchClass, patchName, <span class="keyword">null</span>);</div><div class="line">    patchClass = JavaUtils.addPatchConstruct(patchClass, modifiedClass);</div><div class="line">    <span class="keyword">return</span> patchClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å…¶å®æ˜¯è¿™ä¸ªæ’ä»¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œæ€»ä½“æ¥è¯´å°±æ˜¯å°†ä¿®æ”¹åçš„ä»£ç å…¨éƒ¨ç¿»è¯‘æˆåå°„è°ƒç”¨ç”Ÿæˆ xxxPatch ç±»ã€‚<br>æˆ‘ä»¬å…ˆåªå…³æ³¨<code>method.instrument()</code>è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªJavassistçš„APIï¼Œä½œç”¨æ˜¯éå†æ–¹æ³•ä¸­çš„ä»£ç é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>FieldAccessï¼Œå­—æ®µè®¿é—®æ“ä½œã€‚åˆ†ä¸ºå­—æ®µè¯»å’Œå†™ä¸¤ç§ï¼Œåˆ†åˆ«è°ƒç”¨<code>ReflectUtils.getFieldString</code>æ–¹æ³•ï¼Œå°†ä»£ç é€»è¾‘ä½¿ç”¨Javassistç¿»è¯‘æˆåå°„è°ƒç”¨ï¼Œç„¶åæ›¿æ¢ã€‚</li>
<li>NewExprï¼Œnew å¯¹è±¡æ“ä½œã€‚ä¹Ÿåˆ†ä¸ºä¸¤ç§<ul>
<li>éé™æ€å†…éƒ¨ç±»ï¼Œè°ƒç”¨<code>ReflectUtils.getNewInnerClassString</code>ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
<li>å¤–éƒ¨ç±»ï¼Œè°ƒç”¨<code>ReflectUtils.getCreateClassString</code>ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
</ul>
</li>
<li>Castï¼Œå¼ºè½¬æ“ä½œã€‚è°ƒç”¨<code>ReflectUtils.getCastString</code>ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
<li>MethodCallï¼Œæ–¹æ³•è°ƒç”¨æ“ä½œã€‚æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œä»¥ä¸‹å‡ ç§æƒ…å½¢<ul>
<li>lamdaè¡¨è¾¾å¼ï¼Œè°ƒç”¨<code>ReflectUtils.getNewInnerClassString</code>ç”Ÿæˆå†…éƒ¨ç±»çš„æ–¹æ³•å¹¶ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
<li>ä¿®æ”¹çš„æ–¹æ³•æ˜¯å†…è”æ–¹æ³•ï¼Œè°ƒç”¨<code>ReflectUtils.getInLineMemberString</code>æ–¹æ³•ç”Ÿæˆå ä½å†…è”ç±»<code>xxInLinePatch</code>ï¼Œå¹¶åœ¨æ”¹ç±»ä¸­æŠŠä¿®æ”¹çš„æ–¹æ³•ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢è°ƒç”¨ï¼Œè¿™æ–¹æ³•ä¸­åˆæœ‰ä¸€äº›å…¶ä»–æƒ…å†µåˆ¤æ–­ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»</li>
<li>å¦‚æœæ˜¯superæ–¹æ³•ï¼Œè¿™ä¸ªæƒ…å†µåé¢å•ç‹¬æ‹å‡ºæ¥è¯´</li>
<li>æ­£å¸¸æ–¹æ³•ï¼Œè°ƒç”¨<code>ReflectUtils.getMethodCallString</code>æ–¹æ³•ç¿»è¯‘æˆåå°„ï¼Œç„¶åæ›¿æ¢</li>
</ul>
</li>
<li>ç”Ÿæˆè¡¥ä¸ç±»å¹¶å¢åŠ æ„é€ æ–¹æ³•</li>
</ul>
<p>è¯·æ³¨æ„ï¼Œä»¥ä¸Šæ‰€æœ‰æ–¹æ³•å’Œéœ€è¦å¤„ç†çš„æ–¹æ³•éƒ½éœ€è¦ç‰¹åˆ«æ³¨æ„æ–¹æ³•ç­¾åï¼</p>
<h2 id="æ§åˆ¶è¡¥ä¸è¡Œä¸º"><a href="#æ§åˆ¶è¡¥ä¸è¡Œä¸º" class="headerlink" title="æ§åˆ¶è¡¥ä¸è¡Œä¸º"></a>æ§åˆ¶è¡¥ä¸è¡Œä¸º</h2><p>æœ€åè°ƒç”¨ <code>createControlClass(patchPath, ctClass)</code>ã€<code>createPatchesInfoClass(patchPath);</code>ç”Ÿæˆ PatchesInfoImplã€xxxPatchControl å†™å…¥è¡¥ä¸ä¿¡æ¯å’Œæ§åˆ¶è¡¥ä¸è¡Œä¸ºã€‚</p>
<p>å…¶ä¸­ï¼Œ<code>PatchesInfoImpl</code>ä¸­åŒ…å«æ‰€æœ‰è¡¥ä¸ç±»çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œæ¯”å¦‚ <code>MainActivity -&gt; MainActivityPatch</code>ï¼Œä¸æ¸…æ¥šçš„å¯ä»¥å‚è€ƒè¯¥ç³»åˆ—çš„ä¸Šä¸€ç¯‡æ–‡ç« ã€‚ç”Ÿæˆçš„<code>xxxPatchControl</code>ç±»ç”¨äºç”Ÿæˆ<code>xxPatch</code>ç±»ï¼Œå¹¶åˆ¤æ–­è¡¥ä¸ä¸­çš„æ–¹æ³•æ˜¯å¦å’Œmethods.robustä¸­çš„æ–¹æ³•idåŒ¹é…ï¼Œå¦‚æœåŒ¹é…æ‰ä¼šå»è°ƒç”¨è¡¥ä¸ä¸­æ–¹æ³•ã€‚</p>
<p>è‡³æ­¤æ•´ä½“æµç¨‹åŸºæœ¬æ¢³ç†å®Œæˆã€‚åé¢ä¼šé’ˆå¯¹å…·ä½“çš„å¤æ‚æƒ…å†µåŠ ä»¥è§£æã€‚</p>
<h1 id="this-å¦‚ä½•å¤„ç†"><a href="#this-å¦‚ä½•å¤„ç†" class="headerlink" title="this å¦‚ä½•å¤„ç†"></a>this å¦‚ä½•å¤„ç†</h1><p>é¦–å…ˆï¼Œåœ¨è¡¥ä¸ç±»ä¸­ xxPatch ä¸­ï¼Œ<code>this</code>æŒ‡ä»£çš„æ˜¯xxPatchç±»çš„å¯¹è±¡ï¼Œè€Œæˆ‘ä»¬æ˜¯æƒ³è¦çš„å¯¹è±¡æ˜¯è¢«è¡¥ä¸çš„ç±»çš„å¯¹è±¡ã€‚</p>
<p>åœ¨<code>PatchesFactory.createPatchClass()</code>æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">CtMethod reaLParameterMethod = CtMethod.make(JavaUtils.getRealParamtersBody(), temPatchClass);</div><div class="line">temPatchClass.addMethod(reaLParameterMethod);</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRealParamtersBody</span><span class="params">()</span> </span>&#123;</div><div class="line">    StringBuilder realParameterBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">    realParameterBuilder.append(<span class="string">"public  Object[] "</span> + Constants.GET_REAL_PARAMETER + <span class="string">" (Object[] args)&#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"if (args == null || args.length &lt; 1) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" return args;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"&#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" Object[] realParameter = new Object[args.length];"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"for (int i = 0; i &lt; args.length; i++) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"if (args[i] instanceof Object[]) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"realParameter[i] ="</span> + Constants.GET_REAL_PARAMETER + <span class="string">"((Object[]) args[i]);"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"&#125; else &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"if (args[i] ==this) &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" realParameter[i] =this."</span> + ORIGINCLASS + <span class="string">";"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"&#125; else &#123;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" realParameter[i] = args[i];"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">"  return realParameter;"</span>);</div><div class="line">    realParameterBuilder.append(<span class="string">" &#125;"</span>);</div><div class="line">    <span class="keyword">return</span> realParameterBuilder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µçš„ä½œç”¨æ˜¯ï¼Œåœ¨æ¯ä¸ªxxPatchè¡¥ä¸ç±»ä¸­éƒ½æ’å…¥ä¸€ä¸ª<code>getRealParameter()</code>æ–¹æ³•ï¼Œåç¼–è¯‘å‡ºæ¥æœ€ç»ˆçš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Object[] getRealParameter(Object[] objArr) &#123;</div><div class="line">    <span class="keyword">if</span> (objArr == <span class="keyword">null</span> || objArr.length &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> objArr;</div><div class="line">    &#125;</div><div class="line">    Object[] objArr2 = <span class="keyword">new</span> Object[objArr.length];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; objArr.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (objArr[i] <span class="keyword">instanceof</span> Object[]) &#123;</div><div class="line">            objArr2[i] = getRealParameter((Object[]) objArr[i]);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objArr[i] == <span class="keyword">this</span>) &#123;</div><div class="line">            objArr2[i] = <span class="keyword">this</span>.originClass;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            objArr2[i] = objArr[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> objArr2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ƒçš„ä½œç”¨æ˜¯ï¼Œåœ¨æ¯ä¸ªxxPatchä¸­ä½¿ç”¨çš„<code>this</code>ï¼Œéƒ½è½¬æ¢æˆxxè¢«è¡¥ä¸ç±»çš„å¯¹è±¡ã€‚å…¶ä¸­çš„<code>originClass</code>å°±æ˜¯è¡¥ä¸ç±»çš„å¯¹è±¡ã€‚</p>
<h1 id="super-å¦‚ä½•å¤„ç†"><a href="#super-å¦‚ä½•å¤„ç†" class="headerlink" title="super å¦‚ä½•å¤„ç†"></a>super å¦‚ä½•å¤„ç†</h1><p>åŒ<code>this</code>ç±»ä¼¼ï¼ŒxxPatchä¸­è°ƒç”¨ <code>super</code> æ–¹æ³•åŒæ ·éœ€è¦è½¬ä¸ºè°ƒç”¨è¢«è¡¥ä¸ç±»ä¸­ç›¸å…³æ–¹æ³•çš„<code>super</code>è°ƒç”¨ã€‚</p>
<p>è¿˜æ˜¯åœ¨<code>PatchesFactory.createPatchClass()</code>æ–¹æ³•ä¸­æœ‰<code>dealWithSuperMethod(temPatchClass, modifiedClass, patchPath);</code>è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dealWithSuperMethod</span><span class="params">(CtClass patchClass, CtClass modifiedClass, String patchPath)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException </span>&#123;</div><div class="line">    ...</div><div class="line">    methodBuilder.append(<span class="string">"public  static "</span> + invokeSuperMethodList.get(index).getReturnType().getName() + <span class="string">"  "</span> + ReflectUtils.getStaticSuperMethodName(invokeSuperMethodList.get(index).getName()) + <span class="string">"("</span> + patchClass.getName() + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance,"</span> + JavaUtils.getParameterSignure(invokeSuperMethodList.get(index)) + <span class="string">")&#123;"</span>);</div><div class="line">    ...</div><div class="line">    CtClass assistClass = PatchesAssistFactory.createAssistClass(modifiedClass, patchClass.getName(), invokeSuperMethodList.get(index));</div><div class="line">    ...</div><div class="line">    methodBuilder.append(NameManger.getInstance().getAssistClassName(patchClass.getName()) + <span class="string">"."</span> + ReflectUtils.getStaticSuperMethodName(invokeSuperMethodList.get(index).getName())  + <span class="string">"(patchInstance,modifiedInstance"</span>);</div><div class="line">    ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¿ç•™ä¸»è¦ä»£ç ï¼Œæ ¹æ®æ–¹æ³•ç­¾åç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œä»¥<code>staticRobust+methodName</code>å‘½åï¼Œæ–¹æ³•ä¸­è°ƒç”¨ä»¥<code>RobustAssist</code>ç»“å°¾çš„ç±»ä¸­çš„åŒåæ–¹æ³•ï¼Œå¹¶è°ƒç”¨ <code>PatchesAssistFactory.createAssistClass</code> æ–¹æ³•ç”Ÿæˆè¯¥ç±»ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯è¢«è¡¥ä¸ç±»çš„çˆ¶ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">PatchesAssistFactory.createAssistClass:</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">createAssistClass</span><span class="params">(CtClass modifiedClass, String patchClassName, CtMethod removeMethod)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    staticMethodBuidler.append(<span class="string">"public static  "</span> + removeMethod.returnType.name + <span class="string">"   "</span> + ReflectUtils.getStaticSuperMethodName(removeMethod.getName())</div><div class="line">            + <span class="string">"("</span> + patchClassName + <span class="string">" patchInstance,"</span> + modifiedClass.getName() + <span class="string">" modifiedInstance)&#123;"</span>);</div><div class="line">                </div><div class="line">    staticMethodBuidler.append(<span class="string">" return patchInstance."</span> + removeMethod.getName() + <span class="string">"("</span> + JavaUtils.getParameterValue(removeMethod.getParameterTypes().length) + <span class="string">");"</span>);</div><div class="line">    staticMethodBuidler.append(<span class="string">"&#125;"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨éå†<code>MethodCall</code>è¿‡ç¨‹ä¸­ï¼Œå¤„ç†æ–¹æ³•è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">m.replace(ReflectUtils.invokeSuperString(m, firstVariable));</div><div class="line">...</div><div class="line"><span class="function">def <span class="keyword">static</span> String <span class="title">invokeSuperString</span><span class="params">(MethodCall m, String originClass)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    stringBuilder.append(getStaticSuperMethodName(m.methodName) + <span class="string">"(this,"</span> + Constants.ORIGINCLASS + <span class="string">",\$\$);"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¼ é€’çš„å‚æ•°ï¼Œpatchã€originClassï¼ˆè¢«è¡¥ä¸ç±»å¯¹è±¡ï¼‰ã€æ–¹æ³•å®é™…å‚æ•°åˆ—è¡¨ã€‚</p>
<p>åç¼–è¯‘å‡ºçš„ç»“æœå®é™…æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">MainFragmentActivity:</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">MainFragmentActivityPatch:</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">    MainFragmentActivityPatchRobustAssist.staticRobustonCreate(mainFragmentActivityPatch, mainFragmentActivity, bundle);</div><div class="line">&#125;</div><div class="line"></div><div class="line">MainFragmentActivityPatchRobustAssist:</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivityPatchRobustAssist</span> <span class="keyword">extends</span> <span class="title">WrapperAppCompatFragmentActivity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        mainFragmentActivityPatch.onCreate(bundler);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‚æ•°æ˜¯æŒ‰ç…§å®é™…çš„æ–¹æ³•å‚æ•°ä¼ è¿›å»çš„ï¼Œæœ€åè°ƒç”¨äº†xxPatch.superMethodæ–¹æ³•ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿå¹¶æ²¡æœ‰å®ç°<code>super</code>æ–¹æ³•çš„è½¬ä¹‰å•Šï¼Œå†å¾€ä¸‹çœ‹ã€‚</p>
<p>åœ¨å¤„ç†smaliè¿‡ç¨‹ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">invokeSuperMethodInSmali</span><span class="params">(<span class="keyword">final</span> String line, String fullClassName)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    result = line.replace(Constants.SMALI_INVOKE_VIRTUAL_COMMAND, Constants.SMALI_INVOKE_SUPER_COMMAND);</div><div class="line">    ...</div><div class="line">    result = result.replace(<span class="string">"p0"</span>, <span class="string">"p1"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å¤„ç†ä¹‹å‰ï¼Œsmaliæ˜¯é•¿è¿™æ ·çš„ï¼š<code>invoke-invoke-virtual {p0, p2}, Lcom/meituan/robust/patch/SecondActivityPatch;-&gt;onCreate(Landroid/os/Bundle;)V</code>,<br>å¤„ç†ä¹‹åæ˜¯è¿™æ ·çš„ï¼š<code>invoke-super {p1, p2}, Landroid/support/v7/app/AppCompatActivity;-&gt;onCreate(Landroid/os/Bundle;)V</code>ï¼Œæ„æ€å°±æ˜¯æœ¬æ¥æ˜¯è°ƒç”¨æ­£å¸¸æ–¹æ³•ï¼Œç°åœ¨è½¬ä¸ºè°ƒç”¨superæ–¹æ³•ï¼Œå¹¶ä¸”æŠŠå‚æ•°æ¢äº†ä¸€ä¸‹ï¼ŒæŠŠp0(è¡¥ä¸ç±»å¯¹è±¡)æ¢æˆäº†p1ï¼ˆè¢«è¡¥ä¸ç±»å¯¹è±¡ï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†<code>super</code>çš„å¤„ç†ã€‚åç¼–è¯‘åæœ€ç»ˆç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragmentActivityPatchRobustAssist</span> <span class="keyword">extends</span> <span class="title">WrapperAppCompatFragmentActivity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticRobustonCreate</span><span class="params">(MainFragmentActivityPatch mainFragmentActivityPatch, MainFragmentActivity mainFragmentActivity, Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="å†…è”æ€ä¹ˆå¤„ç†"><a href="#å†…è”æ€ä¹ˆå¤„ç†" class="headerlink" title="å†…è”æ€ä¹ˆå¤„ç†"></a>å†…è”æ€ä¹ˆå¤„ç†</h1><p>å†…è”æ˜¯ä¸ªå¹¿ä¹‰çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬äº†æ··æ·†è¿‡ç¨‹ä¸­çš„ä¼˜åŒ–(ä¿®æ”¹æ–¹æ³•ç­¾åã€åˆ é™¤æ–¹æ³•ç­‰)ã€å†…è”ã€‚åœ¨ä¸Šé¢çš„åˆ†æä¸­å¤„ç†ziæ–¹æ³•åŸºæœ¬ä¹Ÿæåˆ°äº†ï¼Œç¼ºå•¥è¡¥å•¥ï¼šå°±æ˜¯æŠŠå†…è”æ‰çš„æ–¹æ³•å†è¡¥å›æ¥ã€‚<br>å¯¹äºå†…è”çš„æ–¹æ³•ï¼Œä¸èƒ½ç”¨<code>@Modify</code>æ³¨è§£æ ‡æ³¨ï¼Œåªèƒ½ä½¿ç”¨<code>RobustModify.modify()</code>æ ‡æ³¨ï¼Œå› ä¸ºåœ¨åŸºç¡€åŒ…ä¸­æ–¹æ³•éƒ½æ²¡äº†ï¼Œæ‰“äº†lè¡¥ä¸æ–¹æ³•ä¹Ÿæ²¡ç”¨ã€‚</p>
<p>ä¸»è¦é€»è¾‘åœ¨éå†<code>MethodCall</code> -&gt; <code>repalceInlineMethod()</code> -&gt; <code>ReflectUtils.getInLineMemberString()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">stringBuilder.append(<span class="string">" instance=new "</span> + NameManger.getInstance().getInlinePatchName(method.declaringClass.name) + <span class="string">"(\$0);"</span>)</div><div class="line">stringBuilder.append(<span class="string">"\$_=(\$r)instance."</span> + getInLineMethodName(method) + <span class="string">"("</span> + parameterBuilder.toString() + <span class="string">");"</span>)</div><div class="line">...</div></pre></td></tr></table></figure>
<p>ä½œç”¨å°±æ˜¯æŠŠå†…è”æ‰çš„æ–¹æ³•è°ƒç”¨æ›¿æ¢ä¸ºInLineç±»ä¸­çš„æ–°å¢æ–¹æ³•ã€‚</p>
<p>ç»“æœå°±æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String first=<span class="keyword">null</span>;</div><div class="line">    <span class="comment">//privateMethodè¢«å†…è”äº†</span></div><div class="line">    <span class="comment">// private void privateMethod(String fir)&#123;</span></div><div class="line">    <span class="comment">//    System.out.println(fir);</span></div><div class="line">    <span class="comment">//&#125;</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(String fir)</span></span>&#123;</div><div class="line">        first=fir;</div><div class="line">        Parent children=<span class="keyword">new</span> Children();</div><div class="line">        <span class="comment">//children.privateMethod("Robust");</span></div><div class="line">        <span class="comment">//å†…è”æ›¿æ¢çš„é€»è¾‘</span></div><div class="line">        ParentInline inline= <span class="keyword">new</span> ParentInline(children);</div><div class="line">        inline.privateMethod(<span class="string">"Robust"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParentInline</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Parent children ;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParentInline</span><span class="params">(Parent p)</span></span>&#123;</div><div class="line">       children=p;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ··æ·†ä¸ºc</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">privateMethod</span><span class="params">(String fir)</span></span>&#123;</div><div class="line">        System.out.println(fir);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Robust çš„æ ¸å¿ƒå…¶å®å°±æ˜¯è‡ªåŠ¨åŒ–ç”Ÿæˆè¡¥ä¸è¿™å—ï¼Œè‡³äºæ’åº„ã€è¡¥ä¸åŠ è½½è¿™äº›éƒ½æ˜¯å¾ˆå¥½å®ç°çš„ï¼Œå› ä¸ºæ²¡æœ‰å¾ˆå¤šçš„ç‰¹æ®Šæƒ…å†µéœ€è¦å¤„ç†ã€‚<br>è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æäº†è‡ªåŠ¨åŒ–è¡¥ä¸æ’ä»¶çš„ä¸»è¦å·¥ä½œæµç¨‹ï¼Œå’Œä¸€äº›ç‰¹æ®Šæƒ…å†µçš„å¤„ç†ï¼Œæ–‡ç« æœ‰é™ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šç‰¹æ®Šæƒ…å†µæ²¡æœ‰åˆ†æï¼Œè¿™é‡Œåªæ˜¯æä¾›ä¸€äº›åˆ†ææºç çš„æ€è·¯ï¼Œç¢°åˆ°ç‰¹æ®Šæƒ…å†µå¯ä»¥æŒ‰ç…§è¿™ä¸ªæ€è·¯æ’æŸ¥è§£å†³é—®é¢˜ã€‚</p>
<p>å°±åƒä»£ç ä¸­æœ‰ä¸€è¡Œæ³¨é‡Šï¼Œæˆ‘è§‰å¾—ç‰¹åˆ«èƒ½æ¦‚æ‹¬è‡ªåŠ¨åŒ–ç”Ÿæˆè¡¥ä¸çš„å›¢é˜Ÿçš„å¿ƒé‡Œè·¯ç¨‹ï¼Œåœ¨æ­¤ä¹Ÿå†æ¬¡æ„Ÿè°¢ç¾å›¢å›¢é˜Ÿå¯¹å¼€æºåšå‡ºçš„è´¡çŒ®ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  shit !!too many situations need take into  consideration</span></div></pre></td></tr></table></figure></p>
<p>æ€»ä½“æ¥è¯´ï¼ŒRobust å‘æ˜¯æœ‰çš„ï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯é«˜å¯ç”¨æ€§ã€é«˜å…¼å®¹æ€§çš„çƒ­ä¿®å¤æ¡†æ¶ï¼Œå°¤å…¶æ˜¯åœ¨Android ç³»ç»Ÿå¼€æ”¾æ€§è¶Šæ¥è¶Šæ”¶ç´§çš„è¶‹åŠ¿ä¸‹ï¼ŒRobust  ä½œä¸ºä¸ hook ç³»ç»Ÿ API çš„çƒ­ä¿®å¤æ¡†æ¶ä¼˜åŠ¿æ›´åŠ çªå‡ºã€‚è™½ç„¶å…¶ä¸­å¯èƒ½æœ‰ä¸€äº›å‘ï¼Œåªè¦æˆ‘ä»¬å¯¹åŸç†ç†Ÿæ‚‰æŒæ¡ï¼Œæ‰æœ‰ä¿¡å¿ƒèƒ½æå®šè¿™äº›é—®é¢˜ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œä¸»è¦å°±è®²ä¸‹Robustä¸å…¶ä»–æ¡†æ¶æ­é…ä½¿ç”¨å‡ºç°çš„ä¸€äº›å‘ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://tech.meituan.com/android_autopatch.html" target="_blank" rel="external">Androidçƒ­æ›´æ–°æ–¹æ¡ˆRobustå¼€æºï¼Œæ–°å¢è‡ªåŠ¨åŒ–è¡¥ä¸å·¥å…·</a></li>
<li><a href="https://www.jianshu.com/p/b9b3ff0e1bf8" target="_blank" rel="external">Javassist ä½¿ç”¨æŒ‡å—ï¼ˆäºŒï¼‰</a></li>
<li><a href="https://juejin.im/entry/579ef6e37db2a2005a6350d8" target="_blank" rel="external">[è½¬] æ·±å…¥ç†è§£ Dalvik å­—èŠ‚ç æŒ‡ä»¤åŠ Smali æ–‡ä»¶</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2018/05/28/robust-1/">http://w4lle.com/2018/05/28/robust-1/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Android çƒ­è¡¥ä¸æ¡†æ¶ Robust ä¸­ï¼Œå‡ ä¸ªé‡è¦çš„æµç¨‹åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¡¥ä¸åŠ è½½è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« &lt;a href=&quot;http://w4lle.com/2017/03/31/robust-0/&quot;&gt;Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)&lt;/a&gt;ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†å‰ä¸¤ä¸ªï¼Œè¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º &lt;code&gt;0.3.2&lt;/code&gt;ã€‚&lt;br&gt;è¯¥ç¯‡æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œä¸»è¦åˆ†æè¡¥ä¸è‡ªåŠ¨åŒ–ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œåˆ†æçš„ç‰ˆæœ¬ä¸º&lt;code&gt;0.4.82&lt;/code&gt;ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Python å¤„ç† pdf</title>
    <link href="http://w4lle.com/2018/02/02/python-pdf/"/>
    <id>http://w4lle.com/2018/02/02/python-pdf/</id>
    <published>2018-02-02T01:34:45.000Z</published>
    <updated>2018-02-05T01:33:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘è€å©†å·¥ä½œä¸­ç¢°åˆ°ä¸€äº›å›°éš¾ï¼Œæ€»æ˜¯è·Ÿæˆ‘æŠ±æ€¨å·¥ä½œå¥½çƒ¦ï¼Œä¸å¼€å¿ƒã€‚<br>ä¸»è¦æ˜¯æ˜¯å› ä¸ºè¦å¤„ç†ä¸€äº›æŠ¥å‘Šï¼Œè¿™äº› pdf æ ¼å¼çš„æ ·æœ¬æŠ¥å‘Šæ¯”è¾ƒå¤šï¼ŒåŸºæœ¬éƒ½æ˜¯äººå·¥æ“ä½œæ¯”è¾ƒå®¹æ˜“å‡ºé”™ï¼Œä¹Ÿæ¯”è¾ƒçç¢ï¼Œå¥½å¿ƒæƒ…éƒ½è¢«ç£¨æ²¡äº†ã€‚</p>
<p>ç„¶åæˆ‘è¯´è¦ä¹ˆå†™ä¸ªå°ç¨‹åºå§ï¼Œå¸®ä½ å¤„ç†è¿™äº›çç¢çš„å·¥ä½œï¼Œç„¶åå°±å¤§æ¦‚æ¢³ç†äº†ä¸€ä¸‹ä¸»è¦éœ€æ±‚ï¼š</p>
<a id="more"></a>
<p>å†…éƒ¨æŠ¥å‘Šï¼š</p>
<ol>
<li>é¦–å…ˆéœ€è¦ä»ç³»ç»Ÿå‡ºå¯¼å‡ºä¸€ä¸ªå¤§çš„ pdfï¼ŒåŒ…å«å¾ˆå¤šå°çš„ pdf</li>
<li>æ¯ä¸ªå°çš„ pdf æŠ¥å‘Šä¸­åŒ…å«ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ æŠ¥å‘Šæ ‡é¢˜ã€å§“åã€ç¼–å·ã€åŒ»é™¢ã€æ€»é¡µæ•°</li>
<li>æ‹¿åˆ°è¿™äº›ä¿¡æ¯ä¹‹åï¼Œåˆ†å‰²å¤§çš„ pdfï¼Œå°†å°çš„ pdf æŠ¥å‘Šå‰¥ç¦»å¤„ç†</li>
<li>ç„¶åé‡å‘½åè¿™äº›æŠ¥å‘Šï¼Œæ ¼å¼ä¸º <code>å§“å-ç¼–å·.pdf</code></li>
<li>å°†è¿™äº›æŠ¥å‘Šç§»åŠ¨åˆ°å¯¹åº”åŒ»é™¢çš„ç›®å½•ä¸‹ï¼Œç„¶åå°†è¿™äº›åŒ»é™¢ç›®å½•å‹ç¼©</li>
</ol>
<p>å¤–éƒ¨æŠ¥å‘Šï¼š</p>
<ol>
<li>å¤–éƒ¨ä¼šå‘è¿‡æ¥å‹ç¼©åŒ…ï¼Œå…¶ä¸­åŒ…å«å•ä¸ªçš„ pdf æŠ¥å‘Š</li>
<li>è§£å‹ç¼©åå°†æŠ¥å‘Šæ‹¿å‡ºæ¥ï¼Œæå–å…¶ä¸­çš„ä¿¡æ¯ï¼Œä¿¡æ¯åŸºæœ¬åŒå†…éƒ¨æŠ¥å‘Š</li>
<li>é‡å‘½å</li>
<li>ç§»åŠ¨åˆ°å¯¹åº”çš„åŒ»é™¢ç›®å½•ä¸‹ï¼Œå¹¶å‹ç¼©</li>
</ol>
<h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><p>äººç”Ÿè‹¦çŸ­ï¼Œæˆ‘ç”¨pythonã€‚<br>å—¯ï¼Œpythonå¤§æ³•å¥½ï¼Œå¤„ç†è¿™äº›çç¢çš„äº‹æƒ…å†™ä¸ª python è„šæœ¬è·‘ä¸€ä¸‹ä¸å°±å¥½äº†å—ã€‚<br>python ç‰ˆæœ¬ä½¿ç”¨çš„python 3.xã€‚</p>
<p>æ¢³ç†äº†ä¸‹è¾“çƒï¼Œé¦–å…ˆéœ€è¦è§£æå¤§ pdf ä¸­çš„ä¸€äº›å…³é”®ä¿¡æ¯ï¼Œè½¬åŒ–ä¸ºæˆ‘ä»¬éœ€è¦çš„æŠ¥å‘Šä¿¡æ¯ï¼Œé¦–å…ˆå†™ä¸ªModelå«åš <code>Sample</code>ï¼ŒåŒ…å« titleã€numberã€nameã€total_pageã€hospital ç­‰ç­‰ï¼Œç„¶åä¾æ¬¡è§£æ pdf ç”Ÿæˆç»„æˆ samples åˆ—è¡¨ï¼Œæœ€åæ ¹æ®æŠ¥å‘Šåˆ—è¡¨åˆ†å‰²å¤„ç†pdf å°±å¥½äº†ã€‚</p>
<h2 id="è§£æ-pdf"><a href="#è§£æ-pdf" class="headerlink" title="è§£æ pdf"></a>è§£æ pdf</h2><p>æœ‰ä¸ª python åº“å«åš <a href="https://github.com/euske/pdfminer" target="_blank" rel="external">pdfminer</a>ï¼Œè¿™ä¸ªåº“å·²ç»ä¸æ”¯æŒpython 3.x ç‰ˆæœ¬äº†ï¼Œè¯¥é¡¹ç›®æ³¨æ˜äº†å¯ä»¥ä½¿ç”¨ <a href="https://github.com/pdfminer/pdfminer.six" target="_blank" rel="external">pdfminer.six</a>æ¥æ”¯æŒ3.xçš„ç‰ˆæœ¬ã€‚</p>
<p>åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_samples</span><span class="params">()</span>:</span></div><div class="line">    fp = open(get_origin_report_path(), <span class="string">'rb'</span>)  <span class="comment"># ä»¥äºŒè¿›åˆ¶è¯»æ¨¡å¼æ‰“å¼€</span></div><div class="line">    <span class="comment"># ç”¨æ–‡ä»¶å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªpdfæ–‡æ¡£åˆ†æå™¨</span></div><div class="line">    praser = PDFParser(fp)</div><div class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªPDFæ–‡æ¡£</span></div><div class="line">    doc = PDFDocument()</div><div class="line">    <span class="comment"># è¿æ¥åˆ†æå™¨ ä¸æ–‡æ¡£å¯¹è±¡</span></div><div class="line">    praser.set_document(doc)</div><div class="line">    doc.set_parser(praser)</div><div class="line"></div><div class="line">    <span class="comment"># æä¾›åˆå§‹åŒ–å¯†ç </span></div><div class="line">    <span class="comment"># å¦‚æœæ²¡æœ‰å¯†ç  å°±åˆ›å»ºä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²</span></div><div class="line">    doc.initialize()</div><div class="line"></div><div class="line">    <span class="comment"># æ£€æµ‹æ–‡æ¡£æ˜¯å¦æä¾›txtè½¬æ¢ï¼Œä¸æä¾›å°±å¿½ç•¥</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> doc.is_extractable:</div><div class="line">        <span class="keyword">raise</span> PDFTextExtractionNotAllowed</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="comment"># åˆ›å»ºPDf èµ„æºç®¡ç†å™¨ æ¥ç®¡ç†å…±äº«èµ„æº</span></div><div class="line">        rsrcmgr = PDFResourceManager()</div><div class="line">        <span class="comment"># åˆ›å»ºä¸€ä¸ªPDFè®¾å¤‡å¯¹è±¡</span></div><div class="line">        laparams = LAParams()</div><div class="line">        device = PDFPageAggregator(rsrcmgr, laparams=laparams)</div><div class="line">        <span class="comment"># åˆ›å»ºä¸€ä¸ªPDFè§£é‡Šå™¨å¯¹è±¡</span></div><div class="line">        interpreter = PDFPageInterpreter(rsrcmgr, device)</div><div class="line"></div><div class="line">        <span class="comment"># å¾ªç¯éå†åˆ—è¡¨ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ªpageçš„å†…å®¹</span></div><div class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> doc.get_pages():  <span class="comment"># doc.get_pages() è·å–pageåˆ—è¡¨</span></div><div class="line">            number_index = <span class="number">0</span></div><div class="line">            name_index = <span class="number">0</span></div><div class="line">            sample = Sample()</div><div class="line">            interpreter.process_page(page)</div><div class="line">            <span class="comment"># æ¥å—è¯¥é¡µé¢çš„LTPageå¯¹è±¡</span></div><div class="line">            layout = device.get_result()</div><div class="line">            <span class="comment"># è¿™é‡Œlayoutæ˜¯ä¸€ä¸ªLTPageå¯¹è±¡ é‡Œé¢å­˜æ”¾ç€ è¿™ä¸ªpageè§£æå‡ºçš„å„ç§å¯¹è±¡ ä¸€èˆ¬åŒ…æ‹¬LTTextBox, LTFigure, LTImage, LTTextBoxHorizontal ç­‰ç­‰ æƒ³è¦è·å–æ–‡æœ¬å°±è·å¾—å¯¹è±¡çš„textå±æ€§ï¼Œ</span></div><div class="line">            <span class="keyword">for</span> index, out <span class="keyword">in</span> enumerate(layout):</div><div class="line">                <span class="comment"># if hasattr(out, "get_text"):</span></div><div class="line">                <span class="comment"># if (isinstance(out, LTTextBoxHorizontal)):</span></div><div class="line">                <span class="keyword">if</span> (isinstance(out, LTTextBox)):</div><div class="line">                    <span class="keyword">with</span> open(get_log_path(), <span class="string">'a'</span>) <span class="keyword">as</span> outfile:</div><div class="line">                        results = out.get_text().replace(<span class="string">u'\xa0'</span>, <span class="string">u' '</span>)</div><div class="line">                        parse()</div><div class="line">                        ...</div><div class="line">                        ....</div></pre></td></tr></table></figure>
<p>å®˜ç½‘ç»™å‡ºçš„ layout å¸ƒå±€</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/pdfminer_layout.png" alt="layout"></p>
<p>æˆ‘ä»¬ä¸»è¦æ‹¿å…¶ä¸­çš„æ–‡æœ¬ä¿¡æ¯ï¼Œæ‰€ä»¥æ‹¿åˆ°æ¯ä¸€é¡µ pdf çš„LTPageåï¼Œéå†å…¶ä¸­çš„åŒ…å« text å±æ€§çš„æ§ä»¶å°±å¥½äº†ï¼Œæ‹¿åˆ°æ–‡æœ¬ä¿¡æ¯ï¼Œæ ¹æ®æ­£åˆ™åŒ¹é…åˆ°å…³å¿ƒçš„æ–‡æœ¬ä¿¡æ¯ï¼Œèµ‹å€¼ç»™æ–°å»ºçš„<code>sample</code>ï¼Œä¾æ¬¡å¾ªç¯ï¼Œæœ€åç»„æˆ <code>samples</code> æŠ¥å‘Šåˆ—è¡¨ç»™åé¢ä½¿ç”¨ã€‚<br>è§£æå®Œäº†åå°±éœ€è¦å¤„ç† pdf äº†ã€‚</p>
<h3 id="åˆ†å‰²-pdf"><a href="#åˆ†å‰²-pdf" class="headerlink" title="åˆ†å‰² pdf"></a>åˆ†å‰² pdf</h3><p>é¦–å…ˆè¦åšçš„æ˜¯å°†å¤§çš„ pdf åˆ†å‰²æˆå°çš„ pdfï¼Œæœäº†ä¸‹åˆ†å‰² pdf æœ‰ä¸ªpython åº“å«åš <a href="https://pythonhosted.org/PyPDF2/" target="_blank" rel="external">PyPDF2</a>ï¼Œå‚è€ƒAPI å†™äº†ä¸€ä¸ªå·¥å…·æ–¹æ³•ç”¨æ¥åˆ†å‰² pdfã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_pdf</span><span class="params">(infn, outfn, start_page, end_page)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    åˆ†å‰²pdfæ–‡æ¡£ï¼Œå¦‚æœéœ€è¦çš„è¯</div><div class="line"></div><div class="line">    :param infn: æºæŠ¥å‘Šç›®å½•</div><div class="line">    :param outfn: åˆ†å‰²åè¾“å‡ºæ–‡æ¡£ç›®å½•</div><div class="line">    :param start_page:</div><div class="line">    :param end_page:</div><div class="line">    :return:</div><div class="line">    """</div><div class="line">    pdf_output = PdfFileWriter()</div><div class="line">    pdf_input = PdfFileReader(open(infn, <span class="string">'rb'</span>))</div><div class="line">    <span class="comment"># è·å– pdf å…±ç”¨å¤šå°‘é¡µ</span></div><div class="line">    page_count = pdf_input.getNumPages()</div><div class="line">    <span class="comment"># å°† pdf çš„åˆ†å‰²é¡µé¢ï¼Œè¾“å‡ºåˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(start_page, end_page):</div><div class="line">        pdf_output.addPage(pdf_input.getPage(i))</div><div class="line">    pdf_output.write(open(outfn, <span class="string">'wb'</span>))</div><div class="line">    print(<span class="string">'---åˆ†å‰²pdfå®Œæ¯•--'</span>)</div></pre></td></tr></table></figure>
<p>æ ¹æ®ç¬¬ä¸€æ­¥å¾—å‡ºçš„ samplesï¼Œå¾ªç¯ä¸€ä¸‹æ‹¿å‡ºå…¶ä¸­çš„total_pageï¼Œä¾æ¬¡åˆ†å‰²å°±å¥½äº†ã€‚</p>
<p>æœ€åå°±æ˜¯é‡å‘½åã€ç§»åŠ¨ã€å‹ç¼©ï¼Œä¸å†™äº†ã€‚</p>
<h1 id="æ‰“åŒ…æˆ-exe-å¯æ‰§è¡Œæ–‡ä»¶"><a href="#æ‰“åŒ…æˆ-exe-å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="æ‰“åŒ…æˆ exe å¯æ‰§è¡Œæ–‡ä»¶"></a>æ‰“åŒ…æˆ exe å¯æ‰§è¡Œæ–‡ä»¶</h1><p>è€å©†ä½¿ç”¨çš„æ˜¯ Windownsï¼Œæ‰€ä»¥æœ€åè¦æ‰“åŒ…æˆ <code>.exe</code> å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœäº†ä¸‹ pyinstaller å¯ä»¥è§£å†³ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦åœ¨å¯¹åº”çš„å¹³å°æ‰èƒ½æ‰“å‡ºå¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯å°±æ˜¯è¯´æƒ³è¦æ‰“å‡º <code>.exe</code> å¿…é¡»åœ¨ Windows ä¸‹æ‰“åŒ…ï¼Œè¿™å°±æœ‰ç‚¹è›‹ç–¼äº†ã€‚ç„¶åå¼„äº†ä¸€ä¸‹ï¼Œå‘ç° Windows ç”¨æ¥åšå¼€å‘çœŸçš„æ˜¯éš¾ç”¨æ— æ¯”ã€‚<br>æœ€åä¹Ÿæ²¡æ‰“ <code>.exe</code>ï¼Œç›´æ¥åœ¨ Windows ä¸‹è£…äº†pythonï¼ŒåŒå‡» <code>.py</code> æ–‡ä»¶å¥½äº†ï¼Œæœ‰bugçš„è¯æ›¿æ¢ä¸€ä¸‹æ–‡ä»¶å¥½äº†ï¼Œä¸ç”¨é‡æ–°æ‰“åŒ…ã€‚</p>
<h1 id="ç¢°åˆ°çš„é—®é¢˜"><a href="#ç¢°åˆ°çš„é—®é¢˜" class="headerlink" title="ç¢°åˆ°çš„é—®é¢˜"></a>ç¢°åˆ°çš„é—®é¢˜</h1><p>é¡¹ç›®äº¤ä»˜è€å©†ä½¿ç”¨åï¼Œæå…¶çš„å¥½ç”¨ï¼Œå¤§å¹…æå‡äº†å·¥ä½œæ•ˆç‡ï¼Œå‡å°‘å‡ºé”™æ¦‚ç‡ï¼Œè€å©†ç”šè‡³å‘äº†ä¸ªæœ‹å‹åœˆå¤¸å¥–äº†ä¸€ç•ªï¼Œæ„Ÿè§‰ç¾æ»‹æ»‹ã€‚</p>
<p>ç¾äº†ä¸åˆ°ä¸¤å¤©å°±å‡º bug äº†ã€‚</p>
<p>bugæ˜¯è¿™æ ·çš„ï¼Œæ¯”å¦‚æœ‰ä¸ªç¼–å·<code>ç¼–å·ï¼šG201802020108</code> æ­£å¸¸è§£æå‡ºæ¥ <code>sample.number = G201802020108</code> æ‰å¯¹ï¼Œä½†æ˜¯ç»“æœå¯èƒ½æ˜¯è¿™æ ·çš„<code>G20180202</code>ï¼Œåé¢å°‘äº†å‡ ä½ã€‚æ‹¿åˆ°åŸå§‹çš„å¤§ pdf è·‘äº†ä¸€éå‘ç°ç¡®å®æ˜¯è¿™æ ·ï¼Œæ¯ä¸ª pdf åœ¨è§£ææ—¶æˆ‘éƒ½æŠŠæ–‡æœ¬ä¿¡æ¯å­˜äº†ä¸‹æ¥ä»¥ä¾¿æŸ¥é—®é¢˜ç”¨ï¼Œè¿™æ—¶æ´¾ä¸Šäº†ç”¨åœºï¼Œæ‰“å¼€çœ‹äº†ä¸‹æ–‡æœ¬ä¿¡æ¯è¢«è¿™æ ·å¤„ç†äº†ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ç¼–å·ï¼šG20180202</div><div class="line"><span class="number">0108</span></div></pre></td></tr></table></figure>
<p>æœ¬æ¥åœ¨ä¸€è¡Œæˆ–è€…è¯´åœ¨ä¸€ä¸ª <code>LTTextBox</code> ä¸­çš„å†…å®¹è¢«åˆ†å‰²æˆäº†ä¸¤ä¸ªï¼Œæ‰€ä»¥å‡ºç°äº†å†…å®¹å°‘çš„é—®é¢˜ã€‚</p>
<p>æ‰¾åˆ°äº†é—®é¢˜åŸå› å°±å¥½å¤„ç†äº†ã€‚<br>é¦–å…ˆæƒ³åˆ°äº†ä¸€ä¸ªæ–¹æ¡ˆï¼Œæ¯ä¸ª <code>LTxx</code> æ§ä»¶åœ¨å½“é¡µ pdf ä¸­çš„ä½ç½®ç”±åæ ‡è¡¨ç¤ºï¼Œå·¦ä¸Šè§’åæ ‡æ˜¯ <code>{x0:0,y0:0, x1:0,y1:0}</code>ï¼Œåªè¦æ¡†ä½äº†ç¼–å·ä¿¡æ¯æ‰€åœ¨çš„åæ ‡èŒƒå›´ï¼Œåªè¦åœ¨è¯¥èŒƒå›´å†…çš„ï¼Œæ‰€æœ‰æ–‡æœ¬ä¿¡æ¯ append ä¸€ä¸‹ç„¶åå†æ­£åˆ™åŒ¹é…å°±å¥½äº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">in_number_area</span><span class="params">(text_box)</span>:</span></div><div class="line">    <span class="comment"># x0,y0,x1,y1</span></div><div class="line">    scope = (<span class="number">370</span>, <span class="number">700</span>, <span class="number">560</span>, <span class="number">740</span>)</div><div class="line">    <span class="keyword">if</span> in_area(text_box.bbox, scope):</div><div class="line">        print(<span class="string">'æ ·æœ¬ç¼–å·åŒ¹é…ï¼åæ ‡ç‚¹ï¼š'</span>, text_box.bbox)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    </div><div class="line"></div><div class="line"><span class="comment"># åˆ¤æ–­TextBoxåæ ‡èŒƒå›´æ˜¯å¦åœ¨è§„å®šèŒƒå›´å†…</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">in_area</span><span class="params">(bbox, scope)</span>:</span></div><div class="line">    <span class="keyword">if</span> bbox[<span class="number">0</span>] &gt; scope[<span class="number">0</span>] <span class="keyword">and</span> bbox[<span class="number">1</span>] &gt; scope[<span class="number">1</span>] <span class="keyword">and</span> bbox[<span class="number">2</span>] &lt; scope[<span class="number">2</span>] <span class="keyword">and</span> bbox[<span class="number">3</span>] &lt; scope[<span class="number">3</span>]:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>ç»™å®šå›ºå®šåæ ‡èŒƒå›´ï¼Œæ‰¾åˆ°åœ¨è¯¥åæ ‡èŒƒå›´å†…çš„æ§ä»¶ï¼Œç„¶åå†å»åŒ¹é…ã€‚</p>
<p>è·‘äº†ä¸€ä¸‹ç¡®å®ç”Ÿæ•ˆäº†ï¼Œä½†æ˜¯é—®é¢˜ä¾ç„¶æ²¡æœ‰è§£å†³ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæŠ¥å‘Šç§ç±»ä¸ä¸€ï¼Œå¯¼è‡´æ ¼å¼å°±ä¸ä¸€æ ·ï¼Œåæ ‡èŒƒå›´ä¹Ÿä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åŠ¨æ€çš„æ‰¾åˆ°åæ ‡èŒƒå›´ã€‚è¯¥æ–¹æ¡ˆå¤±è´¥ã€‚</p>
<p>äºæ˜¯åˆæƒ³åˆ°äº†ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œç›´æ¥çœ‹ä»£ç å§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># è§£æç¼–å·</span></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> utils.number_legal_for_internal(sample.number):</div><div class="line">    num = utils.parse_sample_num(results)</div><div class="line">    <span class="keyword">if</span> num:</div><div class="line">        number_index = index</div><div class="line">        sample.number = num</div><div class="line">        <span class="keyword">continue</span></div><div class="line">    <span class="comment"># è§£å†³ç¼–å·è¢«åˆ†æˆä¸¤æ®µçš„é—®é¢˜</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> utils.number_legal_for_internal(sample.number) <span class="keyword">and</span> number_index <span class="keyword">and</span> (</div><div class="line">            index == number_index + <span class="number">1</span> <span class="keyword">or</span> index == number_index + <span class="number">2</span>):</div><div class="line">        print(<span class="string">'ä¿®æ­£åçš„ç¼–å·ï¼š'</span>)</div><div class="line">        num = utils.parse_sample_num(<span class="string">'æ ·æœ¬ç¼–å·ï¼š'</span> + sample.number + results)</div><div class="line">        sample.number = num</div><div class="line">        <span class="keyword">if</span> utils.number_legal_for_internal(num):</div><div class="line">            number_index = <span class="number">0</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>åŸºæœ¬è§£å†³ã€‚</p>
<p>å…¶å®ç¬¬äºŒä¸ªæ–¹æ¡ˆä¹Ÿä¸å¤ªå®Œç¾ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿç¼–å·è¿˜å¥½è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯å­—æ¯åŠ æ•°å­—ï¼Œå¦‚æœå‡ºç°è¿™ä¸ªbugä¸€èˆ¬éƒ½èƒ½æ¯”è¾ƒå¥½åˆ¤æ–­æ˜¯å¦åˆæ³•ï¼Œæ¯”å¦‚ç¼–å·é•¿åº¦ &gt;=11ï¼Œä½†æ˜¯ï¼Œå¦‚æœæ˜¯åå­—å‘¢ï¼Œå°±æ²¡æœ‰å¾ˆå¥½çš„åˆæ³•è§„åˆ™æ¥åˆ¤æ–­ï¼Œæ¯”å¦‚<code>åå­—ï¼šå¼ ä¸‰ä¸°</code>ï¼Œ<code>ä¸°</code>å­—è¢«åˆ†å‰²äº†ï¼Œè€Œåˆæ³•åˆ¤æ–­æ˜¯åå­—é•¿åº¦ &gt;=2ï¼Œé‚£æœ€åç»“æœå°±æ˜¯<code>å¼ ä¸‰</code>è€Œä¸æ˜¯<code>å¼ ä¸‰ä¸°</code>ã€‚</p>
<p>æ‰€ä»¥ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªä¼˜åŒ–æ–¹æ¡ˆï¼Œåœ¨æ–¹æ¡ˆä¸€å’Œæ–¹æ¡ˆäºŒçš„åŸºç¡€ä¸Šï¼Œç¬¬ä¸€æ­¥å…ˆåŒ¹é…å…³é”®å­—ï¼Œæ¯”å¦‚<code>å§“åï¼š</code>ï¼ŒåŒ¹é…åˆ°äº†ä»¥åå†æ¡†å®šåæ ‡èŒƒå›´ï¼Œä¸€èˆ¬åå­—éƒ½æ˜¯6å­—ä»¥å†…ï¼Œç¼–å·æ˜¯20ä½ä»¥å†…ï¼Œåˆ’å®šåæ ‡èŒƒå›´åå°†èŒƒå›´å†…çš„åŒ¹é…æ§ä»¶æ–‡æœ¬ä¿¡æ¯éƒ½æ‹¿å‡ºæ¥å†ä¸€èµ·è§£æã€‚åŸºæœ¬åšåˆ°äº†åŠ¨æ€åˆ¤æ–­åæ ‡èŒƒå›´ã€‚</p>
<p>å¤–éƒ¨æŠ¥å‘Šè·Ÿå†…éƒ¨æŠ¥å‘ŠåŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«æ˜¯é¦–å…ˆéœ€è¦è§£å‹ä¸€ä¸‹ï¼Œç„¶åè§£æã€å¤„ç†ï¼Œä¸å†™äº†ã€‚</p>
<h1 id="è¿˜æœ‰å“ªäº›å¯ä»¥åš"><a href="#è¿˜æœ‰å“ªäº›å¯ä»¥åš" class="headerlink" title="è¿˜æœ‰å“ªäº›å¯ä»¥åš"></a>è¿˜æœ‰å“ªäº›å¯ä»¥åš</h1><p>å‰é¢å†™äº†æ€ä¹ˆè§£æå¤„ç†pdfï¼Œå…¶å®è¿˜æœ‰ä¸€éƒ¨åˆ†å·¥ä½œä¹Ÿå¯ä»¥ç”¨è„šæœ¬æ¥å¤„ç†ï¼Œæ¯”å¦‚ï¼Œå¤§çš„pdf ä¸‹è½½å¯ä»¥é€šè¿‡è„šæœ¬å¤„ç†ï¼›å¤„ç†å¥½çš„ pdf æŠ¥å‘Šè¦é€šè¿‡é‚®ä»¶æ³•å‘é€ç»™å®¢æˆ·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬å¤„ç†ï¼›æœ‰æ—¶è¿˜éœ€è¦æŠŠè§£æå‡ºçš„ä¿¡æ¯å¡«åˆ°è¡¨æ ¼ä¸­ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨è„šæœ¬å¤„ç†çš„ã€‚</p>
<p>æ€»ç»“ä¸‹æ¥ä¸€å…±æœ‰è¿™å‡ ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>çˆ¬è™«ï¼Œä»ç³»ç»Ÿä¸­å¯¼å‡ºå¤§çš„ pdf æŠ¥å‘Š</li>
<li>pdf è§£æå’Œåˆ†å‰²</li>
<li>å½’ç±»ï¼Œå‹ç¼©</li>
<li>ç”Ÿæˆè¡¨æ ¼</li>
<li>å‘é€é‚®ä»¶</li>
</ul>
<p>ç›®å‰åªåšäº†2 å’Œ3 ï¼Œå…¶ä½™çš„æœ‰æ—¶é—´æ…¢æ…¢å†™ã€‚</p>
<h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« å‘¢ï¼Ÿ<br>å…¶å®ç”¨åˆ°çš„ä¸œè¥¿å¾ˆç®€å•ï¼Œçœ‹å‡ åˆ†é’Ÿ python å…¥é—¨ç„¶åå†æ‰¾ä¸¤ä¸ªå¼€æºåº“å°±æå®šäº†ï¼Œä¹Ÿæ²¡å¿…è¦è®°å½•ä»€ä¹ˆæŠ€æœ¯çŸ¥è¯†ç‚¹ã€‚<br>æˆ‘çœŸæ­£æƒ³è¯´çš„æ˜¯ä¸€äº›æ„Ÿæ‚Ÿï¼Œç¨‹åºå‘˜ç¢°åˆ°è¿™ç§é—®é¢˜ä¸€èˆ¬éƒ½ä¼šæƒ³åŠæ³•å†™ä¸€äº›è„šæœ¬å¤„ç†ï¼Œæ²¡ä»€ä¹ˆç¨€å¥‡çš„ã€‚ä½†æ˜¯å¯¹äºä¸ä¼šå†™ç¨‹åºçš„äººæ¥è¯´ï¼Œæœ‰è¿™ä¸ªç¨‹åºå’Œæ²¡æœ‰è¿™ä¸ªç¨‹åºç®€ç›´å°±æ˜¯ä¸ä¸€æ ·çš„å·¥ä½œï¼Œå°±æ‹¿è¿™ä»¶äº‹æ¥è¯´ï¼Œç”¨äº†è¿™ä¸ªç¨‹åºä¹‹åï¼Œæˆ‘è€å©†çš„å·¥ä½œæ•ˆç‡æ˜æ˜¾æå‡ï¼Œæ¯å¤©èƒ½èŠ‚çœå‡º1-2å°æ—¶æ—¶é—´åšåˆ«çš„äº‹æƒ…ï¼Œä»äº¤ä»˜é‚£å¤©èµ·ï¼ŒåŸºæœ¬æ²¡å¬è¿‡è€å©†å†æŠ±æ€¨å·¥ä½œäº†ã€‚ç®€ç›´å¼€å¿ƒã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯ä»¥å‰æ€»æ„Ÿè§‰ç¨‹åºå‘˜è¿™ä¸ªå·¥ä½œå¯¹ç”Ÿæ´»çš„å¸®åŠ©ç®€ç›´å°±æ˜¯æ²¡å•¥ç”¨ï¼Œæ¯”å¦‚ï¼Œä½ çœ‹è°è°ç°åœ¨æ˜¯åŒ»ç”Ÿï¼Œå»åŒ»é™¢éƒ½ä¸ç”¨æŒ‚å·ï¼Œç›´æ¥å°±èƒ½çœ‹ç—…ï¼›è°è°æ˜¯è€å¸ˆï¼Œå­©å­ä¸Šå­¦çš„äº‹æƒ…æ ¹æœ¬ä¸ç”¨æ„ç­‰ç­‰è¯¸å¦‚æ­¤ç±»ï¼ŒèŒä¸šé™¤äº†èƒ½å…»æ´»è‡ªå·±ä¹‹å¤–èƒ½å¤Ÿåå“ºç”Ÿæ´»ï¼Œåœ¨ç”Ÿæ´»ä¸­æä¾›ä¸€äº›ä»·å€¼ã€‚åè§‚ç¨‹åºå‘˜å¯¹ç”Ÿæ´»ä¸Šçš„å¸®åŠ©ç®€ç›´å°±æ˜¯0ï¼Œç”šè‡³å¯ä»¥è¯´æ˜¯è´Ÿæ•°ã€‚</p>
<p>ç°åœ¨æ˜¯é«˜é€Ÿå‘å±•çš„ä¿¡æ¯æ—¶ä»£ï¼Œå¹²ä»€ä¹ˆå·¥ä½œéƒ½ç¦»ä¸å¼€æ‰‹æœºã€ç”µè„‘ï¼Œç”šè‡³äººå·¥æ™ºèƒ½åœ¨æŸäº›æ–¹é¢éƒ½å¼€å§‹å–ä»£äººåŠ›å»åšä¸€äº›å·¥ä½œï¼Œæ‰€ä»¥æˆ‘è§‰å¾—è¶Šæ¥è¶Šèƒ½ä½“ç°å‡ºç¨‹åºå‘˜çš„ä»·å€¼ï¼Œå¯ä»¥æ§åˆ¶æœºå™¨å–ä»£äººå·¥å»åšä¸€äº›é‡å¤æ€§çš„ã€æœºæ¢°æ€§çš„å·¥ä½œï¼Œæ‰€ä»¥åœ¨æœ‰èƒ½åŠ›çš„å‰æä¸‹å­¦ä¹ ä¸€äº›å¼€å‘çŸ¥è¯†ä¼šå¤§æœ‰è£¨ç›Šã€‚å°±åƒæ¯ä¸ªäººéƒ½å­¦è‹±è¯­ä¸€æ ·ï¼Œåœ¨æœªæ¥ï¼Œç¼–ç¨‹ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€é—¨åŸºç¡€å­¦ç§‘ï¼Œæ¯ä¸ªäººéƒ½åº”è¯¥æŒæ¡ã€‚</p>
<p>å›åˆ°ç°åœ¨ï¼Œç®€å•çš„ç”¨ä¸€äº›ç®€å•çš„è„šæœ¬æå‡ç”Ÿæ´»å¹¸ç¦æ„Ÿï¼ŒæŠŠè¿™äº›çƒ¦äººçš„å·¥ä½œäº¤ç»™æœºå™¨å»åšï¼Œäººç±»æœ€æ“…é•¿çš„æ˜¯æµªè´¹æ—¶é—´ï¼Œæ©ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/machine_time1.jpg" alt=""></p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/machine_time2.jpg" alt=""></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2018/02/02/python-pdf/">http://w4lle.com/2018/02/02/python-pdf/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æœ€è¿‘è€å©†å·¥ä½œä¸­ç¢°åˆ°ä¸€äº›å›°éš¾ï¼Œæ€»æ˜¯è·Ÿæˆ‘æŠ±æ€¨å·¥ä½œå¥½çƒ¦ï¼Œä¸å¼€å¿ƒã€‚&lt;br&gt;ä¸»è¦æ˜¯æ˜¯å› ä¸ºè¦å¤„ç†ä¸€äº›æŠ¥å‘Šï¼Œè¿™äº› pdf æ ¼å¼çš„æ ·æœ¬æŠ¥å‘Šæ¯”è¾ƒå¤šï¼ŒåŸºæœ¬éƒ½æ˜¯äººå·¥æ“ä½œæ¯”è¾ƒå®¹æ˜“å‡ºé”™ï¼Œä¹Ÿæ¯”è¾ƒçç¢ï¼Œå¥½å¿ƒæƒ…éƒ½è¢«ç£¨æ²¡äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åæˆ‘è¯´è¦ä¹ˆå†™ä¸ªå°ç¨‹åºå§ï¼Œå¸®ä½ å¤„ç†è¿™äº›çç¢çš„å·¥ä½œï¼Œç„¶åå°±å¤§æ¦‚æ¢³ç†äº†ä¸€ä¸‹ä¸»è¦éœ€æ±‚ï¼š&lt;/p&gt;
    
    </summary>
    
    
      <category term="å·¥å…·" scheme="http://w4lle.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="å…¶ä»–" scheme="http://w4lle.com/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>åŒºå—é“¾ï¼ˆä¸€ï¼‰åŒºå—é“¾å’Œä»¥å¤ªåŠ</title>
    <link href="http://w4lle.com/2017/10/27/ethereum-0/"/>
    <id>http://w4lle.com/2017/10/27/ethereum-0/</id>
    <published>2017-10-27T11:37:06.000Z</published>
    <updated>2017-10-27T13:59:25.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŒºå—é“¾æ˜¯ä»€ä¹ˆ"><a href="#åŒºå—é“¾æ˜¯ä»€ä¹ˆ" class="headerlink" title="åŒºå—é“¾æ˜¯ä»€ä¹ˆ"></a>åŒºå—é“¾æ˜¯ä»€ä¹ˆ</h1><blockquote>
<p>åŒºå—é“¾ï¼ˆè‹±è¯­ï¼šblockchain æˆ– block chainï¼‰æ˜¯ç”¨åˆ†å¸ƒå¼æ•°æ®åº“è¯†åˆ«ã€ä¼ æ’­å’Œè®°è½½ä¿¡æ¯çš„æ™ºèƒ½åŒ–å¯¹ç­‰ç½‘ç»œ, ä¹Ÿç§°ä¸ºä»·å€¼äº’è”ç½‘ã€‚ä¸­æœ¬èªåœ¨2008å¹´ï¼Œäºã€Šæ¯”ç‰¹å¸ç™½çš®ä¹¦ã€‹ä¸­æå‡ºâ€œåŒºå—é“¾â€æ¦‚å¿µï¼Œå¹¶åœ¨2009å¹´åˆ›ç«‹äº†æ¯”ç‰¹å¸ç¤¾ä¼šç½‘ç»œï¼Œå¼€å‘å‡ºç¬¬ä¸€ä¸ªåŒºå—ï¼Œå³â€œåˆ›ä¸–åŒºå—â€ã€‚</p>
</blockquote>
<a id="more"></a>
<p>åŒºå—é“¾ï¼Œç®€å•çš„è®²å°±æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨çš„ä¸€ä¸ªå¤§è´¦æœ¬ï¼Œç”±ä¸€æ¡æ¡çš„äº¤æ˜“è®°å½•ï¼ˆblockï¼‰ç»„æˆï¼Œå¹¶ä¸”ä»»ä½•äººéƒ½å¯ä»¥æ‹¥æœ‰è¿™ä¸ªè´¦æœ¬å¹¶ä¸”å¯ä»¥å­˜å‚¨äº¤æ˜“è®°å½•ï¼Œå‡ ä¹åœ¨åŒä¸€æ—¶é—´è¿™æ¡è®°å½•å°±ä¼šè¢«åŒæ­¥åˆ°å…¨ä¸–ç•Œçš„å‰¯æœ¬ä¸Šï¼Œè¿™å°±ä½¿å¾—æ²¡æœ‰äººèƒ½å¤Ÿä¿®æ”¹æœ¬åœ°è´¦æœ¬ä¸­çš„è®°å½•ï¼Œä½¿å…¶æ‹¥æœ‰äº†å»ä¸­å¿ƒåŒ–çš„èƒ½åŠ›ã€‚å¯ä»¥ç†è§£ä¸ºè¿™å°±æ˜¯åŒºå—é“¾æŠ€æœ¯çš„åŸºæœ¬å†…å®¹ï¼Œæ¯”ç‰¹å¸å’Œä»¥å¤ªåŠå’Œå…¶ä»–ä»£å¸éƒ½æ˜¯ä»¥æ­¤ä¸ºåŸºç¡€ã€‚æœ€æœ‰åæ°”çš„å°±å±æ¯”ç‰¹å¸äº†ã€‚</p>
<p>è€ƒè™‘ç°å®ç”Ÿæ´»ï¼Œæ¯”å¦‚æƒ³å»æ‰¾ä¸€ä¸ªé™Œç”Ÿäººå€Ÿé’±ï¼Œé‚£ä¹ˆå°±å¿…é¡»æœ‰ä¸€ä¸ªåŒæ–¹éƒ½è®¤å¯çš„ç¬¬ä¸‰æ–¹å­˜åœ¨ï¼Œæ¯”å¦‚é“¶è¡Œã€‚ç”±äºåŒºå—é“¾çš„å­˜åœ¨ï¼Œè¿™ä¸ªç¬¬ä¸‰æ–¹å°±å¯ä»¥ä¸éœ€è¦äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘è¦å€Ÿç»™ A ä¸€å—é’±ï¼Œæˆ‘è¦åœ¨è´¦æœ¬ä¸Šå†™ä¸€æ¡ï¼Œæˆ‘è¦å€Ÿç»™ A ä¸€å—é’±ï¼Œé¦–å…ˆä¼šå»æ£€æŸ¥ä½ æœ‰æ²¡æœ‰ä¸€å—é’±ï¼Œå¦‚æœæœ‰çš„è¯å°±ä¼šè®°å½•ä¸‹æ¥ï¼Œå¹¶ä¸”åŒæ—¶åœ¨ä½ çš„è´¦æˆ·ä¸­æ‰£æ‰ä¸€å—é’±åŒæ—¶åœ¨ A çš„è´¦æˆ·ä¸­å¢åŠ ä¸€å—é’±ï¼ŒåŒæ—¶åŒæ­¥åˆ°æ‰€æœ‰æŒæœ‰è¯¥è´¦æœ¬çš„è´¦æˆ·ä¸Šã€‚</p>
<p>å› æ­¤ï¼ŒåŒºå—é“¾å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å»ä¸­å¿ƒåŒ–</li>
<li>åˆ†å¸ƒå¼</li>
<li>å¯†ç æ€§å®‰å…¨</li>
</ul>
<h1 id="ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ"><a href="#ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ"></a>ä»¥å¤ªåŠæ˜¯ä»€ä¹ˆ</h1><blockquote>
<p>ä»¥å¤ªåŠæ˜¯ä¸€ä¸ªå…¨æ–°å¼€æ”¾çš„åŒºå—é“¾å¹³å°ï¼Œå®ƒå…è®¸ä»»ä½•äººåœ¨å¹³å°ä¸­å»ºç«‹å’Œä½¿ç”¨é€šè¿‡åŒºå—é“¾æŠ€æœ¯è¿è¡Œçš„å»ä¸­å¿ƒåŒ–åº”ç”¨ã€‚</p>
</blockquote>
<p>ä»¥å¤ªåŠç›¸æ¯”äºåŒºå—é“¾æœ‰äº†æ›´è¿›ä¸€æ­¥çš„å‘å±•ï¼Œå®ƒå¯ä»¥åœ¨é“¾ä¸Šåˆ›å»ºä¸€äº›è‡ªåŠ¨è¿è¡Œçš„ç¨‹åºç§°ä¹‹ä¸ºæ™ºèƒ½åˆçº¦ï¼Œåªè¦è¿™ä¸ªæ™ºèƒ½åˆçº¦å‘å¸ƒåˆ°äº†é“¾ä¸Šï¼Œä»»ä½•äººéƒ½æ— æ³•ä¿®æ”¹å®ƒï¼Œå¹¶ä¸”å®ƒæ˜¯å¯¹ä»»ä½•äººé€æ˜çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥çœ‹åˆ°å…¶ä»£ç ã€‚ä»»ä½•äººéƒ½å¯ä»¥å‘å¸ƒæ™ºèƒ½åˆçº¦ï¼Œç¼–å†™æ™ºèƒ½åˆçº¦æ‰€ä½¿ç”¨çš„é«˜çº§è¯­è¨€ä¹Ÿæ˜¯å›¾çµå®Œå¤‡çš„ï¼ˆæ„å‘³ç€è¯­è¨€å¯ä»¥ä½¿ç”¨è®¡å›¾çµæœºå®Œæˆä»»ä½•å›¾çµæœºå¯ä»¥å®Œæˆçš„ä»»åŠ¡ï¼‰ï¼Œè¿™å°±ä½¿å¾—è¿™æ˜¯å¯ç¼–ç¨‹çš„ï¼Œä»»ä½•äººæ”¯ä»˜ä¸€ç¬”è´¹ç”¨ (Gas) éƒ½å¯ä»¥éƒ¨ç½²ç¼–å†™çš„æ™ºèƒ½åˆçº¦ä¾›å…¶ä»–äººä½¿ç”¨ã€‚</p>
<p>è€ƒè™‘ç°å®ç”Ÿæ´»ï¼Œæ¯”å¦‚è¯´ä½¿ç”¨åŸºäºä»¥å¤ªåŠçš„æ™ºèƒ½åˆçº¦å­˜é’±ï¼Œè¯¥åˆçº¦çº¦å®šæœˆåˆ©ç‡1%ï¼Œé‚£ä¹ˆå‡å¦‚æˆ‘å­˜äº†100å—é’±è¿›å»ï¼Œä¸€ä¸ªæœˆåæ¥å–ï¼Œé‚£ä¹ˆæˆ‘èƒ½å–åˆ°çš„é‡‘é¢å¿…ç„¶æ˜¯ 100 + 100 * 0.01ã€‚</p>
<p>æ‰€ä»¥ç›¸å¯¹äºåŒºå—é“¾ï¼Œä»¥å¤ªåŠå¤šäº†ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ™ºèƒ½åˆçº¦</li>
<li>å›¾çµå®Œå¤‡</li>
</ul>
<h1 id="æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ"><a href="#æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ" class="headerlink" title="æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ"></a>æŒ–çŸ¿æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</h1><p>ä»¥å¤ªåŠçš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªåŸºäºäº¤æ˜“çš„çŠ¶æ€æœº(transaction-based state machine)ã€‚ä»¥å¤ªåŠçš„çŠ¶æ€åŒ…å«å¾ˆå¤šäº¤æ˜“ï¼Œè¿™äº›äº¤æ˜“è¢«æ‰“åŒ…åˆ°åŒºå—ä¸­ï¼ˆblockï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª block åŒ…å«äº†ä¸€ç³»åˆ—çš„äº¤æ˜“ï¼Œæ¯ä¸ªåŒºå—ä¸å®ƒçš„å‰ä¸€ä¸ªåŒºå—é“¾æ¥èµ·æ¥ç»„æˆåŒºå—é“¾ã€‚<br><img src="http://7xs23g.com1.z0.glb.clouddn.com/blockchain.png" alt="blockchain"><br>ä¸ºäº†è®©äº¤æ˜“è¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„ï¼Œéƒ½å¿…é¡»è¦ç»å†ä¸€ä¸ªéªŒè¯çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯æŒ–çŸ¿ã€‚æŒ–çŸ¿å®é™…ä¸Šå°±æ˜¯çŸ¿å·¥ç”¨ä»–ä»¬çš„è®¡ç®—èµ„æºæ¥åˆ›å»ºä¸€ä¸ªåŒ…å«æœ‰æ•ˆäº¤æ˜“çš„åŒºå—å‡ºæ¥ã€‚ç„¶è€Œå½“ä½ åœ¨è®¡ç®—åŒºå—çš„æ—¶å€™åˆ«çš„çŸ¿å·¥åŒæ ·ä¹Ÿåœ¨è®¡ç®—ï¼Œå¦‚æœå¤§å®¶åŒæ—¶æäº¤çš„è¯ï¼Œæ€ä¹ˆè¯æ˜è°çš„åŒºå—æ˜¯æœ‰æ•ˆçš„ï¼Ÿæ‰€ä»¥åœ¨æäº¤åŒºå—åˆ°åŒºå—é“¾ä¸Šæ—¶ï¼Œéƒ½éœ€è¦æä¾›ä¸€ä¸ªæ•°å­¦æœºåˆ¶çš„è¯æ˜ï¼Œç§°ä¹‹ä¸ºå·¥ä½œé‡è¯æ˜ï¼ˆproof of workï¼‰ï¼Œæ‰€ä»¥ä¸€ä¸ªçŸ¿å·¥å¿…é¡»è¦æ¯”å…¶ä»–çŸ¿å·¥æ›´å¿«çš„æä¾›å‡ºè¿™ä¸ªè¯æ˜æ¥æŠ¢å åŒºå—çš„æœ‰æ•ˆæ€§å°†ä¹‹åˆå¹¶åˆ°åŒºå—ä¸¤ä¸Šï¼Œä¸æ­¤åŒæ—¶ï¼Œåˆ«çš„çŸ¿å·¥ä¼šåŠæ—¶çš„å°†åŒºå—é“¾çš„çŠ¶æ€æ›´æ–°è‡³æœ€æ–°ã€‚è¯å®äº†ä¸€ä¸ªæ–°åŒºå—çš„çŸ¿å·¥éƒ½ä¼šè¢«å¥–åŠ±ä¸€å®šä»·å€¼çš„å¥–èµã€‚å¥–èµå°±æ˜¯ä»¥å¤ªåŠä½¿çš„ç”¨ä¸€ç§å†…åœ¨æ•°å­—ä»£å¸â€”ä»¥å¤ªå¸(Ether)ã€‚</p>
<p>å¦å¤–ï¼Œä»¥å¤ªåŠå’ŒåŒºå—é“¾çš„æ¶æ„ä¸åŒåœ¨äºï¼Œä»¥å¤ªåŠåŒºå—ä¸ä»…åŒ…å«äº¤æ˜“è®°å½•å’Œæœ€è¿‘çš„çŠ¶æ€ï¼Œè¿˜åŒ…å«åŒºå—åºå·å’Œéš¾åº¦å€¼ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/ethereum-blockchain.png" alt=""></p>
<h1 id="æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›"><a href="#æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›" class="headerlink" title="æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›"></a>æˆ‘ä»¬èƒ½ç”¨æ¥å¹²å˜›</h1><p>æˆ‘ä»¬å…¬å¸ 1024 ç¨‹åºå‘˜èŠ‚å½“å¤©æäº†ä¸ª HackathonDay æ´»åŠ¨ï¼Œæˆ‘ä»¬æŠ¥åå‚åŠ äº†ä¸‹ï¼Œå¹¶ä¸”é€‰é¢˜å°±æ˜¯åŸºäºåŒºå—é“¾çš„å®é™…åº”ç”¨ï¼Œè™½ç„¶åŸºæœ¬åªæœ‰ä¸€å¤©çš„æ—¶é—´æ¥å­¦ä¹ åŒºå—é“¾çš„ç›¸å…³çŸ¥è¯†ï¼Œæˆ‘ä»¬è¿˜æ˜¯åšå‡ºäº†ä¸€äº› Demoï¼ŒåŸºæœ¬ç®—æ˜¯å…¥é—¨ã€‚<br>æ‰€ä»¥æ¥ä¸‹æ¥çš„æ–‡ç« ä¼šå†™åˆ°åŸºäºä»¥å¤ªåŠæ­å»ºä¸€ä¸ªç§æœ‰é“¾ã€åˆ›å»ºè´¦æˆ·ã€è¿›è¡ŒæŒ–çŸ¿ã€è¿›è¡Œè½¬è´¦äº¤æ˜“ã€åŸºäº Solidity è¯­è¨€ç¼–å†™æ™ºèƒ½åˆçº¦ã€éƒ¨ç½²åˆ°åŒºå—é“¾ä¸Šã€ç¼–å†™ DApp æ¥ä½¿ç”¨æ™ºèƒ½åˆçº¦ç­‰ç­‰ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://github.com/ethereum/wiki/wiki/%5B%E4%B8%AD%E6%96%87%5D-%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%99%BD%E7%9A%AE%E4%B9%A6" target="_blank" rel="external">ä»¥å¤ªåŠç™½çš®ä¹¦</a></li>
<li><a href="http://ethfans.org/posts/how-does-ethereum-work-anyway" target="_blank" rel="external">ä»¥å¤ªåŠçš„å·¥ä½œåŸç†</a></li>
<li><a href="http://wangxiaoming.com/blog/2016/05/05/blockchain-tech-what-is-blockchain/" target="_blank" rel="external">åŒºå—é“¾æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/10/27/ethereum-0/">http://w4lle.com/2017/10/27/ethereum-0/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;åŒºå—é“¾æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#åŒºå—é“¾æ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;åŒºå—é“¾æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;/a&gt;åŒºå—é“¾æ˜¯ä»€ä¹ˆ&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;åŒºå—é“¾ï¼ˆè‹±è¯­ï¼šblockchain æˆ– block chainï¼‰æ˜¯ç”¨åˆ†å¸ƒå¼æ•°æ®åº“è¯†åˆ«ã€ä¼ æ’­å’Œè®°è½½ä¿¡æ¯çš„æ™ºèƒ½åŒ–å¯¹ç­‰ç½‘ç»œ, ä¹Ÿç§°ä¸ºä»·å€¼äº’è”ç½‘ã€‚ä¸­æœ¬èªåœ¨2008å¹´ï¼Œäºã€Šæ¯”ç‰¹å¸ç™½çš®ä¹¦ã€‹ä¸­æå‡ºâ€œåŒºå—é“¾â€æ¦‚å¿µï¼Œå¹¶åœ¨2009å¹´åˆ›ç«‹äº†æ¯”ç‰¹å¸ç¤¾ä¼šç½‘ç»œï¼Œå¼€å‘å‡ºç¬¬ä¸€ä¸ªåŒºå—ï¼Œå³â€œåˆ›ä¸–åŒºå—â€ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="åŒºå—é“¾" scheme="http://w4lle.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>çƒ­ä¿®å¤æ€»ç»“</title>
    <link href="http://w4lle.com/2017/05/04/hotpatch-summary/"/>
    <id>http://w4lle.com/2017/05/04/hotpatch-summary/</id>
    <published>2017-05-04T10:45:31.000Z</published>
    <updated>2017-05-15T02:51:33.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="çƒ­ä¿®å¤æ€»ç»“"><a href="#çƒ­ä¿®å¤æ€»ç»“" class="headerlink" title="çƒ­ä¿®å¤æ€»ç»“"></a>çƒ­ä¿®å¤æ€»ç»“</h1><table>
<thead>
<tr>
<th style="text-align:center">å¹³å°</th>
<th style="text-align:center">é˜¿é‡Œ AndFix</th>
<th style="text-align:center">é˜¿é‡Œ HotFix1.x</th>
<th style="text-align:center">Nuwa</th>
<th style="text-align:center">å¾®ä¿¡Tinker</th>
<th style="text-align:center">ç¾å›¢Robust</th>
<th style="text-align:center">é˜¿é‡Œ HotFix2.x</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å³æ—¶ç”Ÿæ•ˆ</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">çœ‹æƒ…å†µ</td>
</tr>
<tr>
<td style="text-align:center">æ€§èƒ½æŸè€—</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå¤§</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
</tr>
<tr>
<td style="text-align:center">è¡¥ä¸åŒ…å¤§å°</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">è¾ƒå¤§</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
</tr>
<tr>
<td style="text-align:center">å Romä½“ç§¯</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">è¾ƒå¤§</td>
<td style="text-align:center">è¾ƒå°</td>
<td style="text-align:center">çœ‹æƒ…å†µ</td>
</tr>
<tr>
<td style="text-align:center">æ¥å…¥å¤æ‚åº¦</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">å¤æ‚</td>
<td style="text-align:center">ç®€å•</td>
<td style="text-align:center">ç®€å•</td>
</tr>
<tr>
<td style="text-align:center">å®‰å…¨æ ¡éªŒ</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">ç±»æ›¿æ¢</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">èµ„æºæ›¿æ¢</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">å³å°†æ”¯æŒ</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">soæ›¿æ¢</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">å³å°†æ”¯æŒ</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">å…¨å¹³å°æ”¯æŒ</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">å¼€å‘é€æ˜</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">gradleæ”¯æŒ</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">æ¥å£æ–‡æ¡£</td>
<td style="text-align:center">è¾ƒå°‘</td>
<td style="text-align:center">ä¸°å¯Œ</td>
<td style="text-align:center">è¾ƒå°‘</td>
<td style="text-align:center">ä¸°å¯Œ</td>
<td style="text-align:center">ä¸°å¯Œ</td>
<td style="text-align:center">ä¸°å¯Œ</td>
</tr>
<tr>
<td style="text-align:center">æˆåŠŸç‡</td>
<td style="text-align:center">è¾ƒä½</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">ä¸€èˆ¬</td>
<td style="text-align:center">è¾ƒé«˜</td>
<td style="text-align:center">æœ€é«˜</td>
<td style="text-align:center">è¾ƒé«˜</td>
</tr>
<tr>
<td style="text-align:center">åå°ç®¡ç†</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">åŠ å›ºå…¼å®¹</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">éƒ¨åˆ†å…¼å®¹</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">ä¸ç¡®å®š</td>
</tr>
</tbody>
</table>
<p>ä¸Šè¡¨åŸºæœ¬æ¶µç›–äº†å…·æœ‰ä»£è¡¨æ€§çš„å„ç§çƒ­ä¿®å¤æ–¹æ¡ˆï¼Œæ¶‰åŠåˆ°çš„å„ç§å…³é”®æŒ‡æ ‡çš„æ¨ªå‘å¯¹æ¯”ã€‚</p>
<p>Slider ä¸­å¤§æ¦‚æ€»ç»“äº†å„ç§æ–¹æ¡ˆçš„å®ç°æ–¹å¼ï¼Œä»¥åŠå¸¸è§çš„é—®é¢˜ã€‚</p>
<p>Slider åœ°å€ï¼š <a href="http://w4lle.github.io/sliders/hot-fix/index.html" target="_blank" rel="external">http://w4lle.github.io/sliders/hot-fix/index.html</a></p>
<p>è¯¦ç»†çš„å„ç§æ–¹æ¡ˆåˆ†æï¼š</p>
<ul>
<li><a href="http://w4lle.github.io/2016/03/03/Android%E7%83%AD%E8%A1%A5%E4%B8%81%E4%B9%8BAndFix%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹AndFixåŸç†è§£æ</a></li>
<li><a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a></li>
<li><a href="http://w4lle.github.io/2016/12/16/tinker/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æ</a></li>
<li><a href="http://w4lle.github.io/2017/03/31/robust-0/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
</ul>
<p>æ°´å¹³æœ‰é™ï¼Œéš¾å…æœ‰å†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿äº¤æµã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/05/04/hotpatch-summary/">http://w4lle.com/2017/05/04/hotpatch-summary/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;çƒ­ä¿®å¤æ€»ç»“&quot;&gt;&lt;a href=&quot;#çƒ­ä¿®å¤æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;çƒ­ä¿®å¤æ€»ç»“&quot;&gt;&lt;/a&gt;çƒ­ä¿®å¤æ€»ç»“&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;å¹³å°&lt;/th&gt;
&lt;t
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</title>
    <link href="http://w4lle.com/2017/03/31/robust-0/"/>
    <id>http://w4lle.com/2017/03/31/robust-0/</id>
    <published>2017-03-31T07:58:12.000Z</published>
    <updated>2018-05-29T08:40:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ—©åœ¨16å¹´9æœˆä»½ï¼Œç¾å›¢æŠ€æœ¯å›¢é˜Ÿå°±å†™è¿‡ä¸€ç¯‡æ–‡ç« æè¿° Android çƒ­è¡¥ä¸æ¡†æ¶Robustçš„ç®€å•å®ç°åŸç†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¼€æºï¼›ç„¶ååœ¨17å¹´3æœˆä»½ï¼Œç¾å›¢å›¢é˜Ÿå®£å¸ƒæ­£å¼å¼€æº Robustå¹¶ä¸”é…å¥—äº†è‡ªåŠ¨æ‰“è¡¥ä¸åŒ…å·¥å…·ã€‚æœ¬ç³»åˆ—æ–‡ç« ä¸»è¦è§£æRobustå®ç°åŸç†ï¼Œåˆ†ä¸ºå‡ ä¸ªæ–¹é¢</p>
<ul>
<li>è¡¥ä¸åŠ è½½è¿‡ç¨‹</li>
<li>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹</li>
<li>è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹</li>
</ul>
<p>æœ¬æ–‡ä¸ºç¬¬ä¸€ç¯‡ï¼Œä¸»è¦è®²è§£è¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æç‰ˆæœ¬ <code>0.3.2</code>ã€‚</p>
<a id="more"></a>
<p>ç³»åˆ—æ–‡ç« :</p>
<ul>
<li><a href="http://w4lle.com/2017/03/31/robust-0/">Androidçƒ­è¡¥ä¸ä¹‹RobuståŸç†è§£æ(ä¸€)</a></li>
<li><a href="http://w4lle.com/2018/05/28/robust-1/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆäºŒï¼‰è‡ªåŠ¨åŒ–è¡¥ä¸åŸç†è§£æ</a></li>
<li><a href="http://w4lle.com/2018/05/29/robust-2/">Androidçƒ­è¡¥ä¸ä¹‹Robustï¼ˆä¸‰ï¼‰å‘å’Œè§£</a></li>
</ul>
<h1 id="ä»-InstantRun-è¯´èµ·"><a href="#ä»-InstantRun-è¯´èµ·" class="headerlink" title="ä» InstantRun è¯´èµ·"></a>ä» InstantRun è¯´èµ·</h1><p>ä¸å¾—ä¸è¯´ InstantRun çœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚ç›®å‰ä¸»æµçš„çƒ­ä¿®å¤æ¡†æ¶éƒ½æœ‰æˆ–å¤šæˆ–å°‘çš„å‚è€ƒ InstantRun çš„æŸäº›æŠ€æœ¯ç‚¹ï¼Œæ¯”å¦‚ <a href="https://github.com/Tencent/tinker" target="_blank" rel="external">Tinker</a> çš„å®˜æ–¹æ–‡ç« ä¸­æ˜ç¡®è€ƒè™‘è¿‡ InstantRun ä¸­çš„ Application æ›¿æ¢ï¼Œè™½ç„¶æœ€åæ²¡æœ‰é‡‡ç”¨ï¼Œä½†æ˜¯èº«ä¸ºå…¶å…„å¼Ÿåº“çš„ <a href="http://tinkerpatch.com/Docs/intro" target="_blank" rel="external">TinkerPatch</a> ä¸­ä¸€é”®æ¥å…¥æ–¹æ¡ˆå°±é‡‡ç”¨çš„è¯¥æŠ€æœ¯ç‚¹ã€‚å…³äºè¯¥æŠ€æœ¯ç‚¹ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç«  <a href="http://w4lle.github.io/2017/01/05/one-key-for-tinker/" target="_blank" rel="external">ä¸€é”®æ¥å…¥Tinker</a> ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒInstantRun å¯¹åº”ä¸‰ç§æ›´æ–°æœºåˆ¶ï¼š</p>
<ul>
<li>å†·æ’æ‹”ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé‡å¯æ›´æ–°æœºåˆ¶</li>
<li>æ¸©æ’æ‹”ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé‡å¯Activityæ›´æ–°æœºåˆ¶</li>
<li>çƒ­æ’æ‹”ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºçƒ­æ›´æ–°æœºåˆ¶</li>
</ul>
<p>å¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰ InstantRunï¼Œè¯·å‚è€ƒæˆ‘çš„è¿™ç¯‡æ–‡ç« <a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a></p>
<p>è€Œè¿™ç¯‡æ–‡ç« çš„ä¸»è§’ Robust ï¼Œå…¶çƒ­ä¿®å¤çš„å…³é”®æŠ€æœ¯ç‚¹å°±æ˜¯é‡‡ç”¨äº† InstantRun ä¸­çš„çƒ­æ›´æ–°æœºåˆ¶ï¼Œå¯¹åº”äºå¤š ClassLoader çš„åŠ¨æ€åŠ è½½æ–¹æ¡ˆï¼Œå³ä¸€ä¸ª dex æ–‡ä»¶å¯¹åº”ä¸€ä¸ªæ–°å»º ClassLoader ã€‚</p>
<h1 id="Robust-åŸç†è§£æ"><a href="#Robust-åŸç†è§£æ" class="headerlink" title="Robust åŸç†è§£æ"></a>Robust åŸç†è§£æ</h1><p>Robust çš„åŸç†å¯ä»¥ç®€å•æè¿°ä¸ºï¼š</p>
<ol>
<li>æ‰“åŸºç¡€åŒ…æ—¶æ’æ¡©ï¼Œåœ¨æ¯ä¸ªæ–¹æ³•å‰æ’å…¥ä¸€æ®µç±»å‹ä¸º <code>ChangeQuickRedirect</code> é™æ€å˜é‡çš„é€»è¾‘</li>
<li>åŠ è½½è¡¥ä¸æ—¶ï¼Œä»è¡¥ä¸åŒ…ä¸­è¯»å–è¦æ›¿æ¢çš„ç±»åŠå…·ä½“æ›¿æ¢çš„æ–¹æ³•å®ç°ï¼Œæ–°å»º ClassLoader åŠ è½½è¡¥ä¸dexã€‚</li>
</ol>
<p>æˆ‘ä»¬æ¥åˆ†åˆ«åˆ†æã€‚</p>
<h2 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h2><p>æ‰“åŸºç¡€åŒ…æ—¶ï¼ŒRobust ä¸ºæ¯ä¸ªç±»æ–°å¢äº†ä¸€ä¸ªç±»å‹ä¸º <code>ChangeQuickRedirect</code> çš„é™æ€å˜é‡ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæ–¹æ³•å‰ï¼Œå¢åŠ åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦ä¸ºç©ºçš„é€»è¾‘ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œèµ°æ‰“åŸºç¡€åŒ…æ—¶æ’æ¡©çš„é€»è¾‘ï¼Œå¦åˆ™èµ°æ­£å¸¸é€»è¾‘ã€‚æˆ‘ä»¬åç¼–è¯‘å‡ºåŸºç¡€åŒ…ä¸­çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//SecondActivity</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ChangeQuickRedirect u;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (u != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (PatchProxy.isSupport(<span class="keyword">new</span> Object[]&#123;bundle&#125;, <span class="keyword">this</span>, u, <span class="keyword">false</span>, <span class="number">78</span>)) &#123;</div><div class="line">                PatchProxy.accessDispatchVoid(<span class="keyword">new</span> Object[]&#123;bundle&#125;, <span class="keyword">this</span>, u, <span class="keyword">false</span>, <span class="number">78</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯¹åº”äºè¡¥ä¸æ–‡ä»¶ï¼Œéœ€è¦æœ‰ä¸‰ä¸ªæ–‡ä»¶</p>
<ul>
<li><code>PatchesInfoImpl</code> ç”¨äºè®°å½•ä¿®æ”¹çš„ç±»ï¼ŒåŠå…¶å¯¹åº”çš„ <code>ChangeQuickRedirect</code> æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬åç¼–è¯‘è¡¥ä¸åŒ…å¾—å‡ºä»¥ä¸‹ç»“æœï¼Œå…¶ä¸­çš„ç±»åæ˜¯æ··æ·†åçš„ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchesInfoImpl</span> <span class="keyword">implements</span> <span class="title">PatchesInfo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">getPatchedClassesInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        List arrayList = <span class="keyword">new</span> ArrayList();</div><div class="line">        arrayList.add(<span class="keyword">new</span> PatchedClassInfo(<span class="string">"com.meituan.sample.robusttest.l"</span>, <span class="string">"com.meituan.robust.patch.SampleClassPatchControl"</span>));</div><div class="line">        arrayList.add(<span class="keyword">new</span> PatchedClassInfo(<span class="string">"com.meituan.sample.robusttest.p"</span>, <span class="string">"com.meituan.robust.patch.SuperPatchControl"</span>));</div><div class="line">        arrayList.add(<span class="keyword">new</span> PatchedClassInfo(<span class="string">"com.meituan.sample.SecondActivity"</span>, <span class="string">"com.meituan.robust.patch.SecondActivityPatchControl"</span>));</div><div class="line">        EnhancedRobustUtils.isThrowable = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> arrayList;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>xxxPatchControl</code> æ˜¯ <code>ChangeQuickRedirect</code> æ¥å£çš„å…·ä½“å®ç°ï¼Œæ˜¯ä¸€ä¸ªä»£ç†ï¼Œå…·ä½“çš„æ›¿æ¢æ–¹æ³•æ˜¯åœ¨ <code>xxxPatch</code> ç±»ä¸­</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivityPatchControl</span> <span class="keyword">implements</span> <span class="title">ChangeQuickRedirect</span> </span>&#123;</div><div class="line">...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSupport</span><span class="params">(String methodName, Object[] paramArrayOfObject)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"78:79:90:"</span>.contains(methodName.split(<span class="string">":"</span>)[<span class="number">3</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">accessDispatch</span><span class="params">(String methodName, Object[] paramArrayOfObject)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            SecondActivityPatch secondActivityPatch;</div><div class="line">            ...</div><div class="line">            Object obj = methodName.split(<span class="string">":"</span>)[<span class="number">3</span>];</div><div class="line">            <span class="keyword">if</span> (<span class="string">"78"</span>.equals(obj)) &#123;</div><div class="line">                secondActivityPatch.onCreate((Bundle) paramArrayOfObject[<span class="number">0</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"79"</span>.equals(obj)) &#123;</div><div class="line">                <span class="keyword">return</span> secondActivityPatch.getTextInfo((String) paramArrayOfObject[<span class="number">0</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"90"</span>.equals(obj)) &#123;</div><div class="line">                secondActivityPatch.RobustPubliclambda$onCreate$<span class="number">0</span>((View) paramArrayOfObject[<span class="number">0</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">            th.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆè°ƒç”¨ <code>accessDispatch</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®ä¼ é€’è¿‡æ¥çš„æ–¹æ³•ç­¾åï¼Œè°ƒç”¨<code>xxxPatch</code>çš„ä¿®æ”¹è¿‡çš„æ–¹æ³•ã€‚</p>
<ul>
<li><code>xxxPatch</code> å…·ä½“çš„æ›¿æ¢å®ç°ç±»ï¼Œä»£ç å°±ä¸è´´äº†ã€‚</li>
</ul>
<p>å…¶è¿‡ç¨‹å¯ä»¥ç®€å•æè¿°ä¸ºï¼Œä¸‹å‘è¡¥ä¸åŒ…åï¼Œæ–°å»º DexClassLoader åŠ è½½è¡¥ä¸ dex æ–‡ä»¶ï¼Œåå°„å¾—åˆ° <code>PatchesInfoImpl</code> classï¼Œå¹¶åˆ›å»ºå…¶å¯¹è±¡ï¼Œè°ƒç”¨ <code>getPatchedClassesInfo()</code> æ–¹æ³•å¾—åˆ°å“ªäº›ä¿®æ”¹çš„ç±»ï¼ˆæ¯”å¦‚ SecondActivityï¼‰ï¼Œç„¶åå†é€šè¿‡åå°„å¾ªç¯æ‹¿åˆ°æ¯ä¸ªä¿®æ”¹ç±»åœ¨å½“å‰ç¯å¢ƒä¸­çš„çš„classï¼Œå°†å…¶ä¸­ç±»å‹ä¸º <code>ChangeQuickRedirect</code> çš„é™æ€å˜é‡åå°„ä¿®æ”¹ä¸º <code>xxxPatchControl.java</code> è¿™ä¸ªclass new å‡ºæ¥çš„å¯¹è±¡ã€‚</p>
<p>ç”¨å®˜æ–¹çš„ä¸€ç§å›¾å¾ˆå¥½çš„è¡¨è¾¾äº†æ›¿æ¢åŸç†ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/patching.png" alt="Robust"></p>
<h2 id="è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ"><a href="#è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ" class="headerlink" title="è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ"></a>è¡¥ä¸åŠ è½½è¿‡ç¨‹åˆ†æ</h2><p>demoä¸­çš„è¡¥ä¸åŠ è½½å°±ä¸€å¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> PatchExecutor(getApplicationContext(), <span class="keyword">new</span> PatchManipulateImp(),  <span class="keyword">new</span> Callback()).start();</div></pre></td></tr></table></figure>
<p><code>PatchExecutor</code> æ˜¯ä¸ª Thread</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">public class PatchExecutor extends Thread &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        ...</div><div class="line">        applyPatchList(patches);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * åº”ç”¨è¡¥ä¸åˆ—è¡¨</div><div class="line">     */</div><div class="line">    protected void applyPatchList(List&lt;Patch&gt; patches) &#123;</div><div class="line">        ...</div><div class="line">        for (Patch p : patches) &#123;</div><div class="line">            ...</div><div class="line">            currentPatchResult = patch(context, p);</div><div class="line">            ...</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    protected boolean patch(Context context, Patch patch) &#123;</div><div class="line">        ...</div><div class="line">        DexClassLoader classLoader = new DexClassLoader(patch.getTempPath(), context.getCacheDir().getAbsolutePath(),</div><div class="line">                null, PatchExecutor.class.getClassLoader());</div><div class="line">        patch.delete(patch.getTempPath());</div><div class="line">        ...</div><div class="line">        try &#123;</div><div class="line">            patchsInfoClass = classLoader.loadClass(patch.getPatchesInfoImplClassFullName());</div><div class="line">            patchesInfo = (PatchesInfo) patchsInfoClass.newInstance();</div><div class="line">            &#125; catch (Throwable t) &#123;</div><div class="line">             ...</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        for (PatchedClassInfo patchedClassInfo : patchedClasses) &#123;</div><div class="line">            ...</div><div class="line">            try &#123;</div><div class="line">                oldClass = classLoader.loadClass(patchedClassName.trim());</div><div class="line">                Field[] fields = oldClass.getDeclaredFields();</div><div class="line">                for (Field field : fields) &#123;</div><div class="line">                    if (TextUtils.equals(field.getType().getCanonicalName(), ChangeQuickRedirect.class.getCanonicalName()) &amp;&amp; TextUtils.equals(field.getDeclaringClass().getCanonicalName(), oldClass.getCanonicalName())) &#123;</div><div class="line">                        changeQuickRedirectField = field;</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                ...</div><div class="line">                try &#123;</div><div class="line">                    patchClass = classLoader.loadClass(patchClassName);</div><div class="line">                    Object patchObject = patchClass.newInstance();</div><div class="line">                    changeQuickRedirectField.setAccessible(true);</div><div class="line">                    changeQuickRedirectField.set(null, patchObject);</div><div class="line">                    &#125; catch (Throwable t) &#123;</div><div class="line">                    ...</div><div class="line">                &#125;</div><div class="line">            &#125; catch (Throwable t) &#123;</div><div class="line">                 ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œé€šè¿‡æŒ‡å®šçš„è·¯å¾„å»è¯»patchæ–‡ä»¶çš„jaråŒ…ï¼Œpatchæ–‡ä»¶å¯ä»¥ä¸ºå¤šä¸ªï¼Œæ¯ä¸ªpatchæ–‡ä»¶å¯¹åº”ä¸€ä¸ª DexClassLoader å»åŠ è½½ï¼Œæ¯ä¸ªpatchæ–‡ä»¶ä¸­å­˜åœ¨PatchInfoImpï¼Œé€šè¿‡éå†å…¶ä¸­çš„ç±»ä¿¡æ¯è¿›è€Œåå°„ä¿®æ”¹å…¶ä¸­ <code>ChangeQuickRedirect</code> å¯¹è±¡çš„å€¼ã€‚</p>
<h2 id="åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ"><a href="#åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ" class="headerlink" title="åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ"></a>åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹åˆ†æ</h2><p>ç±»ä¼¼ InstantRun ï¼Œ Robust ä¹Ÿæ˜¯ä½¿ç”¨ Transform API ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶ï¼Œè¯¥ API å…è®¸ç¬¬ä¸‰æ–¹æ’ä»¶åœ¨  .class æ–‡ä»¶æ‰“åŒ…ä¸º dex æ–‡ä»¶ä¹‹å‰æ“ä½œç¼–è¯‘å¥½çš„ .class å­—èŠ‚ç æ–‡ä»¶ã€‚</p>
<p>Robust ä¸­çš„ <code>Gradle-Plugin</code> å°±æ˜¯æ“ä½œå­—èŠ‚ç çš„åä¸º <code>robust</code> çš„ gradle æ’ä»¶é¡¹ç›®ã€‚æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸‹å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RobustTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project target)</span> </span>&#123;</div><div class="line">            <span class="comment">//è§£æé¡¹ç›®ä¸‹robust.xmlé…ç½®æ–‡ä»¶</span></div><div class="line">            robust = <span class="keyword">new</span> XmlSlurper().parse(<span class="keyword">new</span> File(<span class="string">"$&#123;project.projectDir&#125;/$&#123;Constants.ROBUST_XML&#125;"</span>))</div><div class="line">            ...</div><div class="line">            project.android.registerTransform(<span class="keyword">this</span>)</div><div class="line">            project.afterEvaluate(<span class="keyword">new</span> RobustApkHashAction())</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transform</span><span class="params">(Context context, Collection&lt;TransformInput&gt; inputs, Collection&lt;TransformInput&gt; referencedInputs, TransformOutputProvider outputProvider, <span class="keyword">boolean</span> isIncremental)</span> <span class="keyword">throws</span> IOException, TransformException, InterruptedException </span>&#123;</div><div class="line">    ...</div><div class="line">    ClassPool classPool = <span class="keyword">new</span> ClassPool()</div><div class="line">    project.android.bootClasspath.each &#123;</div><div class="line">        logger.debug <span class="string">"android.bootClasspath   "</span> + (String) it.absolutePath</div><div class="line">        classPool.appendClassPath((String) it.absolutePath)</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    def box = ConvertUtils.toCtClasses(inputs, classPool)</div><div class="line">    insertRobustCode(box, jarFile)</div><div class="line">    writeMap2File(methodMap, Constants.METHOD_MAP_OUT_PATH)</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè¯»å– robust.xml é…ç½®æ–‡ä»¶å¹¶åˆå§‹åŒ–ï¼Œå¯é…ç½®é€‰é¡¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä¸€äº›å¼€å…³é€‰é¡¹</li>
<li>éœ€è¦çƒ­è¡¥ä¸çš„åŒ…åæˆ–è€…ç±»åï¼Œè¿™äº›åŒ…åä¸‹çš„æ‰€æœ‰ç±»éƒ½è¢«ä¼šæ’å…¥ä»£ç </li>
<li>ä¸éœ€è¦çƒ­è¡¥çš„åŒ…åæˆ–è€…ç±»åï¼Œå¯ä»¥åœ¨éœ€è¦çƒ­è¡¥çš„åŒ…ä¸­å‰”é™¤æŒ‡å®šçš„ç±»æˆ–è€…åŒ…</li>
</ul>
<p>ç„¶åé€šè¿‡ <code>Transform</code> API è°ƒç”¨ <code>transform()</code> æ–¹æ³•ï¼Œæ‰«ææ‰€æœ‰ç±»åŠ å…¥åˆ° <code>classPool</code> ä¸­ï¼Œè°ƒç”¨ <code>insertRobustCode()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="function">def <span class="title">insertRobustCode</span><span class="params">(List&lt;CtClass&gt; box, File jarFile)</span> </span>&#123;</div><div class="line">    ZipOutputStream outStream=<span class="keyword">new</span> JarOutputStream(<span class="keyword">new</span> FileOutputStream(jarFile));</div><div class="line">    <span class="keyword">new</span> ForkJoinPool().submit &#123;</div><div class="line">        box.each &#123; ctClass -&gt;</div><div class="line">            <span class="keyword">if</span> (isNeedInsertClass(ctClass.getName())) &#123;</div><div class="line">               <span class="comment">//å°†classè®¾ç½®ä¸ºpublic ctClass.setModifiers(AccessFlag.setPublic(ctClass.getModifiers()))</span></div><div class="line">                <span class="keyword">boolean</span> addIncrementalChange = <span class="keyword">false</span>;</div><div class="line">                ctClass.declaredBehaviors.findAll &#123;</div><div class="line">                <span class="comment">//è§„é¿æ¥å£å’Œæ— æ–¹æ³•ç±»</span></div><div class="line">                    <span class="keyword">if</span> (ctClass.isInterface() || ctClass.declaredMethods.length &lt; <span class="number">1</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (!addIncrementalChange) &#123;</div><div class="line">                    <span class="comment">//æ’å…¥ public static ChangeQuickRedirect changeQuickRedirect;</span></div><div class="line">                        addIncrementalChange = <span class="keyword">true</span>;</div><div class="line">                        ClassPool classPool = it.declaringClass.classPool</div><div class="line">                        CtClass type = classPool.getOrNull(Constants.INTERFACE_NAME);</div><div class="line">                        CtField ctField = <span class="keyword">new</span> CtField(type, Constants.INSERT_FIELD_NAME, ctClass);</div><div class="line">                        ctField.setModifiers(AccessFlag.PUBLIC | AccessFlag.STATIC)</div><div class="line">                        ctClass.addField(ctField)</div><div class="line">                        logger.debug <span class="string">"ctClass: "</span> + ctClass.getName();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (it.getMethodInfo().isStaticInitializer()) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// synthetic æ–¹æ³•æš‚æ—¶ä¸aop æ¯”å¦‚AsyncTask ä¼šç”Ÿæˆä¸€äº›åŒå syntheticæ–¹æ³•,å¯¹synthetic ä»¥åŠprivateçš„æ–¹æ³•ä¹Ÿæ’å…¥çš„ä»£ç ï¼Œä¸»è¦æ˜¯é’ˆå¯¹lambdaè¡¨è¾¾å¼</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.SYNTHETIC) != <span class="number">0</span> &amp;&amp; !AccessFlag.isPrivate(it.getModifiers())) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//ä¸æ”¯æŒæ„é€ æ–¹æ³•</span></div><div class="line">                    <span class="keyword">if</span> (it.getMethodInfo().isConstructor()) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//è§„é¿æŠ½è±¡æ–¹æ³•</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.ABSTRACT) != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//è§„é¿NATIVEæ–¹æ³•</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.NATIVE) != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//è§„é¿æ¥å£</span></div><div class="line">                    <span class="keyword">if</span> ((it.getModifiers() &amp; AccessFlag.INTERFACE) != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (it.getMethodInfo().isMethod()) &#123;</div><div class="line">                        <span class="keyword">if</span> (AccessFlag.isPackage(it.modifiers)) &#123;</div><div class="line">                            it.setModifiers(AccessFlag.setPublic(it.modifiers))</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰æ–¹æ³•è°ƒç”¨ï¼Œè¿”å›æ˜¯å¦æ’åº„</span></div><div class="line">                        <span class="keyword">boolean</span> flag = modifyMethodCodeFilter(it)</div><div class="line">                        <span class="keyword">if</span> (!flag) &#123;</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//æ–¹æ³•è¿‡æ»¤</span></div><div class="line">                    <span class="keyword">if</span> (isExceptMethodLevel &amp;&amp; exceptMethodList != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">for</span> (String exceptMethod : exceptMethodList) &#123;</div><div class="line">                            <span class="keyword">if</span> (it.name.matches(exceptMethod)) &#123;</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (isHotfixMethodLevel &amp;&amp; hotfixMethodList != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">for</span> (String name : hotfixMethodList) &#123;</div><div class="line">                            <span class="keyword">if</span> (it.name.matches(name)) &#123;</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">true</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> !isHotfixMethodLevel</div><div class="line">                &#125;.each &#123; ctBehavior -&gt;</div><div class="line">                    <span class="comment">// methodMap must be put here</span></div><div class="line">                    methodMap.put(ctBehavior.longName, insertMethodCount.incrementAndGet());</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (ctBehavior.getMethodInfo().isMethod()) &#123;</div><div class="line">                            <span class="keyword">boolean</span> isStatic = ctBehavior.getModifiers() &amp; AccessFlag.STATIC;</div><div class="line">                            CtClass returnType = ctBehavior.getReturnType0();</div><div class="line">                            String returnTypeString = returnType.getName();</div><div class="line">                            def body = <span class="string">"if ($&#123;Constants.INSERT_FIELD_NAME&#125; != null) &#123;"</span></div><div class="line">                            body += <span class="string">"Object argThis = null;"</span></div><div class="line">                            <span class="keyword">if</span> (!isStatic) &#123;</div><div class="line">                                body += <span class="string">"argThis = \$0;"</span></div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            body += <span class="string">"   if (com.meituan.robust.PatchProxy.isSupport(\$args, argThis, $&#123;Constants.INSERT_FIELD_NAME&#125;, $isStatic, "</span> + methodMap.get(ctBehavior.longName) + <span class="string">")) &#123;"</span></div><div class="line">                            body += getReturnStatement(returnTypeString, isStatic, methodMap.get(ctBehavior.longName));</div><div class="line">                            body += <span class="string">"   &#125;"</span></div><div class="line">                            body += <span class="string">"&#125;"</span></div><div class="line">                            ctBehavior.insertBefore(body);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t ) &#123;</div><div class="line">                        logger.error <span class="string">"ctClass: "</span> + ctClass.getName() + <span class="string">" error: "</span> + t.toString();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                &#125;</div><div class="line">            zipFile(ctClass.toBytecode(),outStream,ctClass.name.replaceAll(<span class="string">"\\."</span>,<span class="string">"/"</span>)+<span class="string">".class"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;.get()</div><div class="line">    outStream.close();</div><div class="line">    logger.debug <span class="string">"robust insertMethodCount: "</span> + insertMethodCount.get()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>å°†classè®¾ç½®ä¸ºpublic</li>
<li>è§„é¿ æ¥å£</li>
<li>è§„é¿ æ— æ–¹æ³•ç±»</li>
<li>è§„é¿ æ„é€ æ–¹æ³•</li>
<li>è§„é¿ æŠ½è±¡æ–¹æ³•</li>
<li>è§„é¿ nativeæ–¹æ³•</li>
<li>è§„é¿ syntheticæ–¹æ³•</li>
<li>è¿‡æ»¤é…ç½®æ–‡ä»¶ä¸­ä¸éœ€è¦ä¿®å¤çš„ç±»</li>
<li>é€šè¿‡ javassist åœ¨ç±»ä¸­æ’å…¥ <code>public static ChangeQuickRedirect changeQuickRedirect;</code></li>
<li>é€šè¿‡ javassist åœ¨æ–¹æ³•ä¸­æ’å…¥é€»è¾‘ä»£ç æ®µ</li>
<li>é€šè¿‡ zipFile() æ–¹æ³•å†™å›classæ–‡ä»¶</li>
</ul>
<p>æœ€åè°ƒç”¨ <code>writeMap2File()</code> å°†æ’æ¡©çš„æ–¹æ³•ä¿¡æ¯å†™å…¥ robust/methodsMap.robust æ–‡ä»¶ä¸­ï¼Œæ­¤æ–‡ä»¶å’Œæ··æ·†çš„mappingæ–‡ä»¶éœ€è¦å¤‡ä»½ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åˆ°è¿™é‡Œæœ¬ç¯‡æ–‡ç« ç»“æŸï¼Œä¸»è¦è®²äº†ä¸‹åŸºç¡€åŸç†ã€è¡¥ä¸åŠ è½½æµç¨‹å’Œæ’æ¡©è¿‡ç¨‹ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•çš„å¯¹ Robust åšä¸‹æ€»ç»“ã€‚</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç”±äºä½¿ç”¨å¤šClassLoaderæ–¹æ¡ˆï¼ˆè¡¥ä¸ä¸­æ— æ–°å¢Activityï¼Œæ‰€ä»¥ä¸ç®—æ¿€è¿›ç±»å‹çš„åŠ¨æ€åŠ è½½ï¼Œæ— éœ€hook systemï¼‰ï¼Œå…¼å®¹æ€§å’Œç¨³å®šæ€§æ›´å¥½ï¼Œä¸å­˜åœ¨preverifyçš„é—®é¢˜</li>
<li>ç”±äºé‡‡ç”¨ InstantRun çš„çƒ­æ›´æ–°æœºåˆ¶ï¼Œæ‰€ä»¥å¯ä»¥å³æ—¶ç”Ÿæ•ˆï¼Œä¸éœ€è¦é‡å¯</li>
<li>æ”¯æŒAndroid2.3-7.Xç‰ˆæœ¬</li>
<li>å¯¹æ€§èƒ½å½±å“è¾ƒå°ï¼Œä¸éœ€è¦åˆæˆpatch</li>
<li>æ”¯æŒæ–¹æ³•çº§åˆ«çš„ä¿®å¤ï¼Œæ”¯æŒé™æ€æ–¹æ³•</li>
<li>æ”¯æŒæ–°å¢æ–¹æ³•å’Œç±»</li>
<li>æ”¯æŒProGuardçš„æ··æ·†ã€å†…è”ã€ç¼–è¯‘å™¨ä¼˜åŒ–åå¼•èµ·çš„é—®é¢˜(æ¡¥æ–¹æ³•ã€lambdaã€å†…éƒ¨ç±»ç­‰)ç­‰æ“ä½œ</li>
</ul>
<p>å½“ç„¶ï¼Œæœ‰ä¼˜ç‚¹å°±ä¼šæœ‰ç¼ºç‚¹ï¼š</p>
<ul>
<li>æš‚æ—¶ä¸æ”¯æŒæ–°å¢å­—æ®µï¼Œä½†å¯ä»¥é€šè¿‡æ–°å¢ç±»è§£å†³</li>
<li>æš‚æ—¶ä¸æ”¯æŒä¿®å¤æ„é€ æ–¹æ³•ï¼Œå·²ç»åœ¨å†…æµ‹</li>
<li>æš‚æ—¶ä¸æ”¯æŒèµ„æºå’Œ so ä¿®å¤ï¼Œä¸è¿‡è¿™ä¸ªé—®é¢˜ä¸å¤§ï¼Œå› ä¸ºç‹¬ç«‹äº dex è¡¥ä¸ï¼Œå·²ç»æœ‰å¾ˆæˆç†Ÿçš„æ–¹æ¡ˆäº†ï¼Œå°±çœ‹æ€ä¹ˆæ‰“åˆ°è¡¥ä¸åŒ…ä¸­ä»¥åŠ diff æ–¹æ¡ˆã€‚</li>
<li>å¯¹äºè¿”å›å€¼æ˜¯ this çš„æ–¹æ³•æ”¯æŒä¸å¤ªå¥½</li>
<li><strong>æ²¡æœ‰å®‰å…¨æ ¡éªŒï¼Œéœ€è¦å¼€å‘è€…åœ¨åŠ è½½è¡¥ä¸ä¹‹å‰è‡ªå·±åšéªŒè¯</strong></li>
<li>å¯èƒ½ä¼šå‡ºç°æ·±åº¦æ–¹æ³•å†…è”å¯¼è‡´çš„ä¸å¯é¢„çŸ¥çš„é”™è¯¯(å‡ ç‡å¾ˆå°å¯ä»¥å¿½ç•¥)</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼ŒRobustæ˜¯å¯ç”¨çš„ã€é«˜ç¨³å®šæ€§çš„ã€æˆåŠŸç‡å¾ˆé«˜ï¼ˆå®˜æ–¹è¯´99.9%ï¼‰çš„ã€æ— ä¾µå…¥çš„ä¸€æ¬¾ä¼˜ç§€çš„çƒ­ä¿®å¤æ¡†æ¶ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="http://tech.meituan.com/android_robust.html" target="_blank" rel="external">Androidçƒ­æ›´æ–°æ–¹æ¡ˆRobust</a></li>
<li><a href="http://tech.meituan.com/android_autopatch.html" target="_blank" rel="external">Androidçƒ­æ›´æ–°æ–¹æ¡ˆRobustå¼€æºï¼Œæ–°å¢è‡ªåŠ¨åŒ–è¡¥ä¸å·¥å…·
</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/26036302" target="_blank" rel="external">çƒ­ä¿®å¤æ¡†æ¶ç ”ç©¶ä¹‹RobuståŸç†</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/03/31/robust-0/">http://w4lle.com/2017/03/31/robust-0/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ—©åœ¨16å¹´9æœˆä»½ï¼Œç¾å›¢æŠ€æœ¯å›¢é˜Ÿå°±å†™è¿‡ä¸€ç¯‡æ–‡ç« æè¿° Android çƒ­è¡¥ä¸æ¡†æ¶Robustçš„ç®€å•å®ç°åŸç†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¼€æºï¼›ç„¶ååœ¨17å¹´3æœˆä»½ï¼Œç¾å›¢å›¢é˜Ÿå®£å¸ƒæ­£å¼å¼€æº Robustå¹¶ä¸”é…å¥—äº†è‡ªåŠ¨æ‰“è¡¥ä¸åŒ…å·¥å…·ã€‚æœ¬ç³»åˆ—æ–‡ç« ä¸»è¦è§£æRobustå®ç°åŸç†ï¼Œåˆ†ä¸ºå‡ ä¸ªæ–¹é¢&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¡¥ä¸åŠ è½½è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;åŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;è¡¥ä¸åŒ…ç”Ÿæˆè¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ¬æ–‡ä¸ºç¬¬ä¸€ç¯‡ï¼Œä¸»è¦è®²è§£è¡¥ä¸åŠ è½½è¿‡ç¨‹å’ŒåŸºç¡€åŒ…æ’æ¡©è¿‡ç¨‹ï¼Œåˆ†æç‰ˆæœ¬ &lt;code&gt;0.3.2&lt;/code&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>å†è§ï¼Œè–„è·ï¼</title>
    <link href="http://w4lle.com/2017/03/08/goodbye-boohee/"/>
    <id>http://w4lle.com/2017/03/08/goodbye-boohee/</id>
    <published>2017-03-07T16:00:00.000Z</published>
    <updated>2017-03-08T12:56:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>2015.3.23 - 2017.3.8 </p>
<p>ä¸¤å¹´æ—¶å…‰ï¼ŒåŒ†åŒ†è€Œé€ã€‚</p>
<p>æ¥åˆ°è–„è·å·²ç»ä¸¤å¹´æ—¶é—´ï¼Œè¯´é•¿ä¸é•¿ï¼Œè¯´çŸ­ä¸çŸ­ã€‚</p>
<a id="more"></a>
<p>ä¸¤å¹´æ¥åœ¨å…¬å¸ä¹Ÿæˆé•¿äº†å¾ˆå¤šï¼ŒåŒ…æ‹¬æŠ€æœ¯å’ŒæŠ€æœ¯ä»¥å¤–çš„å…¶ä»–ä¸œè¥¿ã€‚</p>
<p>è–„è·æ˜¯å¾ˆæ³¨é‡æŠ€æœ¯æ°›å›´çš„å…¬å¸ï¼Œæˆ‘ä»¬çš„æŠ€æœ¯å›¢é˜Ÿæ˜¯æˆ‘å·¥ä½œä»¥æ¥æŠ€æœ¯æ°›å›´æœ€ä¸ºæµ“åšçš„å›¢é˜Ÿï¼Œå…·ä½“ä½“ç°åœ¨æ¯å‘¨ä¸‰æ™šçš„æŠ€æœ¯åˆ†äº«å’Œæ¯å‘¨æœ«æ¯äººä¸€ç¯‡çš„æŠ€æœ¯åšå®¢ã€‚åšæŒå†™ä½œæ˜¯è–„è·é•¿ä¹…ä»¥æ¥çš„ä¼˜ç§€ä¼ ç»Ÿï¼Œæˆ‘ä¹‹å‰ä¸€ç›´åœ¨CSDNå†™åšå®¢ï¼Œéš”ä¸‰å·®äº”å†™ä¸€ç¯‡æœ‰æ—¶å€™ä¸å¤Ÿç§¯æï¼Œä½†æ˜¯ä»åŠ å…¥è–„è·åå†™ä½œçš„ç§¯ææ€§ä¹Ÿæœ‰äº†æé«˜ï¼Œä¸ªäººåšå®¢ä»2016å¹´æ­å»ºè‡³ä»Šä¹ŸæŒç»­å†™äº†ä¸€äº›æ–‡ç« ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€äº›è´¨é‡è¿˜ä¸é”™çš„æ–‡ç« è¢«å¹¿æ³›é˜…è¯»ï¼Œä¸€å¹´çš„æ—¶é—´åšå®¢ä¹Ÿæœ‰äº†6wçš„è®¿é—®é‡ï¼Œè™½ç„¶ä¸å¤šï¼Œå¯¹æˆ‘æ¥è¯´ä¹Ÿæ˜¯ä¸€ç§æ¿€åŠ±ï¼Œè¯´æ˜åˆ†äº«çš„ä¸œè¥¿ä¹Ÿä¼šå¯¹åˆ«äººæœ‰ç”¨ã€‚</p>
<p>è‡³äºAndroidç»„ï¼Œæˆ‘ä»¬æœ‰å……åˆ†è‡ªç”±çš„æŠ€æœ¯æ ˆé€‰æ‹©ï¼Œåœ¨å¯ç”¨æ€§å’Œç¨³å®šæ€§çš„å‰æä¸‹ï¼Œéƒ½å¯ä»¥å¼•å…¥é¡¹ç›®ä¸­ä½¿ç”¨ã€‚åœ¨è¿™ä¸¤å¹´æ—¶é—´é‡Œï¼Œæˆ‘ä¹Ÿä¸»åŠ¨æ‰¿æ‹…äº†ä¸€äº›åŸºç¡€å·¥ä½œï¼Œæ…¢æ…¢ä¹Ÿæˆé•¿ä¸ºAndroidç»„çš„è´Ÿè´£äººï¼Œæœ‰ä»˜å‡ºå°±ä¼šæœ‰å›æŠ¥ï¼Œä¸ç”¨ç€æ€¥ï¼Œæƒ³è¦çš„ï¼Œæ—¶å…‰éƒ½ä¼šç»™ä½ ã€‚ä¸¤å¹´æ—¶é—´æ›´æ–°äº†å¤šå°‘ç‰ˆæœ¬å·²ç»è®°ä¸å¾—ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªç‰ˆæœ¬æ›´æ–°éƒ½æœ‰æˆ‘çš„ä»˜å‡ºã€‚æœ‰è¿‡å¼€å¿ƒï¼Œæœ‰è¿‡å¤±è½ï¼Œä¸ç®¡æ€æ ·ï¼Œè¿™æ®µå·¥ä½œå·²ç»è¿‡å»ï¼Œä»˜å‡ºçš„æ±—æ°´ç»ˆç©¶æ²¡æœ‰ç™½è´¹ã€‚</p>
<p>è¦æ„Ÿè°¢stormzhangå¯¹æˆ‘å·¥ä½œçš„ä¿¡ä»»å’Œå¸®åŠ©ï¼Œä¹Ÿè¦è°¢è°¢skykaiã€loodyã€ttdevsè¿™äº›å°ä¼™ä¼´ä»¬ï¼Œæ˜¯å¤§å®¶çš„å·¥ä½œæ€åº¦è®©æˆ‘ä»¬è¿™ä¸ªå›¢é˜Ÿè¿™ä¹ˆæœ‰å‡èšåŠ›ã€‚æ¯å½“åˆ«äººé—®èµ·ä½ å¿ƒä¸­çš„ç†æƒ³å›¢é˜Ÿæ˜¯ä»€ä¹ˆæ ·å­ï¼Œæˆ‘éƒ½ä¼šæ¯«ä¸çŠ¹è±«çš„å›ç­”ï¼Œæˆ‘ç°åœ¨æ‰€åœ¨çš„å›¢é˜Ÿå°±æ˜¯æˆ‘å‘å¾€çš„å›¢é˜Ÿã€‚å¤§å®¶å¯¹æŠ€æœ¯çš„çƒ­æƒ…ï¼Œå·¥ä½œçš„ç§¯ææ€åº¦ï¼Œå›¢é˜Ÿè¶³å¤Ÿopençš„æ°›å›´ï¼Œé‡åˆ°é—®é¢˜æ°¸ä¸æœè¾“çš„ç²¾ç¥ï¼Œç”Ÿæ´»ä¸­çš„äº’ç›¸å¸®åŠ©ï¼Œç¢°å·§ä¹Ÿæœ‰å…±åŒçš„çˆ±å¥½ï¼Œæˆ‘è¯´è¿™å°±æ˜¯æˆ‘ç†æƒ³çš„å›¢é˜Ÿã€‚</p>
<p>åœ¨è–„è·çš„è¿™ä¸¤å¹´ï¼Œä¹Ÿå®Œæˆäº†äººç”Ÿä¸­çš„ä¸¤ä»¶å¤§äº‹ã€‚ç»“å©šã€ç”Ÿå­ã€‚æˆ‘å¾ˆæ„Ÿæ©ã€‚æ„Ÿæ©æœ‰ä¸ªè´¤æƒ çš„åª³å¦‡å„¿ï¼Œæ„Ÿæ©æˆ‘ä»¬æœ‰å¥åº·æ¼‚äº®çš„å°jojoï¼Œè‡ªä»æœ‰äº†jojoæˆ‘ä»¬å®¶æ¬¢ç¬‘å°±æ²¡æ–­è¿‡ï¼Œæ¯å¤©å“ˆå“ˆå“ˆã€‚ç”·äººä¸å°±æ˜¯è¿™æ ·ï¼Œå¦»å„¿è€å°ä¸€äººæ‰›ï¼Œå®¶åº­å¹¸ç¦æ¯”å•¥éƒ½å¼ºã€‚å¸Œæœ›æ—¶é—´å¯ä»¥æ…¢ç‚¹èµ°ï¼Œæˆ‘ä»¬çš„å°jojoæ…¢æ…¢å¥åº·é•¿å¤§ï¼Œè®©æˆ‘ä»¬å¤šäº«å—å°jojoæˆé•¿å¸¦ç»™æˆ‘ä»¬çš„å¿«ä¹ã€‚</p>
<p>ç”±äºä¸ªäººåŸå› ç¦»å¼€å…¬å¸ï¼Œä»Šå¤©ä¸‹åˆåŠçš„ç¦»èŒæ‰‹ç»­ï¼Œä¸´èµ°ä¹‹å‰ï¼Œæäº¤äº†æœ€åä¸€è¡Œä»£ç ï¼Œcommit messageæ˜¯â€œGoodbyeâ€ã€‚å›¢é˜Ÿå°ä¼™ä¼´ä»¬ä¸€ç›´æŠŠæˆ‘é€åˆ°åœ°é“ç«™æ‰ç¦»å»ï¼Œæˆ‘çš„å¿ƒé‡Œä¹Ÿæ˜¯å¾ˆå¤šä¸èˆï¼Œä½†æ˜¯äººç”Ÿä¸å°±æ˜¯è¿™æ ·ä¹ˆï¼Œå¤©ä¸‹æ²¡æœ‰ä¸æ•£çš„ç­µå¸­ï¼Œåªèƒ½å¿ƒä¸­é»˜å¿µç¥å¤§å®¶éƒ½å¥½ï¼</p>
<p>è™½ç„¶æœ‰äº›ä¸èˆï¼Œä½†æˆ‘å¿ƒé‡Œæ›´å¤šçš„æ˜¯å¯¹æ–°ç”Ÿæ´»çš„æœŸå¾…ï¼ŒæœŸå¾…ç¾å¥½çš„æ˜å¤©ï¼ŒæœŸå¾…ç»™å®¶äººä¸€ä¸ªç¨³å®šçš„å®¶ï¼ŒæœŸå¾…ç®€å•çš„ç¨³ç¨³çš„å¹¸ç¦ã€‚æœŸå¾…çˆ¶æ¯èº«ä½“å¥åº·ï¼ŒæœŸå¾…è€å©†è´¤æƒ æ¼‚äº®ï¼ŒæœŸå¾…jojoå¥åº·æˆé•¿ã€‚æœŸå¾…æ°¸è¿œå¹´è½»ï¼Œæ°¸è¿œçƒ­æ³ªç›ˆçœ¶ï¼Œæ°¸è¿œç›¸ä¿¡æ¢¦æƒ³ã€‚</p>
<p>å·²ç»è¿œå»çš„ï¼Œå¸¦ç€ç¾å¥½è®°å¿†æŒ¥æŒ¥æ‰‹è¯´å£°æ‹œæ‹œã€‚</p>
<p>å°†è¦åˆ°æ¥çš„ï¼Œæ€€ç€æœŸå¾…å¼ å¼€åŒæ‰‹è¿æ¥æœªæ¥ã€‚</p>
<p>å†è§ï¼Œè–„è·ã€‚</p>
<p>ä½ å¥½ï¼Œæ˜å¤©ã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/03/08/goodbye-boohee/">http://w4lle.com/2017/03/08/goodbye-boohee/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2015.3.23 - 2017.3.8 &lt;/p&gt;
&lt;p&gt;ä¸¤å¹´æ—¶å…‰ï¼ŒåŒ†åŒ†è€Œé€ã€‚&lt;/p&gt;
&lt;p&gt;æ¥åˆ°è–„è·å·²ç»ä¸¤å¹´æ—¶é—´ï¼Œè¯´é•¿ä¸é•¿ï¼Œè¯´çŸ­ä¸çŸ­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å…¶ä»–" scheme="http://w4lle.com/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>Gradleæ¨¡å—åŒ–é…ç½®</title>
    <link href="http://w4lle.com/2017/01/22/gradle-modules/"/>
    <id>http://w4lle.com/2017/01/22/gradle-modules/</id>
    <published>2017-01-22T01:53:37.000Z</published>
    <updated>2017-01-23T00:56:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä»¥<a href="https://github.com/shwenzhang/AndResGuard" target="_blank" rel="external">AndResGuard</a>å’Œ<a href="https://github.com/Tencent/tinker" target="_blank" rel="external">Tinker</a>ä¸ºä¾‹è®²è§£ä¸‹å¦‚ä½•æ¨¡å—åŒ–é…ç½®Gradleï¼Œä»¥åŠä¸€é”®æ‰“Tinkerè¡¥ä¸åŒ…çš„å®ç°æ–¹æ³•ã€‚<br><a id="more"></a></p>
<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>éšç€é¡¹ç›®è¶Šæ¥è¶Šå¤§ï¼Œå¼•ç”¨ç¬¬ä¸‰æ–¹åº“çš„gradleæ„ˆæ¥æ„ˆå¤šï¼Œappçš„build.gradleæ–‡ä»¶ä¹Ÿè¶Šæ¥è¶Šé•¿ï¼Œæ‹¿è–„è·Appä¸ºä¾‹å·²ç»è¾¾åˆ°äº†1000è¡Œå·¦å³ï¼Œä¸€å¤§å¨ä»£ç èµ›åœ¨ä¸€èµ·çœ‹èµ·æ¥å¾ˆä¸çˆ½ã€‚å¹¶ä¸”å°†ç¬¬ä¸‰æ–¹åº“çš„é…ç½®ç§»æ¤åˆ°æ–°é¡¹ç›®ä¹Ÿå¾ˆå›°éš¾ï¼Œç¨å¾®ä¸æ³¨æ„å°±ä¼šå‡ºé”™ã€‚</p>
<h1 id="AndResGuardé…ç½®"><a href="#AndResGuardé…ç½®" class="headerlink" title="AndResGuardé…ç½®"></a>AndResGuardé…ç½®</h1><p>é¦–å…ˆæ–°å»ºresguard.gradleæ–‡ä»¶ï¼Œé…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'AndResGuard'</span></div><div class="line">andResGuard &#123;</div><div class="line">    use7zip = <span class="keyword">true</span></div><div class="line">    useSign = <span class="keyword">true</span></div><div class="line">    keepRoot = <span class="keyword">false</span></div><div class="line">    whiteList&#123;...&#125;</div><div class="line">    compressFilePattern&#123;...&#125;</div><div class="line">    sevenzip&#123;...&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ä¸»é¡¹ç›®çš„build.gradleä¸­åŠ å…¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">apply from: <span class="string">'../resguard.gradle'</span></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath (<span class="string">'com.tencent.mm:AndResGuard-gradle-plugin:1.1.16'</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±é…ç½®å¥½äº†ï¼Œå­Projectä¾èµ–resguardè„šæœ¬ï¼Œsyncä¸‹å°±èƒ½çœ‹åˆ°resguard Taskäº†ã€‚é‚£ä¹ˆç§»æ¤åˆ°æ–°é¡¹ç›®åªéœ€è¦æŠŠresguard.gradleæ‹·è´è¿‡å»å°±okäº†ã€‚</p>
<h1 id="Tinkeré…ç½®"><a href="#Tinkeré…ç½®" class="headerlink" title="Tinkeré…ç½®"></a>Tinkeré…ç½®</h1><p>ç”±äºè¦é…åˆAndResGuardä½¿ç”¨ï¼ŒTinkerçš„gradleé…ç½®ç›¸å¯¹æ¥è¯´å¤æ‚äº›ï¼Œç„¶åæˆ‘åˆåœ¨ä¸­é—´æ’å…¥äº†è‡ªåŠ¨å¤‡ä»½å’Œå¤šæ¸ é“æ‰“åŒ…çš„taskï¼Œç„¶åå°±å¯ä»¥ä¸€é”®æ‰“ReleaseåŒ…å’Œè¡¥ä¸åŒ…ã€‚</p>
<p>é¦–å…ˆæ–°å»ºtinker.graldeæ–‡ä»¶ï¼Œé¦–å…ˆæŠŠTinkerçš„å®˜æ–¹åŸºæœ¬é…ç½®copyè¿›æ¥æ­¤å¤„ä»£ç ç•¥ã€‚å…ˆçœ‹ä¸‹Projectçš„build.gradleæ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">apply from: <span class="string">'../tinker.gradle'</span></div><div class="line">apply from: <span class="string">'../utils.gradle'</span></div><div class="line">dependencies &#123;</div><div class="line">    classpath (<span class="string">"com.tencent.tinker:tinker-patch-gradle-plugin:$&#123;TINKER_VERSION&#125;"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Projectåªéœ€è¦é…ç½®è¿™ä¸¤è¡Œä»£ç å°±å¯ä»¥äº†ã€‚å…¶ä¸­çš„utils.gradleæ˜¯ä¸€ä¸ªå·¥å…·è„šæœ¬æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€äº›å¸¸ç”¨çš„å·¥å…·æ–¹æ³•ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//utils.gradle</span></div><div class="line">ext &#123;</div><div class="line">    releaseTime = <span class="keyword">this</span>.&amp;releaseTime</div><div class="line">    packageChannel = <span class="keyword">this</span>.&amp;packageChannel</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">def <span class="title">releaseTime</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date().format(<span class="string">"yyyy-MM-dd"</span>, TimeZone.getTimeZone(<span class="string">"UTC"</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å¤šæ¸ é“æ‰“åŒ…ï¼Œä½¿ç”¨çš„ç¾å›¢æ–¹æ¡ˆ</span></div><div class="line"><span class="function">def <span class="title">packageChannel</span><span class="params">(String releaseApk)</span> </span>&#123;</div><div class="line">    print <span class="string">"begin package Channel! \n "</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        def stdout = <span class="keyword">new</span> ByteArrayOutputStream()</div><div class="line">        exec &#123;</div><div class="line">            commandLine <span class="string">'python'</span>, rootProject.getRootDir().getAbsolutePath() + <span class="string">"/app/multi_build.py"</span>, releaseApk</div><div class="line">            standardOutput = stdout</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> stdout.toString().trim()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (ignored) &#123;</div><div class="line">        print <span class="string">"package Channel Error! \n "</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"UnKnown"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„å¤šæ¸ é“æ‰“åŒ…æ–¹æ¡ˆä»ç„¶ä½¿ç”¨çš„ç¾å›¢ä¹‹å‰çš„å¾€META-INFæ’å…¥ç©ºæ–‡ä»¶çš„åšæ³•ï¼Œæ˜¯å› ä¸ºAndResGuardèµä¸æ”¯æŒv2ç­¾åï¼Œæš‚æ—¶æ— æ³•ä½¿ç”¨æ–°ä¸€ä»£çš„v2ç­¾åå¤šæ¸ é“æ‰“åŒ…æ–¹æ¡ˆ<a href="https://github.com/Meituan-Dianping/walle" target="_blank" rel="external">walle</a>ã€‚</p>
<p>ç»§ç»­çœ‹tinker.gradleï¼Œé¦–å…ˆéœ€è¦é…ç½®ä¾èµ–åº“å’Œæ‰“åŒ…æ—¶çš„æ’å…¥ä»£ç æ¯”å¦‚ç‰ˆæœ¬å·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    defaultConfig &#123;</div><div class="line">        <span class="comment">//æ¯æ¬¡å‘è¡¥ä¸éœ€è¦æ›´æ”¹æ­¤å¤„ å¢åŠ patchç‰ˆæœ¬å·ã€‚å‡çº§app ç‰ˆæœ¬è¦è¿˜åŸ0.0</span></div><div class="line">        buildConfigField <span class="string">"String"</span>, <span class="string">"PATCH_VERSION"</span>, <span class="string">"\"0.0\""</span></div><div class="line">        buildConfigField <span class="string">"String"</span>, <span class="string">"PLATFORM"</span>, <span class="string">"\"all\""</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    provided(<span class="string">"com.tencent.tinker:tinker-android-anno:$&#123;cfg.TINKER_VERSION&#125;"</span>)</div><div class="line">    compile(<span class="string">"com.tencent.tinker:tinker-android-lib:$&#123;cfg.TINKER_VERSION&#125;"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·é…ç½®å®ŒTinkerå°±å¯ä»¥å¯ç”¨äº†ï¼Œç„¶åæˆ‘ä»¬è¦å¤„ç†å’ŒAndResGuardé…ç½®ä½¿ç”¨ä»¥åŠè‡ªåŠ¨å¤‡ä»½è‡ªåŠ¨æ‰“æ¸ é“åŒ…ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä½¿ç”¨resguardæ‰“æ­£å¼åŒ…åéœ€è¦å¤‡ä»½apkã€Rã€mappingã€Resource mappingï¼›å¹¶ä¸”æ‰“æ¸ é“åŒ…</li>
<li>æ‰“è¡¥ä¸åŒ…éœ€è¦è‡ªåŠ¨å¡«å…¥resguardæ–°æ‰“å‡ºåŒ…çš„è·¯å¾„buildApkPathï¼Œapkã€Rã€mappingã€Resource mappingæ–‡ä»¶çš„å¯¹åº”è·¯å¾„ã€‚</li>
<li>æ‰“è¡¥ä¸åŒ…æ—¶resguardæ–°æ‰“å‡ºçš„åŒ…ä¸éœ€è¦å¤‡ä»½</li>
<li>éœ€è¦åŒºåˆ†debugå’Œreleaseåˆ‡æ¢å¤‡ä»½è·¯å¾„</li>
</ol>
<p>å¯¹åº”ä»¥ä¸Šå‡ ç‚¹ï¼Œç»™å‡ºå…³é”®ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">def cfg = rootProject.ext</div><div class="line">def bakPath = file(<span class="string">"$&#123;buildDir.parent&#125;/tinkerBackup/"</span>)</div><div class="line">def bakResguard = file(<span class="string">"$&#123;bakPath&#125;"</span>)</div><div class="line">def debugBakPath = file(<span class="string">"$&#123;buildDir.absolutePath&#125;/tinkerBackup"</span>)</div><div class="line">ext &#123;</div><div class="line">    appName = <span class="string">"nicepro"</span></div><div class="line">    ...</div><div class="line">    çœç•¥tinkeré…ç½®</div><div class="line">&#125;</div><div class="line">    def isNeedBackup = <span class="keyword">true</span></div><div class="line">    task AtinkerPatchPrepare &lt;&lt; &#123;</div><div class="line">        isNeedBackup = <span class="keyword">false</span></div><div class="line">        def backUpVersion = <span class="string">""</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).exists()) &#123;</div><div class="line">            backUpVersion = <span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).getText()</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!backUpVersion.isEmpty()) &#123;</div><div class="line">            print <span class="string">"app version : + $&#123;backUpVersion&#125; \n"</span></div><div class="line">            project.tinkerPatch.oldApk = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;.apk"</span></div><div class="line">            project.tinkerPatch.buildConfig.applyResourceMapping = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;_R.txt"</span></div><div class="line">            project.andResGuard.mappingFile = file(<span class="string">"$&#123;bakResguard&#125;/resource_mapping_$&#123;backUpVersion&#125;.txt"</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * bak apk and mapping</div><div class="line">     */</div><div class="line">    android.applicationVariants.all &#123; variant -&gt;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * task type, you want to bak</div><div class="line">         */</div><div class="line">        def taskName = <span class="string">'release'</span></div><div class="line"><span class="comment">//        def taskName = 'debug'</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (taskName.equals(<span class="string">"debug"</span>)) &#123;</div><div class="line">            bakResguard = file(<span class="string">"$&#123;buildDir.absolutePath&#125;/tinkerBackup"</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tasks.all &#123;</div><div class="line">            <span class="keyword">if</span> (variant.buildType.name == taskName) &#123;</div><div class="line"></div><div class="line">                def backUpVersion = <span class="string">""</span></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).exists()) &#123;</div><div class="line">                    backUpVersion = <span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>).getText()</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (<span class="string">"tinkerPatch$&#123;taskName.capitalize()&#125;"</span>.equalsIgnoreCase(it.name)) &#123;</div><div class="line">                    def resguardTask</div><div class="line">                    tasks.all &#123;</div><div class="line">                        <span class="keyword">if</span> (it.name.equalsIgnoreCase(<span class="string">"resguard$&#123;taskName.capitalize()&#125;"</span>)) &#123;</div><div class="line">                            resguardTask = it</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    it.doFirst(&#123;</div><div class="line">                        <span class="comment">// change build apk path</span></div><div class="line">                        it.buildApkPath = <span class="string">"$&#123;buildDir&#125;/outputs/apk/AndResGuard_$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;/$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;_signed_7zip_aligned.apk"</span></div><div class="line">                        project.android.ext.tinkerOldApkPath = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;.apk"</span></div><div class="line">                        project.android.ext.tinkerApplyResourcePath = <span class="string">"$&#123;bakResguard&#125;/$&#123;backUpVersion&#125;_R.txt"</span></div><div class="line">                    &#125;)</div><div class="line">                    it.dependsOn AtinkerPatchPrepare</div><div class="line">                    it.dependsOn resguardTask</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (<span class="string">"resguard$&#123;taskName.capitalize()&#125;"</span>.equalsIgnoreCase(it.name)) &#123;</div><div class="line">                    <span class="keyword">if</span> (!backUpVersion.isEmpty() &amp;&amp; <span class="keyword">new</span> File(<span class="string">"$&#123;backUpVersion&#125;_mapping.txt"</span>).exists()) &#123;</div><div class="line">                        ext.andResMappingFile = <span class="keyword">new</span> File(<span class="string">"$&#123;backUpVersion&#125;_mapping.txt"</span>)</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        ext.andResMappingFile = <span class="keyword">null</span></div><div class="line">                    &#125;</div><div class="line">                    it.doLast &#123;</div><div class="line">                        <span class="keyword">if</span> (!isNeedBackup) &#123;</div><div class="line">                            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">                        &#125;</div><div class="line">                        def date = <span class="keyword">new</span> Date().format(<span class="string">"MMdd-HH-mm-ss"</span>)</div><div class="line">                        def orgAndresPrefix = <span class="string">"AndResGuard_$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;"</span></div><div class="line">                        def orgApkPrefix = <span class="string">"$&#123;appName&#125;_$&#123;cfg.versionName&#125;_$&#123;releaseTime()&#125;"</span></div><div class="line">                        def targetApkPrefix = <span class="string">"$&#123;appName&#125;_$&#123;taskName.capitalize()&#125;_$&#123;cfg.versionName&#125;_$&#123;date&#125;"</span></div><div class="line"></div><div class="line">                        <span class="comment">//backUpVersion</span></div><div class="line">                        File version = <span class="keyword">new</span> File(<span class="string">"$&#123;bakResguard&#125;/version.txt"</span>)</div><div class="line">                        <span class="keyword">if</span> (!version.parentFile.exists()) &#123;</div><div class="line">                            version.parentFile.mkdir()</div><div class="line">                        &#125;</div><div class="line">                        version.write(<span class="string">"$&#123;targetApkPrefix&#125;"</span>)</div><div class="line"></div><div class="line">                        copy &#123;</div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/outputs/apk/$&#123;orgAndresPrefix&#125;/$&#123;orgApkPrefix&#125;_signed_7zip_aligned.apk"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    fileName.replace(<span class="string">"$&#123;orgApkPrefix&#125;_signed_7zip_aligned.apk"</span>, <span class="string">"$&#123;targetApkPrefix&#125;.apk"</span>)</div><div class="line">                                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                    print <span class="string">"rename apk mapping error"</span></div><div class="line">                                    e.printStackTrace()</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/outputs/mapping/$&#123;taskName&#125;/mapping.txt"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                fileName.replace(<span class="string">"mapping.txt"</span>, <span class="string">"$&#123;targetApkPrefix&#125;_mapping.txt"</span>)</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/intermediates/symbols/$&#123;taskName&#125;/R.txt"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                fileName.replace(<span class="string">"R.txt"</span>, <span class="string">"$&#123;targetApkPrefix&#125;_R.txt"</span>)</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            from <span class="string">"$&#123;buildDir&#125;/outputs/apk/$&#123;orgAndresPrefix&#125;/resource_mapping_$&#123;orgApkPrefix&#125;.txt"</span></div><div class="line">                            <span class="function">into <span class="title">file</span><span class="params">(bakResguard.absolutePath)</span></span></div><div class="line">                            rename &#123; String fileName -&gt;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    fileName.replace(<span class="string">"resource_mapping_$&#123;orgApkPrefix&#125;.txt"</span>, <span class="string">"resource_mapping_$&#123;targetApkPrefix&#125;.txt"</span>)</div><div class="line">                                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                    print <span class="string">"rename resource mapping error"</span></div><div class="line">                                    e.printStackTrace()</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                            print <span class="string">"one resguard backup tinker base apk ok! \n"</span></div><div class="line">                        &#125;</div><div class="line">                        packageChannel(<span class="string">"$&#123;buildDir&#125;/outputs/apk/$&#123;orgAndresPrefix&#125;/$&#123;orgApkPrefix&#125;_signed_7zip_aligned.apk"</span>)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>é…ç½®å®Œæˆã€‚å‘è¡¥ä¸åŒ…åªéœ€æ‰§è¡Œ<code>./gradlew resguardRelease</code>ä¾¿ä¼šæ‰“å‡ºå¤šæ¸ é“åŒ…ä»¥åŠå¤‡ä»½tinkeréœ€è¦çš„æ–‡ä»¶ã€‚</p>
<p>æ‰“tinkerè¡¥ä¸ä¸éœ€è¦æ‰‹åŠ¨å¡«ä¾èµ–æ–‡ä»¶ï¼ŒåŒ…åªéœ€æ‰§è¡Œ<code>./gradlew tinkerProcessRelease</code>ã€‚</p>
<p>æ­£å¥½ç°åœ¨å¹¶è¡Œä¸‰ä¸ªé¡¹ç›®ï¼Œç§»æ¤è¿‡ç¨‹å¾ˆå¿«ï¼Œcopyä¸¤ä¸ªgradleé…ç½®æ–‡ä»¶å°±æå®šäº†ã€‚appçš„build.gradleä»£ç ä¹Ÿåªæœ‰ä¸åˆ°200è¡Œã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p> <a href="http://blog.csdn.net/innost/article/details/48228651" target="_blank" rel="external">æ·±å…¥ç†è§£Androidä¹‹Gradle</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/01/22/gradle-modules/">http://w4lle.com/2017/01/22/gradle-modules/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡ä»¥&lt;a href=&quot;https://github.com/shwenzhang/AndResGuard&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AndResGuard&lt;/a&gt;å’Œ&lt;a href=&quot;https://github.com/Tencent/tinker&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Tinker&lt;/a&gt;ä¸ºä¾‹è®²è§£ä¸‹å¦‚ä½•æ¨¡å—åŒ–é…ç½®Gradleï¼Œä»¥åŠä¸€é”®æ‰“Tinkerè¡¥ä¸åŒ…çš„å®ç°æ–¹æ³•ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Thingsåˆæ¢</title>
    <link href="http://w4lle.com/2017/01/06/AndroidThings-0/"/>
    <id>http://w4lle.com/2017/01/06/AndroidThings-0/</id>
    <published>2017-01-06T09:26:47.000Z</published>
    <updated>2017-01-08T08:57:51.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Android Thingsæ˜¯Googleæ¨å‡ºçš„å…¨æ–°ç‰©è”ç½‘æ“ä½œç³»ç»Ÿ<br><a id="more"></a><br>å‰èº«æ˜¯å»å¹´å‘å¸ƒçš„ç‰©è”ç½‘å¹³å° Brilloã€‚Brillo ä½¿ç”¨ C/C++ åŸºäº NDK è¿›è¡Œå¼€å‘ï¼Œè€ŒAndroid Thingsä½¿ç”¨JAVAã€Android Studioã€Android SDKã€NDKç­‰è¿›è¡Œå¼€å‘ï¼Œå¦å¤–è¿˜æ–°å¢äº†åä¸º<code>Things Support Library</code>çš„åº“è¿™ä¸ªåº“æœ‰ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼šé€šè¿‡å¤šç§åè®®å’Œæ¥å£ï¼ˆGPIOã€PWMã€I2Cã€SPIã€UARTç­‰ï¼‰è®¿é—®ä¼ æ„Ÿå™¨å’Œæ‰§è¡Œå™¨çš„å¤–å›´I/O APIï¼›ä»¥åŠä¸€ä¸ªç”¨æˆ·é©±åŠ¨APIï¼ˆUser Driver APIï¼‰ï¼Œå¯ä»¥ç»™åº”ç”¨ç¨‹åºæ·»åŠ æ–°çš„è®¾å¤‡é©±åŠ¨ï¼Œç”¨äºå°†ç¡¬ä»¶äº‹ä»¶æ³¨å…¥ç³»ç»Ÿï¼Œä½¿å®ƒä»¬å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºæ‰€ç”¨ã€‚è¿˜æœ‰ï¼ŒAndroid Things å¤©ç”Ÿæ”¯æŒç‰©è”ç½‘é€šè®¯åè®® Weaveï¼Œå¯è®©æ‰€æœ‰ç±»å‹çš„è®¾å¤‡èƒ½å¤Ÿè¿ä¸Šäº‘ç«¯å¹¶ä¸å…¶ä»–æœåŠ¡å¦‚ Google Assistant äº¤äº’ã€‚Android Thingsç›®å‰æ”¯æŒä¸‰ç§ç¡¬ä»¶å¹³å°ï¼šIntel Edisonã€NXP Picoã€Raspberry Pi 3ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/things0.png" alt=""></p>
<p>ç®€å•æ¥è¯´ï¼Œé€šè¿‡Android Thingsï¼Œå¼€å‘è€…å¯ä»¥åƒå¼€å‘Androidåº”ç”¨ä¸€æ ·ç®€å•åœ°æ§åˆ¶ç¡¬ä»¶è®¾å¤‡ã€‚</p>
<h1 id="æ­å»ºå¼€å‘ç¯å¢ƒ"><a href="#æ­å»ºå¼€å‘ç¯å¢ƒ" class="headerlink" title="æ­å»ºå¼€å‘ç¯å¢ƒ"></a>æ­å»ºå¼€å‘ç¯å¢ƒ</h1><p>ç¡¬ä»¶å¹³å°é€‰æ‹©äº†æ ‘è“æ´¾3ï¼Œéœ€è¦å‡†å¤‡çš„ç¡¬ä»¶è®¾å¤‡ï¼š</p>
<ul>
<li>æ ‘è“æ´¾3å¼€å‘æ¿ä¸€ä¸ª</li>
<li>SDå¡ä¸€å¼ ï¼Œæˆ‘ä¹°çš„32G</li>
<li>USBæ’å£çº¿ä¸€æ¡</li>
<li>HDMIè§†é¢‘è¾“å‡ºçº¿ä¸€æ¡</li>
<li>æ˜¾ç¤ºå™¨ä¸€å°</li>
<li>æœ‰çº¿é¼ æ ‡ä¸€ä¸ª</li>
<li>LEDç¯2ä¸ª</li>
<li>æœé‚¦çº¿è‹¥å¹²æ¡</li>
<li>ç½‘çº¿ä¸€æ¡</li>
</ul>
<p>ç„¶åå‡†å¤‡æŠŠä»å®˜ç½‘ä¸‹è½½è§£å‹å¥½çš„imgæ–‡ä»¶çƒ§å…¥SDå¡ï¼Œæ­¥éª¤å‚è€ƒ<a href="https://developer.android.com/things/hardware/developer-kits.html" target="_blank" rel="external">å®˜ç½‘</a>å’Œ<a href="https://www.raspberrypi.org/documentation/installation/installing-images/mac.md" target="_blank" rel="external">æ ‘è“æ´¾å®˜ç½‘</a>ï¼Œæˆ‘æŒ‰ç…§å®˜ç½‘æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo dd bs=1m if=iot_rpi3.img of=/dev/disk2</div></pre></td></tr></table></figure>
<p>æç¤º<code>Resource busy</code>ï¼Œ<a href="http://raspberrypi.stackexchange.com/questions/9217/resource-busy-error-when-using-dd-to-copy-disk-img-to-sd-card" target="_blank" rel="external">è§£å†³æ–¹æ¡ˆ</a>å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">df -h</div><div class="line">sudo diskutil unmount /dev/disk2s1</div><div class="line">sudo dd bs=<span class="number">1</span>m <span class="keyword">if</span>=iot_rpi3.img of=/dev/rdisk2</div></pre></td></tr></table></figure>
<p>çƒ§å¥½åæŠŠSDå¡æ’å…¥å¼€å‘æ¿çš„å¡æ§½é‡Œï¼ŒUSBçº¿è¿ç”µè„‘ï¼ŒHDMIè¿æ˜¾ç¤ºå™¨ã€‚ç„¶åé€šç”µå¼€æœºã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/things1.jpg" alt=""><br><img src="http://7xs23g.com1.z0.glb.clouddn.com/things2.jpg" alt=""></p>
<p>çœ‹åˆ°è¿™ä¸ªç•Œé¢å°±å¯åŠ¨å¥½äº†ï¼Œå®é™…ä¸Šè¿™ä¸ªç•Œé¢å°±æ˜¯Androidåº”ç”¨Launcherçš„ä¸€ä¸ªActivity IoTLauncherã€‚IoT(Internet of Things)ç‰©è”ç½‘çš„ç®€ç§°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">âœ code &gt;adb shell dumpsys activity | grep <span class="string">"mFocusedActivity"</span></div><div class="line">  mFocusedActivity: ActivityRecord&#123;a7148f7 u0 com.android.iotlauncher/.IoTLauncher t1&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæ’ç½‘çº¿ï¼Œå†…ç½‘IPä¼šæ˜¾ç¤ºåœ¨Launcherç•Œé¢ï¼Œç„¶åç”¨adbè¿æ¥å¼€å‘æ¿ï¼Œè¿wifi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">adb connect 192.168.1.143</div><div class="line">adb shell am startservice \\n    </div><div class="line">-n com.google.wifisetup/.WifiSetupService \\n    </div><div class="line">-a WifiSetupService.Connect \\n</div><div class="line">-e ssid ssid \\n</div><div class="line">-e passphrase ***</div><div class="line">adb shell ping 8.8.8.8</div></pre></td></tr></table></figure>
<h1 id="è¿æ¥ledç¯"><a href="#è¿æ¥ledç¯" class="headerlink" title="è¿æ¥ledç¯"></a>è¿æ¥ledç¯</h1><p>æ ¹æ®demoç»™çš„å›¾è¿æ¥ledç¯</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/rpi3_schematics.png" alt=""></p>
<p>è¿™å¼ å›¾ç»™å‡ºäº†ä¸¤æ ¹çº¿ä¸€ä¸ªæ’åœ°çº¿ï¼Œä¸€ä¸ªæ’ç»¿è‰²çš„GPIOã€‚<br>è¿™é‡Œæ”¾ä¸Šä¸€å¼ å›¾å±•ç¤ºäº†æ ‘è“æ´¾ä¸Šå¯¹åº”çš„é’ˆè„šç±»å‹å’Œnameï¼Œæ¥ä¸‹æ¥çš„æ“ä½œledéœ€è¦nameæ‰èƒ½æ§åˆ¶ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/gpio.png" alt=""></p>
<h1 id="è¿è¡Œç¨‹åº"><a href="#è¿è¡Œç¨‹åº" class="headerlink" title="è¿è¡Œç¨‹åº"></a>è¿è¡Œç¨‹åº</h1><p>å®˜ç½‘æä¾›äº†å‡ ä¸ªSampleï¼Œæˆ‘ä»¬ä¸‹è½½ä¸‹æ¥ç„¶åè¿è¡Œç¬¬ä¸€ä¸ªSample-Blinkã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PeripheralManagerService service = <span class="keyword">new</span> PeripheralManagerService();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    mLedGpio = service.openGpio(<span class="string">"BCM5"</span>);</div><div class="line">    mLedGpio.setDirection(Gpio.DIRECTION_OUT_INITIALLY_LOW);</div><div class="line">&#125; <span class="keyword">catch</span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>openGpioæ–¹æ³•ä¸­çš„å‚æ•°å°±æ˜¯ä¸Šé¢æåˆ°çš„é’ˆè„šå¯¹åº”çš„nameã€‚ç¨‹åºè·‘èµ·æ¥ä¹‹åå°±å¯ä»¥çœ‹åˆ°æ¯éš”ä¸€ç§’ledé—ªä¸€ä¸‹ï¼ŒæŒºæœ‰æ„æ€ã€‚</p>
<p>æˆ‘ä»¬ç¨å¾®æ”¹é€ ä¸‹ï¼Œå†™ä¸€ä¸ªxmlæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªbuttonï¼Œæ¯æ¬¡ç‚¹å‡»buttonæ§åˆ¶ledç¯çš„çŠ¶æ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">findViewById(R.id.btn_blink).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mLedGpio.setValue(!mLedGpio.getValue());</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>å¤–æ¥é¼ æ ‡ï¼Œæ¯ç‚¹ä¸€ä¸‹buttonæ”¹å˜ä¸€ä¸‹ledçš„äº®ç­ã€‚<br>ç„¶åå†æ”¹ä¸‹ï¼Œæ’ä¸¤ä¸ªledç¯ï¼Œç¬¬äºŒä¸ªåœ¨BCM21 <code>mLedGpio2 = service.openGpio(&quot;BCM21&quot;);</code><br>ç„¶åæ¯éš”1sæ§åˆ¶ä¸¤ä¸ªç¯çš„çŠ¶æ€å–åã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mLedGpio2.setValue(mLedGpio.getValue());</div><div class="line">mLedGpio.setValue(!mLedGpio.getValue());</div></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚å›¾ï¼Œgifå‹ç¼©å¤ªä¸¥é‡ï¼Œå‡‘åˆçœ‹å§ã€‚<br><img src="http://7xs23g.com1.z0.glb.clouddn.com/things3.gif" alt=""></p>
<p>å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œé€šè¿‡Android Thingsæ§åˆ¶ç¡¬ä»¶çœŸçš„æ„Ÿè§‰è·Ÿå¼€å‘ä¸€æ¬¾Android Appæ²¡æœ‰å¤ªå¤§ä»€ä¹ˆåŒºåˆ«ï¼ŒåŒæ ·çš„å¼€å‘å·¥å…·ï¼ŒåŒæ ·çš„å¼€å‘ç¯å¢ƒï¼Œç”šè‡³SDKå¤§äº24çš„Andriod AppåŒæ ·å¯ä»¥å®‰è£…è¿è¡Œåœ¨Android Thingsç³»ç»Ÿä¸Šï¼›è€Œå¯¹äºNDKå¼€å‘ï¼Œè·ŸAndroidä¸Šä¹Ÿæ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚</p>
<h1 id="Android-Everywhere"><a href="#Android-Everywhere" class="headerlink" title="Android Everywhere"></a>Android Everywhere</h1><p>è¿˜è®°å¾—RoyLiåœ¨åšçš„åä¸ºRuffçš„ç‰©è”ç½‘å¹³å°ï¼ŒRoyLiæ˜¯è¿™æ ·ä»‹ç»å®ƒçš„</p>
<blockquote>
<p> Ruff è®©ä¸ä¼šåšç¡¬ä»¶çš„è½¯ä»¶å·¥ç¨‹å¸ˆæ ¹æ®äº§å“ç»ç†çš„åˆ›æ„ç¼–å†™åº”ç”¨ï¼Œ(è½¯ä»¶å·¥ç¨‹å¸ˆ)ä¸ç”¨å…³å¿ƒåº•å±‚å®ç°å’Œé©±åŠ¨ç§»æ¤é—®é¢˜ï¼Œé€šè¿‡å¼€å‘è€…å»ºç«‹çš„åº”ç”¨ç”Ÿæ€æœ€ç»ˆè§£å†³ç‰©è”ç½‘è½¯ä»¶è½åçš„é—®é¢˜ã€‚<br>Ruffçš„ç›®çš„å°±æ˜¯è¦åšç‰©è”ç½‘é¢†åŸŸçš„Androidå¹³å°ï¼Œé‡‡ç”¨æ¯”è¾ƒæµè¡Œçš„JavaScriptä½œä¸ºç¼–ç¨‹è¯­è¨€ç›´æ¥æ“ä½œç¡¬ä»¶ã€‚</p>
</blockquote>
<p>è€Œç°åœ¨Android Thingså·²ç»ç§»æ¤åˆ°äº†ç‰©è”ç½‘é¢†åŸŸï¼ŒGoogleçš„é‡å¿ƒä¹Ÿå¯è§ä¸€æ–‘ï¼Œå…¶å¯¹äºåƒRuffè¿™æ ·çš„åˆ›ä¸šé¡¹ç›®çš„å†²å‡»ä¹Ÿå¯æƒ³è€ŒçŸ¥ã€‚æ”¾ä¸€å¼ 2015å¹´Google I/Oå¤§ä¼šä¸Šçš„æ—§å›¾</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/google_to.png" alt=""></p>
<p>Androidæœ‰åºå¤§çš„å¼€å‘è€…æ”¯æŒï¼Œå®Œå–„çš„å¼€å‘å·¥å…·é…å¥—ï¼Œä¹Ÿè®¸AndroidçœŸçš„å¯ä»¥åšåˆ°è¿æ¥ä¸‡ç‰©çš„å¯èƒ½ï¼ŒAndroidåœ¨ä¸è¿œçš„æœªæ¥çœŸçš„å¯èƒ½æ— å¤„ä¸åœ¨ï¼Œä¹˜æ­¤ä¸œé£ï¼ŒAndroidå¼€å‘è€…ä¹Ÿå¯å¤§æœ‰å¯ä¸ºã€‚</p>
<h1 id="å®‰å…¨"><a href="#å®‰å…¨" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h1><p>è¯´åˆ°ç‰©è”ç½‘å°±ä¸å¾—ä¸è¯´å®‰å…¨ï¼Œåœ¨è½¯ä»¶å±‚é¢ç›—ä¸ªå·ï¼Œä¸ªäººä¿¡æ¯è¢«çªƒå–å¯èƒ½æ„Ÿè§‰é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯å¯¹äºè”ç½‘çš„ç¡¬ä»¶æ¥è¯´å°±å¾ˆå¯æ€•äº†ï¼Œæ¯”å¦‚è¯´é—¨é”è¢«ç ´è§£ï¼Œä½ å®¶çš„ç…¤æ°”è¢«è¿œç¨‹æ§åˆ¶ï¼ŒåŠå¤œä½ å®¶ç”µè§†çªç„¶å“äº†ï¼Œå°±é—®ä½ æ€•ä¸æ€•ã€‚</p>
<p>Googleæ—¢ç„¶æƒ³ç»Ÿä¸€IoTæ ‡å‡†ï¼Œé‚£ä¹ˆIoTçš„å®‰å…¨æ€§å¿…é¡»é‡è§†ï¼Œå› ä¸ºåœ¨æ ‡å‡†æœªç»Ÿä¸€ä¹‹å‰ç ´è§£æŸä¸€æ¬¾ç¡¬ä»¶è®¾å¤‡æ€§æ„ä¹‰ä¸å¤§ï¼Œè€Œæ ‡å‡†ç»Ÿä¸€ä¹‹åï¼Œåªè¦ç ´è§£è¿™ä¸ªå¹³å°å°±æå®šäº†ä¸€åˆ‡ã€‚çœŸå¿ƒå¸Œæœ›Googleå¯ä»¥åšåˆ°è®©äººæ»¡æ„çš„å®‰å…¨æ€§ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://developer.android.com/things/hardware/index.html" target="_blank" rel="external">Android Things</a><br><a href="https://github.com/androidthings" target="_blank" rel="external">Android Things Sample</a><br><a href="http://www.jianshu.com/nb/3704305" target="_blank" rel="external">ttdevsçš„æ ‘è“æ´¾ä¸“é¢˜</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/01/06/AndroidThings-0/">http://w4lle.com/2017/01/06/AndroidThings-0/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;Android Thingsæ˜¯Googleæ¨å‡ºçš„å…¨æ–°ç‰©è”ç½‘æ“ä½œç³»ç»Ÿ&lt;br&gt;
    
    </summary>
    
    
      <category term="Android Things" scheme="http://w4lle.com/tags/Android-Things/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€é”®æ¥å…¥Tinker</title>
    <link href="http://w4lle.com/2017/01/05/one-key-for-tinker/"/>
    <id>http://w4lle.com/2017/01/05/one-key-for-tinker/</id>
    <published>2017-01-05T06:15:49.000Z</published>
    <updated>2018-02-05T01:32:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Tinkerå¼€æºæŒºé•¿æ—¶é—´äº†ï¼Œä½¿ç”¨çš„å¼€å‘è€…ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå¯¹äºä¸€äº›å°ç™½å¼€å‘è€…æ¥è¯´å¯¹æ¥Tinkerçš„æˆæœ¬è¿˜æ˜¯æŒºé«˜çš„ï¼Œå…¶ä¸­ä¸»è¦å› ç´ è¿˜æ˜¯ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆApplicationè¦ä¿®æ”¹æˆApplicationLikeï¼Œä»¥åŠæ”¹é€ åå¯¹é¡¹ç›®ä¸­ä½¿ç”¨Applicationçš„åœ°æ–¹ä¹Ÿè¦åŒæ­¥ä¿®æ”¹ã€‚</p>
<p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="http://w4lle.github.io/2016/12/16/tinker/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æ</a>ä¸­æˆ‘ä»¬å·²ç»è®²è§£äº†è¿™æ ·åšçš„ç›®çš„ä»¥åŠTinkerçš„åŠ è½½è¡¥ä¸çš„æµç¨‹ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦è®²ä¸€ä¸‹ä¸€é”®æ¥å…¥Tinkerçš„å®ç°æ€è·¯ã€‚</p>
<h1 id="InstantRun"><a href="#InstantRun" class="headerlink" title="InstantRun"></a>InstantRun</h1><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯è¦å®ç°ä¸ä¿®æ”¹Applicationè¾¾åˆ°æ›¿æ¢Applicationçš„æ•ˆæœï¼Œåœ¨è¿™ç¯‡æ–‡ç« <a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a>ä¸­ï¼Œè¯¦ç»†è®²è¿°äº†å¦‚ä½•åŠ¨æ€æ›¿æ¢Applicationï¼Œæ€»ç»“èµ·æ¥å°±ä¸¤æ­¥ï¼š</p>
<ol>
<li>æ‰“åŒ…æ—¶æ›¿æ¢Applicationæ ‡ç­¾ï¼Œæ’å…¥BootstrapApplication</li>
<li>è¿è¡Œæ—¶hookç³»ç»Ÿapiï¼Œå°†BootstrapApplicationæ¢å›MyApplication</li>
</ol>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ç”¨è¿™å¥—æ–¹æ¡ˆæ¥å®ç°Tinkerçš„ä¸€é”®æ¥å…¥ï¼ŒåŠ¨æ€æ›¿æ¢Applicationã€‚</p>
<h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><p>æœ‰äº†æ€è·¯æˆ‘ä»¬å°±å¯ä»¥æ•²ä»£ç äº†ã€‚</p>
<h2 id="æ‰“åŒ…"><a href="#æ‰“åŒ…" class="headerlink" title="æ‰“åŒ…"></a>æ‰“åŒ…</h2><p>æ‰“åŒ…æ—¶æˆ‘ä»¬è¦æ”¹å˜Manifestä¸­Applicationçš„æ ‡ç­¾å€¼ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰Gradleæ’ä»¶æ¥å®ç°ï¼Œå…³é”®ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@TaskAction</span></div><div class="line">    <span class="function">def <span class="title">updateManifest</span><span class="params">()</span> </span>&#123;</div><div class="line">        def ns = <span class="keyword">new</span> Namespace(<span class="string">"http://schemas.android.com/apk/res/android"</span>, <span class="string">"android"</span>)</div><div class="line">        def xml = <span class="keyword">new</span> XmlParser().parse(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(manifestPath), <span class="string">"utf-8"</span>))</div><div class="line"></div><div class="line">        def application = xml.application[<span class="number">0</span>]</div><div class="line">        <span class="keyword">if</span> (application) &#123;</div><div class="line">            def metaDataTags = application[<span class="string">'meta-data'</span>]</div><div class="line"></div><div class="line">            String rawApplicationName = application.attributes()[ns.name]</div><div class="line">            metaDataTags.findAll &#123;</div><div class="line">                it.attributes()[ns.name].equals(TINKER_APPLICATION)</div><div class="line">            &#125;.each &#123;</div><div class="line">                it.parent().remove(it)</div><div class="line">            &#125;</div><div class="line">            application.appendNode(<span class="string">'meta-data'</span>, [(ns.name): TINKER_APPLICATION, (ns.value): rawApplicationName])</div><div class="line">            application.attributes()[ns.name] = TINKER_APPLICATION_VALUE</div><div class="line"></div><div class="line">            def printer = <span class="keyword">new</span> XmlNodePrinter(<span class="keyword">new</span> PrintWriter(manifestPath, <span class="string">"utf-8"</span>))</div><div class="line">            printer.preserveWhitespace = <span class="keyword">true</span></div><div class="line">            printer.print(xml)</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ‰“åŒ…å‡ºçš„apkä¸­çš„AndroidManifest.xmlæ–‡ä»¶åŸºæœ¬æ˜¯è¿™æ ·çš„</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;application android:name="com.w4lle.onekeytinker.BootstrapApplication"&gt;</div><div class="line">    ...</div><div class="line">    &lt;meta-data android:name="ONEKEY_TINKER_APPLICATION" android:value="com.w4lle.onekeytinker.App"/&gt;</div><div class="line">  &lt;/application&gt;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„Appæ˜¯é¡¹ç›®ä¸­åŸæœ‰çš„Applicationï¼ŒBootstrapApplicationæ˜¯åæœŸæˆ‘ä»¬æ’å…¥çš„Applicationã€‚è‡ªå®šä¹‰Gradleæ’ä»¶æ—¶å¯ä»¥å°è£…ä¸€ä¸ªExtensioné…ç½®å‚æ•°ï¼ŒæŠŠTinkerçš„ç›¸å…³é…ç½®å°è£…èµ·æ¥ï¼Œä¸€äº›ä¸å˜çš„é»˜è®¤é…ç½®é¡¹éƒ½å¯ä»¥å†™åˆ°é‡Œé¢ï¼Œè¿™æ ·é¡¹ç›®çš„gradleé…ç½®å¯ä»¥æ›´ç®€æ´ã€‚å¦å¤–è¯´ä¸€å¥ï¼Œè¿™ä¸ªGradleæ’ä»¶çš„é¡ºåºåº”è¯¥æ˜¯æ‰“åŒ…å·¥å…·ç”ŸæˆManifestä¹‹åï¼ŒTinkerç›¸å…³Taskä¹‹å‰ã€‚</p>
<h2 id="è¿è¡Œæ—¶æ›¿æ¢Application"><a href="#è¿è¡Œæ—¶æ›¿æ¢Application" class="headerlink" title="è¿è¡Œæ—¶æ›¿æ¢Application"></a>è¿è¡Œæ—¶æ›¿æ¢Application</h2><p>è¿™ä¸€æ­¥çš„ä¸»è¦å·¥ä½œä¹Ÿæ˜¯åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€å°±æ˜¯è§£æManifestæ–‡ä»¶ï¼Œæ‹¿åˆ°realApplication(App)å’ŒBootstrapApplicationï¼›ç„¶åhook ç³»ç»Ÿå®Œæˆæ›¿æ¢ã€‚</p>
<p>InstantRunä¸­çš„æ›¿æ¢å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">monkeyPatchApplication</span><span class="params">(@Nullable Context context,</span></span></div><div class="line">                                              @Nullable Application bootstrap,</div><div class="line">                                              @Nullable Application realApplication) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Find the ActivityThread instance for the current thread</span></div><div class="line">            Class&lt;?&gt; activityThread = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line">            Object currentActivityThread = getActivityThread(context, activityThread);</div><div class="line"></div><div class="line">            <span class="comment">// Find the mInitialApplication field of the ActivityThread to the real application</span></div><div class="line">            Field mInitialApplication = activityThread.getDeclaredField(<span class="string">"mInitialApplication"</span>);</div><div class="line">            mInitialApplication.setAccessible(<span class="keyword">true</span>);</div><div class="line">            Application initialApplication = (Application) mInitialApplication.get(currentActivityThread);</div><div class="line">            <span class="keyword">if</span> (realApplication != <span class="keyword">null</span> &amp;&amp; initialApplication == bootstrap) &#123;</div><div class="line">            <span class="comment">//**2.æ›¿æ¢æ‰ActivityThread.mInitialApplication**</span></div><div class="line">                mInitialApplication.set(currentActivityThread, realApplication);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Replace all instance of the stub application in ActivityThread#mAllApplications with the</span></div><div class="line">            <span class="comment">// real one</span></div><div class="line">            <span class="keyword">if</span> (realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">                Field mAllApplications = activityThread.getDeclaredField(<span class="string">"mAllApplications"</span>);</div><div class="line">                mAllApplications.setAccessible(<span class="keyword">true</span>);</div><div class="line">                List&lt;Application&gt; allApplications = (List&lt;Application&gt;) mAllApplications</div><div class="line">                        .get(currentActivityThread);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; allApplications.size(); i++) &#123;</div><div class="line">                    <span class="keyword">if</span> (allApplications.get(i) == bootstrap) &#123;</div><div class="line">                    <span class="comment">//**1.æ›¿æ¢æ‰ActivityThread.mAllApplications**</span></div><div class="line">                        allApplications.set(i, realApplication);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Figure out how loaded APKs are stored.</span></div><div class="line"></div><div class="line">            <span class="comment">// API version 8 has PackageInfo, 10 has LoadedApk. 9, I don't know.</span></div><div class="line">            Class&lt;?&gt; loadedApkClass;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                loadedApkClass = Class.forName(<span class="string">"android.app.LoadedApk"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                loadedApkClass = Class.forName(<span class="string">"android.app.ActivityThread$PackageInfo"</span>);</div><div class="line">            &#125;</div><div class="line">            Field mApplication = loadedApkClass.getDeclaredField(<span class="string">"mApplication"</span>);</div><div class="line">            mApplication.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">            <span class="comment">// 10 doesn't have this field, 14 does. Fortunately, there are not many Honeycomb devices</span></div><div class="line">            <span class="comment">// floating around.</span></div><div class="line">            Field mLoadedApk = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mLoadedApk = Application.class.getDeclaredField(<span class="string">"mLoadedApk"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</div><div class="line">                <span class="comment">// According to testing, it's okay to ignore this.</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Enumerate all LoadedApk (or PackageInfo) fields in ActivityThread#mPackages and</span></div><div class="line">            <span class="comment">// ActivityThread#mResourcePackages and do two things:</span></div><div class="line">            <span class="comment">//   - Replace the Application instance in its mApplication field with the real one</span></div><div class="line">            <span class="comment">//   - Set Application#mLoadedApk to the found LoadedApk instance</span></div><div class="line">            <span class="keyword">for</span> (String fieldName : <span class="keyword">new</span> String[]&#123;<span class="string">"mPackages"</span>, <span class="string">"mResourcePackages"</span>&#125;) &#123;</div><div class="line">                Field field = activityThread.getDeclaredField(fieldName);</div><div class="line">                field.setAccessible(<span class="keyword">true</span>);</div><div class="line">                Object value = field.get(currentActivityThread);</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, WeakReference&lt;?&gt;&gt; entry :</div><div class="line">                        ((Map&lt;String, WeakReference&lt;?&gt;&gt;) value).entrySet()) &#123;</div><div class="line">                    Object loadedApk = entry.getValue().get();</div><div class="line">                    <span class="keyword">if</span> (loadedApk == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (mApplication.get(loadedApk) == bootstrap) &#123;</div><div class="line">                        <span class="keyword">if</span> (realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">//**3.æ›¿æ¢æ‰mApplication**</span></div><div class="line">                            mApplication.set(loadedApk, realApplication);</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (realApplication != <span class="keyword">null</span> &amp;&amp; mLoadedApk != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">//**4.æ›¿æ¢æ‰mLoadedApk**</span></div><div class="line">                            mLoadedApk.set(realApplication, loadedApk);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>æ›¿æ¢Application<ul>
<li>baseContext.mPackageInfo.mApplication ä»£ç 3å¤„</li>
<li>baseContext.mPackageInfo.mActivityThread.mInitialApplication ä»£ç 2å¤„</li>
<li>baseContext.mPackageInfo.mActivityThread.mAllApplications ä»£ç 1å¤„</li>
</ul>
</li>
<li>æ›¿æ¢mLoadedApkå¯¹è±¡ï¼Œä»£ç 4å¤„</li>
</ol>
<p>è¯¦ç»†è¯·æŸ¥çœ‹<a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a></p>
<p>åšå®Œä¸Šé¢è¿™ä¸¤æ­¥è¿™æ ·å°±å¯ä»¥å®ç°ä¸€é”®æ¥å…¥äº†ã€‚</p>
<h1 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h1><p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°ï¼Œç”±äºè¯¥æ–¹æ¡ˆå¤§é‡hookç³»ç»Ÿapiï¼Œåœ¨å›½å†…Androidç¢ç‰‡åŒ–å¦‚æ­¤ä¸¥é‡çš„å¸‚åœºç¯å¢ƒä¸‹ï¼Œè¯¥æ–¹æ¡ˆå…¼å®¹æ€§æœ‰ä¸€äº›é—®é¢˜ï¼Œå¤§æ¦‚æœ‰ 1/1wçš„æ¦‚ç‡ä¼šå‡ºç°æ›¿æ¢å¤±è´¥çš„é—®é¢˜ï¼Œå¦‚æœæ›¿æ¢å¤±è´¥ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿä¸­è¿è¡Œçš„Applicationè¿˜æ˜¯BootstrapApplicationï¼Œè€Œæˆ‘ä»¬Appä¸­çš„Applicationå·²ç»æ²¡æœ‰äº†Applicationçš„ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦åœ¨å¤±è´¥catchä¸­è°ƒç”¨ä¸‹Applicationçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥ä¿è¯ç¨‹åºèƒ½å¤Ÿæ­£å¸¸åˆå§‹åŒ–å¯åŠ¨èµ·æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  ...</div><div class="line">&#125; <span class="keyword">catch</span> &#123;</div><div class="line">  e = <span class="keyword">true</span>;</div><div class="line">  realApplication.onCreate();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration paramConfiguration)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onConfigurationChanged(paramConfiguration);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onConfigurationChanged(paramConfiguration);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onLowMemory();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onLowMemory();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@TargetApi</span>(<span class="number">14</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> paramInt)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onTrimMemory(paramInt);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onTrimMemory(paramInt);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTerminate</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> (e &amp;&amp; realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">    realApplication.onTerminate();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">super</span>.onTerminate();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¹ˆåšè™½ç„¶èƒ½ä¿è¯Appèƒ½å¯åŠ¨ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜ä¼šæœ‰éšæ€§é—®é¢˜å­˜åœ¨ã€‚æ¯”å¦‚Appä¸­æœ‰å¦‚ä¸‹ä»£ç <code>((App) getApplication()).xxx();</code>ï¼Œé‚£ä¹ˆåœ¨æ›¿æ¢å¤±è´¥çš„æƒ…å†µä¸‹å¯èƒ½å°±ä¼šå´©äº†ï¼Œ å› ä¸º<code>getApplication()</code>å¾—åˆ°çš„æ˜¯BootstrapApplicationï¼Œå¼ºè½¬ä¸º<code>App</code>ç±»å‹è‚¯å®šå°±æŒ‚äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ•´ä½“æ€è·¯å¤§æ¦‚è®²æ¸…æ¥šäº†ï¼Œè™½ç„¶è¿™ç§æ–¹æ¡ˆæ¥å…¥æˆæœ¬ä½ï¼Œä½†æ˜¯å…¼å®¹æ€§é—®é¢˜æ˜¯ä¸ªå¾ˆéº»çƒ¦çš„äº‹æƒ…ï¼Œè¯´ä¸å®šå•¥æ—¶å€™å°±å´©äº†ã€‚æ¨èå¤§å®¶è¿˜æ˜¯ä½¿ç”¨Tinkerè‡ªæœ‰çš„æ¥å…¥æ–¹æ¡ˆã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a><br><a href="http://www.tinkerpatch.com/" target="_blank" rel="external">TinkerPatch</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2017/01/05/one-key-for-tinker/">http://w4lle.com/2017/01/05/one-key-for-tinker/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;Tinkerå¼€æºæŒºé•¿æ—¶é—´äº†ï¼Œä½¿ç”¨çš„å¼€å‘è€…ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå¯¹äºä¸€äº›å°ç™½å¼€å‘è€…æ¥è¯´å¯¹æ¥Tinkerçš„æˆæœ¬è¿˜æ˜¯æŒºé«˜çš„ï¼Œå…¶ä¸­ä¸»è¦å› ç´ è¿˜æ˜¯ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆA
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æ</title>
    <link href="http://w4lle.com/2016/12/16/tinker/"/>
    <id>http://w4lle.com/2016/12/16/tinker/</id>
    <published>2016-12-16T01:49:06.000Z</published>
    <updated>2017-03-08T02:17:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>Tinkerç³»åˆ—æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://w4lle.github.io/2016/12/16/tinker/" target="_blank" rel="external">Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æ</a></li>
<li><a href="http://w4lle.github.io/2017/01/05/one-key-for-tinker/" target="_blank" rel="external">ä¸€é”®æ¥å…¥Tinker</a></li>
<li><a href="http://w4lle.github.io/2017/01/22/gradle-modules/" target="_blank" rel="external">Gradleæ¨¡å—åŒ–é…ç½®</a></li>
</ul>
<p>æœ¬æ–‡æ˜¯ç¬¬ä¸€ç¯‡ã€‚</p>
<blockquote>
<p>æœ¬æ–‡åˆ†æç‰ˆæœ¬  <a href="https://github.com/Tencent/tinker/tree/93ecc9351367badc02a91fac25764bee50e6e6a6" target="_blank" rel="external">93ecc9351367badc02a91fac25764bee50e6e6a6</a><br>é¡¹ç›®åœ°å€ï¼š <a href="https://github.com/Tencent/tinker/" target="_blank" rel="external">Tinker</a></p>
</blockquote>
<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>åœ¨ä»Šå¹´çš„MDCCå¤§ä¼šä¸Šï¼Œå¾®ä¿¡å¼€å‘å›¢é˜Ÿå®£å¸ƒæ­£å¼å¼€æºTinkerï¼Œåœ¨è¿™ä¹‹å‰å¾®ä¿¡å›¢é˜Ÿå·²ç»å‘å‡ºè¿‡ä¸€äº›Tinkerçš„ç›¸å…³æ–‡ç« ï¼Œè¯´å®è¯åœ¨å¼€æºä¹‹å‰æˆ‘ä»¬è¿˜æ˜¯ç›¸å½“æœŸå¾…Tinkerå¼€æºçš„ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºä¹‹å‰ä½¿ç”¨çš„çƒ­è¡¥ä¸ä¸€ç›´å­˜åœ¨ä¸€äº›å…¼å®¹æ€§é—®é¢˜ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¥½å¥‡Tinkerçš„å®ç°æ–¹æ¡ˆã€‚</p>
<a id="more"></a>
<p>åœ¨å¼€æºåæˆ‘ä»¬å›¢é˜Ÿç¬¬ä¸€æ—¶é—´ç€æ‰‹ç ”ç©¶Tinkerï¼Œåœ¨è¯¦ç»†é˜…è¯»äº†æºç ä¹‹åï¼Œæˆ‘ä»¬ç¡®å®šè¦åœ¨ä¹‹åçš„ä¸€ä¸ªç‰ˆæœ¬é›†æˆTinkerä¸Šçº¿ï¼Œçº¿ä¸Šæ•ˆæœæ˜¾ç¤ºTinkerçš„ä¿®å¤æ•ˆæœæœç„¶ç‰›é€¼ï¼Œé”™è¯¯ç‡æ˜æ˜¾ä¸‹é™çš„åŒæ—¶ä¹Ÿæ²¡æœ‰æŠ¥å‡ºå…¼å®¹æ€§çš„é—®é¢˜ã€‚é™„ä¸€å¼ è–„è·appä½¿ç”¨Tinkerä¿®å¤å‰åçš„é”™è¯¯ç‡å¯¹æ¯”ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/fatal.png" alt=""></p>
<h1 id="ä»æ¥å…¥Tinkerå…¥æ‰‹"><a href="#ä»æ¥å…¥Tinkerå…¥æ‰‹" class="headerlink" title="ä»æ¥å…¥Tinkerå…¥æ‰‹"></a>ä»æ¥å…¥Tinkerå…¥æ‰‹</h1><p>æƒ³è¦æ·±å…¥æŸä¸ªæ¡†æ¶ï¼Œå‰ææ˜¯è¦å­¦ä¼šä½¿ç”¨å®ƒã€‚æˆ‘ä»¬å°±ä»Tinkerçš„æ¥å…¥å…¥æ‰‹ä¸€æ­¥ä¸€æ­¥è§£å¼€å®ƒçš„å®ç°åŸç†ã€‚å‚ç…§<a href="https://github.com/Tencent/tinker/wiki" target="_blank" rel="external">wiki</a>æˆ‘ä»¬åšäº†å¦‚ä¸‹æ“ä½œã€‚</p>
<p>å®ç°ä¸€ä¸ªApplication</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneApplicationForTinker</span> <span class="keyword">extends</span> <span class="title">TinkerApplication</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OneApplicationForTinker</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(</div><div class="line">                <span class="comment">//tinkerFlags, tinkeræ”¯æŒçš„ç±»å‹ï¼Œdex,libraryï¼Œè¿˜æ˜¯å…¨éƒ¨éƒ½æ”¯æŒï¼</span></div><div class="line">                ShareConstants.TINKER_ENABLE_ALL,</div><div class="line">                <span class="comment">//ApplicationLikeçš„å®ç°ç±»ï¼Œåªèƒ½ä¼ é€’å­—ç¬¦ä¸²,ä¸èƒ½ä½¿ç”¨class.getName()</span></div><div class="line">                <span class="string">"com.boohee.one.MyApplication"</span>,</div><div class="line">                <span class="comment">//åŠ è½½Tinkerçš„ä¸»ç±»åï¼Œå¯¹äºç‰¹æ®Šéœ€æ±‚å¯èƒ½éœ€è¦ä½¿ç”¨è‡ªå·±çš„åŠ è½½ç±»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</span></div><div class="line">                <span class="comment">//è¿™ä¸ªç±»ä»¥åŠå®ƒä½¿ç”¨çš„ç±»éƒ½æ˜¯ä¸èƒ½è¢«è¡¥ä¸ä¿®æ”¹çš„ï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬åŠ åˆ°dex.loader[]ä¸­ã€‚</span></div><div class="line">                <span class="comment">//ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤å³å¯ã€‚</span></div><div class="line">                <span class="string">"com.tencent.tinker.loader.TinkerLoader"</span>,</div><div class="line">                <span class="comment">//ç”±äºåˆæˆè¿‡ç¨‹ä¸­æˆ‘ä»¬å·²ç»æ ¡éªŒäº†å„ä¸ªæ–‡ä»¶çš„Md5ï¼Œå¹¶å°†å®ƒä»¬å­˜æ”¾åœ¨/data/data/..ç›®å½•ä¸­ã€‚</span></div><div class="line">                <span class="comment">// é»˜è®¤æ¯æ¬¡åŠ è½½æ—¶æˆ‘ä»¬å¹¶ä¸ä¼šå»æ ¡éªŒtinkeræ–‡ä»¶çš„Md5,ä½†æ˜¯ä½ ä¹Ÿå¯é€šè¿‡å¼€å¯loadVerifyFlagå¼ºåˆ¶æ¯æ¬¡åŠ è½½æ—¶æ ¡éªŒï¼Œ</span></div><div class="line">                <span class="comment">// ä½†æ˜¯è¿™ä¼šå¸¦æ¥ä¸€å®šçš„æ—¶é—´æŸè€—ã€‚</span></div><div class="line">                <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„å‡ ä¸ªå‚æ•°åšäº†è¯¦ç»†è¯´æ˜ï¼ŒTinkerå…¶å®æä¾›äº†æ³¨è§£çš„æ–¹å¼ç”Ÿæˆè¯¥ç±»ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸ºäº†æ›´æ¸…æ¥šçš„äº†è§£Tinkerçš„åŸç†ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ä½¿ç”¨æ³¨è§£ã€‚</p>
<p>ç„¶ååœ¨<code>AndroidManifest.xml</code>ä¸­å£°æ˜è¯¥ç±»ä¸º<code>application</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">&lt;application</div><div class="line">        android:name=".tinker.OneApplicationForTinker"</div><div class="line">        ...</div><div class="line">&lt;/application&gt;</div></pre></td></tr></table></figure>
<p>é‚£æˆ‘ä»¬å°±çŸ¥é“äº†ï¼Œappçš„å…¥å£Applicationå°±æ˜¯è¯¥ç±»ï¼Œè¯¥ç±»ç»§æ‰¿è‡ªTinkerApplicationã€‚ç„¶åæˆ‘ä»¬é¡¹ç›®ä¸­çš„MyApplicationç»§æ‰¿è‡ªApplicationLikeï¼Œå…¶å®çœ‹åˆ°è¿™é‡Œï¼Œå°±å¤§æ¦‚çŒœåˆ°äº†OneApplicationForTinkerå¯èƒ½æ˜¯ä¸€ä¸ªä»£ç†ï¼ŒAppä¸­çš„Applicationçš„çœŸæ­£å®ç°è¿˜æ˜¯MyApplicationã€‚</p>
<h1 id="Applicationçš„æ›¿æ¢"><a href="#Applicationçš„æ›¿æ¢" class="headerlink" title="Applicationçš„æ›¿æ¢"></a>Applicationçš„æ›¿æ¢</h1><p>ä¸ºäº†åšåˆ†æå‰çš„é“ºå«ï¼Œæˆ‘ä»¬ä»æœ€å¼€å§‹çš„æ¥å…¥å…¥æ‰‹ï¼Œå®ç°äº†OneApplicationForTinkerï¼Œç»§æ‰¿è‡ªTinkerApplicationã€‚æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚<br>çœ‹ä¸‹TinkerApplicationçš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TinkerApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TinkerApplication</span><span class="params">(<span class="keyword">int</span> tinkerFlags, String delegateClassName,</span></span></div><div class="line">                                String loaderClassName, <span class="keyword">boolean</span> tinkerLoadVerifyFlag) &#123;</div><div class="line">        <span class="keyword">this</span>.tinkerFlags = tinkerFlags;</div><div class="line">        <span class="keyword">this</span>.delegateClassName = delegateClassName;</div><div class="line">        <span class="keyword">this</span>.loaderClassName = loaderClassName;</div><div class="line">        <span class="keyword">this</span>.tinkerLoadVerifyFlag = tinkerLoadVerifyFlag;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">createDelegate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Use reflection to create the delegate so it doesn't need to go into the primary dex.</span></div><div class="line">            <span class="comment">// And we can also patch it</span></div><div class="line">            Class&lt;?&gt; delegateClass = Class.forName(delegateClassName, <span class="keyword">false</span>, getClassLoader());</div><div class="line">            Constructor&lt;?&gt; constructor = delegateClass.getConstructor(Application.class, <span class="keyword">int</span>.class, <span class="keyword">boolean</span>.class, <span class="keyword">long</span>.class, <span class="keyword">long</span>.class,</div><div class="line">                Intent.class, Resources[].class, ClassLoader[].class, AssetManager[].class);</div><div class="line">            <span class="keyword">return</span> constructor.newInstance(<span class="keyword">this</span>, tinkerFlags, tinkerLoadVerifyFlag,</div><div class="line">                applicationStartElapsedTime, applicationStartMillisTime,</div><div class="line">                tinkerResultIntent, resources, classLoader, assetManager);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(<span class="string">"createDelegate failed"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">ensureDelegate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (delegate == <span class="keyword">null</span>) &#123;</div><div class="line">            delegate = createDelegate();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Hook for sub-classes to run logic after the &#123;<span class="doctag">@link</span> Application#attachBaseContext&#125; has been</div><div class="line">     * called but before the delegate is created. Implementors should be very careful what they do</div><div class="line">     * here since &#123;<span class="doctag">@link</span> android.app.Application#onCreate&#125; will not have yet been called.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onBaseContextAttached</span><span class="params">(Context base)</span> </span>&#123;</div><div class="line">        applicationStartElapsedTime = SystemClock.elapsedRealtime();</div><div class="line">        applicationStartMillisTime = System.currentTimeMillis();</div><div class="line">        loadTinker();</div><div class="line">        ensureDelegate();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Method method = ShareReflectUtil.findMethod(delegate, <span class="string">"onBaseContextAttached"</span>, Context.class);</div><div class="line">            method.invoke(delegate, base);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(<span class="string">"onBaseContextAttached method not found"</span>, t);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//é‡ç½®å®‰å…¨æ¨¡å¼æ¬¡æ•°ï¼Œå¤§äºç­‰äºä¸‰æ¬¡ä¼šè¿›å…¥å®‰å…¨æ¨¡å¼ä¸å†åŠ è½½</span></div><div class="line">        <span class="keyword">if</span> (useSafeMode) &#123;</div><div class="line">            String processName = ShareTinkerInternals.getProcessName(<span class="keyword">this</span>);</div><div class="line">            String preferName = ShareConstants.TINKER_OWN_PREFERENCE_CONFIG + processName;</div><div class="line">            SharedPreferences sp = getSharedPreferences(preferName, Context.MODE_PRIVATE);</div><div class="line">            sp.edit().putInt(ShareConstants.TINKER_SAFE_MODE_COUNT, <span class="number">0</span>).commit();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.attachBaseContext(base);</div><div class="line">        onBaseContextAttached(base);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">delegateMethod</span><span class="params">(String methodName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (delegate != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Method method = ShareReflectUtil.findMethod(delegate, methodName, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">                method.invoke(delegate, <span class="keyword">new</span> Object[<span class="number">0</span>]);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(String.format(<span class="string">"%s method not found"</span>, methodName), t);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        ensureDelegate();</div><div class="line">        delegateMethod(<span class="string">"onCreate"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TinkerApplicationç»§æ‰¿è‡ªApplicationï¼Œè¯´æ˜å®ƒæ˜¯æ­£ç»çš„Applicationï¼Œè€Œä¸”åœ¨manifestæ–‡ä»¶ä¸­å£°æ˜çš„ä¹Ÿå¿…é¡»æ˜¯å®ƒã€‚ç„¶ååœ¨Applicationçš„å„ä¸ªå£°æ˜å‘¨æœŸæ–¹æ³•ä¸­åå°„è°ƒç”¨<code>delegate</code>åŒæ­¥Applicationçš„å‘¨æœŸæ–¹æ³•å›è°ƒï¼Œå…¶ä¸­çš„<code>delegate</code>æ˜¯æˆ‘ä»¬ä¼ è¿‡æ¥çš„æˆ‘ä»¬é¡¹ç›®ä¸­çš„Application <code>MyApplication</code>ã€‚</p>
<p>å…¶ä¸­çš„loaderTinker()æ–¹æ³•æ˜¯Tinkerçš„åŠ è½½æµç¨‹ï¼Œæˆ‘ä»¬ç¨åä¼šè®²åˆ°ï¼Œåœ¨åå°„è°ƒç”¨MyApplicationçš„attachBaseContextä¹‹å‰ï¼ŒloaderTinker()å·²ç»è¢«è°ƒç”¨å®Œæˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒTinkeræ˜¯åœ¨åŠ è½½å®Œæ•´ä¸ªæµç¨‹ä¹‹åæ‰å»è°ƒç”¨çš„appä¸­çš„Applicationçš„attachBaseContextå¼€å§‹çœŸæ­£çš„æ•´ä¸ªAppçš„ç”Ÿå‘½å‘¨æœŸã€‚è¯´ç™½äº†å°±æ˜¯é‡‡ç”¨äº†ä»£ç†ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœä½ çœ‹è¿‡æˆ‘ä¹‹å‰å†™çš„<a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a>ï¼Œå°±ä¼šå‘ç°è·Ÿè¿™ä¸ªå¥½åƒã€‚åŒºåˆ«åœ¨äºï¼ŒInstantRunæ˜¯åœ¨ç¼–è¯‘å™¨ä¿®æ”¹manifestæ’å…¥IncrementalClassLoaderï¼Œè¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢æˆé¡¹ç›®ä¸­å®é™…ä½¿ç”¨çš„MyApplicationï¼Œè¿›è€Œæ›¿æ¢äº†ClassLoaderå’Œèµ„æºç­‰ï¼Œå¼€å‘è€…åœ¨æ¯«ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å°±å®Œæˆäº†æ›¿æ¢ã€‚</p>
<p>å…¶ä¸­å¤§é‡ä½¿ç”¨äº†åå°„ï¼Œhookç³»ç»Ÿapiï¼Œæ›¿æ¢è¿è¡Œæ—¶ç³»ç»Ÿä¸­ä¿æœ‰çš„Applicationçš„å¼•ç”¨ï¼Œæœ€ç»ˆå®Œæˆæ›¿æ¢ï¼ŒTinkerå›¢é˜Ÿä¹‹å‰åšè¿‡æµ‹è¯•ï¼Œ100wäººä¼šæœ‰å‡ åä¸ªåœ¨æ›¿æ¢çš„æ—¶å€™å‡ºç°é—®é¢˜ï¼Œè€Œä¸”å¦‚æœåå°„æ›¿æ¢Applicationçš„é—®é¢˜ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸å¯é€†çš„ã€‚Tinkerä¸ºäº†å…¼å®¹æ€§é—®é¢˜è€ƒè™‘ï¼Œé‡‡ç”¨äº†å·¥ç¨‹ä»£ç†çš„æ–¹å¼ï¼Œé¿å…è¿›å…¥å…¼å®¹æ€§çš„å‘ã€‚è™½ç„¶å¯ä»¥ç”¨æ³¨è§£çš„æ–¹å¼ç”Ÿæˆï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ç›¸æ¯”InstantRunçš„é‚£ä¸€å¥—æ¥å…¥æˆæœ¬è¿˜æ˜¯å¢å¤§ä¸å°‘ï¼Œä¸è¿‡ä¸ºäº†çº¿ä¸Šçš„ç¨³å®šï¼Œè¿™ä¸€åˆ‡éƒ½æ˜¯å€¼å¾—çš„ã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTinkerApplicationæ˜¯é‡‡ç”¨åå°„è°ƒç”¨çš„MyApplicationï¼Œä¸ºä»€ä¹ˆä¸€å®šæ˜¯åå°„ï¼Œæˆ‘ä»¬ç›´æ¥ä¼ è¿‡å»MyApplicationçš„å¼•ç”¨ç›´æ¥è°ƒç”¨ä¸å°±å¥½äº†å—ï¼Ÿå…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åé¢ä¼šè¯¦ç»†è¯´æ˜ã€‚</p>
<h1 id="è¡¥ä¸åŠ è½½"><a href="#è¡¥ä¸åŠ è½½" class="headerlink" title="è¡¥ä¸åŠ è½½"></a>è¡¥ä¸åŠ è½½</h1><p>åœ¨è¡¥ä¸åŠ è½½ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¡¥ä¸æ–‡ä»¶ç°åœ¨å·²ç»ä¸‹å‘åˆ°appä¸­ï¼Œå¹¶ä¸”é€šè¿‡dexDiffåˆæˆå¹¶ä¸”æ ¡éªŒç„¶åpushåˆ°<code>/data/data/package_name/tinker/</code>ä¸‹ã€‚å¤§æ¦‚çš„æ–‡ä»¶ç›®å½•ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">root@android:/data/data/tinker.sample.android/tinker # ls</div><div class="line">info.lock</div><div class="line">patch-bc7c9396</div><div class="line">patch.info</div><div class="line"></div><div class="line">root@android:/data/data/tinker.sample.android/tinker/patch-bc7c9396 # ls</div><div class="line">dex</div><div class="line">odex</div><div class="line">patch-bc7c9396.apk</div><div class="line">res</div></pre></td></tr></table></figure>
<p>åˆšæ‰è®²åˆ°loadTinker()æ–¹æ³•æ˜¯å®ç°TinkeråŠ è½½è¡¥ä¸çš„å…³é”®ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸‹å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadTinker</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//disable tinker, not need to install</span></div><div class="line">    <span class="keyword">if</span> (tinkerFlags == TINKER_DISABLE) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    tinkerResultIntent = <span class="keyword">new</span> Intent();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//reflect tinker loader, because loaderClass may be define by user!</span></div><div class="line">        Class&lt;?&gt; tinkerLoadClass = Class.forName(loaderClassName, <span class="keyword">false</span>, getClassLoader());</div><div class="line"></div><div class="line">        Method loadMethod = tinkerLoadClass.getMethod(TINKER_LOADER_METHOD, TinkerApplication.class, <span class="keyword">int</span>.class, <span class="keyword">boolean</span>.class);</div><div class="line">        Constructor&lt;?&gt; constructor = tinkerLoadClass.getConstructor();</div><div class="line">        tinkerResultIntent = (Intent) loadMethod.invoke(constructor.newInstance(), <span class="keyword">this</span>, tinkerFlags, tinkerLoadVerifyFlag);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        <span class="comment">//has exception, put exception error code</span></div><div class="line">        ShareIntentUtil.setIntentReturnCode(tinkerResultIntent, ShareConstants.ERROR_LOAD_PATCH_UNKNOWN_EXCEPTION);</div><div class="line">        tinkerResultIntent.putExtra(INTENT_PATCH_EXCEPTION, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„<code>loaderClassName</code>æ˜¯æˆ‘ä»¬ä¼ è¿‡æ¥çš„<code>&quot;com.tencent.tinker.loader.TinkerLoader&quot;</code>ï¼Œåå°„è°ƒç”¨TinkerLoaderçš„tryLoad()æ–¹æ³•æ‹¿åˆ°åŠ è½½è¡¥ä¸ç»“æœï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¹Ÿè¦ç”¨åå°„ï¼Œæ˜¯å› ä¸ºTinkeråšäº†å¾ˆå¤šæ‰©å±•æ€§çš„å·¥ä½œï¼ŒTinkerLoaderåªæ˜¯é»˜è®¤å®ç°ï¼Œå¼€å‘è€…å®Œå…¨å¯ä»¥è‡ªå·±å®šä¹‰åŠ è½½å™¨å®ŒæˆåŠ è½½æµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//TinkerLoader</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * only main process can handle patch version change or incomplete</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">tryLoad</span><span class="params">(TinkerApplication app, <span class="keyword">int</span> tinkerFlag, <span class="keyword">boolean</span> tinkerLoadVerifyFlag)</span> </span>&#123;</div><div class="line">        Intent resultIntent = <span class="keyword">new</span> Intent();</div><div class="line"></div><div class="line">        <span class="keyword">long</span> begin = SystemClock.elapsedRealtime();</div><div class="line">        tryLoadPatchFilesInternal(app, tinkerFlag, tinkerLoadVerifyFlag, resultIntent);</div><div class="line">        <span class="keyword">long</span> cost = SystemClock.elapsedRealtime() - begin;</div><div class="line">        ShareIntentUtil.setIntentPatchCostTime(resultIntent, cost);</div><div class="line">        <span class="keyword">return</span> resultIntent;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨tryLoadPatchFilesInternal()æ–¹æ³•ï¼Œç„¶åè®¡ç®—æ¶ˆè€—æ—¶é—´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryLoadPatchFilesInternal</span><span class="params">(TinkerApplication app, <span class="keyword">int</span> tinkerFlag, <span class="keyword">boolean</span> tinkerLoadVerifyFlag, Intent resultIntent)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    ...</div><div class="line">        <span class="comment">//tinker/patch.info</span></div><div class="line">        File patchInfoFile = SharePatchFileUtil.getPatchInfoFile(patchDirectoryPath);</div><div class="line"></div><div class="line">        <span class="comment">//old = 641e634c5b8f1649c75caf73794acbdf</span></div><div class="line">        <span class="comment">//new = 2c150d8560334966952678930ba67fa8</span></div><div class="line">        File patchInfoLockFile = SharePatchFileUtil.getPatchInfoLockFile(patchDirectoryPath);</div><div class="line"></div><div class="line">        patchInfo = SharePatchInfo.readAndCheckPropertyWithLock(patchInfoFile, patchInfoLockFile);</div><div class="line"></div><div class="line">        String oldVersion = patchInfo.oldVersion;</div><div class="line">        String newVersion = patchInfo.newVersion;</div><div class="line"></div><div class="line">        resultIntent.putExtra(ShareIntentUtil.INTENT_PATCH_OLD_VERSION, oldVersion);</div><div class="line">        resultIntent.putExtra(ShareIntentUtil.INTENT_PATCH_NEW_VERSION, newVersion);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> mainProcess = ShareTinkerInternals.isInMainProcess(app);</div><div class="line">        <span class="keyword">boolean</span> versionChanged = !(oldVersion.equals(newVersion));</div><div class="line"></div><div class="line">        String version = oldVersion;</div><div class="line">        <span class="keyword">if</span> (versionChanged &amp;&amp; mainProcess) &#123;</div><div class="line">            version = newVersion;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//patch-641e634c</span></div><div class="line">        String patchName = SharePatchFileUtil.getPatchVersionDirectory(version);</div><div class="line"></div><div class="line">        <span class="comment">//tinker/patch.info/patch-641e634c</span></div><div class="line">        String patchVersionDirectory = patchDirectoryPath + <span class="string">"/"</span> + patchName;</div><div class="line">        File patchVersionDirectoryFile = <span class="keyword">new</span> File(patchVersionDirectory);</div><div class="line"></div><div class="line">        <span class="comment">//tinker/patch.info/patch-641e634c/patch-641e634c.apk</span></div><div class="line">        File patchVersionFile = <span class="keyword">new</span> File(patchVersionDirectoryFile.getAbsolutePath(), SharePatchFileUtil.getPatchVersionFile(version));</div><div class="line"></div><div class="line">        ShareSecurityCheck securityCheck = <span class="keyword">new</span> ShareSecurityCheck(app);</div><div class="line"></div><div class="line"><span class="comment">//æ ¡éªŒç­¾åå’ŒtinkerId</span></div><div class="line">        <span class="keyword">int</span> returnCode = ShareTinkerInternals.checkSignatureAndTinkerID(app, patchVersionFile, securityCheck);</div><div class="line"></div><div class="line">        resultIntent.putExtra(ShareIntentUtil.INTENT_PATCH_PACKAGE_CONFIG, securityCheck.getPackagePropertiesIfPresent());</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isEnabledForDex = ShareTinkerInternals.isTinkerEnabledForDex(tinkerFlag);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (isEnabledForDex) &#123;</div><div class="line">            <span class="comment">//tinker/patch.info/patch-641e634c/dex</span></div><div class="line">            <span class="keyword">boolean</span> dexCheck = TinkerDexLoader.checkComplete(patchVersionDirectory, securityCheck, resultIntent);</div><div class="line">            <span class="keyword">if</span> (!dexCheck) &#123;</div><div class="line">                <span class="comment">//file not found, do not load patch</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isEnabledForNativeLib = ShareTinkerInternals.isTinkerEnabledForNativeLib(tinkerFlag);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (isEnabledForNativeLib) &#123;</div><div class="line">            <span class="comment">//tinker/patch.info/patch-641e634c/lib</span></div><div class="line">            <span class="keyword">boolean</span> libCheck = TinkerSoLoader.checkComplete(patchVersionDirectory, securityCheck, resultIntent);</div><div class="line">            <span class="keyword">if</span> (!libCheck) &#123;</div><div class="line">                <span class="comment">//file not found, do not load patch</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//check resource</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isEnabledForResource = ShareTinkerInternals.isTinkerEnabledForResource(tinkerFlag);</div><div class="line">        Log.w(TAG, <span class="string">"tryLoadPatchFiles:isEnabledForResource:"</span> + isEnabledForResource);</div><div class="line">        <span class="keyword">if</span> (isEnabledForResource) &#123;</div><div class="line">            <span class="keyword">boolean</span> resourceCheck = TinkerResourceLoader.checkComplete(app, patchVersionDirectory, securityCheck, resultIntent);</div><div class="line">            <span class="keyword">if</span> (!resourceCheck) &#123;</div><div class="line">                <span class="comment">//file not found, do not load patch</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//we should first try rewrite patch info file, if there is a error, we can't load jar</span></div><div class="line">        <span class="keyword">if</span> (mainProcess &amp;&amp; versionChanged) &#123;</div><div class="line">            patchInfo.oldVersion = version;</div><div class="line">            <span class="comment">//update old version to new</span></div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//æ˜¯å¦å·²ç»è¿›å…¥å®‰å…¨æ¨¡å¼</span></div><div class="line">        <span class="keyword">if</span> (!checkSafeModeCount(app)) &#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//now we can load patch jar</span></div><div class="line">        <span class="keyword">if</span> (isEnabledForDex) &#123;</div><div class="line">            <span class="keyword">boolean</span> loadTinkerJars = TinkerDexLoader.loadTinkerJars(app, tinkerLoadVerifyFlag, patchVersionDirectory, resultIntent);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//now we can load patch resource</span></div><div class="line">        <span class="keyword">if</span> (isEnabledForResource) &#123;</div><div class="line">            <span class="keyword">boolean</span> loadTinkerResources = TinkerResourceLoader.loadTinkerResources(tinkerLoadVerifyFlag, patchVersionDirectory, resultIntent);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//all is ok!</span></div><div class="line">        ShareIntentUtil.setIntentReturnCode(resultIntent, ShareConstants.ERROR_LOAD_OK);</div><div class="line">        Log.i(TAG, <span class="string">"tryLoadPatchFiles: load end, ok!"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è´´çš„ä»£ç çœç•¥äº†å¥½å¤šåˆ¤ç©ºæ“ä½œï¼Œä¼šåˆ¤æ–­è¡¥ä¸æ˜¯å¦å­˜åœ¨ï¼Œæ£€æŸ¥è¡¥ä¸ä¿¡æ¯ä¸­çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼Œæ ¡éªŒè¡¥ä¸ç­¾åä»¥åŠtinkerIdä¸åŸºå‡†åŒ…æ˜¯å¦ä¸€è‡´ã€‚åœ¨æ ¡éªŒç­¾åæ—¶ï¼Œä¸ºäº†åŠ é€Ÿæ ¡éªŒé€Ÿåº¦ï¼ŒTinkeråªæ ¡éªŒ <code>*_meta.txt</code>æ–‡ä»¶ï¼Œç„¶åå†æ ¹æ®metaæ–‡ä»¶ä¸­çš„md5æ ¡éªŒå…¶ä»–æ–‡ä»¶ã€‚<br>å…¶ä¸­ï¼Œmetaæ–‡ä»¶æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>package_meta.txt è¡¥ä¸åŒ…çš„åŸºæœ¬ä¿¡æ¯</li>
<li>dex_meta.txt     è¡¥ä¸åŒ…ä¸­dexæ–‡ä»¶çš„ä¿¡æ¯</li>
<li>so_meta.txt      è¡¥ä¸åŒ…ä¸­soæ–‡ä»¶çš„ä¿¡æ¯</li>
<li>res_meta.txt     è¡¥ä¸åŒ…ä¸­èµ„æºæ–‡ä»¶çš„ä¿¡æ¯</li>
</ul>
<p>ç„¶åæ ¹æ®å¼€å‘è€…é…ç½®çš„Tinkerå¯è¡¥ä¸ç±»å‹åˆ¤æ–­æ˜¯å¦å¯ä»¥åŠ è½½dexï¼Œresï¼Œsoã€‚ç„¶ååˆ†åˆ«åˆ†å‘ç»™TinkerDexLoaderã€TinkerSoLoaderã€TinkerResourceLoaderåˆ†åˆ«è¿›è¡Œæ ¡éªŒæ˜¯å¦ç¬¦åˆåŠ è½½æ¡ä»¶è¿›è€Œè¿›è¡ŒåŠ è½½ã€‚</p>
<h2 id="åŠ è½½è¡¥ä¸dex"><a href="#åŠ è½½è¡¥ä¸dex" class="headerlink" title="åŠ è½½è¡¥ä¸dex"></a>åŠ è½½è¡¥ä¸dex</h2><p>åœ¨å¼€å§‹è®²load dexä¹‹å‰ï¼Œå…ˆè¯´ä¸‹Tinkerçš„è¡¥ä¸æ–¹æ¡ˆï¼ŒTinkeré‡‡ç”¨çš„æ˜¯ä¸‹å‘å·®åˆ†åŒ…ï¼Œç„¶ååœ¨æ‰‹æœºç«¯åˆæˆå…¨é‡çš„dexæ–‡ä»¶è¿›è¡ŒåŠ è½½ã€‚è€Œåœ¨build.gradleé…ç½®ä¸­çš„tinkerPatch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dex.loader = [<span class="string">"com.tencent.tinker.loader.*"</span>,</div><div class="line"><span class="string">"tinker.sample.android.app.SampleApplication"</span>,</div><div class="line"><span class="string">"tinker.sample.android.app.BaseBuildInfo"</span></div><div class="line">]</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªé…ç½®ä¸­çš„ç±»ä¸ä¼šå‡ºç°åœ¨ä»»ä½•å…¨é‡è¡¥ä¸dexé‡Œï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åˆæˆåï¼Œè¿™äº›ç±»è¿˜åœ¨è€çš„dexæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚åœ¨è¡¥ä¸å‰dexé¡ºåºæ˜¯è¿™æ ·çš„ï¼š<code>oldDex1 -&gt; oldDex2 -&gt; oldDex3..</code>ï¼Œé‚£ä¹ˆå‡å¦‚ä¿®æ”¹äº†dex1ä¸­çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆè¡¥ä¸é¡ºåºæ˜¯è¿™æ ·çš„<code>newDex1 -&gt; oldDex1 -&gt; oldDex2...</code>å…¶ä¸­åˆæˆåçš„newDex1ä¸­çš„ç±»æ˜¯oldDex1ä¸­é™¤äº†dex.loaderä¸­æ ‡æ˜çš„ç±»ä¹‹å¤–çš„æ‰€æœ‰ç±»ï¼Œdex.loaderä¸­çš„ç±»ä¾ç„¶åœ¨oldDex1ä¸­ã€‚</p>
<p>ç”±äºTinkerçš„æ–¹æ¡ˆæ˜¯åŸºäºMultidexå®ç°çš„ä¿®æ”¹dexElementsçš„é¡ºåºå®ç°çš„ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯è¦ä¿®æ”¹classLoderä¸­dexPathListä¸­dexElementsçš„é¡ºåºã€‚Androidä¸­æœ‰ä¸¤ç§ClassLoaderç”¨äºåŠ è½½dexæ–‡ä»¶ï¼ŒBootClassLoaderã€PathClassLoaderå’ŒDexClassLoaderéƒ½æ˜¯ç»§æ‰¿è‡ªBaseDexClassLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span></div><div class="line">            String libraryPath, ClassLoader parent) &#123;</div><div class="line">        <span class="keyword">super</span>(parent);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.originalPath = dexPath;</div><div class="line">        <span class="keyword">this</span>.pathList =</div><div class="line">            <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, libraryPath, optimizedDirectory);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        Class clazz = pathList.findClass(name);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> clazz;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//DexPathList</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</div><div class="line">            DexFile dex = element.dexFile;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</div><div class="line">                Class clazz = dex.loadClassBinaryName(name, definingContext);</div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> clazz;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆåœ¨DexPathListçš„findClassä¸­éå†dexElementsï¼Œè°åœ¨å‰é¢ç”¨è°ã€‚è€Œè¿™ä¸ªdexElementsæ˜¯åœ¨æ–¹æ³•makeDexElementsä¸­ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯hookè¿™ä¸ªæ–¹æ³•æŠŠdexæ’å…¥åˆ°dexElementsçš„å‰é¢ã€‚</p>
<p>ç»§ç»­åŠ è½½æµç¨‹ï¼Œé¦–å…ˆè°ƒç”¨TinkerDexLoaderçš„checkCompleteæ ¡éªŒdex_meta.xmlæ–‡ä»¶ä¸­è®°è½½çš„dexè¡¥ä¸æ–‡ä»¶å’Œç»è¿‡optä¼˜åŒ–è¿‡çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œç„¶åè°ƒç”¨loadTinkerJarsåŠ è½½è¡¥ä¸dexã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/**</span></div><div class="line">     * Load tinker JARs and add them to</div><div class="line">     * the Application ClassLoader.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> application The application.</div><div class="line">     */</div><div class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">loadTinkerJars</span><span class="params">(Application application, <span class="keyword">boolean</span> tinkerLoadVerifyFlag, String directory, Intent intentResult)</span> </span>&#123;</div><div class="line"></div><div class="line">        PathClassLoader classLoader = (PathClassLoader) TinkerDexLoader.class.getClassLoader();</div><div class="line"></div><div class="line">        String dexPath = directory + <span class="string">"/"</span> + DEX_PATH + <span class="string">"/"</span>;</div><div class="line">        File optimizeDir = <span class="keyword">new</span> File(directory + <span class="string">"/"</span> + DEX_OPTIMIZE_PATH);</div><div class="line"></div><div class="line">        ArrayList&lt;File&gt; legalFiles = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isArtPlatForm = ShareTinkerInternals.isVmArt();</div><div class="line">        <span class="keyword">for</span> (ShareDexDiffPatchInfo info : dexList) &#123;</div><div class="line">            <span class="comment">//for dalvik, ignore art support dex</span></div><div class="line">            <span class="keyword">if</span> (isJustArtSupportDex(info)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            String path = dexPath + info.realName;</div><div class="line">            File file = <span class="keyword">new</span> File(path);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (tinkerLoadVerifyFlag) &#123;</div><div class="line">                <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">                String checkMd5 = isArtPlatForm ? info.destMd5InArt : info.destMd5InDvm;</div><div class="line">                <span class="keyword">if</span> (!SharePatchFileUtil.verifyDexFileMd5(file, checkMd5)) &#123;</div><div class="line">                    <span class="comment">//it is good to delete the mismatch file</span></div><div class="line">                    ...</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            legalFiles.add(file);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            SystemClassLoaderAdder.installDexes(application, classLoader, optimizeDir, legalFiles);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"install dexes failed"</span>);</div><div class="line"><span class="comment">//            e.printStackTrace();</span></div><div class="line">            intentResult.putExtra(ShareIntentUtil.INTENT_PATCH_EXCEPTION, e);</div><div class="line">            ShareIntentUtil.setIntentReturnCode(intentResult, ShareConstants.ERROR_LOAD_PATCH_VERSION_DEX_LOAD_EXCEPTION);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        Log.i(TAG, <span class="string">"after loaded classloader: "</span> + application.getClassLoader().toString());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ ¹æ®ä¼ è¿‡æ¥çš„tinkerLoadVerifyFlagé€‰é¡¹æ§åˆ¶æ˜¯å¦æ¯æ¬¡åŠ è½½éƒ½è¦éªŒè¯dexçš„md5å€¼ï¼Œä¸€èˆ¬æ¥è¯´ä¸éœ€è¦ï¼Œé»˜è®¤ä¹Ÿæ˜¯falseï¼Œä¼šèŠ‚çœåŠ è½½æ—¶é—´ã€‚ç„¶åè°ƒç”¨SystemClassLoaderAdderå»åŠ è½½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//SystemClassLoaderAdder</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">installDexes</span><span class="params">(Application application, PathClassLoader loader, File dexOptDir, List&lt;File&gt; files)</span></span></div><div class="line">        <span class="keyword">throws</span> Throwable &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!files.isEmpty()) &#123;</div><div class="line">            ClassLoader classLoader = loader;</div><div class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">24</span>) &#123;</div><div class="line">                classLoader = AndroidNClassLoader.inject(loader, application);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//because in dalvik, if inner class is not the same classloader with it wrapper class.</span></div><div class="line">            <span class="comment">//it won't fail at dex2opt</span></div><div class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">23</span>) &#123;</div><div class="line">                V23.install(classLoader, files, dexOptDir);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</div><div class="line">                V19.install(classLoader, files, dexOptDir);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">14</span>) &#123;</div><div class="line">                V14.install(classLoader, files, dexOptDir);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                V4.install(classLoader, files, dexOptDir);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!checkDexInstall()) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(ShareConstants.CHECK_DEX_INSTALL_FAIL);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœä½ ä¹‹å‰çœ‹è¿‡Multidex.install()æ–¹æ³•çš„å®ç°ï¼Œå°±ä¼šæ„Ÿè§‰å¾ˆç›¸ä¼¼ã€‚åªä¸è¿‡çƒ­ä¿®å¤æ˜¯æŠŠdexæ’åˆ°dexElementsçš„å‰é¢ï¼ŒMultidexæ˜¯æŠŠå…¶ä½™çš„dexæ’åˆ°åé¢ã€‚ç›¸åŒçš„å°±æ˜¯éƒ½æ˜¯åˆ†ç‰ˆæœ¬åŠ è½½ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ï¼Œç”±äºv14ä»¥ä¸‹(Android4.0ä»¥å‰)å¤ªè¿‡å¤è€ï¼Œæˆ‘ä»¬å°±ä¸çœ‹äº†ï¼Œä»v14å¼€å§‹ã€‚</p>
<h3 id="v14"><a href="#v14" class="headerlink" title="v14"></a>v14</h3><p>14 &lt;= SDK &lt; 19<br>Android 4.0 &lt;= Androidç³»ç»Ÿ &lt; Android 4.4</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Installer for platform versions 14, 15, 16, 17 and 18.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V14</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries,</span></span></div><div class="line">                                File optimizedDirectory)</div><div class="line">        <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</div><div class="line">        NoSuchFieldException, InvocationTargetException, NoSuchMethodException &#123;</div><div class="line">        Field pathListField = ShareReflectUtil.findField(loader, <span class="string">"pathList"</span>);</div><div class="line">        Object dexPathList = pathListField.get(loader);</div><div class="line">        ShareReflectUtil.expandFieldArray(dexPathList, <span class="string">"dexElements"</span>, makeDexElements(dexPathList,</div><div class="line">            <span class="keyword">new</span> ArrayList&lt;File&gt;(additionalClassPathEntries), optimizedDirectory));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object[] makeDexElements(</div><div class="line">        Object dexPathList, ArrayList&lt;File&gt; files, File optimizedDirectory)</div><div class="line">        <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException,</div><div class="line">        NoSuchMethodException &#123;</div><div class="line">        Method makeDexElements =</div><div class="line">            ShareReflectUtil.findMethod(dexPathList, <span class="string">"makeDexElements"</span>, ArrayList.class, File.class);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (Object[]) makeDexElements.invoke(dexPathList, files, optimizedDirectory);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åå°„æ‰¾åˆ°classLoderä¸­çš„pathListï¼Œç„¶ååå°„è°ƒç”¨pathListä¸­çš„makeDexElementsæ–¹æ³•ï¼Œç©¿è¿›å»çš„å‚æ•°åˆ†åˆ«æ˜¯è¡¥ä¸dexListå’Œä¼˜åŒ–è¿‡çš„optç›®å½•ï¼Œåœ¨Tinkerä¸­æ˜¯dexè¡¥ä¸ç›®å½•çš„åŒçº§ç›®å½•<code>odex/</code>ã€‚</p>
<p>å…¶ä¸­æœ‰ä¸ªShareReflectUtil.expandFieldArrayæˆ‘ä»¬çœ‹ä¸‹å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expandFieldArray</span><span class="params">(Object instance, String fieldName, Object[] extraElements)</span></span></div><div class="line">    <span class="keyword">throws</span> NoSuchFieldException, IllegalArgumentException, IllegalAccessException &#123;</div><div class="line">    Field jlrField = findField(instance, fieldName);</div><div class="line"></div><div class="line">    Object[] original = (Object[]) jlrField.get(instance);</div><div class="line">    Object[] combined = (Object[]) Array.newInstance(original.getClass().getComponentType(), original.length + extraElements.length);</div><div class="line"></div><div class="line">    <span class="comment">// <span class="doctag">NOTE:</span> changed to copy extraElements first, for patch load first</span></div><div class="line"></div><div class="line">    System.arraycopy(extraElements, <span class="number">0</span>, combined, <span class="number">0</span>, extraElements.length);</div><div class="line">    System.arraycopy(original, <span class="number">0</span>, combined, extraElements.length, original.length);</div><div class="line"></div><div class="line">    jlrField.set(instance, combined);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ä¼ è¿›æ¥çš„å€¼åˆ†åˆ«æ˜¯pathList,â€dexElementsâ€å’Œæ–°ç”Ÿæˆçš„dexElementsæ•°ç»„ï¼Œæ‰¾åˆ°pathListçš„åŸå§‹oldDexElementsï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°ç»„combinedï¼Œé•¿åº¦æ˜¯oldDexElements.length + newDexElements.lengthã€‚ç„¶åå°†newDexElementsæ‹·è´åˆ°combinedçš„å‰é¢ï¼Œå°†oldDexElementsæ‹·è´çš„combinedçš„å‰©ä½™ä½ç½®ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºdexå‰ç½®ã€‚</p>
<p>åˆšæ‰æˆ‘ä»¬è¯´Tinkeræ˜¯å°†dexå‰ç½®ï¼ŒMultidexæ˜¯å°†dexåç½®ï¼Œæˆ‘ä»¬é¡ºä¾¿çœ‹ä¸‹Multidex.install()ä¸­expandFieldArrayçš„å®ç°å§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Multidex.java</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expandFieldArray</span><span class="params">(Object instance, String fieldName,</span></span></div><div class="line">            Object[] extraElements) <span class="keyword">throws</span> NoSuchFieldException, IllegalArgumentException,</div><div class="line">            IllegalAccessException &#123;</div><div class="line">        Field jlrField = findField(instance, fieldName);</div><div class="line">        Object[] original = (Object[]) jlrField.get(instance);</div><div class="line">        Object[] combined = (Object[]) Array.newInstance(</div><div class="line">                original.getClass().getComponentType(), original.length + extraElements.length);</div><div class="line">        System.arraycopy(original, <span class="number">0</span>, combined, <span class="number">0</span>, original.length);</div><div class="line">        System.arraycopy(extraElements, <span class="number">0</span>, combined, original.length, extraElements.length);</div><div class="line">        jlrField.set(instance, combined);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å®ƒæ˜¯å…ˆæŠŠoldDexElementsæ‹·è´åˆ°äº†å‰é¢ï¼Œåœ¨æŠŠnewDexElementsæ‹·è´åˆ°äº†åé¢ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºdexåç½®ã€‚</p>
<p>å®é™…ä¸Šï¼Œå¯¹äºMultidexçš„é¡¹ç›®ï¼Œä¸è®ºTinkeræ˜¯å¦åŠ è½½äº†è¡¥ä¸ï¼Œéƒ½åº”è¯¥åœ¨ApplicationLikeçš„onBaseContextAttachedæ–¹æ³•ä¸­æ‰§è¡Œ<code>MultiDex.install(base);</code>ã€‚</p>
<h3 id="v19"><a href="#v19" class="headerlink" title="v19"></a>v19</h3><p>19 &lt;= SDK &lt; 23<br>Android 4.4 &lt;= Androidç³»ç»Ÿ &lt; Android 6.0</p>
<p>è·Ÿv14çš„åŒºåˆ«ä¸å¤§ï¼Œåªæ˜¯åœ¨makeDexElementsæ–¹æ³•ä¸­å¤šåŠ äº†ä¸€ä¸ªå‚æ•°suppressedExceptionså¼‚å¸¸æ•°ç»„ï¼Œå¦å¤–åœ¨makeDexElementsçš„catchå¼‚å¸¸ä¸­å¤šåŠ äº†ä¸€æ¬¡é‡è¯•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">                Log.e(TAG, <span class="string">"NoSuchMethodException: makeDexElements(ArrayList,File,ArrayList) failure"</span>);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    makeDexElements = ShareReflectUtil.findMethod(dexPathList, <span class="string">"makeDexElements"</span>, List.class, File.class, List.class);</div><div class="line">                &#125; <span class="keyword">catch</span> (NoSuchMethodException e1) &#123;</div><div class="line">                    Log.e(TAG, <span class="string">"NoSuchMethodException: makeDexElements(List,File,List) failure"</span>);</div><div class="line">                    <span class="keyword">throw</span> e1;</div><div class="line">                &#125;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>æ˜¯å› ä¸ºTinkerå‘ç°çº¿ä¸Šæœ‰çš„Romå°†æ”¹æ–¹æ³•å‚æ•°ç±»å‹ç»™æ”¹äº†ï¼Œæœ¬æ¥æ˜¯<code>makeDexElements(ArrayList,File,ArrayList)</code>ï¼Œç»™æ”¹æˆäº†<code>makeDexElements(List,File,List)</code>ï¼Œåšäº†ä¸ªå…¼å®¹å¤„ç†ã€‚</p>
<h3 id="v23"><a href="#v23" class="headerlink" title="v23"></a>v23</h3><p>23 &lt;= SDK &lt; 24<br>Android 6.0 &lt;= Androidç³»ç»Ÿ &lt; Android 7.0</p>
<p>Android6.0ä»¥åæŠŠmakeDexElementsç»™æ”¹äº†ï¼Œæ”¹æˆäº†<code>makePathElements(List,File,List)</code>ï¼Œå¦‚æœæ‰¾ä¸åˆ°çš„è¯å†æ‰¾ä¸€ä¸‹<code>makeDexElements(List,File,List)</code>ã€‚å…¶ä½™æ²¡å•¥åŒºåˆ«ã€‚</p>
<h3 id="v24"><a href="#v24" class="headerlink" title="v24"></a>v24</h3><p>SDK &gt;=24<br>Android ç³»ç»Ÿ &gt;= Android7.0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">24</span>) &#123;</div><div class="line">    classLoader = AndroidNClassLoader.inject(loader, application);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å“ï¼Œè¿™ä¸ªå¥½åƒè·Ÿä¸Šé¢ä¸å¤ªä¸€æ ·å•Šï¼Œè¿™æ˜¯ä¸ºå•¥å‘¢ã€‚<br><a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286341&amp;idx=1&amp;sn=054d595af6e824cbe4edd79427fc2706&amp;scene=0" target="_blank" rel="external">Android Næ··åˆç¼–è¯‘ä¸å¯¹çƒ­è¡¥ä¸å½±å“è§£æ</a>ä¸­è¯¦ç»†è§£é‡Šäº†æ··åˆç¼–è¯‘å¯¹çƒ­ä¸å®šçš„å½±å“ã€‚æˆ‘åšä¸‹ç®€å•çš„æ€»ç»“ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Dalvikè™šæ‹Ÿæœºä¸­ï¼Œæ€»æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡JITï¼ˆJust-Inâ€”Timeï¼‰æŠŠå­—èŠ‚ç æ–‡ä»¶ç¼–è¯‘æˆæœºå™¨ç æ–‡ä»¶å†æ‰§è¡Œï¼Œè¿™æ ·è·‘èµ·æ¥ç¨‹åºå°±å¾ˆæ…¢ï¼Œæ‰€åœ¨ARTä¸Šï¼Œæ”¹ä¸ºAOTï¼ˆAhead-Ofâ€”Timeï¼‰æå‰ç¼–è¯‘ï¼Œå³åœ¨å®‰è£…åº”ç”¨æˆ–OTAç³»ç»Ÿå‡çº§æ—¶æå‰æŠŠå­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ‰§è¡Œäº†ï¼Œæé«˜äº†è¿è¡Œæ•ˆç‡ã€‚ä½†æ˜¯AOTæœ‰ä¸ªç¼ºç‚¹å°±æ˜¯æ¯æ¬¡æ‰§è¡Œçš„æ—¶é—´éƒ½å¤ªé•¿äº†ï¼Œå¹¶ä¸”å ç”¨çš„ROMç©ºé—´åˆå¾ˆå¤§ï¼Œæ‰€ä»¥åœ¨Android Nä¸ŠGoogleåšäº†æ··åˆç¼–è¯‘åŒæ—¶æ”¯æŒJITå’ŒAOTã€‚æ··åˆç¼–è¯‘çš„ä½œç”¨ç®€å•æ¥è¯´ï¼Œåœ¨åº”ç”¨è¿è¡Œæ—¶åˆ†æè¿è¡Œè¿‡çš„ä»£ç ä»¥åŠâ€œçƒ­ä»£ç â€ï¼Œå¹¶å°†é…ç½®å­˜å‚¨ä¸‹æ¥ã€‚åœ¨è®¾å¤‡ç©ºé—²ä¸å……ç”µæ—¶ï¼ŒARTä»…ä»…ç¼–è¯‘è¿™ä»½é…ç½®ä¸­çš„â€œçƒ­ä»£ç â€ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨åº”ç”¨å®‰è£…å’Œé¦–æ¬¡è¿è¡Œä¸åšAOTç¼–è¯‘ï¼Œå…ˆè®©ç”¨æˆ·æ„‰å¿«çš„ç©è€èµ·æ¥ï¼Œç„¶åæŠŠåœ¨è¿è¡Œä¸­JITè§£é‡Šæ‰§è¡Œçš„é‚£éƒ¨åˆ†ä»£ç æ”¶é›†èµ·æ¥ï¼Œåœ¨æ‰‹æœºç©ºé—²çš„æ—¶å€™é€šè¿‡dex2aotç¼–è¯‘ç”Ÿæˆä¸€ä»½åä¸ºapp imageçš„base.artæ–‡ä»¶ï¼Œç„¶ååœ¨ä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™ä¸€æ¬¡æ€§æŠŠapp imageåŠ è½½è¿›æ¥åˆ°ç¼“å­˜ï¼Œé¢„å…ˆåŠ è½½ä»£æ›¿ç”¨æ—¶æŸ¥æ‰¾ä»¥æå‡åº”ç”¨çš„æ€§èƒ½ã€‚</p>
<p>è¿™ç§æ–¹å¼å¯¹çƒ­è¡¥ä¸çš„å½±å“å°±æ˜¯ï¼Œapp imageä¸­å·²ç»å­˜åœ¨çš„ç±»ä¼šè¢«æ’å…¥åˆ°ClassLoaderçš„ClassTableï¼Œå†æ¬¡åŠ è½½ç±»æ—¶ï¼Œç›´æ¥ä»ClassTableä¸­å–è€Œä¸ä¼šèµ°DefineClassã€‚å‡è®¾base.artæ–‡ä»¶åœ¨è¡¥ä¸å‰å·²ç»å­˜åœ¨ï¼Œè¿™é‡Œå­˜åœ¨ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>è¡¥ä¸ä¿®æ”¹çš„ç±»éƒ½ä¸appimageä¸­ï¼›è¿™ç§æƒ…å†µæ˜¯æœ€ç†æƒ³çš„ï¼Œæ­¤æ—¶è¡¥ä¸æœºåˆ¶ä¾ç„¶æœ‰æ•ˆï¼›</li>
<li>è¡¥ä¸ä¿®æ”¹çš„ç±»éƒ¨åˆ†åœ¨appimageä¸­ï¼›è¿™ç§æƒ…å†µæˆ‘ä»¬åªèƒ½æ›´æ–°ä¸€éƒ¨åˆ†çš„ç±»ï¼Œæ­¤æ—¶æ˜¯æœ€å±é™©çš„ã€‚ä¸€éƒ¨åˆ†ç±»æ˜¯æ–°çš„ï¼Œä¸€éƒ¨åˆ†ç±»æ˜¯æ—§çš„ï¼Œappå¯èƒ½ä¼šå‡ºç°åœ°å€é”™ä¹±è€Œå‡ºç°crashã€‚</li>
<li>è¡¥ä¸ä¿®æ”¹çš„ç±»å…¨éƒ¨åœ¨appimageä¸­ï¼›è¿™ç§æƒ…å†µåªæ˜¯é€ æˆè¡¥ä¸ä¸ç”Ÿæ•ˆï¼Œappå¹¶ä¸ä¼šå› æ­¤é€ æˆcrashã€‚</li>
</ol>
<p>Tinkerçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œå®Œå…¨åºŸå¼ƒæ‰PathClassloaderï¼Œè€Œé‡‡ç”¨ä¸€ä¸ªæ–°å»ºClassloaderæ¥åŠ è½½åç»­çš„æ‰€æœ‰ç±»ï¼Œå³å¯è¾¾åˆ°å°†cacheæ— ç”¨åŒ–çš„æ•ˆæœã€‚åŸºæœ¬åŸç†æˆ‘ä»¬æ¸…æ¥šäº†ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹ä»£ç å§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AndroidNClassLoader.java</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AndroidNClassLoader <span class="title">inject</span><span class="params">(PathClassLoader originClassLoader, Application application)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        AndroidNClassLoader classLoader = createAndroidNClassLoader(originClassLoader);</div><div class="line">        reflectPackageInfoClassloader(application, classLoader);</div><div class="line">        <span class="keyword">return</span> classLoader;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AndroidNClassLoader <span class="title">createAndroidNClassLoader</span><span class="params">(PathClassLoader original)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">//let all element ""</span></div><div class="line">        AndroidNClassLoader androidNClassLoader = <span class="keyword">new</span> AndroidNClassLoader(<span class="string">""</span>,  original);</div><div class="line">        Field originPathList = findField(original, <span class="string">"pathList"</span>);</div><div class="line">        Object originPathListObject = originPathList.get(original);</div><div class="line">        <span class="comment">//should reflect definingContext also</span></div><div class="line">        Field originClassloader = findField(originPathListObject, <span class="string">"definingContext"</span>);</div><div class="line">        originClassloader.set(originPathListObject, androidNClassLoader);</div><div class="line">        <span class="comment">//copy pathList</span></div><div class="line">        Field pathListField = findField(androidNClassLoader, <span class="string">"pathList"</span>);</div><div class="line">        <span class="comment">//just use PathClassloader's pathList</span></div><div class="line">        pathListField.set(androidNClassLoader, originPathListObject);</div><div class="line">        <span class="keyword">return</span> androidNClassLoader;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æŒ‰æ­¥éª¤è¿›è¡Œï¼š</p>
<ol>
<li>æ–°å»ºä¸€ä¸ªAndroidNClassLoader å®ƒçš„parentæ˜¯originPathClassLoaderã€‚æ³¨æ„ï¼ŒPathClassLoaderçš„optimizedDirectoryåªèƒ½æ˜¯nullï¼Œè¿™ä¸ªåé¢è¿˜æœ‰ç”¨ã€‚</li>
<li>æ‰¾åˆ°originPathClassLoaderä¸­çš„pathList å’Œ pathListä¸­çš„ç±»å‹ä¸ºClassLoaderçš„definingContextã€‚</li>
<li>æ›¿æ¢definingContextä¸ºAndroidNClassLoader</li>
<li>å°†AndroidNClassLoaderä¸­çš„pathListæ›¿æ¢ä¸ºoriginPathClassLoaderçš„pathListã€‚</li>
</ol>
<p>æœ‰çš„åŒå­¦å¯èƒ½ä¼šé—®ï¼ŒAndroid çš„ClassLoaderé‡‡ç”¨åŒäº²å§”æ‰˜æ¨¡å‹ï¼Œåªæœ‰parentæ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹æ‰ä¼šå»æ‰¾AndroidNClassLoaderï¼Œé‚£æˆ‘æ–°å»ºè¿™ä¸ªAndroidNClassLoaderæœ‰ä»€ä¹ˆç”¨ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šå»originPathClassLoaderä¸­å–æ‰¾ã€‚å…¶å®ä¸æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬å·²ç»å°†originPathClassLoaderä¸­pathListä¸­çš„definingContext(æ˜¯ä¸ªClassLoader)æ›¿æ¢ä¸ºäº†AndroidNClassLoaderäº†ã€‚è¿™ä¸ªdefiningContextä¼šåœ¨ç”ŸæˆDexFileçš„æ—¶å€™ä¼ é€’è¿›å»ï¼Œè€ŒClassLoaderçš„findClass()æ–¹æ³•ä¼šè°ƒç”¨pathListçš„findClassæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DexPathList.java</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</div><div class="line">            DexFile dex = element.dexFile;</div><div class="line">            <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</div><div class="line">                Class clazz = dex.loadClassBinaryName(name, definingContext);</div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> clazz;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨çš„dexFile.loadClassBinaryName()æ–¹æ³•ï¼Œå…¶ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°å…¶å®å°±å·²ç»æ˜¯AndroidNClassLoaderäº†ã€‚</p>
<p>è¿˜è®°å¾—åˆšæ‰è¯´çš„AndroidNClassLderçš„optimizedDirectoryæ˜¯nullå—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DexPathList.java</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makeDexElements(ArrayList&lt;File&gt; files,</div><div class="line">            File optimizedDirectory) &#123;</div><div class="line">            ...</div><div class="line">            dex = loadDexFile(file, optimizedDirectory);</div><div class="line">            ....</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DexFile <span class="title">loadDexFile</span><span class="params">(File file, File optimizedDirectory)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">if</span> (optimizedDirectory == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DexFile(file);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String optimizedPath = optimizedPathFor(file, optimizedDirectory);</div><div class="line">            <span class="keyword">return</span> DexFile.loadDex(file.getPath(), optimizedPath, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬æ˜ç™½äº†ï¼ŒoptimizedDirectoryæ˜¯ç”¨æ¥ç¼“å­˜æˆ‘ä»¬éœ€è¦åŠ è½½çš„dexæ–‡ä»¶çš„ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªDexFileå¯¹è±¡ï¼Œå¦‚æœå®ƒä¸ºnullï¼Œé‚£ä¹ˆä¼šç›´æ¥ä½¿ç”¨dexæ–‡ä»¶åŸæœ‰çš„è·¯å¾„æ¥åˆ›å»ºDexFileå¯¹è±¡ã€‚æ„æ€ä¹Ÿå°±æ˜¯è¯´æˆ‘ä¸éœ€è¦ç”¨ç¼“å­˜ï¼Œä¸éœ€è¦ç”¨app imageåŠ è½½ã€‚</p>
<p>æ¥ç»­å¾€ä¸‹èµ°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectPackageInfoClassloader</span><span class="params">(Application application, ClassLoader reflectClassLoader)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    String defBase = <span class="string">"mBase"</span>;</div><div class="line">    String defPackageInfo = <span class="string">"mPackageInfo"</span>;</div><div class="line">    String defClassLoader = <span class="string">"mClassLoader"</span>;</div><div class="line"></div><div class="line">    Context baseContext = (Context) findField(application, defBase).get(application);</div><div class="line">    Object basePackageInfo = findField(baseContext, defPackageInfo).get(baseContext);</div><div class="line">    Field classLoaderField = findField(basePackageInfo, defClassLoader);</div><div class="line">    Thread.currentThread().setContextClassLoader(reflectClassLoader);</div><div class="line">    classLoaderField.set(basePackageInfo, reflectClassLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½œç”¨æ˜¯æ›¿æ¢æ‰äº†mPackageInfoä¸­çš„ClassLoaderï¼ŒmPackageInfoæ˜¯LoadedApkçš„å¯¹è±¡ï¼Œä»£è¡¨äº†APKæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºï¼Œè¯¸å¦‚Apkæ–‡ä»¶çš„ä»£ç å’Œèµ„æºï¼Œç”šè‡³ä»£ç é‡Œé¢çš„Activityï¼ŒServiceç­‰ç»„ä»¶çš„ä¿¡æ¯æˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡æ­¤å¯¹è±¡è·å–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ActivityThread.java</span></div><div class="line">java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</div><div class="line">StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">r.intent.setExtrasClassLoader(cl);</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œå°±å®Œæˆäº†AndroidNClassLoaderçš„åˆ›å»ºä¸æ›¿æ¢ï¼Œæ¥ä¸‹æ¥çš„åŠ è½½è¿‡ç¨‹ä½¿ç”¨äº†v23çš„åŠ è½½æµç¨‹ï¼Œå°±ä¸ç»†è¯´äº†ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è‡³æ­¤ï¼Œæ•´ä¸ªdexåŠ è½½æµç¨‹å°±åˆ†æå®Œäº†ã€‚æˆ‘ä»¬çœ‹åˆ°Tinkeråœ¨å…¼å®¹æ€§ä¸Šåšäº†å……è¶³çš„å·¥ä½œï¼Œæ•´ä¸ªåŠ è½½æµç¨‹è™½ç„¶è·Ÿå…¶ä»–åŸºäºMultidexçš„çƒ­è¡¥ä¸æ¡†æ¶å·®ä¸å¤šï¼Œä½†æ˜¯åœ¨å…¼å®¹æ€§ä¸Šåšäº†æ›´å®Œå¤‡çš„å¤„ç†ã€‚</p>
<h2 id="åŠ è½½è¡¥ä¸èµ„æº"><a href="#åŠ è½½è¡¥ä¸èµ„æº" class="headerlink" title="åŠ è½½è¡¥ä¸èµ„æº"></a>åŠ è½½è¡¥ä¸èµ„æº</h2><p>Tinkerçš„èµ„æºæ›´æ–°é‡‡ç”¨çš„InstantRunçš„èµ„æºè¡¥ä¸æ–¹å¼ï¼Œå…¨é‡æ›¿æ¢èµ„æºã€‚ç”±äºAppåŠ è½½èµ„æºæ˜¯ä¾èµ–Context.getResources()æ–¹æ³•è¿”å›çš„Resourceså¯¹è±¡ï¼ŒResources å†…éƒ¨åŒ…è£…äº† AssetManagerï¼Œæœ€ç»ˆç”± AssetManager ä» apk æ–‡ä»¶ä¸­åŠ è½½èµ„æºã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯æ–°å»ºä¸€ä¸ªAssetManager()ï¼Œhookæ‰å…¶ä¸­çš„addAssetPath()æ–¹æ³•ï¼Œå°†æˆ‘ä»¬çš„èµ„æºè¡¥ä¸ç›®å½•ä¼ é€’è¿›å»ï¼Œç„¶åå¾ªç¯æ›¿æ¢Resourceså¯¹è±¡ä¸­çš„AssetManagerå¯¹è±¡ï¼Œè¾¾åˆ°èµ„æºæ›¿æ¢çš„ç›®çš„ã€‚çœ‹ä¸‹ä»£ç å®ç°ã€‚</p>
<p>é¦–å…ˆä¾ç„¶å…ˆæ ¹æ®res_meta.xmlæ–‡ä»¶ä¸­è®°è½½çš„ä¿¡æ¯æ£€æŸ¥æ–‡ä»¶(res/resources.apk)æ˜¯å¦å­˜åœ¨ï¼Œå®ç°åœ¨TinkerResourceLoader.checkComplete()æ–¹æ³•ï¼Œç„¶åè°ƒç”¨<code>TinkerResourcePatcher.isResourceCanPatch(context);</code>åˆ¤æ–­æ˜¯å¦æ”¯æŒåå°„æ›´æ–°èµ„æºï¼Œçœ‹ä¸‹å…·ä½“çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isResourceCanPatch</span><span class="params">(Context context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="comment">// Create a new AssetManager instance and point it to the resources installed under /sdcard</span></div><div class="line">    AssetManager assets = context.getAssets();</div><div class="line">    <span class="comment">// Baidu os</span></div><div class="line">    <span class="keyword">if</span> (assets.getClass().getName().equals(<span class="string">"android.content.res.BaiduAssetManager"</span>)) &#123;</div><div class="line">        Class baiduAssetManager = Class.forName(<span class="string">"android.content.res.BaiduAssetManager"</span>);</div><div class="line">        newAssetManager = (AssetManager) baiduAssetManager.getConstructor().newInstance();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        newAssetManager = AssetManager.class.getConstructor().newInstance();</div><div class="line">    &#125;</div><div class="line">    addAssetPathMethod = AssetManager.class.getDeclaredMethod(<span class="string">"addAssetPath"</span>, String.class);</div><div class="line">    addAssetPathMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Kitkat needs this method call, Lollipop doesn't. However, it doesn't seem to cause any harm</span></div><div class="line">    <span class="comment">// in L, so we do it unconditionally.</span></div><div class="line">    ensureStringBlocksMethod = AssetManager.class.getDeclaredMethod(<span class="string">"ensureStringBlocks"</span>);</div><div class="line">    ensureStringBlocksMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Iterate over all known Resources objects</span></div><div class="line">    <span class="keyword">if</span> (SDK_INT &gt;= KITKAT) &#123;</div><div class="line">        <span class="comment">//pre-N</span></div><div class="line">        <span class="comment">// Find the singleton instance of ResourcesManager</span></div><div class="line">        Class&lt;?&gt; resourcesManagerClass = Class.forName(<span class="string">"android.app.ResourcesManager"</span>);</div><div class="line">        Method mGetInstance = resourcesManagerClass.getDeclaredMethod(<span class="string">"getInstance"</span>);</div><div class="line">        mGetInstance.setAccessible(<span class="keyword">true</span>);</div><div class="line">        Object resourcesManager = mGetInstance.invoke(<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Field fMActiveResources = resourcesManagerClass.getDeclaredField(<span class="string">"mActiveResources"</span>);</div><div class="line">            fMActiveResources.setAccessible(<span class="keyword">true</span>);</div><div class="line">            ArrayMap&lt;?, WeakReference&lt;Resources&gt;&gt; arrayMap =</div><div class="line">                (ArrayMap&lt;?, WeakReference&lt;Resources&gt;&gt;) fMActiveResources.get(resourcesManager);</div><div class="line">            references = arrayMap.values();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ignore) &#123;</div><div class="line">            <span class="comment">// N moved the resources to mResourceReferences</span></div><div class="line">            Field mResourceReferences = resourcesManagerClass.getDeclaredField(<span class="string">"mResourceReferences"</span>);</div><div class="line">            mResourceReferences.setAccessible(<span class="keyword">true</span>);</div><div class="line">            <span class="comment">//noinspection unchecked</span></div><div class="line">            references = (Collection&lt;WeakReference&lt;Resources&gt;&gt;) mResourceReferences.get(resourcesManager);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Class&lt;?&gt; activityThread = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line">        Field fMActiveResources = activityThread.getDeclaredField(<span class="string">"mActiveResources"</span>);</div><div class="line">        fMActiveResources.setAccessible(<span class="keyword">true</span>);</div><div class="line">        Object thread = getActivityThread(context, activityThread);</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        HashMap&lt;?, WeakReference&lt;Resources&gt;&gt; map =</div><div class="line">            (HashMap&lt;?, WeakReference&lt;Resources&gt;&gt;) fMActiveResources.get(thread);</div><div class="line">        references = map.values();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// check resource</span></div><div class="line">    <span class="keyword">if</span> (references == <span class="keyword">null</span> || references.isEmpty()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"resource references is null or empty"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        assetsFiled = Resources.class.getDeclaredField(<span class="string">"mAssets"</span>);</div><div class="line">        assetsFiled.setAccessible(<span class="keyword">true</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</div><div class="line">        <span class="comment">// N moved the mAssets inside an mResourcesImpl field</span></div><div class="line">        resourcesImplFiled = Resources.class.getDeclaredField(<span class="string">"mResourcesImpl"</span>);</div><div class="line">        resourcesImplFiled.setAccessible(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æŒ‰ç…§æ­¥éª¤æ¥å§ï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ªAssetManagerå¯¹è±¡ï¼Œå…¶ä¸­å¯¹BaiduROMåšäº†å…¼å®¹(BaiduAssetManager)ï¼Œæ‹¿åˆ°å…¶ä¸­çš„addAssetPathæ–¹æ³•çš„åå°„addAssetPathMethodï¼Œç„¶åæ‹¿åˆ°ensureStringBlocksçš„åå°„ï¼Œç„¶ååŒºåˆ†ç‰ˆæœ¬æ‹¿åˆ°Resourcesçš„é›†åˆã€‚</p>
<ul>
<li>SDK &gt;= 19ï¼Œä»ResourcesManagerä¸­æ‹¿åˆ°mActiveResourceså˜é‡ï¼Œæ˜¯ä¸ªæŒæœ‰Resourcesçš„ArrayMapï¼Œèµ‹å€¼ç»™referencesï¼ŒAndroid Nä¸­è¯¥å˜é‡å«åšmResourceReferences</li>
<li>SDK &lt; 19ï¼Œä»ActivityThreadä¸­è·å–mActiveResourcesï¼Œæ˜¯ä¸ªHashMapæŒæœ‰Resourcesï¼Œèµ‹å€¼ç»™references</li>
</ul>
<p>å¦‚æœreferencesä¸ºç©ºï¼Œè¯´æ˜è¯¥ç³»ç»Ÿä¸æ”¯æŒèµ„æºè¡¥ä¸ï¼Œthrow ä¸€ä¸ªIllegalStateExceptionè¢«ä¸Šå±‚è°ƒç”¨catchã€‚</p>
<p>ç„¶åè°ƒç”¨monkeyPatchExistingResourcesæ–¹æ³•(è¿™ä¸ªæ–¹æ³•çš„åå­—è·ŸInstantRunçš„èµ„æºè¡¥ä¸æ–¹æ³•åæ˜¯ä¸€æ ·çš„)ï¼Œå°†è¡¥ä¸èµ„æºè·¯å¾„(res/resources.apk)ä¼ é€’è¿›å»ï¼Œä»£ç å°±ä¸è´´äº†ï¼Œç®€å•æè¿°ä¸ºåå°„è°ƒç”¨æ–°å»ºçš„AssetManagerçš„addAssetPathå°†è·¯å¾„ç©¿è¿›å»ï¼Œç„¶åä¸»åŠ¨è°ƒç”¨ensureStringBlocksæ–¹æ³•ç¡®ä¿èµ„æºçš„å­—ç¬¦ä¸²ç´¢å¼•åˆ›å»ºå‡ºæ¥ï¼›ç„¶åå¾ªç¯éå†æŒæœ‰Resourceså¯¹è±¡çš„referencesé›†åˆï¼Œä¾æ¬¡æ›¿æ¢å…¶ä¸­çš„AssetManagerä¸ºæ–°å»ºçš„AssetManagerï¼Œæœ€åè°ƒç”¨Resources.updateConfigurationå°†Resourceså¯¹è±¡çš„é…ç½®ä¿¡æ¯æ›´æ–°åˆ°æœ€æ–°çŠ¶æ€ï¼Œå®Œæˆæ•´ä¸ªèµ„æºæ›¿æ¢çš„è¿‡ç¨‹ã€‚</p>
<p>ç›®å‰æ¥çœ‹InstantRunçš„èµ„æºæ›´æ–°æ–¹å¼æœ€ç®€ä¾¿è€Œä¸”å…¼å®¹æ€§ä¹Ÿæœ€å¥½ï¼Œå¸‚é¢ä¸Šå¤§å¤šæ•°çš„çƒ­è¡¥ä¸æ¡†æ¶éƒ½é‡‡ç”¨è¿™å¥—æ–¹æ¡ˆã€‚Tinkerçš„è¿™å¥—æ–¹æ¡ˆè™½ç„¶ä¹Ÿé‡‡ç”¨å…¨é‡çš„æ›¿æ¢ï¼Œä½†æ˜¯åœ¨ä¸‹å‘patchä¸­ä¾ç„¶é‡‡ç”¨å·®é‡èµ„æºçš„æ–¹å¼è·å–å·®åˆ†åŒ…ï¼Œä¸‹å‘åˆ°æ‰‹æœºåå†åˆæˆå…¨é‡çš„èµ„æºæ–‡ä»¶ï¼Œæœ‰æ•ˆçš„æ§åˆ¶äº†è¡¥ä¸æ–‡ä»¶çš„å¤§å°ã€‚</p>
<h2 id="åŠ è½½è¡¥ä¸so"><a href="#åŠ è½½è¡¥ä¸so" class="headerlink" title="åŠ è½½è¡¥ä¸so"></a>åŠ è½½è¡¥ä¸so</h2><p>ä¾ç„¶æ ¹æ®so_meta.txtä¸­çš„è¡¥ä¸ä¿¡æ¯æ ¡éªŒsoæ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨ã€‚ç„¶åå°†soè¡¥ä¸åˆ—è¡¨å­˜æ”¾åœ¨ç»“æœä¸­libsçš„å­—æ®µã€‚</p>
<p>soçš„æ›´æ–°æ–¹å¼è·Ÿdexå’Œèµ„æºéƒ½ä¸å¤ªä¸€æ ·ï¼Œå› ä¸ºç³»ç»Ÿæä¾›ç»™äº†å¼€å‘è€…è‡ªå®šä¹‰soç›®å½•çš„é€‰é¡¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">System</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String pathName)</span> </span>&#123;</div><div class="line">        Runtime.getRuntime().load(pathName, VMStack.getCallingClassLoader());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TinkeråŠ è½½SOè¡¥ä¸æä¾›äº†ä¸¤ä¸ªå…¥å£ï¼Œåˆ†åˆ«æ˜¯TinkerInstallerå’ŒTinkerApplicationHelperã€‚ä»–ä»¬ä¸¤ä¸ªçš„åŒºåˆ«æ˜¯TinkerInstalleråªæœ‰åœ¨Tinker.installè¿‡ä¹‹åæ‰èƒ½ä½¿ç”¨,å¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//TinkerInstaller</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">loadLibraryFromTinker</span><span class="params">(Context context, String relativePath, String libname)</span> <span class="keyword">throws</span> UnsatisfiedLinkError </span>&#123;</div><div class="line">        <span class="keyword">final</span> Tinker tinker = Tinker.with(context);</div><div class="line"></div><div class="line">        libname = libname.startsWith(<span class="string">"lib"</span>) ? libname : <span class="string">"lib"</span> + libname;</div><div class="line">        libname = libname.endsWith(<span class="string">".so"</span>) ? libname : libname + <span class="string">".so"</span>;</div><div class="line">        String relativeLibPath = relativePath + <span class="string">"/"</span> + libname;</div><div class="line"></div><div class="line">        <span class="comment">//TODO we should add cpu abi, and the real path later</span></div><div class="line">        <span class="keyword">if</span> (tinker.isEnabledForNativeLib() &amp;&amp; tinker.isTinkerLoaded()) &#123;</div><div class="line">            TinkerLoadResult loadResult = tinker.getTinkerLoadResultIfPresent();</div><div class="line">            <span class="keyword">if</span> (loadResult.libs != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (String name : loadResult.libs.keySet()) &#123;</div><div class="line">                    <span class="keyword">if</span> (name.equals(relativeLibPath)) &#123;</div><div class="line">                        String patchLibraryPath = loadResult.libraryDirectory + <span class="string">"/"</span> + name;</div><div class="line">                        File library = <span class="keyword">new</span> File(patchLibraryPath);</div><div class="line">                        <span class="keyword">if</span> (library.exists()) &#123;</div><div class="line">                            <span class="comment">//whether we check md5 when load</span></div><div class="line">                            <span class="keyword">boolean</span> verifyMd5 = tinker.isTinkerLoadVerify();</div><div class="line">                            <span class="keyword">if</span> (verifyMd5 &amp;&amp; !SharePatchFileUtil.verifyFileMd5(library, loadResult.libs.get(name))) &#123;</div><div class="line">                                tinker.getLoadReporter().onLoadFileMd5Mismatch(library, ShareConstants.TYPE_LIBRARY);</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                System.load(patchLibraryPath);</div><div class="line">                                TinkerLog.i(TAG, <span class="string">"loadLibraryFromTinker success:"</span> + patchLibraryPath);</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ç®€å•æ¥è¯´å°±æ˜¯éå†æ£€æŸ¥çš„ç»“æœåˆ—è¡¨libsï¼Œæ‰¾åˆ°è¦åŠ è½½çš„ç±»ï¼Œè°ƒç”¨System.loadæ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚</p>
<h1 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h1><p>åœ¨é›†æˆTinkerçš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜(ç¯å¢ƒæ˜¯Dalvikï¼ŒARTæ²¡é—®é¢˜)ï¼Œåœ¨å‰é¢æˆ‘ä»¬æåˆ°äº†dex.loaderçš„é…ç½®ï¼Œæˆ‘æŠŠé¡¹ç›®ä¸­ç”¨äºä¸‹è½½è¡¥ä¸æ–‡ä»¶çš„å·¥å…·ç±»AåŠ åˆ°äº†å…¶ä¸­ï¼Œç„¶åä¸‹å‘è¡¥ä¸æŠ¥é”™ï¼Œå‡ºç°Class ref in pre-verified class resolved to unexpected  implementationçš„crashã€‚Qzoneçš„é‚£å¥—çƒ­è¡¥ä¸ä¸ºäº†æ¶ˆé™¤è¿™ä¸ªé”™è¯¯é‡‡ç”¨æ’åº„çš„æ–¹å¼æ¥è§„é¿ï¼ŒTinkeré‡‡ç”¨å…¨é‡dexçš„æ–¹å¼æ¥è§„é¿è¯¥é—®é¢˜ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜ä¼šå‡ºç°å‘¢ã€‚</p>
<p>æ ¹æ®logæ‰¾åˆ°äº†æŠ¥é”™ç‚¹æ˜¯åœ¨å·¥å…·ç±»Aä¸­çš„ä¸€ä¸ªç›´æ¥å¼•ç”¨ç±»Bçš„æ–¹æ³•ä¸­æŠ¥é”™ã€‚é”™è¯¯åŸå› åœ¨åŠ è½½è¡¥ä¸dexä¸€èŠ‚å…¶å®å·²ç»æåˆ°ä¸€äº›ï¼Œæˆ‘ä»¬å¼•ç”¨è¿‡æ¥ï¼Œè¿™ä¸ªé…ç½®(dex.loader)ä¸­çš„ç±»ä¸ä¼šå‡ºç°åœ¨ä»»ä½•å…¨é‡è¡¥ä¸dexé‡Œï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åˆæˆåï¼Œè¿™äº›ç±»è¿˜åœ¨è€çš„dexæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚åœ¨è¡¥ä¸å‰dexé¡ºåºæ˜¯è¿™æ ·çš„ï¼š<code>oldDex1 -&gt; oldDex2 -&gt; oldDex3..</code>ï¼Œé‚£ä¹ˆå‡å¦‚ä¿®æ”¹äº†dex1ä¸­çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆè¡¥ä¸é¡ºåºæ˜¯è¿™æ ·çš„<code>newDex1 -&gt; oldDex1 -&gt; oldDex2...</code>å…¶ä¸­åˆæˆåçš„newDex1ä¸­çš„ç±»æ˜¯oldDex1ä¸­é™¤äº†dex.loaderä¸­æ ‡æ˜çš„ç±»ä¹‹å¤–çš„æ‰€æœ‰ç±»ï¼Œdex.loaderä¸­çš„ç±»ä¾ç„¶åœ¨oldDex1ä¸­ã€‚<br>ä¹Ÿå°±æ˜¯è¯´Aç±»æ˜¯åœ¨dex.loaderé…ç½®ä¸­çš„ï¼Œè¡¥ä¸åï¼ŒAä¾ç„¶åœ¨oldDex1ä¸­ï¼Œè€ŒAçš„ç›´æ¥å¼•ç”¨ç±»Bå´å‡ºç°åœ¨äº†newDex1ä¸­ï¼Œå¹¶ä¸”åœ¨ä¹‹å‰Aç±»å·²ç»è¢«æ‰“ä¸Šäº†preverifyæ ‡å¿—ï¼Œæ‰€åœ¨Aå†å»newDex1ä¸­åŠ è½½Bçš„è¯å°±ä¼šæŠ¥è¯¥é”™è¯¯ã€‚</p>
<p>é‚£æœ‰çš„åŒå­¦å¯èƒ½ä¼šé—®äº†ï¼ŒTinkerApplicationä¹Ÿåœ¨oldDex1ä¸­çš„ï¼Œè€Œæˆ‘ä»¬çš„ApplicationLikeåœ¨è¡¥ä¸åä¹Ÿå‡ºç°åœ¨äº†newDex1ä¸­ï¼ŒTinkerApplicationåå°„è°ƒç”¨ApplicationLikeçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸ºä»€ä¹ˆæ²¡æœ‰å‡ºç°crashå‘¢ï¼Ÿè¿˜è®°å¾—æ–‡ç« å‰é¢çš„æœ‰ä¸€ä¸ªåå°„ä¹ˆï¼Œæˆ‘ä»¬è¯´äº†è¦æ³¨æ„åé¢ä¼šè®²åˆ°ï¼Œå°±æ˜¯åœ¨è¿™é‡Œç”¨åˆ°çš„ã€‚</p>
<p>æ ¡éªŒpreverifyçš„æ–¹æ³•ï¼Œæ­£å¸¸çš„ç±»åŠ è½½ä¼šèµ°åˆ°è¿™é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ClassObject* dvmResolveClass(<span class="keyword">const</span> ClassObject* referrer, u4 classIdx,</div><div class="line">    bool fromUnverifiedConstant)</div><div class="line">&#123;</div><div class="line">....</div><div class="line">       <span class="keyword">if</span> (!fromUnverifiedConstant &amp;&amp;</div><div class="line">            IS_CLASS_FLAG_SET(referrer, CLASS_ISPREVERIFIED))</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œåå°„èµ°äº†å®Œå…¨ä¸åŒçš„è·¯å¾„ï¼Œä¸ä¼šèµ°åˆ°dvmResolveClassæ–¹æ³•ï¼Œä¹Ÿå°±ä¸ä¼šæŠ¥é”™äº†ã€‚å…³äºè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« ä¼šè¯¦ç»†è®²è§£ã€‚åå°„æœ€ç›´æ¥çš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†éš”ç¦»å¼€è¿™ä¸¤ä¸ªç±»ï¼Œä¹Ÿå°±æ˜¯éš”ç¦»å¼€äº†Tinkerç»„ä»¶å’Œappã€‚å¦‚å›¾</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/ref.png" alt=""></p>
<p>é€šè¿‡åå°„ï¼Œå°†Tinkerç»„å»ºå’ŒAppéš”ç¦»å¼€ï¼Œå¹¶ä¸”å…ˆåé¡ºåºæ˜¯å…ˆTinkeråAppï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢Appä¸­çš„ä»£ç æå‰åŠ è½½ï¼Œç¡®ä¿Appä¸­æ‰€æœ‰çš„ä»£ç éƒ½å¯ä»¥å…·æœ‰è¢«çƒ­ä¿®å¤çš„èƒ½åŠ›åŒ…æ‹¬ApplicationLikeã€‚</p>
<p>ç„¶ååˆæœ‰åŒå­¦é—®äº†ï¼Œä¸ºå•¥Dalvikæœ‰é—®é¢˜ï¼ŒARTæ²¡é—®é¢˜å‘¢ï¼Ÿé‚£æ˜¯å› ä¸ºåœ¨ARTè™šæ‹ŸæœºåŸç”Ÿæ”¯æŒä»APKæ–‡ä»¶åŠ è½½å¤šä¸ªdexæ–‡ä»¶ã€‚åœ¨åº”ç”¨å®‰è£…æ—¶æ‰§è¡Œdex2oatæ‰«æ classes(..N).dexæ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬ç¼–è¯‘æˆå•ä¸ªoatæ–‡ä»¶ï¼Œä¾› Androidè®¾å¤‡æ‰§ï¼Œä¹Ÿå°±ä¸å­˜åœ¨MultiDexçš„é—®é¢˜äº†ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜çš„<a href="https://github.com/Tencent/tinker/issues/124" target="_blank" rel="external">issue</a></p>
<h1 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åˆ°è¿™é‡Œï¼ŒTinkerçš„åŸºæœ¬è¡¥ä¸åŠ è½½æµç¨‹å°±åˆ†æå®Œäº†ï¼Œæœ¬æ–‡åªå¯¹è¡¥ä¸åŠ è½½æµç¨‹åŠ ä»¥åˆ†æï¼Œå¯¹dexDiffå·®åˆ†ä»¥åŠè¡¥ä¸åŠ è½½æ²¡æœ‰åšè¯´æ˜ï¼Œå¦‚æœä½ å¯¹è¿™éƒ¨åˆ†æ„Ÿå…´è¶£å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://www.zybuluo.com/dodola/note/554061" target="_blank" rel="external">Tinker Dexdiffç®—æ³•è§£æ</a>ã€‚å¦å¤–ARTä¸‹çš„å†…è”å½±å“å’ŒOTAå‡çº§æ²¡æœ‰åšè¿‡å¤šè¯´æ˜ï¼ŒTinkerå®˜æ–¹å·²ç»æœ‰ç›¸å…³æ–‡ç« ã€‚</p>
<p>æˆ‘ä»¬ç®€å•å¯¹Tinkeråšä¸‹æ€»ç»“ã€‚<br>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ”¯æŒç±»ã€èµ„æºã€soä¿®å¤</li>
<li>å…¼å®¹æ€§å¤„ç†çš„å¾ˆå¥½ï¼Œå…¨å¹³å°æ”¯æŒ</li>
<li>ç”±äºä¸ç”¨æ’åº„ï¼Œæ‰€ä»¥æ€§èƒ½æŸè€—å¾ˆå°</li>
<li>å®Œå–„çš„å¼€å‘æ–‡æ¡£å’Œå®˜æ–¹æŠ€æœ¯æ”¯æŒ</li>
<li>gradleæ”¯æŒï¼Œå†è‡ªå·±å®šä¹‰ä¸‹å¯ä»¥ä¸€é”®æ‰“è¡¥ä¸åŒ…</li>
<li>dexDiffç®—æ³•ä½¿å¾—è¡¥ä¸æ–‡ä»¶è¾ƒå°</li>
<li>æ‰©å±•æ€§è‰¯å¥½ï¼Œä»£ç ä¸­å¤„å¤„ä¸ºå¼€å‘è€…ç•™å‡ºå¼€æ”¾æ¥å£ï¼Œç®€ç›´ä¸šç•Œè‰¯å¿ƒ</li>
<li>æ”¯æŒå¤šæ¬¡è¡¥ä¸</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸æ”¯æŒåŠæ—¶ç”Ÿæ•ˆï¼Œä¸‹å‘è¡¥ä¸éœ€è¦é‡å¯ç”Ÿæ•ˆï¼ŒMultiDexæ–¹æ¡ˆå†³å®šçš„</li>
<li>å ç”¨ROMç©ºé—´è¾ƒå¤§ï¼Œè¿™ç‚¹ç©ºé—´åœ¨å¦‚ä»Šçš„æ‰‹æœºå¤§ROMä¸‹ä¹Ÿä¸ç®—ä¸ªäº‹</li>
<li>å¯¹åŠ å›ºæ”¯æŒä¸å¤ªå¥½</li>
</ul>
<p>æ€»ç»“ä¸‹æ¥Tinkeræ˜¯ä¸€ç§åŸºäºå•ClassLoaderåŠ è½½å¤šdexæ–¹æ¡ˆçš„çƒ­è¡¥ä¸æ¡†æ¶ï¼Œå…¼å®¹æ€§åšçš„æ¯”è¾ƒå¥½ï¼ŒåŠŸèƒ½å¼ºå¤§ã€‚å¦‚æœä½ æ­£åœ¨è€ƒè™‘æ¥å…¥çƒ­è¡¥ä¸ï¼Œé‚£ä¹ˆå¼ºçƒˆæ¨èä½ ä½¿ç”¨Tinkerï¼Œåœ°ç²¾ä¿®è¡¥åŒ ï¼Œå¸¦ä½ æ— é™åˆ·æ–°ï¼</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286384&amp;idx=1&amp;sn=f1aff31d6a567674759be476bcd12549&amp;scene=4#wechat_redirect" target="_blank" rel="external">å¾®ä¿¡Tinkerçš„ä¸€åˆ‡éƒ½åœ¨è¿™é‡Œï¼ŒåŒ…æ‹¬æºç (ä¸€)</a><br><a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286341&amp;idx=1&amp;sn=054d595af6e824cbe4edd79427fc2706&amp;scene=0" target="_blank" rel="external">Android Næ··åˆç¼–è¯‘ä¸å¯¹çƒ­è¡¥ä¸å½±å“è§£æ</a><br><a href="https://www.zybuluo.com/dodola/note/554061" target="_blank" rel="external">Tinker Dexdiffç®—æ³•è§£æ</a><br><a href="http://w4lle.github.io/2016/05/02/%E4%BB%8EInstant%20run%E8%B0%88Android%E6%9B%BF%E6%8D%A2Application%E5%92%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">ä»Instant runè°ˆAndroidæ›¿æ¢Applicationå’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</a><br><a href="https://segmentfault.com/a/1190000004062880" target="_blank" rel="external">AndroidåŠ¨æ€åŠ è½½åŸºç¡€ ClassLoaderå·¥ä½œæœºåˆ¶</a><br><a href="http://blog.csdn.net/luoshengyang/article/details/8791064" target="_blank" rel="external">Androidåº”ç”¨ç¨‹åºèµ„æºç®¡ç†å™¨ï¼ˆAsset Managerï¼‰çš„åˆ›å»ºè¿‡ç¨‹åˆ†æ</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/12/16/tinker/">http://w4lle.com/2016/12/16/tinker/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tinkerç³»åˆ—æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://w4lle.github.io/2016/12/16/tinker/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Androidçƒ­è¡¥ä¸ä¹‹TinkeråŸç†è§£æ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://w4lle.github.io/2017/01/05/one-key-for-tinker/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ä¸€é”®æ¥å…¥Tinker&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://w4lle.github.io/2017/01/22/gradle-modules/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Gradleæ¨¡å—åŒ–é…ç½®&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ¬æ–‡æ˜¯ç¬¬ä¸€ç¯‡ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡åˆ†æç‰ˆæœ¬  &lt;a href=&quot;https://github.com/Tencent/tinker/tree/93ecc9351367badc02a91fac25764bee50e6e6a6&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;93ecc9351367badc02a91fac25764bee50e6e6a6&lt;/a&gt;&lt;br&gt;é¡¹ç›®åœ°å€ï¼š &lt;a href=&quot;https://github.com/Tencent/tinker/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Tinker&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;åœ¨ä»Šå¹´çš„MDCCå¤§ä¼šä¸Šï¼Œå¾®ä¿¡å¼€å‘å›¢é˜Ÿå®£å¸ƒæ­£å¼å¼€æºTinkerï¼Œåœ¨è¿™ä¹‹å‰å¾®ä¿¡å›¢é˜Ÿå·²ç»å‘å‡ºè¿‡ä¸€äº›Tinkerçš„ç›¸å…³æ–‡ç« ï¼Œè¯´å®è¯åœ¨å¼€æºä¹‹å‰æˆ‘ä»¬è¿˜æ˜¯ç›¸å½“æœŸå¾…Tinkerå¼€æºçš„ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºä¹‹å‰ä½¿ç”¨çš„çƒ­è¡¥ä¸ä¸€ç›´å­˜åœ¨ä¸€äº›å…¼å®¹æ€§é—®é¢˜ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¥½å¥‡Tinkerçš„å®ç°æ–¹æ¡ˆã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
      <category term="çƒ­è¡¥ä¸" scheme="http://w4lle.com/tags/%E7%83%AD%E8%A1%A5%E4%B8%81/"/>
    
  </entry>
  
  <entry>
    <title>AndroidStudio å¸¸ç”¨å¿«æ·é”®</title>
    <link href="http://w4lle.com/2016/12/14/AndroidStudio-shotcurts-md/"/>
    <id>http://w4lle.com/2016/12/14/AndroidStudio-shotcurts-md/</id>
    <published>2016-12-14T10:47:01.000Z</published>
    <updated>2017-01-06T01:51:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¿«æ·é”®"><a href="#å¿«æ·é”®" class="headerlink" title="å¿«æ·é”®"></a>å¿«æ·é”®</h1><p>æ•´ç†äº†ä¸‹å¸¸ç”¨çš„å¿«æ·é”®<br>å› ä¸ºæˆ‘ç”¨AndroidStudioçš„vimæ’ä»¶ï¼Œæ‰€ä»¥åœ¨ç¼–è¾‘è¿™å—æ²¡æœ‰æ•´ç†å¤ªå¤šã€‚<br>éœ€è¦çš„åŒå­¦å¯ä»¥è‡ªå·±å­¦äº›ä¸‹ã€‚</p>
<p>ç†Ÿè®°è¿™äº›å¿«æ·é”® + vim = åŸºæœ¬ä¸ç”¨é¼ æ ‡ = æå‡æ•ˆç‡50%</p>
<a id="more"></a>
<h1 id="AS-å¸¸ç”¨å¿«æ·é”®"><a href="#AS-å¸¸ç”¨å¿«æ·é”®" class="headerlink" title="AS å¸¸ç”¨å¿«æ·é”®"></a>AS å¸¸ç”¨å¿«æ·é”®</h1><h2 id="æ–‡ä»¶"><a href="#æ–‡ä»¶" class="headerlink" title="æ–‡ä»¶"></a>æ–‡ä»¶</h2><ul>
<li>cmd + o                  æ‰“å¼€classæ–‡ä»¶</li>
<li>cmd + shift + o          æ‰“å¼€ä»»æ„æ–‡ä»¶</li>
<li>cmd + alt + o            æ‰“å¼€å˜é‡æ‰€åœ¨æ–‡ä»¶</li>
<li>shift + shift            æ‰“å¼€ä»»æ„ä½ç½®æ–‡ä»¶</li>
<li>cmd + e                  æœ€è¿‘ä½¿ç”¨æ–‡ä»¶</li>
<li>cmd + shift + e          æœ€è¿‘ä¿®æ”¹æ–‡ä»¶</li>
<li>cmd + u                  æ‰“å¼€çˆ¶ç±»</li>
</ul>
<h2 id="å¯¼èˆª"><a href="#å¯¼èˆª" class="headerlink" title="å¯¼èˆª"></a>å¯¼èˆª</h2><ul>
<li>cmd + number             æ‰“å¼€å·¥å…·é¢æ¿</li>
<li>shift + esc              å…³é—­å½“å‰å·¥å…·é¢æ¿</li>
<li>cmd + shift + F12        å…³é—­æ‰€æœ‰é¢æ¿</li>
<li>esc                      ç„¦ç‚¹åˆ‡æ¢å›ç¼–è¾‘å™¨</li>
<li>F12                      é‡æ–°æ‰“å¼€ä¸Šæ¬¡æ‰€åœ¨å·¥å…·é¢æ¿</li>
<li>alt + F12                æ‰“å¼€terminal</li>
<li>ctrl + tab               åœ¨æœ€è¿‘æ‰“å¼€tabé—´åˆ‡æ¢</li>
<li>ctrl + h                 ç»§æ‰¿ç»“æ„</li>
<li>ctrl + alt + h           æ–¹æ³•è°ƒç”¨è·¯å¾„</li>
</ul>
<h3 id="å¯¼èˆªï¼ˆäºŒï¼‰"><a href="#å¯¼èˆªï¼ˆäºŒï¼‰" class="headerlink" title="å¯¼èˆªï¼ˆäºŒï¼‰"></a>å¯¼èˆªï¼ˆäºŒï¼‰</h3><ul>
<li>cmd + shift + h          æ–¹æ³•ç»“æ„            </li>
<li>alt + F1                 åœ¨Finderä¸­æ‰“å¼€</li>
<li>cmd + []                 å…‰æ ‡å†å²è·³è½¬</li>
<li>cmd + ,                  æ‰“å¼€è®¾ç½®</li>
<li>cmd + down               æ‰“å¼€é¡¹ç›®è®¾ç½®</li>
<li>cmd + l                  è·³è½¬åˆ°æŒ‡å®šè¡Œ</li>
<li>F2                       è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæŠ¥é”™çš„ä½ç½®</li>
</ul>
<h2 id="ç¼–è¾‘"><a href="#ç¼–è¾‘" class="headerlink" title="ç¼–è¾‘"></a>ç¼–è¾‘</h2><ul>
<li>cmd + shift + enter      è¯­å¥è¡¥å…¨</li>
<li>alt + enter              æ™ºèƒ½çº é”™</li>
<li>tab/enter                ä»£ç è¡¥å…¨</li>
<li>!                        å–åè¡¥å…¨</li>
<li>cmd + j                  æ¨¡æ¿æ–¹æ³•</li>
<li>.                        åç¼€è¡¥å…¨</li>
<li>cmd + p                  æŸ¥çœ‹æ–¹æ³•å‚æ•°</li>
<li>cmd + shift + up/down    ä¸Šä¸‹ç§»åŠ¨ä»£ç </li>
<li>cmd + /                  æ³¨é‡Šä¸€è¡Œ</li>
<li>cmd + alt + /            æ³¨é‡Šå¤šè¡Œ</li>
</ul>
<h3 id="ç¼–è¾‘ï¼ˆäºŒï¼‰"><a href="#ç¼–è¾‘ï¼ˆäºŒï¼‰" class="headerlink" title="ç¼–è¾‘ï¼ˆäºŒï¼‰"></a>ç¼–è¾‘ï¼ˆäºŒï¼‰</h3><ul>
<li>cmd + alt + t            Surround with</li>
<li>shift + j                åˆå¹¶ä¸‹ä¸€è¡Œä»£ç ä¸ºä¸€è¡Œ</li>
<li>cmd + alt + l            æ ¼å¼åŒ–ä»£ç </li>
<li>cmd + n                  ç”Ÿæˆä»£ç </li>
<li>ctrl + space             å”¤å‡ºè‡ªåŠ¨è¡¥å…¨</li>
<li>cmd + F12                å½“å‰ç±»å†…å®¹ç»“æ„</li>
<li>hold alt                 å—æ“ä½œ</li>
<li>cmd + y                  æ–¹æ³•é¢„è§ˆ</li>
<li>ctrl + shift + q         ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
</ul>
<h2 id="é‡æ„"><a href="#é‡æ„" class="headerlink" title="é‡æ„"></a>é‡æ„</h2><ul>
<li>ctrl + o                 é‡å†™æ–¹æ³•</li>
<li>ctrl + i                 å®ç°æ–¹æ³•</li>
<li>cmd + alt + m            æŠ½å–æ–¹æ³•</li>
</ul>
<h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><ul>
<li>shift + F10                 run</li>
<li>cmd + F9                    make</li>
</ul>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><ul>
<li>F8                          ä¸‹ä¸€æ­¥</li>
<li>F7                          è¿›å…¥</li>
</ul>
<h2 id="æŸ¥æ‰¾"><a href="#æŸ¥æ‰¾" class="headerlink" title="æŸ¥æ‰¾"></a>æŸ¥æ‰¾</h2><ul>
<li>cmd + f                       </li>
<li>cmd + shift + f               å…¨å±€æœç´¢</li>
<li>cmd + alt + F7                é¢„è§ˆæ–¹æ³•è°ƒç”¨</li>
<li>alt + F7                      æ–¹æ³•è°ƒç”¨</li>
</ul>
<h2 id="ä¸‡èƒ½é”®"><a href="#ä¸‡èƒ½é”®" class="headerlink" title="ä¸‡èƒ½é”®"></a>ä¸‡èƒ½é”®</h2><ul>
<li>cmd + shift + a </li>
</ul>
<p>ppt:</p>
<p><a href="http://w4lle.github.io/sliders/androidstudio-shortcurts/index.html" target="_blank" rel="external">http://w4lle.github.io/sliders/androidstudio-shortcurts/index.html</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/12/14/AndroidStudio-shotcurts-md/">http://w4lle.com/2016/12/14/AndroidStudio-shotcurts-md/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¿«æ·é”®&quot;&gt;&lt;a href=&quot;#å¿«æ·é”®&quot; class=&quot;headerlink&quot; title=&quot;å¿«æ·é”®&quot;&gt;&lt;/a&gt;å¿«æ·é”®&lt;/h1&gt;&lt;p&gt;æ•´ç†äº†ä¸‹å¸¸ç”¨çš„å¿«æ·é”®&lt;br&gt;å› ä¸ºæˆ‘ç”¨AndroidStudioçš„vimæ’ä»¶ï¼Œæ‰€ä»¥åœ¨ç¼–è¾‘è¿™å—æ²¡æœ‰æ•´ç†å¤ªå¤šã€‚&lt;br&gt;éœ€è¦çš„åŒå­¦å¯ä»¥è‡ªå·±å­¦äº›ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;ç†Ÿè®°è¿™äº›å¿«æ·é”® + vim = åŸºæœ¬ä¸ç”¨é¼ æ ‡ = æå‡æ•ˆç‡50%&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>OkHttp3 æºç æµ…æ</title>
    <link href="http://w4lle.com/2016/12/06/OkHttp/"/>
    <id>http://w4lle.com/2016/12/06/OkHttp/</id>
    <published>2016-12-06T08:20:52.000Z</published>
    <updated>2017-01-06T01:53:45.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¹‹å‰çš„åº•å±‚ç½‘ç»œåº“åŸºæœ¬å°±æ˜¯Apache HttpClientå’ŒHttpURLConnectionã€‚ç”±äºHttClientæ¯”è¾ƒéš¾ç”¨ï¼Œå®˜æ–¹åœ¨Android2.3ä»¥åå°±ä¸å»ºè®®ç”¨äº†ï¼Œå¹¶ä¸”åœ¨Android5.0ä»¥ååºŸå¼ƒäº†HttpClientï¼Œåœ¨Android6.0æ›´æ˜¯åˆ é™¤äº†HttpClientã€‚</p>
<p>HttpURLConnectionæ˜¯ä¸€ç§å¤šç”¨é€”ã€è½»é‡æçš„HTTPå®¢æˆ·ç«¯ï¼Œä½¿ç”¨å®ƒæ¥è¿›è¡ŒHTTPæ“ä½œå¯ä»¥é€‚ç”¨äºå¤§å¤šæ•°çš„åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯åœ¨Android 2.2ç‰ˆæœ¬ä¹‹å‰å­˜åœ¨ä¸€äº›bugï¼Œæ‰€ä»¥å®˜æ–¹å»ºè®®åœ¨Android2.3ä»¥åæ›¿ä»£HttpClientï¼ŒVolleyå°±æ˜¯æŒ‰ç‰ˆæœ¬åˆ†åŒºä½¿ç”¨è¿™ä¸¤ä¸ªç½‘ç»œåº“ã€‚</p>
<p>ç„¶è€Œéšç€å¼€æºå±Šæ‰›æŠŠå­Squareçš„å´›èµ·ï¼ŒOkHttpçš„å¼€æºï¼Œè¿™ä¸¤ä¸ªç½‘ç»œåº“åªèƒ½è¢«æ·¹æ²¡åœ¨å†å²æ´ªæµä¸­ã€‚Android4.4ä»¥åHttpURLConnectionçš„åº•å±‚å·²ç»æ›¿æ¢æˆOkHttpå®ç°ã€‚OkHttpé…åˆåŒæ ·æ˜¯Squareå¼€æºçš„Retrofitï¼Œç½‘ç»œè¯·æ±‚å˜å¾—æ›´ç®€ä¾¿ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€‚</p>
<h1 id="OkHttp"><a href="#OkHttp" class="headerlink" title="OkHttp"></a>OkHttp</h1><p>OkHttpæ˜¯ä¸€ä¸ªç°ä»£ï¼Œå¿«é€Ÿï¼Œé«˜æ•ˆçš„ç½‘ç»œåº“ï¼ŒOkHttp åº“çš„è®¾è®¡å’Œå®ç°çš„é¦–è¦ç›®æ ‡æ˜¯é«˜æ•ˆã€‚</p>
<ul>
<li>æ”¯æŒ HTTP/2å’ŒSPDYï¼Œè¿™ä½¿å¾—å¯¹åŒä¸€ä¸ªä¸»æœºå‘å‡ºçš„æ‰€æœ‰è¯·æ±‚éƒ½å¯ä»¥å…±äº«ç›¸åŒçš„å¥—æ¥å­—è¿æ¥ï¼›</li>
<li>å¦‚æœ HTTP/2å’ŒSPDYä¸å¯ç”¨ï¼ŒOkHttpä¼šä½¿ç”¨è¿æ¥æ± æ¥å¤ç”¨è¿æ¥ä»¥æé«˜æ•ˆç‡ã€‚</li>
<li>æ”¯æŒGzipé™ä½ä¼ è¾“å†…å®¹çš„å¤§å°</li>
<li>æ”¯æŒHttpç¼“å­˜</li>
<li>ä¼šä»å¾ˆå¤šå¸¸ç”¨çš„è¿æ¥é—®é¢˜ä¸­è‡ªåŠ¨æ¢å¤ã€‚å¦‚æœæœåŠ¡å™¨é…ç½®äº†å¤šä¸ªIPåœ°å€ï¼ŒOkHttp ä¼šè‡ªåŠ¨é‡è¯•ä¸€ä¸ªä¸»æœºçš„å¤šä¸ª IP åœ°å€ã€‚</li>
<li>ä½¿ç”¨Okioæ¥å¤§å¤§ç®€åŒ–æ•°æ®çš„è®¿é—®ä¸å­˜å‚¨ï¼Œæé«˜æ€§èƒ½</li>
</ul>
<h2 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h2><p>ç®€å•çš„å¼‚æ­¥è¯·æ±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line">    Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">            .url(url)</div><div class="line">            .build();</div><div class="line"></div><div class="line">    client.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Request request, IOException e)</span>  </span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            System.out.println(response.body().string());</div><div class="line">        &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨éå¸¸çš„ç®€ç­”ï¼Œå‘é€è¯·æ±‚ï¼Œæ‹¿åˆ°å¼‚æ­¥ç»“æœã€‚</p>
<h2 id="OkHttpClient"><a href="#OkHttpClient" class="headerlink" title="OkHttpClient"></a>OkHttpClient</h2><p>è·Ÿä¸‹æºç ï¼ŒOkHttpClient.newCallå®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpClient</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">Call</span>.<span class="title">Factory</span></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    Dispatcher dispatcher;</div><div class="line">    Proxy proxy;</div><div class="line">    List&lt;Protocol&gt; protocols;</div><div class="line">    List&lt;ConnectionSpec&gt; connectionSpecs;</div><div class="line">    <span class="keyword">final</span> List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">final</span> List&lt;Interceptor&gt; networkInterceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    ProxySelector proxySelector;</div><div class="line">    CookieJar cookieJar;</div><div class="line">    Cache cache;</div><div class="line">    InternalCache internalCache;</div><div class="line">    SocketFactory socketFactory;</div><div class="line">    SSLSocketFactory sslSocketFactory;</div><div class="line">    CertificateChainCleaner certificateChainCleaner;</div><div class="line">    HostnameVerifier hostnameVerifier;</div><div class="line">    CertificatePinner certificatePinner;</div><div class="line">    Authenticator proxyAuthenticator;</div><div class="line">    Authenticator authenticator;</div><div class="line">    ConnectionPool connectionPool;</div><div class="line">    Dns dns;</div><div class="line">    <span class="keyword">boolean</span> followSslRedirects;</div><div class="line">    <span class="keyword">boolean</span> followRedirects;</div><div class="line">    <span class="keyword">boolean</span> retryOnConnectionFailure;</div><div class="line">    <span class="keyword">int</span> connectTimeout;</div><div class="line">    <span class="keyword">int</span> readTimeout;</div><div class="line">    <span class="keyword">int</span> writeTimeout;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call <span class="title">newCall</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RealCall(<span class="keyword">this</span>, request);</div><div class="line">    ...</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OkHttpClienté€šè¿‡Builderå®ä¾‹åŒ–ï¼Œå®ç°äº†Call.Factoryæ¥å£åˆ›å»ºäº†ä¸€ä¸ªRealCallçš„å®ä¾‹ï¼Œè€ŒRealCallæ˜¯Callæ¥å£çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Call</span> </span>&#123;</div><div class="line">  <span class="function">Request <span class="title">request</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">Response <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</div><div class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isExecuted</span><span class="params">()</span></span>;</div><div class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isCanceled</span><span class="params">()</span></span>;</div><div class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</div><div class="line">    <span class="function">Call <span class="title">newCall</span><span class="params">(Request request)</span></span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="RealCall"><a href="#RealCall" class="headerlink" title="RealCall"></a>RealCall</h2><p>RealCallä¸­å°è£…äº†OKHttpClientå’ŒRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">RealCall</span><span class="params">(OkHttpClient client, Request originalRequest)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.client = client;</div><div class="line">    <span class="keyword">this</span>.originalRequest = originalRequest;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span> </span>&#123;</div><div class="line">    enqueue(responseCallback, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</div><div class="line">      executed = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    client.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback, forWebSocket));</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span> <span class="keyword">extends</span> <span class="title">NamedRunnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Callback responseCallback;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> forWebSocket;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AsyncCall</span><span class="params">(Callback responseCallback, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(<span class="string">"OkHttp %s"</span>, redactedUrl().toString());</div><div class="line">      <span class="keyword">this</span>.responseCallback = responseCallback;</div><div class="line">      <span class="keyword">this</span>.forWebSocket = forWebSocket;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        Response response = getResponseWithInterceptorChain(forWebSocket);</div><div class="line">        <span class="keyword">if</span> (canceled) &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">if</span> (signalledCallback) &#123;</div><div class="line">          <span class="comment">// Do not signal the callback twice!</span></div><div class="line">          Platform.get().log(INFO, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="comment">//æ³¨æ„è¿™ä¸€å¥ä»£ç </span></div><div class="line">        client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨enqueueå°è£…æˆAsyncCalläº¤ç»™OKHttpClientçš„dispatcherçº¿ç¨‹æ± æ‰§è¡Œã€‚</p>
<h2 id="Dispatcherçº¿ç¨‹æ± "><a href="#Dispatcherçº¿ç¨‹æ± " class="headerlink" title="Dispatcherçº¿ç¨‹æ± "></a>Dispatcherçº¿ç¨‹æ± </h2><p>OkHttpçš„dispatcherå‚æ•°æ˜¯ç›´æ¥newå‡ºæ¥çš„ã€‚å…ˆçœ‹ä¸‹enqueueæ–¹æ³•ï¼Œå°†AsyncCallå½“åšå‚æ•°ä¼ é€’è¿›æ¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span> </span>&#123;</div><div class="line">  <span class="comment">/** æœ€å¤§å¹¶å‘è¯·æ±‚æ•°ä¸º64 */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxRequests = <span class="number">64</span>;</div><div class="line">  <span class="comment">/** æ¯ä¸ªä¸»æœºæœ€å¤§è¯·æ±‚æ•°ä¸º5 */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxRequestsPerHost = <span class="number">5</span>;</div><div class="line"></div><div class="line">  <span class="comment">/** çº¿ç¨‹æ±  */</span></div><div class="line">  <span class="keyword">private</span> ExecutorService executorService;</div><div class="line"></div><div class="line">  <span class="comment">/** å‡†å¤‡æ‰§è¡Œçš„è¯·æ±‚ */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/** æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚ï¼ŒåŒ…å«å·²ç»å–æ¶ˆä½†æœªæ‰§è¡Œå®Œçš„è¯·æ±‚ */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/** æ­£åœ¨æ‰§è¡Œçš„åŒæ­¥è¯·æ±‚ï¼ŒåŒ…å«å·²ç»å–æ¶ˆå•æœªæ‰§è¡Œå®Œçš„è¯·æ±‚ */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line">  <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(AsyncCall call)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</div><div class="line">      runningAsyncCalls.add(call);</div><div class="line">      executorService().execute(call);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      readyAsyncCalls.add(call);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> ExecutorService <span class="title">executorService</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (executorService == <span class="keyword">null</span>) &#123;</div><div class="line">      executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS,</div><div class="line">          <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(<span class="string">"OkHttp Dispatcher"</span>, <span class="keyword">false</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> executorService;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„é€ ä¸€ä¸ªçº¿ç¨‹æ± ExecutorServiceï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">executorService = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">    <span class="number">0</span>, <span class="comment">//corePoolSize æœ€å°å¹¶å‘çº¿ç¨‹æ•°,å¦‚æœæ˜¯0çš„è¯ï¼Œç©ºé—²ä¸€æ®µæ—¶é—´åæ‰€æœ‰çº¿ç¨‹å°†å…¨éƒ¨è¢«é”€æ¯ã€‚</span></div><div class="line">    Integer.MAX_VALUE, <span class="comment">//maximumPoolSize: æœ€å¤§çº¿ç¨‹æ•°ï¼Œå½“ä»»åŠ¡è¿›æ¥æ—¶å¯ä»¥æ‰©å……çš„çº¿ç¨‹æœ€å¤§å€¼ï¼Œå½“å¤§äºäº†è¿™ä¸ªå€¼å°±ä¼šæ ¹æ®ä¸¢å¼ƒå¤„ç†æœºåˆ¶æ¥å¤„ç†</span></div><div class="line">    <span class="number">60</span>, <span class="comment">//keepAliveTime: å½“çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´</span></div><div class="line">    TimeUnit.SECONDS,<span class="comment">//å•ä½ç§’</span></div><div class="line">    <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),<span class="comment">//å·¥ä½œé˜Ÿåˆ—,å…ˆè¿›å…ˆå‡º        Util.threadFactory("OkHttp Dispatcher", false));//å•ä¸ªçº¿ç¨‹çš„å·¥å‚</span></div></pre></td></tr></table></figure>
<p>æ„å»ºäº†ä¸€ä¸ªæœ€å¤§çº¿ç¨‹æ•°ä¸ºInteger.MAX_VALUEçš„çº¿ç¨‹æ± ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯ä¸ªä¸è®¾æœ€å¤§ä¸Šé™çš„çº¿ç¨‹æ± ï¼ˆå…¶å®æœ‰é™åˆ¶64ä¸ªï¼‰ï¼Œæœ‰å¤šå°‘ä»»åŠ¡æ·»åŠ è¿›æ¥å°±æ–°å»ºå¤šå°‘çº¿ç¨‹ï¼Œä»¥ä¿è¯I/Oä»»åŠ¡ä¸­é«˜é˜»å¡ä½å ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šé•¿æ—¶é—´å¡åœ¨é˜»å¡ä¸Šã€‚å½“å·¥ä½œå®Œæˆåï¼Œçº¿ç¨‹æ± ä¼šåœ¨60så†…ç›¸ç»§å…³é—­æ‰€æœ‰çº¿ç¨‹ã€‚</p>
<p>è¿˜è®°å¾—åˆšæ‰åœ¨AsyncCall.execute() finallyä¸­çš„å†…å®¹å—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">finally &#123;</div><div class="line">    client.dispatcher().finished(this);</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">  </div><div class="line">  /** Used by &#123;@code AsyncCall#run&#125; to signal completion. */</div><div class="line">  synchronized void finished(AsyncCall call) &#123;</div><div class="line">    if (!runningAsyncCalls.remove(call)) throw new AssertionError(&quot;AsyncCall wasn&apos;t running!&quot;);</div><div class="line">    promoteCalls();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"></div><div class="line">  //Dispatcher.java</div><div class="line">  private void promoteCalls() &#123;</div><div class="line">  //è¶…è¿‡é˜ˆå€¼ è¿”å›</div><div class="line">    if (runningAsyncCalls.size() &gt;= maxRequests) return; // Already running max capacity.</div><div class="line">    if (readyAsyncCalls.isEmpty()) return; // No ready calls to promote.</div><div class="line"></div><div class="line">    for (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) &#123;</div><div class="line">      AsyncCall call = i.next();</div><div class="line"></div><div class="line">      if (runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</div><div class="line">        i.remove();</div><div class="line">        runningAsyncCalls.add(call);</div><div class="line">        executorService().execute(call);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (runningAsyncCalls.size() &gt;= maxRequests) return; // Reached max capacity.</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>å½“AsyncCallæ‰§è¡Œå®Œæˆåï¼Œè°ƒç”¨Disptcherçš„finish()æ–¹æ³•ï¼Œè°ƒç”¨promoteCalls()æ–¹æ³•ï¼Œå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œç»§ç»­ç­‰å¾…ï¼Œå¦åˆ™å–å‡ºç¼“å­˜åŒºçš„ä»»åŠ¡æ‰§è¡Œï¼Œé¡ºåºæ˜¯å…ˆè¿›å…ˆå‡ºã€‚</p>
<p>Dispatcherçº¿ç¨‹æ± æ€»ç»“</p>
<ul>
<li>è°ƒåº¦çº¿ç¨‹æ± Disptcherå®ç°äº†é«˜å¹¶å‘ï¼Œä½é˜»å¡çš„å®ç°</li>
<li>é‡‡ç”¨Dequeä½œä¸ºç¼“å­˜ï¼Œå…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œ</li>
<li>ä»»åŠ¡åœ¨try/finallyä¸­è°ƒç”¨äº†finishedå‡½æ•°ï¼Œæ§åˆ¶ä»»åŠ¡é˜Ÿåˆ—çš„æ‰§è¡Œé¡ºåºï¼Œè€Œä¸æ˜¯é‡‡ç”¨é”ï¼Œå‡å°‘äº†ç¼–ç å¤æ‚æ€§æé«˜æ€§èƒ½</li>
</ul>
<h2 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h2><p>è°ƒåº¦åŸºæœ¬æ•´æ˜ç™½äº†ï¼ŒAsyncCall ä¸­çš„executeå…·ä½“å†…å®¹è¿˜æ²¡æœ‰åˆ†æï¼Œä¸»è¦å°±ä¸€è¡Œä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    ...</div><div class="line">    Response response = getResponseWithInterceptorChain(forWebSocket);</div><div class="line">    ...</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Response <span class="title">getResponseWithInterceptorChain</span><span class="params">(<span class="keyword">boolean</span>     forWebSocket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">Interceptor.Chain chain = <span class="keyword">new</span>         ApplicationInterceptorChain(<span class="number">0</span>, originalRequest, forWebSocket);</div><div class="line"><span class="keyword">return</span> chain.proceed(originalRequest);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»æ–¹æ³•åå­—åŸºæœ¬å¯ä»¥çŒœåˆ°æ˜¯å¹²å˜›çš„ï¼Œè°ƒç”¨<code>chain.proceed(originalRequest);</code>å°†requestä¼ é€’è¿›æ¥ï¼Œä»æ‹¦æˆªå™¨é“¾é‡Œæ‹¿åˆ°è¿”å›ç»“æœã€‚é‚£ä¹ˆæ‹¦æˆªå™¨Interceptoræ˜¯å¹²å˜›çš„ï¼ŒChainæ˜¯å¹²å˜›çš„å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹ApplicationInterceptorChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationInterceptorChain</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Chain</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Request request;</div><div class="line"></div><div class="line">    ApplicationInterceptorChain(<span class="keyword">int</span> index, Request request, <span class="keyword">boolean</span> forWebSocket) &#123;</div><div class="line">      <span class="keyword">this</span>.index = index;</div><div class="line">      <span class="keyword">this</span>.request = request;</div><div class="line">      <span class="keyword">this</span>.forWebSocket = forWebSocket;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Connection <span class="title">connection</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Request <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> request;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      <span class="comment">// If there's another interceptor in the chain, call that.</span></div><div class="line">      <span class="keyword">if</span> (index &lt; client.interceptors().size()) &#123;</div><div class="line">        Interceptor.Chain chain = <span class="keyword">new</span> ApplicationInterceptorChain(index + <span class="number">1</span>, request, forWebSocket);</div><div class="line">        Interceptor interceptor = client.interceptors().get(index);</div><div class="line">        Response interceptedResponse = interceptor.intercept(chain);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (interceptedResponse == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"application interceptor "</span> + interceptor</div><div class="line">              + <span class="string">" returned null"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> interceptedResponse;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// No more interceptors. Do HTTP.</span></div><div class="line">      <span class="keyword">return</span> getResponse(request, forWebSocket);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>ApplicationInterceptorChainå®ç°äº†Interceptor.Chainæ¥å£ï¼ŒæŒæœ‰Requestçš„å¼•ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line">  <span class="function">Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Chain</span> </span>&#123;</div><div class="line">    <span class="function">Request <span class="title">request</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line"></div><div class="line">    <span class="function">Connection <span class="title">connection</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>proceedæ–¹æ³•ä¸­åˆ¤æ–­indexï¼ˆæ­¤æ—¶ä¸º0ï¼‰æ˜¯å¦å°äºclient.interceptors(List<interceptor> )çš„å¤§å°ï¼Œå¦‚æœå°äºä¹Ÿå°±æ˜¯è¯´client.interceptorsè¿˜æœ‰Interceptorï¼Œé‚£ä¹ˆå°±å†å°è£…ä¸€ä¸ªApplicationInterceptorChainï¼Œåªä¸è¿‡index + 1ï¼Œç„¶åå–å‡ºç¬¬indexä¸ªInterceptorå°†chainä¼ é€’è¿›å»ã€‚ä¼ é€’è¿›å»å¹²å˜›å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸ªç”¨æ³•ï¼Œä»¥å®é™…é¡¹ç›®ä¸ºä¾‹</interceptor></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">HttpLoggingInterceptor interceptor = <span class="keyword">new</span> HttpLoggingInterceptor(<span class="keyword">new</span> RetrofitLogger());</div><div class="line">        interceptor.setLevel(HttpLoggingInterceptor.Level.BODY);</div><div class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">        .addInterceptor(interceptor)</div><div class="line">        .retryOnConnectionFailure(<span class="keyword">true</span>)</div><div class="line">        .connectTimeout(<span class="number">15</span>, TimeUnit.SECONDS)</div><div class="line">        .addInterceptor(getCommonParameterInterceptor())</div><div class="line">        .addNetworkInterceptor(getTokenInterceptor())</div><div class="line">        .build();</div><div class="line">        </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Interceptor <span class="title">getCommonParameterInterceptor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Interceptor() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            Request originalRequest = chain.request();</div><div class="line">            Request request = originalRequest;</div><div class="line">            <span class="keyword">if</span> (!originalRequest.method().equalsIgnoreCase(<span class="string">"POST"</span>)) &#123;</div><div class="line">                HttpUrl modifiedUrl = originalRequest.url().newBuilder()</div><div class="line">                        .addQueryParameter(<span class="string">"version_code"</span>, String.valueOf(AppUtils.getVersionCode()))</div><div class="line">                        .addQueryParameter(<span class="string">"app_key"</span>, <span class="string">"nicepro"</span>)</div><div class="line">                        .addQueryParameter(<span class="string">"app_device"</span>, <span class="string">"Android"</span>)</div><div class="line">                        .addQueryParameter(<span class="string">"app_version"</span>, AppUtils.getVersionName())</div><div class="line">                        .addQueryParameter(<span class="string">"token"</span>, AccountUtils.getToken())</div><div class="line">                        .build();</div><div class="line">                request = originalRequest.newBuilder().url(modifiedUrl).build();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> chain.proceed(request);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Interceptor <span class="title">getTokenInterceptor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Interceptor() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            Request originalRequest = chain.request();</div><div class="line">            Request authorised = originalRequest.newBuilder()</div><div class="line">                    .header(<span class="string">"app-key"</span>, <span class="string">"nicepro"</span>)</div><div class="line">                    .header(<span class="string">"app-device"</span>, <span class="string">"Android"</span>)</div><div class="line">                    .header(<span class="string">"app-version"</span>, AppUtils.getVersionName())</div><div class="line">                    .header(<span class="string">"os"</span>, AppUtils.getOs())</div><div class="line">                    .header(<span class="string">"os-version"</span>, AppUtils.getAndroidVersion() + <span class="string">""</span>)</div><div class="line">                    .header(<span class="string">"Accept"</span>, <span class="string">"application/json"</span>)</div><div class="line">                    .header(<span class="string">"User-Agent"</span>, <span class="string">"Android/retrofit"</span>)</div><div class="line">                    .header(<span class="string">"token"</span>, AccountUtils.getToken())</div><div class="line">                    .build();</div><div class="line">            <span class="keyword">return</span> chain.proceed(authorised);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ¯ä¸ªInterceptorçš„interceptæ–¹æ³•ä¸­åšäº†ä¸€äº›æ“ä½œåï¼Œæœ€åéƒ½ä¼šè°ƒç”¨<code>chain.proceed(request)</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ªchainå°±æ˜¯æ¯æ¬¡prceedæ–¹æ³•ä¸­ç”Ÿæˆçš„ApplicationInterceptorChainï¼Œç”¨index+1çš„æ–¹å¼é€’å½’è°ƒç”¨OkHttClientä¸­çš„Interceptorsï¼Œè¿›è¡Œæ‹¦æˆªæ“ä½œï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥ç›‘æ§logï¼Œä¿®æ”¹è¯·æ±‚ï¼Œä¿®æ”¹ç»“æœï¼Œä¾›å¼€å‘è€…è‡ªå®šä¹‰å‚æ•°æ·»åŠ ç­‰ç­‰ï¼Œç„¶åæœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯æœ€åˆçš„index=0çš„é‚£ä¸ªchainçš„proceedæ–¹æ³•ä¸­çš„<code>getResponse(request, forWebSocket);</code>ã€‚</p>
<p>å¯ä»¥è¯´OkHttpæ˜¯ç”¨chainä¸²è”èµ·æ‹¦æˆªå™¨ï¼Œè€Œæ¯ä¸ªæ‹¦æˆªå™¨éƒ½æœ‰èƒ½åŠ›è¿”å›Responseï¼Œè¿”å›Responseå³ç»ˆæ­¢æ•´ä¸ªè°ƒç”¨é“¾ï¼Œè¿™ç§è®¾è®¡æ¨¡å¼ç§°ä¸º<a href="https://zh.wikipedia.org/wiki/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F" target="_blank" rel="external">è´£ä»»é“¾æ¨¡å¼</a>ã€‚è¿™ç§æ¨¡å¼ä¸ºOkHttpæä¾›äº†å¼ºå¤§çš„è£…é…èƒ½åŠ›ï¼Œæå¤§çš„æé«˜äº†OkHttpçš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<p>åœ¨Androidç³»ç»Ÿä¸­æœ€å…¸å‹çš„è´£ä»»é“¾æ¨¡å¼å°±æ˜¯Viewçš„Touchä¼ é€’æœºåˆ¶ï¼Œä¸€å±‚ä¸€å±‚ä¼ é€’ç›´åˆ°è¢«æ¶ˆè´¹ã€‚</p>
<p>å®˜æ–¹çš„ä¸€å¼ å›¾å°±èƒ½å¾ˆå¥½çš„è§£é‡ŠInterceptor<br><img src="https://raw.githubusercontent.com/wiki/square/okhttp/interceptors@2x.png" alt=""><br>æ•´ä¸ªæµç¨‹å¾ˆæ¸…æ™°ã€‚è¿™ç§è®¾è®¡çœŸæ˜¯å¤ªæ£’äº†ï¼Œå€¼å¾—å­¦ä¹ ï¼</p>
<h2 id="è¿æ¥æ± å¤ç”¨"><a href="#è¿æ¥æ± å¤ç”¨" class="headerlink" title="è¿æ¥æ± å¤ç”¨"></a>è¿æ¥æ± å¤ç”¨</h2><p>æˆ‘ä»¬çŸ¥é“è¿›è¡Œä¸€æ¬¡tcpç½‘ç»œè¯·æ±‚ï¼Œä¸€èˆ¬è¦ä¸‰æ¬¡æ¡æ‰‹è¿æ¥ï¼Œå››æ¬¡æ¡æ‰‹æ–­å¼€è¿æ¥ã€‚ä¸€æ¬¡å®Œæ•´çš„httpè¯·æ±‚è¿‡ç¨‹è§ä¸‹å›¾ã€‚</p>
<p><img src="http://7xs23g.com1.z0.glb.clouddn.com/http.jpg" alt=""></p>
<p>å¦‚æœè¯·æ±‚é‡å¤çš„åœ°å€ï¼Œé‚£ä¹ˆé‡å¤çš„è¿æ¥å’Œæ–­å¼€è¿æ¥å°±æˆäº†å»¶é•¿æ•´ä¸ªæ—¶é—´çš„çš„é‡è¦å› ç´ ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œæ¯æ¬¡è¯·æ±‚ä¼ è¾“æ•°æ®çš„å¤§å°å°†ä¸å†æ˜¯è¯·æ±‚é€Ÿåº¦çš„å†³å®šæ€§å› ç´ ã€‚</p>
<p>httpæœ‰ä¸€ç§<code>keepalive connections</code>çš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨ä¼ è¾“åä»ç„¶ä¿æŒè¿æ¥ï¼Œå½“å®¢æˆ·ç«¯éœ€è¦å†æ¬¡è·å–æ•°æ®æ—¶ï¼Œç›´æ¥ä½¿ç”¨åˆšåˆšç©ºé—²ä¸‹æ¥çš„è¿æ¥è€Œä¸éœ€è¦å†æ¬¡æ¡æ‰‹ã€‚</p>
<p>Okhttpæ”¯æŒ5ä¸ªå¹¶å‘KeepAliveï¼Œé»˜è®¤é“¾è·¯ç”Ÿå‘½ä¸º5åˆ†é’Ÿ(é“¾è·¯ç©ºé—²åï¼Œä¿æŒå­˜æ´»çš„æ—¶é—´)ï¼Œå…³äºOkHttpè¿æ¥æ± å¤ç”¨è¯¦ç»†è¯·çœ‹è¿™ç¯‡æ–‡ç«  <a href="http://www.jianshu.com/p/92a61357164b" target="_blank" rel="external">OkHttp3æºç åˆ†æ[å¤ç”¨è¿æ¥æ± ]</a>ã€‚</p>
<h2 id="DNSè§£æ"><a href="#DNSè§£æ" class="headerlink" title="DNSè§£æ"></a>DNSè§£æ</h2><p>å¯¹æ¯”ä¸Šä¸€å¼ å›¾çš„ä¸€æ¬¡å®Œæ•´çš„Httpè¯·æ±‚ï¼Œåœ¨å¤æ‚çš„å¤©æœç½‘ç»œç¯å¢ƒä¸‹ï¼Œç›¸ä¿¡å¤§å¤šæ•°å¼€å‘è€…éƒ½ç¢°åˆ°è¿‡å¾ˆå¥‡æ€ªçš„ç½‘ç»œé—®é¢˜ï¼Œæ¯”å¦‚è¿è¥å•†åŠ¨æ€æ’å…¥è¾£é¸¡htmlä»£ç åµŒå…¥å¹¿å‘Šï¼Œæ¯”å¦‚è¿è¥å•†ç¼“å­˜è¯·æ±‚æ•°æ®å¯¼è‡´ç”¨æˆ·è¯·æ±‚åˆ°çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„é—®é¢˜ï¼Œæ¯”å¦‚æŸäº›è¿è¥å•†åªæ”¯æŒ<code>put\post</code>è¯·æ±‚ï¼Œè€Œä¸æ”¯æŒ<code>delete</code>è¯·æ±‚ï¼Œæ¯”å¦‚è¿è¥å•†ã€‚ã€‚ã€‚è¿™äº›é—®é¢˜å¤§éƒ¨åˆ†éƒ½è·ŸDNSç›¸å…³ã€‚</p>
<p>ä¸ºäº†è§£å†³DNSåŠ«æŒçš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨è–„è·appä¸Šåšäº†å¾ˆå¤šä¼˜åŒ–å·¥ä½œï¼Œæ¯”å¦‚ä½¿ç”¨HTTP DNSï¼ˆæˆ‘ä»¬ä½¿ç”¨çš„DNSPodï¼‰ä»£æ›¿ç³»ç»Ÿè‡ªå¸¦çš„libcåº“å»æŸ¥è¯¢è¿è¥å•†çš„DNSæœåŠ¡å™¨ï¼Œç›´æ¥æ‹¿åˆ°IPåœ°å€è¿›è¡ŒIPç›´è¿ï¼Œå…¶ä¸­åˆåšäº†ä¸€äº›ç¼“å­˜å’Œé€‰æ‹©æœ€ä¼˜IPçš„ä¸€äº›æ“ä½œã€‚è§£å†³æ‰äº†å¾ˆå¤§ä¸€éƒ¨åˆ†ç”¨æˆ·åé¦ˆçš„ç½‘ç»œé—®é¢˜ã€‚</p>
<p>è€Œåœ¨OkHttpä¸­ï¼Œå¯ä»¥ç›´æ¥é…ç½®DNSï¼Œé»˜è®¤æ˜¯ç³»ç»Ÿè‡ªå¸¦çš„<code>Dns.SYSTEM</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Try each address for best behavior in mixed IPv4/IPv6 environments.</span></div><div class="line">List&lt;InetAddress&gt; addresses = address.dns().lookup(socketHost);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = addresses.size(); i &lt; size; i++) &#123;</div><div class="line">  InetAddress inetAddress = addresses.get(i);</div><div class="line">  inetSocketAddresses.add(<span class="keyword">new</span> InetSocketAddress(inetAddress, socketPort));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ç»“æœæ˜¯æ•°ç»„ï¼Œå³ä¸€ä¸ªåŸŸåå¯èƒ½ä¼šæœ‰å¤šä¸ªIPï¼Œå¦‚æœä¸€ä¸ªIPä¸é€šï¼Œä¼šè‡ªåŠ¨é‡è¿ä¸‹ä¸€ä¸ªIPã€‚</p>
<p>å¼€å‘è€…å°±å¯ä»¥æ–°å»ºä¸€ä¸ªDnsç±»å¤å†™<code>lookup</code>æ–¹æ³•é€šè¿‡HTTP DNSè¯·æ±‚IPåœ°å€ï¼Œå…¶ä¸­æ–°å»ºä¸€ä¸ª<code>HttpDNSClient</code>æ¥è¯·æ±‚DNSï¼Œæ’å…¥æ‹¦æˆªå™¨æ¥é…ç½®ç¼“å­˜æ—¶é—´ï¼Œå®¹é”™å¤„ç†ç­‰ç­‰ï¼Œç„¶ååœ¨æ„å»ºOkHttpClientæ—¶åŠ å…¥<code>dns</code>æ–¹æ³•å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">client = <span class="keyword">new</span> OkHttpClient.Builder().addNetworkInterceptor(getLogger())</div><div class="line">        .dispatcher(getDispatcher())</div><div class="line">        <span class="comment">//é…ç½®DNSæŸ¥è¯¢å®ç°</span></div><div class="line">        .dns(HTTP_DNS)</div><div class="line">        .build();</div></pre></td></tr></table></figure>
<p>è¿™æ ·çš„å…¨å±€HTTP DNSè§£æçœŸæ˜¯è¶³å¤Ÿç®€å•é«˜æ•ˆï¼Œå¹¶ä¸”å®Œå…¨æ˜¯æ— ä¾µå…¥æ€§çš„ï¼Œä¸æ¯«ä¸å½±å“æ­£å¸¸çš„ç½‘ç»œè¯·æ±‚ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡åŸºæœ¬è®²äº†ä¸‹OkHttp3çš„å¤§æ¦‚æµç¨‹ï¼ŒInterceptorçš„åŸºæœ¬åŸç†ï¼ŒDNSçš„å¯é€‰é…ç½®ç­‰ã€‚æ¶‰åŠåˆ°socketå’ŒOkioæµç›¸å…³çš„éƒ½æ²¡æœ‰è®²åˆ°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥åœ¨å‚è€ƒæ–‡ç« è‡ªè¡Œæœç´¢ã€‚æ€»ç»“æ¥è¯´ï¼ŒOkHttpåŸºæœ¬å¯ä»¥æ»¡è¶³æ—¥å¸¸å¼€å‘çš„éœ€æ±‚ï¼Œå¹¶ä¸”æ€§èƒ½è¶³å¤Ÿå¼ºå¤§ï¼Œé…åˆRetrofit + Rxjavaæ›´æ˜¯æ•ˆç‡ç¿»å€ã€‚å¦‚æœä½ åœ¨å¼€å‘æ–°çš„é¡¹ç›®ï¼Œå¼ºçƒˆå»ºè®®ä½ æ‰”æ‰Volleyï¼Œæ‹¥æŠ±Retrofitã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="http://www.jianshu.com/p/aad5aacd79bf" target="_blank" rel="external">OkHttp3æºç åˆ†æ[ç»¼è¿°]</a></li>
<li><a href="http://www.jianshu.com/p/9803a6efb672" target="_blank" rel="external">OkHttp3åº”ç”¨[HTTP DNSçš„å®ç°]</a></li>
<li><a href="https://gold.xitu.io/post/581311cabf22ec0068826aff" target="_blank" rel="external">ä»OKHttpæ¡†æ¶çœ‹ä»£ç è®¾è®¡</a></li>
<li><a href="http://blog.piasy.com/2016/07/11/Understand-OkHttp/" target="_blank" rel="external">æ‹†è½®å­ç³»åˆ—ï¼šæ‹† OkHttp</a></li>
<li><a href="http://blog.csdn.net/liudong8510/article/details/7908093" target="_blank" rel="external">ä¸€æ¬¡å®Œæ•´çš„Httpè¯·æ±‚è¿‡ç¨‹</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/12/06/OkHttp/">http://w4lle.com/2016/12/06/OkHttp/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ä¹‹å‰çš„åº•å±‚ç½‘ç»œåº“åŸºæœ¬å°±æ˜¯Apache HttpClientå’ŒHttpURLConnectionã€‚ç”±äºHttClientæ¯”è¾ƒéš¾ç”¨ï¼Œå®˜æ–¹åœ¨And
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Retrofit Multipartå¤šæ–‡ä»¶ä¸Šä¼ </title>
    <link href="http://w4lle.com/2016/11/28/retrofit-multipart/"/>
    <id>http://w4lle.com/2016/11/28/retrofit-multipart/</id>
    <published>2016-11-28T01:03:43.000Z</published>
    <updated>2017-01-06T01:53:41.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æ–°é¡¹ç›®çš„ç½‘ç»œåº“å·²ç»ç”±Volleyåˆ‡åˆ°äº†Retrofitï¼Œé…åˆ<code>Rxjava + Dagger2 + CleanArchitecture</code> ï¼Œæœ‰æ•ˆçš„å°†é¡¹ç›®è§£è€¦å’Œï¼Œå„ä¸ªå±‚æ¬¡èŒè´£æ›´æ¸…æ™°ã€‚ä¾èµ–æ³¨å…¥å’Œæ³¨è§£ã€åŠ¨æ€ä»£ç†æå¤§çš„ç®€åŒ–äº†ç½‘ç»œè¯·æ±‚ï¼Œå¼€å‘æ›´é«˜æ•ˆã€‚</p>
<p>é¡¹ç›®ä¸­ç»å¸¸ä¼šæœ‰ä¸Šä¼ æ–‡ä»¶çš„éœ€æ±‚ï¼Œç‰¹åˆ«æ˜¯ä¸Šä¼ å›¾ç‰‡ã€‚ä¸Šä¼ å›¾ç‰‡é€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>bitmapé€šè¿‡Base64è½¬ä¸ºStringï¼Œè¿™ç§æ–¹å¼å¯¹äºå®¢æˆ·ç«¯æœ€å‹å¥½ï¼Œä½†æ˜¯å¯¹äºæœåŠ¡ç«¯è¦å¤æ‚äº›</li>
<li>multipart/form-data æ–¹å¼</li>
</ul>
<a id="more"></a>
<h1 id="multipart-form-data-æ˜¯ä»€ä¹ˆ"><a href="#multipart-form-data-æ˜¯ä»€ä¹ˆ" class="headerlink" title="multipart/form-data æ˜¯ä»€ä¹ˆ"></a>multipart/form-data æ˜¯ä»€ä¹ˆ</h1><p>httpåè®®å°†è¯·æ±‚åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼šçŠ¶æ€è¡Œï¼Œè¯·æ±‚å¤´ï¼Œè¯·æ±‚ä½“ã€‚<br>è€ŒRESTFulé£æ ¼è¯·æ±‚æ›´multipartåˆæœ‰äº›ä¸åŒï¼Œå…·ä½“çš„ï¼š</p>
<ol>
<li><code>multipart/form-data</code>çš„åŸºç¡€æ–¹æ³•æ˜¯postï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯ç”±postæ–¹æ³•æ¥ç»„åˆå®ç°çš„ã€‚</li>
<li><code>multipart/form-data</code>ä¸postæ–¹æ³•çš„ä¸åŒä¹‹å¤„ï¼šè¯·æ±‚å¤´ï¼Œè¯·æ±‚ä½“ã€‚</li>
<li><code>multipart/form-data</code>çš„è¯·æ±‚å¤´å¿…é¡»åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„å¤´ä¿¡æ¯ï¼šContent-Typeï¼Œä¸”å…¶å€¼ä¹Ÿå¿…é¡»è§„å®šä¸ºmultipart/form-dataï¼ŒåŒæ—¶è¿˜éœ€è¦è§„å®šä¸€ä¸ªå†…å®¹åˆ†å‰²ç¬¦ç”¨äºåˆ†å‰²è¯·æ±‚ä½“ä¸­çš„å¤šä¸ªpostçš„å†…å®¹ï¼Œå¦‚æ–‡ä»¶å†…å®¹å’Œæ–‡æœ¬å†…å®¹è‡ªç„¶éœ€è¦åˆ†å‰²å¼€æ¥ï¼Œä¸ç„¶æ¥æ”¶æ–¹å°±æ— æ³•æ­£å¸¸è§£æå’Œè¿˜åŸè¿™ä¸ªæ–‡ä»¶ã€‚</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Content-Type: multipart/form-data; boundary=$&#123;bound&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­${bound}æ˜¯å®šä¹‰çš„åˆ†éš”ç¬¦ï¼Œç”¨äºåˆ†å‰²å„é¡¹å†…å®¹(æ–‡ä»¶,key-valueå¯¹)ã€‚postæ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">--$&#123;bound&#125;</div><div class="line">Content-Disposition: form-data; name=<span class="string">"Filename"</span></div><div class="line"> </div><div class="line">HTTP.pdf</div><div class="line">--$&#123;bound&#125;</div><div class="line">Content-Disposition: form-data; name=<span class="string">"file000"</span>; filename=<span class="string">"HTTPåè®®è¯¦è§£.pdf"</span></div><div class="line">Content-Type: application/octet-stream</div><div class="line"> </div><div class="line">%PDF-<span class="number">1.5</span></div><div class="line">file content</div><div class="line">%%EOF</div><div class="line"> </div><div class="line">--$&#123;bound&#125;</div><div class="line">Content-Disposition: form-data; name=<span class="string">"Upload"</span></div><div class="line"> </div><div class="line">Submit Query</div><div class="line">--$&#123;bound&#125;--</div></pre></td></tr></table></figure>
<p>${bound}æ˜¯Content-Typeé‡Œboundaryçš„å€¼</p>
<h1 id="Volley-multipart"><a href="#Volley-multipart" class="headerlink" title="Volley multipart"></a>Volley multipart</h1><p>åœ¨ä¹‹å‰çš„é¡¹ç›®ä¸­ä½¿ç”¨Volleyï¼Œç”±äºVolleyçš„é«˜åº¦å¯æ‰©å±•æ€§å®ç°èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ï¼Œå°è£…ä¸€ä¸ª<a href="https://gist.github.com/w4lle/aecfecc5285c6d8e85eeff80685cadbb" target="_blank" rel="external">MultipartRequest</a>å³å¯ã€‚ä¸»è¦çš„è¿™è¡Œä»£ç æ›´æ”¹Content-Typeçš„å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getBodyContentType</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"multipart/form-data;charset=utf-8;boundary="</span> + boundary ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Retrofit-multipart"><a href="#Retrofit-multipart" class="headerlink" title="Retrofit multipart"></a>Retrofit multipart</h1><p>ç”±äºRetrofitæ˜¯ä¸€ä¸ªç½‘ç»œåº“çš„å°è£…ï¼Œå…·ä½“çš„ç½‘ç»œè¯·æ±‚é»˜è®¤æ˜¯ä½¿ç”¨OkHttpï¼ŒRetrofitå¯¹äºmultipartçš„æ”¯æŒæœ€ç»ˆä¹Ÿä¼šè½¬æ¢æˆOkHttpçš„å®ç°ã€‚</p>
<p>åœ¨Retrofitä¸­å®ç°ä¸€ä¸ªmultipartä¸Šä¼ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Multipart</span></div><div class="line"><span class="meta">@POST</span>(<span class="string">"upload"</span>)</div><div class="line"><span class="function">Call&lt;ResponseBody&gt; <span class="title">uploadFile</span><span class="params">(</span></span></div><div class="line">    @Part(<span class="string">"description"</span>) RequestBody description,</div><div class="line">    @Part MultipartBody.Part file);</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><code>@retrofit2.http.Multipart</code>æ³¨è§£: æ ‡è®°ä¸€ä¸ªè¯·æ±‚æ˜¯multipart/form-dataç±»å‹,éœ€è¦å’Œ@retrofit2.http.POSTä¸€åŒä½¿ç”¨ï¼Œå‚æ•°å¯ä»¥æ˜¯<code>MultipartBody.Part</code>æˆ–<code>RequestBody</code>ã€‚</li>
<li><code>@retrofit2.http.Part</code>æ³¨è§£: ä»£è¡¨Multiparté‡Œçš„ä¸€é¡¹æ•°æ®,å³ç”¨${bound}åˆ†éš”çš„å†…å®¹å—ã€‚</li>
</ul>
<p>å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶å’Œä¸€ä¸ªå‚æ•°ã€‚ä½†æ˜¯è¿™æ ·å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘æœ‰ä¸€ä¸ªå®ä½“ç±»æƒ³è¦ä¸€èµ·ä¸Šä¼ æ€ä¹ˆåŠï¼Œæ€»ä¸èƒ½å†uploadFileæ–¹æ³•é‡Œå®šä¹‰å¾ˆå¤š<code>@Part(&quot;description&quot;) RequestBody description</code>è¿™ç§å‚æ•°å§ï¼Œå¦‚æœæˆ‘æœ‰å¤šå¼ å›¾ç‰‡è¦ä¸€èµ·ä¸Šä¼ å‘¢ï¼Ÿ</p>
<h1 id="æ–‡ä»¶å’Œå‚æ•°ä¸€èµ·æäº¤"><a href="#æ–‡ä»¶å’Œå‚æ•°ä¸€èµ·æäº¤" class="headerlink" title="æ–‡ä»¶å’Œå‚æ•°ä¸€èµ·æäº¤"></a>æ–‡ä»¶å’Œå‚æ•°ä¸€èµ·æäº¤</h1><p>å¯ä»¥ä½¿ç”¨@PartMap()æ³¨è§£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Multipart</span></div><div class="line">    <span class="meta">@POST</span>(<span class="string">"upload"</span>)</div><div class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">uploadFileWithPartMap</span><span class="params">(</span></span></div><div class="line">            @PartMap() Map&lt;String, RequestBody&gt; partMap,</div><div class="line">            @Part MultipartBody.Part file);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>@PartMapæ³¨è§£ä»£è¡¨å‚æ•°çš„ä¸€ä¸ªé›†åˆã€‚è¿™æ ·ä½¿ç”¨èµ·æ¥å°±å¾ˆæ–¹ä¾¿ï¼Œå¯¹äºå¤šä¸ªå‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Map&lt;String, String&gt; partMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    MultiPartUtil.putRequestBodyMap(partMap, <span class="string">"service_code"</span>, certiValue[checkedItem]);</div><div class="line">    MultiPartUtil.putRequestBodyMap(partMap, <span class="string">"good_at"</span>, goodAt);</div><div class="line">    MultiPartUtil.putRequestBodyMap(partMap, <span class="string">"introduction"</span>, des);</div><div class="line">    MultiPartUtil.putRequestBodyMap(partMap, <span class="string">"integrity"</span>, <span class="string">"certificate"</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MULTIPART_FORM_DATA = <span class="string">"multipart/form-data"</span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putRequestBodyMap</span><span class="params">(Map map, String key, String value)</span> </span>&#123;</div><div class="line">        putRequestBodyMap(map, key, createPartFromString(value));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestBody <span class="title">createPartFromString</span><span class="params">(String descriptionString)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (descriptionString == <span class="keyword">null</span>) &#123;</div><div class="line">            descriptionString = <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> RequestBody.create(</div><div class="line">                MediaType.parse(MULTIPART_FORM_DATA), descriptionString);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putRequestBodyMap</span><span class="params">(Map map, String key, RequestBody body)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(key) &amp;&amp; body != <span class="keyword">null</span>) &#123;</div><div class="line">            map.put(key, body);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ„é€ äº†<code>Content-Type</code>ä¸º<code>multipart/form-data</code>çš„RequestBodyï¼ˆæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥ä¸º <code>application/json; charset=utf-8</code>ï¼‰,åŒæ ·çš„æ„é€ File part</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> MultipartBody.<span class="function">Part <span class="title">prepareFilePart</span><span class="params">(String partName, String fileUri)</span> </span>&#123;</div><div class="line"><span class="comment">//å‹ç¼©</span></div><div class="line">    File file = ViewUtils.compressImageToFile(fileUri, <span class="keyword">new</span> File(FileUtils.getImageCache(BaseApplication.getContext()), partName + <span class="string">".png"</span>));</div><div class="line">    <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// ä¸ºfileå»ºç«‹RequestBodyå®ä¾‹</span></div><div class="line">        RequestBody requestFile =</div><div class="line">        RequestBody.create(MediaType.parse(MULTIPART_FORM_DATA), file);</div><div class="line">        <span class="comment">// MultipartBody.Partå€ŸåŠ©æ–‡ä»¶åå®Œæˆæœ€ç»ˆçš„ä¸Šä¼ </span></div><div class="line">        <span class="keyword">return</span> MultipartBody.Part.createFormData(partName, file.getName(), requestFile);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±åŸºæœ¬ç¬¦åˆéœ€æ±‚ï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¤šå¼ å›¾ç‰‡å‘¢ï¼Ÿæ€»ä¸èƒ½ä¸€ä¸ªå‚æ•°ä¸€ä¸ªå‚æ•°å†™å§ã€‚<br>å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œç”±äº<code>@Part MultipartBody.Part file</code>ç±»å‹ä¸€è‡´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¯å˜å‚æ•°åˆ—è¡¨ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Multipart</span></div><div class="line">    <span class="meta">@POST</span>(<span class="string">"upload"</span>)</div><div class="line">    <span class="function">Observable&lt;JsonObject&gt; <span class="title">authCertification</span><span class="params">(@PartMap Map&lt;String, RequestBody&gt; partMap, @Part MultipartBody.Part... files)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">api.authCertification(partMap, avatarPart,</div><div class="line">                idFrontPart, idBackPart, authOnePart, authTwoPart, authThreePart)</div></pre></td></tr></table></figure>
<p>å¯ä»¥ä¼ ä»»æ„å¤šä¸ªæ–‡ä»¶ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://futurestud.io/tutorials/retrofit-2-passing-multiple-parts-along-a-file-with-partmap" target="_blank" rel="external">Retrofit 2 â€” Passing Multiple Parts Along a File with @PartMap</a></li>
<li><a href="http://www.chenkaihua.com/2016/04/02/retrofit2-upload-multipart-files/" target="_blank" rel="external">Retrofit2 multpartå¤šæ–‡ä»¶ä¸Šä¼ è¯¦è§£</a></li>
<li><a href="https://my.oschina.net/cnlw/blog/168466" target="_blank" rel="external">HTTPåè®®ä¹‹multipart/form-dataè¯·æ±‚åˆ†æ</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/11/28/retrofit-multipart/">http://w4lle.com/2016/11/28/retrofit-multipart/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æ–°é¡¹ç›®çš„ç½‘ç»œåº“å·²ç»ç”±Volleyåˆ‡åˆ°äº†Retrofitï¼Œé…åˆ&lt;code&gt;Rxjava + Dagger2 + CleanArchitecture&lt;/code&gt; ï¼Œæœ‰æ•ˆçš„å°†é¡¹ç›®è§£è€¦å’Œï¼Œå„ä¸ªå±‚æ¬¡èŒè´£æ›´æ¸…æ™°ã€‚ä¾èµ–æ³¨å…¥å’Œæ³¨è§£ã€åŠ¨æ€ä»£ç†æå¤§çš„ç®€åŒ–äº†ç½‘ç»œè¯·æ±‚ï¼Œå¼€å‘æ›´é«˜æ•ˆã€‚&lt;/p&gt;
&lt;p&gt;é¡¹ç›®ä¸­ç»å¸¸ä¼šæœ‰ä¸Šä¼ æ–‡ä»¶çš„éœ€æ±‚ï¼Œç‰¹åˆ«æ˜¯ä¸Šä¼ å›¾ç‰‡ã€‚ä¸Šä¼ å›¾ç‰‡é€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;bitmapé€šè¿‡Base64è½¬ä¸ºStringï¼Œè¿™ç§æ–¹å¼å¯¹äºå®¢æˆ·ç«¯æœ€å‹å¥½ï¼Œä½†æ˜¯å¯¹äºæœåŠ¡ç«¯è¦å¤æ‚äº›&lt;/li&gt;
&lt;li&gt;multipart/form-data æ–¹å¼&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Hexo Materialä¸»é¢˜</title>
    <link href="http://w4lle.com/2016/11/17/hexo-theme-material/"/>
    <id>http://w4lle.com/2016/11/17/hexo-theme-material/</id>
    <published>2016-11-17T02:41:20.000Z</published>
    <updated>2016-11-28T14:24:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Material"><a href="#Material" class="headerlink" title="Material"></a>Material</h1><p>æœ€è¿‘æŠŠåšå®¢ä¸»é¢˜æ¢æˆäº†<a href="https://github.com/viosey/hexo-theme-material" target="_blank" rel="external">Material</a>ï¼Œè¯¥ä¸»é¢˜åˆšåˆšä¸Šçº¿ï¼Œæ•ˆæœè¿˜ä¸é”™ã€‚</p>
<p>éœ€è¦æŠŠä»¥å‰çš„é…ç½®è¿ç§»ä¸€ä¸‹ï¼ŒåŒ…æ‹¬ç•™è¨€ä¹‹ç±»çš„ã€‚</p>
<h1 id="å¤šè¯´è¯„è®º"><a href="#å¤šè¯´è¯„è®º" class="headerlink" title="å¤šè¯´è¯„è®º"></a>å¤šè¯´è¯„è®º</h1><p>ç”±äºä¹‹å‰ç”¨çš„NexTä¸»é¢˜ï¼Œå¤šè¯´åå°æ¯ç¯‡æ–‡ç« çš„thread-keyæ˜¯æ ¹æ®NexTä¸»é¢˜æ¥çš„ï¼Œç°åœ¨Materialä¸»é¢˜çš„å¤šè¯´é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;div id="comments"&gt;</div><div class="line">    &lt;!-- å¤šè¯´è¯„è®ºæ¡† start --&gt;</div><div class="line">        &lt;div class="ds-thread" data-thread-key="&lt;% if(theme.comment.duoshuo_thread_key == "id")&#123; %&gt;&lt;%= page.id %&gt;&lt;% &#125; else &#123; %&gt;&lt;%= page.path %&gt;&lt;% &#125; %&gt;" data-url="&lt;%= config.url+ config.root + url_for(path) %&gt;"&gt;&lt;/div&gt;</div><div class="line">    &lt;!-- å¤šè¯´è¯„è®ºæ¡† end --&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>duoshuo_thread_keyé…æˆäº†page.titleï¼Œå°±å¯¼è‡´æˆ‘ä»¬æ‰¾ä¸åˆ°å¤šè¯´åå°çš„æ•°æ®ã€‚</p>
<p>æ‰€ä»¥è¦æ‰¾åˆ°NexTä¸»é¢˜ç›¸å…³å¤šè¯´çš„é…ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd themes/next/layout</div><div class="line">grep -ri <span class="string">"thread-key"</span> .<span class="comment">/*</span></div></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./_macro/post.swig:                  &lt;span class="post-comments-count ds-thread-count" data-thread-key="&#123;&#123; post.path &#125;&#125;" itemprop="commentsCount"&gt;&lt;/span&gt;</div><div class="line">./_partials/comments.swig:      &lt;div class="ds-thread" data-thread-key="&#123;&#123; page.path &#125;&#125;"</div><div class="line">./_partials/share/duoshuo_share.swig:&lt;div class="ds-share flat" data-thread-key="&#123;&#123; page.path &#125;&#125;"</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°NexTé…ç½®çš„æ˜¯page.pathã€‚é‚£ä¹ˆæˆ‘ä»¬æ‰¾åˆ°Materialä¸»é¢˜çš„thread-keyæ›¿æ¢ä¸‹å°±å¥½äº†ã€‚ä¸»è¦å°±æ˜¯ä¸¤ä¸ªåœ°æ–¹:</p>
<ul>
<li>./layout/_widget/duoshuo.ejs æ–‡ç« è¯„è®ºå†…å®¹</li>
<li>./layout/_partial/Paradox-post_entry.ejs é¦–é¡µæ˜¾ç¤ºè¯„è®ºæ•°</li>
</ul>
<p>éƒ½ä¿®æ”¹ä¸‹å°±èƒ½æ­£å¸¸æ˜¾ç¤ºä»¥å‰çš„è¯„è®ºäº†ã€‚</p>
<h1 id="æ¯æ—¥ä¸€å›¾"><a href="#æ¯æ—¥ä¸€å›¾" class="headerlink" title="æ¯æ—¥ä¸€å›¾"></a>æ¯æ—¥ä¸€å›¾</h1><p>Materialä¸»é¢˜é¦–é¡µæœ‰ä¸ªæ¯æ—¥å›¾ç‰‡ï¼Œé»˜è®¤æ˜¯å†™æ­»çš„ã€‚æˆ‘ä»¬å¯ä»¥æ”¹ä¸ºåŠ¨æ€çš„ï¼Œä½¿ç”¨äº†bingçš„æ¯æ—¥å›¾ç‰‡ï¼Œæ˜¯ä¸€ä½å¼€å‘è€…æŠ“å–çš„ç„¶åæä¾›çš„ä¸€ä¸ªapiï¼Œåœ°å€ï¼š<a href="https://i-meto.com/bing-api/" target="_blank" rel="external">å¿…åº”ç¾å›¾ API</a></p>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./_partial/daily_pic.ejs</div><div class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"mdl-card__media mdl-color-text--grey-50"</span> style=<span class="string">"background-image:url(https://api.i-meto.com/bing)"</span>&gt;</div></pre></td></tr></table></figure>
<h1 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h1><p>åŒä¸ŠèƒŒæ™¯å›¾ä¹Ÿå¯ä»¥è®¾ç½®æˆbingçš„å›¾ç‰‡ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">config_css.ejs</div><div class="line">&lt;% if(theme.background.bing.enable == true)&#123; %&gt;</div><div class="line">	&lt;style&gt;</div><div class="line">		body&#123;</div><div class="line">            background-image: url(https://api.i-meto.com/bing?&lt;%= theme.background.bing.parameter %&gt;);</div><div class="line">        &#125;</div><div class="line">	&lt;/style&gt;</div></pre></td></tr></table></figure>
<p>configé…ç½®æ–‡ä»¶</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># Background Settings</div><div class="line"># bing available parameter:</div><div class="line">#     new | color= | type=</div><div class="line">#         color available value: black, blue, brown, green, multi, orange, pink, purple, red, white, yellow</div><div class="line">#         type available value: A (animal), C (culture), N (nature), S (space), T (travel)</div><div class="line">background:</div><div class="line">    purecolor: "#F5F5F5"</div><div class="line">    bgimg: blur</div><div class="line">    bing:</div><div class="line">        parameter: color=white</div><div class="line">        enable: true</div></pre></td></tr></table></figure>
<h1 id="ä¸ç®—å­ç»Ÿè®¡"><a href="#ä¸ç®—å­ç»Ÿè®¡" class="headerlink" title="ä¸ç®—å­ç»Ÿè®¡"></a>ä¸ç®—å­ç»Ÿè®¡</h1><p>ç«™ç‚¹ç»Ÿè®¡<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">footer.ejs</div><div class="line">		&lt;div&gt;</div><div class="line">		&lt;script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"&gt;&lt;/script&gt;</div><div class="line">		&lt;div&gt;</div><div class="line">		æœ¬ç«™æ€»è®¿é—®é‡ &lt;span id="busuanzi_value_site_pv"&gt;&lt;/span&gt; &amp;nbsp&amp;nbsp&amp;nbsp</div><div class="line">		ä½ æ˜¯ç¬¬&lt;span id="busuanzi_value_site_uv"&gt;&lt;/span&gt;ä¸ªæ¥åˆ°çš„å°ä¼™ä¼´</div><div class="line">		&lt;/div&gt;</div><div class="line">		&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<h1 id="æ–‡ç« æ‘˜è¦"><a href="#æ–‡ç« æ‘˜è¦" class="headerlink" title="æ–‡ç« æ‘˜è¦"></a>æ–‡ç« æ‘˜è¦</h1><p>æœ‰ä¸¤ç§æ–¹å¼è®¾ç½®ï¼š</p>
<ol>
<li>å†™æ­»å›ºå®šå¤§å°</li>
<li>moreæ ‡ç­¾<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ä»¥ä¸Šæ˜¯æ‘˜è¦</div><div class="line">&lt;!--more--&gt;</div><div class="line">ä»¥ä¸‹æ˜¯ä½™ä¸‹å…¨æ–‡</div></pre></td></tr></table></figure>
</li>
</ol>
<p>æ¨èç¬¬äºŒç§</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/11/17/hexo-theme-material/">http://w4lle.com/2016/11/17/hexo-theme-material/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Material&quot;&gt;&lt;a href=&quot;#Material&quot; class=&quot;headerlink&quot; title=&quot;Material&quot;&gt;&lt;/a&gt;Material&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æŠŠåšå®¢ä¸»é¢˜æ¢æˆäº†&lt;a href=&quot;https://github.com/viosey/h
    
    </summary>
    
    
      <category term="Hexo" scheme="http://w4lle.com/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>AsyncTaskè§£æ</title>
    <link href="http://w4lle.com/2016/07/29/AsyncTask/"/>
    <id>http://w4lle.com/2016/07/29/AsyncTask/</id>
    <published>2016-07-29T07:44:19.000Z</published>
    <updated>2016-07-31T11:12:31.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="AsyncTaskç”¨æ³•"><a href="#AsyncTaskç”¨æ³•" class="headerlink" title="AsyncTaskç”¨æ³•"></a>AsyncTaskç”¨æ³•</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SaveImageTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Bitmap</span>, <span class="title">String</span>, <span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</div><div class="line">        Helper.showToast(<span class="string">"æ­£åœ¨åˆ†äº«ï¼Œè¯·ç¨ç­‰..."</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(Bitmap... params)</span> </span>&#123;</div><div class="line">        <span class="comment">//è€—æ—¶æ“ä½œ</span></div><div class="line">        <span class="keyword">return</span> String; </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String result)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onPostExecute(result);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ä½¿ç”¨</span></div><div class="line"><span class="keyword">new</span> SaveImageTask().execute(loadedImage);</div></pre></td></tr></table></figure>
<h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><p>AsyncTaskç±»æ€»å…±600è¡Œå·¦å³ï¼Œå¤§æ¦‚çœ‹ä¸‹å†…éƒ¨å®ç°ã€‚åˆå§‹åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</div><div class="line">    Params[] mParams;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">            <span class="comment">//noinspection unchecked</span></div><div class="line">            Result result = doInBackground(mParams);</div><div class="line">            Binder.flushPendingCommands();</div><div class="line">            <span class="keyword">return</span> postResult(result);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                postResultIfNotInvoked(get());</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                android.util.Log.w(LOG_TAG, e);</div><div class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                        e.getCause());</div><div class="line">            &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–äº†ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªCallable mWorkerï¼Œä¸€ä¸ªFutureTask mFutureï¼ŒFutureTaskå®ç°äº†Runnableå’ŒFutureã€‚å°†mWorkerä½œä¸ºå‚æ•°ä¼ é€’ç»™äº†mFutureçš„æ„é€ æ–¹æ³•ï¼Œå…³äºFutureTaskå’ŒCallableï¼Œç®€å•çš„æ¥è¯´å°±æ˜¯Futureé‡Œé¢å°è£…äº†Callableï¼Œæ‰§è¡ŒFutureå®é™…ä¸Šæ‰§è¡Œçš„æ˜¯Callableçš„callæ–¹æ³•ï¼ŒFutureçš„get()å¯ä»¥ä»Callableæ‹¿åˆ°æ‰§è¡Œçš„ç»“æœã€‚Callableçš„Call()ä¼šå»æ‰§è¡ŒæŠ½è±¡æ–¹æ³•doInBackground(mParams);å¹¶æŠŠä¼ è¿›æ¥çš„mParamså¸¦è¿‡å»ï¼ŒdoInBackgroundéœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œå»åšä¸€äº›è€—æ—¶çš„æ“ä½œã€‚ç„¶åæ‹¿åˆ°ç»“æœæ‰§è¡ŒpostResult(result)æ–¹æ³•ï¼Œè¿™ä¸ªå¾…ä¼šå†è¯´ã€‚ç»§ç»­å¾€ä¸‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">FutureTaskçš„runæ–¹æ³•</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//æ„é€ æ–¹æ³•é‡Œçš„Callableå‚æ•°</span></div><div class="line">            Callable&lt;V&gt; c = callable;</div><div class="line">            <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</div><div class="line">                V result;</div><div class="line">                <span class="keyword">boolean</span> ran;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    result = c.call();</div><div class="line">                    ran = <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                    result = <span class="keyword">null</span>;</div><div class="line">                    ran = <span class="keyword">false</span>;</div><div class="line">                    setException(ex);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (ran)</div><div class="line">                    set(result);<span class="comment">//å¯ä»¥é€šè¿‡get()æ‹¿åˆ°ç»“æœ</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡ŒAsyncTaskçš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">        Params... params) &#123;</div><div class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">        <span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">            <span class="keyword">case</span> RUNNING:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task is already running."</span>);</div><div class="line">            <span class="keyword">case</span> FINISHED:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task has already been executed "</span></div><div class="line">                        + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mStatus = Status.RUNNING;</div><div class="line"></div><div class="line">    onPreExecute();</div><div class="line"></div><div class="line">    mWorker.mParams = params;</div><div class="line">    exec.execute(mFuture);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¯ä¸ªä»»åŠ¡åœ¨å®Œæˆå‰åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ‰§è¡ŒonPreExecute();çš„æŠ½è±¡æ–¹æ³•ï¼Œåœ¨ä½¿ç”¨çš„AsyncTaskä¸­å®ç°åšä¸€äº›å‡†å¤‡æ“ä½œï¼Œç„¶åå°†ä¼ è¿›æ¥çš„paramså‚æ•°ä»˜ç»™mWorkerçš„mParamsï¼Œè¿˜è®°å¾—mWorkerå—ï¼Œæ˜¯ä¸€ä¸ªCallableã€‚exec.execute(mFuture);å®é™…ä¸Šè¢«è°ƒç”¨çš„æ˜¯mWorkerçš„call()ã€‚è¿™é‡Œæœ‰ä¸ªé»˜è®¤çš„Executor sDefaultExecutorï¼Œçœ‹ä¸‹å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">    Runnable mActive;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">        mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    r.run();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    scheduleNext();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">            scheduleNext();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">            THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mTasksæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—å­˜å‚¨Runnableå¯¹è±¡ï¼Œofferæ–¹æ³•åŠ åˆ°é˜Ÿå°¾ï¼Œpoll()ä»é˜Ÿå¤´å–ã€‚ç¬¬ä¸€æ¬¡mActiveè‚¯å®šæ˜¯nullï¼Œæ‰€ä»¥èµ°åˆ°scheduleNextå–å‡ºä¸€ä¸ªç”¨THREAD_POOL_EXECUTORå»æ‰§è¡Œã€‚ä¸‹ä¸€æ¬¡å†è°ƒç”¨execute()ï¼Œè¿™æ˜¯mActiveä¸ä¸ºç©ºï¼Œæ‰€ä»¥å°±ä¸ä¼šæ‰§è¡ŒscheduleNext()ï¼Œä½†æ˜¯ç”±äºæœ‰try finallyçš„å­˜åœ¨ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¬¡scheduleNext();æ˜¯åœ¨æœ¬æ¬¡runæ–¹æ³•æ‰§è¡Œå®Œï¼Œä¹Ÿå°±æ˜¯è¯´è¦ç­‰å¾…æœ¬æ¬¡è€—æ—¶æ“ä½œæ‰§è¡Œå®Œæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ¬¡è€—æ—¶æ“ä½œã€‚ä¹Ÿå¯¹åº”äº†SerialExecutorè¿™ä¸ªåå­—ï¼Œä¸²è¡Œæ‰§è¡Œã€‚å®é™…çš„Executoræ˜¯THREAD_POOL_EXECUTORï¼Œçœ‹ä¸‹å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = CPU_COUNT + <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadFactory sThreadFactory = <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger mCount = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"AsyncTask #"</span> + mCount.getAndIncrement());</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</div><div class="line">        <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR</div><div class="line">        = <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE,</div><div class="line">                TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</div></pre></td></tr></table></figure>
<p>å®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼ŒåŒæ—¶è¿è¡Œçº¿ç¨‹æ•°CPUæ•°+1ï¼Œçº¿ç¨‹æ± æ€»å¤§å°CPUæ•° * 2 + 1ï¼Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬è¿™ä¸¤ä¸ªæ•°å­—åˆ†åˆ«æ˜¯5å’Œ128ã€‚è™½ç„¶å®šä¹‰äº†å¯ä»¥åŒæ—¶è¿è¡Œé‚£ä¹ˆå¤šçº¿ç¨‹ï¼Œä½†æ˜¯ç”±äºSerialExecutorçš„å­˜åœ¨ï¼Œå®ƒä¼šå¼ºåˆ¶ä¸²è¡Œå¹¶å‘ï¼Œæ‰€ä»¥å®é™…ä¸Šåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è·‘ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å­˜åœ¨ä»»åŠ¡æ•°è¶…è¿‡çº¿ç¨‹æ± æ€»å¤§å°ä¼šè¹¦çš„é—®é¢˜äº†ã€‚SerialExecutoræ˜¯AsyncTaskæä¾›ç»™å¼€å‘è€…çš„ä¸€ç§é»˜è®¤å®ç°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>public final AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec,Params... params)</code>æ–¹æ³•ä¼ è¿›å»ä¸€ä¸ªè‡ªå·±å®šä¹‰çš„çº¿ç¨‹æ± ï¼Œè¿™æ ·å°±å¯ä»¥å¹¶è¡Œå¹¶å‘äº†ã€‚</p>
<p>åˆšæ‰è¯´åˆ°æœ€ç»ˆçš„æ‰§è¡Œæ—¶åœ¨mWorkerçš„call()å»æ‰§è¡Œå…·ä½“çš„è€—æ—¶æ“ä½œï¼Œæ‰§è¡Œå®Œäº†è°ƒç”¨postResult()æ–¹æ³•ï¼Œçœ‹ä¸‹å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">            <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">    message.sendToTarget();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™å°±å¾ˆæ˜äº†äº†ï¼Œé€šè¿‡HandleræŠŠresultç»“æœå‘å‡ºå»ã€‚çœ‹ä¸‹Handlerçš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                <span class="comment">// There is only one result</span></div><div class="line">                result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                result.mTask.onProgressUpdate(result.mData);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>InternalHandleræ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹ä¸Šçš„Handlerï¼Œä¹Ÿå°±æ˜¯å‘æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹ï¼Œåˆšæ‰å‘è¿‡æ¥çš„Resultå°±è¢«å‘é€çš„ä¸»çº¿ç¨‹äº†ï¼Œæœ€åè°ƒç”¨AsyncTaskçš„finishæ–¹æ³•ï¼Œçœ‹ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">        onCancelled(result);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        onPostExecute(result);</div><div class="line">    &#125;</div><div class="line">    mStatus = Status.FINISHED;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœå–æ¶ˆäº†æ‰§è¡ŒonCancelled(result)å›è°ƒï¼Œå¦åˆ™æ‰§è¡ŒonPostExecute(result)ã€‚å¹¶æŠŠçŠ¶æ€ç½®ä¸ºFINISHEDã€‚æ•´ä¸ªæµç¨‹ä¹Ÿå°±èµ°å®Œäº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡åˆ†æäº†AsyncTaskçš„åŸç†ï¼Œä¸€å¥è¯æ¦‚æ‹¬ï¼ŒAsyncTaskå°è£…äº†çº¿ç¨‹æ± å’ŒHandlerï¼Œçº¿ç¨‹æ± è·‘è€—æ—¶ä»»åŠ¡ã€Handlerå‘ä¸»çº¿ç¨‹å‘æ¶ˆæ¯ã€‚å¦‚æœä¸æ˜¯å¾ˆå¤šä»»åŠ¡çš„è¯å°±ç”¨HandlerThreadæ¥åšå°±è¡Œäº†ï¼›ä»»åŠ¡å¤šå¹¶ä¸”ä¸æ˜¯é‚£ä¹ˆè€—æ—¶çš„å¯ä»¥è€ƒè™‘ç”¨ç”¨AsyncTaskï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®è‡ªå·±å†™çº¿ç¨‹æ± ã€‚</p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/07/29/AsyncTask/">http://w4lle.com/2016/07/29/AsyncTask/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;AsyncTaskç”¨æ³•&quot;&gt;&lt;a href=&quot;#AsyncTaskç”¨æ³•&quot; class=&quot;headerlink&quot; title=&quot;AsyncTaskç”¨æ³•&quot;&gt;&lt;/a&gt;AsyncTaskç”¨æ³•&lt;/h1&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidè¿›ç¨‹ä¿æ´»ä¹‹ç»‘å®šç³»ç»ŸæœåŠ¡</title>
    <link href="http://w4lle.com/2016/07/24/Android%E8%BF%9B%E7%A8%8B%E4%BF%9D%E6%B4%BB%E4%B9%8B%E7%BB%91%E5%AE%9A%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/"/>
    <id>http://w4lle.com/2016/07/24/Androidè¿›ç¨‹ä¿æ´»ä¹‹ç»‘å®šç³»ç»ŸæœåŠ¡/</id>
    <published>2016-07-24T12:25:32.000Z</published>
    <updated>2017-01-06T01:51:30.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è¿›ç¨‹ä¿æ´»"><a href="#è¿›ç¨‹ä¿æ´»" class="headerlink" title="è¿›ç¨‹ä¿æ´»"></a>è¿›ç¨‹ä¿æ´»</h1><p>æœ‰äº›ä¸šåŠ¡éœ€è¦serviceåœ¨åå°æŒç»­çš„è¿è¡Œï¼Œæ‰€ä»¥å°±è¦æœ‰åå°ä¿æ´»æœºåˆ¶ï¼ŒåŒ…æ‹¬lowMemoryé˜²æ€å’Œè‡ªå¯ã€‚</p>
<h2 id="é˜²æ€æœºåˆ¶"><a href="#é˜²æ€æœºåˆ¶" class="headerlink" title="é˜²æ€æœºåˆ¶"></a>é˜²æ€æœºåˆ¶</h2><p>åŸºæœ¬å°±æ˜¯æé«˜è¿›ç¨‹ä¼˜å…ˆçº§ï¼Œä¿è¯åœ¨ä½å†…å­˜æ—¶è¿›ç¨‹ä¸è¢«æœ‰é™æ€æ­»ï¼Œå¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯åˆ©ç”¨ç³»ç»Ÿbugæé«˜è¿›ç¨‹ä¼˜å…ˆçº§ï¼Œç°è‰²ä¿æ´»æ‰‹æ®µã€‚</p>
<h2 id="åå°è‡ªå¯"><a href="#åå°è‡ªå¯" class="headerlink" title="åå°è‡ªå¯"></a>åå°è‡ªå¯</h2><p>å¤§æ¦‚åŒ…æ‹¬</p>
<ul>
<li>Receiveræ‹‰èµ·</li>
<li>AlarmManageræ‹‰èµ·</li>
<li>åŒè¿›ç¨‹äº’ç›¸å®ˆæŠ¤</li>
<li>åˆ©ç”¨æ¨é€SDKæ‹‰èµ·è¿›ç¨‹</li>
</ul>
<p>ä»¥ä¸Šè¯´çš„è¿™å‡ ç§æ˜¯å¸¸ç”¨çš„æ–¹æ³•ï¼Œå¯¹äºåŸç”Ÿå’Œæ²¡æœ‰æ·±åº¦å®šåˆ¶çš„ROMæœ‰ä¸€å®šä½œç”¨ï¼Œä½†æ˜¯å¯¹äºåƒå°ç±³ã€é­…æ—ç­‰è¿™ç±»æ·±åº¦å®šåˆ¶çš„ç³»ç»Ÿæ¥è¯´æ•ˆæœä¸æ˜¯å¾ˆå¥½ã€‚</p>
<h2 id="ç»‘å®šç³»ç»ŸæœåŠ¡"><a href="#ç»‘å®šç³»ç»ŸæœåŠ¡" class="headerlink" title="ç»‘å®šç³»ç»ŸæœåŠ¡"></a>ç»‘å®šç³»ç»ŸæœåŠ¡</h2><p>ç³»ç»Ÿæä¾›ä¸€äº›ç³»ç»Ÿçº§çš„Serviceï¼Œæ¯”å¦‚AccessibilityServiceè¾…åŠ©æœåŠ¡ã€NotificationListenerServiceç”¨äºç›‘å¬é€šçŸ¥æ¶ˆæ¯ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦è®²ä¸‹æ€æ ·åˆ©ç”¨NotificationListenerServiceç”¨äºç›‘å¬é€šçŸ¥æ¶ˆæ¯å®ç°è¿›ç¨‹ä¿æ´»ã€‚</p>
<p>é¦–å…ˆï¼Œå¦‚æœæƒ³ä½¿ç”¨ç³»ç»Ÿserviceï¼Œå¿…é¡»è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å¼€æƒé™ã€‚æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªè®¾ç½®çš„å…¥å£ç›´æ¥è·³åˆ°ç³»ç»Ÿè®¾ç½®é€šçŸ¥æƒé™çš„ç•Œé¢ï¼Œæ˜¾ç¤ºæç¤ºç”¨æˆ·éœ€è¦å¼€å¯æƒé™ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">goNLPermission</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="string">"android.settings.ACTION_NOTIFICATION_LISTENER_SETTINGS"</span>);</div><div class="line">        context.startActivity(intent);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç•Œé¢å°±ä¸æˆªå›¾äº†ï¼Œç„¶åæˆ‘ä»¬appä¸­è¦æœ‰ä¸€ä¸ªæƒé™çš„çŠ¶æ€æ£€æŸ¥ç”¨äºæç¤ºç”¨æˆ·æ˜¯å¦å¼€å¯äº†é€šçŸ¥æ˜¾ç¤ºæƒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ£€æŸ¥é€šçŸ¥ä½¿ç”¨æƒ</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkNotificationPermission</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    String pkg = context.getPackageName();</div><div class="line">    String flat = Settings.Secure.getString(context.getContentResolver(), <span class="string">"enabled_notification_listeners"</span>);</div><div class="line">    <span class="keyword">boolean</span> enabled = flat != <span class="keyword">null</span> &amp;&amp; flat.contains(pkg);</div><div class="line">    <span class="keyword">return</span> enabled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨å†Œï¼Œå£°æ˜è¿è¡Œåœ¨com.package.pedometerè¿›ç¨‹ä¸­</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;service</div><div class="line">    android:name=".service.MyListenerService"</div><div class="line">    android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE"</div><div class="line">    android:process=":pedometer"&gt;</div><div class="line">    &lt;intent-filter&gt;</div><div class="line">        &lt;action android:name="android.service.notification.NotificationListenerService"/&gt;</div><div class="line">    &lt;/intent-filter&gt;</div><div class="line">&lt;/service&gt;</div></pre></td></tr></table></figure>
<p>ç„¶åéœ€è¦ç»§æ‰¿NotificationListenerServiceå®ç°ä¸¤ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * ç›‘å¬ç³»ç»Ÿé€šçŸ¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¼€å¯æƒé™ï¼Œé‚£ä¹ˆè¯¥è¿›ç¨‹å¯ä»¥ä¸æ­»</div><div class="line"> */</div><div class="line"><span class="meta">@TargetApi</span>(Build.VERSION_CODES.JELLY_BEAN_MR2)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyListenerService</span> <span class="keyword">extends</span> <span class="title">NotificationListenerService</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(StatusBarNotification sbn)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationRemoved</span><span class="params">(StatusBarNotification sbn)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–¹æ³•ä¸­ä»€ä¹ˆéƒ½ä¸ç”¨å®ç°ï¼ŒMyListenerServiceæ‰€åœ¨çš„è¿›ç¨‹å°±æ‹¥æœ‰äº†è·ŸNotificationListenerServiceä¸€æ ·çš„æƒé™ã€‚å¯ä»¥è¯•ä¸‹æ‰‹åŠ¨å¼ºåˆ¶åœæ­¢è¿›ç¨‹ä¼šå‘ç°æ€ä¹ˆéƒ½ç»“æŸä¸æ‰ï¼Œå¼ºåˆ¶åœæ­¢çš„æŒ‰é’®ä¸€ç›´å¯ä»¥ç‚¹å‡»ã€‚å¯ä»¥ä½¿ç”¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb shell ps | grep ***</div></pre></td></tr></table></figure></p>
<p>å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹æ˜¯å¦å­˜æ´»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cat /proc/<span class="number">12869</span>/oom_adj</div><div class="line"><span class="number">0</span></div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è¿›ç¨‹çš„oom_adjçš„å€¼ä¸º0ï¼Œé‚£ä¹ˆæˆ‘ä»¬çŸ¥é“åœ¨ç°è‰²ä¿æ´»æ‰‹æ®µä¸ŠåŸºæœ¬å°±æ˜¯æé«˜oom_adjçš„å€¼ï¼Œè¶Šå°è¶Šä¸å®¹æ˜“è¢«æ€æ­»ï¼Œè¿™ç§æ–¹æ³•ä¸€æ­¥åˆ°ä½ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆåº”ç”¨åˆ°æˆ‘ä»¬è‡ªå·±çš„serviceä¸­å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå°†serviceè·ŸMyListenerServiceè¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹å°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;service</div><div class="line">    android:name=".service.StepCounterService"</div><div class="line">    android:exported="true"</div><div class="line">    android:process=":pedometer"&gt;</div><div class="line">&lt;/service&gt;</div></pre></td></tr></table></figure>
<p>è¿™æ ·åŸºæœ¬å°±å¯ä»¥ä¿è¯serviceæ‰€åœ¨çš„è¿›ç¨‹ä¸è¢«æ€æ­»äº†ã€‚å½“ç„¶ï¼Œå¦‚æœROMå‚å•†åœ¨ç³»ç»Ÿçº§åˆ«æ‹¦æˆªæ‰äº†ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿä¼šæ— æ•ˆäº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¦‚æœè¦ç”¨è¿™ç§æ–¹æ³•è¿›ç¨‹ä¿æ´»ï¼Œé‚£ä¹ˆä½ çš„appè‚¯å®šæ˜¯æœ‰æ˜¾ç¤ºé€šçŸ¥æ çš„é€šçŸ¥ï¼Œä¸ç„¶ç”¨æˆ·è°è¿™ä¹ˆå‚»å»ç»™ä½ å¼€è¿™ä¹ˆæƒé™å‘¢ã€‚å…¶æ¬¡ï¼Œæ˜¾ç¤ºé€šçŸ¥æ æ¶ˆæ¯å°±æ˜¯å‰å°è¿›ç¨‹äº†ï¼Œç”¨æˆ·å§‹ç»ˆå¯ä»¥çœ‹åˆ°ï¼Œå†é…åˆserviceè‡ªå¯çš„å‡ ç§æ–¹æ³•ï¼ŒåŸºæœ¬å°±å¯ä»¥ä¿è¯æˆ‘ä»¬çš„è¿›ç¨‹ä¸æ­»äº†ã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿä¸èƒ½è¯´ç»å¯¹ç®¡ç”¨ï¼Œåœ¨æ·±åº¦å®šåˆ¶é¢å‰ï¼Œä¸€åˆ‡éƒ½æ˜¯æ¸£æ¸£ã€‚éªŒè¯ä¸‹æ¥ï¼Œé­…æ—åŸºæœ¬éƒ½å¥½ç”¨ï¼Œå°ç±³4cä¸å¤ªå¥½ç”¨ï¼Œå°ç±³å…¶ä»–æœºå‹æ²¡æœ‰æµ‹è¯•ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://blog.csdn.net/aigestudio/article/details/51348408" target="_blank" rel="external">è®ºAndroidåº”ç”¨è¿›ç¨‹é•¿å­˜çš„å¯è¡Œæ€§</a><br><a href="http://www.jianshu.com/p/63aafe3c12af#" target="_blank" rel="external">å…³äº Android è¿›ç¨‹ä¿æ´»ï¼Œä½ æ‰€éœ€è¦çŸ¥é“çš„ä¸€åˆ‡</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/07/24/Androidè¿›ç¨‹ä¿æ´»ä¹‹ç»‘å®šç³»ç»ŸæœåŠ¡/">http://w4lle.com/2016/07/24/Androidè¿›ç¨‹ä¿æ´»ä¹‹ç»‘å®šç³»ç»ŸæœåŠ¡/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;è¿›ç¨‹ä¿æ´»&quot;&gt;&lt;a href=&quot;#è¿›ç¨‹ä¿æ´»&quot; class=&quot;headerlink&quot; title=&quot;è¿›ç¨‹ä¿æ´»&quot;&gt;&lt;/a&gt;è¿›ç¨‹ä¿æ´»&lt;/h1&gt;&lt;p&gt;æœ‰äº›ä¸šåŠ¡éœ€è¦serviceåœ¨åå°æŒç»­çš„è¿è¡Œï¼Œæ‰€ä»¥å°±è¦æœ‰åå°ä¿æ´»æœºåˆ¶ï¼ŒåŒ…æ‹¬lowMemoryé˜²æ€å’Œè‡ªå¯ã€‚&lt;/p&gt;
&lt;h2 id
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>å¿«é€Ÿæ’åº</title>
    <link href="http://w4lle.com/2016/07/03/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/"/>
    <id>http://w4lle.com/2016/07/03/å¿«é€Ÿæ’åº/</id>
    <published>2016-07-03T12:55:44.000Z</published>
    <updated>2017-01-06T01:56:50.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Wikipedia: å¿«é€Ÿæ’åºæ˜¯ç”±ä¸œå°¼éœå°”æ‰€å‘å±•çš„ä¸€ç§æ’åºç®—æ³•ã€‚åœ¨å¹³å‡çŠ¶å†µä¸‹ï¼Œæ’åºnä¸ªé¡¹ç›®è¦ÎŸ(n log n)æ¬¡æ¯”è¾ƒã€‚ åœ¨æœ€åçŠ¶å†µä¸‹åˆ™éœ€è¦ÎŸ(n2)æ¬¡æ¯”è¾ƒï¼Œä½†è¿™ç§çŠ¶å†µå¹¶ä¸å¸¸è§ã€‚äº‹å®ä¸Šï¼Œå¿«é€Ÿæ’åºé€šå¸¸æ˜æ˜¾æ¯”å…¶ä»–ÎŸ(n log )ç®—æ³•æ›´å¿«ï¼Œ å› ä¸ºå®ƒçš„å†…éƒ¨å¾ªç¯ï¼ˆinner loopï¼‰å¯ä»¥åœ¨å¤§éƒ¨åˆ†çš„æ¶æ„ä¸Šå¾ˆæœ‰æ•ˆç‡åœ°è¢«å®ç°å‡ºæ¥ã€‚</p>
</blockquote>
<h1 id="å¿«æ’çš„æ€è·¯"><a href="#å¿«æ’çš„æ€è·¯" class="headerlink" title="å¿«æ’çš„æ€è·¯"></a>å¿«æ’çš„æ€è·¯</h1><p>å¿«é€Ÿæ’åºé‡‡ç”¨äº†åˆ†æ²»çš„ç­–ç•¥ï¼Œé€šå¸¸ç§°å…¶ä¸ºåˆ†æ²»æ³•(Divide-and-ConquerMethod)ã€‚<br>è¯¥æ–¹æ³•çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š</p>
<ol>
<li>é€‰å–ä¸€ä¸ªåŸºå‡†å…ƒç´ ï¼ˆpivotï¼‰</li>
<li>åˆ†åŒºè¿‡ç¨‹ï¼Œæ¯”pivotå°çš„æ”¾åˆ°pivotå·¦è¾¹ï¼Œæ¯”pivotå¤§çš„æ”¾åˆ°pivotå³è¾¹</li>
<li>å¯¹pivotå·¦è¾¹çš„åºåˆ—å’Œå³è¾¹çš„åºåˆ—åˆ†åˆ«é€’å½’çš„æ‰§è¡Œæ­¥éª¤1å’Œæ­¥éª¤2</li>
</ol>
<p>è™½ç„¶æ˜¯é‡‡ç”¨åˆ†æ²»æ³•ï¼Œä½†æ˜¯åˆ†æ²»æ³•ä¸èƒ½å®Œå…¨æ¦‚æ‹¬è¿™ä¸ªç®—æ³•ï¼Œå› ä¸ºæˆ‘æ¯æ¬¡çœ‹å®Œç®—æ³•ä¼šå¾ˆæ¸…æ¥šï¼Œä½†æ˜¯è¿‡æ®µæ—¶é—´å°±å¿˜äº†ã€‚ç„¶åçœ‹åˆ°äº†éå¸¸æ–°é¢–çš„åå­—ï¼šâ€œæŒ–å‘æ’åºâ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å¿«é€Ÿæ’åº</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(<span class="keyword">int</span> s[], <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (l &lt; r)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> i = l, j = r;</div><div class="line">        <span class="comment">//å°†æ•°ç»„ä¸­çš„æœ€ä½ä½å€¼å–å‡ºï¼Œç›¸å½“äºæŒ–äº†ç¬¬ä¸€ä¸ªå‘</span></div><div class="line">        <span class="keyword">int</span> x = s[l];</div><div class="line">        <span class="keyword">while</span> (i &lt; j)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">while</span>(i &lt; j &amp;&amp; s[j] &gt;= x) &#123;</div><div class="line">            <span class="comment">//ä»å³å‘å·¦æ‰¾ç¬¬ä¸€ä¸ªå°äºxçš„æ•°</span></div><div class="line">				j--;  </div><div class="line">			&#125;</div><div class="line">            <span class="keyword">if</span>(i &lt; j) &#123;</div><div class="line">            <span class="comment">//å°†s[j]çš„æ•°æŒ–å‘å¡«ä¹‹å‰çš„å‘</span></div><div class="line">				s[i++] = s[j];</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">            <span class="keyword">while</span>(i &lt; j &amp;&amp; s[i] &lt; x) &#123;</div><div class="line">            <span class="comment">// ä»å·¦å‘å³æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äºxçš„æ•°</span></div><div class="line">				i++;  </div><div class="line">			&#125;</div><div class="line">            <span class="keyword">if</span>(i &lt; j) &#123;</div><div class="line">            <span class="comment">//æŒ–å‘ï¼Œå¡«ä¹‹å‰çš„å‘</span></div><div class="line">				s[j--] = s[i];</div><div class="line">			&#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å¡«æœ€åä¸€ä¸ªå‘</span></div><div class="line">        s[i] = x;</div><div class="line">        quickSort(s, l, i - <span class="number">1</span>); <span class="comment">// é€’å½’è°ƒç”¨ </span></div><div class="line">        quickSort(s, i + <span class="number">1</span>, r);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹æŒ–å‘å¡«æ•°è¿›è¡Œæ€»ç»“</p>
<ol>
<li>i =L; j = R; å°†åŸºå‡†æ•°æŒ–å‡ºå½¢æˆç¬¬ä¸€ä¸ªå‘a[i]ã€‚</li>
<li>jâ€“ç”±åå‘å‰æ‰¾æ¯”å®ƒå°çš„æ•°ï¼Œæ‰¾åˆ°åæŒ–å‡ºæ­¤æ•°å¡«å‰ä¸€ä¸ªå‘a[i]ä¸­ã€‚</li>
<li>i++ç”±å‰å‘åæ‰¾æ¯”å®ƒå¤§çš„æ•°ï¼Œæ‰¾åˆ°åä¹ŸæŒ–å‡ºæ­¤æ•°å¡«åˆ°å‰ä¸€ä¸ªå‘a[j]ä¸­ã€‚</li>
<li>å†é‡å¤æ‰§è¡Œ2ï¼Œ3äºŒæ­¥ï¼Œç›´åˆ°i==jï¼Œå°†åŸºå‡†æ•°å¡«å…¥a[i]ä¸­ã€‚</li>
</ol>
<h1 id="ç®—æ³•åˆ†æ"><a href="#ç®—æ³•åˆ†æ" class="headerlink" title="ç®—æ³•åˆ†æ"></a>ç®—æ³•åˆ†æ</h1><p>å¹³å‡æƒ…å†µä¸‹å¿«é€Ÿæ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n\lgn)O(n\lgn)ï¼Œæœ€åæƒ…å†µæ˜¯O(n2)O(n2)ã€‚</p>
<h2 id="æœ€åæ—¶é—´å¤æ‚åº¦"><a href="#æœ€åæ—¶é—´å¤æ‚åº¦" class="headerlink" title="æœ€åæ—¶é—´å¤æ‚åº¦"></a>æœ€åæ—¶é—´å¤æ‚åº¦</h2><p>å½“åˆ’åˆ†äº§ç”Ÿçš„ä¸¤ä¸ªå­é—®é¢˜åˆ†åˆ«åŒ…å« n-1 å’Œ 0ä¸ªå…ƒç´ æ—¶ï¼Œæœ€åæƒ…å†µå‘ç”Ÿã€‚å› æ­¤ï¼Œå¿«é€Ÿæ’åºå¿…é¡»åšn-1æ¬¡åˆ’åˆ†ï¼Œç¬¬iæ¬¡åˆ’åˆ†å¼€å§‹æ—¶åŒºé—´é•¿åº¦ä¸ºn-i+1ï¼Œæ‰€éœ€çš„æ¯”è¾ƒæ¬¡æ•°ä¸ºn-i(1â‰¤iâ‰¤n-1)ï¼Œæ•…æ€»çš„æ¯”è¾ƒæ¬¡æ•°è¾¾åˆ°æœ€å¤§å€¼ï¼š<br><code>Cmax = n(n-1)/2=O(n^2)</code></p>
<h2 id="æœ€å¥½æ—¶é—´å¤æ‚åº¦"><a href="#æœ€å¥½æ—¶é—´å¤æ‚åº¦" class="headerlink" title="æœ€å¥½æ—¶é—´å¤æ‚åº¦"></a>æœ€å¥½æ—¶é—´å¤æ‚åº¦</h2><p>å½“åˆ’åˆ†äº§ç”Ÿçš„ä¸¤ä¸ªå­é—®é¢˜åˆ†åˆ«åŒ…å«âŒŠn/2âŒ‹âŒŠn/2âŒ‹å’ŒâŒˆn/2âŒ‰âˆ’1âŒˆn/2âŒ‰âˆ’1ä¸ªå…ƒç´ æ—¶ï¼Œæœ€å¥½æƒ…å†µå‘ç”Ÿã€‚ç”¨é€’å½’æ ‘æ¥åˆ†ææœ€å¥½æƒ…å†µä¸‹çš„æ¯”è¾ƒæ¬¡æ•°æ›´ç®€å•ã€‚å› ä¸ºæ¯æ¬¡åˆ’åˆ†åå·¦ã€å³å­åŒºé—´é•¿åº¦å¤§è‡´ç›¸ç­‰ï¼Œæ•…é€’å½’æ ‘çš„é«˜åº¦ä¸ºO(lgn)ï¼Œè€Œé€’å½’æ ‘æ¯ä¸€å±‚ä¸Šå„ç»“ç‚¹æ‰€å¯¹åº”çš„åˆ’åˆ†è¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„å…³é”®å­—æ¯”è¾ƒæ¬¡æ•°æ€»å’Œä¸è¶…è¿‡nï¼Œæ•…æ•´ä¸ªæ’åºè¿‡ç¨‹æ‰€éœ€è¦çš„å…³é”®å­—æ¯”è¾ƒæ€»æ¬¡æ•°C(n)=O(nlgn)ã€‚</p>
<p>å› ä¸ºå¿«é€Ÿæ’åºçš„è®°å½•ç§»åŠ¨æ¬¡æ•°ä¸å¤§äºæ¯”è¾ƒçš„æ¬¡æ•°ï¼Œæ‰€ä»¥å¿«é€Ÿæ’åºçš„æœ€åæ—¶é—´å¤æ‚åº¦åº”ä¸º0(n2)ï¼Œæœ€å¥½æ—¶é—´å¤æ‚åº¦ä¸ºO(nlgn)ã€‚äº‹å®ä¸Šåªè¦åˆ’åˆ†æ˜¯å¸¸æ•°æ¯”ä¾‹çš„ï¼Œç®—æ³•çš„è¿è¡Œæ—¶é—´æ€»æ˜¯O(nlgn)ã€‚ å‡è®¾æŒ‰ç…§ 9:1 åˆ’åˆ†ï¼Œæ¯å±‚ä»£ä»·æœ€å¤šä¸º cnï¼Œé€’å½’æ·±åº¦ä¸º log(10/9, n)=O(lgn)ï¼Œæ•…æ’åºçš„æ€»ä»£ä»·ä¸ºO(nlgn)ã€‚å¹³å‡æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ä¸€æ¬¡åçš„åˆ’åˆ†æ¥ç€ä¸€æ¬¡å¥½çš„åˆ’åˆ†ï¼Œåçš„åˆ’åˆ†é‚£ä¸€é¡¹å¯ä»¥åˆå¹¶åˆ°å¥½çš„åˆ’åˆ†é‡Œï¼Œç»Ÿè®¡ä¸Šæ¥è®²å¹³å‡æƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦ä»ç„¶æ˜¯O(nlgn)ã€‚</p>
<h1 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h1><p>åœ¨å½“å‰æ— åºåŒºä¸­é€‰å–åˆ’åˆ†çš„åŸºå‡†å…³é”®å­—æ˜¯å†³å®šç®—æ³•æ€§èƒ½çš„å…³é”®ã€‚</p>
<ol>
<li>â€œä¸‰è€…å–ä¸­â€è§„åˆ™ï¼Œå³åœ¨å½“å‰åŒºé—´é‡Œï¼Œå°†è¯¥åŒºé—´é¦–ã€å°¾å’Œä¸­é—´ä½ç½®ä¸Šçš„å…³é”®å­—æ¯”è¾ƒï¼Œå–ä¸‰è€…ä¹‹ä¸­å€¼æ‰€å¯¹åº”çš„è®°å½•ä½œä¸ºåŸºå‡†</li>
<li>å–ä½äºlowå’Œhighä¹‹é—´çš„éšæœºæ•°k(lowâ‰¤kâ‰¤high)ï¼Œç”¨R[k]ä½œä¸ºåŸºå‡†ï¼Œ éšæœºåŒ–çš„å¿«é€Ÿæ’åºä¸ä¸€èˆ¬çš„å¿«é€Ÿæ’åºç®—æ³•å·®åˆ«å¾ˆå°ã€‚ä½†éšæœºåŒ–åï¼Œç®—æ³•çš„æ€§èƒ½å¤§å¤§åœ°æé«˜äº†ï¼Œå°¤å…¶æ˜¯å¯¹åˆå§‹æœ‰åºçš„æ–‡ä»¶ï¼Œä¸€èˆ¬ä¸å¯èƒ½å¯¼è‡´æœ€åæƒ…å†µçš„å‘ç”Ÿã€‚</li>
</ol>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://blog.csdn.net/morewindows/article/details/6684558" target="_blank" rel="external">ç™½è¯ç»å…¸ç®—æ³•ç³»åˆ—ä¹‹å…­ å¿«é€Ÿæ’åº å¿«é€Ÿæå®š</a><br><a href="http://harttle.com/2015/09/27/quick-sort.html" target="_blank" rel="external">å¿«é€Ÿæ’åºçš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦</a><br><a href="http://student.zjzk.cn/course_ware/data_structure/web/paixu/paixu8.3.2.4.htm" target="_blank" rel="external">å¿«é€Ÿæ’åºç®—æ³•åˆ†æ</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/07/03/å¿«é€Ÿæ’åº/">http://w4lle.com/2016/07/03/å¿«é€Ÿæ’åº/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Wikipedia: å¿«é€Ÿæ’åºæ˜¯ç”±ä¸œå°¼éœå°”æ‰€å‘å±•çš„ä¸€ç§æ’åºç®—æ³•ã€‚åœ¨å¹³å‡çŠ¶å†µä¸‹ï¼Œæ’åºnä¸ªé¡¹ç›®è¦ÎŸ(n log n)æ¬¡æ¯”è¾ƒã€‚ åœ¨æœ€åçŠ¶å†µä¸‹åˆ™éœ€è¦ÎŸ(n2)æ¬¡æ¯”è¾ƒï¼Œä½†è¿™ç§çŠ¶å†µå¹¶ä¸å¸¸è§ã€‚äº‹å®ä¸Šï¼Œå¿«é€Ÿæ’åºé€šå¸¸æ˜æ˜¾æ¯”å…¶ä»–ÎŸ(n log )ç®—æ³•æ›´å¿«ï¼Œ å› ä¸ºå®ƒçš„å†…
    
    </summary>
    
    
      <category term="å…¶ä»–" scheme="http://w4lle.com/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>Androidè®¡æ­¥</title>
    <link href="http://w4lle.com/2016/06/26/step-counter/"/>
    <id>http://w4lle.com/2016/06/26/step-counter/</id>
    <published>2016-06-26T02:35:39.000Z</published>
    <updated>2016-06-26T12:17:21.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è®¡æ­¥è¶Šæ¥è¶Šæˆä¸ºäººä»¬çš„å¼ºéœ€æ±‚ï¼Œä¸€èˆ¬æœ‰æ‰‹ç¯è®¡æ­¥ï¼Œæ‰‹è¡¨è®¡æ­¥ï¼Œæ‰‹æœºè®¡æ­¥ç­‰å®ç°ï¼Œè¿™ç¯‡æ–‡ç« è®¨è®ºä¸‹æ‰‹æœºä¸Šå®ç°è®¡æ­¥çš„ä¸¤ç§æ–¹æ¡ˆã€‚</p>
<h1 id="åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨ï¼ˆgsensorï¼‰"><a href="#åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨ï¼ˆgsensorï¼‰" class="headerlink" title="åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨ï¼ˆgsensorï¼‰"></a>åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨ï¼ˆgsensorï¼‰</h1><p>äººåœ¨èµ°è·¯æ—¶ï¼ŒåŠ é€Ÿåº¦ä¼ æ„Ÿå™¨ä¼šå½¢æˆä¸€ä¸ªç±»ä¼¼æ­£å¼¦æ³¢å½¢å›¾ï¼Œå› æ­¤å¯ä»¥æ ¹æ®æ£€æµ‹æ³¢å³°æ³¢è°·è®°æ­¥ã€‚è§ä¸‹å›¾ï¼š</p>
<p><img src="http://www.analog.com/library/analogDialogue/archives/44-06/AD44_06_FIG_03.jpg" alt=""></p>
<p>å¯ä»¥åˆ†ä¸ºå‡ æ­¥è¿›è¡Œï¼š</p>
<ol>
<li>ç‰¹å¾é€‰å–ï¼Œç”±äºæ‰‹æœºåœ¨ä¸åŒæ”¾ç½®æ¡ä»¶ä¸‹ä¸‰è½´ä¼ æ„Ÿå™¨ä¼šæœ‰ä¸åŒçš„æ•°æ®è¡¨ç°ï¼Œæ‰€ä»¥ å¯ä»¥å–ä¸‰è½´çš„å¹³æ–¹å’Œã€‚</li>
<li>æ»¤æ³¢ï¼Œç”±äºå¾—åˆ°çš„æ•°æ®å­˜åœ¨ä¸€å®šçš„å™ªéŸ³ï¼Œæˆ‘ä»¬éœ€è¦è¿‡æ»¤æ‰è¿™äº›å™ªéŸ³å¾—åˆ°æ¯” è¾ƒå¹³æ»‘çš„æ•°æ®ï¼Œä¸€èˆ¬æœ‰ä¸­å€¼æ»¤æ³¢å’Œä½é€šæ»¤æ³¢ã€‚</li>
<li>è®¡æ­¥ç›‘æµ‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨åˆ¤æ–­å³°è°·å€¼æ¥å†³å®šæ˜¯å¦æ˜¯ä¸€æ¬¡è®¡æ­¥ã€‚</li>
<li>åŠ¨æ€é˜ˆå€¼ï¼Œé‡‡ç”¨åˆ¤æ–­å³°è°·å€¼æ¥è®°æ­¥éœ€è¦åŠ¨æ€çš„è®¡ç®—é˜ˆå€¼ï¼Œç¬¦åˆé˜ˆå€¼æ ‡å‡†æ‰èƒ½ç®—ä¸€æ¬¡è®¡æ­¥ã€‚</li>
<li>æ­¥æ•°çŸ«æ­£ï¼Œäººçš„æ­¥ä¼é€Ÿåº¦åœ¨200-2000msä¹‹é—´ï¼Œé€šè¿‡è®°å½•è®°æ­¥çš„æ—¶é—´æˆ³ï¼ŒçŸ«æ­£æ­¥æ•°ã€‚æ­¥ä¼é—´éš”<200mså’Œ>2000msï¼Œè®¤ä¸ºæ˜¯æ— æ•ˆæ­¥æ•°ã€‚</200mså’Œ></li>
</ol>
<p>ä½¿ç”¨gsensoræ¥è®¡æ­¥å¯èƒ½ä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>ç»­èˆªé—®é¢˜ï¼Œç”±äºè¦ä¸åœçš„ç›‘æµ‹gsensorå˜åŒ–å’Œè®¡ç®—ï¼Œå°±ä¼šå¯¼è‡´æ‰‹æœºä¸ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œä¸€ç›´ä¿æŒCPUçš„å”¤é†’ï¼Œè¿™å¯¹äºæ‰‹æœºçš„ç»­èˆªå¯èƒ½ä¼šå¸¦æ¥ä¸€å®šçš„å½±å“ã€‚</li>
<li>ç²¾åº¦é—®é¢˜ï¼Œè®¡æ­¥ç®—æ³•éœ€è¦ä¸æ–­çš„äº§å“è¿­ä»£ï¼Œå¹¶ä¸”è¦æœ‰è¾ƒå¥½çš„æ­¥æ•°çŸ«æ­£æœºåˆ¶ï¼ŒçŸ­æ—¶é—´å†…ä¸èƒ½åšåˆ°ä¼˜ç§€çš„è®¡æ­¥åŠŸèƒ½ã€‚</li>
<li>åå°serviceä¿æ´»é—®é¢˜ï¼Œè¦ä¿è¯åå°å¯ä»¥å®æ—¶ç»Ÿè®¡æ­¥æ•°éœ€è¦åå°æœåŠ¡ä¸€ç›´è¿è¡Œï¼ŒåŒ…æ‹¬ä½å†…å­˜é˜²æ€æœºåˆ¶ã€è‡ªå¯æœºåˆ¶ç­‰ã€‚</li>
<li>å¯¹äºä¸€äº›é”å±è‡ªåŠ¨å…³é—­sensorçš„å®šåˆ¶ç³»ç»Ÿæ¥è¯´ä¸å¯ç”¨ã€‚</li>
</ul>
<h1 id="è®¡æ­¥ä¼ æ„Ÿå™¨ï¼ˆstep-sensorï¼‰"><a href="#è®¡æ­¥ä¼ æ„Ÿå™¨ï¼ˆstep-sensorï¼‰" class="headerlink" title="è®¡æ­¥ä¼ æ„Ÿå™¨ï¼ˆstep-sensorï¼‰"></a>è®¡æ­¥ä¼ æ„Ÿå™¨ï¼ˆstep-sensorï¼‰</h1><p>ç›¸å¯¹äºä½¿ç”¨åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨è·å–æ•°æ®å’Œè®¡ç®—å®ç°è®¡æ­¥çš„æ–¹å¼ï¼Œé€šè¿‡è®¡æ­¥ä¼ æ„Ÿå™¨sensorç›‘æµ‹æˆ–è€…è¯»å–è®¡æ­¥æ•°å¯¹äºç»ˆç«¯çš„ç»­èˆªèƒ½åŠ›æœ‰äº†å¾ˆå¤§çš„æé«˜ã€‚</p>
<p>åœ¨Android4.4ï¼ˆKITKATï¼‰ç³»ç»ŸAPIæä¾›äº†ä¸¤ç§ç¡¬ä»¶è®¡æ­¥ä¼ æ„Ÿå™¨çš„æ”¯æŒï¼Œå› ä¸ºæ˜¯ç¡¬ä»¶æ‰€ä»¥éœ€è¦å‚å•†æ”¯æŒã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ä½ çš„æ‰‹æœºæ˜¯å¦æ”¯æŒ</p>
<ul>
<li><p>adb shell pm list features<br>å¦‚æœæœ‰ä»¥ä¸‹ä¸¤é¡¹è¯´æ˜æ”¯æŒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">feature:android.hardware.sensor.stepcounter</div><div class="line">feature:android.hardware.sensor.stepdetector</div></pre></td></tr></table></figure>
</li>
<li><p>ä»£ç æ£€æµ‹Android4.4åæ›´é«˜å¹¶ä¸”æœ‰sensoræ”¯æŒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isKitkatWithStepSensor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// BEGIN_INCLUDE(iskitkatsensor)</span></div><div class="line">    <span class="comment">// Require at least Android KitKat</span></div><div class="line">    <span class="keyword">int</span> currentApiVersion = android.os.Build.VERSION.SDK_INT;</div><div class="line">    <span class="comment">// Check that the device supports the step counter and detector sensors</span></div><div class="line">    PackageManager packageManager = getActivity().getPackageManager();</div><div class="line">    <span class="keyword">return</span> currentApiVersion &gt;= android.os.Build.VERSION_CODES.KITKAT</div><div class="line">            &amp;&amp; packageManager.hasSystemFeature(PackageManager.FEATURE_SENSOR_STEP_COUNTER)</div><div class="line">            &amp;&amp; packageManager.hasSystemFeature(PackageManager.FEATURE_SENSOR_STEP_DETECTOR);</div><div class="line">    <span class="comment">// END_INCLUDE(iskitkatsensor)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>åœ¨ä½¿ç”¨å‰éœ€è¦å£°æ˜æƒé™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;uses-feature android:name=<span class="string">"android.hardware.sensor.stepcounter"</span> /&gt;</div><div class="line">&lt;uses-feature android:name=<span class="string">"android.hardware.sensor.stepdetector"</span> /&gt;</div></pre></td></tr></table></figure>
<ol>
<li><p>TYPE_STEP_COUNTER<br>APIçš„è§£é‡Šè¯´è¿”å›ä»å¼€æœºè¢«æ¿€æ´»åç»Ÿè®¡çš„æ­¥æ•°ï¼Œå½“é‡å¯æ‰‹æœºåè¯¥æ•°æ®å½’é›¶ï¼Œè¯¥ä¼ æ„Ÿå™¨æ˜¯ä¸€ä¸ªç¡¬ä»¶ä¼ æ„Ÿå™¨æ‰€ä»¥å®ƒæ˜¯ä½åŠŸè€—çš„ã€‚ä¸ºäº†èƒ½æŒç»­çš„è®¡æ­¥ï¼Œè¯·ä¸è¦åæ³¨å†Œäº‹ä»¶ï¼Œå°±ç®—æ‰‹æœºå¤„äºä¼‘çœ çŠ¶æ€å®ƒä¾ç„¶ä¼šè®¡æ­¥ã€‚å½“æ¿€æ´»çš„æ—¶å€™ä¾ç„¶ä¼šä¸ŠæŠ¥æ­¥æ•°ã€‚è¯¥sensoré€‚åˆåœ¨é•¿æ—¶é—´çš„è®¡æ­¥éœ€æ±‚ã€‚</p>
</li>
<li><p>TYPE_STEP_DETECTOR<br>ç¿»è¯‘è¿‡æ¥å°±æ˜¯èµ°è·¯æ£€æµ‹ï¼ŒAPIæ–‡æ¡£ä¹Ÿç¡®å®æ˜¯è¿™æ ·è¯´çš„ï¼Œè¯¥sensoråªç”¨æ¥ç›‘ç›‘æµ‹èµ°æ­¥ï¼Œæ¯æ¬¡è¿”å›æ•°å­—1.0ã€‚å¦‚æœéœ€è¦é•¿äº‹ä»¶çš„è®¡æ­¥è¯·ä½¿ç”¨TYPE_STEP_COUNTERã€‚</p>
</li>
</ol>
<p>ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œå®ç°æ¯”è¾ƒæ–¹ä¾¿ï¼Œç”±äºæˆ‘ä»¬éœ€è¦é•¿æ—¶é—´çš„è®¡æ­¥ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬é‡‡ç”¨<code>TYPE_STEP_COUNTER</code>ã€‚<br>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç²¾åº¦ç›¸å¯¹æ¥è¯´ç²¾ç¡®ã€‚</li>
<li>ä½åŠŸè€—ï¼Œå¯¹æ‰‹æœºç»­èˆªåŸºæœ¬æ²¡æœ‰å½±å“ã€‚</li>
<li>ä¸éœ€è¦åå°æœåŠ¡æŒç»­å”¤é†’ï¼Œæ‰€ä»¥ä¸éœ€è¦åå°ä¿æ´»ã€‚</li>
<li>å®ç°ç®€å•ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ‰‹æœºå¿…é¡»è¦Android4.4åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå¹¶ä¸”å†…ç½®è®¡æ­¥sensorç¡¬ä»¶</li>
<li>å¹¶ä¸åƒiOSçš„M7åå¤„ç†å™¨è®°å½•æ¯å¤©å„ä¸ªæ—¶æ®µçš„è®¡æ­¥æ•°æ®ï¼Œstep counter sensorè®°å½•ä»å¼€æœºä»¥æ¥æ‰€æœ‰çš„æ­¥æ•°ï¼Œæ¯æ—¥è®¡æ­¥æ•°éœ€è¦è‡ªå·±ç»´æŠ¤ã€‚</li>
</ul>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»ç»“æ¥è¯´ï¼Œå¦‚æœç”¨g-sensoræ¥å®ç°è®¡æ­¥ä¼šä¿è¯è‰¯å¥½çš„å…¼å®¹æ€§ï¼Œæ’é™¤é”å±è‡ªåŠ¨å…³é—­sensorçš„å®šåˆ¶ç³»ç»Ÿé™¤å¤–ï¼ŒåŸºæœ¬æ‰€æœ‰çš„Androidæ‰‹æœºéƒ½å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦ä¸€å®šæ—¶é—´çš„ç®—æ³•è°ƒè¯•å’Œåå°ä¿æ´»æœºåˆ¶çš„å¥å…¨ä¿è¯ï¼Œå¼€å‘å‘¨æœŸè¾ƒé•¿ï¼›å¦‚æœé¡¹ç›®éœ€æ±‚å¼€å‘å‘¨æœŸè¾ƒçŸ­ï¼Œå¹¶ä¸”æ²¡æœ‰å¼ºåˆ¶æ€§çš„å…¨æœºå‹å…¼å®¹ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨step-sensorï¼Œä¼˜ç‚¹æ¯”è¾ƒæ˜æ˜¾ï¼Œè€Œä¸”ä½¿ç”¨åå¤„ç†å™¨ä»£æ›¿çº¯è½¯ä»¶è®¡ç®—å®ç°è®¡æ­¥ç›‘æµ‹å·²ç»æ˜¯å¤§åŠ¿æ‰€è¶‹ã€‚å¦å¤–ä»¥ä¸Šä¸¤ç§æ–¹æ¡ˆéƒ½éœ€è¦å¼€æœºè‡ªå¯æƒé™ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.wujiame.com/blog/2013/12/27/pedometer/" target="_blank" rel="external">å¦‚ä½•åœ¨æ‰‹æœºä¸Šå®ç°é«˜ç²¾åº¦åŠè‡ªé€‚åº”å¤šç§åœºæ™¯çš„è®¡æ­¥å™¨ç®—æ³•</a><br><a href="https://github.com/johnjohndoe/Android-Developers-Samples/tree/master/BatchStepSensor" target="_blank" rel="external">Android-Developers-Samples-BatchStepSensor</a><br><a href="http://www.analog.com/library/analogDialogue/china/archives/44-06/pedometer.html" target="_blank" rel="external">åˆ©ç”¨3è½´æ•°å­—åŠ é€Ÿåº¦è®¡å®ç°åŠŸèƒ½å…¨é¢çš„è®¡æ­¥å™¨è®¾è®¡</a></p>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/06/26/step-counter/">http://w4lle.com/2016/06/26/step-counter/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è®¡æ­¥è¶Šæ¥è¶Šæˆä¸ºäººä»¬çš„å¼ºéœ€æ±‚ï¼Œä¸€èˆ¬æœ‰æ‰‹ç¯è®¡æ­¥ï¼Œæ‰‹è¡¨è®¡æ­¥ï¼Œæ‰‹æœºè®¡æ­¥ç­‰å®ç°ï¼Œè¿™ç¯‡æ–‡ç« è®¨è®ºä¸‹æ‰‹æœºä¸Šå®ç°è®¡æ­¥çš„ä¸¤ç§æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;h1 id=&quot;åŠ é€Ÿ
    
    </summary>
    
    
      <category term="Android" scheme="http://w4lle.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Hexoä¸»é¢˜åŒæ­¥</title>
    <link href="http://w4lle.com/2016/06/06/Hexo-themes/"/>
    <id>http://w4lle.com/2016/06/06/Hexo-themes/</id>
    <published>2016-06-06T10:48:22.000Z</published>
    <updated>2016-06-06T12:41:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><p>ç”±äºå‡çº§<code>Node.js</code>å¯¼è‡´è¦é‡æ–°å®‰è£…<code>Hexo</code>ï¼Œå®‰è£…å®Œæ–°ç‰ˆçš„<code>Hexo</code>å‘ç°æœ‰äº›ä¸œè¥¿ä¸èƒ½ç”¨ï¼Œææ¥æå»æŠŠæœ¬åœ°ä»“åº“æä¹±äº†ï¼Œå°±æƒ³ç€æŠŠæœ¬åœ°çš„ä»“åº“åˆ æ‰å§ï¼Œåœ¨ä»è¿œç¨‹<code>clone</code>ä¸€ä»½ä¸‹æ¥ã€‚<br>åšå®¢ç”¨çš„æ˜¯<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">Nextä¸»é¢˜</a>ï¼Œç»“æœä¹‹å‰çš„ä¸»é¢˜é…ç½®<code>themes/next/</code>ç›®å½•æ ¹æœ¬å°±æ²¡æœ‰ä¸Šä¼ åˆ°è¿œç¨‹åˆ†æ”¯ï¼Œå¯¼è‡´ä¸»é¢˜æ‰€æœ‰çš„å®šåˆ¶åŒ–ä¿®æ”¹å…¨éƒ¨ä¸¢å¤±ã€‚æ­¤é—®é¢˜å·²ç»æäº¤åˆ°<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">Nextä¸»é¢˜</a>çš„<a href="https://github.com/iissnan/hexo-theme-next/issues/932" target="_blank" rel="external">Issues</a>ä¸­ã€‚</p>
<h1 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h1><p>å…ˆçœ‹ä¸‹<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">Nextä¸»é¢˜</a>çš„ä½¿ç”¨æ–¹æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/iissnan/hexo-theme-next themes/next</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·é…ç½®å®Œå…¶å®<code>thems/next/</code>å°±æ˜¯ä¸€ä¸ªåŒ…å«<code>.git/</code>çš„å­é¡¹ç›®ä»“åº“ã€‚æ‰€ä»¥åœ¨<code>push</code>ä¸»é¡¹ç›®çš„æ—¶å€™ä¸ä¼šä¸Šä¼ å­é¡¹ç›®ï¼Œå­é¡¹ç›®çš„æ–‡ä»¶å¤¹æ˜¯ç°çš„ï¼Œå¹¶ä¸”é‡Œé¢æ˜¯ç©ºçš„ã€‚å¦‚å›¾<br><img src="https://cloud.githubusercontent.com/assets/7310246/15810485/b86f642a-2bd1-11e6-9bea-c8c603e9ba35.png" alt="æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°"></p>
<p>æ‰€ä»¥ä»è¿œç¨‹ä»“åº“æ‹‰å–çš„é¡¹ç›®ä¸­æ˜¯æ²¡æœ‰<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">Nextä¸»é¢˜</a>çš„ã€‚</p>
<h1 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h1><p>è§£å†³æ–¹æ³•åœ¨<a href="https://github.com/iissnan/hexo-theme-next/issues/932" target="_blank" rel="external">Issues</a>é‡Œä¹Ÿè¯´äº†ï¼Œç”¨<code>fork + subtree</code>ã€‚</p>
<p>é¦–å…ˆè¦<code>fork</code> <code>Next</code>ï¼Œç„¶åæ‹‰å–åˆ°æœ¬åœ°åšä¿®æ”¹ï¼Œä¿®æ”¹å¥½å<code>push</code>åˆ°è¿œç¨‹ä»“åº“ã€‚<br>ç„¶åç”¨<code>git subtree</code>æŠŠ<code>themes/next/</code>å½“åšå­é¡¹ç›®æ¥ç»Ÿä¸€ç®¡ç†ã€‚<code>subtree</code>çš„ç”¨æ³•å¯ä»¥çœ‹<a href="http://aoxuis.me/post/2013-08-06-git-subtree" target="_blank" rel="external">ä½¿ç”¨GIT SUBTREEé›†æˆé¡¹ç›®åˆ°å­ç›®å½•</a>ã€‚</p>
<p>å…·ä½“æ­¥éª¤ï¼š</p>
<ol>
<li><p>åˆ é™¤<code>themes/next/</code>å¹¶<code>push</code>åˆ°è¿œç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">rm -rf themes/next</div><div class="line">gst</div><div class="line">ga .</div><div class="line">git add --all</div><div class="line">gcmsg <span class="string">"delete next"</span></div><div class="line">ggpush</div></pre></td></tr></table></figure>
</li>
<li><p>ç»‘å®šå­é¡¹ç›®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git remote add -f next git<span class="meta">@github</span>.com:w4lle/hexo-theme-next.git</div><div class="line">git subtree add --prefix=themes/next next master --squash</div></pre></td></tr></table></figure>
</li>
<li><p>æ›´æ–°å­é¡¹ç›®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git fetch next master</div><div class="line">git subtree pull --prefix=themes/next next master --squash</div></pre></td></tr></table></figure>
</li>
<li><p>ä»å­ç›®å½•pushåˆ°è¿œç¨‹ä»“åº“</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git subtree push --prefix=themes/next next master</div></pre></td></tr></table></figure>
</li>
</ol>
<p>ç°åœ¨å†å»è¿œç¨‹ä»“åº“çœ‹<code>themes/next/</code>å°±æœ‰å†…å®¹äº†ï¼Œå¹¶ä¸”è·Ÿå­é¡¹ç›®çš„è¿œç¨‹ä»“åº“å¯ä»¥ä¿æŒæ›´æ–°ï¼Œåœ¨ä¸»é¡¹ç›®ä¸­ä¿®æ”¹ä¹Ÿå¯ä»¥<code>push</code>åˆ°å­é¡¹ç›®çš„è¿œç¨‹ã€‚å†ä¹Ÿä¸ç”¨æ‹…å¿ƒä¸»é¢˜é…ç½®ä¸¢å¤±äº†ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="http://aoxuis.me/post/2013-08-06-git-subtree" target="_blank" rel="external">ä½¿ç”¨GIT SUBTREEé›†æˆé¡¹ç›®åˆ°å­ç›®å½•</a></li>
<li><a href="http://tidus.xyz/2016/01/29/hexo%E7%94%A8subtree%E5%90%8C%E6%AD%A5%E4%B8%BB%E9%A2%98/" target="_blank" rel="external">hexoç”¨subtreeåŒæ­¥ä¸»é¢˜</a></li>
</ul>
<p>æœ¬æ–‡é“¾æ¥ï¼š <a href="http://w4lle.com/2016/06/06/Hexo-themes/">http://w4lle.com/2016/06/06/Hexo-themes/</a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;é—®é¢˜&quot;&gt;&lt;a href=&quot;#é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜&quot;&gt;&lt;/a&gt;é—®é¢˜&lt;/h1&gt;&lt;p&gt;ç”±äºå‡çº§&lt;code&gt;Node.js&lt;/code&gt;å¯¼è‡´è¦é‡æ–°å®‰è£…&lt;code&gt;Hexo&lt;/code&gt;ï¼Œå®‰è£…å®Œæ–°ç‰ˆçš„&lt;code&gt;Hexo&lt;/cod
    
    </summary>
    
    
      <category term="Hexo" scheme="http://w4lle.com/tags/Hexo/"/>
    
  </entry>
  
</feed>
