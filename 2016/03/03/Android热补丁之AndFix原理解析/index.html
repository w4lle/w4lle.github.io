<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        Android热补丁之AndFix原理解析 | w4lle&#39;s Notes
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="w4lle">
    <meta name="description" content="生活不止眼前的苟且，还有诗，和远方。">
    <meta name="keywords" content="Android">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="w4lle&#39;s Notes">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://w4lle.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Android热补丁之AndFix原理解析 | w4lle&#39;s Notes">
    <meta property="og:description" content="生活不止眼前的苟且，还有诗，和远方。">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.min.css" type="text/css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #00838F
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important
    }
    
	/* Sidebar User Drop Down Menu Text Color */
	#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #0097A7 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #0097A7 !important
    }
    
    .toTop{
        background: #757575 !important
    }
		
	.material-layout .material-post>.material-nav,
	.material-layout .material-index>.material-nav,
	.material-nav a{
		color: #757575;
	}
		
	#scheme-Paradox .MD-burger-layer {
		background-color: #757575;
	}

	#scheme-Paradox #post-toc-trigger-btn{
		color: #757575;
	}
	
	.post-toc a:hover{
		color: #00838F;
		text-decoration: underline;
	}
</style>


<!-- Theme Background Related-->

    <style>
        body{
            background-color: #F5F5F5
        }
		
		/* blog_info bottom background */
        #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
            background-color: #fff;
        }
    </style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>

	<script src="/js/jquery.min.js" type="text/javascript"></script>
	
	<link rel="stylesheet" href="/css/highlight/solarized-white.css" type="text/css">
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css" type="text/css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                <!-- Post TOC -->

    
	<!-- Back Button -->
<!--
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			
-->
	<!-- Left aligned menu below button -->
	<button id="post-toc-trigger-btn"
			class="mdl-button mdl-js-button mdl-button--icon">
	  <i class="material-icons">format_list_numbered</i>
	</button>

	<ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect"
		for="post-toc-trigger-btn">
			
			<ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#背景"><span class="post-toc-number">1.</span> <span class="post-toc-text">背景</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#AndFix"><span class="post-toc-number">2.</span> <span class="post-toc-text">AndFix</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用方法"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">使用方法</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#apkPatch工具解析"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">apkPatch工具解析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#对比apk文件"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">对比apk文件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#将对比结果打包"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">将对比结果打包</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#打补丁原理"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">打补丁原理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Java层"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text">Java层</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Native层"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text">Native层</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">总结</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#优点"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">优点</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#缺点"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text">缺点</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">参考</span></a></li></ol></li></ol>
		
<!--			<li class="mdl-menu__item">Some Action</li>-->
	</ul>



<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
		
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		
			<!-- Random Thumbnail -->
			<div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
				<script>
    
    var randomNum;
    randomNum = Math.floor(Math.random() * 5 + 1);
    
    $(".post_thumbnail-random").css('background-image', 'url(' + '/img/random/' + randomNum + '.png' + ')');
    
</script>

		
	
        <p class="article-headline-p">
            Android热补丁之AndFix原理解析
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>w4lle</strong>
        <span>3月 03, 2016</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Android/">Android</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/热补丁/">热补丁</a>
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    <!-- Busuanzi Views -->
    <a class="post_share-link" href="#">
        <li class="mdl-menu__item">
            阅读量 <span id="busuanzi_value_page_pv"></span>
        </li>
    </a>
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Android热补丁之AndFix原理解析&url=http://w4lle.github.io//2016/03/03/Android热补丁之AndFix原理解析/index.html&via=w4lle" target="_blank">
        <li class="mdl-menu__item">
            分享到 Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://w4lle.github.io//2016/03/03/Android热补丁之AndFix原理解析/index.html" target="_blank">
        <li class="mdl-menu__item">
            分享到 Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Android热补丁之AndFix原理解析&url=http://w4lle.github.io//2016/03/03/Android热补丁之AndFix原理解析/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            分享到微博
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>2015年下半年开源了很多Android热更新的项目，其中大部分是以QQ空间技术团队写的那篇<a href="https://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=400118620&amp;idx=1&amp;sn=b4fdd5055731290eef12ad0d17f39d4a&amp;scene=1&amp;srcid=1106Imu9ZgwybID13e7y2nEi#wechat_redirect" target="_blank" rel="external">文章</a>为依据写出的基于<code>multidex</code>的热更新框架，包括<a href="https://github.com/jasonross/Nuwa" target="_blank" rel="external">Nuwa</a>、<a href="https://github.com/dodola/HotFix" target="_blank" rel="external">HotFix</a>、<a href="https://github.com/bunnyblue/DroidFix" target="_blank" rel="external">DroidFix</a>等；还有这篇文章的主角，阿里开源的<a href="https://github.com/alibaba/AndFix" target="_blank" rel="external">AndFix</a>。</p>
<p>在这之前，热补丁框架并没有那么火，原因无非就是要么用起来太重，要么不支持ART。比如携程出品的<a href="https://github.com/CtripMobile/DynamicAPK" target="_blank" rel="external">DynamicAPK</a>,这种框架是为了解决平台级的产品相关业务开发之间的解耦，热补丁只是其附属功能，对于量级没有那么大的项目，没有必要采用这种很重的框架。另外就是基于阿里出品的基于<a href="https://github.com/rovo89/Xposed" target="_blank" rel="external">Xposed</a>的AOP框架<a href="https://github.com/alibaba/dexposed" target="_blank" rel="external">dexposed</a>，剥离掉<code>Xposed</code>的root部分功能，主要应该与AOP编程、插桩 (如测试、性能监控等)、在线热补丁、SDK hooking等，用起来比较重并且不支持<code>ART</code>。<br>众多的热补丁框架为开发者带来了福利，不用发版本就可以紧急修复线上版本的bug。</p>
<p>这篇文章主要是分析AndFix的实现原理。</p>
<h1 id="AndFix"><a href="#AndFix" class="headerlink" title="AndFix"></a>AndFix</h1><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>引用</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.alipay.euler:andfix:0.3.1@aar'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">patchManager = <span class="keyword">new</span> PatchManager(context);</span><br><span class="line">patchManager.init(appversion);<span class="comment">//current version</span></span><br></pre></td></tr></table></figure>
<p>加载补丁，尽量在<code>Application</code>的<code>onCreate</code>方法中使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchManager.loadPatch();</span><br></pre></td></tr></table></figure>
<p>应用补丁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchManager.addPatch(path);<span class="comment">//path of the patch file that was downloaded</span></span><br></pre></td></tr></table></figure>
<p>项目中提供了一个生成补丁(后缀为<code>.apatch</code>)的工具<code>apkpatch</code><br>用法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usage: apkpatch -f &#60;new&#62; -t &#60;old&#62; -o &#60;output&#62; -k &#60;keystore&#62; -p &#60;***&#62; -a &#60;alias&#62; -e &#60;***&#62;&#10; -a,--alias &#60;alias&#62;     keystore entry alias.&#10; -e,--epassword &#60;***&#62;   keystore entry password.&#10; -f,--from &#60;loc&#62;        new Apk file path.&#10; -k,--keystore &#60;loc&#62;    keystore path.&#10; -n,--name &#60;name&#62;       patch name.&#10; -o,--out &#60;dir&#62;         output dir.&#10; -p,--kpassword &#60;***&#62;   keystore password.&#10; -t,--to &#60;loc&#62;          old Apk file path.</span><br></pre></td></tr></table></figure>
<p> 如下生成补丁文件</p>
 <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./apkpatch.sh -f new.apk -t old.apk -o ./ -k ../one.keystore -p *** -a one -e ***</span><br></pre></td></tr></table></figure>
<h2 id="apkPatch工具解析"><a href="#apkPatch工具解析" class="headerlink" title="apkPatch工具解析"></a>apkPatch工具解析</h2><p><code>apkpatch</code>是一个jar包，并没有开源出来，我们可以用<code>JD-GUI</code>或者<code>procyon</code>来看下它的源码,版本1.0.3。<br>首先找到<code>Main.class</code>，位于<code>com.euler.patch</code>包下，找到<code>Main()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line">        .....</span><br><span class="line">        <span class="comment">//根据上面命令输入拿到参数        </span></span><br><span class="line">       <span class="keyword">final</span> ApkPatch apkPatch = <span class="keyword">new</span> ApkPatch(from, to, name, out, keystore, password, alias, entry);</span><br><span class="line">       apkPatch.doPatch();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>ApkPatch</code>的<code>doPatch</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//生成smali文件夹</span></span><br><span class="line">            <span class="keyword">final</span> File smaliDir = <span class="keyword">new</span> File(<span class="keyword">this</span>.out, <span class="string">"smali"</span>);</span><br><span class="line">            <span class="keyword">if</span> (!smaliDir.exists()) &#123;</span><br><span class="line">                smaliDir.mkdir();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//新建diff.dex文件</span></span><br><span class="line">            <span class="keyword">final</span> File dexFile = <span class="keyword">new</span> File(<span class="keyword">this</span>.out, <span class="string">"diff.dex"</span>);</span><br><span class="line">            <span class="comment">//新建diff.apatch文件</span></span><br><span class="line">            <span class="keyword">final</span> File outFile = <span class="keyword">new</span> File(<span class="keyword">this</span>.out, <span class="string">"diff.apatch"</span>);</span><br><span class="line">            <span class="comment">//第一步，拿到两个apk文件对比，对比信息写入DiffInfo</span></span><br><span class="line">            <span class="keyword">final</span> DiffInfo info = <span class="keyword">new</span> DexDiffer().diff(<span class="keyword">this</span>.from, <span class="keyword">this</span>.to);</span><br><span class="line">            <span class="comment">//第二步，将对比结果info写入.smali文件中，然后打包成dex文件</span></span><br><span class="line">            <span class="keyword">this</span>.classes = buildCode(smaliDir, dexFile, info);</span><br><span class="line">            <span class="comment">//第三步，将生成的dex文件写入jar包，并根据输入的签名信息进行签名,生成diff.apatch文件</span></span><br><span class="line">            <span class="keyword">this</span>.build(outFile, dexFile);</span><br><span class="line">            <span class="comment">//第四步，将diff.apatch文件重命名，结束</span></span><br><span class="line">            <span class="keyword">this</span>.release(<span class="keyword">this</span>.out, dexFile, outFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">            e2.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>以上可以简单描述为两步</p>
<ol>
<li>对比apk文件，得到需要的信息</li>
<li>将结果打包为apatch文件</li>
</ol>
<h3 id="对比apk文件"><a href="#对比apk文件" class="headerlink" title="对比apk文件"></a>对比apk文件</h3><p><code>DexDiffer().diff()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DiffInfo <span class="title">diff</span><span class="params">(<span class="keyword">final</span> File newFile, <span class="keyword">final</span> File oldFile)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">//提取新apk的dex文件</span></span><br><span class="line">        <span class="keyword">final</span> DexBackedDexFile newDexFile = DexFileFactory.loadDexFile(newFile, <span class="number">19</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//提取旧apk的dex文件</span></span><br><span class="line">        <span class="keyword">final</span> DexBackedDexFile oldDexFile = DexFileFactory.loadDexFile(oldFile, <span class="number">19</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">final</span> DiffInfo info = DiffInfo.getInstance();</span><br><span class="line">        <span class="keyword">boolean</span> contains = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> DexBackedClassDef newClazz : newDexFile.getClasses()) &#123;</span><br><span class="line">            <span class="keyword">final</span> Set&lt;? extends DexBackedClassDef&gt; oldclasses = oldDexFile.getClasses();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> DexBackedClassDef oldClazz : oldclasses) &#123;</span><br><span class="line">            	 <span class="comment">//对比相同的方法,存储为修改的方法</span></span><br><span class="line">                <span class="keyword">if</span> (newClazz.equals(oldClazz)) &#123;</span><br><span class="line">                	 <span class="comment">//对比class文件的变量</span></span><br><span class="line">                    <span class="keyword">this</span>.compareField(newClazz, oldClazz, info);</span><br><span class="line">                    <span class="comment">//对比class文件的方法，如果同一个类中没有相同的方法</span></span><br><span class="line">                    <span class="comment">//则判定为新增方法</span></span><br><span class="line">                    <span class="keyword">this</span>.compareMethod(newClazz, oldClazz, info);</span><br><span class="line">                    contains = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!contains) &#123;</span><br><span class="line">            	 <span class="comment">//否则是新增的类</span></span><br><span class="line">                info.addAddedClasses(newClazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回包含diff信息的DiffInfo对象</span></span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其原理就是根据 <code>dex diff</code>得到两个apk文件的差别信息。对比方法过程中对比两个<code>dex</code>文件中同时存在的方法，如果方法实现不同则<strong>存储为修改过的方法</strong>；如果方法名不同，<strong>存储为新增的方法</strong>，也就是说<strong>AndFix支持增加新的方法</strong>，这一点已经测试证明。另外，在比较<code>Field</code>的时候有如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAddedFields</span><span class="params">(DexBackedField field)</span> </span>&#123;</span><br><span class="line">  addedFields.add(field);</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"can,t add new Field:"</span> + </span><br><span class="line">    field.getName() + <span class="string">"("</span> + field.getType() + <span class="string">"), "</span> + <span class="string">"in class :"</span> + </span><br><span class="line">    field.getDefiningClass());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addModifiedFields</span><span class="params">(DexBackedField field)</span> </span>&#123;</span><br><span class="line">  modifiedFields.add(field);</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"can,t modified Field:"</span> + </span><br><span class="line">    field.getName() + <span class="string">"("</span> + field.getType() + <span class="string">"), "</span> + <span class="string">"in class :"</span> + </span><br><span class="line">    field.getDefiningClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说<strong><code>AndFix</code>不支持增加成员变量，但是支持在新增方法中增加的局部变量</strong>。<strong>也不支持修改成员变量</strong>。已经测试证明这一点。<br>还有一个地方要注意，就是提取<code>dex</code>文件的地方，在<code>DexFileFactory</code>类中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DexBackedDexFile <span class="title">loadDexFile</span><span class="params">(File dexFile, <span class="keyword">int</span> api, <span class="keyword">boolean</span> experimental)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadDexFile(dexFile, <span class="string">"classes.dex"</span>, <span class="keyword">new</span> Opcodes(api, experimental));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，只提取出了<code>classes.dex</code>这个文件，所以源生工具并<strong>不支持multidex</strong>，如果使用了<code>multidex</code>方案，并且修复的类不在同一个<code>dex</code>文件中，那么补丁就不会生效。所以这里并不像作者在issue中提到的支持<code>multidex</code>那样，不过我们可以通过<code>JavaAssist</code>工具<strong>修改<code>apkpatch</code>这个jar包，来达到支持multidex的目的</strong>，后续我们会讲到。</p>
<h3 id="将对比结果打包"><a href="#将对比结果打包" class="headerlink" title="将对比结果打包"></a>将对比结果打包</h3><p>这一步我们重点关注拿到<code>DiffInfo</code>后将其存入<code>smali</code>文件的过程<br><code>ApkPatch.buildCode()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">buildCode</span><span class="params">(<span class="keyword">final</span> File smaliDir, <span class="keyword">final</span> File dexFile, <span class="keyword">final</span> DiffInfo info)</span> <span class="keyword">throws</span> IOException, RecognitionException, FileNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ClassFileNameHandler outFileNameHandler = <span class="keyword">new</span> ClassFileNameHandler(smaliDir, <span class="string">".smali"</span>);</span><br><span class="line">        <span class="keyword">final</span> ClassFileNameHandler inFileNameHandler = <span class="keyword">new</span> ClassFileNameHandler(smaliDir, <span class="string">".smali"</span>);</span><br><span class="line">        <span class="keyword">final</span> DexBuilder dexBuilder = DexBuilder.makeDexBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> DexBackedClassDef classDef : list) &#123;</span><br><span class="line">            <span class="keyword">final</span> String className = classDef.getType();</span><br><span class="line">            baksmali.disassembleClass(classDef, outFileNameHandler, options);</span><br><span class="line">            <span class="keyword">final</span> File smaliFile = inFileNameHandler.getUniqueFilenameForClass(TypeGenUtil.newType(className));</span><br><span class="line">            classes.add(TypeGenUtil.newType(className).substring(<span class="number">1</span>, TypeGenUtil.newType(className).length() - <span class="number">1</span>).replace(<span class="string">'/'</span>, <span class="string">'.'</span>));</span><br><span class="line">            SmaliMod.assembleSmaliFile(smaliFile, dexBuilder, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dexBuilder.writeTo(<span class="keyword">new</span> FileDataStore(dexFile));</span><br><span class="line">        <span class="keyword">return</span> classes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>将上一步得到的<code>diff</code>信息写入<code>smali</code>文件，并且生成<code>diff.dex</code>文件。<code>smali</code>文件的命名以<code>_CF.smali</code>结尾，并且在修改的地方用自定义的<strong>Annotation</strong>(<code>MethodReplace</code>)标注，用于在替换之前查找修复的变量或方法，如下。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.method</span><span class="keyword"> private</span><span class="function"> getUserProfile(</span><span class="function">)</span>V</span><br><span class="line"><span class="keyword">    .locals</span> 2</span><br><span class="line"><span class="keyword">    .annotation</span> runtime <span class="class">Lcom/alipay/euler/andfix/annotation/MethodReplace;</span></span><br><span class="line">        clazz = <span class="string">"com.boohee.account.UserProfileActivity"</span></span><br><span class="line">        method = <span class="string">"getUserProfile"</span><span class="keyword"></span><br><span class="line">    .end annotation</span></span><br></pre></td></tr></table></figure>
<p>在打包生成的<code>diff.dex</code>文件中，反编译出来可以看到这段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成的注解</span></span><br><span class="line"><span class="annotation">@MethodReplace</span>(clazz=<span class="string">"com.boohee.account.UserProfileActivity"</span>, method=<span class="string">"onCreate"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle paramBundle)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(paramBundle);</span><br><span class="line">    getUserProfile();</span><br><span class="line">    addPatch();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后就是签名，打包，加密的流程，就不具体分析了。注意，<code>apkPatch</code>在生成<code>.apatch</code>补丁文件的时候会加入签名信息，并且会进行加密操作，在应用补丁的时候会验证签名信息是否正确。</p>
<h2 id="打补丁原理"><a href="#打补丁原理" class="headerlink" title="打补丁原理"></a>打补丁原理</h2><h3 id="Java层"><a href="#Java层" class="headerlink" title="Java层"></a>Java层</h3><p><code>PatchManager.init()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(String appVersion)</span> </span>&#123;</span><br><span class="line">		SharedPreferences sp = mContext.getSharedPreferences(SP_NAME,</span><br><span class="line">				Context.MODE_PRIVATE);</span><br><span class="line">		String ver = sp.getString(SP_VERSION, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//根据版本号加载补丁文件，版本号不同清空缓存目录</span></span><br><span class="line">		<span class="keyword">if</span> (ver == <span class="keyword">null</span> || !ver.equalsIgnoreCase(appVersion)) &#123;</span><br><span class="line">			cleanPatch();</span><br><span class="line">			sp.edit().putString(SP_VERSION, appVersion).commit();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			initPatchs();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPatchs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 缓存目录data/data/package/file/apatch/会缓存补丁文件</span></span><br><span class="line">		<span class="comment">// 即使原目录被删除也可以打补丁</span></span><br><span class="line">		File[] files = mPatchDir.listFiles();</span><br><span class="line">		<span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">			addPatch(file);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><code>addPatch</code>和<code>loadPatch()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPatch</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	FileUtil.copyFile(src, dest);<span class="comment">// copy to patch's directory</span></span><br><span class="line">	Patch patch = addPatch(dest);</span><br><span class="line">	<span class="keyword">if</span> (patch != <span class="keyword">null</span>) &#123;</span><br><span class="line">		loadPatch(patch);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadPatch</span><span class="params">(Patch patch)</span> </span>&#123;</span><br><span class="line">	Set&lt;String&gt; patchNames = patch.getPatchNames();</span><br><span class="line">	ClassLoader cl;</span><br><span class="line">	List&lt;String&gt; classes;</span><br><span class="line">	<span class="keyword">for</span> (String patchName : patchNames) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mLoaders.containsKey(<span class="string">"*"</span>)) &#123;</span><br><span class="line">			cl = mContext.getClassLoader();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			cl = mLoaders.get(patchName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (cl != <span class="keyword">null</span>) &#123;</span><br><span class="line">			classes = patch.getClasses(patchName);</span><br><span class="line">			mAndFixManager.fix(patch.getFile(), cl, classes);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看下<code>AndFixManager</code>的<code>fix()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//省略掉验证签名信息、安全检查的代码，安全方面做得很好</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixClass</span><span class="params">(Class&lt;?&gt; clazz, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">			<span class="comment">//还记得对比过程中生成的Annotation注解吗</span></span><br><span class="line">			<span class="comment">//这里通过注解找到需要替换掉的方法</span></span><br><span class="line">			methodReplace = method.getAnnotation(MethodReplace.class);</span><br><span class="line">			<span class="keyword">if</span> (methodReplace == <span class="keyword">null</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">//标记的类</span></span><br><span class="line">			clz = methodReplace.clazz();</span><br><span class="line">			<span class="comment">//需要替换的方法</span></span><br><span class="line">			meth = methodReplace.method();</span><br><span class="line">			<span class="keyword">if</span> (!isEmpty(clz) &amp;&amp; !isEmpty(meth)) &#123;</span><br><span class="line">				<span class="comment">//所有找到的方法，循环替换</span></span><br><span class="line">				replaceMethod(classLoader, clz, meth, method);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">replaceMethod</span><span class="params">(Method dest, Method src)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setFieldFlag</span><span class="params">(Field field)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addReplaceMethod</span><span class="params">(Method src, Method dest)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			replaceMethod(src, dest);</span><br><span class="line">			initFields(dest.getDeclaringClass());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">			Log.e(TAG, <span class="string">"addReplaceMethod"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>后面就是调用<code>native</code>层的方法，写在<code>jni</code>中，打包为<code>.so</code>文件供<code>java</code>层调用。</p>
<p>总结一下，<code>java</code>层的功能就是找到补丁文件，根据补丁中的注解找到将要替换的方法然后交给jni层去处理替换方法的操作。好了，继续往下看。</p>
<h3 id="Native层"><a href="#Native层" class="headerlink" title="Native层"></a>Native层</h3><p>在<code>jni</code>的代码中支持<code>Dalvik</code>与<code>ART</code>，那么这是怎么区分的呢?在<code>AndFixManager</code>的构造方法中有这么一句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSupport = Compat.isSupport();</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">isSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (isChecked)</span><br><span class="line">		<span class="keyword">return</span> isSupport;</span><br><span class="line"></span><br><span class="line">		isChecked = <span class="keyword">true</span>;</span><br><span class="line">		<span class="comment">// not support alibaba's YunOs</span></span><br><span class="line">		<span class="comment">//SDK android 2.3 to android 6.0</span></span><br><span class="line">		<span class="keyword">if</span> (!isYunOS() &amp;&amp; AndFix.setup() &amp;&amp; isSupportSDKVersion()) &#123;</span><br><span class="line">			isSupport = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> isSupport;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AndFix</code>的`setUp()``方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> String vmVersion = System.getProperty(<span class="string">"java.vm.version"</span>);</span><br><span class="line">		<span class="comment">//判断是否是ART</span></span><br><span class="line">		<span class="keyword">boolean</span> isArt = vmVersion != <span class="keyword">null</span> &amp;&amp; vmVersion.startsWith(<span class="string">"2"</span>);</span><br><span class="line">		<span class="keyword">int</span> apilevel = Build.VERSION.SDK_INT;</span><br><span class="line">		<span class="comment">//这里也是native方法</span></span><br><span class="line">		<span class="keyword">return</span> setup(isArt, apilevel);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		Log.e(TAG, <span class="string">"setup"</span>, e);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用<code>setup(isArt, apilevel);</code>的<code>native</code>方法，在<code>andfix.cpp</code>中注册<code>jni</code>方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line"><span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line">&#123; <span class="string">"setup"</span>, <span class="string">"(ZI)Z"</span>, (<span class="keyword">void</span>*) setup &#125;, </span><br><span class="line">&#123; <span class="string">"replaceMethod"</span>,</span><br><span class="line">		<span class="string">"(Ljava/lang/reflect/Method;Ljava/lang/reflect/Method;)V"</span>,(<span class="keyword">void</span>*) replaceMethod &#125;,</span><br><span class="line">&#123; <span class="string">"setFieldFlag"</span>,</span><br><span class="line">		<span class="string">"(Ljava/lang/reflect/Field;)V"</span>, (<span class="keyword">void</span>*) setFieldFlag &#125;, &#125;;</span><br></pre></td></tr></table></figure>
<p><code>native</code>实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">setup</span><span class="params">(JNIEnv* env, jclass clazz, jboolean isart,</span><br><span class="line">		jint apilevel)</span> </span>&#123;</span><br><span class="line">	isArt = isart;</span><br><span class="line">	LOGD(<span class="string">"vm is: %s , apilevel is: %i"</span>, (isArt ? <span class="string">"art"</span> : <span class="string">"dalvik"</span>),</span><br><span class="line">			(<span class="keyword">int</span> )apilevel);</span><br><span class="line">	<span class="keyword">if</span> (isArt) &#123;</span><br><span class="line">		<span class="keyword">return</span> art_setup(env, (<span class="keyword">int</span>) apilevel);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> dalvik_setup(env, (<span class="keyword">int</span>) apilevel);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">replaceMethod</span><span class="params">(JNIEnv* env, jclass clazz, jobject src,</span><br><span class="line">		jobject dest)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (isArt) &#123;</span><br><span class="line">		art_replaceMethod(env, src, dest);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		dalvik_replaceMethod(env, src, dest);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据上层传过来的<code>isArt</code>判断调用<code>Dalvik</code>还是<code>Art</code>的方法。<br>以<code>Dalvik</code>为例,继续往下分析,代码在<code>dalvik_method_replace.cpp</code>中<br><code>dalvik_setup</code>方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> jboolean __attribute__ ((visibility (<span class="string">"hidden"</span>))) dalvik_setup(</span><br><span class="line">		JNIEnv* env, <span class="keyword">int</span> apilevel) &#123;</span><br><span class="line">	jni_env = env;</span><br><span class="line">	<span class="keyword">void</span>* dvm_hand = dlopen(<span class="string">"libdvm.so"</span>, RTLD_NOW);</span><br><span class="line">	<span class="keyword">if</span> (dvm_hand) &#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//使用dlsym方法将dvmCallMethod_fnPtr函数指针指向libdvm.so中的		//dvmCallMethod方法，也就是说可以通过调用该函数指针执行其指向的方法</span></span><br><span class="line">		<span class="comment">//下面会用到dvmCallMethod_fnPtr</span></span><br><span class="line">		dvmCallMethod_fnPtr = dvm_dlsym(dvm_hand,</span><br><span class="line">			apilevel &gt; <span class="number">10</span> ?</span><br><span class="line">			<span class="string">"_Z13dvmCallMethodP6ThreadPK6MethodP6ObjectP6JValuez"</span> :</span><br><span class="line">			<span class="string">"dvmCallMethod"</span>);</span><br><span class="line">		...</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>替换方法的关键在于<code>native</code>层怎么影响内存里的java代码，我们知道<code>java</code>代码里将一个方法声明为<code>native</code>方法时,对此函数的调用就会到<code>native</code>世界里找，AndFix原理就是将一个不是native的方法修改成native方法，然后在<code>native</code>层进行替换，通过<code>dvmCallMethod_fnPtr</code>函数指针来调用<code>libdvm.so</code>中的<code>dvmCallMethod()</code>来加载替换后的新方法，达到替换方法的目的。<code>Jni</code>反射调用<code>java</code>方法时要用到一个<code>jmethodID</code>指针,这个指针在<code>Dalvik</code>里其实就是<code>Method</code>类,通过修改这个类的一些属性就可以实现在运行时将一个方法修改成<code>native</code>方法。</p>
<p>看下<code>dalvik_replaceMethod(env, src, dest);</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">void</span> __attribute__ ((visibility (<span class="string">"hidden"</span>))) dalvik_replaceMethod(</span><br><span class="line">		JNIEnv* env, jobject src, jobject dest) &#123;</span><br><span class="line">	jobject clazz = env-&gt;CallObjectMethod(dest, jClassMethod);</span><br><span class="line">	ClassObject* clz = (ClassObject*) dvmDecodeIndirectRef_fnPtr(</span><br><span class="line">			dvmThreadSelf_fnPtr(), clazz);</span><br><span class="line">	<span class="comment">//设置为初始化完毕</span></span><br><span class="line">	clz-&gt;status = CLASS_INITIALIZED;</span><br><span class="line">	<span class="comment">//meth是将要被替换的方法</span></span><br><span class="line">	Method* meth = (Method*) env-&gt;FromReflectedMethod(src);</span><br><span class="line">	<span class="comment">//target是新的方法</span></span><br><span class="line">	Method* target = (Method*) env-&gt;FromReflectedMethod(dest);</span><br><span class="line">	LOGD(<span class="string">"dalvikMethod: %s"</span>, meth-&gt;name);</span><br><span class="line"></span><br><span class="line">	meth-&gt;jniArgInfo = <span class="number">0x80000000</span>;</span><br><span class="line">	<span class="comment">//修改method的属性，将meth设置为native方法</span></span><br><span class="line">	meth-&gt;accessFlags |= ACC_NATIVE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> argsSize = dvmComputeMethodArgsSize_fnPtr(meth);</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth))</span><br><span class="line">		argsSize++;</span><br><span class="line">	meth-&gt;registersSize = meth-&gt;insSize = argsSize;</span><br><span class="line">	<span class="comment">//将新的方法信息保存到insns</span></span><br><span class="line">	meth-&gt;insns = (<span class="keyword">void</span>*) target;</span><br><span class="line">	<span class="comment">//绑定桥接函数，java方法的跳转函数</span></span><br><span class="line">	meth-&gt;nativeFunc = dalvik_dispatcher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dalvik_dispatcher</span><span class="params">(<span class="keyword">const</span> u4* args, jvalue* pResult,</span><br><span class="line">		<span class="keyword">const</span> Method* method, <span class="keyword">void</span>* self)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	Method* meth = (Method*) method-&gt;insns;</span><br><span class="line">	meth-&gt;accessFlags = meth-&gt;accessFlags | ACC_PUBLIC;</span><br><span class="line">	<span class="keyword">if</span> (!dvmIsStaticMethod(meth)) &#123;</span><br><span class="line">		Object* thisObj = (Object*) args[<span class="number">0</span>];</span><br><span class="line">		ClassObject* tmp = thisObj-&gt;clazz;</span><br><span class="line">		thisObj-&gt;clazz = meth-&gt;clazz;</span><br><span class="line">		argArray = boxMethodArgs(meth, args + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			<span class="keyword">goto</span> bail;</span><br><span class="line"></span><br><span class="line">		dvmCallMethod_fnPtr(self, (Method*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;result, thisObj,</span><br><span class="line">				argArray);</span><br><span class="line"></span><br><span class="line">		thisObj-&gt;clazz = tmp;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		argArray = boxMethodArgs(meth, args);</span><br><span class="line">		<span class="keyword">if</span> (dvmCheckException_fnPtr(self))</span><br><span class="line">			<span class="keyword">goto</span> bail;</span><br><span class="line"></span><br><span class="line">		dvmCallMethod_fnPtr(self, (Method*) jInvokeMethod,</span><br><span class="line">				dvmCreateReflectMethodObject_fnPtr(meth), &amp;result, <span class="literal">NULL</span>,</span><br><span class="line">				argArray);</span><br><span class="line">	&#125;</span><br><span class="line">	bail: dvmReleaseTrackedAlloc_fnPtr((Object*) argArray, self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>dalvik_dispatcher</code>这个跳转函数完成最后的替换工作，到这里就完成了两个方法的替换，有问题的方法就可以被修复后的方法取代。ART的替换方法就不讲了，原理上差别不大。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>AndFix热补丁原理就是在<code>native</code>动态替换方法<code>java</code>层的代码，通过<code>native</code>层hook <code>java</code>层的代码。</p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>因为是动态的，所以不需要重启应用就可以生效</li>
<li>支持ART与Dalvik</li>
<li>与multidex方案相比，性能会有所提升(Multi Dex需要修改所有class的class_ispreverified标志位，导致运行时性能有所损失)</li>
<li>支持新增加方法</li>
<li>支持在新增方法中新增局部变量</li>
<li>足够轻量，生成补丁文件简单</li>
<li>安全性够高，验证签名</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>因为是动态的，跳过了类的初始化，设置为初始化完毕，所以对于静态方法、静态成员变量、构造方法或者class.forname()的处理可能会有问题</li>
<li>不支持新增成员变量和修改成员变量</li>
<li>官方apkPatch工具不支持multidex,但是可以通过修改工具来达到支持multidex的目的</li>
<li>由于是在native层替换方法，某些缺心眼厂商可能会修改源生关键部分的native层实现，导致可能在某些特定ROM支持不够好</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://bbs.pediy.com/showthread.php?t=186054" target="_blank" rel="external">注入安卓进程,并hook java世界的方法</a></li>
<li><a href="http://blog.csdn.net/l173864930/article/details/39667355" target="_blank" rel="external">Hook Java的的一个改进版本</a></li>
<li><a href="http://blog.csdn.net/xxooyc/article/details/50317455" target="_blank" rel="external">关于Android APP在线热修复bug方案的调研(一)(AndFix)</a></li>
<li><a href="http://blog.zhaiyifan.cn/2015/11/20/HotPatchCompare/" target="_blank" rel="external">各大热补丁方案分析和比较</a></li>
</ul>
<p>项目地址：<a href="https://github.com/alibaba/AndFix" target="_blank" rel="external">AndFix</a>，本文分析版本：<a href="https://github.com/alibaba/AndFix/tree/c68d9811bd756ee418fce761ca113376ec9c4e66" target="_blank" rel="external">AndFix:0.3.1</a></p>
<p>本文地址 <a href="http://w4lle.github.io/2016/03/03/Android热补丁之AndFix原理解析/">http://w4lle.github.io/2016/03/03/Android热补丁之AndFix原理解析/</a> </p>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                
                    
    <!-- 使用多说评论 -->
    <link rel="stylesheet" href="/css/duoshuo.min.css" type="text/css">
<style>
    #ds-thread #ds-reset .ds-post-button{
        background-color: #0097A7 !important;
    }
    #ds-wrapper #ds-reset .ds-icons-32{
        background-color: #0097A7 !important;
    }
    #ds-reset .ds-highlight {
        color: #0097A7 !important;
    }
</style>
<div id="comments">
    <!-- 多说评论框 start -->
        <div class="ds-thread" 
            data-thread-key="2016/03/03/Android热补丁之AndFix原理解析/" 
            data-url="http://w4lle.github.io/2016/03/03/Android热补丁之AndFix原理解析/"
            data-title="Android热补丁之AndFix原理解析"></div>
    <!-- 多说评论框 end -->
</div>



                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2016/03/13/AndFix支持multidex解决方案/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/02/15/ClassyShark——分析apk利器/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="w4lle's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        wanglinglong.me@gmail.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="mailto:wanglinglong.me@gmail.com" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             主页
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             归档
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">1</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
		<li>
			<a href="/tags" title="标签">
				标签
			</a>
		</li>
	
		<li>
			<a href="/guestbook" title="最近访客">
				最近访客
			</a>
		</li>
	
		<li>
			<a href="/friends" title="友情链接">
				友情链接
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
             文章总数
             <span class="sidebar-badge">27</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		主题 - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				
					<!-- Footer Top Button -->
					<div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>
				
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    
    
    <!-- Weibo -->
    
    <a href="http://weibo.com/u/2274417881" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-weibo.png);">
        <span class="visuallyhidden">Weibo</span>
    </button></a>
    
    
    <!-- Instagram -->
    
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://github.com/w4lle" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    

    <!-- CSDN -->
    
    <a href="http://blog.csdn.net/hlglinglong" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-csdn.png);">
        <span class="visuallyhidden">CSDN</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;w4lle's Notes

		<div>
	    <!-- Busuanzi -->
		
	    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
		
		<div>
		总访问量 <span id="busuanzi_value_site_pv"></span> 
		你是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴
		</div>
		</div>

		</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/highlight.min.js" type="text/javascript"></script>
<script src="/js/js.min.js" type="text/javascript"></script>
<script src="/js/nprogress.js" type="text/javascript"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>






    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    <!-- 多说公共 js 代码 start -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"w4lle"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = 'https://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共 js 代码 end -->




<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $(".post-toc-wrap").parent(".mdl-menu__container").css("position", "fixed");
    });
</script>

<!-- MathJax Load-->

            </main>
        </div>
		
    </body>
		
	
</html>
